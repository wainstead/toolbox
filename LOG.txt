#####################################################################
021118

Oh, I need my emacs config stuff.

Well, we'll have to add it later since I don't have cvs. Sigh.

Was in at 9am. I was probably the first person on the tech staff
here. My Mac was not at all configured and the box wouldn't read the
cdroms. Basil gave me a new drive and I installed it; the replacement
drive worked. Basil gave me a demo of the phone system. I read some of
the phone manual but it was written by engineers and thus kind of
annoying.

Went to two meetings, the first being the twice-weekly tech meeting
(Mon, Fri at 11am). Got some idea of what's going on. It's not rocket
science; as Gautam says, there are a million parts and the trick is to
change one part without breaking others.

We had lunch with Felix at Burritoville.

When I came back the install for OSX was still hung, but after a reboot
it redid the second disk and it was fine.

I installed Mozilla, I'm downloading the developer's tools for osx,
and waiting on Basil to get my password for some of the servers. I
think it might be better for me to have a Linux box though, since they
are easier to set up and it has all the tools I need by default. Since
I have a complete Windows box (with monitor) I don't really need to
put myself through the hassle of setting up osx.




#########################################################################
021119

I think the current version of Emacs from CVS won't compile. It won't
compile for me anyway.

Cleaned up the desk today and organized the hardware as best I
could. I need to start a list of questions like "Where is the CVS
server?"

Machine: 350mhz 128 MB RAM.

I have access to CVS and created a personal archive. This log is now
under version control. I also went over SpamAssassin with Gautam, but
the combination of technologies involved is imap, the imap server
Courier, SpamAssassin, Pine, and procmail. What a mess. But I know
the mail server and how to login () so I could just use Pine for
now. I've been getting spam already.

Got Emacs compiled now. I should package it for Gautam.

Went over stuff with Gautam, need to make notes:

A dev environment has been set up for me today (ahead of
schedule!). It's some monstrous Sun thing. Tomorrow Gautam and I will
have a planning meeting to decide what goes on it, in terms of
EvolutionWare.

We talked quite briefly... the staging machines (unfortunately named
'dev') have a naming scheme like so:

amprira.dev.ampira.com
fcgold.dev
hostv3.dev

These machines have the admin front ends on them.

Rob Walker is the product manager for Ampira/evwr. He'll be asking me
for stuff.

.vps are python scripts. They can call compiled Java
things. (Actually via CORBA).

evw1-dev



#########################################################################
021120

In by 9am. Network is down. Supposed to meet with Gautam today and
plan what goes into the development machine for Evolutionware.

Still haven't checked this file in. Yesterday I got a timeout from
CVS. Today the network is down.

12:10 pm. Still no network.
1:54 pm. Still no network.
2:44. Still no network.

I switched the connections on my ethernet drop and now the Windows
box is offline but the Mac works. This was around 3:30pm.

I installed Office X today too.

Had a meeting with Lysa and Gautam on the systems architecture. She
drew a chart of the boxes and what they do vis EvolutionWare. Then
Gautam proposed we use two boxes to hold all of this for a
development environment. Steve Wolf thought Trellix needed its own
box and would look that up.



#########################################################################
021121

Getting fairly settled in. It's taking a little getting used to this
Macintosh. It's much snappier though than my G3 Pismo laptop. Adding
RAM made a huge difference.

Mail.app seemed to intuitively know where to get my mail, so that
will be my primary means of communication.

I want to trace out the application architecture vis the directory
structure on ampira.dev today. Yesterday I was too foggy to really
get much done, plus in pain from a bicycle injury, and the network
was down most of the day. I also have my keyboard from home which
makes some difference.

The Sun box Zlatin is working on is one of the two boxen I will use
for development. I will be involved with installation and stuff for
that.

Wrote a little Perl script to generate an index.html file for all
files under the current working directory. I used this to make a
clickable list of all the files in EW.

JeffO showed a cool feature where you type ">console" at the login
prompt and you are dropped out of the GUI and to a login prompt. Once
logged in you get a shell.

Installed XDarwin, OroborosX, and AfterStep. Can't find AfterStep
though. I did do startx at the console and it worked; X ships with
twm as a default.

Gotta get the background set to black in Emacs now.

To get X working remotely, I have to:

start OroborosX
in a Terminal window, do:
export DISPLAY=:0.0
xhost + 192.168.2.210 # the ip of the dev box
On the remote box do 
export DISPLAY=ip.of.my.mac:0.0
Then on the Sun box I can just run emacs& and it opens on my display.

I compiled Emacs and installed it (along with Lisp documentation) on
the new dev machine. I had to solve a problem with the compile, but
pasting the error message into Google saves the day again.



#########################################################################
021122

In by 9:30. It took only 11 minutes to walk here even though I had to
limp due to my injured foot.

I'm trying to devise a list of all the tools I'll need for this new
box. I installed Emacs yesterday and found there's no CVS client on
it yet.

I am charged with the task of installing Resin on Jessy's computer,
but I can't get the version they are using on staging (2.0.2). I'll
have to install 2.1.x. I installed it and the Sun SDK on my Windows
box as a test drive, and it works fine, though the example didn't
work. (Later found out this was due to the file extension which
Windows hides from you.)

Monday morning: install Resin and the SDK on Jessy's machina. Get
all version numbers by midday Tuesday. Files are in
Bababooey\shared\Temporary Items. Also review Chris's test code which
he sent via email. It's for comparing checksums on blobs.


#########################################################################
021125 Monday

In by 9:35, had to do two errands before I came in; plus a woman in
my building was moving out and I stopped to talk to her for a few
minutes.

Read through email. Gautam mailed links to the intranet stuff on
Friday evening; cvsview, twiki, intranet and bugzilla. I need to
create a bugzilla account.

Jeff pointed out an article on O'Reilly that describes a Perl module
called Mac::iTunes. The author (Brian D Foy, no less) uses it to
write a mod_perl script to drive iTunes on a remote Mac in his house.

Had the 11am meeting, got a haircut and took a short lunch.

I've been spelunking through the servers looking for version numbers
to different pieces of software all afternoon. It's been quite
interesting. I have maybe half the stuff. Still can't find PHP. Chris
listed more things on the white board that we'll need for a dev
server... 

Trellix lives inside /opt/twe-ampira/twe/classes/sitebuilder.jar.

tomorrow: etags on files on evw-1.dvl. Wrap up version numbers.


#########################################################################
021126 Tuesday

In before 9:30am. Got to get my bicycle around 1pm.

Installed CVS on the two dvl machines.

Testing my .ssh/authorized_keys setup on cvs now...

I installed Python, Tcl/Expect, and cvs on both machines; I installed
Emacs on the new one; I got ssh configured so I can check stuff in
via CVS, but it seems CVS support on the OS X version of Emacs is
broken. It just hangs forever and times out. It works on the dvl
machines though.

I've been trying to craft an AppleScript that launches Terminal,
opens two windows, and launches ssh in each to the two dvl
machines. However, there are a few problems. One is that the AS
executes the commands but the windows take a while... so subsequent
script commands are sent to windows that either don't exist or aren't
listening.

The second problem is there seems to be no way to send commands to a
window that's already open (that is, tell the shell in the window to
execute a shell command).

The application dictionary for Terminal is not consistent with
reality.


tell application "Terminal"
	do script with command "ls -l"
	do script with command "ps -aux"
	
	tell window "ls -l"
		set normal text color to "yellow"
	end tell
	tell window "ps -aux"
		set normal text color to "green"
	end tell
	
end tell

This will launch two windows running the commands but they never get
the orders to change their text.

This works fine and comes from Apple:

tell application "Terminal"
	activate
	with timeout of 1800 seconds
		do script with command "top"
		tell window 1
			set background color to "black"
			set cursor color to "green"
			set normal text color to "yellow"
			set bold text color to "red"
			set title displays shell path to true
			set title displays window size to true
			set title displays device name to true
			set title displays file name to true
			set title displays custom title to true
			set custom title to "bozo"
			set number of columns to 80
			set number of rows to 40
		end tell
	end timeout
end tell

This is about as close as I got. I need a way to sleep 5 seconds.

set cws to "ssh 192.168.2.209"
set evw to "ssh 192.168.2.210"

tell application "Terminal"
	activate
	do script with command cws
	do script with command evw
	
	--tell window 1 to close
	
	set numwins to the count of windows
	
	(*
	tell window 1
		set normal text color to "yellow"
		set name to "cws"
	end tell
	*)
	(*

	tell window 2
		set normal text color to "green"
	end tell
	*)
end tell





#########################################################################
021127 Wednesday

Got a turkey on the way to work. Don't forget it's in the fridge.

Perhaps I should keep a record of the compiles I do; especially the
compile options. I have to answer the question, "What is -D EAPI"?




#########################################################################
021202 Monday

I need to find the spreadsheet template for tasks that everybody is
keeping.

Bababooey: is 2.6/shared. I need to add the folder name in order to
get it to connect, and use the raw ip address.

Got the template for ToDo lists; but I can't use Office X at the same
time jeffo is. We need to up the user license by one person.

Also found out we have ChiliSoft's ASP emulator for
Apache. Yay. Chris tells me the last person to build Apache spent a
week getting it right; Chilisoft requires a dynamic module that has
to be compiled.

Chris got me the ChiliSoft cdrom, and installation instructions for
DB2. Prior to lunch I tried to compile Analog, which might not be
totally necessary, and had to add a flag to the Makefile to get it to
compile. However I didn't see the binary when it finished, nor did it
have a "make install" option.

Got familiar with Sun's .pkg format today. Analog's binaries come as
pkg files. pkgadd -d /path/to/dir/containing/pgkinfo was needed,
i.e. I couldn't specifiy the dir where the pkg files were but the dir
that holds the dir. pkgadd scans all the dirs apparently for
installable packages.

Analog will only run out of /usr/local/analog right now. I tried
moving it to /opt but it couldn't find a language file it
needed. There is probably a way to install a pkg file and specify the
install directory; the crappy thing is Analog installs all the source
and object files as well.

Finally installed Resin and the JSDK on Jessy's machine. Had the same
problem as on mine: the damn example wouldn't work. It turns out it's
because Windows adds a file extension automatically. Once I cracked
that nut the example finally worked.

I have been working on my Excel to-do list and it really helps me see
what needs to be done.




#########################################################################
021203 Tuesday

ketelone.nyc.fortunecity.net is my machine name. Zlatin tells me DB2
is downloading to evw-1 right now.

Installed mysql and it runs OK. It's in /usr/local/mysql. I installed
from the binary package and had trouble with sudo for a while, so
gave up and just did a mv of the whole tree. Maybe it was a slice
problem?

Installed Lynx and Mozilla 1.2.1 today.

openssl stuff was installed into /usr/local/ssl.

BerkeleyDB install:
Installing DB include files: /usr/local/BerkeleyDB.4.1/include ...
Installing DB library: /usr/local/BerkeleyDB.4.1/lib ...
cp -p .libs/libdb-4.1.so /usr/local/BerkeleyDB.4.1/lib/libdb-4.1.so
chmod +x /usr/local/BerkeleyDB.4.1/lib/libdb-4.1.so
cp -p .libs/libdb-4.1.lai /usr/local/BerkeleyDB.4.1/lib/libdb-4.1.la
cp -p .libs/libdb-4.1.a /usr/local/BerkeleyDB.4.1/lib/libdb-4.1.a
ranlib /usr/local/BerkeleyDB.4.1/lib/libdb-4.1.a
chmod 644 /usr/local/BerkeleyDB.4.1/lib/libdb-4.1.a
----------------------------------------------------------------------
Libraries have been installed in:
   /usr/local/BerkeleyDB.4.1/lib

If you ever happen to want to link against installed libraries
in a given directory, LIBDIR, you must either use libtool, and
specify the full pathname of the library, or use the `-LLIBDIR'
flag during linking and do at least one of the following:
   - add LIBDIR to the `LD_LIBRARY_PATH' environment variable
     during execution
   - add LIBDIR to the `LD_RUN_PATH' environment variable
     during linking
   - use the `-Wl,--rpath -Wl,LIBDIR' linker flag

See any operating system documentation about shared libraries for
more information, such as the ld(1) and ld.so(8) manual pages.
----------------------------------------------------------------------
echo "Installing DB utilities: /usr/local/BerkeleyDB.4.1/bin ..."
Installing DB utilities: /usr/local/BerkeleyDB.4.1/bin ...
cp -p .libs/db_archive /usr/local/BerkeleyDB.4.1/bin/db_archive
cp -p .libs/db_checkpoint /usr/local/BerkeleyDB.4.1/bin/db_checkpoint
cp -p .libs/db_deadlock /usr/local/BerkeleyDB.4.1/bin/db_deadlock
cp -p .libs/db_dump /usr/local/BerkeleyDB.4.1/bin/db_dump
cp -p .libs/db_load /usr/local/BerkeleyDB.4.1/bin/db_load
cp -p .libs/db_printlog /usr/local/BerkeleyDB.4.1/bin/db_printlog
cp -p .libs/db_recover /usr/local/BerkeleyDB.4.1/bin/db_recover
cp -p .libs/db_stat /usr/local/BerkeleyDB.4.1/bin/db_stat
cp -p .libs/db_upgrade /usr/local/BerkeleyDB.4.1/bin/db_upgrade
cp -p .libs/db_verify /usr/local/BerkeleyDB.4.1/bin/db_verify
Installing documentation: /usr/local/BerkeleyDB.4.1/docs ...

Well, that was a waste. iPlanet is the ldap server, not openldap. Oh
well.

Chris was showing me a couple of items: a Python module on evw-1.dev:

/usr/lib/python1.5/site-packages/evw/CoreUtils.py

and a Perl file manager on cws-1.dev:

and on /usr/lib/python1.5/site-packages/evw
/opt/evw/lib/perl5 (where the perl libraries are)
cd /opt/ampira.fm/etc/fm_miniserv.pl

Setting environment variables in Windows: control panels, system,
advanced. 

C:\jars\ADM.jar;C:\jars\ADMModule.jar;C:\jars\AnalogProduct.jar;C:\jars\ApacheAnalog.jar;C:\jars\ApacheWebRedirect.jar;C:\jars\DomainManagementProduct.jar;C:\jars\EVW.jar;C:\jars\FSSL.jar;C:\jars\FSSLIAIK.jar;C:\jars\MailListProduct.jar;C:\jars\MivaProduct.jar;C:\jars\OB.jar;C:\jars\WebRedirectProduct.jar;C:\jars\Webmail.jar;C:\jars\crimson.jar;C:\jars\iaik_jce_full.jar;C:\jars\iaik_ssl.jar;C:\jars\interclient.jar;C:\jars\jdk12.jar;C:\jars\jsdk23.jar;C:\jars\junit.jar;C:\jars\mail.jar;C:\jars\netscape.jar;C:\jars\resin.jar;C:\jars\xalan.jar



#########################################################################
021204 Wednesday

Solved the problem driving me crazy last night: I couldn't get the
jar files for EVW to show in the classpath on my Windows box. In fact
they don't show at all; but I can include classes. I was trying to
import com.evolutionware.CORBA, and was getting an error with
EVW.jar. It turns out the jar file was corrupted. I copied it again
from evw-1.dev and that fixed it. There is a weird problem when I am
in a shared directory on a Windows box, and I try to scp a file down
from some server. I kept getting a zero byte file; scp thought
everything was fine.

It's another example of how I have to be careful using OS X at
work. Some things do not work as you would think. This is clearly a
bug however.

Ops are fighting a fire with SF this morning. It looks like they had
to sync the production servers with the staging server and something
went wrong; Lysa sent an email saying staging was not in a usable
state.

DB2 is in /var/tmp on evw-1.dvl.

Searching for config files: resin.conf is on evw-1.dev in
/usr/local/resin/conf.

web.xml files are under /opt/frontend*:

[swain@evw-1 evw]$ for w in $(find frontend* -type d -name WEB-INF); do ls -l $w/web.xml; done
-rwxrwxr-x   1 root     other        1857 Jul  7 06:32 frontend-14-2-final/WEB-INF/web.xml
-rwxrwxr-x   1 root     other        1857 Oct 23 16:32 frontend-ampira/WEB-INF/web.xml
-rwxrwxr-x   1 root     other        1857 Oct 16 17:19 frontend-fcgold/WEB-INF/web.xml
-rwxrwxr-x   1 root     other        1857 Oct 22 12:24 frontend-hostgs/WEB-INF/web.xml
-rwxrwxr-x   1 root     other        1857 Oct 22 12:24 frontend-hostv3/WEB-INF/web.xml
-rwxrwxr-x   1 root     other        1857 Oct 22 12:24 frontend-plain/WEB-INF/web.xml

They appear to be the same on the staging servers.

Notes on installing/configuring Resin on Windows:

Disabling IIS: (thanks Gautam!)
settings->control panels->admin tools->services->www
publishing->right click->startup-type->disabled

The differences between the resin.conf files, default vs. ampira:

A change in logging, to:
log id='/log' href='stderr:' timestamp='[%Y-%m-%d %H:%M:%S.%

<doc-dir> is <app-dir> in the ampira version

class-update-interval increased from 2 to 60

request-timeout decreased to 30s

logging changed from logs/ to log/

war-dir commented out

path-mapping removed (? looks that way)

Then a series of <host> declarations, which are separate from the
configs above; the above changes appear to apply only to <host
id='/'>.

These are the only differences. I've tried setting the path to the
doc dir on my Windows box but it just lists / as empty.

I'm extremely tired from banging my head agains Resin. It's a good
app and the documentation is good, but the configurations between
evw-1 and my Windows seem slight but yet are thus far inexplicable. I
suspect a problem might be version differences.

Try: 
cd /Users/swain/tmp
sdiff resindef.conf resin.conf |less

db2inst1 is db2-dvl

I had a problem in that db2setup couldn't add a new user db2inst1. It
was because we use /home instead of the default /export/home.



#########################################################################
021205 Thursday

Yesterday was an all-around bad day. I spent most of the day trying
to get the Resin configuration right on Windows. Today Steve asked
when it would be up on Jessy's machine. Chris was trying to get the
db2 install working on evw-1.dvl when I left last night. I brought in
my db2 book today.

I think I have the config right for Resin now. We'll see. I got the
virtual hosting thing figured out.


#!/bin/bash
# heller's script to list all classes in the classpath

NEWPATH=`echo $CLASSPATH | sed 's/:/ /g'`

# echo $NEWPATH

for x in $NEWPATH
  do
  if [ -d $x ]; then
      echo Class Directory Structure: $x
      pushd $x > /dev/null
      find . -name "*.class" | cut -c3-
      popd > /dev/null
  else

      echo Class Java Archive: $x

# unzip -qq prevents all headers from being written. I'll take care of that.
# 59 is the start of the filename. that's all we care about.
      unzip -vqq $x | cut -c 59-

  fi
done

Spent some time installing frontend-ampira on my mac, then setting up
the classpath. This is a convenience to help me find classes
faster. I wonder how the Windows people do it?

Did a cvs update on emacs but it still won't compile.

Once I set up virtual servers on the Windows box the classpath was
hosed again. Copying them to the resin/lib dir didn't work; I had to
put all the jar files in each virtual server's WEB-INF/lib. I was
able to import com.evolutionware.CORBA.CoreObject then.


notes from the windows box:

Disabling IIS:
settings->control panels->admin tools->services->www
publishing->right click->startup-type->disabled

Install JRE
Install Resin (both are in Temporary Items on bababooey)
Copy the jar files over, make them available by placing them in:
resin-2.1.6\doc\WEB-INF\lib

edit the hosts file in c:\winnt\system32\drivers\etc\ 
and add the hostnames

get resin.conf and web.xml from staging, modify to work:
Adding these lines to resin.conf does it:

<host id='ampira.jess.ampira.com' doc-dir='frontend-ampira' class-update-interval='2'></host>
<host id='fcgold.jess.ampira.com' doc-dir='frontend-fcgold' class-update-interval='2'></host>
<host id='hostgs.jess.ampira.com' doc-dir='frontend-hostgs' class-update-interval='2'></host>
<host id='hostv3.jess.ampira.com' doc-dir='frontend-hostv3'
class-update-interval='2'></host>

Add all the jar files to resin/lib and quit/restart httpd

eventually when directory services are needed, the dvl servers 
  will be up and her setup can point to that.


There is probably a way to add the jar files by editing resin.conf
instead of copying all the jar files to every lib dir (this would be
the Right Thing). Got it... had to stop/start Resin.

Also:

<%@ page import="java.util.*" %>
Classpath=<%= java.lang.System.getProperty("java.class.path") %>

---

Well, the install on Jessy's machine failed. I don't know why. I
theorize that it's because I installed it as Administrator on my
machine but as jhanley on hers. Resin didn't automagically create the
app directories.

I think it's because I installed resin.conf instead of
resin.conf.txt, from the Temporary Items folder.

I copied the Python db2 module from evw-1.dev since it wouldn't
compile on evw-1.dvl.

Started a bind compile, and fortunately I was running screen because
the network was cut at 6ish; I can reconnect to my screen session in
the morning and see if the compile finished.




#########################################################################
021206 Friday

In by 9:10.

BIND compiled last night without a hitch. My good habit of using
'screen' saved the day; the network went offline as scheduled before
the compile completed, and though I lost my connection the session
continued on evw-1.dvl.

I found out both Tomcat and Resin are needed on the dvl env, same as
staging.

This is at
https://cvs.corp.fortunecity.com/cgi-bin/cvsweb.cgi/swain/LOG.txt

Question: what user does muddleftpd run as?
Q2: How do we test the total configuration of a system? Hand-clicking
a few links?

After my work with guitester at CT, I would venture that a
domain-specific language is needed to do www gui testing. It should
be simple enough to learn in a day, but sophisticated enough to
handle a lot of weird situations.

Found a book on Amazon that looks interesting: a book on grey box
testing for Web applications. Put in the "for later" shopping cart.

Copied the libftpmagic.so file over to dvl, muddle looks happy now.

Installed resin on evw-1.dvl in /opt/resin-2.1.6. The bin/ is under
this dir.

I can't copy exim off ims-1 since I'm not in the sudo list, and some
dirs are not viewable by me.

iPlanet is some Sun thing now. It's not clear what version we
use. Not clear to me anyways.

Gautam's email from earlier this week:
Ops team,
    Could you guys please accommodate the following tasks in your schedule
for this week so we can get a dev environment for EVW up and going this
week. Please workout the exact schedule for this stuff with swain.


Install/configure Bind - Lisa
Install/configure DB2 - Lisa
Install/configure Trellix - Lisa

Install/configure LDAP - Zlatin
Install/configure muddleFTP - Zlatin
Install/configure Apache (w/ PHP and chillisoft extensions)- Zlatin

Lysa owes me Trellix today; I already did BIND and DB2. I did
muddleftpd. Just sent an email updating Gautam's email above.

After reading the long, complicated install docs for Chili!Soft, I
tarred and downloaded it off cws-1.dev, and the same for apache. The
tarballs were huge.



#########################################################################
021209 Monday

I started on Exim at the COB Friday. It will be another shot in the
dark. I can't just copy it off ims-1.corp because I am not in the
sudo list, and Lysa told me something about how that wouldn't work
anyhow (I think. I should have made a note on that.) Zlatin did a few
things over the weekend, namely installing ldap and doing config work
for Apache and muddleftpd.

I cvs updated emacs and it's compiling... looks like it might make it
this time. Nope. Died trying to make the menu or something.

Lunch: approximately 40 minutes.

The day flew by. Lots to do, lots done.

Jessy just walked me through what users have to do after they've
registered. She showed me how the user, *after registration*, has to
set up their ftp account, set up mailboxes and mail forwarding,
etc. They could not until recently ftp files to their.domain.com, but
with one of the new visps this is possible.

I'd like to see registration next, since I have to spec out PayPal for
the site. I compiled Exim, though it might not be correct; ImpMail is
part of evw, I think.

I found Lysa's list on Twiki, which is really a list on rollouts to
cws. I worked for a while on a problem where a credit card report
times out; I was reading the Python code and doing some sample
scripting.


#########################################################################
021210 Tuesday

Notes from yesterday are incomplete. This morning I downloaded and
tested Chimera (Gautam pronounced it right, rhymes with "eye
mira"). It's pretty speedy all right, and uses some spiffy Cocoa
features like the side tray. I'm trying a Dock that doesn't autohide
and is small. Seems faster.

Got my cursor/foreground/background colors set, but it's not
universal... when I open a new frame it has the default
colors. Speedbar has the default colors. I had to restart to get the
cursor color to be universal. Also, make clean/configure/make
bootstrap did the trick in getting it to compile, but I'm going to
wait to do a make install.

This font looks funny with colors reversed.

I've spent all afternoon reading ccTransLogReport.vps, learning db2
commands, and trying to find why this script fails. However today it
only returns one error, "No records found due to an error." The
shitty script does not catch the error and report why it
failed. Totally ambiguous.

Wainstead \ [to darky]: but i think you follow my problem. I'm facing this:
[Type lines of input; use `.' to end or `@abort' to abort the command.]
>> Command Aborted <<
[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
try:
   build sql query
   run sql query
   process the results
except:
   usless text string error message
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
Wainstead \ [to darky]: in java i can at least printStackTrace or something. i 
think you're saying python does have an Exception object and I can inspect 
that.
DrDaByGoD says, "i've drank like 400 quarts of water today. how can i be 
thirsty after eating one fucking cookie."
darky [to Wainstead \]: yes.
darky [to Wainstead \]: except Exception, e:
darky [to Wainstead \]: now, printing stack trace, sec.
Wainstead \ [to darky]: oic.
You say, "drat. my python book is too old."
darky [to Wainstead \]: from traceback import print_exc
darky [to Wainstead \]: print_exc()
darky [to Wainstead \]: will spew traceback about current exception to stdout.
darky [to Wainstead \]: or maybe stderr.
Wainstead \ [to darky]: danke
Wainstead \ tries
darky [to Wainstead \]: traceback.format_exception() in combination with 
sys.exc_info() might be helpful too, if you want to log it or something.
darky [to Wainstead \]: something like apply (traceback.format_exception, 
sys.exc_info()) will apparently return a list of strings to be printed as part 
of the exception information/stack trace.
darky [to Wainstead \]: also 
http://www.python.org/doc/current/lib/traceback-example.html. :)


Help from darky on Python exception objects. I don't know if our
version is new enough to apply this.



#########################################################################
021211 Wednesday

Spent a lot of time yesterday working on the bug in the credit card
report. There were some detours and misteps along the way; for
example I spent way too much time trying to do db2 stuff, and one
error was being caused by my using the wrong host name
(secure.ampira.com instead of the correct evw-1.ampira.com). At the
end of the day it looked as though the difference between 7 and 8
days back was the problem. I'll test that again today.

My Windows box makes a squeaky sound. It's the fan in the back, I
think.

Reading over Lysa's instructions for migrating evw: first run
/etc/profile. This is different from Sun's default only in these
lines:

LD_LIBRARY_PATH="/opt/evw/lib:/usr/local/lib:$LD_LIBRARY_PATH:/opt/muddleftpd/li
b":/opt/evw/lib:/usr/local/lib:/opt/evw/lib:/usr/local/lib
export LD_LIBRARY_PATH

EVW_HOME=/opt/evw
export EVW_HOME

CLASSPATH=.
CLASSPATH=$CLASSPATH:$EVW_HOME/evw-frontend/WEB-INF/classes
for a in $EVW_HOME/java/*.jar ; do
  CLASSPATH=$CLASSPATH:$a
done
for a in $EVW_HOME/java/*.zip ; do
  CLASSPATH=$CLASSPATH:$a
done

export CLASSPATH

There is some weirdness with the F keys on this system. control-f7
doesn't register in Emacs. In Key Caps control-F2 opens the Apple
menu. Emacs can't see F14 or F15 either. I was just making a list of
my F keys and what they do and discovered this.

Lysa's docs are about rolling out to cws, no surprise there. Noone
has ever done a rollout of evw; it's always been set up by SF.

Wrote a little Perl script to loop and fork, running tests against
evw-1.ampira.com. Unfortunately it seems to wait for each process, so
I must have put 'wait' in the wrong place.





#########################################################################
021212 Thursday

I still need lisp to self-truncate a buffer. That is, when program
output in shell mode is excessive, turn off font lock mode and keep
the buffer size under a certain limit.

Met with Gautam for a bit to do estimation of the PayPal job. He's
going to send an email later.

I checked the ldap log on db2-1.prv and I don't see anything
unusual. No high activity when I run the query, nothing in the error
log. I never did see how ldap could have figured into it since the
.vsp script doesn't seem to do anything ldap; it calls db2 and
processes the results. The problem is consistently a 7 day problem
though; more than 7 days means no data returned.

Met with Jessy to see how the buying process works for customers. It
looks like we might have to add a page to branch from our own credit
card way to paypal; it might be clunky not to.

It's noisy in here today.

Zlatin gave me sudo access on db2-1.prv, and I was able to run the
query created on staging; but db2 complained there were no such
tables. Hrmm.

etags: /usr/local/bin/etags --language=python `find . -name \*.vps`
seems to work.

With the help of Zlatin I got the query to run on the production
server for DB2. With Chris' help I got a query out of the prod
version of the cc.vsp file. The query was not the problem; it returns
right away.

I got lost in the Python code eventually because of the combination
of whitespace indentation and mixed in HTML. Bad idea!



#########################################################################
021213 Friday

11am meeting; spent the day continuing the bug hunt for the Python
script
(/opt/cvs/evw/frontend-ampira/billing/GenericCreditCard/ccTransLogReport.vps). My
initial hunch that the problem was seven days vs. eight days was
wrong; it was just the server timeout settings. I wrote an email to
Gautam outlining the problem and possible fixes.



#########################################################################
021216 Monday

No transit strike, sadly. :-)

Just did the VISP test after the 11am meeting. One of the three
failed. Have to meet with ops and Gautam at 3 to plan the rest of the
Evo install on devil.

The continuing saga: I tarred the whole /opt/evw dir on staging, 240
MB. Took a while. I tried to scp it to dvl but evw-1.dvl's routing
was hosed. Got Zlatin to fix it. scp the file; it hangs at 60%, start
over, go out to the bank and come back and it's done. Now untarring
it (also taking a long time).

I have the list of files needed for config, dunno if it's the
complete list but we'll see. We're waiting on a ticket calling for a
new token; evw calls a key server or something.

Man, that took a long time. The 240MB is finally untarred, and I
copied the /etc files over too.



#########################################################################
021217 Tuesday

I'm suddenly annoyed because some of the useful tools I wrote at
capital thinking are still there. I'm IMing Tarquin hoping to get a
tarball of the tools I wrote.

Can't get a remote display of Emacs off the devil env
anymore. Strange. I followed the directions here in my log. It
doesn't work off either machine anymore.

My nose won't stop running. Most annoying. I have congestion and it's
interfering with my work.

Zlatin is redoing the setup of ldap. He's moving the existing files
out of the way and copying everything from staging again; the db
files in place now cannot be edited for a variety of reasons. It has
something to do with the /d0 directory and symlinks.

Meanwhile he told me that in production they are trying to keep all
agents using certain port ranges, and this might not have made it
down to staging yet since we do that backwards (migrate from
production to staging).

Zlatin redid ldap, and said it ran with no problems now. I restarted
evw on evw, and we now have five services running where we only had
four before, so a small gain.

I'm looking at Python scripts for loading DNS info into ldap, a
script that worked with evw circa the 12.x release; we use the 14.x
release and these scripts don't work anymore. Zlatin opened a ticket
and SF is looking into it, but meanwhile I'm to assess the situation
and come up with example questions we'd have to ask about the system
and the API to decide if we can do this ourselves or not.

I also wrote a Lisp function for setting the colors when I open a new
frame in Emacs.





#########################################################################
021218 Wednesday

Met with Steve Wolf at 1030 on the PayPal stuff. The decision was to
do this for V3 subdomains, doing it the simplest way possible, to
gauge the demand from our users. Meanwhile I'm flying high again on
Nyquil.

Went to Times Square with Lysa to get a present for the Secret Santa
gift exchange.

"Compound Members" is the page on apidocs.systemsfusion.com that
lists all members of all classes, a handy way to look things up.



#########################################################################
021219 Thursday

Steve is looking for a general understanding of how the Evolutionware
system works, so we can ask intelligent questions when they
upgrade. That's an oversimplification of our conversation from a
little bit ago, but that will do for now.

I ran sdiff on connectToBaseModule.py and connectToApacheAgent.py,
and indeed, look at this:

#!/usr/bin/python                     #!/usr/bin/python
#                                     #
# Name: connectToBaseModule.py        # Name: connectToBaseModule.py
# Desc:                               # Desc:
#                                     #


# Imports                             # Imports
#----------------------------------   #---------------------------------
import evw.Core                       import evw.Core
import evw.Base                       import evw.Base
from evw.CoreUtils import *           from evw.CoreUtils import *
from Fnorb.orb import CORBA           from Fnorb.orb import CORBA
from Fnorb.orb import TypeCode        from Fnorb.orb import TypeCode
import sys                            import sys
                                    > import evw.Server
                                    > import evw.Web
                                    > import evw.Apache


Here slightly edited for brevity. So yes, the SFusion people don't
even change the script name.

Zlatin just showed me the ticket system for Systems Fusion, something
I should have seen weeks ago. I was completely out of the loop on a
conversation about installing evw on the devil
environment. tar/gz/gunzip/untar is so insufficient, according to the
sales engineer, that it "won't even scratch the surface" of what
needs to be done.

I'm theorizing that the java classes are loaded from the Java
classpath, unless evw.Core is something else entirely.

Just read through the Fnorb tutorial. CORBA looks fairly simple when
done in Python. More and more, everything looks simple.



#########################################################################
021220 Friday

In late, mostly because of this head cold; though I think my
coworkers suspect a night of debauchery on my part. I was out very
late but was never really over the edge, drinking-wise.

Yesterday was actually a pretty fruitful day in terms of grokking the
system. I read though the Fnorb docs, and the whole CORBA thing in
Python is very straightforward, and fortunately I've read about .idl
files before.

So I have a somewhat better picture now. I was told when I started
that Evolutionware calls Java from Python, and I thought that meant
directly; but I found yesterday that it's really more of a
client-server design where every class in Java is a server and there
are Python client programs to manipulate them. Conceptually CORBA is
very straightforward, but I imagine the devil is in the details.

I solved, partially, the problem posed to me by Stve Wolf: what would
we need to know, to ask, if we are to do these scripts ourselves? And
the short answer is, SF has newer classes they are using in their
current scripts that must be appearing in the next version. Since we
don't have these classes yet anything we write now would be obsolete
with the next release, and to make matters more difficult there is no
documentation I've found on the current API that we use.

Generated javadocs on the jar packages we have from SF; I'm trying to
do it for a number of packages now, but javadoc keeps running out of
memory.






#########################################################################
021223 Monday

Met at 10am with Jeff and Gautam. Looks like I'll be adding PayPal to
V3.

Joe Strummer's death was announced today.

No 11am; went over the v3.com stuff with JeffO. I think I might try
to set it up on my osx box instead of a new Linux box. We found we
can drag and drop files and folders from Finder onto Emacs and Emacs
opens them correctly.

I have a partial list of the Apache modules; I need to link
/opt/v3.com to ~/Sites/projects/v3.com.

Installed Ant and ran a small buildfile to test it. Looks good. Slow,
of course.



#########################################################################
021224 Tuesday

Installed many, many Perl modules today, plus the Expat library for
XML. Looks good. I was puzzled for a bit over HTML::Trunk until I
remembered Jeff said it was a kludge from the previous programmers.

Once I got CPAN.pm and LWP installed, installing modules went a lot
faster. CPAN.pm has an annoying way of failing when 'make test'
fails for a particular module though; I like the 'follow' feature a
lot.




#########################################################################
021226 Thursday

I need to update my .emacs file globally.

We are told we can leave early, I leave at 1:30 pm to get a haircut.


#########################################################################
021227 Friday

Apache logs are in /private/var/log/httpd.

JeffO helped me get the rest of the config right for V3. Gautam will
want to do it next.

Jeff updated stuff and put it into cvs, so I need to redo the
database stuff on Monday. This means ./setup --user=root kinda thing.





#########################################################################
021230 Monday

Moving day. I have all my stuff ready for Basil; all my books and
stuff are moved and the space cleaned up.

Done: tweak of Apache::Registry config, suitable email test page,
move of things, installed new hard drive in Mac, helped Chris debug a
Trellix problem.




#########################################################################
021231 Tuesday

Happy new year.

Aha. The refused connection is a redirect to bibit. Thur: find/edit
the page that sends you to bibit.



#########################################################################
030102 Thursday

Fixed problem with Emacs where the emacsclient woudn't work. There
was a snippet of code I found in the release notes for version 2.1 of
ProjectBuilder. There were three lisp files missing from my 21.3.50
build that came with Apple's version of 21.1. Then I just had a PATH
problem where 21.3 was calling 21.1's emacsclient. That tiny bit is
what I figured out last night before falling asleep.

Find all .pm and .pl files for TAGS:
find . \( -name "*.pm" -o -name "*.pl" \) -print | etags -

In order to add a page to redirect to PayPal I will have to add some
template files, perhaps only one, and/or edit one template to allow
the user to choose between payment methods. I can write this now
saying I've read a lot of the code, including the man pages on
Template Toolkit, and I have a sense of how it will be
impemented. Funny how with static HTML it could be done in a few
minutes.




#########################################################################
030103 Friday

ssl4d3r is the passphrase for my ssl.



#########################################################################
030106 Monday

Friday was partially hosed by the network outage, which was the War
of the Print Servers.

We had our 11am meeting at 1030, and I just got SSL working thanks to
the nice article on Apple's dev site. I doubt the config is right for
the test servers, but JeffO can hopefully help me with that. I'm
meeting deAnna for lunch in Grand Central today.

Got the config fixed with the help of Chris Ferry. I just had to call
it with -D SSL, which apachectl wasn't doing.



#########################################################################
030107 Tuesday

Finally narrowed down the "Bus error (10)" to the ssl apache.

Here is what I'm seeing in the error_log:

[ debug ] V3::Bibit::Order::getAsXML->(  )
[ debug ] V3Core::Template::process->( TEMPLATE => bibit/order_xml )
[Tue Jan  7 15:25:22 2003] [notice] child pid 3363 exit signal Bus error (10)
[Tue Jan  7 15:25:24 2003] [notice] child pid 2964 exit signal Bus error (10)
[ debug ] V3::DB::_connect->( pid => 3372, dsn => dbi:mysql:v3:host=localhost,v3,v3 )
[ debug ] V3::Bibit::Webshop::run->(  )
[ debug ] V3::Bibit::Webshop::run->( bibit )
[ debug ] V3::Bibit::Webshop::handlePayment->(  )
[ info ]  V3::Bibit::Webshop::_checkForValidRequest->(  )
[ debug ] V3::Bibit::Data::_queryCustomerInfo->( customer_id => 1 )
[ debug ] V3::DB::_connect->( pid => 3366, dsn => dbi:mysql:v3_cust:host=localhost,v3,v3 )
[ debug ] V3::Bibit::Data::_querySubdomainInfo->( subdomain_id => 1 )
[ debug ] V3::Bibit::Data::_queryPackageInfo->( package_id => 1 )
[ debug ] V3::Bibit::Order::sendToBibit->(  )
[ debug ] V3::Bibit::Order::getAsXML->(  )
[ debug ] V3Core::Template::process->( TEMPLATE => bibit/order_xml )
[ debug ] V3::DB::_connect->( pid => 3372, dsn => dbi:mysql:v3_cust:host=localhost,v3,v3 )
[Tue Jan  7 15:25:32 2003] [notice] child pid 3366 exit signal Bus error (10)
[ debug ] V3::DB::_connect->( pid => 3377, dsn => dbi:mysql:v3:host=localhost,v3,v3 )
[ debug ] V3::Bibit::Webshop::run->(  )
[ debug ] V3::Bibit::Webshop::run->( bibit )
[ debug ] V3::Bibit::Webshop::handlePayment->(  )
[ info ]  V3::Bibit::Webshop::_checkForValidRequest->(  )
[ debug ] V3::Bibit::Data::_queryCustomerInfo->( customer_id => 1 )
[ debug ] V3::DB::_connect->( pid => 3372, dsn => dbi:mysql:v3_cust:host=localhost,v3,v3 )
[ debug ] V3::Bibit::Data::_querySubdomainInfo->( subdomain_id => 1 )
[ debug ] V3::Bibit::Data::_queryPackageInfo->( package_id => 1 )
[ debug ] V3::Bibit::Order::sendToBibit->(  )
[ debug ] V3::Bibit::Order::getAsXML->(  )
[ debug ] V3Core::Template::process->( TEMPLATE => bibit/order_xml )
[ debug ] V3::DB::_connect->( pid => 3377, dsn => dbi:mysql:v3_cust:host=localhost,v3,v3 )
[Tue Jan  7 15:25:40 2003] [notice] child pid 3372 exit signal Bus error (10)
[ debug ] V3::DB::_connect->( pid => 3393, dsn => dbi:mysql:v3:host=localhost,v3,v3 )
[ debug ] V3::Bibit::Webshop::run->(  )
[ debug ] V3::Bibit::Webshop::run->( bibit )
[ debug ] V3::Bibit::Webshop::handlePayment->(  )
[ info ]  V3::Bibit::Webshop::_checkForValidRequest->(  )
[ debug ] V3::Bibit::Data::_queryCustomerInfo->( customer_id => 1 )
[ debug ] V3::DB::_connect->( pid => 3377, dsn => dbi:mysql:v3_cust:host=localhost,v3,v3 )
[ debug ] V3::Bibit::Data::_querySubdomainInfo->( subdomain_id => 1 )
[ debug ] V3::Bibit::Data::_queryPackageInfo->( package_id => 1 )
[ debug ] V3::Bibit::Order::sendToBibit->(  )
[ debug ] V3::Bibit::Order::getAsXML->(  )
[ debug ] V3Core::Template::process->( TEMPLATE => bibit/order_xml )
[ debug ] V3::DB::_connect->( pid => 3393, dsn => dbi:mysql:v3_cust:host=localhost,v3,v3 )
[Tue Jan  7 15:25:54 2003] [notice] child pid 3377 exit signal Bus error (10)
[ debug ] V3::DB::_connect->( pid => 3435, dsn => dbi:mysql:v3:host=localhost,v3,v3 )
[ debug ] V3::Bibit::Webshop::run->(  )
[ debug ] V3::Bibit::Webshop::run->( bibit )
[ debug ] V3::Bibit::Webshop::handlePayment->(  )
[ info ]  V3::Bibit::Webshop::_checkForValidRequest->(  )
[ debug ] V3::Bibit::Data::_queryCustomerInfo->( customer_id => 1 )
[ debug ] V3::DB::_connect->( pid => 3393, dsn => dbi:mysql:v3_cust:host=localhost,v3,v3 )
[ debug ] V3::Bibit::Data::_querySubdomainInfo->( subdomain_id => 1 )
[ debug ] V3::Bibit::Data::_queryPackageInfo->( package_id => 1 )
[ debug ] V3::Bibit::Order::sendToBibit->(  )
[ debug ] V3::Bibit::Order::getAsXML->(  )
[ debug ] V3Core::Template::process->( TEMPLATE => bibit/order_xml )
[ debug ] V3::DB::_connect->( pid => 3435, dsn => dbi:mysql:v3_cust:host=localhost,v3,v3 )
[Tue Jan  7 15:26:08 2003] [notice] child pid 3393 exit signal Bus error (10)

So why the ssl apache is dying, I do not know. Didn't find anything
through Google. I'm just going ahead for now and hack in a branch to
PayPal and worry about that later. (Also, the new Safari browser
didn't like the certificate and wouldn't even load
https://home.v3.com/.)




#########################################################################
030108 Wednesday

It would be more opitimal if we had a dev environment for v3.com
properties that anyone could hack on; I've spent far too much time
with configuration issues. It's the ssl crap that causes all the
problems.

Another dumb bug: I was using == to compare strings. Perl really
needs to overload the operator on this one.

Tried to debug the problem where, on startup, Perl bitches about a
useless use of a constant in a void context (or something). I tried
recoding the area where the problem is, which involves inheritence
and has hash magic going on.



#########################################################################
030109 Thursday

The PayPal button might be problematic. Choosing from a dropdown
means I have to add all the other form fields... not sure if this is
optimal. Jeff's solution of an intermediate page might be better.

Oh dear, crucial mistake. If you already have an account you go
direct to a screen to login, then to bibit. Suck. So my approach is
hosed. The next step is to back out the changes, and then introduce
an intermediate page which I wanted to avoid in the first place.

Creating a valid account: since the free setup works, first do
that. I've collected the activity trace -- what would be an activity
diagram in UML -- and saved them in ~/tmp.

The points of departure are traced, just insert an intermediate
screen.


#########################################################################
030110 Friday

Dr. Fisher says no upper body lifting, and to get a sling, and take
my indomethicin, lose weight, my ankle is just sprained, and she
doesn't accept Empire Blue Cross.

Gautam asked for items we wish for, for a software development road
map. I thought at the moment that I had nothing to contribute; but I
now see that for in-house code, we need a set of coding
guidelines. All the Perl modules for v3 should have flower boxes and
CVS 'log' tags. This is a minor thing to ask for; even better is if
all this info is in Pod format. I'd be willing to help put this in
place.

We had a meeting at 4pm, and Gautam dropped the bomb on us: a new
head of systems will start on Monday. The ops team doesn't know
this. They never met him. Even worse, perhaps, is that he hasn't met
them yet.

I half-heartedly pitched the idea of "quiet time" here, two hours a
day, since Gautam raised the idea of an IRC server again. (It happened
when Zlatin was leaning over my cubicle shouting to Jessica). The two
ideas tie together: quiet time, only IRC talk allowed. This allows
optional monitoring. I think Gautam asked Lysa to set up a server on
the machine that hosts Twiki and CVS. We also kicked around the idea
of a blog. I like that one: an intranet blog where anyone can post
something.

I've gotten little done today. Late due to doctor's appointment,
meeting, lunch, some work, then another meeting.

Jeff showed me a different place to put in the intermediary page
asking for payment method. It would be in a Bibit module, which I
would have totally avoided b/c it's not intuitive (see True Names and
Other Dangers.)





#########################################################################
030113 Monday

We had the 11 am meeting; I thought I might get my work finished
before that, but I did not, due to hassles changing the redirect URL.

Victor just came to me and said that he didn't like my current
approach because it adds another page to the login process. I outlined
the issues for him and he was adamant; I told him to put this through
Steve Wolf and Gautam so they know I'm facing a setback. Now all my
work from Thursday and Friday goes out the window.

Met the new head of Ops today. Seems nice enough. Wonder how the
first big meeting went.

Finally filed a bug report on the CVS problem with Emacs under Aqua,
which has been driving me crazy. I cannot send email from Emacs which
is why it's taken me so long... Emacs acts like it sends the mail
with no problem, but I never receive test messages I send.

Also filed reports on both the speedbar bug and line editing in shell
mode.




#########################################################################
030114 Tuesday

My posts to the Emacs pretest mailing list made it. I remembered I
found another problem, use of (server-start). My compile/install
problems as of late with Emacs probably lie in not doing a "make
bootstrap." Also there is a problem sometimes with scrolling up,
where it tells me I'm at start of buffer when I'm not.

Gautam didn't get informed yesterday by Victor that the specs for
PayPal changed, since Victor wanted the interface changed all
around. I asked Victor to tell Gautam and Steve Wolf but he didn't.

I changed my $PATH back to the way it was originally, so it doesn't
search /usr/local/bin ahead of /usr/bin. I set the full path to
emacsclient in .emacs_bash.

Gonna do a full configure, make, install today. I'll drop a new
distro in my shared folder. If it compiles!

The file templates/additional/additional_login.tt2 is not called from
anywhere else, so I can just insert the radion buttons and not use
Template Toolkit's conditional logic.

Buttons:
<tr>
	<td class=signupinput align=right
	valign=middle><p
	class=domaintext3>&nbsp;PAYMENT METHOD:</p></td>
	<td class=signupinput
	align=left><!--&nbsp;<input
	class="signupinput2" type="password"
	name="password"
	style="width:200px;"/>--> 
          PayPal: <input type="radio"
	value="paypal" checked="no"
	name="payment"> Credit Card: <input
	type="radio" value="credit_card"
	checked="yes" name="payment">
	</td>
</tr>

Hack: I think I can get away with only redirecting to paypal. The
default behavior is to go to bibit, and only if the user selects
paypal do we use that url. Problem: changing the ACTION of the
form. Perhaps I should use a clone of the redirect page.

signup_init.tt2 is where you enter the two email addresses; it's fed
its ACTION url via a variable, but it just renders as:

<form method="post" name=emailcheck action="/app/signup" enctype="application/x-www-form-urlencoded">
<input type="hidden" name="rm" value="handleAgreementForm" />
<input type="hidden" name="x" value="UmFuZG9tSVa8+kOAFTcEBM8vNpjy+jIy7uguduBIl7yKCJZT8e/YHitmbwYEIuYpAiEPpPahnXO4
/ojxHKtkx1X8+xzIityD
" />

Here "rm" is the remote method (?) and 'x' contains all the form
data which is processed via HTML/Trunk.pm.

In additional_login.tt2, we find:
<form method="post" action="/app/additional/" enctype="application/x-www-form-urlencoded">
<input type="hidden" name="rm" value="handleAdditionalLogin" />
<input type="hidden" name="x" value="UmFuZG9tSVa8+kOAFTcEBH5fU0aQgdQ30u6V178dXHLvYIcpOvEkhklNlUssDW0msjXXunTzOvQzkQ4faBoin8my+iQofURdaVqLJ9mSclU=" />

Quick spec: for pattern at or around point, convert :: to /, search
the Perl lib path for module, load.

singup_paid_info_form.tt2 will call:

<form method="post" name=orderform action="/app/signup" enctype="application/x-www-form-urlencoded">
<input type="hidden" name="rm" value="handlePaidInfoForm" />
<input type="hidden" name="x" value="UmFuZG9tSVa8+kOAFTcEBH5fU0aQgdQ3JxxpN61zmK+sZAmu2eVl7AP+VozAza/Dq8/1Ni4r/g3c
9imxj2Guw/IxggSLPpl9yatWMg0/nfpEbIqOsaUpXUWNgiY9NAbO
" />		

the stuff from paypal sayeth:

<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_xclick">
<input type="hidden" name="business" value="info@v3.com">
<input type="hidden" name="item_name" value="[see below]">
<input type="hidden" name="item_number" value="[see below]">
<input type="hidden" name="amount" value="12.95">
<input type="hidden" name="no_note" value="1">
<input type="hidden" name="currency_code" value="USD">
<input type="image" src="https://www.paypal.com/images/x-click-but01.gif"
border="0" name="submit" alt="PayPal payment">
</form>
<br/>
<a href="[% bibit_url %]">credit card</a>



#########################################################################
030115 Wednesday

Jeff beat me in today. Surprising.

Good-o, PayPal accepts GET data. That simplifies matters.

subdomain table:
sub_v3url is the name you input (your-name)
uri_scheme_host contains the domain, which must be a foreign key thing


Victor's email:
The PayPal Business account is now set up. The email/login is info@v3.com
(I'll write down the password in a piece of paper).

HTML code for pay button
------------------------
(available at https://www.paypal.com/cgi-bin/webscr?cmd=_sell)


<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_xclick">
<input type="hidden" name="business" value="info@v3.com">
<input type="hidden" name="item_name" value="[see below]">
<input type="hidden" name="item_number" value="[see below]">
<input type="hidden" name="amount" value="12.95">
<input type="hidden" name="no_note" value="1">
<input type="hidden" name="currency_code" value="USD">
<input type="image" src="https://www.paypal.com/images/x-click-but01.gif"
border="0" name="submit" alt="PayPal payment">
</form>

Please notice that "item_name" and "item_number" (and "amount" as well) will
change depending on the customer's choice. If an i.am domain is selected,
then we'll get:

"item_name"=V3 Gold Member - i.am 1 year
"item_number"=4




#########################################################################
030116 Thursday

Very productive day yesterday. I have all the pieces in place for
PayPal; I need to do a code review with Jeff. One thing that bugs me
is Victor's assertion that the price will change based on what the
user selects, and I think that might be an error. The price is
temporarily hardcoded into the file. That's one thing I need Jeff's
advice on. The other is abstracting metadata out of the Perl code to
(likely) Config.pm.

I've copied the method to the other class -- that is, the method
_redirectToBibit() exists in two Perl modules, JeffO just copy/pasted
it -- and stepped through the four paths (new user paypal/cc, and old
user pp/cc) and it looks good to go. What happens after the Paypal
site is reached, I do not know.

There does not appear to be a ticket open right now for the dvl
environment in SystemsFusion's queue.

Met with JeffO, and we pulled in Victor. Showed the processes that
lead to PayPal. Problems: there is no way to manually vett PP
transactions yet. It would be optimal if we could send through the
"success" url to redirect the user. This would activate the account,
at least. There is a 48 hour time limit on new accounts and they are
wiped if not validated. Passing an order ID is also essential -- more
concretely, if we can pass the subdomain through to PayPal and get it
in the mail, this would be a win.

To restate this, minimally we'd need the subdomain passed by email to
Victor for manual vetting. Better still is to be able to redirect the
user to a succuss URL on our site that activates the account.

(Note to self: write out a better functional spec next time.)

Got success and failure urls into paypal now, thanks to JeffO's
advice. Dunno if they will work though. Put a puzzle to Jeff and
Gautam on finding a Perl module; I wrote up a little solution.

The real trick though would be to "find module at point." Reason
being, I'd have to parse the text around point for something like
Foo::Bar::Baz.





#########################################################################
030117 Friday

Testing values before sending them to bibit (from SignupView.pm)

	#
	# check that encoded params are valid
	#

	my $params = $self->_getEncodedParams( $q->param('x') ) ;
	if ( 
		! $params->{'v'}	# v3_url
		|| ! $params->{'d'} # domain_id
		|| ! $params->{'p'} # package_id
	)
	{
		$e->error( 'Invalid Request: Data is missing' ) ;
		return ;
	}

	$e->debug( Dumper( $params ) ) ;

Breakdown of the decoded url we get as a redirect:


o: 2003011714303339435 order id
p: 3 package id
s: 83 subdomain id
c: 83 customer id
ok: 1 someone's not messing with url

url: my $data = 'UmFuZG9tSVaCHkcXuB+qpmJaweY/LW/e+4SD30MEjQCYKqHfvXJoEZgSdRX4YLOKm4cALpOXiku01K4ISYTrr2ARqMdnu/1xGpC9FEoy7cYWmvkn4XniHD3t8weGRpwIXrzd2A46Xx4=';

Probably need to uri_encode the urls.

sending:
success url:
https://home.v3.com/app/signup/ok/?o=UmFuZG9tSVY0DT%2BMScHS%2Byy5A6cA3Y%2BBosFwHH%2B1IJbtJnhVJQp%2B3QuaAmqjlLfP%2FcRv7021MGhL%0AWbPyFqApqzff7IQfsAHTAZFw7aJmBKh1NrPJj7CReBWBmEuX%2BwKnIs4c1%2FymBDE%3D%0A




#########################################################################
030120 Monday

zahn [to DrDaByGoD]: you need to start acting out your fantasies...
DrDaByGoD [to zahn]: i don't have that kind of time.

Getting an out-of-memory error this morning starting Apache.

Bad redirect, revisited:

https://home.v3.com/app/additional//ok/?o=UmFuZG9tSVbTUT9FT2I5lkjfXMuPmiEoR2uCgB8G7GiKvrUjHTerWNX6CwGAg6G1xtaxOwKVNJBoI54Epe4ck2UxAQOWIqdpfXl52XXlT6RvYzK8d/AzYRaVJN5irrDa8AqZtSz1WG8=

Going to this URL when going to bibit:
https://home.v3.com/app/bibit/?x=UmFuZG9tSVbTUT9FT2I5ltJ8STvn9fIXVHw%2FuOR1oQieWWzCgo%2B%2F0IobrWu97YKFxOFCa120z1n8%0A1Yo4y3H82g%3D%3D%0A

Going to this URL when going to paypal:
https://www.paypal.com/cgi-bin/webscr/?cmd=_xclick

&business=info@v3.com&no_note=1

&currency_code=USD

&item_name=V3%20Gold%20Member%20-%20come.to%201%20year

&item_number=1

&return=https://home.v3.com/app/additional//ok/?o=UmFuZG9tSVampC0QcwXXZcuRwtmmNKm9oJPKiC7MkWU8I2PBwdx%2F7o5alNizJiBu0FDwiMRtXlv1%0AkP0EzukwkEKspuGzYPYFpv0PaOCqAni2O4VRnYMCgctY6vEXyY08S2TVfybvAZI%3D%0A

&cancel_return=https://home.v3.com/app/additional//failed/?f=UmFuZG9tSVampC0QcwXXZcuRwtmmNKm9%2BM3fp8KfsKvAec3HwL2GtTK3tborpG19iboIm0LKzSgU%0AOnFDUWG5mFTp4RM5dOeUoMX1wgXjPYbval3KiWj%2F8AdTkEptE1%2BzcxsbmVztuZsWYnoq7yOoPg%3D%3D%0A

&amount=12.95

Redirect, after passing through paypal: 
https://home.v3.com/app/additional//ok/?o=UmFuZG9tSVampC0QcwXXZcuRwtmmNKm9oJPKiC7MkWU8I2PBwdx/7o5alNizJiBu0FDwiMRtXlv1kP0EzukwkEKspuGzYPYFpv0PaOCqAni2O4VRnYMCgctY6vEXyY08S2TVfybvAZI=

o=UmFuZG9tSVampC0QcwXXZcuRwtmmNKm9oJPKiC7MkWU8I2PBwdx%2F7o5alNizJiBu0FDwiMRtXlv1%0AkP0EzukwkEKspuGzYPYFpv0PaOCqAni2O4VRnYMCgctY6vEXyY08S2TVfybvAZI%3D%0A
o=UmFuZG9tSVampC0QcwXXZcuRwtmmNKm9oJPKiC7MkWU8I2PBwdx/7o5alNizJiBu0FDwiMRtXlv1kP0EzukwkEKspuGzYPYFpv0PaOCqAni2O4VRnYMCgctY6vEXyY08S2TVfybvAZI=

The odd thing is the first one contains carriage returns. These
appear to be filtered out by paypal. The first one is created by
JeffO's stuff.


https://home.v3.com/app/bibit/ok/?o=UmFuZG9tSVampC0QcwXXZcuRwtmmNKm9oJPKiC7MkWVqRFxR7D72j6ItFOLywy3NoJ0QZdGLIGG1UFEt1UxJbXZyVBwXf+Qvil9ru68XyANZhO0eidW+TGnZ9qAkBGs6X/BsUDh1xFM=


Jeff changed a method; because we refactored, the url had to be
constructed differrently. Restarting Apache, I got it to work.


https://home.v3.com/app/bibit/ok/?o=UmFuZG9tSVYWwFwY/kwb5KvSXmRM3RlEpFibyr/TFmk0aJ+uobawv7SCX7eYw7eLmtqXPy/eC0bmAAqgPu6sxqufzlI/NZCWBHik+ezt+mSo2JG60YgOf2yH87aPvcBV/+R7gK0u7r0=


It looks like I'm almost finished with PayPal. Jeff's code turned out
to be easy to reuse; there were a few wrinkles but with his help
things got straightened out quickly.

I emailed Victor and we'll do a test on the integration server
shortly. Meanwhile I'm tracking down the files sent by SF for moving
iReg people to dEVW.



#########################################################################
030121 Tuesday

I settled on using on-the-fly variable creation, which meant not
using 'use strict'. I feel evil:

    for my $x (0..$#cols) {
        ${"$cols[$x]"} = $fields[$x] || "";
        print "field: $cols[$x] value: ${$cols[$x]}\n";
    }

Problem: each client means one organization.xml. How to generate all
the... hm...  maybe the python script doesn't care what they are
named. Yup, opens argv[1] and not a named file. Goodo. Also takes
multiple args! Woohoo!

Got all the files generated in a subdir. Need to figure out the few
remaining fields to fill in.



#########################################################################
030122 Wednesday

We are importing iReg customers into Ampira with the ISP set to
FCTY. This is for historical reasons.

Customers of iReg are client organizations in Evw. They may or may
not have users.

Zlatin got the Python modules installed around noonish. When I run
the script it complains about a token:

[swain@evw-1 ireg]$ ./ImportOrganizations.py -v -a vcx874 org.xml.d/aameramin.com.xml 
[1] Reading System IOR from /var/System.ior
[1] Connecting to System
[1] Authenticating as user admin under org o=DMFC
[1] Connecting to Base Module
[1] Connecting to Accounts Module
[1] Connecting to Tax Module
[1] Parsing file org.xml.d/aameramin.com.xml
XML: Parse fatal error (org.xml.d/aameramin.com.xml:3:32: not well-formed (invalid token))

Not sure what 3:32 means. Ah. Row, column.

You say, "i know that as programmers go I'm in the minority opinion, but I 
think xml kinda blows."
heller says, "stupid and fucked up xml blows. saddly, that's the most common 
kind. "
darky says, "i don't like the people that think xml should be used for 
everything."
darky says, "or, rather, i don't agree with them."
heller says, "yea. that's what usually leads to stupid and fucked up xml. "
darky says, "a good point."

---

Extremely frustrating day. Evw is a black box yielding no
details. It's taken a lot of brutally tedious hacking to get the
python script to load data (two typos in the SF example file!), then
Gautam turned me on to the export script they sent... but if I had
all the info to run it, I wouldn't really need it!

I have managed to get the python script to load a user from iReg,
though, after data massaging. But oh, what I wouldn't give for the
equivalent of a mysqldump of the db2.

Lysa attempts to fill in the blanks for me:

[swain@evw-1 ireg]$ !?export
 ./exportOrgInfo.py -v -a vcx874
Admin Password: ******
using: o=DMFCvcx874

LDAP Hostname: evw-1.dev.ampira.com
LDAP Port: 400
LDAP Bind Dn: 
LDAP Password: ******
LDAP Base Dn: o=DMFC
LDAP Type (OID=Oracle Oid,N=Netscape,OL(Open Ldap): N


DB Name: evw
DB Billing User: ******
DB Billing User Password: 112233
DB Type (O=Oracle,DB2=IBM DB2): DB2


ISP Name: 
Contact person name: 
Tax Realm ID: 
Traceback (innermost last):
  File "./exportOrgInfo.py", line 613, in ?
    taxRealmId = string.atol(taxRealmIdString)
ValueError: empty string for atol()
[swain@evw-1 ireg]$ 

on evw-1.dev:
[swain@evw-1 swain]$ db2 connect to evw user evwbill using ******

Assorted db2 stuff:
https://twiki.corp.fortunecity.com/bin/view/Ampira/IbmDb2
? for help

descibe table foo (like desc tablename in oracle)


---

So in the end: couldn't find CONTACT in the database, or in ldap, or
in the html form data. Merchant ID I did find in db2, and it's
limited to length 4. Still don't have a few other fields but the
python script didn't complain about them.






#########################################################################
030123 Thursday

Assumptions --

Contact: user email address

merchantacctid: is too long

taxrealm: must be integer 0,99999. On staging they are all US: 1, 21, 41
currency: USD
balance value: I'm ANN LANDERS!!  I can SHOPLIFT!!
anniversary date: Sometime in 1993 NANCY SINATRA will lead a BLOODLESS COUP on GUAM!!

Clean out / from credit card expiration.
Zip codes not valid in some cases.
Passwords less than 6 chars.

Emailed Gautam on the iReg status. Someone needs to push ops to fix
staging. Speaking of which, the stuff Lysa did:

  108  /etc/init.d/evolutionware status                     # show status of system
  109  /etc/evolutionware/control.sh start BillingModule    
  110  tail -f /opt/evw/logs/Billing.log
  111  /opt/evw/sbin/BillingModule 
  112  /opt/evw/sbin/BillingModule 
  113  vi /opt/evw/etc/BillingModule.conf   # look, conf files!
  114  vi /opt/evw/etc/BillingModule.conf 
  117  /opt/evw/sbin/BillingModule          # run it directly to see
  the error
  118  /etc/init.d/evolutionware stop    # bounce evw
  119  /etc/init.d/evolutionware start
  120  /etc/init.d/evolutionware status
  121  /etc/evolutionware/control.sh status BillingModule  # individual status
  122  tail -f /opt/evw/logs/Billing.log

  124  /opt/evw/sbin/BillingModule
  125  vi /opt/evw/etc/BillingModule.conf 
  126  tail -f /opt/evw/logs/Billing.log  # read log file
  127  /opt/evw/sbin/BillingModule

Converted to Mozilla mail today, but now that it's configured it
doesn't seem any faster than Mail.app. Sad.



#########################################################################
030124 Friday

Had last Friday meeting today; once a week now for tech
staff. Created new spreadsheet, need to fill in some details. iReg
migration is a high priority. Chance to shine.

Did some more work on configuring Mozilla mail, but damn the thing is
slow.

Was running open wifi node in the meeting for Lysa's laptop and
Chris' handheld device, also on Avalon. Uploaded pix after the
meeting from Wednesday's pot luck.

I think I was using an older version of Zlatin's spreadsheet, or else
Perl is lopping off the leading zero on zip codes. I think it's the
former though.

continue:

[1] Parsing file org.xml.d/cheapplumbers.net.xml
Organization email address invalid for organization Weintraub Morton

No TLD in it...

In honey2thesoul:

<address type="physical"
   street1="5934 Kenilwood"
   street2=""
   city="Houston"
   state="TX"
   zip="733-4275"

Importing users will use the same organization files. Just did a test
run and most of them failed, all but one. Puzzling.



#########################################################################
030127 Monday

Swolf emphasized iReg conversion was critical. Gotta work faster.

Sent email asking for final decision on what to do with bad password
users; now chinking away at ImportUser.py errors. First one: bad user
name (contains a space).

Error creating user William Tyler: evw.Core.InvalidUsername
Error creating user Alexei Afonin: evw.Core.InvalidUsername
Error creating user drissi djalloul: evw.Core.InvalidUsername
Error creating user t_berger: evw.Core.InvalidUsername
Error creating user david riley: evw.Core.InvalidUsername
Error creating user CYRK-San Diego: evw.Core.InvalidUsername
Error creating user Pat V. Blair: evw.Core.InvalidUsername
Error creating user Helmut Lipsky: evw.Core.InvalidUsername
Error creating user John Olsen: evw.Core.InvalidUsername
Error creating user dave spangler: evw.Core.InvalidUsername
Error creating user Tracy Miller: evw.Core.InvalidUsername
Error creating user Tim Fromhart: evw.Core.InvalidUsername
Error creating user Sonja Hanson: evw.Core.InvalidUsername
Error creating user walter erikson: evw.Core.InvalidUsername

CC expiry invalid for organization Assembleia de Deus
Organization email address invalid for organization Weintraub Morton
CC expiry invalid for organization Global Netdubbing Corporation
Physical zip invalid for organization Honey 2 The Soul
CC expiry invalid for organization Maunder David
CC expiry invalid for organization Maunder David
CC expiry invalid for organization Tony Tunnell Construction & Custom Carpentry
CC expiry invalid for organization Sagan

242 records, 49 are bad.
14 bad usernames
6 bad expiry dates
1 bad zip
1 bad email
27 bad passwords

Showed these stats to Swolf just now. Finally got the answer I was
looking for: double the passwords, save list for Support. No answer
on my question of rollbacks; Swolf said to email Snair. All that now
done.

Short answer from ops: no can roll back, since it would only take us
back two days. No biggie. Proper route: SF provides us with rollback
scripts that undo what they did with the same data set.

Also, I don't have access to the Cobolt boxen, so for the time being
I'm dependent on Zlatin to get the users. I wrote up a subroutine to
expand short passwords to 6-10 chars when they are under 6.

# yay fun wee
sub double_up_password {
    my $crappy_password = shift;

    # zeroeth case, just in case
    if (length($crappy_password) == 0) {
        return "eightchr";
    }

    # if it's six or more note we just fall through
    while (length($crappy_password) < 6) {
        $crappy_password .= $crappy_password;
    }

    return $crappy_password;
}



Tried to trace through the system to see if I can write a script to
delete the users I added. From the web form I followed it into the
.vps script, which calls a Java class via CORBA, and I found the
javadoc file for that class was empty, so for whatever reason it
didn't get generated (hunch: disk full at the time of the
write). Anyway I found I need a session key regardless, so there must
be a way to generate a session key so I can call the object and
manipulate fun stuff directly.



#########################################################################
030128 Tuesday

Spent some time trying to grok Tramp. I hate using Emacs through a
term window due to the command key difference. But:

* info docs locally are hosed
* cannot download a distro to read the docs
* remote boxen don't have Emacs 21 or tramp

So it's all been  frustrating. I like the idea of Tramp though: dired
supposedly works.

Got it to work! Holy smokes it's slow. If only the x libraries were
there... sigh.

Just found that X11/xterm into evw-1 allow me to use command as
meta. sweet. I wonder why that didn't work at home.

Log files on evw-1.dev.ampira.com are in /usr/local/apache, even
though SF was told not to put them there.

Sat in on a meeting with a phone call to Chris Van Wie. Ops is
upgrading to 14.3. One thing that struck me was that we could use an
automated testing system for our customizations; I think SF only does
manual tests on their upgrades (bad), and CVW was emphatic about how
they do not support customer changes to the system; only the "admin
interface as it's shipped is supported."

Swolf asked about merging two CVS trees. SF gives us the upgrade as a
dump from their CVS and meanwhile we have been checking in our
customizations to our own cvs server... hmm... I need more details.

Sent him an email. Meanwhile, .vps files use "echo" ala:

</noframes>
<% echo("hello sailor") %>
   </body>
</html>

and not 'print' like I would have thought... I guess echo() is how
one gets Python things displayed right outside the <% %> brackets.

I have shell access on four of the five servers now, that hold the
ireg sites. Problem: a lot of the sites are not in use anymore. A
percentage have a /users directory, but it doesn't hold anything
useful.

I haven't found detailed info on the users and Zlatin has been very
busy with the Evolutionware upgrade.




#########################################################################
030129 Wednesday

Steve leaning on me again today. Wants definitive answer as to when
this user import will be done. He's chomping at the bit because he
wants to be able to go to mgmt and say, "we have a process, we can
bring in users from other isp's into EVW."

Started out right away with Zlatin tracking down user info. Zlatin
has lots of answers.

Meanwhile, structure of the cobalt server's app:

stuff is in 
/usr/admserv/cgi-bin/.cobalt
/usr/admserv/html/.cobalt




#########################################################################
030130 Thursday

Didn't get to write much yesterday, though a lot happened. After
spending most of the day acquiring user info off the Cobalt boxen,
Steve Wolf decided to scrap that part of the project. Zlatin made a
long case on importation of email addresses. Steve continued to
stress the need for speed. At the end of the business day,
/export/home was full again on evw-1 so I gave up.

In early today to get a head start. I'm trying to see how the hell
the package import part works, which we skip (I think), and how we
buy the packages for the customers.

Met with Zlatin, went over the database for email accounts on iReg,
looked at the user's admin pages for same on evw, in preparation for
the meetings. One with Petrus, one with Rob Walker.

Swolf set up a deal where the SF guys are going to do an import of
three people per package; in his own words the tools we were given
are "half baked."



#########################################################################
030131 Friday

Swolf had a realization last night: that we can't use the automated
approach to loading iReg customers if we have to stop all jobs... in
the live setting there are always jobs pending. SF also wanted us to
shut down all jobs for the visps on staging as well, which is how
they came up with a number of 400 and we only found about 187.

So it looks like the week's work will amount to naught unless SF
comes through with some magic this afternoon.

Meanwhile I found out that one of Gautam's tasks will be to search
for alternate solutions to the problems we are addressing vis. SF.

Meanwhile... installing Red Hat 8.0 on my (former) Win2K box. I'm
thinking I'll use it to do work on the Unix boxen and avoid the
keyboard schizophrenia.



#########################################################################
030203 Monday

Seems to be a small problem with the current build of Emacs:
autocomplete is broken.

I have a terrible pain in my right shoulder today. When I was shaving
it was as though it had "seized up." I think it's just more
stress. My right knee has bothered me since last night too. It might
have happened when I stepped out/in to/from the fire escape.

Morning meetings are moved to 10am. Forgot my laptop for recording
the minutes. Started bringing in books to give away.

Javadoc command:
javadoc -J-Xmx512m  `find com/evolutionware/ -name \*.java`

It seems there are enough minor differences in the five xml files for
buying packages that I will just leave them in separate files and
commit the sin of duplication.

Had two meetings today, the second one a dev meeting to bring Gautam
up to speed. He chastised us for not ccing him throughout the week.

Will there be cases where WebHost will not be "www"?

You have to create the $domain_prefix and $tld variables now:

($domain_prefix, $tld) = split /\./, $domain_name;




#########################################################################
030204 Tuesday

In 9ish. First. Stress killing me. Slept poorly. Somehow feel much
better sitting at keyboard.

Fucking 'screen' locked up on me. Fucking Solaris. I hate Sun. Emacs
doesn't seem to have desktop-auto-save-p, which it should. I lost my
whole session which is a setback. I have to figure out where I was.

When I left last night my mind was turning to clay. I couldn't get a
simple grep command to work! Wtf! I had the -i in the wrong place, I
found when I came in this morning.

Whelp. Emacs won't compile today. Try try tomorrow. I'm doing OK with
the alt keys so far today.

Well. No cvs on evw-1.dev. Bleh.

Shame on me. I can't interpolate vars via eval{} anymore. Put me out
to pasture.



Advanced Web - Monthly: ]
Internal Id:
1002046135.76690

Basic - FTP - Monthly - NSU: ]
Internal Id:
1022157906.728127

Frontpage Web - Monthly: ]
Internal Id:
1002045797.692994

Starter Web with 5 Email - Monthly: ]
Internal Id:
1005330496.964462

Value Web - Monthly: ]
Internal Id:
1002045467.332631

some notes on the whole thing:

JeffO spotted my little brain dead error with the Perl script: using
the same filehandle name twice. Good call. Zlatin walked me through
the interfact to see where the job was and its status.

The ID for the advanced package was wrong, a small gaff on the part of
Kenneth at SF. The other four were right. I have to check with Rob
Walker on Basic FTP which doesn't show as iReg.

It turns out I will hand off all the XML files to ops or support,
since every person has to be hand vetted for the domain.

There are a number of data fields that need checking to make sure they
are correct for the live environment; likely all the package IDs, the
o=DMFC, web traffic profile, tax realm id, merchantaccountid...

145 files with no issues (short password, expired cc, etc) ready for
testing.

Just double checked package IDs, they are correct for staging.


#########################################################################
030205 Wednesday

Yay, tab completion fixed, and Emacs compiles again. Got a terse
bitchy email from the Aqua maintainer. He doesn't use shell
mode. Luser. Replied and told him he didn't have to flame me.

The packages we were originally told to use were changed without
notice. Fortunately this was just caught.

At this stage I can generate the organization.xml files and the
ImportPackage.xml files... the latter is a confusing name. What it
does is buy an Ampira package for a given "org." To make matters more
confusing, I have to test against a list of domains that have no orgs
before I proceed.

We also have to add some kind of email workflow thing, I'm waiting
for Zlatin to come by and give me a better explanation of it.

# alias nextfive='mv `find undone -name \*.xml|head -5` pending/'
# alias nextten='mv `find undone -name \*.xml|head -10` pending/'



CC expiry invalid for organization Assembleia de Deus
Duplicate email address doakes@woh.rr.com for organization Astro Lanes
Duplicate email address gottalaff@aol.com for organization Scoggins Julie
Duplicate email address mkangai@aol.com for organization MMK Production
Duplicate email address rdmjmocam@yahoo.com for organization Mergawa
Duplicate organization Atlant Computers
Duplicate organization Cakes by Sharon and Ginger
Duplicate organization Dexterity Music Group
Duplicate organization Lightning Connect
Duplicate organization Mid Flight Records
Duplicate organization PAULco Computer Consulting
Duplicate username Christy for organization Home Ministries
Duplicate username adsvinow for organization Netpas Inc
Duplicate username bigdaddybmx for organization Berrios Michael
Duplicate username dalamode for organization Maunder David
Duplicate username djimusic for organization Dow Jones and The Industerials
Duplicate username emy for organization Phillips Emy
Duplicate username ivan for organization Salon Principles
Duplicate username jamie for organization Titan Sports Consultants
Duplicate username michaele for organization Eisenstein Michael


According to Lysa, security and intelligence services had their name
truncated.


Since we are now in limbo, sorta, while I wait for Zlatin to update
and sync packages, I can add some needed features to the ireg.pl
script.

email from Kenneth: FYI, the way to get the debug dump is to use this
URL in a separate browser while you are buying a package:
Hostname/wizard/buy/buy?debugDump=yes You can refresh that page on
each step and see the info collected.  So, the XML is good. We'll get
back to you on the Billing core tomorrow.

The 92 orgs created are in pgms/perl/ireg2sf/done.txt

Kenneth: 9-1-510-663-7910 x404
Chris Van Wie x406



#########################################################################
030206 Thursday

It is 10:25 am, I am working on the highly critical process of buying
packages for iReg orgs imported into Evw, and my sysadmin has been
taken away for a superfluous security meeting. I asked Christina in
Support if she knew what it meant when a job was in Pending and says

         Check if we need to do vetting for domain registration

She says that it's a new message and they don't know what it means
but it eventually goes through.

Seems like time for an update. I found I made a small error
generating the xml files: I forgot to change the maillist variables
(there are two of them). Fortunately only one of the three jobs had
the bad data, so I made a note of it. I regenerated the xml and
copied it up. Zlatin is working on getting the IP addresses for the
domains to be moved (? they use the same dns server, why is this
necessary I wonder).

Meanwhile, the three jobs I submitted around 10am are still slowly
working their way through at 3:43 pm. They have about three more
steps to go.

ssh -L 2000:db2-1.prv:400 swain@bastion



#########################################################################
030207 Friday




#########################################################################
030210 Monday

Well, apparently I never made an entry for Friday... but it was
another long long day of staring at the spinning icon in the web
browser waiting for the staging server to reply; meetings; and
revisions to previous work.

Zlatin, it seems, did not get the mail workflow installed on live or
staging even though we both stayed late one night. A gaff I
suppose. We had to manually delete the fifteen sample customers on
staging so they could be added again as credit card customers... they
were created as invoice customers the first time and noone knows why
we have invoicing available as an option on staging.

Late Friday I recreated the fifteen as cc customers. I sent an email
to Ken saying it was OK to add them again, but the option was open
for us to do it. I think while I wait for him to get to work (he's in
California) I'll do a sixteenth customer.

Also, I need to make it drop dead simple to generate files for
staging or production... maybe I should add a command line switch...

Added command line params to ireg.pl. This will prevent me from
goofing the generation of files for staging or production.

Talked to Kenneth at SF about the xml files. He has one data field,
ScriptProfileName, in some of the files twice. He thought this should
be OK. He also didn't check to see if he got all the emails from the
15 package purchases. 



#########################################################################
030211 Tuesday

Very productive day yesterday. Did a lot of coding after noon, making
the scripts more robust and easier to use and less error prone, while
merging in changes Ken from SF made to the ImportInstalledPackage.xml
files... meanwhile:

From: Steve Wainstead <swain@ampira.com>
Date: Tue Feb 11, 2003  11:02:16 AM America/New_York
To: Steven Wolf <swolf@ampira.com>, Gautam Guliani <gautamg@ampira.com>
Cc: Zlatin Ivanov <zlatin@ampira.com>, Kenneth Maikish <kmaikish@systemsfusion.com>
Subject: status of the ireg move

This morning Zlatin and I planned out the move of one person from iReg
to Production. I generated the necessary scripts, and we were going to
use the admin interface to EVW to bypass domain creation, the point we
expected it to be hung up. Then we'd use Lysa's site copying script to
move the web site from iReg to Ampira.

All went well (except cws-4 needed to be kicked by Lysa because
ProductModule was ignoring us again) until the process of buying the
package for the org stopped in the credit card vetting process; it
appears that the customer will be charged $14.99. Zlatin and I spoke
to Garrison about this and we concluded it would be best to check with
Rob Walker before approving it. It was our belief that the iReg
customers would not be charged.

Unfortunately Rob will not be back in the office until 2pm. I have
some housekeeping work to do though... at this point 92 orgs were
created on Prod, which are a subset of the 150 or so that have no
account problems; there are a couple of orgs that must go to Support
for pathological problems like incomplete email addresses.

~swain

Shame on me. Not keeping up with the tasks spreadsheet. I suck. I
really want to keep it up to date. Gautam asked us to update it last
night... should have done it after lunch today. Lessee. Need a set
time to do it; perhaps the end of each day?
---

Made a booboo. Was splitting to get domain names separated, but
didn't put a 2 in so strutt.org.uk wound up strutt and org, and the
uk was lost.

So a bug uncovered. However we lost a job completely... the Happy job
cannot be found by either Lysa or Zlatin.

Well, Happy didn't go through due to being a Frontpage user. I just
put one through.



#########################################################################
030212 Wednesday

Kenneth is now heading support... I wonder if something happened to
Van Wie.

Had an argument with Gautam over Twiki. I think the organization is
counter to how Wikis work best; but it's a catch-22 situation where
teaching Wiki conventions to users is too hard (you can lead a horse
to water...) while the organization by hierarchy defeats the purpose
of a wiki. A wiki is not a content management system.

Went on a quest for the db2 rollback logs, but found nothing... which
lead to the argument about Twiki (GG said "did you look in Twiki?"
After the argument I did, and the info was not there, of course). Ran
into Chris Ferry in the bathroom and he told me the rollback logs are
in binary and contain little useful insight into how transactions
occur.

Kenneth finally put to rest the whole business about "Migration
Mode." When Petrus was here he said we could get around all of our
problems by putting the modules in this mythical mode. It doesn't
exist.

I am looking for a way to automate the last two steps we have to do
manually, which are to pass the user through cc vetting and then dns
vetting.

Ken replies that to get around the ADM stuff we might get a new
module on Monday with the mythical "migration mode." Monday. We're
off on Monday.

Results from moving domains with Lysa's tool:
--------------------------------------------
strutt.org.uk (not moved)
;; cakesbysharonandginger.com
;; paperandpaintstudio.com
;; jayomi.co.uk
bamboo-in.com (timed out)
thirdstudiofromthesun.com (non-existant domain)
paulco-computer-consulting.com (non-existant domain)
;; whitemagicgraffix.com
;; lionwalk.com



from the perldoc on the net::ssh::perl module:

       ($out, $err, $exit) = $ssh->cmd($cmd, [ $stdin ])

       Runs the command $cmd on the remote server and returns the
       stdout, stderr, and exit status of that command.


Spent time working on Lysa's script. I'm annoyed that I wrote a
little unix tools library at the NYT and don't have it now. I wonder
if I have a copy at home.

./configure --with-tcl=/System/Library/Tcl/8.3/



#########################################################################
030214 Friday

Spent time yesterday afternoon hacking away at a bug in a Python
script. Actually the problem was in a prior script that generates SQL
code, but doesn't honor case in the composite primary key. Ticket
#1078. Very proud of this accomplishment. There's something
emminently satisfying in that kind of bug fixing.

Went through all remaining package buys and extracted the domains;
ran those through nslookup and found a lot of domains non-existent.

On bypassing the UI, to set the domain to "complete" in Registrar,
and skipping the two tasks for primary and secondary DNS:

We  create the package with the py script. We don't get any info back
from this, so we need to get the job ID somehow.



#########################################################################
030218 Tuesday

Got an email from Gautam noting I didn't send updates Thursday and
Friday for the iReg move. It was just a nudge, but it tends to
trouble me when things like this occur; I need to be more
dilligent. Anyway Thursday I got caught up in the debugging of the
import/export scripts for mail templates and Friday we left abruptly
in the afternoon.

Sent a long email exlaining where things are. I revised the filtering
of the input data; we have 148 orgs with 150 packages to buy. We've
created 87 orgs and bought 13 packages.

heatherpartain.com was processed; can't find the job
anymore. Non-existent domain.

Revision: 19 of 148 domains we will transfer are expired.

The domain jessethecomic.com failed to be brought over to Ampira; it's
not clear why from the credit card log. It stopped at the gateway.

Oh! Today is my third month anniversary.

19 packages attempted.

Neptuneholdings passed through the system, nothing was bought. Even
searched on the job ID.

ImportOrganizations.py -a password organizations.xml

Psuedo code:
for each domain passed in:
   get the two ip addresses
   call the Lysa script

cbhall-116658-package.xml         cc on hold
cheetahchoices-116376-package.xml declined
cnoelldunc-117135-package.xml     declined 
corey291-135277-package.xml       done
ctrude-127181-package.xml         declined 

cvoelter-128791-package.xml       done
danl-113050-package.xml           done
denisew1972-140312-package.xml    done
dorothy-102808-package.xml        card num error
dorothy-109211-package.xml        
     
drbradcase-110395-package.xml     done    
drtag-139181-package.xml          declined
dwfrogs-117717-package.xml        done       
egocreatives-113359-package.xml   done
elements-124946-package.xml       done

esharp-119479-package.xml         done
essexpubs-141392-package.xml      done
eugeneo-119452-package.xml        done howth-design.com
facepaintfun-118597-package.xml   declined
falcon-127542-package.xml         done

ffaaddii-135768-package.xml       done registrationfix.com
fuller-128635-package.xml         done kandsfuller.com
garrydietz-118471-package.xml     declined
genesis-138115-package.xml        done genesismotorsinc.com
gex-118504-package.xml            done gextacyspyro.com

gkarrie-128640-package.xml        done audioquran.com
gkolesar-130181-package.xml       declined
gocpcb-5133-package.xml           done pcbprototype.com
haggs-103276-package.xml          done haggs.net
heidsfost-139663-package.xml      done captastic.com

hepatitis-128996-package.xml      done triadhepatitiscgroup.com
hillroy-120358-package.xml        done freakcentral.org
hispanodub-134379-package.xml     declined
iikdrii-129693-package.xml        done neotericnation.com
iloveyoutn-134126-package.xml     "no account"

Processed 35 accounts by hand today.



#########################################################################
030219 Wednesday

imani-117778-package.xml         done imanidamali.com
inspired-139281-package.xml      ???
jeepster72-140738-package.xml    card no. error
jeepster72-141581-package.xml    card no. error
jeffreybenice-142406-package.xml done jeffreybenice.com

jerzey4life-120199-package.xml   done teamlos.com
jjanicki-119624-package.xml      done toxicvibe.com
jmartin-112537-package.xml       done stevieraveon.com 
jordi-123186-package.xml         hold call
jvj-126586-package.xml           declined

kamau-112921-package.xml         done healthyliving4us.com chk
kbc1119-122240-package.xml       done cole-kids.com chk
latebrake-124164-package.xml     done latebrake.com chk
lateduster-134106-package.xml    declined
marrcarr-136474-package.xml      done dot-ave.com chk

massemonkey-133192-package.xml   done massemonkey.com chk
misko667-130483-package.xml      hold-call
nbossette-126926-package.xml     done myobmagazine.net chk
nyxhaus-113640-package.xml       done nyxhaus.com chk

We are up to 51 on the white board, and in a race with support, so to
speak, to finish up. We have migration mode on ADM now, so the only
holdup is Registrar. I hear Chris at his desk now, he said to come by
this afternoon.

Scripting the site moving script will have to be done via LWP. It
cannot be run from the command line except as user apache, I think;
as user 'mover' I get auth failures. It cannot easily be called via
lynx... hmm... time to test curl.

Go curl!

Next:
samlor-134235-package.xml         thetimelessimage.com
schoenherr-124301-package.xml     lindaschoenherr.com
silcon-135239-package.xml         silconusa.com        failed
spicola2-132895-package.xml       gracelandfarms.com
srsmanian-116537-package.xml      giantsmombasa.com
stretchingfm1-119887-package.xml  stretchingfm.com
swickph-125687-package.xml        swickph.com

thadev-121104-package.xml          happylittletrees.com failed
thearc-114418-package.xml          manasotaarc.org 
thehateholiday-121860-package.xml  thehateholiday.com
trevorbaker-134086-package.xml     carolinabca.com 
trgaul-138431-package.xml          cornerstorecomics.com
triberfan-124546-package.xml       ahealthybargain.com

uknowmystyle-133811-package.xml    uknowmystyle.com failed
uksoft-125386-package.xml          uksoft.org
vernon98-104014-package.xml        vernsgifts.com
waltererikson-133453-package.xml   wasteofenergyinc.com
wangandkirtley-120506-package.xml  wangandkirtley.com
willieche-112647-package.xml       afroanime.com            


First run:
[ketelone ireg2sf]$ ./moves.pl moves.input
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   848    0   848    0     0    128      0 --:--:--  0:00:06 --:--:--   150
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
joseantoniocolumna.com is provisioned on 216.27.95.33<br>
In progress of movening joseantoniocolumna.com from 192.168.6.101 to 192.168.6.33<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.101:/home/mover/joseantoniocolumna.com.tar /home/mover/02192003/joseantoniocolumna.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/joseantoniocolumna.com.tar mover@192.168.6.33:/home/mover/02192003/joseantoniocolumna.com.tar': 0<br>
mv /home/mover/02192003/joseantoniocolumna.com.tar /home/mover/02192003/joseantoniocolumna.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming joseantoniocolumna.com.tar to joseantoniocolumna.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   773    0   773    0     0    136      0 --:--:--  0:00:05 --:--:--   193
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
jwmf.com is provisioned on 216.27.95.35<br>
In progress of movening jwmf.com from 192.168.6.109 to 192.168.6.35<br>
Status of Getting config: Directory is at /home2/andrewjohn/<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.109:/home/mover/jwmf.com.tar /home/mover/02192003/jwmf.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.35<br>
return value from command 'scp /home/mover/02192003/jwmf.com.tar mover@192.168.6.35:/home/mover/02192003/jwmf.com.tar': 0<br>
mv /home/mover/02192003/jwmf.com.tar /home/mover/02192003/jwmf.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming jwmf.com.tar to jwmf.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   293    0   293    0     0      0      0 --:--:--  0:05:06 --:--:--     0
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
latebrake.com is provisioned on 216.27.95.33<br>
In progress of movening latebrake.com from 192.168.6.109 to 192.168.6.33<br>
Status of Getting config: Directory is at /home2/latebrake/<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   779    0   779    0     0     58      0 --:--:--  0:00:13 --:--:--    84
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
massemonkey.com is provisioned on 216.27.95.105<br>
In progress of movening massemonkey.com from 192.168.6.105 to 192.168.6.33<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.105:/home/mover/massemonkey.com.tar /home/mover/02192003/massemonkey.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/massemonkey.com.tar mover@192.168.6.33:/home/mover/02192003/massemonkey.com.tar': 0<br>
mv /home/mover/02192003/massemonkey.com.tar /home/mover/02192003/massemonkey.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming massemonkey.com.tar to massemonkey.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   779    0   779    0     0     32      0 --:--:--  0:00:24 --:--:--    84
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
mebanknotes.com is provisioned on 216.27.95.107<br>
In progress of movening mebanknotes.com from 192.168.6.107 to 192.168.6.35<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.107:/home/mover/mebanknotes.com.tar /home/mover/02192003/mebanknotes.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.35<br>
return value from command 'scp /home/mover/02192003/mebanknotes.com.tar mover@192.168.6.35:/home/mover/02192003/mebanknotes.com.tar': 0<br>
mv /home/mover/02192003/mebanknotes.com.tar /home/mover/02192003/mebanknotes.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming mebanknotes.com.tar to mebanknotes.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   852    0   852    0     0    168      0 --:--:--  0:00:05 --:--:--   138
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
myobmagazine.net is provisioned on 216.27.95.35<br>
In progress of movening myobmagazine.net from 192.168.6.109 to 192.168.6.35<br>
Status of Getting config: Directory is at /home2/nbossette/<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.109:/home/mover/myobmagazine.net.tar /home/mover/02192003/myobmagazine.net.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.35<br>
return value from command 'scp /home/mover/02192003/myobmagazine.net.tar mover@192.168.6.35:/home/mover/02192003/myobmagazine.net.tar': 0<br>
mv /home/mover/02192003/myobmagazine.net.tar /home/mover/02192003/myobmagazine.net.tar.complete<br>
Looks like it got there OK :) <br>
Renaming myobmagazine.net.tar to myobmagazine.net.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   799    0   799    0     0    147      0 --:--:--  0:00:05 --:--:--    94
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
nyxhaus.com is provisioned on 216.27.95.33<br>
In progress of movening nyxhaus.com from 192.168.6.109 to 192.168.6.33<br>
Status of Getting config: Directory is at /home/nyxhaus/<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.109:/home/mover/nyxhaus.com.tar /home/mover/02192003/nyxhaus.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/nyxhaus.com.tar mover@192.168.6.33:/home/mover/02192003/nyxhaus.com.tar': 0<br>
mv /home/mover/02192003/nyxhaus.com.tar /home/mover/02192003/nyxhaus.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming nyxhaus.com.tar to nyxhaus.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   314    0   314    0     0    143      0 --:--:--  0:00:02 --:--:--   157
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
othman-moufid.com is provisioned on 216.27.95.35<br>
In progress of movening othman-moufid.com from 192.168.6.105 to 192.168.6.35<br>
Ewps - /homes/sites/www.othman-moufid.com doesn't exist on 192.168.6.105<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   768    0   768    0     0    113      0 --:--:--  0:00:06 --:--:--   134
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
paperchefs.com is provisioned on 216.27.95.33<br>
In progress of movening paperchefs.com from 192.168.6.107 to 192.168.6.33<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.107:/home/mover/paperchefs.com.tar /home/mover/02192003/paperchefs.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/paperchefs.com.tar mover@192.168.6.33:/home/mover/02192003/paperchefs.com.tar': 0<br>
mv /home/mover/02192003/paperchefs.com.tar /home/mover/02192003/paperchefs.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming paperchefs.com.tar to paperchefs.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   928    0   928    0     0    155      0 --:--:--  0:00:05 --:--:--   166
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
paulco-computer-consulting.com is provisioned on 216.27.95.35<br>
In progress of movening paulco-computer-consulting.com from 192.168.6.107 to 192.168.6.35<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.107:/home/mover/paulco-computer-consulting.com.tar /home/mover/02192003/paulco-computer-consulting.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.35<br>
return value from command 'scp /home/mover/02192003/paulco-computer-consulting.com.tar mover@192.168.6.35:/home/mover/02192003/paulco-computer-consulting.com.tar': 0<br>
mv /home/mover/02192003/paulco-computer-consulting.com.tar /home/mover/02192003/paulco-computer-consulting.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming paulco-computer-consulting.com.tar to paulco-computer-consulting.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   840    0   840    0     0      5      0 --:--:--  0:02:21 --:--:--   100
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
peggygarcia.com is provisioned on 216.27.95.109<br>
In progress of movening peggygarcia.com from 192.168.6.109 to 192.168.6.33<br>
Status of Getting config: Directory is at /home/pgarcia/<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.109:/home/mover/peggygarcia.com.tar /home/mover/02192003/peggygarcia.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/peggygarcia.com.tar mover@192.168.6.33:/home/mover/02192003/peggygarcia.com.tar': 0<br>
mv /home/mover/02192003/peggygarcia.com.tar /home/mover/02192003/peggygarcia.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming peggygarcia.com.tar to peggygarcia.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100  1000    0  1000    0     0    183      0 --:--:--  0:00:05 --:--:--    94
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
rydalch.org is provisioned on 216.27.95.33<br>
In progress of movening rydalch.org from 192.168.6.109 to 192.168.6.33<br>
Status of Getting config: Directory is at /home2/richr/<br>
the tar command 'tar cvf /home/mover/rydalch.org.tar  -C /home2/richr/ .' returned nonzero...<br>
stderr says: tar: .: Cannot savedir: Permission denied
tar: Error exit delayed from previous errors
<p>
return value from command 'scp -oProtocol=1 mover@192.168.6.109:/home/mover/rydalch.org.tar /home/mover/02192003/rydalch.org.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/rydalch.org.tar mover@192.168.6.33:/home/mover/02192003/rydalch.org.tar': 0<br>
mv /home/mover/02192003/rydalch.org.tar /home/mover/02192003/rydalch.org.tar.complete<br>
Looks like it got there OK :) <br>
Renaming rydalch.org.tar to rydalch.org.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   789    0   789    0     0    136      0 --:--:--  0:00:05 --:--:--   138
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
stevieraveon.com is provisioned on 216.27.95.105<br>
In progress of movening stevieraveon.com from 192.168.6.105 to 192.168.6.33<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.105:/home/mover/stevieraveon.com.tar /home/mover/02192003/stevieraveon.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/stevieraveon.com.tar mover@192.168.6.33:/home/mover/02192003/stevieraveon.com.tar': 0<br>
mv /home/mover/02192003/stevieraveon.com.tar /home/mover/02192003/stevieraveon.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming stevieraveon.com.tar to stevieraveon.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   798    0   798    0     0    134      0 --:--:--  0:00:05 --:--:--   140
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
supportnetinc.com is provisioned on 216.27.95.33<br>
In progress of movening supportnetinc.com from 192.168.6.107 to 192.168.6.33<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.107:/home/mover/supportnetinc.com.tar /home/mover/02192003/supportnetinc.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/supportnetinc.com.tar mover@192.168.6.33:/home/mover/02192003/supportnetinc.com.tar': 0<br>
mv /home/mover/02192003/supportnetinc.com.tar /home/mover/02192003/supportnetinc.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming supportnetinc.com.tar to supportnetinc.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   292    0   292    0     0      0      0 --:--:--  0:05:09 --:--:--     0
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
teamlos.com is provisioned on 216.27.95.109<br>
In progress of movening teamlos.com from 192.168.6.109 to 192.168.6.35<br>
Status of Getting config: Directory is at /home2/jerzey4life/<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   879    0   879    0     0     54      0 --:--:--  0:00:16 --:--:--    99
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
thirdstudiofromthesun.com is provisioned on 216.27.95.107<br>
In progress of movening thirdstudiofromthesun.com from 192.168.6.107 to 192.168.6.35<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.107:/home/mover/thirdstudiofromthesun.com.tar /home/mover/02192003/thirdstudiofromthesun.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.35<br>
return value from command 'scp /home/mover/02192003/thirdstudiofromthesun.com.tar mover@192.168.6.35:/home/mover/02192003/thirdstudiofromthesun.com.tar': 0<br>
mv /home/mover/02192003/thirdstudiofromthesun.com.tar /home/mover/02192003/thirdstudiofromthesun.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming thirdstudiofromthesun.com.tar to thirdstudiofromthesun.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   899    0   899    0     0    180      0 --:--:--  0:00:04 --:--:--   160
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
touchofcolorphotography.com is provisioned on 216.27.95.107<br>
In progress of movening touchofcolorphotography.com from 192.168.6.107 to 192.168.6.35<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.107:/home/mover/touchofcolorphotography.com.tar /home/mover/02192003/touchofcolorphotography.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.35<br>
return value from command 'scp /home/mover/02192003/touchofcolorphotography.com.tar mover@192.168.6.35:/home/mover/02192003/touchofcolorphotography.com.tar': 0<br>
mv /home/mover/02192003/touchofcolorphotography.com.tar /home/mover/02192003/touchofcolorphotography.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming touchofcolorphotography.com.tar to touchofcolorphotography.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   822    0   822    0     0     79      0 --:--:--  0:00:10 --:--:--   132
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
toxicvibe.com is provisioned on 216.27.95.109<br>
In progress of movening toxicvibe.com from 192.168.6.109 to 192.168.6.35<br>
Status of Getting config: Directory is at /home2/jjanicki/<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.109:/home/mover/toxicvibe.com.tar /home/mover/02192003/toxicvibe.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.35<br>
return value from command 'scp /home/mover/02192003/toxicvibe.com.tar mover@192.168.6.35:/home/mover/02192003/toxicvibe.com.tar': 0<br>
mv /home/mover/02192003/toxicvibe.com.tar /home/mover/02192003/toxicvibe.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming toxicvibe.com.tar to toxicvibe.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   841    0   841    0     0     47      0 --:--:--  0:00:17 --:--:--   136
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
vectors2001.com is provisioned on 216.27.95.109<br>
In progress of movening vectors2001.com from 192.168.6.109 to 192.168.6.33<br>
Status of Getting config: Directory is at /home2/tajvida/<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.109:/home/mover/vectors2001.com.tar /home/mover/02192003/vectors2001.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/vectors2001.com.tar mover@192.168.6.33:/home/mover/02192003/vectors2001.com.tar': 0<br>
mv /home/mover/02192003/vectors2001.com.tar /home/mover/02192003/vectors2001.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming vectors2001.com.tar to vectors2001.com.tar.complete<br>



Second run:

  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   778    0   778    0     0    136      0 --:--:--  0:00:05 --:--:--   136
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
carolinabca.com is provisioned on 216.27.95.33<br>
In progress of movening carolinabca.com from 192.168.6.103 to 192.168.6.33<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.103:/home/mover/carolinabca.com.tar /home/mover/02192003/carolinabca.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/carolinabca.com.tar mover@192.168.6.33:/home/mover/02192003/carolinabca.com.tar': 0<br>
mv /home/mover/02192003/carolinabca.com.tar /home/mover/02192003/carolinabca.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming carolinabca.com.tar to carolinabca.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   838    0   838    0     0     36      0 --:--:--  0:00:22 --:--:--    93
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
cornerstorecomics.com is provisioned on 216.27.95.35<br>
In progress of movening cornerstorecomics.com from 192.168.6.101 to 192.168.6.35<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.101:/home/mover/cornerstorecomics.com.tar /home/mover/02192003/cornerstorecomics.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.35<br>
return value from command 'scp /home/mover/02192003/cornerstorecomics.com.tar mover@192.168.6.35:/home/mover/02192003/cornerstorecomics.com.tar': 0<br>
mv /home/mover/02192003/cornerstorecomics.com.tar /home/mover/02192003/cornerstorecomics.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming cornerstorecomics.com.tar to cornerstorecomics.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   863    0   863    0     0     19      0 --:--:--  0:00:44 --:--:--   103
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
giantsmombasa.com is provisioned on 216.27.95.109<br>
In progress of movening giantsmombasa.com from 192.168.6.109 to 192.168.6.33<br>
Status of Getting config: Directory is at /home2/srsmanian/<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.109:/home/mover/giantsmombasa.com.tar /home/mover/02192003/giantsmombasa.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/giantsmombasa.com.tar mover@192.168.6.33:/home/mover/02192003/giantsmombasa.com.tar': 0<br>
mv /home/mover/02192003/giantsmombasa.com.tar /home/mover/02192003/giantsmombasa.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming giantsmombasa.com.tar to giantsmombasa.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   808    0   808    0     0    138      0 --:--:--  0:00:05 --:--:--   142
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
gracelandfarms.com is provisioned on 216.27.95.33<br>
In progress of movening gracelandfarms.com from 192.168.6.103 to 192.168.6.33<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.103:/home/mover/gracelandfarms.com.tar /home/mover/02192003/gracelandfarms.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/gracelandfarms.com.tar mover@192.168.6.33:/home/mover/02192003/gracelandfarms.com.tar': 0<br>
mv /home/mover/02192003/gracelandfarms.com.tar /home/mover/02192003/gracelandfarms.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming gracelandfarms.com.tar to gracelandfarms.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   884    0   884    0     0     33      0 --:--:--  0:00:26 --:--:--   144
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
lindaschoenherr.com is provisioned on 216.27.95.109<br>
In progress of movening lindaschoenherr.com from 192.168.6.109 to 192.168.6.33<br>
Status of Getting config: Directory is at /home2/schoenherr/<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.109:/home/mover/lindaschoenherr.com.tar /home/mover/02192003/lindaschoenherr.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/lindaschoenherr.com.tar mover@192.168.6.33:/home/mover/02192003/lindaschoenherr.com.tar': 0<br>
mv /home/mover/02192003/lindaschoenherr.com.tar /home/mover/02192003/lindaschoenherr.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming lindaschoenherr.com.tar to lindaschoenherr.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   839    0   839    0     0     13      0 --:--:--  0:01:03 --:--:--   100
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
manasotaarc.org is provisioned on 216.27.95.33<br>
In progress of movening manasotaarc.org from 192.168.6.109 to 192.168.6.33<br>
Status of Getting config: Directory is at /home2/thearc/<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.109:/home/mover/manasotaarc.org.tar /home/mover/02192003/manasotaarc.org.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/manasotaarc.org.tar mover@192.168.6.33:/home/mover/02192003/manasotaarc.org.tar': 0<br>
mv /home/mover/02192003/manasotaarc.org.tar /home/mover/02192003/manasotaarc.org.tar.complete<br>
Looks like it got there OK :) <br>
Renaming manasotaarc.org.tar to manasotaarc.org.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   857    0   857    0     0      4      0 --:--:--  0:03:07 --:--:--    86
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
stretchingfm.com is provisioned on 216.27.95.109<br>
In progress of movening stretchingfm.com from 192.168.6.109 to 192.168.6.33<br>
Status of Getting config: Directory is at /home2/stretchingfm1/<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.109:/home/mover/stretchingfm.com.tar /home/mover/02192003/stretchingfm.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/stretchingfm.com.tar mover@192.168.6.33:/home/mover/02192003/stretchingfm.com.tar': 0<br>
mv /home/mover/02192003/stretchingfm.com.tar /home/mover/02192003/stretchingfm.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming stretchingfm.com.tar to stretchingfm.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   738    0   738    0     0     51      0 --:--:--  0:00:14 --:--:--    78
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
swickph.com is provisioned on 216.27.95.33<br>
In progress of movening swickph.com from 192.168.6.105 to 192.168.6.33<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.105:/home/mover/swickph.com.tar /home/mover/02192003/swickph.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/swickph.com.tar mover@192.168.6.33:/home/mover/02192003/swickph.com.tar': 0<br>
mv /home/mover/02192003/swickph.com.tar /home/mover/02192003/swickph.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming swickph.com.tar to swickph.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   877    0   877    0     0      3      0 --:--:--  0:03:58 --:--:--    89
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
thehateholiday.com is provisioned on 216.27.95.33<br>
In progress of movening thehateholiday.com from 192.168.6.109 to 192.168.6.33<br>
Status of Getting config: Directory is at /home2/thehateholiday/<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.109:/home/mover/thehateholiday.com.tar /home/mover/02192003/thehateholiday.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.33<br>
return value from command 'scp /home/mover/02192003/thehateholiday.com.tar mover@192.168.6.33:/home/mover/02192003/thehateholiday.com.tar': 0<br>
mv /home/mover/02192003/thehateholiday.com.tar /home/mover/02192003/thehateholiday.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming thehateholiday.com.tar to thehateholiday.com.tar.complete<br>
  % Total    % Received % Xferd  Average Speed          Time             Curr.
                                 Dload  Upload Total    Current  Left    Speed
100   829    0   829    0     0    133      0 --:--:--  0:00:06 --:--:--   146
<html>
 <head><title>Admin Move Tool</title></head>
 <body bgcolor="black" text="white" font="Arial"> 
thetimelessimage.com is provisioned on 216.27.95.107<br>
In progress of movening thetimelessimage.com from 192.168.6.107 to 192.168.6.35<br>
return value from command 'scp -oProtocol=1 mover@192.168.6.107:/home/mover/thetimelessimage.com.tar /home/mover/02192003/thetimelessimage.com.tar': 0<br>



 , , 0


<p><P>moving tar from Support to 192.168.6.35<br>
return value from command 'scp /home/mover/02192003/thetimelessimage.com.tar mover@192.168.6.35:/home/mover/02192003/thetimelessimage.com.tar': 0<br>
mv /home/mover/02192003/thetimelessimage.com.tar /home/mover/02192003/thetimelessimage.com.tar.complete<br>
Looks like it got there OK :) <br>
Renaming thetimelessimage.com.tar to thetimelessimage.com.tar.complete<br>
[ketelone ireg2sf]$ 



---
Duplicates:
Christy.xml is not a dupe
adsvinow.xml is all done (? check again)

dalamode.xml exists but package must be bought dalamode-131930-package.xml
danoakes.xml needs the package bought danoakes-114002-package.xml
panarello.xml needs package bought panarello-113988-package.xml
djimusic.xml: needs package bought djimusic-113814-package.xml

davespangler.xml: is a vanilla user.
dilarajones.xml: another vanilla user.

emy exists, CC info matches; needs package bought emy-127587-package.xml

ivan.xml is not a dupe
michaele.xml: not a dupe




joseantoniocolumna.com
jwmf.com
latebrake.com failed
massemonkey.com

The bad:
latebrake.com is provisioned on 216.27.95.33
othman-moufid.com is provisioned on 216.27.95.35
teamlos.com is provisioned on 216.27.95.109

~swain:
org done: 37
org bad:  22

pkg done: 29
pkg bad:   9

~zlatin:
org done: 88
org bad:  20

pkg done: 67
pkg bad:  26

orgs done: 125
orgs bad:   42

pkg total:  131
pkg bought: 96
pkg fails:  35


email to the bosses:
After I process the spreadsheet my script tells me:
read in 297 lines.
skipped 148 lines.
26 of those were found domains.
processed 149 lines.

122 of the skipped go to Gautam. I'm not sure where the number "118"
came from, unless there were duplicate emails. The attachment I sent
had 122 lines.

26 were already in Ampira; this makes 148 of the 297 lines.

149 lines were processed, giving:

org.xml files: 145
pkg.xml files: 149

149 processed plus 148 skipped gives us 297. Note the total number of
orgs Zlatin and I were to attempt is 145.

The number we attempted came to 167, for some reason. I'll look into
it, but it's probably because we tried initially to create orgs with
bad CC numbers and those were rejected.

The number of orgs created was 125. There are 42 rejects.
The number of packages bought for the 125 was 96, with 35 rejects.
(+ 96 35) = 131. I'm not sure yet why more packages were bought than
orgs created, but that's also on the todo list.

We are still doing a number of things: moving domains from iReg to
Ampira and updating zone files. I'll have the number of sites moved
to date shortly.

Needs: We need to automate the processing of org files. It will go
like this: given a list of org files, att



#########################################################################
030221 Friday

Breakdown of tasks:

20 failed org creations. These failed because:
duplicate username (9): match to see if they are same person
duplicate organization (6): see if the package can be bought
duplicate email (4): see if it's the same person, then buy package
one bad CC slipped through (1): should get blastmail

49 failed package buys. Must cull email addresses for these.

Potentially, 41 sites remain to be moved. I need to double check this
number. Sites that have no iReg IP need to be found by hand by
searching all the iReg servers.

Sent email to Ken about the DTD problem (xml files the system accepts
to not validate with the DTD).

This came up in the weekly ticket meeting with SF.

These two seem to have been bought packages but not org
created... which is of course impossible.

> Joanneanderson
> Manager

Sent mail to Gautam with the list of people who have orgs but no
packages.

Created org for Fishbine and bought the package. Must move the domain
now.

Tried to buy packages for some of the orgs that already existed, but
got errors. For example, Dow Jones and the Industrials (mispelled
Industerials on iReg):

bash-2.04# ./ImportInstalledPackages.py -a "deleted" -p 1 pending/djimusic-113814-package.xml 
Error getting account ID for package 69010 under o=Dow Jones and The Industrials,ou=Clients,o=FCTY: evw.Core.BillingDbError

Import completed:

    1 packages
    0 succeeded
    0 skipped due to wrong pass
    0 failed validation
    1 failed on import

This is after I corrected the org name. It needs more magic.

Changing vanilla users: cannot. Email address clashes.
bash-2.04# ./ImportOrganizations.py -a "removed" pending/jonesdilara.xml 
Duplicate email address dilarajones@hotmail.com for organization Global Venus




#########################################################################
030224 Monday

10am meeting. We didn't bring any money in over the weekend, we have
to find out why.

I am going through the entrails of the run Friday night moving the
large sites; one timed out after 30 minutes. Must be a big fscking
site!

Also seeing:
calspascalifornia.net is provisioned on 216.27.95.109<br>
In progress of movening calspascalifornia.net from 192.168.6.109 to 192.168.6.35<br>
Status of Getting config: Directory is at ///<br>

This is a parsing failure, perhaps, in moves.cgi. Nope: there was no
listing in the vhost file. Hmm.

Met over lunch with Zlatin and Gautam, and we covered the current
migration process. Gautam had some solutions for us. We are meeting
later to talk about the next round of customers. 

Had a 3 p.m. meeting with Rob Walker, swolf, gg, zi. Rob decided the
thing to do is mass email the iReg customers, and this would replace
the org creation process Zlatin and I have done by hand. We then need
to cull the orgs created and buy the correct packages. Chris Ferry
knows how emails sent from workflows trigger a script, and this could
keep a log for us to process.

Completed tests for Jessica. It was for the VisiHost visp.

I still have the registrar problem to look at.

Got the debugDump thing. Pretty easy once I read the instructions
carefully:

"FYI, the way to get the debug dump is to use this URL in a separate browser while you are buying a package:

"Hostname/wizard/buy/buy?debugDump=yes

"You can refresh that page on each step and see the info collected."

So it should be easy to create the xml files for the new packages for
the next round. The output is easy to read.




#########################################################################
030225 Tuesday

Back at it with the Python script, trying to get to the
Registrar. Small steps: first, I reformatted the indentation (a royal
pain in the butt with Python), and added a counter to stop the loop
listing jobs in the queue.

Got the script to change the status of a domain on staging, from
'awaiting vetting' to 'complete'. Took some old fashioned hacking and
guesswork. Right now it's not very forgiving, but it works. A list of
domains can be fed in and it will iterate over them.

Updated spreadsheet TODO list. Zlatin and I started going over the
iReg pages and were trying to find things in the database... Had 4pm
dev meeting, went well. Updated the Perl script to find duplicate keys
in the dump of the mailTemplate table, sent note to ops list.

Tried to merge differences in Excel spreadsheets, but it's beyond the
fu of me, Jeff or Gautam. I need to be able to share a spreadsheet
easily with Christina from Support.



#########################################################################
030226 Wednesday

Took the train in for the first time. It's roughly 45 minutes from
door to door (versus about 15 minutes from my old apartment). I am a
straphanger now.

Spent time with Zlatin looking at the iReg database. High weirdness:
We couldn't view the DMN table because we logged in as
administrator. The user had privileges though. We found that the iReg
login/password were the same as the opensrs login/password.

Just got a new todo list from Gautam. 

1. Wind down and document the automated procedure for iReg customer
   imports. The next set is going to be foisted on the user entirely;
   it looks like we won't even have to do site copying, though I find
   that incredible. We have a 5pm meeting on this.

2. Lysa has a script for a monthly marketing report. It generates a
   CSV file. I need to look it over with her and take it over. Find
   out her issues with it, give Gautam an estimate of the amount of
   work.

3. Shortcutting the CGI tree: there's a list of reports, one per
   visp, that are too cumbersome to get to via the admin
   interface. The goal here is to provide some kind of static link to
   the end user so when they click on it, they go directly to the
   report. First one to look at is the Product Summary Report. Day,
   week, month long reports.





#########################################################################
030227 Thursday

Spent the night in the old apt.

Got the Python script from Lysa. She says there are no issues with it
currently; she had to do some changes to handle special chars last
month. Oh, sometimes if the file is too large it won't send the
email. (When I think "report generation" I think Perl, personally).

Hmm. Idea. Python to write out data, Perl to format it nicely. Perl
== hammer, everything == nails.

Nope, not necessary. The Python script does pretty much
everything. Spent some time trying to find out why there is no $! or
printStackTrace() in Python 1.5. Very annoying when you get a generic
meaningless error message.

Moving on to other things. I still need to put iReg conversion on ice.

Cleaned out mailbox: created folder "iReg move" and put all email
pertaining to the move into it.

Sent mail to Zlatin, cc Gautam, on usage of iReg conversion scripts.

Task: make output of packageActivityReport.py capable of being
imported into Excel.


Well, comma separated values is right out. There are ldap strings in
the output and that screws it all up. Hrmm.

Hmm. The email attachment opens in Excel just fine. HTML does not
seem to, though.



#########################################################################
030228 Friday

In early, gonna do Christina's updates.

Note you can open a file via Lisp this way:
(find-file "/Volumes/192.168.2.4/AMPIRA SUPPORT/iReg2Ampira/ireg2ampira_expired.xls")
and C-x C-e on the last paren. Of course this is useless in the sense
that it's an Excel file and Emacs cannot read it.

Tried to put through two people: gkolesar and whimsey. gkolsare
failed on a bad credit card number (the org was created
though). whimsey has a bad expiry number (104). Emailed Christina and
cc'd GG.

-- reset to originals
update mailtemplate set toaddress='systems@ampira.com' where templatetype='1.3.6.1.4.1.3999.1.11.50.1.1' and dn='o=dmfc'
update mailtemplate set toaddress='systems@ampira.com, rob@ampira.com' where templatetype='1.3.6.1.4.1.3999.1.11.50.1.1' a\
nd dn='o=globalscape,ou=clients,o=dmfc'
update mailtemplate set toaddress='systems@ampira.com, rob@ampira.com' where templatetype='1.3.6.1.4.1.3999.1.11.50.1.1' a\
nd dn='o=hostv3,ou=clients,o=dmfc'
update mailtemplate set toaddress='systems@ampira.com' where templatetype='1.3.6.1.4.1.3999.1.11.50.1.1' and dn='o=visihos\
t,ou=clients,o=dmfc'

-- set for testing
update mailtemplate set toaddress='swain@ampira.com' where templatetype='1.3.6.1.4.1.3999.1.11.50.1.1'

This is for staging. The reason everyone was getting emails was
because I didn't specify the isp, so it was generated for all of them.

Wrote two shell scripts to set/reset email addresses for the mail
templates used by the product module report.

---

Shortcutting the cgitree: first, they have to be logged in.

Sample URL:
https://evw-1.ampira.com/billing/GenericCreditCard/ccTransLogReport.vps?fromDay=28&fromMonth=2&fromYear=2003&endDay=28&endMonth=2&endYear=2003&sessionkey=FCTY_ZXRyVHQNRFWGKBP&currentTreeNodeId=29&parentTreeNodeId=24&formAction=PrepLogByDate&x=8&y=10

The trick here, in part, is the session key.

<start Conversation with Ken>

4:17PM
k:hi
s:i have a question about cgitree
k:shoot
s:i've been asked to find a way to create shortcuts
because navigating down the tree to find reports takes a long time
k:thats not goign to be simple
s:i thought fora start of a way of doing ccTransactionLog.vps
s:(yeah, my initial assessment too)
s:it looks like ccTransactionLog gets certain things passed from cgitree? i gues that's my question.
k:ya, every page
s:cgitree probably holds a lot of state
k:does
4:20PM
k:you have to look for session.get()
k:in the vps page
k:that is the stuff that comes from the tree
s:ok. i thought i could get away with just a valid sessionkey but that does not appear to be the case.
k:not quite
s:if i have any more questions i'll bug you again
k:k, you'll need the db name and pass for most reports
as well
s:yeah
s:i see how that comes from a conf file, which is part of the session stuff.
s:or i should say, becomes part of the session.
k:right
k:good luck
s:i'll need it

s:perl may be the devil's language...
s:but mixing python and html is just a bad idea.
k:ha, i have to agree
k:that thing was written about 5 years ago
k:maybe a little more
s:15 is going all jsp, right?
k:thats right
k:i wrote most of it
k:much easier to work with
s:that's an argument for another time. 

s:but i'll just say: java development is slower than php/python/perl/other scripting language...
s:but we are having birthday cake so i gotta run.
k:cheers

</end conversation>
(Here's a reason to switch to tik. I had to add the s: and k: to all that.)


So: CgiTree uses the session key plus some numeric notation to track
its state. The shape of the tree is probably something server-side,
meaning it might not be possible for a user to store a default
configuration. (Confirmed by Ken, and Petrus said "no way!" to users
storing tree state).

Procedure: Open tree to desired configuration. Save HTML.

Log out, in. Copy new sessionkey.

Global search/replace on saved HTML, putting in new sessionkey.

Click on node. Result: negative. The page is replaced by the current
state. In this case, the whole tree vanished and was replaced by the
unexpanded tree.

Wrote estimate for Gautam:

Two tasks in front of me: one, improve the reports from
packageActivityReport.py, and two, find a shortcut to certain reports
under CgiTree.

I've already made some headway with packageActivityReport.py. I
converted tabs to spaces and changed the extension of the attachment
from .txt to .csv, and on my Mac it opens nicely in Excel. I have to
test it on the PC still.

Next will be filling in the blanks... the obstacle here is the code is
pretty dense with a complex Python data structure. It will have to be
deciphered, and the variables passed on from iteration to
iteration. Might take two days, depending on my budding Python-fu and
length of concentration.

For the next task, I spent some time today researching the code and
had a couple of chat sessions with Kenneth.  Part of the problem is
the session data is set by CgiTree, and the pages in the right frame
thereafter get a handle on the session object. From the session object
the page (really, the vps file) gets things like the database
login/password, etc.

The trick is to get the sessionkey out of this closed system of
CgiTree in the left frame and the vps pages on the right. One approach
would be to put some code in the first right frame, called splash.vps,
and if the user is on an ACL, display links to common reports.

If that's feasible, then we can just hand-code links into the output
to the forms, or even calculate the input values for certain forms to
get the report automatically.

Unknowns: how to make an ACL for this, or if we can test on domain or
address so only people inside FC can see these links.

An example of a really low-rent solution to this would be to write a
little CGI. User logs in, copies their session key from the source,
call the CGI, give it the session key, and that would generate a page
of links. This is not the answer of course, I'm just outlining another
solution to give you an idea of how it works. It all pretty much
hinges on the session key, which is interpolated into the pages all
throughout the EVW interface.

A third approach is to add a new top level node to CgiTree, which
calls one vps file, which we can then put any links into that we want.

Once an approach is chosen I can give you a better estimate on the
amount of time needed. I think "less than a week" is about the best I
can say right now. Sorry.

Consider the iReg-to-Ampira project on ice, save for the occasional
task for the support team.

See you on Monday.
~swain



#########################################################################
030303 Monday

Spent whole weekend without a net connection.

Found that uncommenting one line filled in all of the sparse matrix
generated by packageActivityReport.py. Had to spend time finding why
this broke the HTML output. Mail.app doesn't like the html at all
anymore, but the CSV opens in Excel on Mac and PC, and Gnumeric on
Lysa's box.

Fudge. I overwrote some changes she made. I could just die; earlier I
was thinking what a mistake it wasn't in CVS and now I've got to redo
her work. It's not difficult, just tedious: adding columns and print
statements.




#########################################################################
030304 Tuesday

Had to hunt down three domains today for iReg; Support reported
strangeness with them, but two we never bought packages for, and one
was not in the original list.

Fixed up the packageActivityReport.py script to divide the addresses
into columns. Prints the HTML OK but I'm not getting the emails.

I reviewed the setup on the dvl machines, and there is a 12:30
p.m. conference call about them.

The A/C keeps coming on and it's cold in here. Skipped breakfast,
going to be really hungry when conference call ends.

Meeting just got pushed to 2:30.

Went OK. Signoff on COB Monday. 4pm coming up. Generating reports;
gotta send them by hand. I took time to put in a hack to write out
three files: summary, csv, and html. Feb being generated now.

Sent the full report files (they had to be for all visps, not just
for FCTY).

Duplicate email address gottalaff@aol.com for organization Scoggins Julie



#########################################################################
030305 Wednesday

Thought about expanding the CgiTree via Javascript and target= calls,
but this would be too slow. I think a better way is to scan the right
page for the session key, then call a script that renders the form
somehow.


http://evw-1.dev.ampira.com/billing/global/productSummaryReport.vps?fromDay=2&fromMonth=3&fromYear=2003&endDay=5&endMonth=3&endYear=2003&x=33&y=12&sessionkey=DMFC_eJSQmWyiKLUTQEW&currentTreeNodeId=24&parentTreeNodeId=18&action=GetTransactions

http://evw-1.dev.ampira.com/billing/global/productSummaryReport.vps?fromDay=2&fromMonth=3&fromYear=2003&endDay=5&endMonth=3&endYear=2003&x=33&y=12&sessionkey=DMFC_ZCLwNbDNyBPJQej&currentTreeNodeId=24&parentTreeNodeId=18&action=GetTransactions

http://evw-1.dev.ampira.com/billing/global/productSummaryReport.vps?fromDay=2&fromMonth=3&fromYear=2003&endDay=5&endMonth=3&endYear=2003&sessionkey=DMFC_ZCLwNbDNyBPJQej&currentTreeNodeId=24&parentTreeNodeId=18&action=GetTransactions


Http://evw-1.dev.ampira.com/billing/global/productSummaryReport.vps?sessionkey=DMFC_ePvTMdPETRUURsX&currentTreeNodeId=24&parentTreeNodeId=18&action=GetTransactions

http://evw-1.dev.ampira.com/billing/global/productSummaryReport.vps?fromDay=2&fromMonth=3&fromYear=2003&endDay=5&endMonth=3&endYear=2003&sessionkey=DMFC_NKTrneNpPFtfTIN&currentTreeNodeId=0&parentTreeNodeId=0&action=GetTransactions

http://evw-1.dev.ampira.com/billing/global/productSummaryReport.vps?fromDay=2&fromMonth=3&fromYear=2003&endDay=5&endMonth=3&endYear=2003&sessionkey=DMFC_NKTrneNpPFtfTIN&currentTreeNodeId=0&parentTreeNodeId=0&action=GetTransactions

Log in. Click link for product summary report, which opens in a new
window. Fails: system error.

In parent window, navigate down to product summary report. Switch to
the window opened in the previous step which shows a system
error. Reload. Now it works.

CgiTree has loaded config info that is now in the user session
object, which the vps page gets via the sessionkey.

Ken writes:

"The reason that the tree has to be expanded to the proper node to
display the page is because the tree source populates the session with
info that is necessary in that page.

"There is no parameter to pass to make the tree expand automatically.
The reason is that expanding the tree automatically can be very
intensive on LDAP.  (this would also be very difficult to script, though
I suppose it would be possible).

"My feeling on this is that if you want to give them access to these
reports without the tree, you can just populate the page with the
necessary variables and run the page without a tree (you sill still need
a valid sessionkey though)."

I showed Gautam how you cannot just drop the session key into the URL
and get the form. State info is placed in the session object by
CgiTree, so it has to be opened, or the state data must be provided
another way.

I found that by hardcoding only one variable into the script,
accountDn, I got it to work regardless of CgiTree.

try:
   #AccountDn is actually the merchant accountDn
   accountDn = session.get("accountDn")
   merchantAccountId = accountManager.getMerchantAccountIdFromDn(sessionkey, accountDn)
except:
   accountDn="evwMerchantAccountId=0000000002,evwMerchantId=0000000001,o=DMFC"
   #EvwRedirect("/errors/systemUnavailable.vps",
    #           "Could not get the account dn.")

Wrote email to Gautam outlining two approaches to the CgiTree
shortcut.



#########################################################################
030306 Thursday

Gautam liked the second approach, modifying each vps file. No
surprise. I wouldn't have conceded to the javascript version anyway,
unless ordered to; too unreliable.

Issues:
package sync: will it hose the changes?
security: will this expose us?
warranty voided with sf?
will the data be reliable?

Sent email requesting permission to install Emacs on
evw-1.prv. Addressed it to Sunil.

https://evw-1.ampira.com/billing/global/productSummaryReport.vps?sessionkey=FCTY_HbIEPVAqmmpztCX&currentTreeNodeId=23&parentTreeNodeId=17


https://evw-1.ampira.com/billing/global/productSummaryReport.vps?fromDay=1&fromMonth=3&fromYear=2003&endDay=6&endMonth=3&endYear=2003&x=22&y=8&sessionkey=FCTY_bVsRgSLIOtkRNAU&currentTreeNodeId=23&parentTreeNodeId=17&action=GetTransactions

https://evw-1.ampira.com/billing/global/productSummaryReport.vps?fromDay=1&fromMonth=3&fromYear=2003&endDay=6&endMonth=3&endYear=2003&x=13&y=8&sessionkey=FCTY_FzdwCJgPTACBVXX&currentTreeNodeId=23&parentTreeNodeId=17&action=GetTransactions

So. The scripts need both the database info and the accountDn. This
means hardcoding the database params in, including the password. Not
optimal.

databaseName     = "evwv"
databaseUsername = "evwbill"
databasePassword = "eV0lbI11"
databaseType     = "db2"

except:
   accountDn = "evwMerchantAccountId=0000000001,evwMerchantId=0000000001,o=FCTY"
   merchantAccountId = accountManager.getMerchantAccountIdFromDn(sessionkey, accountDn)
   #EvwRedirect("/errors/systemUnavailable.vps",
   #            "Could not get the account dn.")

# steve wainstead tries to figure out if you are the admin user
print "<hr>"
# copied from user.vps
try:
   userDn = session.get("pageDn")
   loginDn = session.get("loginDn")
   evwIspDn = session.get("evwIspDn")
except:
   print "Unable to retrieve session variables for session"

#print "userDn %s loginDn %s" % userDn, loginDn
print evwIspDn
print userDn
print loginDn

try:
   tmpString = string.split(userDn, 'people,')
   #tmpString = string.split(tmpString[1], ',')
   organisationDn = tmpString[1]
except:
   print "organization didn't happen, using empty string."
   organisationDn = ""

# copied from somewhere else chris ferry showed me
try:
   if EvwIsAdmin( sessionkey, system, organisationDn, "" ):
      print "User is admin"
   else:
      print "Not admin"
except:
   print "exception thrown trying to determine if you are admin"

# resume code copied from user.vps
try:
   ior = system.resolve("User Manager")
   userManager = orb.string_to_object( ior )
   userManager.ping()
except:
   print "Unable to connect to the User Manager"

try:
   userIor = userManager.selectUser( sessionkey , userDn )
   User = orb.string_to_object( userIor )
except:
   print "Unable to connect to User : %s" % userDn

try:
   username = User.getUsername( sessionkey )
   print username
   if username != "admin":
      print "Is not admin user"
   else:
      print "Is indeed the admin user"
except:
   print "Error trying to determine user name. so there."

print "<hr>"
%>



#########################################################################
030307 Friday

Made progress yesterday, though it was a game of inches. Swolf says
that they login under different names but have permission to view the
logs so I will have to find the permission bit thing eventually.

Worked out how to check for membership in an array in Python. Not too
hard. I can maintain a simple ACL this way for the forms.

Location for FC acl module:
/usr/lib/python1.5/site-packages

Got it. Putting "session.set(vars)" in the imported file did not
work; I guessed it was some sort of namespace issue, and looks like
it was. I think all the pieces are in place now except that: if
certain reports require different db user/pw combinations we are in
trouble.

Spent the afternoon chasing bugs; for some reason the product summary
report isn't working again. Then helped Jessy test 4templates.




#########################################################################
030310 Monday

Ha. The bug I was working on, on Friday, was the simplest of
things. I had a typo in the database username. It occured to me to
copy/paste the debug output for the script into *scratch* for trial
runs both ways (through CgiTree and not), and it jumped right out at
me.

Test plan: for each report, save the HTML for the frame, first using
the direct links, then via navigation on CgiTree. Diff the HTML files
when done; they should only differ by timestamps, which seem to
appear in JS here and there.

Ran tests on six of eight reports; no data for the other two. All
look good. Requested a code review.

Got a quickie job that turns out to be a huge problem. They want to
email all the people from 3/3, and ccTransactionLog.vps times out (I
think). We got a list from E-xact of all 108 ppl from 3/3, but none
of the names match what the SQL query returns.

To make matters worse it looks like the record with the email address
is multiline. I had to write a Perl script to parse out CC names and
email addresses.



#########################################################################
030311 Tuesday

Hungry already.

Rob called us in last night after I found that none of the people of
March 3rd matched his list, and it's because he meant the
6th. Meanwhile, a SQL query from staging returns no results on
production. How would they differ?

Dummy! MerchantAccountId is 2 on staging, 1 on prod. Simple.

Now, why does the page time out? Why did curl fail? Simple again:
year was hardcoded to 2002.

Look at the size of output for different queries. 3/6 makes a 3.5MB
html file. I stripped out 1.2MB just in font tags.

Busy busy day. In the end I got the ccTransactionLog web page to
return; I sent it to Rob and Gautam, and they wanted to use that; but
I neglected to span the 5th through the 7th, so I had to rerun it. It
took 27:41 on a 30min timeout! I was chomping my nails.

The next trick was to filter out only "Approved" transactions. I
pumped the HTML through Lynx into a text file, then split the file on
a string that appears in every row ("Gateway Message:"). Then I
grepped the file for "Card Holder|@", then wrote a tiny one-off Perl
script to print the lines but only print a newline every other line
(using modulus).

I also submitted myself for a code review... I printed out the Python
I wrote for splash.vps. It was quite nerve wracking, but it turned
out to be so totally worthwhile; we had a discussion about how to
solve the problems and some great ideas came out.

Spent time on an interrupt from Swolf, where five people were charged
three times on 2/20. I don't have a log entry for that day; that was
around the time Gautam put the hammer down and I hurried to put stuff
into the system. I grepped the XML files on production and not one
matched the email addresses. I then checked against the csv file, and
only one matched (which had a bad credit card). So none of those
could have been run on 2/20 by me or Zlatin.



#########################################################################
030312 Wednesday

Stolen from ComputerWorld:
<script LANGUAGE="JavaScript">
location.replace('http://www.example.com/');
</script>

Got the clear from Eric and Jessy to work on splash.vps on Ampira.

Refactoring: I put in a redirect to a splash page for the admin
user. I made a small gaff where I left out the code to import
bypassCgiTree, which set me back several minutes until I figured out
why the forms wouldn't work. Duh. All seems snappy now.

Swolf said over lunch the multiple charges incurred by some users of
iReg come from a batch import from a year ago. He didn't elaborate.

Was going over my .emacs file for obsolete code, and Rob Walker
emailed me with a problem with the reports generated by
packageActivityReport.py. Investigating. First theory: errant commas.

How to fix packageSummaryReport.py: join with tabs; for each line,
convert commas to spaces, convert tabs to commas.

Been watching the install process for the devil environments, which
is like watching paint dry.

New task: read code for devnull gateway.



#########################################################################
030314 Friday

Rob sent a spreadsheet with the people from 3/6, culled from the xls
file I sent, and I wrote a quickie Perl script that calls curl to
call the search.vps page. This gave me one html page for each result,
and I used a one liner shell loop to convert them to text files with
lynx. From there I only had to grep for the email address; five orgs
had none, and around three had multiple matches that I had to check
by eyeball.

Accountholders table holds the ldap string for that organization;
from that the email address should be derivable.

Connecting credit card name to ldap entry:

db2 "select cardholdername,organisationdn
from genericccclientaccinfo, accounts, accountholders 
where genericccclientaccinfo.accountid=accounts.accountid
and accounts.accountholderid=accountholders.accountholderid"

From there the organization can be parsed out and used in an ldap
query:

ldapsearch -h evw-1.dev.ampira.com -p 400 -D "cn=Directory Manager" -w "11223344" -b "o=DMFC" "$org"


Perl script:

#!/usr/bin/perl
die "Usage: $0 <organisation name>\n" unless $ARGV[0];

@lines = <<`CMD`;
db2 connect to evw user evwbill using 112233
db2 "select organisationdn,cardholdername from
genericccclientaccinfo,accounts, accountholders where
genericccclientaccinfo.accountid=accounts.accountid and accounts.accountholderid=accountholders.accountholderid"
CMD

for (@lines) {
    chomp;
    #print "line: $_\n";
    m/^o=[^,]+/;
    $org = $&;
    next unless $org =~ /$ARGV[0]/i;
    ($ldapstring, $ccname) = split /     +/, $_;
    push @matches, { orgname => $org, ldapstring => $ldapstring, ccname => $ccname }
}

foreach $match (@matches) {
    $org = $match->{orgname};
    @ldaplines = <<`RESULT`;
ldapsearch -h evw-1.dev.ampira.com -p 400 -D "cn=Directory Manager" -w "11223344" -b "o=DMFC" "$org"
RESULT

print $match->{ccname}, ", ";
for (@ldaplines) { if (/email/) { print; last; } }
}

Next step would be to convert this into pure Python.



#########################################################################
030317 Monday

Cleaned out mailbox, did the 11am meeting, still have to enter the
minutes. We went to Yum for carryout, and I spent a little time
seeing if GuiTester would still kick. Ant seems to have a problem
finding httpunit.jar, so for the moment I've shelved that but I think
it can be up and running in short order.

Meanwhile, forgot my glasses and have to read code today. Doh!

Continued reading the code for the devnull gateway; prompted me to
search Amazon for a CORBA book and order a used copy (saved
$30). Dunno what a servant is yet.

Summary: There are only three code files (one Java, two Python test
harnesses) and an IDL file that contains only one statement.

Running "make" runs idlj
(http://java.sun.com/j2se/1.3/docs/guide/rmi-iiop/toJavaPortableUG.html)
which generates a lot of code. That, I haven't read through.

I can summarize the Java file as such: a few helper classes and a
"main." It does pre-auth, auth, or a combination of the two, and a
rollback (credit) operation. It tests, in a ham-fisted but readable
way, for the cc number and throws the appropriate error.

The Python test harness feeds all input codes and reports if an error
is not thrown.

The other Python file might not work. It contains little code.

After the meeting I wrote Gautam a little proposal to update
GuiTester to speed up the process of visp testing. He just came by
for a chat, we talked about it, and he approved a pilot project.

OK, got a simple test to work on staging. Problems: Can't even get a
"Hello, world" to run on my Mac. Reason: 

Exception in thread "main" java.lang.NoClassDefFoundError: Hello

So that goes. Next, put the stuff on staging, got the jars in the
classpath the cheap way (current working dir). and got that to run
OK. No ant on staging though, so automation is impeded.

Gathering data for a real test:

start url:
https://secure.host4templates.com/Applications/DomainRegistration/installingConfig.jsp;jsessionid=aaaf9Y6CQOgFdn?stepId=2000

nonsecure:
http://host4templates.dev.ampira.com/Applications/DomainRegistration/installingConfig.jsp;jsessionid=aaahI8IeODiC6R?stepId=2000

input type="text" class="formfield" name="registrationDomainPrefix"
<select class="formfield" name="registrationParentZone">

                           <option selected value="com">com
<option value="net">net
<option value="org">org
<option value="co.uk">co.uk
<option value="biz">biz
<option value="info">info

Here we get the start page and fill in the form field and submit.
Problem: no submit button. Will have to go into httpunit docs to see
if there is a way around this. Form has a name though.

Next page: 

 <form name=configForm method=post> 
 <select class=EvwTextInput name="registrationPeriod">
<option value="1">1 year ( $14.99 )
<option selected value="2">2 years ( $29.98 )
<option value="5">5 years ( $74.95 )

Problem: no submit button.

Next page: lots of form fields. Still no submit button.

then choose payment (one small form)

then payment info (choose credit card)

"Finish" (do assertion to make sure we completed)

Thought: if error, dump page to file for user.

...

Ok, looks like form.submit() is sufficient. Next problem: secure
sockets.

Exception: java.lang.Exception: Couldn't get a page from URL
'https://secure.host4templates.com/Applications/DomainRegistration/\ '

java.lang.RuntimeException: https support requires the Java Secure
Sockets Extension. See http://java.sun.com/products/jsse


Good deal: assertion worked on the text. So the form.submit() is
kosher. We are underway.

Gautam ran Hello.class just find, figured out there was another
Hello.class in my classpath, put . at the front and it's solved. I
can run the tests locally now and the secure stuff should be
available (part of 1.4).




#########################################################################
030318 Tuesday

Day after St. Patrick's, feeling fine.

myurl = "http://host4templates.dev.ampira.com/Applications/DomainRegistration/installingConfig.jsp;jsessionid=aaa7Ygk8ZAKmYC?stepId=2000";

Test now works on my Mac. Weird session key error though.

Right now a submit button is required; I need to refactor to remove
this requirement, and allow a "if no submit button, generate
form.submit() code instead" block of Java.

This new block is like this:

            // get and fill the HTML form
            
            htmlforms = response.getForms();

            if (htmlforms == null || htmlforms.length == 0)
                throw new Exception("No HTML form found for:\n" + response);

            htmlform = htmlforms[0];

            /*            
            submitButtonArray = htmlform.getSubmitButtons();

            if (submitButtonArray == null || submitButtonArray.length == 0)
                throw new Exception("Didn't get a submit button array in "
                                    + "response object:\n");


            request = htmlform.getRequest(submitButtonArray[0]);
            */
            try {
                
            htmlform.setParameter("registrationDomainPrefix", "thereisnosuchzzthing");

            } catch (Exception n) {
                throw new Exception( n
                                     + "\nCouldn't set a parameter in this form:\n"
                                     + htmlform );
            }

            try {
                response = htmlform.submit();
            } catch (Exception r) {
                throw new Exception(r + "\nCouldn't submit the form!\n" +
                                    "Request was:\n" + request + "\n");
            }
            

Note the old code is commented out.

I think we are definitely running into session key problems. Yup. New
twist: gotta start with Jessy's packagetest.html page, but the links
are Javascript. Sigh. Gotta get the form somehow.

Hurray! https URLs can be gotten now, since Apple shipped Java
1.4. Cross one more hurdle off the list.

Here's the deal: on packagetest.html there are A links with
javascript, but these just set a form variable and submit the
form. So: the .inputs files will have to do this themselves.

Imported the project into CVS.

Looks like javascript in A tags is not supported:

[ketelone guitester]$ java BuyPackage
Name for this test: BuyPackage Test 3/18/03 2:58:42 PM
	Title match: Matched 'Testing' OK
GET request for (https://secure.host4templates.com/packagetest.html)
javascript:
document.productWizardForm.productId.value="1046812683.364825";
document.productWizardForm.submit();
Exception: java.lang.NullPointerException
BuyPackage test failed.

Solution to the hidden form element problem:

try {
    System.out.println("productId is now: '" + htmlform.getParameterValue("productId") + "'");
    htmlform.setParameter("productId", "");
    // hack to set the hidden field
    WebForm.Scriptable foo = htmlform.getScriptableObject();
    foo.setParameterValue("productId", "1046812683.364825");
    System.out.println("productId is now: '" + htmlform.getParameterValue("productId") + "'");

} catch (Exception n) {

This reduces to:
htmlform.getScriptableObject().setParameterValue("productId", "1046812683.364825");




#########################################################################
030319 Wednesday

All was going well today: refactored maketest.pl, generated the java
code, compiled... and I'm running into a Javascript error of some
kind:

TypeError: "webHost" is not defined.
	at org.mozilla.javascript.NativeGlobal.constructError(NativeGlobal.java:590)
	at org.mozilla.javascript.NativeGlobal.constructError(NativeGlobal.java:550)
	at org.mozilla.javascript.NativeGlobal.typeError1(NativeGlobal.java:560)
	at org.mozilla.javascript.Interpreter.interpret(Interpreter.java:2042)
	at org.mozilla.javascript.InterpretedFunction.call(InterpretedFunction.java:58)
	at com.meterware.httpunit.javascript.JavaScript$JavaScriptEngine.performEvent(JavaScript.java:156)
	at com.meterware.httpunit.scripting.ScriptableDelegate.doEvent(ScriptableDelegate.java:46)
	at com.meterware.httpunit.WebResponse$Scriptable.load(WebResponse.java:570)
	at com.meterware.httpunit.javascript.JavaScript$Window.initialize(JavaScript.java:401)
	at com.meterware.httpunit.javascript.JavaScript.run(JavaScript.java:80)
	at com.meterware.httpunit.javascript.JavaScriptEngineFactory.associate(JavaScriptEngineFactory.java:46)
	at com.meterware.httpunit.RequestContext.runScripts(RequestContext.java:44)
	at com.meterware.httpunit.WebWindow.getResponse(WebWindow.java:111)
	at com.meterware.httpunit.WebWindow.updateWindow(WebWindow.java:133)
	at com.meterware.httpunit.WebWindow.getSubframeResponse(WebWindow.java:119)
	at com.meterware.httpunit.WebWindow.getResponse(WebWindow.java:110)
	at com.meterware.httpunit.WebWindow.sendRequest(WebWindow.java:99)
	at com.meterware.httpunit.WebRequestSource.submitRequest(WebRequestSource.java:218)
	at com.meterware.httpunit.WebForm.submit(WebForm.java:65)
	at com.meterware.httpunit.WebForm.submit(WebForm.java:53)
	at BuyPackage.main(BuyPackage.java:175)
Exception: java.lang.Exception:
	com.meterware.httpunit.ScriptException: Event
	'document.configForm.webHost.focus();' failed: TypeError:
	"webHost" is not defined.

Trouble is, "webHost" doesn't appear in any of the source code (java
or html). So I can't even tell where it's getting this from.

Need a hack: 
setoption: "name", "value"
which writes it out the old way:

            htmlform.getScriptableObject().setParameterValue("physicalCity", "New York");
            htmlform.setParameter("physicalStateUS", "NY"); // old way

I can run the test against production and it's fine. But there is
some weird problem with staging; every domain name is in use, no
matter how random I make them.

I wrote a little static method to write the HTML to a file, a big
convenience.





#########################################################################
030320 Thursday

Today the F train is running on the G line, leading to delays, and I
didn't get in until 10am exactly.

Staging had issues which were fixed; I refreshed my test data and was
able to go through the whole package buying sequence. I checked the
stuff in.

After doing some testing on userDn strings and Python syntax I put a
new acl file in the Python path; I put files on prod and staging in
/usr/lib/python1.5/site-packages, and checked in the code for
splash.vps and splashAdmin.vps.

Almost time to go; the day flew by. Spent time adding debug code to
GuiTester and looking for a workaround to the Javascript problem, no
luck though. One would think httpunit would provide a way to shut off
Javascript processing.





#########################################################################
030321 Friday

Searched the docs again for a way to disable Javascript, no luck;
wrote an Emacs command to open current file in Safari.

Stripped the webForm strings from two files on staging to get the
test to work; works fine now. Added more calls to writeFile(), which
I can easily open in Safari now. Did not check in JS stripping
though; we'll have to deal with that later, and I will make mention
in Twiki.

Wrote up a good long page on guitester, including usage examples;
wrote up Monday's minutes.




#########################################################################
030324 Monday

Minutes to the 11am meeting done. Gautam mentioned guitester, which
was well receieved; he suggested I get it to work on Jessy's machine,
which is a good idea.

Bleh. Need service pack 2 or the jdk won't install.

Finally just copied the files over via Bababooey when I couldn't get
winzip. There is something wrong with Support's box. I installed the
trial version but it didn't like my tarball. So screw it.

I tried just double clicking the .class files but no go.

After a long struggle I decided to install cygwin, and that is taking
for fucking ever now. Bleh. I hate days like this. I think I'll see
if I can run Emacs off the dvl machines.



#########################################################################
030325 Tuesday

Superhistory is in the crontab but hasn't run since March
3rd. Hrmm. I just edited the crontab and waited, and it ran. Did it
need a newline at the end of the crontab entry?

Emacs on evw-1.dvl, running here on my Mac with X11, works really
nice. It will be a huge improvement over Emacs in Terminal like on
staging.

OK, one dumb mistake: I was not looking in the second column on Sun's
site for the SDK and kept seeing the JRE. Oddly the top of the page
says Runtime Environment.

Next, the long battle to get the classpath right. I found that by
default guitester doesn't run on my Mac unless I put . in the front
of the classpath, which lets it find the jar files there; on Windows
I have to pass everything in via -classpath:

unset FOO
for i in *.jar; do FOO=$FOO\;$i; done
echo $FOO
FOO=".$FOO"
echo $FOO
java -classpath "$FOO" BuyPackage

This set up things right so I could run the test, and I did. Better
still would be to generate a Java app the gui people could just run.

Almost have drag and drop working on a batch file; problem is the
filename has the .class extension.

Did code review with JeffO and Gautam today at the dev meeting,
covered guitester's input file language.



#########################################################################
030326 Wednesday

Trying to refactor the project so "assert" keywords are now "look_for."

Found a bug: multiple args to maketest.pl results in java files where
every one has the same class name declared, which is the first one
processed. Just need to reset this variable for each argv.

Refactoring done; updated the README.

Thought: a keyword, tell_user:, which just echoes to the screen. This
way statements can be printed to track what's going on; the classic
debugging method. The problem is the way the Java code is created; it
doesn't allow for arbitrary words to be inserted between statements.

Unix time from Java:
import java.util.*;
System.out.println(Calendar.getInstance().getTime().getTime());

I was looking at creating on-the-fly values for the input files; it
gets tedious to change the values of domain, email, etc. every
time... but perhaps it's a none-issue. Probably more important I
finish the tell_user: keyword.



#########################################################################
030327 Thursday

Finished up the new keyword "tell_user" and checked that into CVS.

Helped debug a problem with splash.vps; actually two: the app servers
couldn't find the imported files, so Chris had to propagate those;
and splash.vps was failing for Lysa on a search because it didn't
have a session key. It turns out this is an old problem they solved
before and had nothing to do with my code (phew).

Gautam asked me to look into a bypass for the SignupWizard;
researched it, wrote Ken asking if the solution I have in mind will
work.

Tracking the SignupWizard:

first page is installingConfig.jsp, which includes
installingConfigCode.jsp;
This in turn loads:

<%@ include file="/wizard/include.jsp"%>
<%@ include file="/wizard/stepList.jsp"%>
<%@ include file="/Includes/htmlComponents.jsp"%>
<%@ include file="/Includes/clientSideUtils.jsp"%>
<%@ page import="com.evolutionware.CORBA.*"%>
<%@ page import="java.util.Vector"%>
<%@ page import="java.text.NumberFormat"%>

Ken wrote back that simply posting the vars with a form of Hungarian
Notation (it kinda looks like it at least) is sufficient.

[snip]
From: "Kenneth Maikish" <kmaikish@systemsfusion.com>
Date: Thu Mar 27, 2003  4:41:47 PM America/New_York
To: "'Steve Wainstead'" <swain@ampira.com>
Subject: RE: signup wizard

Hi Steve,

Of course it's possible, and you don't have to set the variables in the
session yourself, though that would work as well.

All you have to do is post the variables with their proper names.  You
can get the names from the debugDump.  The only thing to remember is
ProductConfig attributes must be posted with a 'pc_' preceding the
variable name.  

So, if you want to post the package ID, use:
<input type=hidden name="productId" value="1002036394.746">

If you want to post a domain name, use:
<input type=text name="pc_RegistrationDomainPrefix"
value="domain_prefix">
<input type=text name="pc_RegistrationParentZone"
value="top_level_domain"> 

You can post pretty much any piece of data to the wizard, as long as you
use the right names for the variables.  Account types or information,
usernames, whatever.

However, I believe that if you post the domain information as above, the
whois page will come up first.  I wrote that into the wizard for Ampira
a year or so ago.  I think (this hasn't been tested in a while so let me
know if you have problems) that if you post 'whoIsDone=yes', the wizard
will skip the whois lookup.  

I think that answers all your questions.  Good luck.

Ken

-------------------------------------------------------
Kenneth Maikish
Support Team Manager
Systemsfusion Inc.
kmaikish@systemsfusion.com
Desk: 510 663 7910 x404
Mobile: 415 218 8741
-------------------------------------------------------

-----Original Message-----
From: Steve Wainstead [mailto:swain@ampira.com] 
Sent: Thursday, March 27, 2003 1:28 PM
To: Kenneth Maikish
Cc: Gautam Guliani
Subject: signup wizard

Hi Ken! Long time no write.

I was asked to look for a shortcut into the SignupWizard. The question 
is, if we already know the domain name the user wants (and, I assume, 
we know it's available), and the duration they want it for, can we skip 
directly into customerInfo.jsp?

Using the trick you taught me, with debugDump=yes, I could see the 
domain and period are stored in the session info after the user has 
stepped through installingConfig.jsp pages.

One solution, then, would seem to be writing a JSP that sets these two 
values in the session and redirects to customerInfo.jsp. I'm not sure 
if SignupWizard is going to like this though.

Is this possible?

thanks
~swain
[snip]



#########################################################################
030328 Friday

From: "Steven Wolf" <swolf@ampira.com>
Date: Fri Mar 28, 2003  8:54:50 AM America/New_York
To: "Steve Wainstead" <swain@ampira.com>
Cc: "Gautam Guliani" <gautamg@ampira.com>
Subject: 14.4 & Marketing Report

Steve,

Would you please re-run February and March marketing reports from the
STAGING server?  We want to check the 14.4 change to the report.  The
marketing report now is supposed to display the cost profile associated with
the installed package instead of the cost profile currently associated with
the package.

If you re-run & send to me & Rob, I'll have that verified.

Thanks,
-steve

Did this. Back to the issue of passing post vars ahead of time to
customerInfo.jsp.

Was thinking about this either last night or this morning, and
thought I need to get the session key, and I can use a way like
Jessy's test page to do this. Last night I couldn't find my
delme.html file though! 

Pronto Pizza 
212 921 1133

Defining advice for a function:

;; define a function (with fun bad grammar) to add advice to 
(defun sw-foo ()
  "no such think"
  (interactive)
  (error "your gay"))

;; declare a variable and document it, default value is nil
(defvar sw-buffer-name nil
  "Hold the user-assigned name of the current buffer, so 
   toggle-buffer-full-filename can reset it to the user-chosen name.")

;; make the variable local to all buffers
(make-variable-buffer-local 'sw-buffer-name)

;; define some advice for sw-foo that sets sw-buffer-name to the
;; local buffer name
(defadvice sw-foo (before advise-foo activate compile)
  "is too such think"
  (setq sw-buffer-name (buffer-name)))

Note that sw-buffer-name, once set in the first buffer, is visible in
all buffers and holds the same value until set locally.

iced/hot decaf extra-shots cup-size syrup-type milk-type extras roomy drink-name




#########################################################################
030331 Monday

Jeanne@work: 718-424-7785




#########################################################################
030401 Tuesday

Whew. Yesterday was intense. From the moment I arrived I was grinding
away on the code for the V3 redirect, which lands the user on the
third page (customer info). Ken wrote about five or ten lines across
a jsp and a servlet to let us send a fqdn and registration period
without a whois lookup; but after that I lost a lot of time trying to
figure out why nothing was working. It turned out Apache read one
code base and Resin read another. Once I'd resolved this, it took a
short while to reach a bug Ken had introduced (invalid cast), and
then it worked. Later I'd have to write the jsp, and today that was
abandoned in favor of GET.

Spent a few minutes reading over Elisp control structures:

;; when is a special form of "if", executing all lists in sequence if
;; condition is true
(when (> 1 0)
  (message "go and save yourself")
  (message "take it out on me")
  (message "While my BRAINPAN is being refused service in BURGER KING,
 Jesuit priests are DATING CAREER DIPLOMATS!!"))

;; same, but if not true
(unless (> 0 1)
  (message "foo and shave yourself")
  (message "take it out on me")
  (message "HELLO KITTY gang terrorizes town, family STICKERED to death!"))

;; if only does the first list
(if (< 0 1)
  (message "you gave me life" )
  (message "now show me how to live")
  (message "Toes, knees, NIPPLES.  Toes, knees, nipples, KNUCKLES...
 Nipples, dimples, knuckles, NICKLES, wrinkles, pimples!!
 I don't like FRANK SINATRA or his CHILDREN."))

;; cond == case statement
(cond 
 ((= 1 1) "foo") 
 ((= 2 3) "bar")
 ((> 1 0) "blippy")
)

;; while loop
(setq harhar 5)
(while (> harhar 0)
  (insert (format "harhar: %d\n" harhar))
  (setq harhar (1- harhar))
)

;; dotimes macro is a special form of while, similar to perl's for (0..10)
(progn
(setq x "\nhiya\n")
(setq y 1)
(dotimes (y 5)
  (insert x)))

Can't remember what I wanted a (while()) loop for now. (It was for
a replacement for taillog).



#########################################################################
030402 Wednesday

default-directory is where the PWD is stored.
(yes-or-no-p "Do you think I'm sexy? ")
(split-window-vertically)

Testing URLs:

https://secure.hostv3.com/wizard/signup/signup?EvwIspDn=o%3DHostV3%2Cou%3DClients%2Co%3DFCTY&productId=1048620900.514884

http://hostv3.dev.ampira.com/wizard/signup/signup?EvwIspDn=o%3DHostV3%2Cou%3DClients%2Co%3DDMFC&productId=1048620900.514884

Spent a lot of time testing the V3->EVW situation. Could not
reproduce the bug reported, but created plenty of my own. Also spent
time with Resin and evw-1.dvl, trying out different things. Couldn't
get a servlet going, but that's just a config issue. I stopped
becaues Swolf authorized the SF guys to go in and upgrade devil.



#########################################################################
030403 Thursday

Added soap.jar from the Apache project to /opt/evw/java on
devil. Bounced evw.

On /opt/evw/evw-frontend/wizard, did a chgrp -R other and a chmod -R
g+w.

Moved resin-2.1.6 into ~swain/public_html.

Had Zlatin bounce Apache and Resin on dvl:

/etc/rc2.d/S80apache stop/start


Lunched, read up on some Emacs Lisp commands. Talked over the stats
project with JeffO, who finds it tedious to work on. I told him the
challenge is to make the problem interesting.

Logged in as admin, created wcwank client.
Added user joeblow to client wcwank
Bought test package for wcwank (negativegasoline.com)
Tried to change CC number for Wank WcWank, keeps reverting to Visa.
Connected to db2 via the CLI, no problems. Reset db2inst1 password to
112233.
Search Jobs: type 1; results: 3. Click view, you're taken back to the
search pane.
completed domain vetting for wainstead.org, clears OK
cc transaction log OK
tried to suspend negativegasoline.com for wcwank, but blocked due to
job in system (OK)

Help link broken, opens two frame window with 404's
The requested URL /navpane2.htm was not found on this server.
The requested URL /getting_started/welcome_to_evolutionware.htm was not found on this server.

Product summary report appears OK


Log files:
BaseModule.log: [Thu Apr  3 14:27:29 2003 |002|evwModule=Base,o=FCDE                        |getCoreChildNodes             ][10] An error occurred while attempting to group the node (evwMerchantId=0000000001,o=FCDE), The node will not be grouped

Billing.log: [Thu Apr  3 16:14:22 2003
|003|evwModule=Accounts,evwModule=Billing,o=FCDE
|Accounts_impl::getTaxForJournalEntry][ 4] Could not get the tax for
the journal entry (0). An unknown error occurred.

GlobalSystemProxy.log:[Thu Mar 20 14:37:25 2003 |000|GlobalSystemProxyImpl                        |getRealGS                     ][ 5] Error trying to narrow/ping GS (IDL:omg.org/CORBA/NO_PERMISSION:1.0)

System.log:[Thu Apr  3 14:25:13 2003 |003|evwModule=System,o=FCDE                      |getHintQuestionForUser        ][ 7] An LDAP error [Attribute Not Found [evwHintQuestion]] occurred while finding the hint question for the username (admin).

Transaction.log:[Thu Mar 27 14:23:21 2003 |002|BatchThread                                  |sendProductBatch              ][18] A corba communications error occurred while submitting batch ID 3 for product OID 1.3.6.1.4.1.3999.1.9.1.1.15.1 to Global System

Assisted Lysa in debugging problem with productSummaryReport.vps
breaking, since I was the last to edit it according to the collected
.bash_history files. CVW was editing it live based on instructions
from Rob Walker. Feh.




#########################################################################
030404 Friday

Printing the classpath, again:

////////////////////////////////////////////////////////////
String cp = java.lang.System.getProperty("java.class.path");
//out.println(cp.replace(':', '\n'));

char[] ca = cp.toCharArray();

for (int x = 0; x < ca.length; x++) {
   if (ca[x] == ':') { out.println("<br>\n"); }
   out.print(ca[x]);
}
////////////////////////////////////////////////////////////

Spent the morning tinkering with configuration of Resin. I finally
got a simple servlet working, but getting SOAP stuff to work was a
no-go (at least for the sample files) because Resin's war dir is
turned off in the conf file. I did add one servlet, SoapTest, to
/opt/evw/evw-frontend/WEB-INF/web.xml. I didn't want to change the
configuration to the point where .war files could be used though.

At least, the servlet can import the SOAP libraries with no errors.

At the start page for dvl, there is a dropdown with no choices, in a
box labeled "Full Catalog." Choosing this leads to a servlet error:

<!-- diagnostic output -->
<!---- begin wizard error report --

Date: Fri Apr 04 14:20:29 EST 2003
Remote IP: 10.1.1.252 (10.1.1.252)
URI: /wizard/genericError.jsp

HTTP Headers:
    Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,video/x-mng,image/png,image/jpeg,image/gif;q=0.2,text/css,*/*;q=0.1
    Accept-Encoding: gzip, deflate, compress;q=0.9
    Accept-Language: en-us, en;q=0.50
    Connection: keep-alive
    Cookie: JSESSIONID=aaa7g4RKeXdAHD
    Host: evw-1.dvl.ampira.com
    Keep-Alive: 300
    Referer: http://evw-1.dvl.ampira.com/
    User-Agent: Mozilla/5.0 (Macintosh; U; PPC Mac OS X Mach-O; en-US; rv:1.0.1) Gecko/20021220 Chimera/0.6+
    EVW_HOME: /opt/evw
    LD_LIBRARY_PATH: /opt/netscape/server4/lib:/opt/evw/lib:/usr/local/lib:/opt/netscape/server4/lib:/opt/evw/lib:/usr/local/lib:/home/db2inst1/sqllib/lib
    CACHE_ROOT: /opt/evw/frontend-cache
    DB2INSTANCE: db2inst1

Cookies:
    JSESSIONID: aaa7g4RKeXdAHD

Exception:
com.evolutionware.wizard.WizardException: Exception thrown by productModule.getMerchantProducts: null
	at _wizard._signup._selectProduct__jsp._jspService(_selectProduct__jsp.java:1678)
	at com.caucho.jsp.JavaPage.service(JavaPage.java:87)
	at com.caucho.jsp.JavaPage.subservice(JavaPage.java:81)
	at com.caucho.jsp.Page.service(Page.java:474)
	at com.caucho.server.http.FilterChainPage.doFilter(FilterChainPage.java:166)
	at com.caucho.server.http.Invocation.service(Invocation.java:277)
	at com.caucho.server.http.CacheInvocation.service(CacheInvocation.java:129)
	at com.caucho.server.http.RunnerRequest.handleRequest(RunnerRequest.java:334)
	at com.caucho.server.http.RunnerRequest.handleConnection(RunnerRequest.java:266)
	at com.caucho.server.TcpConnection.run(TcpConnection.java:140)
	at java.lang.Thread.run(Thread.java:484)

JSP session Id: aaa7g4RKeXdAHD
JSP session attributes:
    I18N: "com.evolutionware.UI.I18N@37d4a4"
    EvwCss: "<LINK REL="stylesheet" TYPE="text/css" HREF="/Style/Css/default">"
    wizard: "com.evolutionware.wizard.SignupWizard@6963d0"

Wizard
Steps:
    0   1000    /wizard/signup/selectProduct.jsp

ProductConfig:

Attributes:
   EvwIspDn: "%EvwIspDn%"
   ipAddress: "10.1.1.252"
   ccNumber: ""
   ccExpiryDate: ""
   postalZip: ""

-- end wizard error report --
-->

Likewise, domain parking ends in error:

-- begin wizard error report --

Date: Fri Apr 04 14:26:30 EST 2003
Remote IP: 10.1.1.252 (10.1.1.252)
URI: /wizard/signup/signup

HTTP Headers:
    Accept: */*
    Accept-Language: en-us, ja;q=0.21, de-de;q=0.86, de;q=0.79, fr-fr;q=0.71, fr;q=0.64, nl-nl;q=0.57, nl;q=0.50, it-it;q=0.43, it;q=0.36, ja-jp;q=0.29, en;q=0.93, es-es;q=0.14, es;q=0.07
    Connection: close
    Content-Length: 169
    Content-Type: application/x-www-form-urlencoded
    Host: evw-1.dvl.ampira.com
    Referer: http://evw-1.dvl.ampira.com/
    User-Agent: Mozilla/5.0 (Macintosh; U; PPC Mac OS X; en-us) AppleWebKit/60 (like Gecko) Safari/60
    EVW_HOME: /opt/evw
    LD_LIBRARY_PATH: /opt/netscape/server4/lib:/opt/evw/lib:/usr/local/lib:/opt/netscape/server4/lib:/opt/evw/lib:/usr/local/lib:/home/db2inst1/sqllib/lib
    CACHE_ROOT: /opt/evw/frontend-cache
    DB2INSTANCE: db2inst1

Cookies:

Exception:
com.evolutionware.wizard.WizardException: Unable to get product config pages
	at com.evolutionware.wizard.Wizard.addProductConfigPages(Wizard.java:516)
	at com.evolutionware.wizard.SignupWizard.postHandleStep(SignupWizard.java:103)
	at com.evolutionware.wizard.WizardServlet.doPost(WizardServlet.java:139)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:165)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:103)
	at com.caucho.server.http.FilterChainServlet.doFilter(FilterChainServlet.java:82)
	at com.caucho.server.http.Invocation.service(Invocation.java:277)
	at com.caucho.server.http.CacheInvocation.service(CacheInvocation.java:129)
	at com.caucho.server.http.RunnerRequest.handleRequest(RunnerRequest.java:334)
	at com.caucho.server.http.RunnerRequest.handleConnection(RunnerRequest.java:266)
	at com.caucho.server.TcpConnection.run(TcpConnection.java:140)
	at java.lang.Thread.run(Thread.java:484)

Caused by exception:
com.evolutionware.CORBA.ProductNotFound
	at com.evolutionware.CORBA.ProductNotFoundHelper.read(ProductNotFoundHelper.java:67)
	at com.evolutionware.CORBA.ProductNotFoundHelper.extract(ProductNotFoundHelper.java:34)
	at com.evolutionware.CORBA.StubForProductModule.getPackageConfigPages(StubForProductModule.java:5279)
	at com.evolutionware.wizard.Wizard.addProductConfigPages(Wizard.java:493)
	at com.evolutionware.wizard.SignupWizard.postHandleStep(SignupWizard.java:103)
	at com.evolutionware.wizard.WizardServlet.doPost(WizardServlet.java:139)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:165)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:103)
	at com.caucho.server.http.FilterChainServlet.doFilter(FilterChainServlet.java:82)
	at com.caucho.server.http.Invocation.service(Invocation.java:277)
	at com.caucho.server.http.CacheInvocation.service(CacheInvocation.java:129)
	at com.caucho.server.http.RunnerRequest.handleRequest(RunnerRequest.java:334)
	at com.caucho.server.http.RunnerRequest.handleConnection(RunnerRequest.java:266)
	at com.caucho.server.TcpConnection.run(TcpConnection.java:140)
	at java.lang.Thread.run(Thread.java:484)

JSP session Id: aaabERP6siyxYs
JSP session attributes:
    EvwCss: "<LINK REL="stylesheet" TYPE="text/css" HREF="/Style/Css/default">"
    wizard: "com.evolutionware.wizard.SignupWizard@428cb7"

Wizard
Steps:

ProductConfig:
   RegistrationDomainPrefix: "gasolinefire" 0 0.0
   RegistrationParentZone: "com" 0 0.0

Attributes:
   accountData3: "1203"
   accountData2: "************1111"
   RegistrationDomainPrefix: "gasolinefire"
   RegistrationParentZone: "com"
   ipAddress: "10.1.1.252"
   productId: "1002036394.746"
   postalZip: "1391GELMST40404"

-- end wizard error report --


Stepping through the purchase of a mailing list, zip code is hosed
again.

Session:

ID: aaabERP6siyxYs

Attributes:
    I18N: com.evolutionware.UI.I18N@5c458c
    EvwCss: <LINK REL="stylesheet" TYPE="text/css" HREF="/Style/Css/default">
    wizard: com.evolutionware.wizard.SignupWizard@5a1515





Servlet context:

Attributes:
    javax.servlet.context.tempdir: /opt/evw/evw-frontend/WEB-INF/tmp
    caucho.class.path: .:/opt/evw/evw-frontend/WEB-INF/classes:/usr/jakarta-log4j-1.2.7//dist/lib/log4j-1.2.7.jar:/usr/j2sdk1_3_1/lib/tools.jar:/opt/evw/java/ADM.jar:/opt/evw/java/ADMModule.jar:/opt/evw/java/AnalogProduct.jar:/opt/evw/java/ApacheAnalog.jar:/opt/evw/java/ApacheWebRedirect.jar:/opt/evw/java/DomainManagementProduct.jar:/opt/evw/java/EVW.jar:/opt/evw/java/FSSL.jar:/opt/evw/java/FSSLIAIK.jar:/opt/evw/java/MailListProduct.jar:/opt/evw/java/MivaProduct.jar:/opt/evw/java/OB.jar:/opt/evw/java/WebRedirectProduct.jar:/opt/evw/java/Webmail.jar:/opt/evw/java/crimson.jar:/opt/evw/java/db2java.jar:/opt/evw/java/iaik_jce_full.jar:/opt/evw/java/iaik_ssl.jar:/opt/evw/java/jsdk23.jar:/opt/evw/java/junit.jar:/opt/evw/java/mail.jar:/opt/evw/java/netscape.jar:/opt/evw/java/resin.jar:/opt/evw/java/soap.jar:/opt/evw/java/xalan.jar:/opt/evw/java/db2java.zip:/opt/evw/java/runtime.zip:/usr/local/resin-2.0.2/lib/resin.jar:/usr/local/resin-2.0.2/lib/jdbc2_0-stdext.jar:/usr/local/resin-2.0.2/lib/jta-spec1_0_1.jar:/usr/local/resin-2.0.2/lib/jndi.jar:/usr/local/resin-2.0.2/lib/dom.jar:/usr/local/resin-2.0.2/lib/sax.jar:/usr/local/resin-2.0.2/lib/jaxp.jar:/usr/local/resin-2.0.2/lib/webutil.jar:/usr/local/resin-2.0.2/lib/jdbc-mysql.jar:/usr/local/resin-2.0.2/lib/jsdk23.jar:/usr/j2sdk1_3_1/jre/lib/rt.jar:/usr/j2sdk1_3_1/jre/lib/i18n.jar:/usr/j2sdk1_3_1/jre/lib/sunrsasign.jar:/usr/j2sdk1_3_1/jre/classes:/opt/evw/evw-frontend/WEB-INF/classes
    caucho.class-loader: com.caucho.util.DirectoryClassLoader@2a57fb
    caucho.authenticator: null
    resources: com.evolutionware.UI.ResourceManager@1e3e24
    caucho.statistics: com.caucho.server.http.Statistics@1d652
    configuration: com.evolutionware.UI.Configuration@1db0e2
    caucho.login: com.caucho.http.security.BasicLogin@47cadf





The wizard: SignupWizard

Steps:
    0   10    /wizard/signup/whoIs.jsp
    1   1000    /wizard/signup/selectProduct.jsp
    2   2000    /Applications/DomainRegistration/installingConfig.jsp
    3   2001    /Applications/MailList/installingConfig.jsp
    4   3000    /wizard/signup/customerInfo.jsp
    5   4010    /wizard/signup/genericCreditCardAccountConfig.jsp

ProductConfig:
   DomainRegistrationType: "TopLevel" 0 0.0
   RegistrationDomainPrefix: "hoohoohoohahaha" 0 0.0
   maillistName: "freaksintl" 0 0.0
   maillistOwnerEmail: "swain@example.com" 0 0.0
   DelegationDirective: "private" 0 0.0
   RegistrationDomain: "hoohoohoohahaha.com" 0 0.0
   UserDomainRegistrationPeriod: "1" 1 1.0
   RegistrationParentZone: "com" 0 0.0
   DomainRegistrationAction: "New" 0 0.0
   maillistDomain: "evw-1.dvl.ampira.com" 0 0.0
   maillistPassword: "112233" 112233 112233.0
   maillistAgentDn: "evwService=MailList,evwHostname=evw-1.dvl.ampira.com,evwNetwork=Control,ou=Infrastructure,o=FCDE" 0 0.0

Attributes:
   physicalCity: "new york"
   physicalZip: "10018"
   physical2: ""
   hintAnswer: "no"
   physical1: "500 7th ave"
   password: "112233"
   whoIsDone: "yes"
   username: "swaintest0404"
   accountType: "1.3.6.1.4.1.3999.1.9.1.1.15|Test Credit Card|1"
   postalZip: "1391GELMST40404"
   RegistrationDomainPrefix: ""
   accountData3: "1203"
   phone: "3334445555"
   accountData2: "************1111"
   lastname: "pawlowski"
   EvwIspDn: "o=FCDE"
   physicalCountry: "US"
   totalAmount: "0"
   email: "swain@example.com"
   productId: "1047683720.209825"
   ipAddress: "10.1.1.252"
   firstname: "stephen"
   RegistrationParentZone: "com"
   physicalState: "NY"
   hintQuestion: "yesh"
   fax: ""
   companyName: "swaintest0404"


------------------------------

Test plan, thus far:

Buy as many packages as possible, suspend, delete, etc.
Mail templates migration
Test ADM interface
Test home grown scripts: jobInfo.py, for example.


go to http://evw-1.dvl.ampira.com/
enter a domain name under "Claim your own domain"
click "next" on the page SELECT PACKAGE
Eric: package 1
Swolf: package 2
Jessy: package 3
Jeffo: package 4

For the given package, work through the interface to create your
account (note if the billing zip code comes out right). For email
input, just make up a name and use @example.com.

After that, login, add a user, add a domain, or any other trick you
like. Try susending the account.

Report any problems to me.

Testing: I dumped the data from mailtemplatetype and generated a .sh
file to load the data into mailtemplate. Lysa ran the import/export
stuff on it and it was fine. I ran jobInfo.py, no problems.

Eric had no issues with his package buying. Jessy had some issues and
Ken answered them. Gautam checked the ADM and it looked fine. Swolf
had one error which I forwarded to Ken.



#########################################################################
030407 Monday

Continuing with dvl testing: Ken replied to Jessy and Swolf's emails
incorrectly, so we await more explication. GG and I are to do the
disk image according to the plan Ken gave us, which I'm going to
review now. Also Jessy mentioned something about the file manager.




#########################################################################
030408 Tuesday

TODO: write a Python script to hang all jobs in the system, or
delete hung jobs, or both. Oops. Cannot delete jobs! Sucko.

Backed up /opt, /var, and /usr on evw-1.dvl. Er. Gotta do cws-1.dvl
now.

Backup tarball on cws-1.dvl is only about 9MB. Backed up to
/opt/backup/cws-1.tar.gz.

tar -czvf cws-1.tar.gz /opt/evw/var /usr/local/apache/conf
/opt/bind/etc /home/web/members /usr/local/frontpage

Generated a list of all ampira email addresses for Gautam.




#########################################################################
030409 Wednesday

Wanna finish off the dvl env today.

http://www.four09.org/409mp3/

Meanwhile:

Inserting a new page to the wizard isn't exactly trivial, but it's not
too bad.  You will have to modify SignupWizard.java.  Basically, all the
steps are given an integer to determine the order (search for 'STEP' in
the file and you should see what I am talking about).  

Whither:

      addPageURL(STEP_WHOIS, "WhoIsPage");
      addPageURL(STEP_PRODUCT_CATALOGUE, "ProductCataloguePage");
      addPageURL(STEP_CUSTOMER_DETAILS, "CustomerDetailsPage");
      addPageURL(STEP_ACCOUNT_TYPE, "AccountTypePage");
      addPageURL(STEP_FINAL_SUCCESS, "FinalSuccessPage");
      addPageURL(STEP_FINAL_PAYMENTDENIED, "FinalPaymentDeniedPage");





#########################################################################
030410 Thursday

So far, added some touches to the backup file (which is not really a
shell script, though written like one); put that in CVS and
Twiki. Emailed Sunil about transfer of the procedure.

Spent time trying to figure out why I can't run Emacs on cws.devil
and display it here on my Mac; Gautam finally figured out xauth had
to be called via full path in sshd's config.

I'm tracing the activity of the SignupWizard.

SignupWizard constructor: all the pages are added here, and given
order (see previous log entry). The method addPageURL is in the parent
class, Wizard. (Wizard is an abstract class). This method adds a page
URL from a config file; to load the config file it calls
getConfiguration (local method).

Anyway, from the conf object returned by getConfiguration(), it does
a getString( getName(), pageName) and does a pages_.put(stepId,
url). pages_ is a Map class.

Where's the conf file though?

Can one package hold more than one domain? Can an org hold more than
one package? I believe so, regarding the latter. Can we allow people
to buy more than one domain up front?

Was thinking of unifying my bookmark files, since I keep using
different apps; Camino's file is in Library/Application
Support/Chimera/blah/blah/bookmarks.xml. It can't be viewed in a
browser, unfortunately.





#########################################################################
030411 Friday

Decided to leave just before 7pm last night with Jessy. Was in the
middle of adding a test page to the sequence for SignupWizard. Made
cream of chicken soup last night.

Two emails and a chat with Ken: I think I see how the pages are
delivered to the end user.

From the start page the wizard is called. The wizard sends me pages
to determine what package I want. When it gets that, it can call the
Product Module and get the productId. From there it will order the
pages to be sent to the user, and sends them in sequence until it has
all the validated data it needs.



#########################################################################
030414 Monday

Found the page that lists all packages. availablePackages.vps. JeffO
found a new freeware app, a tool that shares clipboards across
Rendezvous.

Worked out an alist over lunch:

;; wrapped in a progn for testing. as if you need to know that.
(progn
  (setq tail-file-list '(
                         ("access_log" . "/usr/local/apache/logs/access_log")
                         ("error_log"  . "/usr/local/apache/logs/error_log")
                         ("messages"   . "/var/messages")))
  (setq foo 3)
  (while (> foo 0) 
    (setq pair (car tail-file-list))
    (message "car: %s cdr: %s" (car pair) (cdr pair))
    (setq tail-file-list (cdr tail-file-list))
    (setq foo (1- foo)))
  )

This is the basis for replacing the nasty macro for opening/tailing
logs. It can be written in Lisp now, iterating over the alist,
creating shell buffers, naming them, inserting the tail -f command,
and balancing windows. As a cheat I could make the ordering of the
alist determine how the windows display.

I updated the page MeetingMinutes to link to all minutes, something I
neglected and, curiously, Chris wanted.

Had an update meeting with Gautam about the custom buying wizard. He
changed what my prototype work would be, but not by a lot.

What the sw-tail-logs function must do:
   take an alist, iterate over it
   create a buffer based on the key
   tail -f value for tailing the file
   call comint-send-input
   balance the windows
   create them in a specified order
   if called again, delete the buffers and make them all over again
   based on optional args, use different alists (example: at home,
      open httpd logs; at work, open evw logs.)
   from a given buffer, restart it (maybe; based on buffer name,
      you could find it in the alist and redo it)

optional: a sw-tail-f function:
   prompts for a log file; defaults to a list user can iterate over
   opens shell buffer, tails log

In the large: the alist is a list of keys that are strings, and
values that are Lisp symbols that define a number of things: ranking
(buffer order), filename, and keywords with their colors for
highlight-regexp.


---

So far, the chain goes:

you need a BaseModule
you need a ResourceManager which Wizard used to provide;
you need a SerlvetContext, maybe.


needs:
sessionkey
getIspDn()


Fuck. Closed my x session by accident. Bogus. I need an auto-save-desktop.



#########################################################################
030415 Tuesday

Back to the grindstone. Last night I accidentally closed my X session
and lost my places in all the files I was editing. Really sucky. I did
(setq desktop-enable t) so whenever I quit Emacs the desktop is
saved; the flipside to this is when I start it the desktop is loaded,
which may not be what I want. But it may be that I just need to
modify my behavior again.

Moved the notes on the proof-of-concept for our shopping cart to my
LOG.txt on devil. It just occured to me that I can share the log
across machines since it's in CVS. Hrmm.

WIZARD DESCRIPTION:

From the top: there are five wizards in the default frontend. Ah. I
see one of my mistakes: SignupWizard is really SignupWizardServlet,
though it's named SignupWizard in web.xml. doh.

SignupWizardServlet instatiates a new SignupWizard and returns it to
the caller. SignupWizardServlet is a very small file.

The servlet gets its wizard from the session object. It determines
what step is next. That's about all it does, for that matter. So the
page sequence is handled by the WizardServlet -- it doesn't care what
the deal is, it only applies the rules -- composes the next URL and
redirects.

The subclass SignupWizardServlet does nothing but instantiate a
SignupWizard and return it.

Basic use case:
1. User enters domain name, SignupWizardServlet is hit.

2. catalog and package pages, via selectProduct.jsp.

3. installingConfig.jsp, which is somehow related to the package and
   not the wizard.
4. customerInfo.jsp, and out.

All the display code is in installingConfig.jsp while most of the java
code is in installingConfigCode.jsp.

For each product, there is an installingConfig.jsp. The wizard gets
the list of needed pages and inserts them into the page order.

My original understanding was that we would insert pages into the
existing wizard; modify the order a bit, so to speak. Gautam made it
clear on Friday that we would not do this, that we would instead
write our own shopping cart based off their code. My initial reading
of the code was geared towards understanding how to do the former.

There are two kinds of pages the wizard serves up: "static" pages
(pages common to that package), and installingConfig pages, which,
depending on the package, there may be zero or more of.

Page order for static pages is determined in the wizard itself (e.g.,
SignupWizard and not SignupWizardServlet, or SignupWizard.conf.) In
fact they are added in the wizard's constructor.

Wizard: has methods to set/get/remove steps, add the product config
pages needed, get/set/remove attributes to the servlet (versus
product config stuff), plus other utilities.

SignupWizard: Adds the static pages, adds account pages and selected
account pages, 



#########################################################################
030416 Wednesday

Burned out yesterday, left at 7pm. Had a talk with Gautam before I
went. I outlined the architecture -- as it exists -- for the
SignupWizard. I think I illustrated that it was more complex than
previously thought. One thing you can see in the code are small fixes
to solve bugs, and it made me think of the Joel On Software diatribe
about how Mozilla shouldn't have thrown out the code base for
Communicator.

The possibilities so far: first, we were looking at changing some or
one of the pages. Ken suggested the catalog page. Two, we were
looking at posting the data in one fell swoop to the wizard. Three,
calling BaseModule from JSP and/or a servlet to create the new
client. Four, extending the Wizard class and WizardServlet classes,
and writing our own. Five, using the existing architecture to write a
shopping cart (this is only sightly different from the prior approach
of extending the wizard class; this means writing the pages just like
SystemsFusion would, where the prior approach is more custom.)

I think we are hung up somewhere around steps four and five.

Just wrote a small Perl script to convert the wizard output into an
HTML form. I couldn't get the wizard to skip the whois check though
(or so it seemed), so there must be some state information hidden in
there.

OK, so: static html approach will work, if I can get the whoIsDone
bit working right. I wound up having to click through all the forms
but the data was valid. So, here's one way to bypass the wizard. We
could do it all in static html forms.

Note to self: rm'ing a class file under the WEB-INF can be a bad
thing.


Update, 3pm.

Have made a clone of the SignupWizard called CartWizard. Had to work
through some configuration problems and I'm not sure if I need to
restart resin, evw, or both when I change a java file. Certainly I
needed to bounce the whole system when I changed the conf file.

#!/opt/gnu/bin/bash
# superbounce
# run as root
. /etc/profile
/etc/init.d/evolutionware stop
/etc/rc2.d/S80apache restart
/etc/init.d/evolutionware start

Ken says that if he had to write a shopping cart, he'd subclass the
wizard and write a set of jsp pages to post the productId. But we
kinda wanted to avoid the rest of the wizard, if
possible... hrmm... that is, we want to avoid the product config
pages if we can. (pc_). Hrmm2. 

via AIM:
me: have any of your customers asked for a shopping cart approach?
ken: actually, no, but im not really surprised
(chat #35)

Brooks, Chapter 9: ``Show me your flowchart and conceal your tables,
and I shall continue to be mystified. Show me your tables, and I won't
usually need your flowchart; it'll be obvious.''

Been reading the LDAP schema I got from Lysa. Very useful for this
moment. Products and Installed Products differ in that:
getAllProducts gets all available, while getInstalledProducts only
applies to an organization. Components are additional things added to
the package after it's been bought, like users or email accounts.


Example ldap search from the command line. The SF doc on the ldap
schema gives a pretty lucid explanation on how to do this:

[swain@evw-1 perl]$ ldapsearch -h evw-1.dev.ampira.com -p 400 -D "cn=Directory Manager" -w "11223344" -b "o=kirtland,ou=Clients,o=DMFC" "username=lundgren" evwdescription username evworgdn
username=lundgren,ou=People,o=kirtland,ou=Clients,o=DMFC
evwdescription=lundgren
username=lundgren
evworgdn=o=kirtland,ou=Clients,o=DMFC



#########################################################################
030417 Thursday

Found the product details. Last night I found the answers to my
nomenclature questions in, of all places, the LDAP schema description
from SystemsFusion, as well as a lucid explanation of ldap
queries. Very nice. Ken confirmed my interpretation of the naming
scheme and said the IPL is out of date, so the words "product" and
"package" are sometimes intermingled (primarily, the word "product"
is used in place of "package" but never the other way around).

Code:

Just append to the bottom of selectPackage.jsp:

<%

out.println("<HR>");

// connect to product module
ProductModule prodmodule = resources.getProductModule();
prodmodule.ping();

// get available packages
ProductData[] pdata = prodmodule.getAvailablePackages(sessionkey, assistant.getWizard().getIspDn());

out.println("number of things in the productdata array: " + pdata.length);

HashMap lookup_table = new HashMap();

// list all available packages
for (int x = 0; x < pdata.length; x++) {
   out.println("<p><i>package</i>: " + pdata[x].name + " " + pdata[x].id + " " +
   pdata[x].description + "</p>");
   //out.println("<li>any length: " + pdata[x].data.length + "<br>");

   // for each package, get the product components (array of ids returned)
   String[] prodcomps = prodmodule.getProductComponents(sessionkey, pdata[x].id);
   //out.println("prodcomps length: " + prodcomps.length  + "<BR>");

   // print out each product component (these are string IDs)

   Arrays.sort(prodcomps);

   Product prod = null;
   String key = "";

   for (int y = 0; y < prodcomps.length; y++) {
      out.println(y + ": <b>" + prodcomps[y] + "</b><BR>");
      prod = prodmodule.getProduct(sessionkey, prodcomps[y]);
      out.println("<li>Product name: " 
                  + prod.name + "<br><li>Description: " + prod.description + "<br>");
      key += prodcomps[y];
      
   }

   lookup_table.put(key, pdata[x].id);
   //   out.println("my new key: " + key + "<br>");
   //   out.println("maps to: " + pdata[x].id + "<br>");
   out.println("<hr>");
}

Iterator it = lookup_table.keySet().iterator();
while (it.hasNext()) {
    String key = (String) it.next();
    out.println("Key: " + key + " Value: " + lookup_table.get(key) + "<br>");
}

%>

Simple answer to saving desktop: add a hook function to
auto-save-hook.

Got around a bug in the Java Cookbook, where it tried to use the
values as keys. Java has a HashMap.values() but oddly not a .keys();
it's .keySet(). Who cares what it is? We use an Iterator either way.

/usr ran out of space
printing to stdout.log in resin works
print out the array of pages to work through in the wizard




#########################################################################
030421 Monday

Here are the entries from the LOG.txt on dvl; I've escaped them with >>
so as not to confuse them. Probably should merge them but oh well.

>> #########################################################################
>> 030408 Tuesday
>> 
>> History of doing a backup:
>> 
>>   512  /etc/init.d/evolutionware stop
>>   513  /usr/ucb/ps awwwx | grep java
>>   514  kill -9 20839 18173
>>   515  /usr/ucb/ps awwwx | grep java
>>   516  ps -ef | grep sbin
>>   517  /etc/init.d/exim stop
>>   518  /etc/init.d/named stop
>>   519  /etc/init.d/mysql.server stop
>>   520  tar -czvf /d1/backuptest.04.08.03.tgz /opt/evw/var /opt/bind/etc /usr/local/mailman /usr/local/mysql/data /var/evw-mail
>>   525  su - db2inst1
>>   537  mkdir /d1/ldap-backup
>>   538  chown nobody:nobody /d1/ldap-backup
>>   539  /opt/netscape/server4/slapd-Evolutionware/db2bak /d1/ldap-backup
>> 
>> 
>> 
>> 
>> #########################################################################
>> 030415 Tuesday
>> 
>> you need a BaseModule, which has registerNewClient()
>> you need a call to getIspDn() or some way to get the FCDE/DMFC/FCTY
>> you need a sessionkey, BaseModule.registerNewClient(sessionkey, user_data, getIspDn()))
>> you need a ResourceManager which Wizard.getResourceWizard() used to
>>    provide, and this is needed because ResourceManager gets the
>>    BaseModule; else, find another way to get the base module (there *is*
>>    another one, we hope.)
>> you need a SerlvetContext, maybe.
>> 
>> We need getAllProductConfig(), which returns a ProductConfig[]. This
>> is passed to the BaseModule. Relevant code:
>> 
>>    public ProductConfig[]
>>    getAllProductConfig()
>>    {
>>       ProductConfig[] productData = new ProductConfig[productConfig_.size()];
>>       Iterator it = productConfig_.values().iterator();
>>       int index = 0;
>>       while (it.hasNext())
>>          productData[index++] = (ProductConfig)it.next();
>>       return productData;
>>    }
>> 
>> A ProductConfig is just a data dummy class with four fields,
>> corresponding to the fields we see in the debug dump.
>> 
>> There are two places data seems to be put. One is the rwd, the other
>> via calls to setProductConfig(). This just sets a hashmap internal to
>> Wizard/SignupWizard.
>> 
>> ----
>> 
>>          // redirect to next step
>>          wizard.postHandleStep(stepId);
>>          Wizard.Step nextStep = wizard.getNextStep(stepId);

[end inserted LOG.txt]


Lines from web.xml:

      <!-- test servlet para esteban wainstead -->
      <servlet servlet-name='SoapTest' servlet-class='com.evolutionware.SoapTest'>
         <load-on-startup/>
      </servlet>
      <servlet-mapping url-pattern='/soap/test' servlet-name='SoapTest'/>

      <servlet servlet-name='CartWizard' servlet-class='com.evolutionware.wizard.CartWizardServlet'>
         <load-on-startup/>
      </servlet>
      <servlet-mapping url-pattern='/wizard/cart/cart' servlet-name='CartWizard'/>

      <!-- end added lines by sw -->

OK. Here's the deal. JSPs are automagically recompiled; servlets and
their helper classes are not, so I must always restart Resin to get
the changes to take effect. It's a start.

Mentioned to Gautam before the meeting started that I'm concerned with
my lack of progress so far, and I was reading the same in him. He
agreed, and said we'd talk later to see what he could do to help.

When I first came in, there was a problem with Resin on devil. The
symptom: Resin was trying to start every 13 seconds, and nothing
written to the error log. Cause: Friday we ran out of disk space on
/usr, and I had opened/edited resin.conf; the whole file was lost
(when my desktop opened it this morning it was zero bytes in size.) I
copied over the resin.conf from staging, and that solved the problem.

The question of the day is now, where does the wizard get its info on
what order and which pages to present? I need to review Ken's emails.

Wizard.addProdconfigPages(): uses session key, product id, and
installtargetdn to get an array of ProductConfigStep objects.

Interesting discovery: the first time the servlet is called,
i.e. wizard/cart/cart, is the only time it seems to get
called. Thereafter the jsp pages call themselves.

In CartWizard, we do this:
first, case 1 is the whois lookup.
If we aren't ready for that, we call for the catalog page ("16"
   possibly, "STEP_MIN" at any rate).
Then we load the product catalog pages, which we get from the Product
   Module, plus the next step, plus Customer Details, which is a
   looping jsp and we get from the Accounts Module.


doPost() it the servlet appears only to be called once at the start of
the process. Its purpose must be to create a wizard and put it in the
session object. Yes, from start to finish, the servlet is only called
the first time. So the jsps must call the wizard themselves.

I wonder why the wizard just isn't in a subclass of a servlet then?

include.jsp is similar to the intitial block of most Python files.
stepList.jsp looks like a debug dump thing of some kind; it has an
   HTML table and writes out the steps in the middle of it.
clientSideUtils.jsp is just javascript stuff like popup window
   functions.
htmlComponents.jsp:  // This file contains the utility functions used
   to draw HTML components.

Files that end in "Code.jsp" contain a mix of HTML for output and some
program logic; they do the work, at the bottom of the page, to connect
to the system and so on.

The difference between the BuyWizard and the CartWizard is mostly in
the choice of pages to display. So wizard logic mostly resides in the
pages.

Zlatin tells me he freed up 100MB under /usr.

Thus far, to plan out a shopping cart, we need to satisfy these
requirements:

We need a start page, obviously. The wizard defaults to the
"categories" page, where you select a different package.

Next, the pages for the particular package are displayed; these come
from the Product Manager. It looks like only installedConfig.jsp is
called. Every product (not package, product) has its own
installedConfig.jsp file:

[evw-1 frontend]$ pwd
/opt/evw/frontend
[evw-1 frontend]$ find . -name installedConfig.jsp
./Applications/ASP/installedConfig.jsp
./Applications/Citrix/installedConfig.jsp
./Applications/Dialup/installedConfig.jsp
./Applications/DomainLockedMailAlias/installedConfig.jsp
./Applications/DomainLockedMailboxes/installedConfig.jsp
./Applications/DomainRegistration/installedConfig.jsp
./Applications/Frontpage/installedConfig.jsp
./Applications/FtpAccount/installedConfig.jsp
[...]

Then customer info is gathered with customerInfo.jsp.

selectProduct.jsp and customerInfo.jsp are specific to the
wizard. installedProduct.jsp is specific to the product.

(Idea: on write file, update tokens that contain the filename and line
number. this could be used in debug output, and the log file will tell
you what file/line number produced the log entry).

I commented out the steps in the CartWizard constructor and the case
statement; I made the customer info page STEP_MIN; and that puts you
right into the page for customer info. The billing info fails because
it wants the productId (the package id, in actuality). Next test: pass
in a product ID.


#########################################################################
030422 Tuesday

LOG.txt is now universal on all machines thanks to the magic of CVS. I
write this entry from the devil environment.

Been fighting a problem with the wizard: access denied. Ken asked if I
had a valid sessionkey? Turns out, all this time, even though I use
the variable in the JSP pages, it was empty. Very weird. There are
other methods that return successfully that require it.

Bad day overall. Must work harder still.




#########################################################################
030423 Wednesday

My box locked up overnight.

Spent time answering Jeff's Java questions; loaned him two books.

Talked over with Jessy: why she couldn't modify the customerInfo.jsp
file; and the difficulty of modularizing the pages she's designed.

Checked out all visp code from cvs onto dvl, /opt/evw/cvs/evw, same as
staging.

Moving the code test for package/product/cost to staging proved to be
a red herring, since the selectProduct page is not displayed on
Ampira. I couldn't test it on hostv3 because it's broken;
interestingly, for the same reason I couldn't create a visp on devil.

Traded emails with Ken on why I couldn't create a visp. Also, I saw
the same wizard exception on staging for hostv3:

Exception:
com.evolutionware.wizard.WizardException: No account types available
	at com.evolutionware.wizard.NewVispWizard.addAccountPages(NewVispWizard.java:162)
	at com.evolutionware.wizard.NewVispWizard.postHandleStep(NewVispWizard.java:92)
	at com.evolutionware.wizard.WizardServlet.doPost(WizardServlet.java:140)
	at
        com.evolutionware.wizard.WizardServlet.doGet(WizardServlet.java:46)

In this case, I was trying to create a visp but there was no generic
account; visps cannot use a generic credit card account. The same
error turns up on staging; this means there are some pitfalls to the
accounts module that the UI does not reflect... that is, there should
be a specific error in this case saying "Hey, you don't have a generic
account I can use..." instead of the nonspecific error "No accounts
available."

Doh. Created testvisp on dvl to see if it works OK, and it did; but
Chris says now we'll have to create it on staging and prod too,
because the package sync requires it.

Did a dump, then a restore from 4/8. This eliminated the test visp,
and I refined the document for dump/restore. Sent email out.




#########################################################################
030425 Friday

List all clients:
ldapsearch -v -h evw-1.dev.ampira.com -p 400 -D "cn=Directory Manager" -w "11223344" -b "o=DMFC" "ou=Clients"|grep DMFC

Hackish but it works.

So: generated the reports for Swolf; they were wrong; redid them with
Lysa's advice, and wrote an ldapsearch query to show the visps. Sat in
on the ticket meeting. Some time lost to the birthday party, had to
play musical chairs (literally).

Found a Java client for opensrs on SourceForge.


#########################################################################
030428 Monday


Just updated Gautam on what I'm doing:
* Finished copying over the visps today from staging to dvl. No email
  from CVW (which has since came, and contains nothing interesting,
  unfortunately).
* Regenerating the FCTY report for Rob Walker starting from 8/2001
* Java on Staging is 1.3, guitester needs 1.4 or an ssl.jar file 
* Found Java client for opensrs
* Still picking at customerInfo.jsp, want to run though it again

I need to send him a list of the variables we mentioned in the cutting
meeting ("Show me your flowcharts...")

Whenever I have a spare moment I'd like to investigate improving
desktop-auto-save so that all shell buffers, their names and contents
and command histories are somehow saved.

Variables mentioned in the meeting; there might be some overlap as the
ideas were evolving as the discussion progressed:

id (this could be the product ID from evw, like 1.2.4.5.33221.7)
products
prices
details
mode
domain name
period (i.e. registration period)
tld
step=
copyright year
short name
  label
  value
long name
  label
  value
from=email
mode=upsell (this was a submode I believe, for the mail.jsp)

Besides these, the same variable list Jeff uses now to jump into the
signup wizard will be needed.




#########################################################################
030429 Tuesday

Got guitester to run its two basic tests just fine this morning; but I
had to run them solo, by hand. With ant I get:

     [exec] javac -classpath httpunit.jar BuyPackage.java
     [exec] An exception has occurred in the compiler (1.3.1). Please file a bug at the Java Developer Connection (http://java.sun.com/cgi-bin/bugreport.cgi).  Include your program and the following diagnostic in your report.  Thank you.
     [exec] com.sun.tools.javac.v8.code.Symbol$CompletionFailure: file org/xml/sax/SAXException.class not found
     [exec] 	at com.sun.tools.javac.v8.code.ClassReader.fillIn(ClassReader.java:997)
     [exec] 	at com.sun.tools.javac.v8.code.ClassReader.complete(ClassReader.java:952)
     [exec] 	at com.sun.tools.javac.v8.code.Symbol.complete(Symbol.java:366)
     [exec] 	at com.sun.tools.javac.v8.code.Type$ClassType.supertype(Type.java:812)
     [exec] 	at com.sun.tools.javac.v8.code.Symbol$ClassSymbol.isSubClass(Symbol.java:622)
     [exec] 	at com.sun.tools.javac.v8.comp.Check.isUnchecked(Check.java:541)
     [exec] 	at com.sun.tools.javac.v8.comp.Flow.markThrown(Flow.java:255)
[...]

and so on. I've seen this before... hrmm...

Waiting on Eric to do the packagetest.html page; I sent Jessy a
stripped down copy of customerInfo.jsp; and I just created cvs
archives for the servlet code and the jsp code for the shopping
cart. Come to think of it, I probably should have done this under the
main branch, but that can come later.

Just had a chat with Steve Wolf. Issue: Douglas  Anoman. Two spaces;
UI shows data from August of 2001, but in the package activity report,
data starts in 2002. I just double checked that the dates Python is
using are correct, and they are. So there is some system issue going
on.




#########################################################################
030430 Wednesday

Meetings today.

/tmp/EcommerceFTPMonthly.html: wizard error (cannot get product
config pages).

/tmp/EcommerceFTPYearly.html: ditto

for f in `ls /tmp/*.html`; do echo "<a href=file://$f>$f</a><br>";
done > /tmp/list.htm

For some reason DomainForwarding couldn't see the string CHOOSE A
DOMAIN NAME. It was the same in every test, but failed every time;
when I removed the check for the string, the test succeeded. Go
figure.

I ran them all, and I'm waiting on ShowBran right now.

Also I've been tracking down a problem where a few visp organizations
appear in output for package activity report. I generated a 12.5 MB
file from the sql query.

bash-2.05a# db2 "SELECT  packageActions.organisationDn,  packageActions.actionTime,  packageActions.evwPackageId,  LOWER(packageActions.packageAction),  packageActions.ispDn,  domainHistory.fqdn  FROM  packageActions LEFT OUTER JOIN domainHistory  ON domainHistory.installedProductId = packageActions.productId  WHERE  packageActions.actionTime BETWEEN 996642000.0 AND 1051678799.0  AND ispdn = 'o=fcty'  ORDER BY  packageActions.ispDn,  packageActions.organisationDn,  packageActions.actionTime " > sql.out

Remember:
makemakebuild.pl
inputmaker.pl <args>
ant compile
ant test



#########################################################################
030501 Thursday

Ran tests against Showbran on production, all failed because the test
credit card page shows. Sent email to Swolf about the issue with
visps showing in the package activity report for FCTY. Sent email
detailing why I'm still running testing.

I read through statements.vps to find out why our friend "Douglas
Anoman" shows activity from 8/2001 in the gui but not in the
packageActivityReport. In short, statements.vps gets its data from
the Account Manager, while the Python script calls the database
directly. But: the listing of transactions happens in CgiTree, which
is a binary. So I don't know yet why it finds them and the sql query
does not.

Date to Unix time:
perl -MDate::Parse -e 'print str2time("December 31, 2001")'


Instructions for using the current version of guitester:
# check out the guitester project
cvs co guitester

# rename the directory after the visp you're testing
mv guitester hostname-test
cd hostname-test

# write a config file, example is at the end of inputmaker.pl
vi config.in

# for every test, the last page received is written to
# /tmp/PackageName.html. Wipe them out before each run.
rm /tmp/*htm*      

# generate the input files for maketest.pl
# arg 1: your config file
# arg 2: the URL guitester needs to start from
inputmaker.pl config.in https://secure.hostvisp.com/packagetest.html

# generate the Makefile and build.xml files
makemakebuild.pl

# run ant to generate, compile and run Java class files
# you can also do "ant generate", "ant compile", etc to 
# do incremental steps
ant

# create an index page in /tmp so you can see the results, if needed
for f in `ls /tmp/*.html`; do echo "<a href=file://$f>$f</a><br>"; done > /tmp/index.htm

# open /tmp/index.html in your favorite browser
mozilla /tmp/index.htm

Met with GG, spent almost 40 min whiteboarding and discussing
architecture for the shopping cart.



#########################################################################
030502 Friday

Gave Gautam a summary of where I spent my time this week:

uglyboy: 20%
testing visps: 40%
meetings: 20%
generating reports: 5%
tracking problems with reports: 15%


Small downtime as ops backs up devil. This week Chris set up the visps
after a package sync; I did the visp creation stuff back on Monday.

Some notes on Jessy's design of the cart pages:

<!--- ------------------------------------------------------------------------------- 
    Begin Main Page Variable Defs 
 ------------------------------------------------------------------------------- --->
 
<!--#set var="page" value="home" -->
<!--#set var="leftnav" value="off" -->

		
<!--- ------------------------------------------------------------------------------- 
      End Main Page Variable Defs 
------------------------------------------------------------------------------- --->

This is at the start of index.shtml. Its intent is clear.

(Converting tabs to three spaces makes the files easier to read; she
uses a fine resolution monitor, so she's looking at like 200 or 300
columns at all times).

Things under common/ appear on all pages, or at least, are not
subject to conditionals.

The logic can be rewritten inline, right next to her SSI directives.

index.shtml is the sole container for all pages, it looks.

If/elsif/else can be done like this:

<% if (0 > 1) { %>
this is the 'then' statement
<% } else { %>
this is the 'else' statement
<% } %>

Ugly but functional. So right off, the conversion process could be a
set of regexps. I imagine the situation is the same for variables:
must be declared at the top of the main container.

Includes in index.shtml:

17 lines matching "include" in buffer: index.shtml
     19:<!--#include virtual="common/topnav.shtml" -->
     31:                        <!--#include virtual="common/leftnav.shtml" -->
     50:                  <!--- ****   This is where the main body Include is Inserted ****   --->               
     53:                                 <!--#include virtual="index_body.shtml" -->
     58:                                       <!--#include virtual="options_body.shtml" -->
     60:                                       <!--#include virtual="domains_body.shtml" -->
     65:                                 <!--#include virtual="hosting_body.shtml" -->
     68:                                 <!--#include virtual="email_body.shtml" -->
     71:                                 <!--#include virtual="onepager_body.shtml" -->   
     74:                                 <!--#include virtual="traffic_body.shtml" -->   
     77:                                 <!--#include virtual="cooltools_body.shtml" -->      
     80:                                 <!--#include virtual="subdomains_body.shtml" -->   
     83:                                 <!--#include virtual="support_body.shtml" -->         
     86:                                 <!--#include virtual="about_body.shtml" -->
     89:                                 <!--#include virtual="reseller.shtml" -->
     92:                                 <!--#include virtual="login_body.shtml" -->   
    150:         <!--#include virtual="common/footer.shtml" -->   


Compare to domains.shtml:

4 lines matching "include" in buffer: domains.shtml
     20:<!--#include virtual="common/topnav.shtml" -->
     32:                        <!--#include virtual="common/leftnav.shtml" -->
     58:                                 <!--#include virtual="domains_body.shtml" -->
    117:         <!--#include virtual="common/footer.shtml" -->   

There are several top level containers, judging by the files that
contain <html> tags. I am tempted, intially, to convert ssi to jsp
directives via perl...

Swolf asked about any great things that happened this week, and
Gautam replied on how many people hours guitester saved. What I find
remarkable, though, is how much time is saved on *repeating* the
test. A lot! Once the test is written, rerunning it takes only a few
minutes; previously everyone had to do it all over again and it was
a huge sink on Jessy's time.

I can include either jsp files or html files via <%@ include
file=""%>, which is a win. Perhaps if I put the files on devil, the
ssis won't work, and I can progressively fill them out by the
conversion.


http://evw-1.dvl.ampira.com/wizard/cart/uglyboy/index.jsp is the
starting point.




#########################################################################
030503 Saturday

In on Saturday for a while. GG didn't put in any docs on the autogen
stuff, but he did check in what he did so far.

I think the job of converting Jessy's stuff to JSP is going to take
longer than I thought.

Meanwhile I need to have a global servlet for lookups (key of
concatenated product IDs to values packageIDs), plus we will use
jsp:usebean tags of some sort to get the beans with product info and
path info, and I need to compile the path info as well, which might be
a better starting point.

According to my JSP book, there is no other way to do conditional page
component loading except for:

<% if (thispage == HOME) {%>
<h1>it's HOME!</h1>
<%@ include file="index_body.shtml"%>
<% } %>

Even the book admits this is clunky and error-prone, just as SSI is.




#########################################################################
030505 Monday

Finally:
http://java.sun.com/products/servlet/2.2/javadoc/index.html

Gautam said to me the problem of doing the if/else logic in the jsps
was "too low level," which put me on the track to the right answer. He
also turned me on to RequestDispatcher, which solves all the problems
of page flow in a simple way.

It's a start: got all the common SSI directives converted to JSP
equivlalents. Got some others changed too. Still not crystal clear on
the page flow re: the jsp files themselves. Jessy uses designer logic.

The next thing is to go through the headers of all the files, and
figure out what environment variables are expected. Today I found she
had a "process" variable, and there was a "conent" (sic) variable but
her answers didn't make sense about that one. She alternately said it
wasn't used and that it was needed. (?)

Grep of all vars she sets:

<!--#set var="domain" value="home" -->
<!--#set var="email" value="home" -->
<!--#set var="from" value="" -->
<!--#set var="hosting" value="home" -->
<!--#set var="leftnav" value="off" -->
<!--#set var="mode" value="upsell" -->
<!--#set var="onepager" value="home" -->
<!--#set var="page" value="about" -->
<!--#set var="page" value="cooltools" -->
<!--#set var="page" value="domains" -->
<!--#set var="page" value="email" -->
<!--#set var="page" value="home" -->
<!--#set var="page" value="hosting" -->
<!--#set var="page" value="onepager" -->
<!--#set var="page" value="support" -->
<!--#set var="process" value="about" -->
<!--#set var="process" value="cooltools" -->
<!--#set var="process" value="domains" -->
<!--#set var="process" value="email" --> 
<!--#set var="process" value="help" --> 
<!--#set var="process" value="hosting" --> 
<!--#set var="process" value="onepager" -->
<!--#set var="process" value="support" --> 
<!--#set var="step" value="1" -->
<!--#set var="step" value="2" -->
<!--#set var="tools" value="home" -->

Gautam showed me the xml file reader he's made, which is not yet
recursive. The list of things we need is huge at this point.

I need:
to compose query strings to call signup wizard
product ids mapped to package ids, narrowed to visp

$page is used to choose main.jsp

$mode applies only to four files:

[swain@evw-1 pages]$ grep '$mode' *.jsp
cooltools_body.jsp:      <!--#if expr="$mode = upsell" -->Would you like to add a web site building tool?
email_body.jsp:                                             <!--#if expr="$mode = upsell" -->Would you like to add email addresses?
email_body.jsp:                                 <!--#if expr="$mode = upsell" -->
hosting_body.jsp:                                             <!--#if expr="$mode = upsell" -->Would you like to add web hosting?
hosting_body.jsp:                                 <!--#if expr="$mode = upsell" -->
onepage_body.jsp:            <!--#if expr="$mode = upsell" -->Would you like to add a One Web Site?

[swain@evw-1 pages]$ grep -l '$mode' *.jsp
cooltools_body.jsp
email_body.jsp
hosting_body.jsp
onepage_body.jsp

and $mode only appears in main.jsp files.

Actually the short of it is, I only care what they are set to, as long
as they are set; I can build a logic table from the headers of her
examples, perhaps. It looks like there's only four examples though. I
don't know what "templatecut" is.

re: shopping cart Gautam found:
BasketBean == SelectionsBean
CustomerServlet == ShoppingCartServlet
InventoryBean == LookupServlet


#########################################################################
030506 Tuesday

Met with Jessy over a list of all the files she had in her folder. We
had a miscommunication. I asked her which files were "active" or "in
use" and she said all of them; but what I really wanted was "which of
these files pertain to me?" I don't think I wasted too much time on
files I don't need, but we did come to the realization that we will
wind up maintaining duplicate versions of some files because: the
domain path, which I'm interested in, shares files with the email
path, which will all be static. So we cannot have it both ways: the
email_body cannot be just ssi or just jsp.

Gap: there is no info in path.xml for the options page. There needs to
be some default state which causes the template to render the options
page.




#########################################################################
030507 Wednesday

sample link:
<a href='javascript:
document.productWizardForm.productId.value="1046812888.454405";
document.productWizardForm.submit();'>Max - FP - YR -
1046812888.454405  </a>

Last night I made the discovery that there are key collisions in the
lookup table. Packages consist of products, and there can be two or
more packages with the exact same combination of products that differ
in config details (25 mailboxes versus 50, which is a product config
detail).

Before I wipe it all out, here's the code used to explore the Product
Module interface:

<%

    // all this code added by swainstead, from here to end of file (less
    // closing tags for html)

    HttpSession mysession = request.getSession();
if (mysession == null) { out.println("<h3>session object null.</h3>"); }
out.println("session attributes:<br>");
for (Enumeration e = mysession.getAttributeNames(); e.hasMoreElements(); ) {
    out.println(e.nextElement() + "<br>");
}


//sessionkey = (String)mysession.getAttribute("id");

//sessionkey = "aaaaDAq3__iOWx"; //assistant.getWizard().getSessionkey();



        out.println("<HR>");

        // connect to product module
        ProductModule prodmodule = resources.getProductModule();
        prodmodule.ping();

        String ispDn = assistant.getWizard().getIspDn();
        String orgDn = "o=HostV3,ou=Clients,o=FCDE";

        out.println("<h3>doing ispDn: " + ispDn + " sessionkey: " + sessionkey + "</h3>");

        // get available packages
        //ProductData[] pdata = prodmodule.getAvailablePackages(sessionkey, assistant.getWizard().getIspDn());

        // limit to hostv3; returns a lot of data though, more than one would think.
	ProductData[] pdata = prodmodule.getAvailablePackages(sessionkey, "o=HostV3,ou=Clients,o=FCDE");
//ProductDetails[] pdata = prodmodule.getVispPackages(sessionkey, "o=HostV3,ou=Clients,o=FCDE");


        out.println("number of things in the productdata array: " + pdata.length);
        int counter = 0;
        HashMap lookup_table = new HashMap();

        // list all available packages
        for (int x = 0; x < pdata.length; x++) {

            if (pdata[x].name.startsWith("V3")) {
                continue;
            } else {
                counter++;
            }

            //            out.println("<hr><p><i>package name</i>: " + pdata[x].name + "," + pdata[x].id + "," +
            //            pdata[x].description);


            String duration = "";

            CostProfile cp = prodmodule.getActiveCostProfile("FCDE_cDCfIBJeUCOTTcI", orgDn, pdata[x].id);
//            out.println("<P>cp: " + cp.description + ", "+ cp.id + ", " + cp.name + " array length: " + cp.components.length);

            java.lang.System.out.println(cp.description);

            if (cp.description.toLowerCase().indexOf("year") != -1) {
                //              out.println("<br> this is yearly");
                duration = "yearly";
            } else if (cp.description.toLowerCase().indexOf("month") != -1) {
                //                out.println("<br> this is monthly");
                duration = "monthly";
            } else {
                //                out.println("<H1> no match --------------- </h1>");
                duration = "error";
            }
            

/*
            for (int xx = 0; xx < cp.components.length; xx++) {
                BillingType bt = cp.components[xx].billingType;
                EntryType et = cp.components[xx].entryType;
                out.println("<br>billing type int: " + bt.value());
                out.println("<br>entry type int: " + et.value());
            }
*/
            // it's always zero length, forget it
            //out.println("<li>any length: " + pdata[x].data.length + "<br>");
            /*
            // for each package, get the product components (array of ids returned)
	    Product p = prodmodule.getProduct(sessionkey, pdata[x].id);
            ProductComponent [] prodcomps = p.components;
            //out.println("<br>prodcomps length: " + prodcomps.length  + "<BR>");

            // array to build up a hash key
            String[] keyparts = new String[prodcomps.length];
           
	    for (int c = 0; c < prodcomps.length; c++) {
		Product component = prodmodule.getProduct(sessionkey, p.components[c].productId);
                /*
                if (component.name == null || component.name.equals("Workflow Product")) {
                  continue;
                }
                */
            /*
                out.println("<br>component name: "+component.name + 
                    "," + component.description +
                    "," + p.components[c].id + "activeCostProfile: " + component.activeCostProfile);


                keyparts[c] = p.components[c].id;
*/


// out.println("<pre>\n" +
// "&lt;!-- " + pdata[x].id + " --&gt;\n" +
// "&lt;!-- " + pdata[x].name + " --&gt;\n" +
// " &lt;evwProduct id=\"" + p.components[c].id + "\"&gt;\n" +
// "    &lt;name&gt;" + component.name + "&lt;/name&gt;\n" +
// "    &lt;shortname&gt;" + component.name + "&lt;/shortname&gt;\n" +
// "    &lt;description&gt;" + component.description + "&lt;/description&gt;\n" +
// "    &lt;price&gt;&lt;/price&gt;\n" +
// "    &lt;period&gt; \n" +
// "      &lt;duration&gt;" + duration + "&lt;/duration&gt;\n" +
// "      &lt;count&gt;" + p.components[c].quantity + "&lt;/count&gt;\n" +
// "      &lt;/period&gt;\n" +
// "  &lt;/evwProduct&gt;\n" +
// "</pre>");
                

	    }
            

            // print out each product component (these are string IDs)

//            Arrays.sort(keyparts);

            //java.lang.System.out.println("swain: sessionkey out: " + sessionkey);

			    //"<br> quantity: " +p.components[c].quantity +
			    //"<br> costprofileid: " + p.components[c].costProfileId +
			    //"<br> productId: " + p.components[c].productId +


	   /*
            Product prod = null;
            String key = "";

            for (int y = 0; y < prodcomps.length; y++) {
                //out.println(y + ": <b>" + prodcomps[y] + "</b><BR>");
                prod = prodmodule.getProduct(sessionkey, prodcomps[y].id);
                out.println("<li>Product name: " 
                            + prod.name 
                            + "," 
                            + prod.id 
                            + "," 
                            + prod.description 
                            + "<br>");
                key += prod.id;

                //String[] pc = prodmodule.getProductComponents(sessionkey, prod.id);
                out.println("<h1>size of the components array: " + prod.components.length + "</h1>");
                //String[] subproductcomps = prodmodule.getProductComponents(sessionkey, prod.id);




		}
           */
/*
            // construct a key from the keyparts array
            String key = "";
            for (int y = 0; y < keyparts.length; y++) {
                key = key + keyparts[y];
            }
            
            if ( lookup_table.containsKey(key) ) {
                out.println("<h2>Oops. This key is already there: " + key + "</h2>");
                out.println("package id: " + lookup_table.get(key) + "<br>");
	    }
            lookup_table.put(key, pdata[x].id);
*/          
            //   out.println("my new key: " + key + "<br>");
            //   out.println("maps to: " + pdata[x].id + "<br>");

            /*
            // putting the key in didn't work.
            // for each package, get the costprofiless
//            CostProfileInfo[] cpinfo = prodmodule.getPackageCostProfiles(,"FCDE_KgeMLQJBSZIZBMO", 
//                                                                         "o=HostV3,ou=Clients,o=FCDE"
                                                                         );
            
//              for (int y = 0; y < cpinfo.length; y++) {
//              out.println(y + ": " + cpinfo[y].name + " " +  cpinfo[y].id + " " + cpinfo[y].description);
//              }

              out.println("<hr>");

            */


        } // end loop

/*
Iterator it = lookup_table.keySet().iterator();
while (it.hasNext()) {
    String key = (String) it.next();
    out.println("Key: " + key + " Value: " + lookup_table.get(key) + "<br>");
}


out.println("<h2>counter: " + counter);
out.println("<br>Size of lookup_table: " + lookup_table.size() + "</h2>");

*/
%>
</body>
</html>




#########################################################################
030508 Thursday

Going over the jump URL today; that is, what POST data has to be sent
to the signup wizard. There are some small variations
unfortunately. I'll talk to CVW about them; they might be legacy
things the wizard doesn't really need.

There are two gotchas now for the jump: ecommerce and forwarding
packages will take them to a screen for Miva or forwarding URL, and if
the package has ASP or MySQL those pages will probably show as
well. They will need to be reskinned too.

I can generate a packagetest.html file instead of having one of the
builders do it. That will be GG's call.

Yesterday was so stressful and intense that I barely had time to make
any log entries. Most important was finding that we didn't need
product prices; we only needed to have package prices. Every path
through the system leads to a package ID, and nothing else really
matters. The shopping cart totals are just frosting.




#########################################################################
030509 Friday

Again, another busy busy day yesterday. I think we have all the path
stuff resolved. Jessy's spreadsheet had extra columns -- in fact she
"normalized" it -- and we just needed to collapse them into one column
to solve the problem of converting the spreadsheet into path.xml,
which Gautam is working on now.

Meanwhile, I need to do several things. I just completed all the
Javascript for both Jessy and me; they differ slightly in that she
passes along package IDs and I pass along the page choice of the
user. I checked out a new copy of the repository and I'm going to
add/test the stuff now.


#########################################################################
030512 Monday

In early. Working on a test to make sure all product IDs will work
with the whois bypass mechanism from SF.

Figured out why the Poke class didn't work on staging: hardcoded
ispDn. Searched the interface for a Java call to solve this, couldn't
find one. I've seen them do string operations in Python to solve this
problem.

Rob says there are workflow products in the packages with Cute stuff
that are causing the funny pages to show; he fixed this on Devil only.

Files for Jessy to edit:

./Applications/DomainRegistration/installingConfig.jsp
./wizard/signup/customerInfo.jsp
./wizard/signup/genericCreditCardAccountConfig.jsp
./wizard/signup/finishExtWizard.jsp

Done today:

Composed the URL the servlet needs to post to EVW.
Generated a file to test all packages against the URL; whittled out
the things not needed; found bugs in packages.
Meeting; took minutes; ate at desk again.
packagetest.html generated for staging; fixed bug in Poke.java that
didn't let me get CORBA.system on staging (needed right ispdn).
Found pages for jessy to edit; stripped code for her, helping her
test/chmod/etc.
Resolved the interface for jsps to the servlet (all data comes as GET
data now).
Retested jsps, found bugs, fixed, checked in; tested javascript
against printenv.cgi for correctness.
Fixed bug where no pagename into outertemplate.jsp caused null pointer
exception.
Helped Cferry with guitester issues.


#########################################################################
030514 Wednesday

alias cpwar='cp
~/public_html/projects/ampiradev/cartwizard/cartwizard.war
/usr/local/resin/webapps/'

Geez, no log entries yesterday. I helped Jessy with the jsp files,
finding and chmoding them where needed; Gautam turned the shopping
cart over to me, and I got it working with the JSPs. Then I had to
work on paths.xml and there were some severe shortcomings in it that
had to be fixed by hand, primarily with email paths, but others had
pieces missing and one typo. I haven't been able to generate a
ChangeLog yet, cvs2cl.pl doesn't like the date format for some
reason...

We entered alpha testing late yesterday; there are bugs in Bugzilla
already assigned to me.

                                   


#########################################################################
030515 Thursday

Late last night, found that we could buy only 1 year domain periods,
after Ken and I played with the inputs to the signup wizard. On
staging it works fine for all three periods. Retested this briefly
when I came in.

Was dealing with several small tasks at once for a while until I could
finally hash out the rest of the domainonly path; did that, all
committed, working so far.

Zlatin and I cleared out a lot of hung jobs on devil. Seconday DNS is
handled on cws-1.dvl and it was stopped. We used jobRestart.py,
adminCommand.py, and jobList.py to do this. I need to monitor these
two boxes more closely.

I also did the work of setting up cartwizard on staging, and have been
handling rollouts. We are using a chat room to communicate
stuff. Bugzilla for bug tracking.




#########################################################################
030516 Friday

Whew. Bug fixing galore today; but they are all closed out now, and I
think we are ready to launch.

dig it: Note: You can also define error pages for the WAR that
contains a JSP page. If error pages are defined for both the WAR and a
JSP page, the JSP page's error page takes precedence.
  
http://java.sun.com/j2ee/tutorial/1_3-fcs/doc/JSPIntro4.html 


#########################################################################
030519 Monday

I can look at the sizes of the body files to guestimate the needed
buffer size.

Here is my current local .emacs file, where I crafted a few
quick-and-dirty lisp functions:

;; local stops only
(when window-system
  ;; make pretty
  (setq default-frame-alist '((background-color . "#000a0a")
                              (foreground-color . "goldenrod")
                              (cursor-color     . "green"))))

(setq sw-tail-file-alist '(
                          ("resin error log" . "/usr/local/resin/log/error.log")
                          ("resin stdout log"  . "/usr/local/resin/log/stdout.log")
                          ("Product Module log"  . "/opt/evw/logs/ProductModule.log")
                          ))


;; express stops for all installs
(load-file "~swain/.elisp/.emacs")

;; more local stuff
(defun sw-servlet ()
  "Jump to the servlet directory."
  (interactive)
  (goto-char (point-max))
  (insert "cd /opt/evw/frontend-hostv3/WEB-INF/classes/com/ampira/cartwizard/servlets")
  (comint-send-input))

(defun sw-jsp ()
  "Jump to the jsp directory."
  (interactive)
  (goto-char (point-max))
  (insert "cd /home/swain/public_html/projects/ampiradev/cartwizard/pages/cartwizard")
  (comint-send-input))

(defun sw-projects ()
  "Jump to the project directory."
  (interactive)
  (switch-to-buffer (get-buffer "cli"))
  (goto-char (point-max))
  (insert "cd /home/swain/public_html/projects/ampiradev/cartwizard/")
  (comint-send-input))

(defun sw-deploy ()
  "copy war file from my cvs copy to live site"
  (interactive)
  (shell-command "cp ~/public_html/projects/ampiradev/cartwizard/cartwizard.war /usr/local/resin/webapps/")
  (message "war file deployed to testing.")
)

(global-set-key [(control f5)] 'sw-deploy)


;; set the default command for M-x compile
(setq compile-command
      "cd /home/swain/public_html/projects/ampiradev/cartwizard/; ant -emacs -f build.xml build-war")

;; always scroll the buffer as compilation proceeds...
(setq compilation-scroll-output t)

(defun rollout ()
  "cvs checkout and all that"
  (interactive)
  (sw-projects)
  (insert "cvs update -d")
  (comint-send-input))




#########################################################################
030520 Tuesday

Spent time late last night working on this Python/ldap thing. Sadly,
the docs on the Sourceforge project appear to have little bearing on
the module we use (no listing for the search_s method, for example;
but the sample code from the site worked, for the most part, save for
the exception handling. We are saddled with Python 1.5 while the rest
of the world has moved to 2.x.

The crux is the result objection appears to be a four dimensional
array (!). I will give this approach a little more time before I use
just shell commands and Perl to get the results.

Rob found a bug in the email path. I found a different bug hunting for
the solution, outlined in my CVS entry:

"email path was incorrect if the user selected yes to email, no to hosting,
yes to forwarding. The problem is: there are five choices for email, but they
all pass control to the same addHosting page. If the user said no to hosting,
they go to the addForwarding page; but the addForwarding page has no way 
of knowing which of the five email packages were chosen.

"This leads again to the combinatorial explosion problem in paths.xml. The
solution was to make four more copies of the addHosting subtree and slightly
modify each one to preserve the email choice."

I found that the bug existed on staging too, but not on devil. I
copied the landing page up to staging and the bug went away; but the
versions in CVS don't differ by much. What probably happened was Jessy
copied the wrong installingConfig.jsp into the folder.


Listing visps: 

bash-2.05a$ ldapsearch -h db2-1.prv.ampira.com -p 400 -D "cn=Directory Manager" -w "11223344" -b "o=FCTY" "o\
u=Clients" |grep FCTY
ou=Clients,o=FCTY
ou=Clients,o=FC Gold,ou=Clients,o=FCTY
ou=Clients,o=GlobalScape,ou=Clients,o=FCTY
ou=Clients,o=HostV3,ou=Clients,o=FCTY
ou=Clients,o=v3 hosting,ou=Clients,o=FCTY
ou=Clients,o=VisiHost,ou=Clients,o=FCTY
ou=Clients,o=HostBran,ou=Clients,o=FCTY
ou=Clients,o=4Templates,ou=Clients,o=FCTY
ou=Clients,o=DemoHost,ou=Clients,o=FCTY
ou=Clients,o=HostDemo,ou=Clients,o=FCTY
ou=Clients,o=HostEfaab,ou=Clients,o=FCTY
ou=Clients,o=HostLive365,ou=Clients,o=FCTY




#########################################################################
030521 Wednesday

Finished the report generation, and am using a little bit of the
morning to organize/houseclean. I recompiled my master todo list, did
some cleanup on the report generation stuff (there is now a file
called genall.sh that is comprehensive, if redundant), and I'm
updating my xls todo sheet now.

xls updated. Time to check in this log too. I should document how I
did the files for JeffO:

He needed a list of things per user in the EVW system:

username
firstname lastname
email
password
domain
organization

I had to generate two files, because I couldn't see how to get all the
data in one ldap query. I also wrote it in Python; I spent time Monday
night at home playing on devil to make it work (just to get the basics
working). 

baseDn = "ou=Clients,o=FCDE"
seachScope = ldap.SCOPE_SUBTREE
retrieveAttributes = None
searchFilter = "username=*"

print "username\tfirstname\tlastname\tpassword\temail\torgDn"
try:
   ldap_result_id = ldapObj.search(baseDn,seachScope, searchFilter,retrieveAttributes)
   result_set = []
   while 1:
      result_type, result_data = ldapObj.result(ldap_result_id, 0)
      if (result_data == []):
         break
      else:
         if result_type == ldap.RES_SEARCH_ENTRY:
            result_set.append(result_data)

# ldapsearch -h db2-1.prv.ampira.com -p 400 -D "cn=Directory Manager" -w "11223344" -b "ou=Clients,o=FCTY" "username=*" username cn sn userpassword evwemailaddress| wc -l

   print len(result_set)
   for item in result_set:
      print "%s\t%s\t%s\t%s\t%s\t%s" % (item[0][1]["username"][0], item[0][1]["cn"][0], item[0][1]["sn"][0], item[0][1]["userpassword"][0], item[0][1]["evwemailaddress"][0], item[0][1]["evworgdn"][0])
      
except: #ldap.LDAPError, e:
   print "some problem with ldap"

The boilerplate above this code chunk does all the work of loading
objects, connecting to the system, etc. One trip-up was that Conf.py
lives in the same directory as the script, and it took me a little
while to realize why the script couldn't find it (I thought there was
a path difference between systems). The while loop was taken from a
demo page I found on the python ldap site on Sourceforge.

One of the weird things is the array of result objects, which are at
least four dimensional. It must have to do with tree representation.

I wrote the query using ldapsearch first, then used Python to format
the output into a csv.

Just moved several things into my private CVS project. ~/pgms now
symlinks to ~swain/cvs/pgms.

Fixed cvs2cl.pl; turns out there was a line break in the regexp for
parsing dates! Once removed, the thing worked. Generated a ChangeLog
for uglyboy and checked it in.


#########################################################################
030523 Friday

Off sick yesterday; don't feel much better today. JeffO accused me of
having a hangover. I wish.

Gautam sent an email yesterday stating there would be no rollout due
to a path problem. I found that I couldn't buy any packages on devil,
guessed that Sunil rolled back from older backups, and Ken helped me
pinpoint where in the admin interface I had to add a credit card
account (Chris had always done this in the past), and then I had to
create a tax realm. The strange thing is when I created the CC account
there were two identical nodes that reflected the same changes. I
should make a note to ask Van Wie about that later.

Anyway, the brief rundown: Log in as admin; search for the visp; go
into Billing Adminsitration and create the generic credit card account
based on info off Staging. Then go into Tax Administration and do the
same.

This was not the problem Gautam had found, however; he stated in his
email the domains only path, but this morning Jessica showed me the
bug and it's in the email path. I rolled back my error handling code,
no effect; I spent time with M-x occur and found that it was the NOOP
feature GG put in for me. It set the package ID to null. I wrote the
IDs back into paths.xml (which was now possible, since I wound up
duplicating the whole addHosting block five times) and that fixed it.

My error checking code is in; have to figure out again how to get the
stack trace into the JSP. Heller showed me once. I didn't write it
down. :-( But it has something to do with passing a new Writer
(JspWriter?) to the Exception object, initializing it with something
else.

<% 


if (exception != null) {
    // "exception" is predefined in jsp pages
    java.lang.System.out.println("Exception received from the jsp templates:");
    out.println("Exception received from the jsp templates:");
    exception.printStackTrace(java.lang.System.out); // send to resin's stdout log
    exception.printStackTrace(new PrintWriter(out)); // send to client as html comment
} else {
    // in the servlet's catch clause, place the exception in an attribute
    java.lang.System.out.println("Exception received from the cart wizard:");
    out.println("Exception received from the cart wizard:");
    Exception e = (Exception)session.getAttribute("javax.servlet.jsp.JspException");
    e.printStackTrace(java.lang.System.out);
    e.printStackTrace(new PrintWriter(out));
}

%>

I can't believe it's 4:30 already.

http://hostv3.dvl.ampira.com/wizard/signup/signup?EvwIspDn=o%3DHostV3%2Cou%3DClients%2Co%3DFCDE

According to Ken all I need to do is call the wizard with the right
EvwIspDn and I get the right packages:

"You must post EvwIspDn to the wizard with the DN of the VISP (URL
encoded, of course).  Then, you will get the list of packages for that
visp.

"FYI, the wizard also filters out all packages marked inactive and all
packages that do not have active cost profiles.  You can remove these is
statements if you want to show these packages."

I made a diagram and some notes. I am waiting very patiently for an
LDAP book I ordered off Amazon as well; it's depressing how little
good info there is on LDAP.




#########################################################################
030527 Tuesday

Reviewed all open bugs this morning for UglyBoy. GG told me to assume
project leadership since Jeffo leaves in two weeks and he'll have to
take over the Unified Login project.

I was working on LDAP queries on Friday when GG and snair dragged me
away to a bar. I was making some interesting discoveries in terms of
how queries work and what's in LDAP for EVW.

We met at 130pm (tech staff). I did the full rollout of UB today; it
tests out ok so far. Before lunch I was working on a sql query to
guess how old the accounts are in EVW, based on invoice dates.

I also helped Zlatin get GuiTester working; there was some queerness
caused by the input file, and after we got around that he had no
problem completing the whole thing on his own. Twelve packages bought
very quickly, and he's pushing them through now (this is on
staging). It was gratifying to hear him say how much better this is
than the tedious task of entering all the info by hand over and over.

Spent a few minutes with my new copy of "Python In A Nutshell" and
rediscovered what darky taught me some months ago: use sys.exc_info()
to see what kind of Exception subclass was returned.

#!/usr/local/bin/python

import sys
from traceback import print_exc

try:
    print "now entering hell:"
    1/0
except Exception, e:
    print "yay, exception!"
    print sys.exc_info()
    print_exc()
    print e


This was tested on devil, Python version 1.5. It returns:

[evw-1 py]$ ./test.py
now entering hell:
yay, exception!
(<class exceptions.ZeroDivisionError at b6c60>, <exceptions.ZeroDivisionError instance at df330>, <traceback object at caff0>)
Traceback (innermost last):
  File "./test.py", line 8, in ?
    1/0
ZeroDivisionError: integer division or modulo
integer division or modulo


Most useful.


#########################################################################
030528 Wednesday

This query returns only organisation email addresses for a visp:

ldapsearch -h evw-1.dev.ampira.com -p 400 -D "cn=Directory Manager" -w
"11223344" -b "ou=Clients,o=HostLive365,ou=Clients,o=DMFC" -s one
"(evwemailaddress=*)" evwemailaddress

What makes it work is the base string and searching only one level
down. -s one, and -b of the clients of the visp. With a list of visps,
I can render a list of just paying clients outta ldap. There must be a
way to do this in one query though.

New version:

ldapsearch -h evw-1.dev.ampira.com -p 400 -D "cn=Directory Manager" -w
"11223344" -b "ou=Clients,o=DMFC" "(evworgtype=ORG)"

This version uses just the filter; the attribute evworgtype=ORG marks
the paying clients, maybe. There is no firstname/lastname though, so
the desire to link the email to the user's real name remains. The same
is true for the previous query.

Proof:

[swain@evw-1 swain]$ ldapsearch -h evw-1.dev.ampira.com -p 400  -D "cn=Directory Manager" -w "11223344" -b "ou=Cl\
ients,o=HostLive365,ou=Clients,o=DMFC"   "(evworgtype=ORG)" evwemailaddress|wc -l
     44
[swain@evw-1 swain]$ ldapsearch -h evw-1.dev.ampira.com -p 400  -D "cn=Directory Manager" -w "11223344" -b "ou=Cl\
ients,o=HostLive365,ou=Clients,o=DMFC"  -s one "(evwemailaddress=*)" evwemailaddress|wc -l
     44


Operations undertaken to solve disk space problems on devil:
  504  cat /dev/null > ./local/mailman/logs/mailman
  513  cat /dev/null >  ./local/apache/logs/access_log
  515  cat /dev/null >  ./local/apache/logs/error_log
  527  cat /dev/null >  ./local/mailman/logs/error

This brought us down to 93%.

Weirdly:

3 lines matching "test@test037.com" in buffer delme.
    633:o=OneEmailtoPersonalFTPMonthly,ou=Clients,o=HostV3,ou=Clients,o=DMFC 'test@test037.com'
   1952:[('username=oneemailtopersonalftpmonthly,ou=People,o=OneEmailtoPersonalFTPMonthly,ou=Clients,o=HostV3,ou=\
Clients,o=DMFC', {'evwemailaddress': ['test@test037.com'], 'sn': ['test'], 'cn': ['test']})]
   1953:test@test037.com test test


The dn is different. Hrmm. Email address as key solved it.


#########################################################################
030529 Thursday

Finished up work on orgs.py, to which I applied all my new ldap
knowledge. I was able to match org email addresses to the owner's
name, data are in separate nodes.

I did another rollout/test/release for UglyBoy; we also had a version
1.1 meeting today.

There are a number of loose ends. I was doing work this week to figure
out the creation date of an org for Jeff; this was to limit the data
set he has to import to Support Wizard. It turns out about the best I
could do is a join on three tables to get the first invoice
date. There are a smattering of dates in the system pertaining to the
user but no "account creation date" per se.

Made minor changes to inputmaker.pl and checked that in; I strip
non-alphanumerics from file names now (which are dynamically created).

New TAGS file via:

find /opt/evw/java/com /opt/evw/frontend-hostv3 -name \*.java -print |etags -

New javadocs via:

javadoc -J-Xmx512m  `find /opt/evw/java/com
/opt/evw/frontend-hostv3/WEB-INF -name \*.java -print| egrep -v
"Helper|Holder|NotFound|Invalid|/work/"`

By filtering out the helper, notfound, etc. classes I cut the number
from 2300 to 920.



#########################################################################
030530 Friday

In by 9:30, a little later than usual. Javadocs fully generated under
/opt/evw/frontend-evw/javadocs. Reviewing all open tickets with SF.

I modified posttests.html to allow me to enter three visps on devil
the proper way (passing in the correct evwispdn). None have account
types, so I added one to 4Templates. Indeed, only domain periods of
one year are available.

Did the same for FC Gold on devil.

ispman: no billing. No packages. No dice.




#########################################################################
030602 Monday

New improved TAGS builder:

find /opt/evw/java/com /opt/evw/frontend/WEB-INF -name \*.java -print|
egrep -v "Helper|Holder|NotFound|Invalid|/work/" | etags -

This is the same filtration that I used to generate the javadocs for
all EVW classes; a lot of the CORBA stub files are filtered out.

The behavior for UglyBoy in cases where the user wants to transfer the
domain name to us: the whoislookup tells them it's taken. We normally
skip this portion. Hrmm. How does the system handle transfers?

Tested out the little sample app I wrote that uses JNDI. It worked on
the app server. I need to find out how the interface will work with SW
though; I'm not clear on some details.

The Plan: User logs into EVW. When they go to Support Wizard, they hit
a servlet (SupportWizardServlet). This first queries LDAP, gets their
info, sends the packet to SW, gets the response, and then sends user
login info to SW and directs the result to the user. This will involve
getting the session key and all that jive from EVW.

Another issue will be creating a SW account when the user signs up for
the first time. Hmm. Well, if we do on the fly account creation, we
have one choke point.

Fetch user: 
ldapsearch -h evw-1.dvl.ampira.com -p 400 -D "cn=Directory Manager" -w
11223344 -b "o=FCDE" "(username=swainfoofoo)" evwcleartextpassword



#########################################################################
030603 Tuesday

Removed from web.xml of evw-frontend/WEB-INF/web.xml:

      <!-- test servlet para esteban wainstead -->
      <servlet servlet-name='SoapTest' servlet-class='com.evolutionware.SoapTest'>
         <load-on-startup/>
      </servlet>
      <servlet-mapping url-pattern='/soap/test' servlet-name='SoapTest'/>
      <!-- end test servlet config -->

Helped Jessy put in a new link in the control panel (so-called) for
all visps. This involved editing CoreUtils.py again.

Got my servlet config working correctly.




#########################################################################
030604 Wednesday

Burning up. We'll see if I make the day. I feel nauseous.

Rolled out another Uglyboy and covered stats again with Jeffo.




#########################################################################
030606 Friday

Man, sick to my stomach. Probably mucus. Also still having these weird
hot flashes. All I did when I got home Wednesday was sleep through to
Thursday. I just didn't want to miss another day of work, or Jeff's
last day. I'm feeling dizzy right now.

I think I just need to populate a bean, serialize it with the soap
library, and send that to a URL.

10.1.1.219 is the box where SW dev happens.


#########################################################################
030609 Monday

The file I'm editing is User.pm in /opt/isc/ampira/lib/FC/SOAP/SW. The
issues with the little Applescript tester I was working on: the word
"email" is automatically uppercased, while the word "password" is
automatically lowercased. These must be keywords in Applescript.

From where I'm sitting, it looks like what we need to do is get the
SOAP call correct; at that point it's a matter of fleshing out the
rest of the servlet, and testing it. Then we change links in EVW to
use the redirector. We can use a test visp for this purpose, or link
from devil.

Next, I need that update from JeffO on what progress he made matching
existing users in SW. Unfortunately, it hasn't come.




#########################################################################
030610 Tuesday

Tasks remaining for Unified Login:

al Map LDAP stuff into SOAP 1
al Auto login via POST 1
al Correct the SOAP code 1
al Only accept logins from EVW 1
sy Synchronize user data 3
te testing 2
al Finding parts, functionality in SW 2
ro rollout plan 1
al learn/code how to delete users from SW 2

prepend visp name
Login new users versus existing users

40: Estimate written out and sent to dev list.
120: Munge Ldap data into a HashMap so it can be put into the SOAP
packet. This involved a lot of string manipulation. It needs to be put
into the servlet now (I wrote it in a testbed).
30: integrate code into servlet. LDAP queries differ slightly,
will have to rectify.
30: lunch
50: fix/test autologin via servlet, works for user billc; first time
ldap data used for the whole process.

Since lunch, did work cleaning up the code. I researched getting the
domain name for a given user, and this can be done with the evworgdn
which we get from the first ldap query we run. Then, we do:

ldapsearch -h evw-1.dev.ampira.com -p 400 -D "cn=Directory Manager" -w
11223344 -b "o=live3651,ou=Clients,o=HostLive365,ou=Clients,o=DMFC"
"(objectclass=evwZone)" evwzone

The MIB node contains the domain name. The question is, does this work
for users of an account? Probably. I'm psyched.

I have the testbed querying for the evwzone, and listing the
results. For some accounts there are multiple entries (like admin for
some of the visps) and a few have none. Since this is staging I would
hope it's just test data.




#########################################################################
030611 Wednesday

1:20: Spent time when I came in, at 9:22, looking at Eric's problem with the
billing page; but GG already solved this. I found Javascript problems
though. Then I looked at the LDAP data thinking about the job GG needs
to run, and what queries will be needed.

Then I finished the testbed that gets a user's fqdn, added that to the
servlet, and it works. It's now 10:41.

Just ran a test: change billc's email and password, and hit the
servlet again. The changes propagated.

Let's see if we can cheat SW. Yup, I can use GET instead of POST,
which will spare me the trouble of doing POST in Java.

Got the queries down for Gautam to run. It was kind of a neat problem
to solve. It also bums me that you can't do joins like in SQL:

----------------------------------------------------------------------------
Gautam,

I think I have the correct solution here. The first step is to cull all yearly package IDs from Rob's spreadsheet. Then, for each package ID, you need to run this query:

bash-2.05a$  ldapsearch -h db2-1.prv.ampira.com -p 400  -D "cn=Directory Manager" -w "new ldap password" -b "o=FCTY" "(evwproductid=1002041286.43075)" evwInstalledProduct

Which yields, for product ID 1002041286.43075, these results:

evwInstalledProduct=1010170330.552121,o=eastglenvillefd,ou=clients,o=fcty
evwInstalledProduct=1010170330.552121

evwInstalledProduct=1010689568.193671,o=Joy Of Life,ou=Clients,o=FCTY
evwInstalledProduct=1010689568.193671

evwInstalledProduct=1012412107.997160,o=j. wine associates,ou=clients,o=fcty
evwInstalledProduct=1012412107.997160

evwInstalledProduct=1013463241.878817,o=FORTSON MOVING SYSTEMS,ou=Clients,o=FCTY
evwInstalledProduct=1013463241.878817

evwInstalledProduct=1014842222.624360,o=nightingale9,ou=Clients,o=FCTY
evwInstalledProduct=1014842222.624360

evwInstalledProduct=1015866160.587605,o=scott sussman,ou=clients,o=fcty
evwInstalledProduct=1015866160.587605

evwInstalledProduct=1017096805.355215,o=The Studio,ou=Clients,o=FCTY
evwInstalledProduct=1017096805.355215

evwInstalledProduct=1017700367.653375,o=street rod innovators,ou=clients,o=fcty
evwInstalledProduct=1017700367.653375

evwInstalledProduct=1018031089.338414,o=lucero enterprises,ou=clients,o=fcty
evwInstalledProduct=1018031089.338414


You'll have to parse these results for the longer string, which you'll get the next base Dn from.

For example:
evwInstalledProduct=1013463241.878817,o=FORTSON MOVING SYSTEMS,ou=Clients,o=FCTY
evwInstalledProduct=1013463241.878817

You want the substring: o=FORTSON MOVING SYSTEMS,ou=Clients,o=FCTY

and use that as the base of the next search (the "-b" part):

bash-2.05a$  ldapsearch -h db2-1.prv.ampira.com -p 400  -D "cn=Directory Manager" -w "new ldap password" -b "o=FORTSON MOVING SYSTEMS,ou=Clients,o=FCTY"   "(evworgtype=ORG)"  evwemailaddress

which yields:

username=JUSTALKEN,ou=People,o=FORTSON MOVING SYSTEMS,ou=Clients,o=FCTY
evwemailaddress=FORTSON@OTELCO.NET


Algorithmically, then:

for each yearly package ID:
   run query 1

for all substrings from step A:
   run query 2

and parse out the email addresses.

~swain
---------------------------------------------------------



#########################################################################
030612 Thursday

ResourceManager is in com.evolutionware.UI.
LdapUtil is in com.evolutionware.Ldap

For a good part of the day I've been banging my head against this damn
problem with the classpath on staging. Here's the skinny: the servlet
works fine on devil. On staging it can't find the
javax.activation.DataSource class file from activation.jar. I finally
narrowed down the problem by putting a copy of activation.jar in
/opt/evw/java; but soap.jar does not suffer this problem! Both jar
files are in WEB-INF/lib where they should be. I understand that
activation.jar is in Resin's classpath on devil, and not on staging;
but I don't see why CartWizard can find activation.jar and
SupportRedirector cannot.

I wrote a little testbed for the URL class to prove or disprove
whether I was instantiating it right. I was. My guess is that Java
uses its own resolving library of some kind, because changes to
/etc/hosts have no effect. Er. Wait. I can call spt-1 from the url
tester, but not from the servlet. It times out. Hrmm. Hardcoded IP
address works. Nothing works on staging.


#########################################################################
030613 Friday

Just did a rollout to app-2; Sunil was going to put it live before we
sync'd it with app-1. Hrmm.

I reran my tests for the URL class and indeed, even with a hardcoded
raw IP I cannot connect to port 80 from staging to spt-1.dvl.

I'm reading through the SOAP::Lite stuff to try to see why JeffO's
stuff doesn't have named attributes.

We leave shortly for Lysa's farewell lunch.

---

xterm -bg "#0a0000" -fg white -cr green &

jeffo:
1. the sw perl needs to be updated.
2. apache needs to be built with mod_perl linked to the _new_ sw perl.
lysa has/had a doc from sw about upgrading the perl.....
it should be a drop and replace into /opt/isc/perl, but backup,
backup, backup.....
and then i have a apache build script to help you with the mod_perl crap.

lysa:
i had a conversation with them about upgrading perl
and i told him what to do to try it out
they suggessted
taking the new version of perl from the dev box and putting it on the older version
(after backing it up, of course)
there is no doc




#########################################################################
030616 Monday

Showed Swolf my servlet, he seemed pleased with it. Talked over the
remaining parts to do for UL. Mail.app acting weird; didn't get any
mail over the weekend, took almost 40 minutes to download my mail. Got
my todo out. I'm out Friday and Monday for a trip to Cle. New sysadmin
not here yet.

Lunched with JeffO. Deal: Perl is statically linked. I need to copy
the /opt/isc/perl5 dir to production; and I need to recompile Apache,
and tweak the conf with the stuff he has in Twiki. Then I might need
to add some Perl modules. That is the whole rollout procedure in a
nutshell.

Also, JeffO explains his procedure in Twiki. I didn't see this
originally:

https://twiki.corp.fortunecity.com/bin/view/Management/UnifiedLogin

All the steps for the project are there.

Rerunning the May reports; GG copied my script and I had a small
"Doh!" in there. I did tab conversion on the summary file and not the
csv file. Doh!

Super ultra weird Perl thing. Observe:

ketelone bin]$ perl -e '$key = "foo"; print $hash{ $key } . "\n";'

[ketelone bin]$ perl -e '$key = "foo"; push @{ $hash{$key} }, 1;print $hash{ $key } . "\n";'
ARRAY(0x6674)
[ketelone bin]$ perl -e '$key = "foo"; $blippy = $hash{$key}; push @{ $blippy }, 1;print $blippy . "\n";'
ARRAY(0x6590)
[ketelone bin]$ perl -e '$key = "foo"; $blippy = $hash{$key}; push @{ "$blippy" }, 1;print $blippy . "\n";'

[ketelone bin]$ perl -e '$key = "foo"; push @{ "$hash{$key}" }, 1;print $hash{ $key } . "\n";'

[ketelone bin]$ perl -e '$hash{foo} = 2; print $hash{foo} . "\n"'
2

Jeffo uses a kind of reverse assignment, where a hash value is given
the reference to the array.




#########################################################################
030617 Tuesday

Logging into mysql on spt devil:
mysql -uroot -p'w!zard!' -S /opt/isc/mysql/data/mysql.sock sw_std

Very weird... having issues connecting to my local mysql server. Also
my current build of Emacs won't accept C-c in shell mode. I can run
mysqlshow though.

from http://www.devarticles.com/art/1/62/3:
mysqldump --opt mydatabase | mysql --host=localhost -C newdatabase

--opt generates 'drop if table exists' statements for you.

Finally, first successful test on staging of the redirect servlet. 

Fixed the 2,5 year problem on devil last week. Forgot to mention this
I think. Ticket finally closed. At Friday's meeting for support
tickets it was discovered that LDAP lost all its entries for com, org
and net tlds. This had been the situation since Thursday, since Sunil
noticed failed jobs were starting to pile up on that day.

Emailed GG asking for a code review.

Redid the query for all users of EVW. I came up with 14034 using the
objectclass=person approach, which is more... data specific, for lack
of a better word. Went back to db2-1 and reran my old query, using a
chain of greps to narrow it down to just username:

bash-2.04$ ldapsearch -h db2-1.prv.ampira.com -p 400 -D "cn=Directory Manager" -w "Ld@p416." -b "ou=Clients,o=FCTY" "username=*" username |grep .|grep -v FCTY|grep -v username::|grep username:|wc -l
   14014

A difference of only twenty users; no idea why though. I'd trust the
objectclass=person approach. Another puzzle is the endless list of
"username::" values which look like they are translated from binary:

username:: c2VydmljZXMtdGVzdAA=
username:: V2l0aG5haWw3NQA=
username:: cnVubmluZ2JhbmcubmV0AA==
username:: YnJpYW5uYXcA
username:: c2V2ZW50aHRlc3QA

Solved a problem today with Support Wizard. I was getting the "Server
made a what?" message again, and after restarting Apache, something
about "no free license." Turns out you can only log in three people at
a time on dvl, and logging them out fixed the problem. Whew.

Had a mini code review with GG earlier, went well. Got good feedback,
and it's useful to sit and mark code with a pen. Kinda satisfying
somehow.

So. All my problems were due to too many users logged in!!!


#########################################################################
030618 Wednesday

Bad news. Tickets are tracked not by user ID but by user name. This
will make it really, really hard to bring over the tickets for each
user when we update their username.

Updating the username in the reports table -- whichever one it is --
seems like a possiblity. Testing: f_enduser is the field in
p6_v_reports. f_user must also be updated.

So, even in production, users can change their username, which results
in a new account being created and they lose all their tickets. Or so.

Creating a new user via SOAP:
select count(*) from p6_v_users;                                select count(*) from p6_v_users;
8635                                                          | 8636
select count(*) from p6_v_users_h;                              select count(*) from p6_v_users_h;
662                                                             662
select count(*) from p6_v_users_show;                           select count(*) from p6_v_users_show;
8728                                                          | 8734

Adding or updating a ticket:
select count(*) from p6_v_users;                                select count(*) from p6_v_users;
8635                                                            8635
select count(*) from p6_v_users_h;                              select count(*) from p6_v_users_h;
662                                                             662
select count(*) from p6_v_users_show;                           select count(*) from p6_v_users_show;
8718                                                          | 8728

Thus far only the p6_v tables appear to be affected.

On both dev and production, changing the username does not affect the
userid. But the tickets are lost because f_enduser is how they are
extracted from the reports table. Contrary to how it appeared
yesterday, you can switch back and forth between usernames but tickets
are still lost.

Updating a ticket appears to just update a row, no additional rows are
added anywhere. Sure wish there were a mysql log.

As a first guess, users_show stores user prefs. users_h stores the
tickets. users has all user data.

mysql> describe p6_v_users_h;
+-------------+---------------------+------+-----+---------------------+----------------+
| Field       | Type                | Null | Key | Default             | Extra          |
+-------------+---------------------+------+-----+---------------------+----------------+
| ID          | int(11)             |      | PRI | NULL                | auto_increment |
| GRP         | tinyint(3) unsigned |      | MUL | 1                   |                |
| F_FieldName | varchar(255)        |      |     |                     |                |
| F_RecordID  | bigint(20)          |      | MUL | 0                   |                |
| F_OldValue  | mediumtext          |      |     |                     |                |
| F_NewValue  | mediumtext          |      |     |                     |                |
| F_Time      | datetime            |      | MUL | 1900-01-01 00:00:00 |                |
| F_User      | varchar(255)        |      |     |                     |                |
+-------------+---------------------+------+-----+---------------------+----------------+
8 rows in set (0.00 sec)

mysql> describe p6_v_users_show;
+-----------+---------------------+------+-----+---------+----------------+
| Field     | Type                | Null | Key | Default | Extra          |
+-----------+---------------------+------+-----+---------+----------------+
| ID        | int(11)             |      | PRI | NULL    | auto_increment |
| GRP       | tinyint(3) unsigned |      | MUL | 1       |                |
| F_User    | varchar(255)        |      | MUL |         |                |
| F_Display | mediumtext          |      |     |         |                |
| F_Search  | mediumtext          |      |     |         |                |
| F_Others  | mediumtext          |      |     |         |                |
+-----------+---------------------+------+-----+---------+----------------+
6 rows in set (0.00 sec)


I'm dumping the tables to files and diffing them after certain
operations. Changing the username affects two tables: p6_v_users and
p6_v_users_show. 

[swain@spt-1 isc]$ diff ~/tables ~/tables2
8682c8682
< INSERT INTO p6_v_users VALUES (8678,1,8677,'ampira_moe2','SW.NVy3Fgi/8s','','Customers','','shdwgrphs@aol\
.com','2003-06-18 18:54:01','2003-06-18 19:49:43','Maureen Safran','','Domain Name Registration','','Unknow\
n','','Updated by user ampira_moe2 on 18 Jun 2003 18:59:11\n\n  Username (Login) was: ampira_moe\n  Usernam\
e (Login) now: ampira_moe2\n\n---------------------------------------------\nUpdated by user ampira_moe on \
18 Jun 2003 19:00:42\n\n  Username (Login) was: ampira_moe2\n  Username (Login) now: ampira_moe\n\n--------\
-------------------------------------\nUpdated by user ampira_moe2 on 18 Jun 2003 19:01:46\n\n  Username (L\
ogin) was: ampira_moe\n  Username (Login) now: ampira_moe2\n\n---------------------------------------------\
\nUpdated by user ampira_moe on 18 Jun 2003 19:02:07\n\n  Username (Login) was: ampira_moe2\n  Username (Lo\
gin) now: ampira_moe\n\n---------------------------------------------\nUpdated by user ampira_moe2 on 18 Ju\
n 2003 19:49:43\n\n  Username (Login) was: ampira_moe\n  Username (Login) now: ampira_moe2\n\n-------------\
--------------------------------\n');
---
> INSERT INTO p6_v_users VALUES (8678,1,8677,'ampira_moe','SW.NVy3Fgi/8s','','Customers','','shdwgrphs@aol.\
com','2003-06-18 18:54:01','2003-06-18 19:51:30','Maureen Safran','','Domain Name Registration','','Unknown\
','','Updated by user ampira_moe2 on 18 Jun 2003 18:59:11\n\n  Username (Login) was: ampira_moe\n  Username\
 (Login) now: ampira_moe2\n\n---------------------------------------------\nUpdated by user ampira_moe on 1\
8 Jun 2003 19:00:42\n\n  Username (Login) was: ampira_moe2\n  Username (Login) now: ampira_moe\n\n---------\
------------------------------------\nUpdated by user ampira_moe2 on 18 Jun 2003 19:01:46\n\n  Username (Lo\
gin) was: ampira_moe\n  Username (Login) now: ampira_moe2\n\n---------------------------------------------\\
nUpdated by user ampira_moe on 18 Jun 2003 19:02:07\n\n  Username (Login) was: ampira_moe2\n  Username (Log\
in) now: ampira_moe\n\n---------------------------------------------\nUpdated by user ampira_moe2 on 18 Jun\
 2003 19:49:43\n\n  Username (Login) was: ampira_moe\n  Username (Login) now: ampira_moe2\n\n--------------\
-------------------------------\nUpdated by user ampira_moe on 18 Jun 2003 19:51:30\n\n  Username (Login) w\
as: ampira_moe2\n  Username (Login) now: ampira_moe\n\n---------------------------------------------\n');
18125c18125
< INSERT INTO p6_v_users_show VALUES (8775,1,'ampira_moe2','','\'reports:Show All\', \'reports:Mine\', \'re\
ports:My Assigned\', \'reports:1 hour\', \'reports:Today\', \'reports:1 week\', \'reports:Open\', \'users:S\
how All\', \'users:Mine\'','');
---
> INSERT INTO p6_v_users_show VALUES (8775,1,'ampira_moe','','\'reports:Show All\', \'reports:Mine\', \'rep\
orts:My Assigned\', \'reports:1 hour\', \'reports:Today\', \'reports:1 week\', \'reports:Open\', \'users:Sh\
ow All\', \'users:Mine\'','');


Create new user with SOAP:

[swain@spt-1 isc]$ diff ~/tables ~/tables2
8682a8683
> INSERT INTO p6_v_users VALUES (8679,1,8678,'ampira_silcon','SWKolgjwNZc3Y','','Customers','','silconus@be\
llsouth.net','2003-06-18 20:04:59','2003-06-18 20:04:59','Alberto Freti','','Domain Name Registration','','\
Unknown','','');
18125a18127
> INSERT INTO p6_v_users_show VALUES (8776,1,'ampira_silcon','','\'reports:Show All\', \'reports:Mine\', \'\
reports:My Assigned\', \'reports:1 hour\', \'reports:Today\', \'reports:1 week\', \'reports:Open\', \'users\
:Show All\', \'users:Mine\'','');


Looking good. If I could just find a way to create a new user via dvl
I can verify we're doing the right thing. I can track down all columns
with the username that need updating.

Sweet:

[swain@spt-1 isc]$ diff ~/tables2 ~/tables3
8683a8684
> INSERT INTO p6_v_users VALUES (8680,1,8679,'verifytest','SWKZbcyhdn/og','','Customers','','test@example.c\
om','2003-06-18 20:11:07','2003-06-18 20:11:07','test to verify jeffo','example.com','Domain Name Registrat\
ion','','Unknown','','Created by user register2 on 18 Jun 2003 20:11:07\n\n--------------------------------\
-------------\n');
18127a18129
> INSERT INTO p6_v_users_show VALUES (8777,1,'verifytest','','\'reports:Show All\', \'reports:Mine\', \'rep\
orts:My Assigned\', \'reports:1 hour\', \'reports:Today\', \'reports:1 week\', \'reports:Open\', \'users:Sh\
ow All\', \'users:Mine\'','');


So SOAP and SW do it the same way. Good. Matching is the next business
of order.

After all my work doing the above, still only two tables were altered
(not counting updates, which wouldn't show with my testing method.)


#########################################################################
030619 Thursday

Am in a daze today, perhaps from Nyquil again. Lots of coding so
far. Strange difference between staging and devil: staging reads the
web.xml file, devil does not. Might have something to do with the
resin.conf setup.

Pulled all strings out of the servlet and ldap classes and put them in
the conf files. This has been quite a piece of work.

Lots resolved today. Can't redirect and do a POST; I moved the
login/password into the middle of the URL so it's not as obvious. Lots
of commenting, refactoring and testing. I still need good redirect
URLs but the thought occurred to me to add a JSP to display errors.



#########################################################################
030624 Tuesday

Trying to grok the output of JeffO's merge script:

total means total number of users in EVW file.
total => 16663, no match => 12946, potential match => 3717

unique: logins => 16875
single matches: total => 15713, exact => 1667
multiple matches: total => 3769, exact => 1036
invalid lines in sw_users file: total => 44

These numbers don't jive, since it claims 12K didn't match out of
16K, but then says there are 15K single matches with 1667 exact. Huh?

JeffO says: "unqiue logins is higher than the number of lines in the
file because some 'logins' have multiple domains. see line 141. this
loops over each domain in a line. and at line 170, each domain is
added to %sw_users using &pushSWParams()

"'single_matches' are sw_users that only have one domain

"'single_matches_exact' are sw_users values that have one domain which
matched to a support wizard user.

"'multiple_matches' are sw_users values that had more than one domain.

"'multiple_matches_exact' are sw_users values that had more than one
domain, and matched a support wizard user.

Had a long chat with JeffO, sorted out several issues. Very cool. I
have most of the rollout plan and I need a little script he has to
help do apache compiles.

---

After playing with the merge script for a while, I made an output
file of the account names for EVW and SW. I found it disturbing that
we'd change account names for accounts where the email doesn't match;
I think the only legit account update should be if email addresses
match, and nothing more. Hrmm. What about domain names? If account
name and domain name match, maybe. At any rate, email match only
means around 2000 accounts updated.

Wrote a Twiki doc on the rollout procedure.

Working example of a loop on a list made with cons:

;; note weird syntax; cons needs a list to add to...
(setq foolist (cons 'laying '(my hand on my creator)))
;; alternately:
;; (setq foolist '(laying my hand on my creator))
(car foolist)
(cdr foolist)

(progn
  (setq counter 0)
  (while (< counter (length foolist))
    (setq counter (+ 1 counter))
    (message (format "hello: %s" (nth counter foolist)))
    )
)



#########################################################################
030625 Wednesday

Updated my Javadoc strings after reading up on it again; private
methods do not get documented, interestingly. For some strange reason
my control-f5 doesn't register anymore; the OS can't even see it.

Went through the steps to put Perl in place on production; it should
be fine. It's a binary from the SW people for a newer version. JeffO
helped me with the steps to build apache/mod_ssl/mod_perl, and that
works so far, so yay. We met with Garrison and he doesn't want to
launch for two weeks; plus he doesn't care about closed tickets
(yay!) so all that fell into place.




#########################################################################
030626 Thursday

Duly noted here: devil does not read the web.xml file, but does read
the resin.conf; staging and production read/honor the web.xml
file. Sadly this makes it tricky to keep things kosher when moving
between platforms.

I resolved everything to get the servlet running on production except
for doing the SOAP call, which requires Zlatin to do some firewall
stuff.

3pm meeting. I had to whip up a demo right fast; did, worked,
success. Problem: they want to go from EVW to AnswerHelp to SW. No
surprise. Solution: AH receives one arg, the EVW sessionkey. Puts in
cookie. Anywhere there is a login to SW, link to servlet with
sessionkey as arg.

If timeout, I now have to take login/password, auth them, and log
them into SW.




#########################################################################
030627 Friday

Bogus. Problem: user's evw sessionkey has expired. We want to give
them a login screen again. We don't know what visp they belonged to
anymore. Thought: if username/password are a unique combo, then we
can just authenticate them in ldap ourselves... unless there are
username/password combos that match across visps.

Ran a test and yup, there are collisions. Bogus.

Tunneling: ssh -v -L 2000:db2-1.prv:400 bastion 
querying: ldapsearch  -h localhost -p 2000 -D "cn=Directory Manager"
-w "secret" -x -b "o=FCTY" "(username=swain)"

New Perl binary still not on production, cannot compile Apache yet.

Well, they rolled out the perl binary and the mysql.so won't load due
to a glibc version difference. Bleh. Jeffo said installing the rpm for
swmysql is tricky and I should do it a few times on development to get
the hang of it; he said he and Lysa were trying to avoid doing it at
all.

Wrote a Python subroutine to parse out the ispdn from any dn. This
will probably be needed for the vps pages so we can pass the ispdn
along with the session key to answerhelp.


#########################################################################
030630 Monday

Sent the todo list. Jessy took the day off to get her dog.

I think I forgot to note here (and am now too lazy to scroll back)
that I did a basic test on production, and save for the SOAP call, the
servlet works just fine.




#########################################################################
030707 Monday

Damn. No entries for last week? I was just too busy. Bad Steve.

Fixed a bug: userDn is not always set when you login. Weird. It
sometimes is, sometimes isn't. The way I tested was to quit the
browser and use different logins, and loginDn appears to be
constistently set; I can parse out the visp/isp from that.

Three meetings today: tech staff, update meeting with Garrison, with
Elke to cover the page flow.


#########################################################################
030708 Tuesday

In by 9:30. Could have gotten here earlier. Oddly, got a seat on the
train by the time we reached Lex.

Eric could not autologin because:

tail -f /opt/apache/logs/error_log
unknown terminal "emacs"
unknown terminal "emacs"
[swain@spt-1 conf]$           'FullName' => 'fcgtest 053',
          'Group' => 'Customers',
          'Password' => '112233',
          'Domain' => 'fcgtest053.com',
          'Login' => 'fc_gold_fcgtest053',
          'AmpiraProduct' => 'Domain Name Registration'
        };
 )
[ error ] FC::SW::User::createUser->( Unable to create user record )
[ debug ] FC::SW::User::createUser->( New user created, new_user_id => 8690 )

Around 2:50pm, I lost my connection to support.ampira.com. I was in
the middle of recompiling Apache. It turns out JeffO told me the wrong
info about the conf file; he thought it was in /opt/apache but the one
in use appears to be /etc/httpd/conf, which is far more complicated
and does all the vhost stuff.

5pm: got the LoginServlet working correctly. Users with expired
session keys are sent to login.jsp; we retain the loginDn. Submitting
the form takes them to the LoginSerlvet, which attempts to
authenticate them by generating a new sessionkey. On success they are
redirected back to the, er, redirect servlet, and then logged into
Support Wizard.

SW went down a second time; more precisely, searches do not work.

Had to copy mail.jar into the lib/ directory, even though it was in
the classpath. (???)




#########################################################################
030709 Wednesday

At one point today, we lost the DMZ and I was cut off for a while.

Two points of flakiness: sometimes we don't get the domain name in the
second ldap query, and sometimes the soap server throws a 500.

My hack to Relay.java:

  public void run () {
    int n;
    StringBuffer strungout = new StringBuffer();
    try {
      while ((n = in.read (buf)) > 0) {
          strungout.append(new String (buf, 0, n, "8859_1"));
        out.write (buf, 0, n);
        out.flush ();
        if (ta != null) {
          ta.append (new String (buf, 0, n, "8859_1"));
        }
      }
    } catch (IOException e) {
    } finally {
      try {
        in.close ();
        out.close ();
        java.lang.System.out.println(strungout.toString());
      } catch (IOException e) {
      }
    }
  }

I just add a StringBuffer and print the results when it's done.


From: Steve Wainstead <swain@ampira.com>
Date: Wed Jul 9, 2003  5:43:38 PM America/New_York
To: dev@ampira.com
Cc: Zlatin Ivanov <zlatin@ampira.com>
Subject: the latest on UL

0) Bug #0: Cannot start ssl on support/production.

Fix: Conf error, resolved.

1) Bug #1: the soap client (on app2) won't tell me what the error is
   because the error message does not conform to the xml schema.
   (grrr!)

Fix: hack soap.jar client program TcpTunnel so it prints the packets
to stdout. Go Java!

2) Bug #2: The soap server (support box) does not like the packet it
   got; claims illegal chars in content.

Fix: I remembered JeffO had trouble with output from the LDAP server
on production because some fields were null terminated, some not. I
test for/remove nulls now. Funny this doesn't happen on devil!

3) Servlet cannot resolve URI namespaces for the XML packet.

Fix: For now we ignore the exception. Zlatin added firewall rules so
we could reach www.w3c.org and www.xmlsoap.org, and though we can now
reach them via Lynx, the servlet still cannot.

Ancillary bug: I found Jeffo's test client (it's a perl script that
runs on the support box, makes a localhost soap call) didn't work,
found a conf file difference; that fixed things for the test client
but didn't fix things for the servlet, so I accidentally fixed an
upstream bug.

Summary: main problem was caused by null terminated strings from
LDAP. I suspect EVW might put them there. Very weird. Not all fields
are null terminated; only about 50% are.

At the moment I can do end-to-end tests on production (YAY!) but I
need to figure out why the Call class is throwing a SOAPException,
claiming it can't resolve the URIs in the namespace declarations.

~swain

---
AIM id: wainstead1
Be indiscrete.  Do it continuously. 


Note that the error with SSL was really the wrong ssl key being used.




#########################################################################
030710 Thursday

-- username for all open tickets
select f_user, f_enduser from p3_v_reports as r where r.f_state != 'Closed';




#########################################################################
030714 Monday

Friday, mostly did monitoring of UL, had a long meeting with Petrus,
and did some general housekeeping.

Met with Gautam after the 11am meeting; went over my todo list. I felt
like I was under the microscope. He wants me to finish off UL by
Wednesday.

First on my list was getting around using the hardcoded SOAP::Lite
keys; but after lunch I played a hunch that they didn't matter, and
indeed, I tried some other names and they worked just fine. JeffO's
implementation just wants an array of values.

While searching, found a little test.jsp file that tells you what XML
parser you're using. Works. Result:

Parser Check
JAXP-compliant parser found? Yes

javax.xml.parsers.DocumentBuilderFactory implementation class: org.apache.crimson.jaxp.DocumentBuilderImpl

org.w3c.dom.Document implementation class: org.apache.crimson.tree.XmlDocument

Namespace-aware? Yes 

Current error message in stdout.log:

SupportRedirectorServlet: Caught SOAPException (SOAP-ENV:Client): Unable to reso
lve namespace URI for &apos;xsd&apos;.



#########################################################################
030715 Tuesday

Installed the latest w3, which appears to be under active dev
again. Sucks. Can't render the NYT home page. Also installed Links
here on my Mac and runs great. Renders Slashdot really well.




#########################################################################
030716 Wednesday

GG forwarded Swolf's email about dupe hostv3 jobs; talked to CVW,
found that there was one for fc gold as well. He wants me to compare
the frontends for ampira and hostv3, /wizard/signup files.



#########################################################################
030718 Friday

Never did make an entry for yesterday... what happened was, the CGI
tools Support uses on comfort.ampira.com were broken. The problem was
in the Apache config. With Gautam's help I fixed it; the scripts are
now just passed to mod_perl. The previous build of Apache didn't have
mod_perl.

I had to compile several modules, some from France which took
forever. Then I wrapped up that business with the HostV3 versus Amira
frontends: I had to compare the JSP files for Chris Van Wie to make
sure nothing was causing the dupe jobs he's been seeing since May
(about six HostV3, one FC Gold).

Also completed the refactoring/checkin of UL. Today Eric skinned the
error page. Rollout on Monday.

Time to write the page for UL:

-------------

<verbatim>

0) Intro.

Unified Login was a project to let users move from Evolutionware
directly into Support Wizard. This is done via cookies, a servlet, the
EVW session key (optionally, the loginDn if their session expired),
a SOAP call to Support Wizard with the user's LDAP data, and finally a
redirect with their login info.

Previously users had to create an account in Support Wizard with the
admonition to use their username/password from EVW. In practice this
is not possible because EVW can have duplicate usernames and SW
cannot.

1) Process.

In a nutshell: the user logs into EVW. From there they can go to
AnswerHelp; we modified splash.vps, the control panel, to call
AnswerHelp with two CGI variables passed in: sessionkey and loginDn.

Code in splash.vps:

# set up args to pass to answerhelp; answerhelp needs these                                                       
# to log the user into support wizard, if need be                                                                 
loginDn = session.get("loginDn")
params = { "sessionkey":sessionkey, "loginDn":loginDn }
querystr = '?' + urlencode(params)

and later:
<a href="http://www.answerhelp.com/index_orgtree.asp<% echo(querystr)%>" target=new>

Resulting link the user clicks on:

http://www.answerhelp.com/index.asp?sessionkey=DMFC_OtYdKcsmVhuNFBx&loginDn=username%3dmtwain,ou%3dPeople,o%3dv3turbofp01,ou%3dClients,o%3dHostV3,ou%3dClients,o%3dDMFC


In AnswerHelp, these two variables are placed in a cookie for the
answerhelp.com domain. Anywhere in AnswerHelp there is a link to
Support Wizard, these vars are placed in a link that calls the
SupportRedirectorServlet:


http://hostv3.dev.ampira.com/supportredirector/sr?sessionkey=DMFC_IEtQQcdVpQePQCX&loginDn=username%3dmtwain,ou%3dPeople,o%3dv3turbofp01,ou%3dClients,o%3dHostV3,ou%3dClients,o%3dDMFC

The servlet does a series of things when called:

a) It connects to Evolutionware.
b) It attempts to validate the sessionkey passed to it.
c) If good, it uses the data to query LDAP for the user's info.
d) It queries LDAP again for the user's domain name.
e) A SOAP call is sent to Support Wizard to either create or update
the user's account.
f) A redirect is sent to the user, which is a CGI GET string with
login info. The user is automatically logged in.

From the user's point of view, they clicked a link in AnswerHelp and
went straight to Support Wizard, after a small delay. If their
sessionkey has expired, they are given a login page (login.jsp), which
has the loginDn embedded as a hidden variable. (This is needed to
determine which visp they belong to). When they submit the login info,
it goes to the LoginServlet; if successful, LoginServlet sends the
user a redirect URL to the SupportRedirectorServlet with a new
sessionkey.

In Support Wizard, nothing has really changed. Jeff O'Connell wrote
some Perl classes to interface with Support Wizard; mod_perl and
SOAP::Lite is used to receive the SOAP call. An insert or update on
the MySQL database is done.

2) Troubleshooting

Unified Login has a few points of failure. Symptoms:

a) From AnswerHelp, cannot login. Check that the
SupportRedirectorServlet is running. If the sessionkey has expired,
the servlet sends the user to login.jsp which calls LoginServlet; if
EVW is down, this servlet will fail.

b) If LDAP is down, the servlet will fail.

c) If the app server (app-1 or app-2) where the servlet runs cannot
contact support.ampira.com (actually, spt-1.prv.ampira.com), it cannot
make the SOAP call, and the login will fail.

d) On the development box, Support Wizard only allows five logins
max. If you see "The server made a what?" in the browser, you've maxed
out the logins.

The way to debug problems with Unified Login: tail -f on resin's
stdout and stderr logs, and tail -f on Support Wizard's log and the
Apache error_log.

You can test the servlet directly. This should take you straight to
the error page, since there is no sessionkey or loginDn:

http://hostv3.dev.ampira.com/supportredirector/sr?

This should take you to the login page, since the sessionkey is no good:
http://hostv3.dev.ampira.com/supportredirector/sr?sessionkey=DMFC_IEtQQcdVpQePQCX&loginDn=username%3dmtwain,ou%3dPeople,o%3dv3turbofp01,ou%3dClients,o%3dHostV3,ou%3dClients,o%3dDMFC



3) Known issues

a) On the devil machine, SupportRedirectorServlet's config info comes
from resin.conf, but for some reason on staging and production it
comes from web.xml (as it should).

b) activation.jar had to be added to the servlet's lib directory to
work on staging, and mail.jar to work on production, even though both
jar files were in the classpath.

c) There is a problem with the XML parser that only affects
production. The SOAP call succeeds but the parser does not like the
returned packet. Solution was to put xerces.jar at the front of the
classpath but this did not solve it.

</verbatim>


#########################################################################
030721 Monday

Installed mysql on devil; installed the Bundle::DBD::mysql. Tests ran
fine. Dumped the database on blast.corp to a file (first, filling up
the /home partition). File size ~470MB. Wrote utility to take output
of mysqlshow and generate shell code to query all tables for size
(select count(*) from tablename).




#########################################################################
030722 Tuesday

The way I wrote the delete script for the blastmail database was
totally stupid. I have to think a bit before I do something like
that. I wrote a script to generate a delete statement for each
message_number; instead I should have written one delete statement
with the clause "where message_number in (...)." That I did this
morning, since I was logged out of blast.corp by bastion before the
script completed. The new one just finished.

I have a strange problem today. Command-x is not received as meta-x on
blast.corp today, though it did yesterday.

 


#########################################################################
030723 Wednesday

msyql database is still loading blastmail data, over 24 hours later.

I finished debugging the frontend walker for evw. Just have to figure
out how to continue into the wizard now.

Started on the mysql script for the ops folks. Got an account on the
box.

Helped Zlatin set up a named screen session.

Debugged problem with user not being able to get into SW. Zlatin did
not make support.ampira.com reboot safe, surprise surprise. I just had
to stop the old apache and start the new one
(/opt/apache-soap/bin/apachectl) once I figured out the problem.

Also building Emacs from May 29th sources since it continues to be
flaky.

Spent time trying to find out why Jessy's html form didn't
work. Looked mostly in EVW and finally found that she defined
productId twice, so the wizard never received a value.




#########################################################################
030724 Thursday

Hurray, the database finally loaded. I'm going to run a few queries
to make sure they are about the same size.

Meanwhile I was asked to look into why Support Wizard's box is
complaining nightly about disk space. They have their own home rolled
version of cron written in Perl, probably so SW can run on Windows
boxen. The dumps of the tables to /opt/isc/db/export/tables are huge,
so I proposed that we move old closed tickets out of the system to
preserve space.

In the SW interface under Setup->Backup this can be set (see
spt-1.dvl.ampira.com, login as admin.)

Proof:
devil:                      production:
Size of Contact_Interests:  Size of Contact_Interests:     
157706                      157706                         
Size of Contact_Profile:    Size of Contact_Profile:       
5373204                     5373204                        
Size of Contact_Source:     Size of Contact_Source:        
7136843                     7136843                        
Size of FC_persdomains:     Size of FC_persdomains:        
1383695                     1383695                        
Size of Global_Unsubcribers Size of Global_Unsubcribers:   
54909                       54909                          
Size of Interests:          Size of Interests:             
14                          14                             
Size of Source:             Size of Source:                
14                          14                             
Size of SvdQuery:           Size of SvdQuery:              
49                          49                             
Size of ampira_customers:   Size of ampira_customers:      
112                         112                            
Size of blast_log:          Size of blast_log:             
188                         188                            
Size of contact:            Size of contact:               
6363496                     6363496                        
Size of contact_list:       Size of contact_list:          
10622626                    10622626                       
Size of contact_message:    Size of contact_message:       
1107630                     1107630                        
Size of fix01_table:        Size of fix01_table:           
280768                      280768                         
Size of ggtmptable1:        Size of ggtmptable1:           
40000                       40000                          
Size of list:               Size of list:                  
82                          82                             
Size of mailings_blockbuste Size of mailings_blockbuster:  :
300000                      300000                         
Size of message:            Size of message:               
768                         768                            
Size of rm_user:            Size of rm_user:               
9                           9                              
Size of session_1:          Size of session_1:             
15                          15                             

Databases are totally identical.

---

Problem with tickets that are being lost.

dorkazoid created a ticket on 7/22 and it's under his dorkazoid name,
not ampira_dorkazoid.


#########################################################################
030725 Friday

Waiting on Zlatin for access to dbm-1 and dbm-2. Helping Gautam with
EFTnet debugging.

Font settings with this new monitor: driving me batty.

---

Test one:
swaintest, bought domain + email + forwarding. Charges claimed to be
$0.00.

Test two: swainoswaino. Bought package; chose eftnet; didn't see any
errors.




#########################################################################
030728 Monday

Got in, GG left a todo for testing eftnet on staging, staff meeting;
spent the early afternoon trying to get the eftnet gateway
running. Eventually found that running the script over and over got it
to succeed; GG called and said this means the devnull gateway was
running. Zlatin is going to take it out of the 'supervise' directory
so it isn't restarted automatically.




#########################################################################
030729 Tuesday

Long long day yesterday that flew right by. In short, after the
trouble setting up eftnet, I had to solve wizard errors that Eric
introduced; after that testingtestingtesting of the system.



#########################################################################
030731 Thursday

Oracle cheat sheet:

select table_name from all_tables;
# pull out views for comparison.
select view_name,text from user_views where rownum < 5;

You can only run Emacs on dmb-2 as root. Very strange. I finally got
my .emacs stuff downloaded. I have been spelunking around Oracle on
db2.fortunecity.net and found the user data. Very frustrating: lost
the login info for V3's database. I did stuff on it just last week but
didn't write any of it down.

# On dmb-2.v3.com: (must be root)
mysql -S /tmp/mysql.v3_cust.sock v3_cust


#########################################################################
030804 Monday

Too much bother to deal with caching the ldap results. I'm going to
work with a query that returns a small data set (GlobalScape) and deal
with that. Still need info from Gautam on which machine he wrote stuff
to do extraction from Oracle; Zlatin has no idea.

When there is binary junk in the cli buffer, write-desktop seems to
have some problems on how to save the file (what character
encoding). I'm writing a long sentence now to test this. Yup. Nasty!

Not nulls... tested the code for them, in Perl, and couldn't find
them. Man I'm freezing today.

/home/gautamg/src/fortunecity/constantcontact

Starting mysql on devil:
pushd /opt/mysql; sudo ./bin/mysqld_safe --user=mysql; popd


#########################################################################
030805 Tuesday

Got the last of the Ampira dumping done; have full user list and paid
user lists. Did dumps on oas1.fortunecity.com for 2000-2003; found
GG's script on dbm-1.v3.com and ran it on dmb-2.v3.com (dumping
customer info out of v3_cust).

bash-2.02$ ./generatebulkusers3.pl 216 0 > ~/fc.2003.txt
bash-2.02$ ./generatebulkusers3.pl 581 365 > ~/fc.2002.txt
bash-2.02$ ./generatebulkusers3.pl 946 730 > ~/fc.2001.txt
bash-2.02$ ./generatebulkusers3.pl 1311 1095 > ~/fc.2000.txt
bash-2.02$ ls
elisp.tar    fc.2000.txt  fc.2001.txt  fc.2002.txt  fc.2003.txt  fc.tar
bash-2.02$ wc -l fc*txt
  285490 fc.2000.txt
  160078 fc.2001.txt
   76932 fc.2002.txt
  143722 fc.2003.txt
  666222 total

on dbm-2:

[root@dbm-2 swain]# cat query.sql
select cus_email, cus_FirstName, cus_LastName, cus_Sex, cus_Birthdate, cus_City, cus_PostalCode, ctr_CountryID, cst_CustomerTypeID, c.con_ConfirmStateID, c.cus_CreateDate, uri_scheme_host, uri_scheme_path, sd.pkg_PackageID from  Customer c, Subscription sb, Subdomain sd  where  sb.org_OrganizationID = c.org_OrganizationID and sb.sbs_SubscriptionID = sd.sbs_SubscriptionID;

[root@dbm-2 swain]# mysql -S /tmp/mysql.v3_cust.sock v3_cust <
query.sql  > v3dump20030805.txt

[root@dbm-2 swain]# ls -l
total 419608
-rw-------    1 root     root          376 Aug  5 11:27 query.sql
-rw-------    1 root     root     429674179 Aug  5 11:46 v3dump20030805.txt


Met with GG over schema changes and work to do for Blastmail. My
current task is to validate the emails. I have to install Net::DNS to
let Email::Valid do its work. Upgrading Bundle::CPAN while I'm at it.




#########################################################################
030806 Wednesday

My screen is fuzzy. Yesterday moved the email address verification
script to 10.1.1.50 (cvs box) to speed it up; something about the dns
queries is far faster than on devil.

I only have about 666,000 users from Fortune City. There's supposed to
be six million, I thought.

OK, running select count(*) from users; on the users table for Fortune
City yields only 1,900,000 users.




#########################################################################
030807 Thursday

Proof I correctly divided the v3 dump:

[evw-1 data]$ wc -l v3*-[0123][0-9].txt; wc -l v3dump20030805.txt 
  138817 v3dump20030805-01.txt
  138817 v3dump20030805-02.txt
  138817 v3dump20030805-03.txt
  138817 v3dump20030805-04.txt
  138817 v3dump20030805-05.txt
  138817 v3dump20030805-06.txt
  138817 v3dump20030805-07.txt
  138817 v3dump20030805-08.txt
  138817 v3dump20030805-09.txt
  138817 v3dump20030805-10.txt
  138817 v3dump20030805-11.txt
  138817 v3dump20030805-12.txt
  138817 v3dump20030805-13.txt
  138817 v3dump20030805-14.txt
  138817 v3dump20030805-15.txt
  138817 v3dump20030805-16.txt
  138817 v3dump20030805-17.txt
  138817 v3dump20030805-18.txt
  138817 v3dump20030805-19.txt
  138817 v3dump20030805-20.txt
  138817 v3dump20030805-21.txt
  138817 v3dump20030805-22.txt
  138817 v3dump20030805-23.txt
  138817 v3dump20030805-24.txt
  138817 v3dump20030805-25.txt
  138817 v3dump20030805-26.txt
  138817 v3dump20030805-27.txt
  138817 v3dump20030805-28.txt
  138817 v3dump20030805-29.txt
  138820 v3dump20030805-30.txt
 4164513 total
 4164513 v3dump20030805.txt

Last night the FC stuff for year 2000 stopped at 23:57 on the cvs
box. I don't know if it completed or not; Emacs had stopped when I
came in.

It cost me a lot of time yesterday trying to get the tcp_timeout set
right for the Net::DNS::Resolver class in Email::Valid. It simply
would not behave. I used the old trick from Advanced Perl Programming
to use alarm(), $SIG{ALRM} = \&somesub { die }, and eval{}; to trap
these long timeouts. I can shorten it to a few seconds. Gautam thinks
ten seconds is too long. I'll probably go with five.=======
Switched to staging for this log. We got a script from Oliver at SF
that inserts a preauth in the job queue. In order to feed it proper
data, for a given user you need their accountID.

Here are some orphaned comments from another version of LOG.txt: 


[snip]
db2 "select accountid from accounts a, accountholders ah where
a.accountholderid=ah.accountholderid and organisationdn like
'%imzlatinman%'"


returns 

ACCOUNTID  
-----------
        925

  1 record(s) selected.


Tips on converting .vps files to a cli file:

Beware session.get(). They are usually everywhere and have to be
ferreted out.

Use string-rectangle to fix indentation problems.

Comment out huge blocks at first until you get a running
script. Generally you need the system connection code from something
like jobInfo.py.

Exceptions: as noted elsewhere in this log, use this trick:

except:
   print sys.exc_info()

which will tell you something marginally useful.

Yet another test:



[July 29, 2003 5:56:06 PM | getClearingHouseDetails] Returning clearing house details.
[July 29, 2003 5:56:06 PM | getClearingHouseDetails] Returning clearing house details.
[July 29, 2003 5:57:52 PM | requestAuthorization] Recieved a request
[July 29, 2003 5:57:53 PM | requestAuthorization] gateway request completed successfully
[July 29, 2003 5:57:53 PM | requestAuthorization] Merchant: 440997041461, CreditCard: 4111111111111111, Reference: ER000000.0003330, Amount: 20890

[snip]





#########################################################################
030808 Friday

Finished V3 email addresses last night; need to collect the data on
Devil now. Ampira and properties next.

Came in at 9am sharp for vendor meeting but the vendor cancelled it.

I need a script to filter out the FCTY.everyone file so it's just the
nonpayers.

Trying to reconcile the output of the V3 sql query with the inputs to
the "process" script.


email          first           last sex birthday            city  zip   countryid custtypeid confirmstateid 
cmitter@aon.at|Claudius Mitter|Last|   |0000-00-00 00:00:00|     |     |        0|        1 |            3 |

 createdate          schemehost schemepath pgkID
 1999-06-07 17:59:00| come.to  |   cmitter|    5


Took a long time to track the bug in the script 'processV3.pl':

      $firstName    = $FIRSTNAME unless $FIRSTNAME = "First";

In this case, $firstName is always undef.

---
At this point in the videotape he always wonder if he's inadvertenly
set his beer down on the fast-forward button, or something, because
dancers go straight from their vicious Randy parody into something
that obviously qualifies as advanced dancing. Randy knows that the
steps they are doing are nominally the same as the basic steps
demonstrated earlier, but he's damned if he can tell which is which,
once they go into their creative mode. There is no recognizable
transition, and that is what pisses Randy off, and has always pissed
him off, about dancing lessons. Any moron can learn to trudge through
the basic steps. That takes all of half an hour. But when that
half-hour is over, dancing instructors always expect you'll take flight
and go though one of those miraculous time-lapse transitions that
happen only in Broadway musicals and begin dancing brilliantly. Randy
supposes that people who are lousy at math feel the same way: the
instructor writes a few simple equations on the board, and ten minutes
later he's deriving the speed of light in a vacuum.
---




#########################################################################
030811 Monday

Breakdown of the record per property, and the commands to generate the
input files:


ampira, paid:
Robert|Walker|o=Robert Walker,ou=Clients,o=FCTY|Robert Walker|212-706-3183|rob@fortunecity.com|31 Leonard Stre||Huntington Station|New York|11746|US

v3:
larspudas@hotmail.com|First|Last||0000-00-00 00:00:00|||0|1|3|2000-04-03 11:48:00|fly.to|pudas|5

fortune city:
20636177, smdmotorsports,rastasun2001@yahoo.com, greg, bennett,01-JAN-03


./processAmpira.pl data/good/fcty.paid+dn.txt.good output 6 42

./processAmpAll.pl data/good/fcty.unpaid.txt.good  output 6 42

./fcty2blastmail.pl data/good/fc.2003.good.txt output/ 8 42
./fcty2blastmail.pl data/good/fc.2002.good.txt output/ 8 42
./fcty2blastmail.pl data/good/fc.2001.good.txt output/ 8 42
./fcty2blastmail.pl data/good/fc.2000.good.txt output/ 8 42

./processV3.pl data/good/v3dump20030805-01.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-02.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-03.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-04.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-05.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-06.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-07.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-08.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-09.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-10.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-11.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-12.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-13.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-14.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-15.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-16.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-17.txt.good output/ 1 42.
/processV3.pl data/good/v3dump20030805-18.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-19.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-20.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-21.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-22.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-23.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-24.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-25.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-26.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-27.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-28.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-29.txt.good output/ 1 42
./processV3.pl data/good/v3dump20030805-30.txt.good output/ 1 42


Moved the tarballs of unchecked data and good data into /d2/blastmail
to free up space under /opt on devil.

---

Since lunchtime I made some dumb mistakes and it's cost me a lot of
time. I think it has, anyway. I tried loading the contact table, and
immediately met with collisions. What I didn't realize until much
later is that this happened because the old data is in the relatamail
database on devil; I should have started out with a fresh
database. Anyway, I tried to stop the import, which then lead to a
lock problem on the contact table. Unable to find a way to clear this,
I killed the database. I did the stupidest thing, rm -rf the
relatamail directory thinking it was bad data. Or maybe this wasn't
stupid; the database came right up and the relatamail db was not
listed anymore. I created a new one, started the import again, and
after a while thought I'd like to do it in verbose mode b/c I couldn't
tell what the hell it was doing. I killed it, and after that, mysqld
wanted to run a very prolonged recovery procedure. So I finally killed
that, after a long consultation with Zlatin, and reinstalled mysql
4.0.13-max (which didn't take more than ten minutes, I still had the
tarball on my mac and the commands were in my superhistory file).

So, once again, keys disabled on contact and mysqlimport is running.



#########################################################################
030812 Tuesday

Finished loading the txt files into blast.corp last night at


home. Super weird: was logged out of Devil and my xterm was closed!
But the Avalon xterm was still open! And I couldn't connect to Devil
from home last night. Stranger and stranger. Checked the crash logs
and the last time an xterm failed on me was August 6th.

First attempt at getting the tax on a package:
<%

Accounts accountsModule                     = resources.getAccountsModule();
Tax taxModule                       = resources.getTaxModule();
ClientRealm[] taxRealms             = new ClientRealm[0];


   try
   {
      taxRealms = taxModule.getClientTaxRealms(accountsModule.getVispMerchantId(sessionkey, ispDn));
   }
   catch (Exception e)
   {
       throw new WizardException("Error getting tax realms", e);
   }
   if (taxRealms.length == 0)
   {
       throw new WizardException("No tax realms available");
   }

%>
 
This won't do me any good, I think.


Teasing apart the Vector class in genericCreditCardAccountConfigCode.jsp:
<!-- added: 0,0 Package -->
<!-- added: 0,1 First Year fee for Super Pak Hosting -->
<!-- added: 0,2 19995 -->
<!-- added: 1,0 Component -->

<!-- added: 1,1 Domain Name Registration -->
<!-- added: 1,2 0 -->
<!-- added: 2,0 Tax -->
<!-- added: 2,1 Tax -->
<!-- added: 2,2 0 -->

explodeString() takes a string with pipes ("|") separating the
contents of the string, returning String[].

(L871)
      costsSeq = productModule._getSetupChargesForPackage(sessionkey, 0, ispDn,
                                                assistant.getAttribute("productId", ""), "", newProductConfig);

Here costsSeq is the stuff from the ProductModule for the productId,
and the third time in the sequence is the pipe delimited string for
Tax.

taxRealmId is not known until after the user has chosen it on the
credit card info page.

Talked over the packageID/costProfile business with swolf, and he
thinks that any given package has one and only one *active* cost
profile.


#########################################################################
030813 Wednesday

select cus_email, cus_FirstName, cus_LastName, cus_Sex, cus_Birthdate,
 cus_City, cus_PostalCode, ctr_CountryID, cst_CustomerTypeID,
 c.con_ConfirmStateID, c.cus_CreateDate, uri_scheme_host,
 uri_scheme_path, sd.pkg_PackageID

from  Customer c, Subscription sb, Subdomain sd  

where sb.org_OrganizationID = c.org_OrganizationID and
 sb.sbs_SubscriptionID = sd.sbs_SubscriptionID;
 


#########################################################################
030814 Thursday

Yesterday, sweating bullets while I tried to wrap up the code changes
to add the VAT tax to HostV3 on Devil. This ended up being three code
blocks across two files, because it was like stringing a noodle
through some spaghetti. In the morning I met with Gautam and it was
productive; followed Angelique's advice to summarize the meeting in an
email so there's a written contract kinda thing.

I worked through Gautam's scripts today and generated the data needed,
in the format needed, for the ampira_customers table. I showed GG the
needed extra columns and how the primary key would have to be
composite. He OK'd it. Only real deal is that he wanted me to import
with -r with mysqlimport.


#########################################################################
030818 Monday

Well. Power outage was Thursday at about 4:10 pm. Within about an hour
it was decided we'd all leave by the staircase. Todd was stuck in an
elevator, and Kevin was caught outside. Cell phones were not working
due to network overload.

On Friday I knew by at least 4pm the block was without power, so the
day was lost. Bloomberg told everyone to stay home, and the trains
were not running anyway.

Couldn't add today's minutes to Twiki because the box is unavailable;
our 10.1.1 network is down. Couldn't access Devil until about
4:30pm. I copied my files off there for the VAT project.

Was running queries this afternoon on db2.fortunecity.com, looking for
more data for Blastmail. There are two tables that are fairly
identical, userdata and userinfo. I found my account has data in the
latter and not the former, but the former has data in it. Gautam says
the database grew organically and to just use the query he sent me (I
presume he means generatebulkusers3.pl, third version of the script he
used that Tim Lloyd wrote).

So I'll drag out the urls for FC users.




#########################################################################
030819 Tuesday

Woke up with a headache that won't go away. Tired again. Maybe it's
from the roach traps I laid out? Only slept so-so, had nightmares
again.

Data for Fortune City: Gautam said to use the query he sent me, which
would be generatebulkusers3, so address info does not go into the
database. Most users don't have any, anyhow.

Hrmm. Seems like just converting commas to tabs, or telling
mysqlimport to use commas (better still) would just solve everything.

FC_customers imported. This mainly associates the URL for the person
with their email.

[bdb-1 input]$ wc -l FC_customers.200?.txt
  279340 FC_customers.2000.txt
  149820 FC_customers.2001.txt
   74886 FC_customers.2002.txt
  139231 FC_customers.2003.txt
  643277 total

Note the total is slightly less that the total number of FC users we
imported. No idea why. I keep puzzling over this USERDATA versus
USERINFO table business.


SQL> select count(*) from users u, userinfo i where u.userid=i.userid;

  COUNT(*)
----------
   1974029

SQL> select count(*) from users u, userdata d where u.userid=d.userid;

  COUNT(*)
----------
    352961

Couldn't do a test of all userids that are in USERINFO and not in
USERDATA. Tim restarted Oracle on me so it might be that my query was
too long.




#########################################################################
030820 Wednesday

Made a chart of stuff done for Blastmail. Lots of stuff done!

I did a dump of the schema on blast.corp only to find that the tables
were all myisam instead of innodb, as I specified in my input sql. I'm
trying to follow the manual on this now. Wish I had my Linux box set
up; it would be faster/easier to do it on a Linux box. MySQL on devil
is doing a very long rollback process since it's been repeatedly
crashed in recent days.

Tried to help Han with a CC problem with a V3 customer, only to find
the ccTransLogReport.vps was returning a mysterious error ("no results
due to an error.") Couldn't track down why, partly because of the file
caching on production (changes I made to the Python file didn't take
effect.)

GG has directed me to add the VAT tax stuff to HostV3 on staging. I'm
on it.

Note Oliver's email is specific to updating existing cost profiles to
use the VAT tax. This is not what we want.

OK, I suck. I just added the VAT for Ampira on staging.

Starting the eftnet gateway:
sudo -s
/usr/ucb/ps -auxwww|grep eftnet
kill pid
nohup /opt/evw/sbin/eftnet.sh 2>&1 >/opt/evw/logs/eftnet_console.log &
/etc/evolutionware/genericcreditcard.sh restart
tail -f /opt/evw/logs/eftnet_console.log 




#########################################################################
030826 Tuesday

Oops. No entry for yesterday. Let me update.

I came in 9ish, started testing Staging. I thought the files were in
place -- indeed, at least hostv3's must have been because I saw debug
output when I viewed source -- but it was because of the changes I
made on Thursday to the database. I was trying to update cost profiles
to correctly charge the VAT tax, but it didn't work (following
Oliver's instructions).

After the meeting I made a backup tarball of the files on staging
(genericCreditCardConfig*jsp) and untarred a ball of the changed
files. Note this is the procedure Eric and Jessy have been using, thus
putting the kabosh on the procedure we'd worked out (commit to cvs,
rollout to staging by cvs update).

I then started testing each visp by hand. This took the rest of the
day. The end result was that Ampira didn't work because costSeq[] has
a different number of elements than the rest of the visps, and
GlobalScape is just flat out broken.

Early this morning I finally renamed .elisp/.emacs to swainlib.el and
byte-compiled everything. Emacs loads way faster now. I cleared out
some files that were never used.

I wanted to include the .emacs I use on devil since it contains some
useful things that were done locally.

;;; Emacs/W3 Configuration
(setq load-path (cons "/usr/local/share/emacs/site-lisp" load-path))
(setq load-path (cons "~swain/.elisp" load-path))

(condition-case () (require 'w3-auto "w3-auto") (error nil))


;; local stops only

;; doesn't work on osx
(setq initial-frame-alist '((width . 115)
                            (height . 57)))


(when window-system
  ;; make pretty
  (setq default-frame-alist '((background-color . "#001f1f")
                              ;;(foreground-color . "#fff0af")
                              (foreground-color . "#ffff90")
                              (cursor-color     . "green")
			      (width . 115)
			      (height . 57))))

;; (setq sw-tail-file-alist '(
;;                           ("resin error log" . "/usr/local/resin/log/error.log")
;;                           ("resin stdout log"  . "/usr/local/resin/log/stdout.log")
;;                           ;;("Product Module log"  . "/opt/evw/logs/ProductModule.log")
;;                           ))

(setq sw-tail-file-alist '(
                          ("generic CC log" . "/opt/evw/logs/GenericCreditCardExtension.log")
                          ("billing log"  . "/opt/evw/logs/Billing.log")
                          ("eftnet log"  . "/opt/evw/logs/eftnet.log")
  ;;                        ("Product Module log"  . "/opt/evw/logs/ProductModule.log")
                          ))



(load "swainlib")

;; more local stuff
(defun sw-servlet ()
  "Jump to the servlet directory."
  (interactive)
  (goto-char (point-max))
  (insert "cd /opt/evw/frontend-hostv3/WEB-INF/classes/com/ampira/cartwizard/servlets")
  (comint-send-input))

(defun sw-jsp ()
  "Jump to the jsp directory."
  (interactive)
  (goto-char (point-max))
  (insert "cd /home/swain/public_html/projects/ampiradev/supportwizard/pages/")
  (comint-send-input))

(defun sw-projects ()
  "Jump to the project directory."
  (interactive)
  (switch-to-buffer (get-buffer "cli"))
  (goto-char (point-max))
  (insert "cd /home/swain/public_html/projects/ampiradev/supportredirector/")
  (comint-send-input))

(defun sw-deploy ()
  "copy war file from my cvs copy to live site"
  (interactive)
  (shell-command "cp ~/public_html/projects/ampiradev/supportredirector/supportredirector.war /usr/local/resin/webapps/")
  (message "war file deployed to devil.")
)

(global-set-key [(meta f5)] 'sw-deploy)


;; set the default command for M-x compile
(setq compile-command
      "cd /home/swain/public_html/projects/ampiradev/supportredirector/; ant -emacs -f build.xml build-war")

;; always scroll the buffer as compilation proceeds...
(setq compilation-scroll-output t)

;; (defun rollout ()
;;   "cvs checkout and all that"
;;   (interactive)
;;   (sw-projects)
;;   (insert "cvs update -d")
;;   (comint-send-input))


(defun do-applescript (&optional args)
  "Tell the user they ain't running Mac OS X."
  (interactive)
  (message "You are not running Mac OS X."))


---

By the way, this 21" monitor is killing my eyes. I think it's because
the focus is fuzzy.

I count 112 forms I filled out today doing testing. That's just by the
numbers, so to speak, not counting extra times I did things. I think
we're ready to roll out signup wizard changes. I tried to do a test
rollout to devil, but it failed due to some hitslink problem. I
emailed Eric for an answer.




#########################################################################
030827 Wednesday

Devil is getting too far out of sync with staging and production to be
used, in some cases. For example, I cannot test my changes to the
SupportRedirectorServlet because the splash.vps pages are not
updated. I will have to do testing on staging.

I am pretty confidant I've found the race condition. The HashMap
userValues was a class level variable, so that's where the race
condition occurred. All I had to do was declare it in doPost() and
change the signature of makeSOAPCall to pass it in. It compiles. Now I
need to test it.


(setq mylist (list 1 2 3 4 5))
(safe-length mylist)
(setq counter (safe-length sw-tail-file-alist))

(defvar sw-log-counter 0 
        "A counter that is used to help iterate over the log buffers.")
(defun sw-next-log ()
  (setq counter (+ 1 counter))
  (setq next-log (% counter (safe-length sw-tail-file-alist)))
  (nth next-log sw-tail-file-alist)
)

(car mylist)
(cdr mylist)

(setq mylist (append (cdr mylist) (car mylist)))

(% 10 7)

;; initial value: 0th item
;; increment it every time sw-next-log is called
;; length(buffer list) modulus counter somehow yields nth buffer
;; 

(% 1 3) ;; 1
(% 2 3) ;; 2
(% 3 3) ;; 0
(% 4 3) ;; 1
(% 5 3) ;; 2
(% 6 3) ;; 0
(% 7 3) ;; 1
(% 8 3) ;; 2

(nth 0 mylist)
(nth 3 mylist)

(devfun)


#########################################################################
030829 Friday

Finally got the new Linux box running. splinter.nyc.fortunecity.net.

He who breaks a thing to discover what it is has left the path of wisdom.
-- Gandalf the Grey

I am still not convinced this stuff for EU VAT is going to work on the
system level. Merchants can only have one taxrealmid. Users can only
have one. A costprofile, supposedly, can have several in the form of a
pipe delimited string.

bash-2.05a$ db2 "select t.taxrealmid, merchantrealmid,name,merchantname  from taxrealm_tbl t, merchants_tbl m wh\
ere merchantrealmid=merchantid and name='EU'"|perl -npe 's/ +$//g'

TAXREALMID  MERCHANTREALMID NAME                 MERCHANTNAME
----------- --------------- -------------------- ---------------------------------------------------------------\
-------------------------------------
        211             131 EU                   VisiHost
        212             192 EU                   HostLive365
        213              71 EU                   GlobalScape
        214             151 EU                   HostBran
        215             191 EU                   HostEfaab
        216              91 EU                   HostV3
        217              51 EU                   FC Gold
        218               1 EU                   Fortune City (Ampira)

  8 record(s) selected.


Here is the table I need to look up user's new taxrealmid.


How to make the list of EU folk:

ldapsearch  -h localhost -p 2000 -D "cn=Directory Manager" -w
"---------" -b "o=FCTY"
"(&(evworgtype=ORG)(|(evwstreetcountry=AT)(evwstreetcountry=BE)(evwstreetcountry=DJ)(evwstreetcountry=FI)(evwstreetcountry=FR)(evwstreetcountry=DE)(evwstreetcountry=GR)(evwstreetcountry=IE)(evwstreetcountry=IT)(evwstreetcountry=LU)(evwstreetcountry=NL)(evwstreetcountry=PT)(evwstreetcountry=ES)(evwstreetcountry=SE)(evwstreetcountry=GB)))"
dn evwstreetcountry > EU.folk

db2 -vf <filename> for running batch files.

I updated almost 1,500 EU customers to have the correct TaxRealmID,
but I doubt they will be charged. When I tested this earlier with the
SQL Oliver provided, tax was charged only if one TaxRealmID was in the
costprofile and it was EU. This will need some testing on Tuesday,
because the Buy Wizard is next, and the report generator.




#########################################################################
030902 Tuesday

Yesterday was Labor Day.

Met with GG about tasks for the coming week; meeting at 11am as
usual. Generated list of email addresses for EU customers affected by
the changes I made Friday; I have to work out the issue with the Buy
Wizard next.

How to use a series of filters from a file with ldapsearch:

ldapsearch -h evw-1.dev.ampira.com -p 400 -f adminfilter -D "cn=Directory Manager\
" -w 11223344   -b "o=DMFC" "%s" dn

where the file "adminfilter" contains one line:

(username=admin)

and it has to have a carriage return. The man page sucks ass,
unfortunately. It took some experimentation to get this to work. This
would, however, allow me to break up the EU query into a series of
lines, which is more practical. It would read: 

(&(evworgtype=ORG)(evwstreetcountry=AT))
(&(evworgtype=ORG)(evwstreetcountry=BE))
(&(evworgtype=ORG)(evwstreetcountry=DJ))

and so on. It might be less efficient though, since we make 15 queries
and traverse the tree 15 times.

Finding all EU clients who have an installed product:

#!/usr/bin/perl

# start with:
# ldapsearch -h evw-1.dev.ampira.com -p 400 -f eufilter -D "cn=Directory Manager" -w 11223344   -b "o=DMFC" "%s" dn > eu.in

# where eufilter contains:
# (&(evworgtype=ORG)(|(evwstreetcountry=AT)(evwstreetcountry=BE)(evwstreetcountry=DJ)(evwstreetcountry=FI)(evwstreetcountry=FR)(evwstreetcountry=DE)(evwstreetcountry=GR)(evwstreetcountry=IE)(evwstreetcountry=IT)(evwstreetcountry=LU)(evwstreetcountry=NL)(evwstreetcountry=PT)(evwstreetcountry=ES)(evwstreetcountry=SE)(evwstreetcountry=GB)))

open INFILE, "<eu.in" or die $!;

while (<INFILE>) {
    next unless /\w/;
    chomp;
    #print "$_\n";
    print `ldapsearch -h evw-1.dev.ampira.com -p 400 -D "cn=Directory Manager" -w 11223344   -b "$_" "objectclass=evwInstalledProduct"`;
    print "\n";
}


Narrowing costprofilecomponents to visp:

db2 "select taxids from costprofilecomponent where costprofileid in
(select costprofileid from costprofile where productmerchantid=1)"



#########################################################################
030903 Wednesday

"Even if you are on the right track, you'll get run over if you just
sit there" - Will Rogers

At the end of the day yesterday I filed a ticket for the problem of
VAT charged via the Buy Wizard. Oliver took it.



#########################################################################
030904 Thursday

Was embroiled in a bug hunt yesterday where certain chars cause the
JNDI query to fail. That took me to 630pm.

sub stripnulls {
    my $thing = shift;
    #print "null in $thing\n" if ($thing =~ m/\x0/);
    $thing =~ s/\x0//g;
    return $thing;
}

by the way.


#########################################################################
030905 Friday

Yesterday was consumed with finding bad CVV2 info and connecting that
info to user data in LDAP. I put forth here in my log that there are
two fundamental design flaws with our vendor's product:

1) Data is divided between LDAP and DB2. This results in a lot of
   script writing to do what would be a trivial JOIN operation were it
   all in DB2. There is nothing wrong with wanting the info stored in
   LDAP for optimization, but LDAP should always be generated from DB2
   and not maintained on its own.

2) EVW divides its data amongst three database instances: product,
   system, and billing. This is going away in the next major version
   of EVW though.

This leaves me kind of lost this morning because I've been pulled in
so many directions the last three days. I still have to solve the bug
with SupportRedirector: non-ASCII chars in the orgDn cause the LDAP
query to fail. Before that, I was working on an install of WebEditPro;
I need to work with Gautam on spec'ing the reporting tool mgmt wants
for the VAT stuff.

Stats on splinter.nyc.fortunecity.net, my GNU/Linux box:

P398
196MB RAM
6 BG HD



#########################################################################
030908 Monday

On Friday, fixed the bugs with SR. For account 'sveinhk' of V3, the
problem was a non-ASCII char. For account 'teamamp' of Ampira, it was
a forward slash which is a metachar for the Name interface in
javax.naming.directory.

CVV2 procedure: log into evw-1.prv. 
cd cvv2
mv cvv2.out cvv2.out.date

run:
db2 "select cvv2, organisationdn, cardholdername from
genericccclientaccinfo, accounts, accountholders where
genericccclientaccinfo.accountid=accounts.accountid and
accounts.accountholderid=accountholders.accountholderid" > cvv2.out

Run that through filter.pl in that directory. Note that cvv2.out
should be larger than the previous version.

Email addresses were validated on 'somebox' (65.244.88.220) in
/opt/swain/blastmail. It's not necessary to do it again. We need to
compare userDns against the already-validated list.

Sending a blastmail:

log into blast.corp via bastion
cd /opt/apache/share/htdocs/blastmail/wwwroot/admin
cp blast2.php.dynamic blast2.php
cd ../user
cp sendtestemail.php.dynamic sendtestemail.php

log into blastmail interface: http://blast.corp.ampira.com/index.php
see note on login info
check CVV Notice
get email message from Peter or equivalent
check code for example, but it's like <firstname> <lastname> <visp>



#########################################################################
030909 Tuesday

Rob asking for contact info of bad email address people. Good-o, turns
out I already generated a tab delimited file of same.

Downloaded Eclipse and gave it a quickie try. Couldn't get Hello,
Sailor! to print to the console, though I don't know where I did
something wrong.

WebEditPro: for starters, index.php calls webedit.php. This file is
114 pages long (my display shows 46 lines a time; if we consider the
standard terminal window of 80x24, then webedit.php is really 218
pages long). The code is not consistently formatted and uses global
variables.

Super heavy javascript reliance. Would have to be tested with lots of
browsers, or at least, lots of IE versions.

The architecture is really monolithic. The one 5,248 line file uses a
long long series of if/else statements to decide which .inc file to
include.

One monolithic table. All content stored in flat files. (how will
searching work?) Will we need a new install for every customer?


#########################################################################
030910 Wednesday

Doh. Forgot to run the collection script yesterday. I'm working on the
cron job right now.

First thing I found is: 
      echo "foo" | mail swain
doesn't work. But mail to swain@ampira.com does work.

0 9,22 * * *
~/src/ampiradev/EVWcreditCardGateway/gateways/eftnet/scripts/eftnetSettlement.pl
|/bin/mail -s "EFTNet Settlement Report `/bin/date '+%D %p'`" -c
rob@ampira.com -c swolf@ampira.com  gautamg@ampira.com

OK, so he had the mail part right... the 'date'  must be hosing
things. Yup. In the syslog I could see the thing getting truncated in
the 'date' part. Putting it into a shell script fixed it.

WebEditPro uses the $_GET array, which is PHP 4.1 and later.

We alst get code like this:

$aaaaaaaqrkl = @$_GET["aaaaaaaqrkl"]; if($aaaaaaaqrkl == "") { $aaaaaaaqrkl = @$_POST["aaaaaaaqrkl"]; }
$aaaaaaazbkx = @$_GET["aaaaaaazbkx"]; if($aaaaaaazbkx == "") { $aaaaaaazbkx = @$_POST["aaaaaaazbkx"]; }

On splinter, to make the TAGS file:
   ctags -e `find . -name \*.php `

The rpm package does not replace etags, nor does it even have it.

It absolutely requires an FTP server for uploading files.

Admin forms do not work in Safari, are really whacked in Mozilla but
appears to work.

Could not log out properly, had to restart IE.


#########################################################################
030911 Thursday

Note today is the second anniversary of 9/11.

Sent report last night; settlement script ran fine last night and this
morning.

According to Lysa, who is also trying to install WebEditPro, her
version does not use ftp and requires the directory to be set 757. We
must have gotten an alpha version of the software.




#########################################################################
030912 Friday

webedit.php uses large blocks of duplicated, copy-and-pasted code. It
has extremely poor error messages. Support for this product is going
to be difficult. Example:

   An error occured while trying to upload 'Sample.jpg'. Please try
   again.

(grammatical error is theirs)

Since there is no log file, one has to grep the php file for the
error, and the code doesn't give any indication as to the failure
either.

I spent a long time trying to debug the file upload. I mistakenly
thought it wasn't using ftp but it was... it writes out a temporary
file first on the localhost. It then ftps it to the ftp server. But it
wasn't working because it was in the wrong directory somehow. Probably
another configuration issue.




#########################################################################
030916 Tuesday

Yesterday, worked on solving a problem for Christina where a user was
declined. Moved splinter to the DMZ and configured it; today I sent an
email to Mitchell about Web Edit Pro and hopefully he can debug the
setup.

Spent the morning grokking the email from SF and Oliver on the fix for
the VAT.

Updating costProfileComponent with the correct taxIds:

db2 "update costProfileComponent set taxIds ='41' where costprofileid
in (select costprofileid from costprofile where productmerchantid=1)"

Unfortunately I've worked this whole scenario twice... but basically
it's an amalgamation of Oliver's stuff.

Now I remember. All my work was recorded in the shell buffer auto save
files.

I think my approach might work on a higher level than SF's. I query
for client realms for this merchant, then interate over those. I never
look at the taxstructures.

Spent 1.5 hours in a meeting with Peter.

#########################################################################
030917 Wednesday

Went over spt-1.prv with Han; he's trying to come up with a log
rotation strategy. Helped Eric with a Java problem. Cleared out email.


  490  db2 connect to evw user evwbill using 112233
  493  db2 "describe table accounts"
  494  db2 "select distinct(status) from accounts"
  495  history |grep db2
  502  history|grep db2
  503  db2 "select merchantId,merchantName from merchants_tbl"
  504  db2 connect to evw user evwbill using 112233
  505  db2 "select merchantId,merchantName from merchants_tbl"
  507  db2 "select taxStructureID, name, taxRate, description from taxStructures_tbl where merchantRealmID =1"
  509  db2 "select taxids from costprofilecomponent where costprofileid in (select costprofileid from costprofile where productmerchantid=1)"
  510  db2 "select taxrealmid, merchantrealmid, name from  taxrealm_tbl"
  511  db2 "select taxstructureid, merchantrealmid, name from taxstructures_tbl"
  512  db2 "select taxids from costprofilecomponent where
  costprofileid in (select costprofileid from costprofile where
  productmerchantid=1)"

Hrmm. I may have made a faulty assumption: productMerchantId does not
match up with merchantId.

Aha! There are two merchants_tbl tables. One in evwbill and one in
evwprod. They probably had to do this to make it easier to do a lot of
operations.

db2 "update costprofilecomponent set taxids="1,181" where
costprofileid in (select costprofileid from costprofile where
productmerchantid=1)"

So far, it ain't working. Query:

db2 "select tr.taxrealmid, ts.taxstructureid, tr.name from
taxrealm_tbl tr, taxrealmdetails_tbl trd, taxstructures_tbl ts where
ts.taxstructureid=trd.taxstructureid and tr.taxrealmid=trd.realmid"

shows how taxRealmId relates to taxStructureId:


TAXREALMID  TAXSTRUCTUREID NAME                
----------- -------------- --------------------
          1              1 US Customers        
          2              2 US Customers        
         21             21 US                  
         62             62 US Customers        
         81             81 US Customers        
         82             82 US Customers        
        101            101 US Customers        
        121            121 US Customers        
        141            141 US Customers        
        161            161 European Union      
        181            181 EU                  
        182            182 EU                  
        201            201 EU                  
        202            202 EU                  
        203            203 EU                  
        204            204 EU                  
        205            205 EU                  

  17 record(s) selected.


[swain@evw-1 vat]$ db2 "update costprofilecomponent set taxids='1,181' where costprofileid in (select costprofileid from costprofile where productmerchantid=1)"
DB20000I  The SQL command completed successfully.
[swain@evw-1 vat]$ db2 "select distinct(taxids) from costprofilecomponent"

TAXIDS                                                                                                                                                
------------------------------------------------------------------------------------------------------------------------------------------------------
1,181                                                                                                                                                 
41                                                                                                                                                    

  2 record(s) selected.

So note that they were all 41 to begin with, but I don't recall if I
did that. Not that it should matter... I have the correct
productMerchantId (1).

OK, stuff works. I just needed to GRANT permissions to evwprod to some
evwbill tables.


show them, update them:
  537  db2 "update costprofilecomponent set taxids='1,181' where costprofileid in (select costprofileid from costprofile where productmerchantid=1)"
  538  db2 "select taxids from costprofilecomponent where costprofileid in (select costprofileid from costprofile where productmerchantid=1)"

get the list of billingIds:
db2 "select billingid, taxids from costprofilecomponent where
costprofileid in (select costprofileid from costprofile where
productmerchantid=1) and billingid <> 0"

                                   


#########################################################################
030918 Thursday

Yesterday I got two accounts created, made sure they were taxed right,
bought additional email accounts for one of them and made sure that
was right. So far I've copied over the new wizard files to the signup
and buy wizards for ampira on staging. They will have to be reconciled
with the originals still (the terms of agreement are missing.)

The day started with an email from Mitchell who can't seem to login to
Splinter even though I gave him the IP address of the box. I found
that the mysql cli tools all fail with the same error now, though:

mysql: relocation error: /usr/lib/mysql/libmysqlclient.so.10:
undefined symbol: fio_keepalive 

Nothing on Google. The tools worked fine before... my only guess is it
has something to do with changing the ip address. PHP has no
problem. GG thought it might be a library issue, but since this is a
totally stock box with no mods that seems unlikely; but he correctly
points out that the box was rebooted. Hrmm. I wonder if it was
rebooted while still on the 192.168 network.

Found that some jobs needed pushing through; unbelievably I forgot to
clear the registrar. I just did this stuff last February.

It's freezing in here today.



#########################################################################
030919 Friday

Late yesterday, worked out some of the details for the Java needed for
the revamped wizard pages. I was indeed able to set the taxRealmId but
now I also have to be careful to set it for all customers... so in the
long run if there are other taxes to be added, some refactoring will
be needed.

Gautam set a meeting for 10am, I think about Blastmail, and it's 10:18
and he's still not here.

Probable solution for VAT:

///////////////////////////////////////////////////////// start ampira code

    ClientRealm[] taxRealms = null;
    Tax taxModule = resources.getTaxModule();

try {
    taxRealms = taxModule.getClientTaxRealms(module.getVispMerchantId(sessionkey, ispDn));
} catch (Exception e) {
    throw new WizardException("Error getting tax realms", e);
}

if (taxRealms.length == 0) {
    throw new WizardException("No tax realms available");
}

out.println("<!-- taxRealms[] length: " + taxRealms.length + " -->");

if (needVATTax(assistant.getAttribute("physicalCountry", null))) {
    out.println("<!-- hey I need the VAT. Imagine that, to need the VAT. -->");
    for (int c = 0; c < taxRealms.length; c++) {
        out.print("<!-- number: " + c + " taxrealm: " + taxRealms[c].name);
        out.println(" id: " + taxRealms[c].id + " -->");
        //    if ("EU".equals(taxRealms[c].name)) {
        if (taxRealms[c].name.indexOf("EU") != -1) {
            assistant.setAttribute("taxRealmId", String.valueOf(taxRealms[c].id));
            break;
        }
    }
} else {
    out.println("<!-- don't need the VAT, ain't down with that. -->");

    for (int c = 0; c < taxRealms.length; c++) {
        out.print("<!-- number: " + c + " taxrealm: " + taxRealms[c].name);
        out.println(" id: " + taxRealms[c].id + " -->");
        if (taxRealms[c].name.indexOf("EU") == -1) {
            assistant.setAttribute("taxRealmId", String.valueOf(taxRealms[c].id));
            break;
        }
    }
}


    String tri = assistant.getAttribute("taxRealmId", "");
    out.println("<!-- taxRealmId: " + tri + "-->");

//////////////////////////////////////////////////////// end ampira code


taxrate.jsp is clipped to just one function:

<%!

double taxrate;

public boolean needVATTax(String countryCode) {

    // The hash values are included here for documentation.
    HashMap cCodes = new HashMap();
    cCodes.put("AT","Austria");
    cCodes.put("BE","Belgium");
    cCodes.put("DJ","Denmark");
    cCodes.put("FI","Finland");
    cCodes.put("FR","France");
    cCodes.put("DE","Germany");
    cCodes.put("GR","Greece");
    cCodes.put("IE","Ireland");
    cCodes.put("IT","Italy");
    cCodes.put("LU","Luxembourg");
    cCodes.put("NL","Netherlands");
    cCodes.put("PT","Portugal");
    cCodes.put("ES","Spain");
    cCodes.put("SE","Sweden");
    cCodes.put("GB","United Kingdom");

    if (cCodes.containsKey(countryCode))
        return true;
    else
        return false;
}
%>


A note on pushing jobs through: after submitting, go into Billing
Admin -> Credit Card -> Vetting Mgmt -> Customers Awaiting Vetting,
and approve the account. Search for the job and submit it; when it's
waiting on DNS provisioning, go into Registrar and approve that. Push
the job the rest of the way.

No changes to the Buy Wizard, it would seem. Tax applied correctly.

OK, summary time... I abstracted the code out to one file, vat.jsp. I
left the GUI diffs to Eric. I documented the changes in Twiki and
talked the stuff over with him.

I did tests by buying stuff on staging with the vatpatch* accounts,
and bought upgrades too. Taxing worked as advertised.

On Monday I need to apply SQL changes to each visp. Jessy says efaab
and showbran are dead now, so we don't need to make changes for them.

Gautam wanted to meet today about Blastmail at 10am, this has been put
off until Monday morning.

Gautam asked for a list of users who have their cvv2 set to 111. I
count 490 of them:

db2 "select cvv2, organisationdn, cardholdername from
genericccclientaccinfo, accounts, accountholders where
genericccclientaccinfo.accountid=accounts.accountid and
accounts.accountholderid=accountholders.accountholderid and
(cvv2='111' or cvv2='1111')" > 111.out

Wrote back and asked how he wanted that data.



#########################################################################
030923 Tuesday

Today: meeting at 11:00am for hosting planning... that is, Peter's
SWOT meeting. Unfortunately I didn't have much to say in my email on
Friday, but what I did say ("five nines") he did repeat, as well as my
Maytag Repairman bit. Anyway eight committees will look at a long list
of things. I'm on development, systems, support.

Second meeting was at 2:30, and was planning for Pretty Girl, the
project to bring Ugly Boy to FC Gold as well as make an upsell path
from the free site to the paid site; one primary path will likely be
domain name plus forwarding for the free hosting. I found it useful to
think of the free site as "free hosting," since it is. I have always
jammed it into the category of "like Tripod or Geocities" and not
given it much more thought.

Eric finished stuff for VAT and I spoke with Swolf about whether to
rollout without a line item in the customer invoice, and without being
able to test recurring charges. He said to wait until tomorrow since I
just updated my ticket on recurring charges and he updated the line
item ticket today.

Looked over Jessy's spec on a site building tool. So far WebEditPro is
not working out for us. Two weeks later, it's still not working. I
reconfigured Splinter this morning, applying security patches for
OpenSSH, Apache, PHP and MySQL, as well as up2date. I tested the
account settings for 'test' and found a couple problems I fixed up.

There is a long list of things I'd like to investigate but don't have
a lot of time to do so... also Gautam has been talking about talking
about Blastmail since Thursday.

fortunecity:
username: blippy
password: tyekormh

Hrmm. Couldn't login via ftp.




#########################################################################
030924 Wednesday

Again, Mitchell from WebEdit fubar'd the config for the test user;
can't blame him, a 10.1.1.207 address from his point of view is
inaccessible, though his browser should never see it.

GRANT statements complete on production; emailed Sunil to upgrade the
module binaries. Wrote out the SQL for updating tax structures, will
have to do the billingIds by hand as on production. No update on my
ticket overnight. Bleh.

Went through todos, notes, etc. and organized them. Gonna find all
rejects files now.

Rejects files are now on devil in /opt/swain/blastmail/rejects. I
don't see the rejects file for ampira though... although there is a
rejects.txt file on 10.1.1.50.

Moving this file back to devil, or maybe splinter.

Done. I'm going to review what I did for blastmail. We need to finish
up this project.

Well, my log entries are of some help. Nothing in Twiki, which is
where it really should be...

Rebuilding 'relatamail' db on devil. Started it under screen.

contact_list and contact_message were supposed to be cleaned up, but
to my knowledge have not been. First discrepency between relatamail
and blastmail databases. Also need v3_customers. I think with the
importation of a few more tables like "lists" it might be done.




#########################################################################
030925 Thursday

Revisiting the problem with MyISM versus InnoDB: it works fine on
devil (tables created are InnoDB) but not on blast.corp (bdb-1).

I never wrote down the way to load data without indexing, so now I
have to figure it out all over again.

Earlier in the day: SF ticket update phone call with Ranier which was
totally useless (Oliver is on vacation and basically everything is on
hold until he comes back). Ran sql to update tables for VAT, tried to
find a job of mine in the queue on production (Sunil asked me to
clear it) but it couldn't be found. Zlatin found it in a database
table. I would like to hack a java program to explore/display stuff
for the job system.

vat.jsp: I changed the method name needVATTax to needVAT but Eric did
not, so that brought the whole works to a halt on app-2... Sunil was
off yesterday and "working from home" (though my email went
unanswered about a rollout) so he moved the binaries live today for
ProductModule and BillingModule... BillingModule cored shortly after,
but it did yesterday too so I'm gambling there's no connection. Anyway
I sent another email for a frontend rollout but I think he went home
for the day.




#########################################################################
030926 Friday

Zlatin say: for any property there is app-1, app-2, secure and evw-1
addresses. Example:

app2.fortunecitygold.com

This makes it simple to look up the ip address I need for my hosts
file.

Long day of drawn out testing as Sunil repeatedly puts the wrong files
up on app-2.

Sent email advocating deletion of dead and dying visps. Eric
concurred. Swolf says save hostgs and demohost.




#########################################################################
030929 Monday

Emailed to rollout VAT today. 11am meeting, took notes. Chatted with
GG about Blastmail, told him I'd work out the reduction queries by
COB, and spent last night and this morning looking at space issues for
Blastmail on Devil. I deleted the old innodb files, but disk space was
not freed... I wonder if I have to bounce MySQL. Bingo! Space freed. I
wonder if it's going to stare at its navel now... nope! Good deal.

3pm meeting coming up, first Development meeting, me, GG and Jessy.

The issue with cleaning up some of these Relatamail tables is: we need
to do a cascading delete, which MySQL doesn't support.

Select all messages in table "message" older than six months old,
joining on "blast_log."

mysql> show index from contact_list;
select entry_date, from_days(to_days(entry_date)) from blast_log;

-- blast_log entries older than six months
select entry_date from blast_log where entry_date < '2003-04-01';

-- contact_message messages older than six months, takes 1:12 minutes
-- to run.
select count(*) from contact_message where time_date_sent > '2003-04-29';

table contact_message: time_date_undeliverable has only 66 instances
where = '', and no nulls.

select distinct(list_number) from contact_list where subscribe_date <
 '2003-04-29' into outfile '/tmp/oldlistnums';

select * from message where date_sent < '2003-04-29' into outfile
'/tmp/messages_2003';

select * from list where number not in
(1,2,3,4,5,6,7,8,9,10,11,46,19,18,16,15,14,13,12,23,24,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,47,48,49,51,52,55,56,57,58,59,69,68,67,66,65,64,63,61,60,70,71,72,73,74)
into outfile '/tmp/list_2003';

Dig:

mysql> lock table contact_list write;
Query OK, 0 rows affected (0.00 sec)

mysql> load data local infile '/tmp/contact_list_2003' into table contact_list;
Query OK, 573057 rows affected (52.84 sec)
Records: 0  Deleted: 573057  Skipped: 0  Warnings: 0

mysql> unlock table;
Query OK, 0 rows affected (1.71 sec)



#########################################################################
031002 Thursday

Out the last two days with a cold... I was home the entire time, save
for a trip to the post office Tuesday and Duane Reade on Wednesday; I
monitored my email and AIM most of the time. I don't feel 100% yet but
I'm hoping the worst is passed. I'm off tomorrow for a personal day.

Chatted with Swolf when I came in about Blastmail and VAT
issues. Seems there is a billing problem that is the fault of SF. I
think I can see how it happened. One of the fixes they made was to use
the user's taxrealmid correctly... that might be the culprit.

There was some problem with the recent rollout and I have to talk to
Zlatin about it. VAT might be the culprit.

Nope, just spoke to him. It was his hosts file.

-- distribution spread for all users who have undeliverable counts
select distinct(undeliverable_count), count(*) from contact group by
undeliverable_count;

Two scripts done, one to remove anyone with five or more
undeliverable_count and one to update anyone with four or less (but
more than zero).

Meeting today at 11am, for support. I missed the systems meeting
yesterday.


Conversation with Oliver on how to test recurring charges: they have a
test mode for the Billing Module. When it is in test mode it runs
every ten seconds, incrementing the hour by one. You can see this when
you are tailing the Billing.log:

[Thu Oct  2 12:18:13 2003 |000|BillingThread                                |BillingThread::search \
        ][24] Recurring costs tracking. Year=2003. Month=9. Day=19. Hour=10.
[Thu Oct  2 12:18:13 2003 |000|BillingThread                                |BillingThread::search \
        ][24] Successfully performed the search for recurring costs.
[Thu Oct  2 12:18:23 2003 |000|BillingThread                                |BillingThread::search \
        ][24] Performing the search for recurring costs.
[Thu Oct  2 12:18:23 2003 |000|BillingThread                                |BillingThread::search \
        ][24] Recurring costs tracking. Year=2003. Month=9. Day=19. Hour=11.
[Thu Oct  2 12:18:23 2003 |000|BillingThread                                |BillingThread::search \
        ][24] Successfully performed the search for recurring costs.
[Thu Oct  2 12:18:33 2003 |000|BillingThread                                |BillingThread::search \
        ][24] Performing the search for recurring costs.
[Thu Oct  2 12:18:33 2003 |000|BillingThread                                |BillingThread::search \
        ][24] Recurring costs tracking. Year=2003. Month=9. Day=19. Hour=12.
[Thu Oct  2 12:18:33 2003 |000|BillingThread                                |BillingThread::search \
        ][24] Successfully performed the search for recurring costs.
[Thu Oct  2 12:18:43 2003 |000|BillingThread                                |BillingThread::search \
        ][24] Performing the search for recurring costs.
[Thu Oct  2 12:18:43 2003 |000|BillingThread                                |BillingThread::search \
        ][24] Recurring costs tracking. Year=2003. Month=9. Day=19. Hour=13.
[Thu Oct  2 12:18:43 2003 |000|BillingThread                                |BillingThread::search \
        ][24] Successfully performed the search for recurring costs.


Stop the billing module. Reset the timestamp
schedulesSearch_tbl.lastSearchUTC. In this case he set the timestamp
to the date of the last billing (doing math on the timestamp). Change
the config file for the billing module in etc and set the billing
module to test mode. tail the output of the Billing.log. Test account
on staging was vatpatchEU.



The secrets to churning out a report for VAT customers charged in the
last month are in genericCCTransLog.vps.

Spelunking paid off:

bash-2.04$ db2 "select journaltimestamp, balance from journal where accountid=23648"|more

JOURNALTIMESTAMP BALANCE    
---------------- -----------
      1065035097        2078
      1065035115           0
      1064315446           0
      1064315453        2998
      1064320670        -479
      1064782983        9520
      1064782984           0

  7 record(s) selected.

I found how to find negative balances.

Narrowing to the dates of the first vat rollout:

bash-2.04$ db2 "select count(*) from journal where journaltimestamp >
1062132475 and journaltimestamp < 1064810875 and balance < 0"

yields:
-----------
        288


-- Select all organisationDns where: their last invoice was between Aug
-- 29 and September 29, and their country code is an EU country, and they
-- have a negative balance.

db2 "SELECT organisationdn FROM accountholders, accounts WHERE accounts.accountholderid = accountholders.accountholderid AND accounts.accountid=invoices_tbl.accountid AND accounts.accountid IN (SELECT accountid FROM journal WHERE journaltimestamp > 1062132475 AND journaltimestamp < 1064810875 AND balance < 0)" > suspects.list

Meet with GG on Blastmail early Monday. Enter the procedure for
recurring testing that Oliver showed you.


#########################################################################
031006 Monday

Came in to a dead Mac. It looks like the Quantam drive failed.

Put the info into Twiki for testing recurring charges.

Email to GG re: Blastmail remaining tasks:

As per our meeting, here's the breakdown:

1. Performance tuning, configuring InnoDB, testing:

Performance tuning will involve turning on the slow queries log and monitoring for queries that take too much time/resources.

Configuring InnoDB: for some reason InnoDB works on Devil but not on production. This is a configuration difference that has to be resolved.

Testing: We will turn on SAR during a blast; we will need someone in ops to assist.

2. PHP upgrade

This affects bdb and bmp. From past experience, an upgrade of PHP means getting the right compile options, compiling, and testing. If these machines have something unusual in their builds (example: PHP is compiled into Apache, necessitating an Apache recompile) it will take the better part of a day, otherwise this should be doable in a few hours.

3. Review bounced email handling

A meeting with Ops has to come first on how to handle them. An interface  for domains would follow -- basically incrementing the undeliverable_count by one. 

We also would need to provide a magic list of domains that we wouldn't want incremented (obvious examples: yahoo.com and hotmail.com). We could provide a distribution count of domains showing the most common domains used by customers (e.g. hotmail, yahoo) down to vanity domains that have  one or a few email addresses.

4. Process for RBL handling

Whose job is it to track RBL (realtime black listing) status? This needs to be assigned to someone.

5. Setting up scheduled maintenence items

a. Delete lists older than six months
b. Delete messages older than six months
c. Delete customers whose undeliverable_count exceeds 2
d. Delete blast_log entries older than six months

6. Setting up scheduled transfer of new/changed customers from 3 properties

This could be done via a simple HTTP POST operation or (more elaborately) via SOAP. Using POST will allow us to use the existing interface to update the CUSTOMERS table; using SOAP, or extending the Relatamail interface, would allow us to add data to the auxillary tables  (ampira_customer, fc_customer, v3_customer).

Early estimates:

1: Enabling InnoDB might take an hour or two to figure out (conf file changes) and then we'd just use ALTER TABLE commands which can run overnight. Performance tuning will be ongoing and will have to happen when we send out a blast.

2. PHP upgrade: 1-3 hours for the first machine, probably less than an hour for the second

3. Review bounce handling: pending a meeting with Ops

4. Process for handling RBL: pending Swolf's decision on who has responsibilty

5. Setting up scheduled maintenence: On hold until a meeting happens to decide bounce handling. 1 to 1.5 days to write queries, script them, cron them IFF the Perl DBD driver for Mysql is on blast.corp.

6. Setting up scheduled transfers: deferred until the completion of above tasks. I have to do a short evaluation of options for this, though.

Gautam Guliani wrote:
> Let's discuss when you've had a chance to review
> 
> 
> 
> Roughly the list of tasks remaining:
> 
> * perf tuning of mysql 4 settings, configure innodb, lots and lots of 
> testing
> * php upgrade (security related) and testing
> * review bounce handling
> * process for RBL handling (need to educate ops and probably write a 
> script for them)
> * setting up scheduled maintainence items (queries to run every day)
> * setting up scheduled transfer of new/changed customers from 3 
> properties (soap xml but leave this as last item, optional in this phase)
> 
> 
> 
> 


Kevin installed a new 10GB HD and installed OS X 10.1. I will bring
in Jaguar tomorrow to upgrade it.

Note that on bdb-1 you've got last-sql, last-cli and last-shell which
contain all the SQL you wrote when you were working on queries for
Blastmail. In particular they contain the preliminary queries to trim
data.

Also note that bdb-1 has both master and slave mysql dbs. One is on
/tmp/mysql-m.sock and the other on /tmp/mysql-s.sock.

InnoDB is just commented out in the my.cnf files on bdb-1. I'm
wondering how big a file size is allowed on Solaris?


#########################################################################
031007 Tuesday

I figured out the procedure for enabling InnoDB on production (my.cnf
changes, primarily uncommenting lines that configure InnoDB), and GG
said to forward it to Ops and have them do it.

I now have six meetings to attend this week: Dev, Support, Systems,
tomorrow morning an Ampira mailing meeting, PrettyGirl, the ticket
meeting. I already had two meetings yesterday.

Coolness. I don't need Perl to do the database trimming. I can use
temporary tables, which have automagic qualities thanks to the mysql
developers:

mysql> create temporary table old_listnums select distinct(list_number) from contact_list \
where subscribe_date > '2003-05-31';
Query OK, 11 rows affected (13.16 sec)
Records: 0  Duplicates: 11  Warnings: 0

mysql> select * from old_listnums;
+-------------+
| list_number |
+-------------+
|          75 |
|          76 |
|          77 |
|          78 |
|          79 |
|          80 |
|          81 |
|          82 |
|          83 |
|          84 |
|          85 |
+-------------+
11 rows in set (0.00 sec)

mysql> 


Here we create a table of old list numbers (the list IDs) which we can
join against... and when the connection is severed the temporary table
is automatically dropped.


Here's the 'make install' output. I moved the old /opt/php to
/opt/php-4.2.2-old.


[bdb-1 php-4.3.3]# make install
Installing PHP CLI binary:        /opt/php/bin/
Installing PHP CLI man page:      /opt/php/man/man1/
Installing PHP SAPI module:       apache
[activating module `php4' in /opt/apache/etc/httpd.conf]
cp libs/libphp4.so /opt/apache/libexec/libphp4.so
chmod 755 /opt/apache/libexec/libphp4.so
cp /opt/apache/etc/httpd.conf /opt/apache/etc/httpd.conf.bak
cp /opt/apache/etc/httpd.conf.new /opt/apache/etc/httpd.conf
rm /opt/apache/etc/httpd.conf.new
Installing shared extensions:     /opt/php/lib/php/20020429/
Installing PEAR environment:      /opt/php/share/pear/
[PEAR] Archive_Tar    - installed: 1.1
[PEAR] Console_Getopt - installed: 1.0
[PEAR] PEAR           - installed: 1.2.1
Wrote PEAR system config file at: /opt/php/etc/pear.conf
You may want to add: /opt/php/share/pear to your php.ini include_path
[PEAR] DB             - installed: 1.5.0RC1
[PEAR] HTTP           - installed: 1.2.1
[PEAR] Mail           - installed: 1.1.1
[PEAR] Net_SMTP       - installed: 1.2.3
[PEAR] Net_Socket     - installed: 1.0.1
[PEAR] XML_Parser     - installed: 1.0.1
[PEAR] XML_RPC        - installed: 1.0.4
Installing build environment:     /opt/php/lib/php/build/
Installing header files:          /opt/php/include/php/
Installing helper programs:       /opt/php/bin/
  program: phpize
  program: php-config
  program: phpextdist
[bdb-1 php-4.3.3]# /etc/init.d/apache restart
httpd restarting.


Something appears to be wrong with the configuration for Apache
though. The server doesn't understand the MIME type.

Weird. You have to call index.php by name; for some reason in
httpd.conf we see:

Options +Includes -Indexes

Now that that's sorted, we get:

Fatal error: Cannot redeclare clear_parse() in
/opt/apache/share/htdocs/blastmail/wwwroot/class/fast_template.php on
line 636

When I compiled PHP on bdb-1 the Apache apsx file wouldn't run... it
called /bin/perl and complained about strict.pm not being in @INC.

A sample query from the ccTransLogReport.vps:

SELECT accountHolders.clientName, genericCcTransactionLog.accountId,
genericCcTransactionLog.transactionType,
genericCcTransactionLog.dateUTC,
genericCcTransactionLog.cardHolderName,
genericCcTransactionLog.lastFourDigits,
genericCcTransactionLog.expiryDate, genericCcTransactionLog.avsData,
genericCcTransactionLog.amount, merchantAccounts_tbl.currency,
genericCcTransactionLog.journalImpact, genericCcTransactionLog.evwRef,
genericCcTransactionLog.gatewayRef,
genericCcTransactionLog.gatewayMessage, accountHolders.organisationDn,
genericCcTransactionLog.status FROM merchantAccounts_tbl,
genericCcTransactionLog LEFT OUTER JOIN accounts ON accounts.accountId
= genericCcTransactionLog.accountId LEFT OUTER JOIN accountHolders ON
accountHolders.accountHolderId = accounts.accountHolderId WHERE
genericCcTransactionLog.merchantAccountId = 61 AND
genericCcTransactionLog.timeStamp >= 1064980800.0 AND
genericCcTransactionLog.timeStamp <= 1065585601.0 AND
merchantAccounts_tbl.merchantAccountId =
genericCcTransactionLog.merchantAccountId ORDER BY
genericCcTransactionLog.timeStamp

1) calculate the Epoch times for the month (example: Aug 1, 12am to
   Aug 31, 11:59:59)

2) Run query against DB2

3) Run returned accounts against LDAP and filter for EU countries

4) format report (Excel-compatible format)

This looks, max, like a day and a half of work, but should hopefully
be less.


#########################################################################
031008 Wednesday

GG out sick today. Found the problem on bdb-1: error reporting was
turned off in php.ini and the same method redeclaration was happening,
just not being reported. Still can't find my copy of Jaguar, and
Panther comes out on the 24th.

to_days(date) returns the number of days since the Epoch.

select count(subscribe_date) from contact_list where (
to_days(subscribe_date) < (to_days(current_date()) - 180) ) ;

-- proof: 
select subscribe_date from contact_list where (
 to_days(subscribe_date) < (to_days(current_date()) - 180) ) and email
 like 'swain%' order by subscribe_date asc;

-- candidate for paring down lists:
 create temporary table old_lists select distinct list_number from
 contact_list where ( to_days(subscribe_date) <
 (to_days(current_date()) - 180) );

Select the ids to be deleted in to a temporary table. Then use the
extended DELETE in MySQL to delete from multiple tables. The temporary
table goes away after you disconnect.

-- test run
create temporary table swain_cl select * from contact_list where email like 'sw%';
create temporary table swain_list select * from list;

mysql> select count(*) from swain_cl, swain_list where number=list_number;
+----------+
| count(*) |
+----------+
|    18141 |
+----------+
1 row in set (1.25 sec)

-- select list numbers to delete into a temporary table
create temporary table swain_delete_these select distinct(list_number)
from swain_cl where to_days(subscribe_date) < (to_days(current_date())
- 180);

-- use mysql delete to remove them
delete swain_cl, swain_list from swain_delete_these, swain_cl,
swain_list where swain_cl.list_number=swain_delete_these.list_number
and swain_list.number=swain_delete_these.list_number;

mysql> select count(*) from swain_cl, swain_list where number=list_number;
+----------+
| count(*) |
+----------+
|      669 |
+----------+
1 row in set (0.06 sec)

select count(*) from message where to_days(date_sent) < (
to_days(current_date()) - 180);


select count(*) from contact_message where to_days(time_date_sent) <
 (to_days(current_date() - 180);

select count(*) from blast_log where to_days(send_out_began_at) < (
to_days(current_date()) - 180);




#########################################################################
031009 Thursday

Reviewed SF tickets prior to 11am call. The FC project meeting was
moved up to 12pm.

Eric brought me a mystery: three customers cannot pass through Unified
Login, and both he and Support are unable to duplicate the problem
(they login fine using these accounts). I wonder if I can log the
user's browser in SupportRedirectorServlet.

Got a reprieve; Swolf said to skip the ticket meeting since none
applied to me.

Germans:

SELECT c.email from contact c, Contact_Source cs where (country = 'Germany' or country = \
'Deutschland' or c.email like '%de') and c.email = cs.email and cs.sourceid = 8 and undel\
iverable_count=0 into outfile '/tmp/fortunecity.txt';                                     

SELECT c.email from contact c, Contact_Source cs where (country = 'Germany' or country = \
'Deutschland' or c.email like '%de') and c.email = cs.email and cs.sourceid = 1 and undel\
iverable_count=0 into outfile '/tmp/v3.txt';

Went to the 12pm meeting which was not the FC meeting (postponed due
to GG) but the Product group, and they asked me to stay.

Sent GG email with SQL to trim tables in Blastmail.

Am going to research to see if EVW records the last login, or even the
login history, of its users. Actually I'd think the log files would
record this somewhere.

Organized desk, found UI bug that needed a ticket and filed it with
SF. Domain: mccabeshoes.com. Irish user.

                                   


#########################################################################
031010 Friday

-- This query pulls the accountid for everyone taxed in the specific
-- time frame.

db2 "select accountid from journal where (journaltimestamp > 1064980800) and
(journaltimestamp < 1065844799) and tax > 0"

-- much simplified query:

db2 "select a.accountid, tax, organisationdn 
from journal j,accountholders ac, accounts a 
where a.accountid=j.accountid and
(journaltimestamp > 1064980800) and (journaltimestamp < 1065844799)
and (tax > 0) and ac.accountholderid=a.accountholderid"

Thoughts on automating the update of blastmail:

I considered for a while a centralized approach, with one script
pulling in all the data from the three properties and inserting it
into Blastmail. However, this would require one machine to have
drivers for all three databases (Oracle, DB2 and MySQL) as well as
LDAP. One way around this is to do it in Java.

It seems a more piecemeal approach would work better: each database
has a script to run one or two SQL queries to generate the
output. These could run every day or week and produce dated files.

Another machine (blast.corp probably) would retrieve these files (or
else receive them via email) and process them. Each database will
probably produce one file for the contact table and a second file for
the *_customers table. Email validation will occur before insertion.

Met with GG at 2pm, went over the todo list for the week. The only
thing I didn't come through on 100% was looking at options for
updating Blastmail on an ongoing basis. GG wants to use SOAP::Lite for
the project. I expressed doubts, that this would be overkill that
delays the development but he was confident SOAP::Lite would be
speedy.

Also talked to Swolf about a spec for the VAT report. He thought he
might have a written spec already but would have to check for
it. Keith has not been leaning on him for it though... and he said it
may be that we only need to know the total amount charged, which
would be trivial. It was good for me to get familiar with the JOURNAL
table though.




#########################################################################
031013 Monday

"todo" list week ending 10/17:

1) The queries are done for trimming Blastmail tables; these just need
   to be cron'd. I estimate that at .5 days, and can complete that
   today. I installed the latest greatest Blastmail database on Devil
   over the weekend, so I can test it there.

2) Interface for Ops for handling bounced emails -- this is still
   simmering until we meet with Ops. I can explore a way to add a new
   page to Blastmail in the interim, .5 days.

3) Domain distribution -- I think it's possible to use MySQL string
   functions to decompose email addresses, and build a distribution
   count of domains used by our customers. The point of this was for
   Ops in regards to handling bounced emails; we wanted a magic list
   of domains never to be blacklisted (e.g. yahoo.com, hotmail.com). I
   give this .5 days.

4) XML representation of a customer record -- I can do this in .5
   days, since it just involves looking at the tables and typing it
   all out. That belies the longer task of using it with SOAP::Lite,
   and I'd like to look at SOAP over SMTP.

I want to visit all the machines and look at their Perl installation,
so I'd like to add another .5 days to this. It would probably be
easiest to have SOAP::Lite installed on all machines involved (clients
and server).

5) Performance tuning of MySQL on blast.corp -- need to ping Ops on
   the admin work we requested for InnoDB.

6) VAT report -- waiting on Swolf to find out what Keith needs and how much.

Deliverables:

Cron jobs for trimming BM data: COB today

Domain name spread, XML example: COB Tuesday

Visit machines, SOAP research: Wednesday

Since there's a plethora of meetings this week, and some items above
are pending, I will update this list Wednesday morning.

~swain 

---

Making a distribution count of email domains of our customers:

-- select all domain names from the email column in blastmail
select substring(email, (locate('@', email) + 1)) from emails where
email like 'sab%';

-- first, our old friend the temporary table. All domain names are
-- selected into it.
create temporary table domains select substring(email, (locate('@',
email) + 1)) as domain from emails where email like 'sab%';

-- counting domain names
select distinct(domain), count(domain) as total from domains group by
domain order by total desc;

---

On oas1.fortunecity.com, perl version 5.005_02. It has a database driver. Looks like
SOAP::Lite will build just fine. Installed it. Comes with XML::Parser.

Perl version 5.6.1 on dbm-2.v32.com. Installed SOAP::Lite
successfully.

5.005_03 on evw-1.prv. No 'make' though. Bummer.




#########################################################################
031014 Tuesday

SOAP::Lite fails most tests on db2-1.prv. Hrmm. I had a thought last
night before bedtime that installing it there might be the way to go.

I see that I have already finished one of my tasks today, the domain
name spread. The query is in yesterday's entry. Today I'll mock up the
xml packet for Blastmail.

Not cool. mysqldump --xml doesn't include type information. Sadly I
had to endure GG pointing this out which was a minor embarassment. Not
sure I reall need it though; when JeffO posts to Support Wizard he
just uses:

my $sync = $user->updateUserFromEVW(
        LOGIN           => 'jeffo3',
#       NEW_LOGIN       => 'jeffo3',                                                       
        FULL_NAME       => 'jeffrey oconnell',
        EMAIL           => $$ . '@rulez.com',
        PASSWORD        => 'rulez',
#       GROUP           => 'Customers',                                                    
        DOMAIN          => 'rulez.com',
        PRODUCT         => 'Domain Name Registration',
) ;


I think I'll whip out the estimate for the VAT report today... I need
to update my todo list tomorrow morning with new estimates.

Due to automatic type conversion, we don't really need to know the
data types. We can treat them all as strings and MySQL will handle
them correctly. Though that doesn't help in terms of enforcement of
the correct type... but wouldn't it be the case that only correct data
can go into any particular database (FC, V3, Ampira), and we have the
correct types defined in Blastmail? So no data enforcement is needed
in the transition.

---

Had a problem with getting SOAP::Lite to work via smtp; I must have
copied a bad char (\xE2) from the perldoc, because when I tried to
paste the offending code into my LOG.txt I got a complaint from Emacs
about what character encoding to use.

Swolf brought me a printout of an account statement for a GB user, who
was not charged the VAT.

ldapsearch -h db2-1.prv.ampira.com -p 400 -D "cn=Directory Manager" -w
"" -b "o=Oueida,ou=Clients,o=FC Gold,ou=Clients,o=FCTY"
"(evworgtype=*)"

One thing I notice in the web browser is Oueida has two addresses;
both are GB, but there's an extra linefeed in there for some reason in
the first address.

bash-2.04$ db2 "select taxrealmid, organisationdn from accountholders where organisationdn like 'o=Oueid%'"

TAXREALMID  ORGANISATIONDN
217         o=Oueida,ou=Clients,o=FC Gold,ou=Clients,o=FCTY

Ruled out: the extra linefeed in the GUI, which is just an errant
<BR>.

The EU tax realm ID for FC Gold is indeed 217, merchant ID 51. So it
looks like "istaxable" in the JOURNAL table is the culprit... but I
have no proof.

Observe:
bash-2.04$ db2 "select count(distinct(accountid)) from journal where istaxable=1"

1          
-----------
       1223

1,223 accountids currently marked as taxable.

[evw-1 swain]$ grep "o=" EU.folk2 | wc -l
    1674

1,674 EU accounts in LDAP. So, is ISTAXABLE used or not?


[snip]
Steve Wolf asked me to look at an account with a negative balance, FC Gold account "Oueida."
The account statement shows no tax applied to the values in the Debit column, but
tax is applied to the value in the Credit column; the end result is a negative balance,
which leads to a positive balance the following month when the recurring charge happens
(which also has no tax applied). This account belongs to a customer in the United Kingdom.

After some looking around the database I found that the column ISTAXABLE was set to zero for 
all entries for this org's accountid.

I did some checking, and found that there are only 

db2 "select distinct(organisationdn) from accountholders ac, accounts a, journal j where j.accountid=a.accountid and a.accountholderid=ac.accountholderid and j.istaxable=1" | grep "o=" > taxed.out

wc -l taxed.out
    1226 taxed.out

But we have 1,674 accounts belonging to EU customers:

 ldapsearch  -h localhost -p 2000 -D "cn=Directory Manager" -w "--------" -b "o=FCTY" "(&(evworgtype=ORG)(|(evwstreetcountry=AT)(evwstreetcountry=BE)(evwstreetcountry=DJ)(evwstreetcountry=FI)(evwstreetcountry=FR)(evwstreetcountry=DE)(evwstreetcountry=GR)(evwstreetcountry=IE)(evwstreetcountry=IT)(evwstreetcountry=LU)(evwstreetcountry=NL)(evwstreetcountry=PT)(evwstreetcountry=ES)(evwstreetcountry=SE)(evwstreetcountry=GB)))" dn evwstreetcountry > EU.folk2

 grep "o=" EU.folk2 | wc -l
    1674

What's more, 861 of these accounts marked ISTAXABLE=1 belong to US customers, plus several other non-EU countries. Some of
the country codes are also just plain weird:

evwpostalcountry:: Q0EA
evwpostalcountry:: Q0EA
evwpostalcountry:: R0IA
evwpostalcountry:: R0IA
evwpostalcountry:: R0IA
evwpostalcountry:: SVQA
evwpostalcountry:: SlAA
evwpostalcountry:: TVgA
evwpostalcountry:: Tk8A
evwpostalcountry:: TkwA
evwpostalcountry:: TkwA
evwpostalcountry:: TkwA
evwpostalcountry:: U0cA
evwpostalcountry:: VEgA
evwpostalcountry:: VFcA
evwpostalcountry:: VUsA
evwpostalcountry:: VVMA
evwpostalcountry:: VVMA
evwpostalcountry:: VVMA

Is it possible ISTAXABLE is being set incorrectly? Do we have bad data in LDAP?

[snip]


Unfortunately my first ticket was typed out better but I must have hit
the wrong submit button... and I forgot to add a subject line. I
probably didn't Cc: it either.




#########################################################################
031015 Wednesday

Was called over to watch the hashing out of responsibility for InnoDB
on production... chatted with Gautam about Blastmail and the need for
an XML description of customer data; he's going to send me an example
of what he wants.

Meanwhile, the Germans got a complaint about a recent mailing. I
checked the two lists I ftp'd up to them and the address appears in
neither... but I made the mistake of doing a case sensitive search,
and GG called me on that; the email address uses mixed case. The files
are now in my home directory on blast.corp under ~swain/de/; it would
be a good practice to do any small task under a unique directory, and
collect all files, scripts, shell buffer contents and command history
there, if possible. One aspect of this job is that I do a lot of
little tasks and some need to be revisited; organization is a key
ability.

Insta=Spec on VAT report:

DATE,       ACCOUNTID, GROSS AMOUNT (USD), VAT CHARGED, COUNTRY
12-Aug-03   12345      $116.00             16%          Germany

Reports due quarterly for just-prior quarter. 1/1, 4/1, 7/1 and 10/1.

Email to keith@ampira.com as CSV attachment.


#########################################################################
031016 Thursday

Worked late yesterday on the VAT report. I think I have all the
necessary data now, but I need to rework the query so the values are
summed according to accountid.

-- First stab at the query:
select journaltimestamp, a.accountid, amountpretax, tax, amount, organisationdn, journalid
from journal j,accountholders ac, accounts a
where a.accountid=j.accountid
and (journaltimestamp > 1057032000)
and (journaltimestamp < 1065067199)
and (tax > 0)
and ac.accountholderid=a.accountholderid


-- But I need to sum the amounts and GROUP BY. I think this works:
db2 "select distinct(a.accountid), sum(amountpretax), sum(tax),
sum(amount),organisationdn from journal j,accountholders ac, accounts
a where a.accountid=j.accountid and (journaltimestamp > 1057032000)
and (journaltimestamp < 1065067199) and (tax > 0) and
ac.accountholderid=a.accountholderid group by
a.accountid,organisationdn"

The math is correct at least.

A fairly more comprehensive, useful exception message:
try:
    orb = CORBA.ORB_init(sys.argv, CORBA.ORB_ID )
    system = connectToSystem(orb)
    sessionkey = system.authenticate( system.getUserDn( "admin", "o=" + system.getClientId() ), "",  "" )
except:
    print "Unable to authenticate with system"
    errstuff = sys.exc_info()
    print errstuff[0], errstuff[1]
    traceback.print_exc()
    sys.exit(1)

There is a traceback object in errstuff[2] but it's a weird
thing. Python is kinda crappy when it comes to debugging.

Investigation: are all taxed people EU? Are all untaxed people not EU?
For the latter, we must narrow down to Sep 1 to Oct 1.

bash-2.04$ db2 "select distinct(organisationdn) from journal j,accountholders ac, accounts a where a.accountid=j.accountid and (journaltimestamp > 1057032000) and (journaltimestamp < 1065067199) and (tax > 0) and ac.accountholderid=a.accountholderid" >  tax.overzero

bash-2.04$ db2 "select distinct(organisationdn) from journal j,accountholders ac, accounts a where a.accountid=j.accountid and (journaltimestamp > 1062388800) and (journaltimestamp < 1064980799) and (tax = 0) and ac.accountholderid=a.accountholderid" > tax.iszero 

All 50 orgs taxed in the time frame are EU countries:

[evw-1 eutest]$ grep evwstreetcountry overzero.out | sort -u
evwstreetcountry=BE
evwstreetcountry=DE
evwstreetcountry=ES
evwstreetcountry=FR
evwstreetcountry=GB
evwstreetcountry=GR
evwstreetcountry=IE
evwstreetcountry=IT
evwstreetcountry=LU
evwstreetcountry=NL
evwstreetcountry=SE

andreatrevisan 18941 Italy, existing customer, was not charged VAT.

andres 20939 France, new customer, was not charged but was
   retroactively charged.

antscds 18652 GB. Not charged. Pre-existed.

o=gibilogic,ou=Clients,o=HostV3,ou=Clients,o=FCTY
evwstreetcountry=IT
pre-existed. not charged at all.

o=hdunn2,ou=Clients,o=FC Gold,ou=Clients,o=FCTY
evwstreetcountry=GB

Does balance carried forward result in a zero tax JOURNAL entry?
(the answer is yes).

#########################################################################
031017 Friday

I need to update the Ampira paid customers in Blastmail. Am sending an
email to GG to ensure understanding.

I'm so retarded. I've been writing these long queries to figure out
billing questions, when what I should be doing is create a temporary
table of EU data. I had the thought while writing a reply to Swolf of
creating a temporary table of all EU customers, so I can do easy
JOINs.. and that led to the thought of populating that table with data
from the JOURNAL table as well. Simple.

Updating ampira: this should be a matter of creating new contact and
ampira_customers files, and using mysqlimport with the command line
arg that says "ignore duplicate entries."

Wrote an email on completion of updating Ampira customers for
Blastmail:

Ops, this probably doesn't concern you, but FYI: I created backups of
the CONTACT and AMPIRA_CUSTOMERS tables in /var/tmp on
blast.corp. There's seven GB available there.

I've extracted the data for all paid customes in Evolutionware since
August 15th and imported that data into Blastmail, first on Devil and
then on blast.corp.

Outline of the process:

First, I had to narrow down the orgs to those created since the middle
of August (technically, Aug 18th, but I did everyone since the 15th
for a little overlap). I created a list of organisationDns by looking
at their installation dates in the ACCOUNTS table.

I used this list in the Perl script used two months ago for the
Blastmail project, which queries for all paid customers, and filtered
out accordingly.

Next I used the process script to generate input files for mysql
(CONTACT and AMPIRA_CUSTOMERS tables).

I compared the output to that from two months ago to ensure
consistency.

Next I tested an import on Devil, and it was without problems.

I exported the CONTACT and AMPIRA_CUSTOMERS tables on blast.corp into
/var/tmp, then used mysqlimport to load in the new data. 1209 accounts
were added to Blastmail.

~swain




#########################################################################
031020 Monday

Late Friday, there was a problem with the recent import of Ampira
customers. The 1300 or so that I added did not have the visp_name
field set.

It looked like the script I used was faulty; in the end the actual
problem was a missing tab character. But the puzzle is, how did this
happen? The original import of the ampira_customers table, which I
saved, is correctly formatted. So I don't understand how this got to
be wrong.

I cleared out my email box; I was about 5 min late for the staff
meeting; I need to write my week-end wrap-up for last week's todo
list, then write this week's todo with estimates.

I struggled for a while on Friday with creating temporary tables in
DB2, to no avail, and converting an integer representing seconds since
the Epoch into a DATE value, also to no avail.

---

Met at 2pm for FC Gold. That went OK. Next up, I wrote/tested the
alter.sql script for Blastmail. I made a --no-data dump of blastmail,
created a test database, loaded it with empty tables, and then applied
the alter.sql script. It took a few seconds but worked just fine.

I am working on the script GG showed me; but Date::Manip was not
installed, and when I tried to install it cpan complained there was no
Makefile.pl.

[evw-1 scripts]# /opt/perl5/bin/perl -MCPAN -e 'shell'

There seems to be running another CPAN process (pid 5585).  Contacting...
Other job not responding. Shall I overwrite the lockfile? (Y/N) [y] 

cpan shell -- CPAN exploration and modules installation (v1.76)
ReadLine support enabled

cpan> install 'Date::Manip'
CPAN: Storable loaded ok
Going to read /opt/perl5/cpan-cache/Metadata
  Database was generated on Fri, 22 Aug 2003 23:44:06 GMT

[...]

Fetching with Net::FTP:
  ftp://ftp.rge.com/pub/languages/perl/authors/id/S/SB/SBECK/DateManip-5.42a.tar.gz
CPAN: Digest::MD5 loaded ok
LWP not available
Fetching with Net::FTP:
  ftp://ftp.rge.com/pub/languages/perl/authors/id/S/SB/SBECK/CHECKSUMS
Checksum for /opt/perl5/cpan-cache/sources/authors/id/S/SB/SBECK/DateManip-5.42a.tar.gz ok
Scanning cache /opt/perl5/cpan-cache/build for sizes
CPAN: Archive::Tar loaded ok
Compression not available - Install IO::Zlib! at /opt/perl5/lib/5.6.0/CPAN.pm line 5823
No files found for /opt/perl5/cpan-cache/sources/authors/id/S/SB/SBECK/DateManip-5.42a.tar.gz at /opt/perl5/lib/5.6.0/CPAN.pm line 5852
Package seems to come without Makefile.PL.
  (The test -f "/opt/perl5/cpan-cache/build/SBECK000/Makefile.PL" returned false.)
  Writing one on our own (setting NAME to DateManip)

  CPAN.pm: Going to build S/SB/SBECK/DateManip-5.42a.tar.gz

Writing Makefile for DateManip
mkdir blib
mkdir blib/lib
mkdir blib/arch
mkdir blib/arch/auto
mkdir blib/arch/auto/DateManip
mkdir blib/lib/auto
mkdir blib/lib/auto/DateManip
  /usr/local/bin/gmake  -- OK
Running make test
No tests defined for DateManip extension.
  /usr/local/bin/gmake test -- OK
Running make install
Writing /opt/perl5/lib/site_perl/5.6.0/sun4-solaris/auto/DateManip/.packlist
Appending installation info to /opt/perl5/lib/5.6.0/sun4-solaris/perllocal.pod
  /usr/local/bin/gmake install  -- OK

Dunno what went wrong. The script still can't find the Date::Manip
module.

Stripped the gunk from the Perl script, edited, tested, got it
working. Mozilla doesn't want to save the attachment, probably a
bug. Worked fine on Mail.app.

Couldn't find the damn email I sent to Victor. Reason: it was on my
old hard drive. GG searched his old emails but couldn't find a
copy. I'll have to reread the cartwizard code. No biggie, but
duplicated effort.


#########################################################################
031021 Tuesday

Trying to get the build working for cartwizard... very annoying, these
build problems. Nothing in my .superhistory or LOG.txt about it.

Perhaps the build configuration and ENV of any project should somehow
be recorded at the time it is actually working.

After going over my build troubles with GG I solved them myself... I
just had to delete the offending parts from the build.xml. Checked in
build.xml as devil.build.xml. I also found my old bookmark link into
the cartwizard in the apache log.

Facts:
There are untaxed charges both before and after the patched binaries.
There are untaxed charges in more than one visp.

Filed another ticket with SF, and attached two files. One untaxed,
another taxed. These are all since Sep 29.




#########################################################################
031022 Wednesday

Just met with Rob for 30min. We talked about workflows... one thing I
missed before is that the workflow doesn't happen until the very
end. What he wants to do is just send an email to Chris telling him
what template number was chosen.

A workflow is a thing that exists by itself. What it is, is a page
generated by EVW as part of a wizard process. First: Rob goes into EVW
and clicks a workflow link in cgitree. This gives him a short series
of pages which ask the following: What name for the page? What data
type(s) are you asking for? What kind of values are they? What
question is asked of the user? Who gets emailed, if at all, with this
information?

This workflow is then added to a list of workflows. It doesn't yet
belong to any one package. When he creates a package called, for
example, FC Yearly Web Hosting With Template, as he adds the products
to the package, the workflow will be one of them. Thus when the user
decides to by FCYWHWT, as part of the wizard they will be presented
with the page. So my next task is to see, via debugDump, how the
variable is stored.

Just got pulled over by Eric. He added Ireland to the dropdown list,
but noticed when he selected IE the VAT was not charged. 

It doesn't seem to be the jsp file versions... because the HTML
comments contain my debug output and it shows that the EU tax realm is
chosen. I checked via the admin interface that this realm is still
charging 16% and it is.

No significant events on Oct 9th in my log. Sunil replaced the System
module the morning of Oct 10th, but the same binary is on both staging
and production.

Updated the latest ticket I filed with SF. I spent almost five hours
hacking away at the VAT problem. Very stressful.

Got Rob to find a package for me that uses a workflow: Super Pack
Hosting with FTP and Cute Site Builder. The workflow page just asks
for the email; I compared the debug dump with another package buy at
the point where you hit customerInfo.jsp; the only difference was the
string the user entered for the workflow.

Tomorrow Rob will create a package with a workflow like how he wants
it, and I will test it to see if posting the info directly works as
needed.



#########################################################################
031023 Thursday

I was quite burned out yesterday from the effort of finding out what
was wrong with VAT. In the end I couldn't find anything wrong and
updated my most recent ticket. We have an 11am meeting with SF for
open tickets.

---

Since lunchtime I've been hacking away on the problem of dynamic
workflows. In short, Rob wants to populate a variable with a template
number, which is then emailed to Chris. Gautam has other ideas though;
he wants to trigger scripts we write. Anyway, Rob built the package
exactly as he wanted, and I was held up a long time trying to solve a
problem with the job queue. Jobs were sticking at SEND MAIL and the
MailSpool module hadn't logged anything since 11:41am this day.

Zlatin finally found that Exim was not running on the target mail
machine due to a missing library file. He copied it over and started
Exim.

I then found that MailSpool had to be restarted but that finally got
things moving.

Next, I had composed all the variables into one HTML form. I had to
copy over the JSP from HostV3 to get around the whois lookup. Next the
page would show from the workflow, but Rob and I found that this can
be disabled in the interface. This got us to the point where
submitting all the data to the Signup Wizard landed us on the Customer
Info page... at that point GG came in and we had a discussion. He
really wants more than sending an email to Chris; he wants to trigger
a script via a workflow. This can be done via email but it's another
point of failure.

We got into a debate again about circumventing the Signup Wizard. I
think it's a mistake to duplicate all that work, but he brought up the
issue of how difficult it is to customize the HTML because it's mixed
into Java code in places (the big issue with UglyBoy, here, was the
error messages, which were indeed buried pretty deep).

He gave me a cookie and said I'd done enough for dynamic workflow
research. We also looked into LDAP because he was sure the variable
defined in the workflow was stored in the system somewhere, but I
think it's just discarded after the workflow completes. He also
reiterated the need to have a deeper understanding of workflows: how
they are made and used. This also ties into my desire to know the job
system better.

Panther shipped, we should all receive it tomorrow.




#########################################################################
031024 Friday

I've spent the morning multitasking: while Panther installs on my Mac,
I first converted the FCTY strings to FCDE on Devil, and documented in
Twiki how to do this. (It occurred to me that this is the beginning of
a rollout script that does this for us). I then bought a package on
HostV3, and tried to push it through. I had to start the eftnet
gateway. I haven't been able to find my job in the vetting tool
though. Weird. I started pushing other jobs: I approved every job in
the Registar, then looked at why all the hung jobs were hung. Once
again the ADM module on cws-1.dvl was stopped, and so was
Server. Bouncing EVW fixed ADM but not Server so I emailed the
details to Ops.




#########################################################################
031027 Monday

9:30am weekly staff meeting, took notes on paper. I think Swolf likes
the small front conference room now. I'll have to start bringing my
laptop if the laptop in the big conference room doesn't work, or be
burdened with moving the power cord as well.

Discovered there's a problem with the name record for Splinter; it
resolves to 10.1.1.107 instead of 192.168.2.207. I can get there by
raw IP and set this in my /etc/hosts file.

Gotta make the todo list. It's going to be quite full.

---

* ListAllActiveUrls: this is for FCR. I need to do some information
gathering on this so I can write up an estimate; the idea right now is
to piggyback a script on the log rotation job. I've heard that the
logs are rotated every four hours, so this would be the insertion
point to parse logs and find what's being clicked on.  COB today if
not sooner.

* VAT review: My theory right now is that package syncs somehow break
the VAT taxing process... it's possible that the taxIds for
costprofilecomponents are different between staging and production,
and a package sync makes them the same. I will be working on this
theory this afternoon; fortunately I have all my scripts from the last
time I did this and can verify I did everything according to Oliver's
PDF.  COB today.

* Make PackageXML: my next task for FCR is scheduled for Tue-Thur
  pending Rob's completion of the packages.

* Ugly Boy PATH_INFO change: I think I can break this into a series of
  small tasks and will be working on them throughout the week.

* Automate change of FCDE/DMFC/FCTY: I'd like to steal this from
  you. I actually did this for Zlatin on devil last week, and I think
  it will just break down to a shell script:

set FROM_LDAP_ROOT=FCTY
set TO_LDAP_ROOT=FDCE
cd /opt/evw
for filename in `find . -type f | xargs grep -i $FROM_LDAP_ROOT`; do
   perl -pi -e 's/$FROM_LDAP_ROOT/$TO_LDAP_ROOT/g' $filename
done

But it will have to match case too.

~swain
* ListAllActiveUrls: this is for FCR. I need to do some information gathering on this so I can write up an estimate; the idea right now is to piggyback a script on the log rotation job. I've heard that the logs are rotated every four hours, so this would be the insertion point to parse logs and find what's being clicked on.
COB today if not sooner.

* VAT review: My theory right now is that package syncs somehow break the VAT taxing process... it's possible that the taxIds for costprofilecomponents are different between staging and production, and a package sync makes them the same. I will be working on this theory this afternoon; fortunately I have all my scripts from the last time I did this and can verify I did everything according to Oliver's PDF.
COB today.

* Make PackageXML: my next task for FCR is scheduled for Tue-Thur pending Rob's completion of the packages.

* Ugly Boy PATH_INFO change: I think I can break this into a series of small tasks and will be working on them throughout the week.

* Automate change of FCDE/DMFC/FCTY: I'd like to steal this from you. I actually did this for Zlatin on devil last week, and I think it will just break down to a shell script:

set FROM_LDAP_ROOT=FCTY
set TO_LDAP_ROOT=FDCE
cd /opt/evw
for filename in `find . -type f | xargs grep -i $FROM_LDAP_ROOT`; do
   perl -pi -e 's/$FROM_LDAP_ROOT/$TO_LDAP_ROOT/g' $filename
done

But it will have to match case too.

~swain


---

Directory where log files are on oas2:
/homepage_1/stats/www.fortunecity.com/apachelogs


As I expected, the evidence indicates package syncs break taxing. The
taxids for costprofilecomponents were identical on both staging and
production, and this is not to be. Updated the SF ticket on that one.

Been running a script on oas2 that parses out image filenames from the
apache logs. Out of habit I wrote "open file or die" but the script
takes so long to run some of the log files disappear before they are
reached. I changed the dies to warns and it's running again.




#########################################################################
031028 Tuesday

At COB yesterday GG helped me find why path info was not working. In
resin.conf you have to define the servlet name as /sc/* instead of
/sc.

11:35, no word on the package sync yet. Working on the shopping cart.

I realized that form submits would be a problem; went to the kitchen
to think about it for a while. I realized that I could manipulate the
ACTION of the form, if it's writable, and just append a dummy
key/value on the end after a question mark -- or maybe not even! --
and form.submit() would work normally. So some JavaScript has to be
written.

GG asked me to verify Devil was updated correctly. So far no smoking
guns. I updated the copy under /opt/cvs/evw and did a diff -r on that
and the frontend for FC Gold; there were only a few differences,
mainly my changes to the ldap root node name.

/opt/evw/frontend-fcgold/product/extensions/webDomain/installedConfig.vps
differs a lot from the one in cvs.

/opt/evw/frontend-fcgold/index.htm has minor differences with the
version in CVS

/opt/evw/frontend-fcgold/product/extensions/webDomain/installedConfig.vps
has some large differences from CVS


---

<html>
<head>
<title>testing if you can set the ACTION in a FORM</title>

<script>

// we cheat: we bundle the form variables and compose them 
// as PATH_INFO, and append that to the action. The variables
// are still sent as GET too, but who cares.

function setAction() {

    pathinfo  = "/";

    for (x = 0; x < document.forms["testform"].length; x++) {
        pathinfo += document.forms["testform"].elements[x].name;
        pathinfo += '=';
        pathinfo += document.forms["testform"].elements[x].value;
        if (x != (document.forms["testform"].length - 1) )
            pathinfo += '&';
    }

    alert(pathinfo);
    document.forms["testform"].action += pathinfo;
    document.forms["testform"].submit();
}
</script>

</head>
<body>

<form name="testform" action="http://192.168.2.232/cgi-bin/env.cgi" method="GET">

<input type="text" name="pathname" value="hosting">  <br>
<input type="text" name="pagename" value="email"> <br>
<input type="text" name="choice" value="pro trellix yearly"> <br>
<input type="text" name="replace" value="falsely"> <br>
<a href="javascript:setAction()">click me</a>

</form>



Update on switching to path_info: The trick here is to use JavaScript
to modify the form's ACTION field. I append the form data as one string:

http://hostv3.dvl.ampira.com/cartwizard/sc/pathname=email&pagename=addHosting20Email&choice=super_ftp_y&replace=true?pathname=email&pagename=addHosting20Email&choice=super_ftp_y&replace=true

and the CGI data (which is identical) is added again, but we don't
really care.

One more change will have to occur: options_body has links hardcoded
into it, and I'll have to rewrite the links to include path info.




#########################################################################
031029 Wednesday

Yesterday, by 6:30, I had all the problems worked out for UglyBoy =>
PATH_INFO. I commented my JavaScript function and pulled out a debug
line, and I'm going to rollout to staging today, and ask for help
testing. Wrote an update to GG about what I'm doing right now.

Rollout to staging means: updating resin.conf with the /sc/* syntax,
copying the war file to evw-1.dev in /usr/local/resin/webapps, and the
web.xml file has to be correct.


Link into staging for testing:
http://hostv3.dev.ampira.com/cartwizard/pages/cartwizard/outertemplate.jsp?domain=thisisthedomain.com&period=1

A note on cartwizard.war and rolling out. On Devil, jar files were
added by GG to /opt/evw/java/cartwizard, and these are found by Resin
via an altered /etc/profile.

But on staging and production this is not the case, so certain jar
files have to be added to the lib directory in the project directory,
so they wind up in WEB-INF/lib on staging and production.

Since the 2pm meeting for FCR, I fought EVW staging for a while trying
to push the jobs through; I finally bounced the whole system. It was
probably in a bad state because the Billing Module kept
hanging. Swolf, Eric and GG tested the cartwizard. I started on
generating packages.xml but found that Rob made many mistakes in the
package creation: lots of costprofile fields were not set. This is
because he doesn't wait for the page to load after he submits
(impatience). Then I found there are missing cost profile components
on devil, and sent an emai to Ops. The package sync will have to be
redone.

I consulted with GG on whether to do the work on staging instead; it
would involve updating all packages, setting those active as inactive
and vice versa. The risk is that a package sync from staging to
production would be a disaster, but as GG pointed out, due to syncing
breaking taxing now that was a minimal risk. But he advised against
doing anything on staging and that is the Right Thing to do.




#########################################################################
031030 Thursday

Sent another email to Ops about the package sync. We have to get Rob
to make sure the cost profiles are all in, or else I have to do it for
him.

Alternately, I can write Java to drill down and pick out the packages
myself, regardless of their active status.

In packages.xml, <price></price> has to have the gunk stripped:
perl -npe 's|(<price>).*?\$(\d?\d?\d\.\d\d).*?(</price>)|$1$2$3|'

I rolled out cartwizard.war to app-1, tested all paths, and it looked
fine. I forgot to put the change in to resin.conf (!) where /sc/*.

Next I tried to reproduce the bad ldap country codes stuff for SF
ticket #1793, but couldn't. Over two weeks have passed since I filed
that ticket. I reran the *same scripts* I did last time and didn't get
the same results. Oh well. I noted this in the ticket and asked for it
to be closed.

Not feeling well today.

Started RegClient.java as a testbed to see if I can duplicate the
effort of the signup wizard. RegisterWizardDetails is easy... it's the
business with the product configuration that's a mess. But I think I'm
in a far better position to do this than six months ago. It's just a
matter of satisfying all the dependencies.




#########################################################################
031031 Friday

Still might be a cold forming... hard to say. I'll stick with
Cold-Ease for now.

So far, the way to register a new client is to populate a
RegisterWizardDetails, which contains about 27 string fields and one
ProductConfig array. Getting the ProductConfig right is all I need to
figure out.

Procedure for fixing tax ids: select merchantid from merchants_tbl in
billing. Using these ids, find the taxstructureids from
taxstructures_tbl.

Select productmerchantids from merchants_tbl in prod. Use that as a
select statement to get the costprofileids in the update statement to
the costprofilecomponent table.

Wrote a Twiki page on how to fix taxes after a package sync. I wrote a
SQL file for each machine and they just have to run it on the target
machine. I also updated devil with the recurring charges fix that I
did on staging and production at the end of September.



#########################################################################
031103 Monday

In by 9:15. Brought balin today so I can take notes if we are in the
front conference room.

Whacked out a script to go with the Perl script I wrote to deal with
EU monitoring. 

1. Generate file EU.folk via LDAP query
2. Process into SQL statements with Perl script
3. Load data into EU table
4. Use unix.py to craft correct unix timestamp
5. Use in query looking for zero tax on amountpretax > 0

Filed another ticket; recurring charges were not being taxed over the
weekend.




#########################################################################
031104 Tuesday

Spent the morning working on the VAT problem. I wrote up a thorough
report this time when I filed a ticket: I showed the user had the
correct taxrealmids, the costprofilecomponents had the right taxids,
and so on.

Jessy says there are no pages shared between the three paths... which
would seem to render the cartwizard superfluous. Also, we need to
retain all the user form data before posting it to EVW. This is a
capability the cartwizard totally lacks; I'm thinking of a generic
mechanism to store/retrieve the values in the HttpSession object.

I need to finish reviewing the resumes.

GG and I met at 3pm. It took me a long time to read through the
resumes. We have six phone interview candidates. One person was ruled
out for being overqualified.

SystemsFusion took my ticket and the support team is going to review
my results.

The crux of the design of CartWizard is that PathInventoryBean
contains a HashMap. 

    public void loadPaths (String pathXmlFile) 
	throws JAXBException, IOException
    {
	JAXBContext jc = JAXBContext.newInstance( "com.ampira.cartwizard.beans.autogen.path" );

	Unmarshaller u = jc.createUnmarshaller();
            
	CwPathsType cwPaths = 
	    (CwPathsType) u.unmarshal( new FileInputStream(pathXmlFile));
            List cpathList = cwPaths.getCwPath();

	    for (Iterator pathIter = cpathList.iterator(); 
		                     pathIter.hasNext();
		 ) {
		CwPathType cp = (CwPathType) pathIter.next();
		List cpageList = cp.getCwPage();
		for (Iterator pageIter = cpageList.iterator(); 
		                         pageIter.hasNext();
		     ) {
		    CwPageType cpage = (CwPageType) pageIter.next();
		    List cChoiceList = cpage.getCwChoice();
		    ListIterator cChoiceListIterator = cChoiceList.listIterator();
		    for (Iterator choiceIter = cChoiceList.iterator(); 
			                       choiceIter.hasNext();
			 ) {
			CwChoiceType cChoice = (CwChoiceType) choiceIter.next();
			CwTargetPageType targetPage = cChoice.getCwTargetPage();

			paths_.put(cp.getName()+cpage.getName()+cChoice.getName(), targetPage);
		    }
		}
	    }
    }
    private static Hashtable paths_     = new Hashtable();


But the problem was the JSP pages passed in just the choice, and there
was no "memory" of where it came from. CartWizard needs to accumulate
the choices in a stack, then use that stack as the key to the
HashMap. It's not at all difficult. But because there was no memory, I
had to copy/paste branches over and over in paths.xml and give them
unique names to get around this problem. In effect I had to code the
traversal information into paths.xml and the pages themselves.

It should have been super small as xml files go. One issue that comes
to mind is backing up. That would have really wrenched the
works... but I know there's an answer. I can feel it. Oh!
Indexing. Each choice increments a number; when they click back they
will get the previous index number. This would have to be tested of
course.




#########################################################################
031105 Wednesday

Oliver asked for examples of folks who weren't charged tax, sent
some. Did a little research on a couple, one turns out to be a new
register; funny thing is, all the things are in place... the frontend
is correct, both in the database and the JSP code.

Finally solved the problem of character encoding when writing out
shell buffer contents:  

(let ( (coding-system-for-write 'no-conversion) ))

Finally:

swain: about to do the productData loop.
PC values: avsState LA 0 0.0
PC values: RegistrationParentZone com 0 0.0
PC values: WebTrafficProfileID 1001973065.563369 0 0.0
PC values: WebPort  80 0.0
PC values: WebAdminEmail admin@fortunecitygold.com 0 0.0
PC values: RegistrationDomainPrefix imadomainnamesorta 0 0.0
PC values: AllowUserAdminEmail No 0 0.0
PC values: avsCountry US 0 0.0
PC values: avsAddressVerification wigglyworld  0 0.0
PC values: avsZipCode 10001 10001 10001.0
PC values: WebTemplateSite FCGDefault 0 0.0
PC values: WebCgiType  4 0.0
PC values: ScriptProfileName FC - Dom Only 0 0.0
PC values: fax  0 0.0
PC values: AccountName Credit Card 0 0.0
PC values: MerchantOid 1.3.6.1.4.1.3999.1.9.1.1.15 0 0.0
PC values: cardHolderName wigglyworld 0 0.0
PC values: RegistrationDomain imadomainnamesorta.com 0 0.0
PC values: Currency USD 0 0.0
PC values: DomainRegistrationType TopLevel 0 0.0
PC values: DelayAdvanceChargesBilling  0 0.0
PC values: UserDomainRegistrationPeriod 2 2 2.0
PC values: email wigglyworld@foo.com 0 0.0
PC values: WebHost www 0 0.0
PC values: DomainRegistrationAction New 0 0.0
PC values: InstallComponentId  0 0.0
PC values: expiryDate 1111 1111 1111.0
PC values: InstallProductId 1029530315.58503 0 0.0
PC values: wizardSource signup 0 0.0
PC values: InstallTargetType  0 0.0
PC values: creditCardNumber 4111111111111111 0 4.111111111111111E15
PC values: DomainRegistrationZones com|net|org|co.uk|biz|info| 0 0.0
PC values: WebQuota  230400 0.0
PC values: TaxRealmId 23 23 0.0
PC values: MerchantAccountId  44 0.0
PC values: AllowUserWebPrefix No 0 0.0
PC values: avsCity wigglyworld 0 0.0
PC values: WebVirtualHostingType Name 0 0.0
PC values: InstallTargetDn  0 0.0
PC values: CVV2 111 111 111.0
PC values: avsTelephone 2223334444 0 2.223334444E9
PC values: DelegationDirective private 0 0.0
[Signup Wizard] Calling RegisterNewClient on Base Module


The issue was: the Wizards are used out of /opt/evw/frontend-evw, and
not the visp frontends. Maybe a Resin misconfiguration? Staging works
the same way.

How does the productData thing get populated throughout the course of
the Signup Wizard?

When we hit Signup Wizard from packagetest.html, 18 params are set in
productConfig_ but I haven't found where from... a number are the ones
I missed while grepping jsp and java files.

Also, we had our 4pm at 430pm; it was delayed by a police raid. About
five cops in bulletproof vests came in, and a detective or two in
plain clothes. There was a site on the FC free site advertising child
pr0n crap. We all had to stay away from our computers for a while, as
a matter of police procedure, but were allowed to continue by 430.

I wrote up the minutes and put them in Twiki; the package sync from
staging to devil was wrong again. The yearly packages have the
quarterly cost profiles.

Found it. All I had to do was read more log
output. /Applications/DomainRegistration/installingConfigCode.jsp is
the missing piece. This is where it all begins.

I think after that everything comes from forms.


#########################################################################
031106 Thursday

Found the last place, I think, where product configuration details are
set. Strange how I missed it. But I did divine that the ProductModule
must get queried, and the package details are then added to the
Wizard's internal HashMap of productconfig_.

I did this by a kind of cheat: when a certain key was being added via
setProductConfig(), I threw an Exception and caught it and printed the
stack trace. This lead me right to the caller, which was in
Wizard.java.

Support meeting with SF postponed until tomorrow; got an 11am with GG
and Jessy on templates. I think I can knock out paths.xml by COB. I
really wanna write my standalone client though.

Post-lunch: I pretty much got paths.xml figured out. Fortunately the
design changed such that everything prior to the domain name search
turned out to be just info pages with no choices... and I see that all
of that is the "hosting" path. So there are three paths, and the page
choices are almost nonexistent. Some variables are pc_ variables that
get posted to Evolutionware.

I think that CartWizard will need an additional module of some kind
that handles/manages all the form data.

For most of the spreadsheet, hosting path, everything just goes to the
billing page. All we care about is the choice token (set in
javascript) which maps to the productID.

Meeting with Jessy and GG went about 1.5 hours. We hashed out the
template design and answered questions about the page flow (which in
turn leads to the design of paths.xml). I can finish this now.

New plan: we don't have a hosting path. We have super, starter,
advanced, personal, business paths.

OK, paths.xml finished. The win was in doing away with the concept of
"hosting," which we don't need, and having all hosting paths as
starting paths:

super
advanced
personal
advanced
starter
forwarding
design

so there are seven of them.

Just got my RegClient.java to get a product by ID and populate a
HashMap same as SystemsFusion does. The code was stashed in
Wizard.java and copy/paste was sufficient.




#########################################################################
031107 Friday

SF dropped the ball again and cancelled our 9am support call. Oliver
posted a review of what I found wrt recurring charges not being
charged. Oliver thinks I didn't follow the plan correctly again.

I checked, and not only did I follow the plan correctly, I have the
insert statements for billingid 351, FC Gold, in my script. So somehow
since Sept. 25th this table got altered. As far as I can tell the
package syncing process does not affect the taxTemplate_tbl so I'm at
a loss for them moment.

Back to RegClient. Looking at the WizardServlet.debugDump method, it
calls Wizard.print, which iterates over productConfig_ and
attributes_, which is also a HashMap. I think I'll just do a manual
package buy right now, and maybe that will give me the next direction
to take this; I've been thinking of doing a step by step audit of the
buying process to watch where pc stuff is set, but screw that.

Well, the approach of taking debugDump and converting it to setters in
java fails. There are a number of attributes that are not fields in
the RegisterWizardDetails. So I have to go through this manually. I
can still do a match and hand edit stuff though.

Well, I could jam them into a HashMap and use that in place of the
code. Hackish but it works.

Zlatin fixed a misconfiguration on cws-1.dvl that prevented the System
module from running. Two things were trying to use the same IP
address.

Earlier it turns out the package sync problems I saw were really bugs
in Safari.

Finally pushed a job through on devil. So it looks good so far, me and
the standalone client.


#########################################################################
031110 Monday

Was on time for 930am meeting, gotta throw the minutes up. Done.

Todo for week ending 11/14:

* By Wednesday I have to complete the JSP templates. This will involve
  taking Jessy's components and making all the logic in
  outertemplate.jsp work.

* By week's end I need to have the reverse engineering of Signup
  Wizard complete. This will require an audit of how product
  configuration information and account information are set up in
  SystemsFusion's Signup Wizard. Currently I know about 10 PC
  variables are retrieved from the Product Module; tax realm ID comes
  from the Tax Module; account type comes from Billing Module (it will
  always be EFTnet); but I have to reverse engineer the whole process
  to be sure all variables are accounted for. I've added this to the
  ProjectSchedule.

* I need to update, at some point, the taxTemplates_tbl on production
  to fix the VAT mess again. I can do this in the off hours since it's
  crunch time... or better yet, this should be pushed off to Ops
  because it's just a simple set of SQL statements (in fact, already
  written). See ticket #1827. It would take me about 20 minutes to
  hand this off to Ops.

GG promised a CVS project for FCR by afternoon. I meet soon with Jessy
to look at her components.

Since sending out my todo list, GG created a project in CVS and I've
been filling it in with directories and files. I can build/deploy a
war file now, and have a Hello.jsp that renders correctly.




#########################################################################
031111 Tuesday

Finished outertemplate.jsp, footer, header, and order_process last
night. Wrote a Perl script to generate links to test the
templating. Had an 11am with GG and JH. Just had a long drawn out
argument about where to store images because PATH_INFO breaks images.

Well. Long day. Interviewed Yogi at 330pm, 4pm meeting on FCR, and
I've been hacking away since 5pm. I've pretty much finished the jsp
templates; they all render with the correct inputs. I wrote a Perl
script to generate links to test the templates with. Very handy.


#########################################################################
031112 Wednesday

So, worked past 7:30 last night and finished the JSP templates. I put
the test page in Twiki that allows one to test out all combinations of
inputs on the template system.

This morning, remembered how to find the workflow product in EVW (I
was looking under FC Gold's control panel instead of Ampira's, and
things like workflows are always created and controlled on the ISP
level). Wrote up doc via email for GG. I wrote a test html file to try
to buy the package in question, and found I could buy the package on
staging but not devil: CORBA system unavailable error, which makes no
sense. I wrote an html form to buy any active package, and that worked
fine.

Next, the SupportRedirectorServlet was failing, and it took a while to
figure out that it couldn't reach the ldap server, and this was
because I specified db2-1.prv instead of ldap-1.prv. I didn't know
about the latter. So that was resolved.

Tried to figure out why the package couldn't be bought, previously
mentioned, and gave up on that for now.

Filed a bug report on the controller servlet. My guess is there's a
problem with paths.xml.


#########################################################################
031113 Thursday

Briefly attended the 10am ticket call. Oliver promised, again, a patch
to show the asterick, this time by COB tomorrow. Which is
Friday. Which means we won't see it.

Meanwhile, itemized what I need to do for RegClient.java, and just in
time for a standup meeting with JH and GG. What would be boss is if I
could do it all today. I asked for no interuptions.

Updated the makelink scripts, and updated the pages in Twiki with the
testing links.

All customer info validation happens in customerInfoCode.jsp, under
DOCHECK.

SelectionBean.addSelection keeps throwing a null pointer
exception. The package ID passed in is valid.

I think the Selections bean will be the place to gather/process
data. I'll leave that to GG. I think I can write RegClient without
having to validate everything; I only care about the package
information, he can validate the customer info.

Ah, only needed a server bounce to get SelectionBean to work
right. Wrong packages.xml info, or none, perhaps. In resin.conf it was
set to packages2.xml... no, only a few packages are being
found. Puzzling.


#########################################################################
031114 Friday

Day started at 930am. By noon I finished, to my joy,
RegClient.java. This is a crucial milestone for the project because it
means we can get away from the Signup Wizard.

After lunch I started on Jessy's design template stuff, but it's going
to be a little hairy. I already have the box and dropdown dynamic, and
now I'm looking for a way to parse strings so I can render the
thumbnails. Tricky stuff.




#########################################################################
031118 Tuesday

If I have time I'll write a summary about yesterday, which was an 11
hour 10 minute day minus a 20 minute lunch.

Working code that calls the DNA service and gets the results back:

<%@ page import="com.ampira.fcsignupwizard.util.DNAClient" %>


<%

DNAClient dnaclient = new DNAClient();

dnaclient.setSoapUrl("http://10.1.1.223/dnaservice");
dnaclient.setTargetURI("DNAService");
dnaclient.setMethodName("do_lookup");
dnaclient.setDomain("housesoftheholy.info");

out.println("<!-- " + dnaclient.toString() + " -->");
dnaclient.run();

int isAvailable = dnaclient.getIsAvailable();
String[] results = dnaclient.getRelatedAvailable();

out.println("<hr>");
out.println("is it available?: " + isAvailable);
out.println("<hr>");

for (int x = 0; x < results.length; x++) {
    out.println("Also available: " + results[x]);
}

out.println("<hr>");
%>


---

OK, so yesterday was a long day. When I came in I was drawn into this
mess where hostv3.com expired. I made frontend changes which
eventually had to be rolled back; Eric's jsp that calls the support
redirector servlet called hostv3.com, so that had to be changed...

Then the meeting came at 130pm. Around that I worked long and hard to
get the design template stuff done. It was a real drag; all this
template stuff is super bitchy and temporate. I finished that around
6:30pm and started on the javascript for the config page. I think that
needs more testing. I left at 8:47.

Today I came in and Gautam provided a standalone example of
querying the DNA service for domain names; I refactored that into a
class for fcsignupwizard and got it working in the jsp files. But then
getting all the little components to do the right thing was an
unending mess, and I think around 5 I had most of it right.

Gautam called me over to talk about wizard stuff. He's decided to try
the approach of using the SystemsFusion wizard code (writing his own
wizard). With this approach we probably won't use the shopping cart
servlet, so all the work I did on packages.xml, paths.xml,
RegClient.java, and Jessy's spreadsheet would be thrown out. Also, it
makes the interfact to the templates somewhat problematic since they
are driven by paths.xml and the cart wizard. So I'm not sure what to
do at this point, and since I only had 3.5 hours sleep last night, I
am too fried to think about it at this point.

I have a short list of things that need doing, plus there's a bug in
Bugzilla to take care of.




#########################################################################
031119 Wednesday

This morning GG and I had a meeting, and he decided to go with
RegClient.java after all as a helper class to the
ShoppingCartServlet. (He described it as a "fall-back plan"). This was
quite a relief. I think we are now on track to have a skin-deep copy
working on staging by tomorrow.

Put in a lot of fixes today; the design templates, the template
system, and regenerated lots of test links including new ones for the
design templates.




#########################################################################
031120 Thursday

It's almost 6, and I've been really at it today. Swolf ordered Indian
for us, and earlier I went out for a shoe shine, but otherwise it's
been constant bug fixing/feature additions to the template system. I
think the controller servlet is starting to take shape. I've made a
lot of commits to the project today.

I don't think I know exactly what GG is doing for error checking, so
I'll work on the paths and testing links for now.


#########################################################################
031121 Friday

In at 8am. Closed some bugs, fixed some that were on my to-do list,
and added all the error checking code Gautam gave me. He wants to do a
rollout to staging after lunch; he feels the client registration stuff
is ready. This is a really good thing; that would mean beta testing is
here. I leave at 4:30pm for Newark airport.




#########################################################################
031202 Tuesday

We "hit the ground running," as Jessy said to me this morning. The
project is in heavy bug fix mode now, and it's in the stage of
testing/fixing pathological cases. It seems the app works fine for
normal usage, so perhaps we'll be ready to launch tomorrow.

I now have at least five bugs to tackle.




#########################################################################
031203 Wednesday

Bugfixing all day yesterday and today. Worked almost 10 hours
yesterday, going on 11 today.


#########################################################################
031205 Friday

Added text messages for all error objects; that is, the
initializeFDE() calls. But that did not give us an error message on
the summary page.


#########################################################################
031208 Monday

It's notable that in the heat of the project I don't have time to make
notes in my log. It's too bad... that is the time where I should
probably write the most.

Had the 9:30, took the minutes; I have an 11:30 with GG on remaining
tasks for FCR, and then we have a 1pm with the whole team. I'm
cleaning up my desk and looking for things to add to my list.

One thing to note is I had to have a policy for the body files of the
template system. Every page has a form at the top,
productWizardForm. This form calls the servlet with pagename and
pathname and choice.

But Gautam decided early on that search would call the template system
directly, so this messed things up a bit since the forms were
hardwired (more or less) to call the servlet... that is, control is
taken out of the controller servlet and placed in the view.

So the policy I developed is this: the outertemplate.jsp would declare
the form, but the body files were responsible for closing it. They
could choose when and where; this allowed me to put subsequent forms
for both the search boxes and the design path.




#########################################################################
031210 Wednesday

Yesterday, worked all day (almost) on the starter path. This included
getting the template logic to work, writing the helper class that does
the subdomain search, and stitching it all together. It was pushed to
staging late in the afternoon.

Today there was a bug in the amount charged and that was a result of
the domain fee always being added to the total in summary_order.jsp.


#########################################################################
031212 Friday

Yesterday, worked on two bug fixes for the 4pm release... the
principle one being domain transfers, which ended in a
NullPointerException because UserRegistrationPeriod was not being
set. The whole office was hung over from Wednesday's Christmas party,
which cut work short on Wednesday. It was a very quiet day in the
office.

I found yet another VAT bug. When I pushed the job through and logged
in as the new user, VAT was billed but not charged. This is because
Gautam passes in the display value for the total amount to Base
Module, and so that is what is charged. So I spent time going through
GenericCreditCardConfigCode.jsp to see how they get the costs, and
there was a smallish block at the end that does this, though it does
something rather dumb (creates a new ProductConfig class, assigns it
to the end of the array, then creates another for TaxRealmId, and
assigns that to the end of the array, thus destroying the previously
created class.)

So I wrote a method for EvwSignupClient and tested it but the String
array we get back from the Product Module does not contain the tax,
even though the right TaxRealmId is being passed in. Strange. So I am
either missing something or I have a bug.

EvwSignupClient:    physicalCountry: "GB"
EvwSignupClient: costs: 0 Package|First month of web hosting|1995
EvwSignupClient: costs: 1 Component|Domain Name Registration Fee|1790
EvwSignupClient: costs: 2 Tax|Tax|0
EvwSignupClient: costs: totalAmount: 3785

Tax realm id is 62, which is correct for FC Gold on devil.

Worked this out by explaining it to Gautam. Too much happens in the
method that registers the client in EvwSignupClient. I'm going to
refactor the user data initialization code into a separate method, and
then we can change the order of operations slightly in the
FortuneCitySignupWizard.

Staging tests for release Wormtongue:

pmfvat:
EvwSignupClient: EvwSignupClient: set taxrealmid to EU: 161
EvwSignupClient: total amount is 53.70
EvwSignupClient: total amount as int is 5370
EvwSignupClient: costs: 0 Package|First Month Fee for FC Gold|895
EvwSignupClient: costs: 1 Component|Domain Name Registration Fee|4475
EvwSignupClient: costs: 2 Tax|Tax|859
EvwSignupClient: in getTax(): tax is: 859
EvwSignupClient: Tax amount is: 859
EvwSignupClient: total amount plus tax is 6229

sqvat:
EvwSignupClient: EvwSignupClient: set taxrealmid to EU: 161
EvwSignupClient: total amount is 14.85
EvwSignupClient: total amount as int is 1485
EvwSignupClient: costs: 0 Package|First three months for FC Gold|1485
EvwSignupClient: costs: 1 Component|Domain Name Registration Fee|0
EvwSignupClient: costs: 2 Tax|Tax|238
EvwSignupClient: in getTax(): tax is: 238
EvwSignupClient: Tax amount is: 238
EvwSignupClient: total amount plus tax is 1723
EvwSignupClient: ccMessage: Approval Message: APPROVED 310031                 

ayevat:
EvwSignupClient: starting RegisterNewClient with productid: 1067352906.401137
EvwSignupClient: EvwSignupClient: set taxrealmid to EU: 161
EvwSignupClient: total amount is 344.25
EvwSignupClient: total amount as int is 34425
EvwSignupClient: costs: 0 Package|First year of web hosting|29950
EvwSignupClient: costs: 1 Component|Domain Name Registration Fee|4475
EvwSignupClient: costs: 2 Tax|Tax|716
EvwSignupClient: in getTax(): tax is: 716
EvwSignupClient: Tax amount is: 716
EvwSignupClient: total amount plus tax is 35141
EvwSignupClient: ccMessage: Approval Message: APPROVED 687687                 



#########################################################################
031215 Monday

Meeting at 9:30. Swolf says everyone who made it gets the afternoon
off for LOTR Wednesday or Thursday, though I dunno if he meant it. I
asked if I could come in late Wednesday instead, he hemmed and said
he'd think about it. I don't mind coming in tired though.

Gautam mentioned last week that the system (FCRedux) needs some
fundamental architectural refactoring. Yup, it sure does. One issue we
face is that we need to connect to EVW every time; no caching is
done. It's not supercritical at this time, because it does not cause a
resource problem as of yet. But the subdomain search client needs to
do this, the registration client needs to do this, and so on. Another
problem we have is blocking the user from buying a domain name that's
already in the system.


---

Gautam,

I'd like to meet and talk about these things:

1) VAT: bug 363. I'd like a little time to research this. It might be
   something local to Devil/Staging, but more likely it's something to
   do with our larger VAT problems. (First guess: package syncing
   borked VAT).  https://bugs.corp.fortunecity.com/show_bug.cgi?id=363

2) Bug 362: user not forced to enter redirect domain. I'd recommend
   Eric do this, and I'll work with him on
   that. https://bugs.corp.fortunecity.com/show_bug.cgi?id=362

3) Add exception classes. I have a couple in mind for the code I
   wrote, and this is just good Java programming practice though not
   totally essential. There are a couple of places where I throw a
   plain Exception but I'd like to improve that with a few exception
   classes that would live in a folder next to util, bean, and
   servet. (I haven't thought of a good name yet... error?)

4) Architecture refactoring: You mentioned last week we need some
   architectural refactoring. The problems we face are coming down to
   the need to connect to Evolutionware over and over... the question
   is, do we need to optimize this? (Early optimization being the root
   of many evils). I need to add a check to domain searches, for the
   DNAClient, to fix bug number 349.  There are a few different
   approaches we can take; the simplest is, optimize later, and just
   add the needed functionality to DNAClient via a small helper class
   that checks the system for the domain name. The most far reaching
   and complex would be to write a servlet that serves up a session
   key and makes sure that session key stays valid before it gives it
   out again. https://bugs.corp.fortunecity.com/show_bug.cgi?id=349

I'm sure you have things on the list as well... lemme know what time's good.

~swain

---

I was just reading the chapter on web development with Eclipse, and
the simplified description of web development really cleared up
something for me:

HTML/JSPs for presentation logic
Beans for the model
Servlets and classes for the controller

And then it was clear how to best refactor the architecture. Jessy's
links from the static HTML first call the servlet, which starts a
session (or clears one) and sends the user to the search page.

Searching is done by DNAClient as a helper class to the servlet.. the
results are passed back via a SearchResultsBean. Perhaps this bean
can work for both domain and subdomain searches.

This paves the way for an EvwConnectionClient class, which maintains
the EVW connection and perhaps returns objects we need (ProductModule,
BillingModule, etc). In fact that way we don't even need to do the
authentication.

This client will be used by the DNAClient, the EvwSignupClient, and
hopefully that's about it. This client will encapsulate the
optimization; intially it can just connect/reconnect/disconnect
through its lifecycle.




#########################################################################
031216 Tuesday

Sent a note about my features/bugfixes for today's release. Tested the
stuff on staging. Swolf working from home today. Tonight is
lotr:trotk.

Gautam filed a bug for Blastmail: most entries have no country value.

The query for V3 asks for the country, but the output doesn't appear
to contain any.

[root@dbm-2 swain]# zcat v3dump20030805.txt.gz |head
cus_email       cus_FirstName   cus_LastName    cus_Sex cus_Birthdate   cus_City        cus_Postal\
Code  ctr_CountryID   cst_CustomerTypeID      con_ConfirmStateID      cus_CreateDate  uri_scheme_h\
ost uri_scheme_path pkg_PackageID
coruno@hotmail.com      Jonas Persson   Last            0000-00-00 00:00:00                     0 \
      1       3       1999-06-07 17:59:00     come.to -andi-  5
delprew@mail.yahoo.com  D       Prew            0000-00-00 00:00:00                     0       1 \
      3       1999-06-07 17:59:00     come.to 2001    5
kengriffeyjr@hotmail.com3       L. Storandt     Last            0000-00-00 00:00:00               \
      0       1       3       1999-06-07 17:59:00     come.to 24.links        5
mlee@engineer.com       Michael Lee     Last            0000-00-00 00:00:00                     0 \
      1       3       1999-06-07 17:59:00     getit.at        michael 5
tullm@gmx.de    T.      Ullmann         0000-00-00 00:00:00                     0       1       3 \
      1999-06-07 17:59:00     come.to 2tears  5
t-s@pobox.com   Takuya  Shigeta         0000-00-00 00:00:00                     0       1       3 \
      1999-06-07 17:59:00     come.to 3b      5
FLipSquad2@aol.com      Chris C Last            0000-00-00 00:00:00                     0       1 \
      3       1999-06-07 17:59:00     come.to 5th.realm       5
htyc7b@yahoo.com.hk     7B      7B              1977-01-01 00:00:00                     0       1 \
      3       1999-06-07 17:59:00     come.to 7b      5
gaoyang@263.net sunny   Last            0000-00-00 00:00:00                     0       1       3 \
      1999-06-07 17:59:00     hello.to        gaoyang 5


Well, for V3, only about 400K of 4 million entries have one. In
generatebulkusers2.pl, for some reason, they are excluded. Ampira paid
customers appear to have them.

I should have done this project from scratch. This is my original
failure with the blastmail project. At every turn something has been
wrong with the way it was done originally.

I should generate a list of all valid email addresses and just do the
whole thing over. It really irks me.

Hmm. GG says jobs are sailing right through without stopping in
vetting. Hrmm.

Most likely cause:

2003-12-12 15:03  swain

	*
	src/com/ampira/fcsignupwizard/servlets/FortuneCitySignupWizard.java
	: Updated the interface calls to the EvwSignupClient. The internal
	state of the client needs to be initialized for preauth and system
	registration now.

2003-12-12 15:02  swain

	* src/com/ampira/fcsignupwizard/util/EvwSignupClient.java:
	Refactored the customer info/package info intialization code. It
	now lives in its own method. Added an internal method, getTax(),
	which returns an integer, and is added to the total.


These should be rolled back to see if that is where the problem
is. These are changes for VAT.

First: in DB2, query the accountholders, accounts tables to find
organisationdns with an install date in the desired range.

Hmm. There are numerous FC Gold people in the journal who were
charged, and judging from the billing statements, they were new
signups and they were mostly billed correctly. Puzzling.




#########################################################################
031217 Wednesday

Spent the morning creating jobs and testing scenarios as to why FC
jobs were skipping vetting. Finally we rolled back the two files I
changed on Friday, and that fixed it.

I think the problem might be pass-by-reference, where I call the
Product Module for the tax amount.


#########################################################################
031218 Thursday

Eliminated: ispDn. This has the correct value.

I'm going to tail the Base Module's log when I start two jobs.

Logs offer nothing; the two jobs have identical output except that 18a
has one extra call to Product Module when I calculate the tax. Logs
compared:

ProductModule.log
Billing.log
Products.log (no output for either job)
GenericCreditCardExtension.log
System.log (no output)
OpenSrsExtension.log (18a only)

I reverted the double to 0d from 0.0000d; no effect.

Pushing all jobs through vetting: in evwbill.genericccvetting, we get:

[swain@evw-1 scripts]$ db2 select distinct status from genericccvetting

STATUS
------
AP
RE
WA

Change all instances of WA or AW to AP. Push the jobs.

db2 "update genericccvetting set status='AP' where status='WA'"

<select name="fqdnState">
<option value='1'>Awaiting Processing</option>
<option value='3'>Complete</option>
</select>




#########################################################################
031219 Friday

Been working out an EvwConnectionManager class most of the day;
started playing around with the idea that we can call the servlet
directly instead of the template system.

I modified paths.xml and the servlet to take nulls for pagename and
choice and change them to empty strings... this works for cases like:

    <cwPage name="">
      <cwChoice name="">
	<cwTargetPage name="search" />
      </cwChoice>
    </cwPage>

that is, the default choice for no pagename is the search
page. Everything seems to work after that. This makes the links to the
wizard shorter and more intuitive:

http://fcgold.dvl.ampira.com/fcsignupwizard/fcsw?pathname=personal

The alternative being:

http://fcgold.dvl.ampira.com/fcsignupwizard/fcsw?pathname=personal&pagename=init&choice=search

The last two variables are extraneous, but then, we can make the
argument that they document what's going to happen next.


#########################################################################
031222 Monday

Gautam was supposed to generate a list for me, of emails I suppose,
for a Blastmail. However none is in my inbox today.


#########################################################################
031223 Tuesday

Spent the day working on that wretched Python script, after doing the
morning meeting and experimenting with the system to try to extract
the data. At some point I decided the best thing was to reuse the
Python script because it queried the Product Module for the package
information.

This was a downward spiral (largely due to me being sick) where I
couldn't get the data structures worked out right. At its heart the
script uses a single global hash of orgDns, which contain a hash of
packageIds, which is a list of one element which is a hash ref. And
that's the rub: I was added a second element to the list, and that
broke it. Terrible, terrible. Took me a long time to see that.

By about 7pm I finally debugged it and generated a small report of
Globalscape stuff... but I'm not convinced the output is correct.

Today I worked out the problems with launching to app-1
(fcsignupwizard). Two issues: wrapper.pl, which I figured out right
away, and jaxp jar files which were not committed to the project (took
about a minute to figure that one out). I committted the jar files to
CVS.

------
MonDec2207:30:312003
oliver - Correspondence added

[Reply][Comment]

Hi,

The respective columns in the 'evwbill.accounts' table for the date, viz.
'instMinute', 'instHour', 'instDay' and 'instYear' are the definitive
date for the creation of the organization. Note that the date is in UTC. If you need
the creation timestamp (in UTC), use the 'dueTimestampUtc'
field.

If you need the package installation date, this can be retrieved from the
'evwprod.PackageActions' table. The field that you would need is
the 'actionTime' field.

Please let me know if you require any other information related to this.


Regards,
Oliver.
------




#########################################################################
040105 Monday

Swolf out ill today. Just getting over a cold myself; I feel tired
(even after a good night's sleep). Weirdly, an arthritis attack has
set in even though I've been good about eating and drinking as of
late.

Generating a report for Rob for 12/15 to 12/31, and meeting with GG at
11am to plan the week.

I did a rollout on Christmas Eve. It turned out there was no entry in
packages.xml for the forwarding path! It's incredible this passed
testing.

Found a new bug with the tax code; assumption that 2 is the position
was wrong, and fixed it to test the string for 'Tax'. Rolled out to
staging; the rounding off looks like it's fixed.


 		dtotal = 100.0000d * dtotal;
                Long tmp = new Long(Math.round(dtotal));
		int total = tmp.intValue();
		stdout ("total amount as long is " + total);

                int tax = getTax(); // tax comes to us without a decimal point
                stdout("Tax amount is: " +  tax);
                total = total + tax;
                stdout("total amount plus tax is " + total);

Well, no surprise why the forwarding path was left out of
packages.xml: the way I filtered it was by looking for the words
monthly, quarterly and yearly in the strings. Forwarding doesn't have
that. So it would be better if all the packages were set active, and
that's how I filter it.

924 jobs on staging; sent another email to ops, cc'd GG.

I traced down the bug where the VAT is not applied evenly. There are
34 cost profiles with no taxids at all. How the hell did that happen.

Tomorrow I'll have to clear that up.


#########################################################################
040106 Tuesday

Wrote an email to GG about why forwarding didn't make it into
packages.xml, and working towards a permanent vat fix. I have a script
written now that updates all taxids for all costprofiles for all
visps. It looks good. I'm now looking at the second part, which fixes
things for recurring billing.

Also updated app-1 for rollout.


#########################################################################
040112 Monday

Was out sick Thursday and Friday. On Wednesday I did a few things, but
mostly dragged due to Nyquil and illness. I helped Swolf track down a
billing issue which turned out to be a UI problem with Eftnet. I tried
to get a Perl script working to get countries for users from
Oracle/Fortune City but kept making simple mistakes. I did a couple
other things which I cannot recall right now.

Was in by 9am today, and I finally got to login to the right machine
to look at the database tables. I can't find any country info. Maybe
GG said V3?

Wrote a perl wrapper, dailyMarketReport.pl, on production. This will
send a daily report to Rob. Also finished exporting country data to 
Blastmail from FC, but it was disappointingly small (275K users out of
how many millions). Sent a request to Eric to do bug 367, which is
where users are not forced to enter a forwarding domain.

I found a simple way to add the org creation date to a copy of the
market report, called anniversaryReport.py. Gautam said he'd write a
Perl script to munge the output into what Rob wants. I thought this
was a hackish thing to do, but he felt it was the best answer for now.

The original problem I had was in trying to add the org creation date
to the overly complicated data structure the script employs. It adds a
hash ref to an array that itself is pointed to by a hash of a
hash. Messy. In a for loop later in the script, the loop fails if
there is more than one element in the array.




#########################################################################
040113 Tuesday

The cron job for the daily marketing report sent Rob the December
results... puzzling. However that was the last thing created last
night... but then, that was the last thing generated by me for Gautam;
but then, the timestamp was 5am! So it makes no sense. But I didn't
look at the file before I erased it so perhaps the old file got sent
before the new one got generated.

We met and discussed software upgrades to talk to SF about; and
planned out refactoring for FCR. Fortunately GG went for the idea of
it, rather than leaving things be.

Oliver finally confirmed that the tax structures table is only
populated from data from the costprofilecomponent table. Yay. This
clears the way for a permanent vat fix.

Wrote a bean for the DNAClient results; modified the jsp page to
render the bean. Easy. Hard part next: move DNA call into the
controller servlet, pass the bean via the session. Well, shouldn't be
all that hard.




#########################################################################
040114 Wednesday

Found the problem today with the daily FC marketing report. The silly
script was running in the wrong directory. Classic cron job problem.

I ran the report for countries for Swolf, since he asked me to do it
prior to GG's arrival. Now GG wants this filtered so it's only opt-ins
but I don't think it's needed.

I'm also running the marketing report for all properities for all
time, again.

GG and I tried to mod Mail.app to do the three horizontal panes, with
some success... but I decided I didn't like it on this 17"
monitor. It would work better on my laptop.

So... followed the threads on emacs-devel and found a link to a page
where a Japanese guy has automatic builds and dmgs to download!
Amazing. Choi resigned because he didn't want to deal with FSF
politics.

I just have to get fcsw to follow the proper flow and I should pretty
much get what I need done today. A new case is where the user goes
from the results page to the results page. (yay!)

 


#########################################################################
040115 Thursday

Debugged the code I moved from the jsp to the servlet... one problem
was getting context params from resin.conf: 

                ServletContext application = getServletContext(); 
                String soapurl = application.getInitParameter("DNASOAPURL");

It looks like everything's working. I have to add code for pending
jobs, and refactor the connection class into the code next.

Looks like it's all working now. I added the code for checking the job
system, and the only problem was I forgot to deploy the war file (duh)
so I wasn't seeing my changes. I noticed a text message in the log
hadn't changed, which is what tipped me off. I've been browsing the
interface looking for a way to test to see if a domain already exists
in the system.




#########################################################################
040116 Friday

I rolled out to staging yesterday the release candidate Degobah. This
fixed the bugs where users could enter duplicate jobs for the same
domain, and the cache was not getting cleared; plus Eric's Javascript
to force the user to enter a forwarding domain.

This morning I went on another hunt through the logs for Infinite
Design Inc. They have an outstaning balance of $0.01, on a charge of
$14.98 that should be $14.99. Sunil has been pulling logs for me for
two days and I couldn't find anything; it turns out the timeframe was
not covered in the logs he pulled, so I emailed yet another request.

I need to find out why there is no path info on the results page (in
the URL), and I should look into using the new evw connection class
for the evw signup client.

I finally isolated the penny errors to another rounding error, this
time in order_summary.jsp:

SWAIN: domainprice: 8.95
SWAIN: total currently: 8.95
SWAIN: total now: 14.989999999999998

I think I'll write a function to fix this problem. Doubles suck ass.

Helped ops with a Python problem; showed them the javadocs for
evolutionware on devil, which IMO is far superior to the crappy
doxygen docs on SF's web site.




#########################################################################
040119 Monday

ims-1 is hosed this morning, and appears to be so since
yesterday... (who was on call?)

I updated Twiki pages for testing FCR on staging, but with DNS being
super flaky there's little we can do about testing. I also realized I
have changes to make for the design path so it calls the servlet
instead of the template system; but this is not a show stopper since
the only thing that happens is the session cache object is not
cleared.

At this point (11:29) I can't even test my changes on Devil, since DNS
lookups fail. (I'll just put it in my hosts file though, should work
fine).




#########################################################################
040120 Tuesday

Hours of frustration ended when I called Chris Van Wie and got a
pointer: it turns out Rob forgot that .info, .uk and .biz could only
be bought for a two year period. So I have to put a fix into one of
the JSP components now.

Today I fixed the bug, which was a defficiency in the requirements,
and got that uploaded to staging eventually. I've had to wait long
periods of time for things like CVS and ssh. Things have been weird
since yesterday's failure with ims-1.

SF replied to our ticket on how to tell the package that was upgraded
to. Actually, one short fix is to just add another column with the
package ID. Cheap.

Finally got the anniversaryReport.py stuff worked out.


#########################################################################
040121 Wednesday

Rob likes the new report structure, and wants it to replace the old
marketActivityReport.py. I think I can add the email address as well,
and he'd like the other date split up if possible.

I thought initially: SF's code for this script got all orgDns for each
run, but this is not true. It does, however, run an ldap search for
each orgdn, which might be a bit slow.

But the first query, the outer join, is the real resource/time hog. It
takes forever.




#########################################################################
040122 Thursday

The cron job hosed the v3 report that ran last night so I reran
it. Again, sent it out without converting tabs to commas. Oh well. I
installed Gallery on pork (cws-1.dvl.ampira.com), installed the
binaries, and all was well. The UI was not cool though... I had to
read the manual to figure out how to add photos, but the upload tool
was simple and worked just fine. Will meet with GG at 4pm to outline
the provisioning process.

Chris Van Wie: 415-640-7144 (cell)

Read through the install for Squirrelmail, which looks really
easy. The config file is just a set of key/value pairs so that should
be easy enough to automate.


#########################################################################
040123 Friday

Late yesterday, I plunged into the code and changed it to use ints
instead of doubles. By the time I left, I only had one bug: the int to
string method I wrote had an off-by-one error. I solved that when I
came in.

I discovered DNA was down and this lead to a quest between GG and ops
to find out why, and why it wasn't reported.

I then found out that the design package has a wrong price which lead
to a $0.45 discrepency. Rob error.

By then it was almost noon, sadly. After lunch I found pork had /usr
at 100%. I freed 15MB and emailed ops; also mail won't work due to
domain name resolution problems.

Squirrelmail and Gallery have both been tested with 4.2.x, so we will
probably go with that. I want to assess 4.3 and see what it offers.

Upgraded pork's PHP from 4.2.0 to 4.2.3. Tested Gallery
(add/resize/delete) and it's pretty spiffy. I wonder how hard it would
be to mass convert my rrw site to Gallery.




#########################################################################
040126 Monday

In by 9:23. Swolf late, perhaps no staff meeting. Rover Opportunity
kicking ass.

I emailed Gautam with a short test plan for Endor, to be released
later today.




#########################################################################
040127 Tuesday

Worked through some problems today with Devil: ampira packages cannot
be bought, and the error makes no sense. Filed bug report for ops.

Then I got involved with the job queue on staging, trying to figure
out why some jobs were not moving. To make a long story short they are
waiting on cc auth and not vetting, as I misthought. (Is that a word?)

Note: fix the problem where ~swain/gallery/setup/ does this:

The requested URL /home/swain/public_html/gallery/setup/index.php was
not found on this server.

Installed Exuberant ctags on devil, pork and ketelone. Now have PHP
support.




#########################################################################
040128 Wednesday

Got gallery checked into CVS. I talked with Zlatin this morning about
web site provisioning and got the picture on how that's laid
out... talked with Rob about the specs for the gallery project, and
with GG before that. So I think the project is taking shape. It looks
like development falls into three tasks:

1) provisioning, which will involve a script for ops
2) a control panel page to configure gallery
3) frontend changes to accomodate the new package

I changed, tested, commited and rolled out to staging release "Force"
of FCR. This has the domain forwarding path change (price change).

Ordered a 40GB hard drive, $56 shipped.

Did a test for PHP processing under a visp dir, no dice. But we
probably don't want that anyhow. We want to access EVW for user data.

Problem: gallery will live on the frontline servers. But the control
panel operates on evw-1. Answer: if the network allows it, we can
require_once("http://evw-1.prv...username/config.php") to load the
configuration. Then editing the config files can indeed take place on
evw-1. No monkeying around with files on cws-N.


#########################################################################
040129 Thursday

Updated the project schedule, wrote a technical description, and
figured out/added CALENDAR features to the schedule page. Sent a
request for comments.

Late yesterday, I realized that editing the config file from the
control panel couldn't be done because the config file lived on the
frontline web server. After batting around solutions with Zlatin,
Gautam intervened and outlined a process where we customize Gallery so
that the setup dir can only be accessed when the referrer is the
control panel... in other words we modify Gallery so that there is no
recognition of a secure or configure mode. To all referrers it appears
to be in secure mode except from the control panel.

I want to finish all my work on it by next Friday, which I think is
doable. The amount of work actually shrank as I spec'd it out.

Wrote a Perl script to generate the necessary shell commands to build
the directory tree for Gallery and hardlink all the necessary files. I
have a build in ~/public_html/tmp that works. It still needs to copy
some actual files over and chmod them.


#########################################################################
040130 Friday

Came in, box was frozen again. Actually what happened: I wiggled the
mouse to bring up the login prompt. It actually brought up the screen
saver, but the little "Star Trek neuralizer" thingy was spinning. No
login prompt. One of the LOTR-on-the-go images was up from the screen
saver. I could ping the box but ssh got a connection refused. I hit
reset and when the box came up I got the ? folder icon. Hitting reset
successively got more of the same. I power cycled it, giving it five
seconds powered off, and it came up just fine. Perhaps later today
I'll install OS X on the 10GB drive as a precaution.

I deployed FCR to app-1, which contains the price changes for domain
forwarding and emailed a request to switch over.

Checked the win2k box for MyDoom, all clean. Configured Software
Update.




#########################################################################
040202 Monday

Was a few minutes late to meeting, but it hadn't started yet (did the
fish slapping dance earlier). Notified the team I need a meeting today
or tomorrow to sort out the Gallery project; need package from Rob and
PHP upgrades on staging and production.

Went through my notes and scratch sheets, and crafted a grand todo
list which included some things that have been pending for weeks (like
freeing up disk space I took while doing blastmail stuff).

Ski trip meeting moved to tomorrow, 12:30.

Worked a little bit on an Elisp command to convert a unix timestamp
into a time string (like Mon Feb  2 15:09:21 EST 2004). The trick is
(format-time-string) takes a list of three integers, as returned by
(current-time). So I have to take the string "1075750819," convert it
to an integer, and then use (lsh 1075750819 -16) to get the leftmost
bits, and do an AND operation to zero out the leftmost bits leaving
the rightmost bits. The third arg is the number of microseconds so
hopefully we can leave that as zero. I have to duplicate the list
returned as well. (list 1 2 3)

(lsh 1075750819 -16) should return the most significant bits. (Returns
"30," which doesn't instill confidence).

(format-time-string "%Y-%m-%d %T%z" 
  (list 
    (lsh 1075750819 -16) 
    (logand 1075750819 4294901760) 0) 
  )

Whipped up a quickie script for Gautam to find valid FQDNs on
Staging. First, an ldapsearch for all evwzones:

ldapsearch -h evw-1.dev.ampira.com -p 400 -D "cn=Directory Manager" -w
11223344 -b "o=FC Gold,ou=Clients,o=DMFC" "(objectclass=evwZone)"
evwzone

Then, on 10.1.1.50 I made this script:

#!/usr/bin/perl                                                                                                   

my $debug = 0;

use strict;
use Net::DNS::Resolver;

open INFILE, "<domains" or die $!;


my $res   = Net::DNS::Resolver->new;


while (<INFILE>) {
    chomp;
    my $fqdn = $_;
    my $query = $res->search($fqdn);

    if ($query) {
        print "yay: $fqdn\n";
    } else {
        warn "query failed: ", $res->errorstring, " $fqdn\n";
    }

}


I had to filter/parse the results of the ldapsearch output for the
domain names first.

Rolled out changes for Jessy; new freebie added to FCR.


#########################################################################
040203 Tuesday

Gautam approached me today for dates on when Gallery deliverables
would be met. This would have been avoided if I had been more
proactive: I didn't fill in the dates on Friday in the project
schedule; I didn't attach dates to my todo list yesterday. On a
smaller note I should have pushed harder for a meeting on Gallery,
since I need things from ops.

mod_rewrite and local .htaccess are supported. However there is no
mod_referrer or mod_referer, and little on Google turns up. I can do
something in PHP for this though.

GG replied to an email with a solution for referrer checking and said
to not worry about this task. It is so done.

---

It turns out Squirrelmail will be an SF sanctioned upgrade! This
changes everything. Unfortunately I just found out Rob wants a more
extensive, more custom interface to Gallery than previously
thought. I should have gone over the spec with him, but when I read
it, it seemed just a reiteration of the existing interface.




#########################################################################
040204 Wednesday

Getting the clean data into Blastmail. I had a chat with Swolf this
morning and explained that I did not engage Rob on the Gallery
interface, which I should have done at the start; I didn't want Gautam
to have to explain this. I don't think it's a huge problem though, nor
will it cause much of a delay.

I replied to GG, who asked for an update on my activities. I also
informed him of the additional requirements for Gallery, but he said
he'd push back on Rob to try to simplify the interface.

Fixing eftnet gateway ("SECURITY VIOLATION"): When Ops does a package
sync the merchantid and merchantname are carried over into the credit
card gateway config. These need to be reset to the test values.




#########################################################################
040205 Thursday

Well. Yesterday, after lunch, spent most of the afternoon fighting
with pork and cws-staging trying to test user web sites. In the end it
turned out the configuration on both was so utterly fucked up that it
took hours of guesswork just to get pork in an almost working
state. You can't use devil or pork as your nameserver to see user
sites on pork, but you can hardcode pork's IP address in your hosts
file and point the user site at that, and get results. So it's
passable.




#########################################################################
040206 Friday

Started reading up on the Support Wizard stats project; had an 11am
with Gautam and Ron to cover it. Did some config work/software
installation on my Mac, having just installed Panther on a 6GB drive.

Met with one Greg McNulty. Can't place why the name sounds so
familiar. He was OK. Two master's degrees.

Been reading docs on Support Wizard.


#########################################################################
040209 Monday

I need to write up my TODO, as well as a spec on the stats
project. The part that puzzles me is how to involve Ron.

I combined my week end review with today's todo list. I really can't
write a proper todo list until I spec the gallery project.

---
	From: 	  swain@ampira.com
	Subject: 	TODO list week ending 2/13/4
	Date: 	February 9, 2004 10:46:04 AM EST
	To: 	  dev@ampira.com

Gautam,

This week's focus is on the stats project, which is the number one priority. Everything else waits until this is finished.

* I owe you a time estimate on the project by this afternoon. Once that is done, I'll have an idea of what I'm doing for the rest of the week.

Meanwhile, from last week's list: a status update.

* Gallery meeting: I will need Ops to install binaries (netpbm, etc) and upgrade PHP on staging and production. I need Rob to create the package on staging and add a node to the CgiTree to access the Gallery setup. I will need you to do the referrer check stuff, or clue me in to it. (Need this today or tomorrow).

done (the meeting part)


* Write spec/estimate on adding the new path to FCR for Gallery.

done


* I need to rewrite the copy for the final page after the user changes the Gallery config.

On hold until stats project is completed.


* Update/write installation docs for Ops. There are two levels to this: installing Gallery for the first time on a server, and installing Gallery for the customer. Some of this is already in Twiki.

done


* Also write a doc on how a later upgrade to Gallery might work.

On hold pending stats project.


* The deployment script I wrote does the following: generate a local PHP file for the user's web directory; generate a shell script for Ops to run, which builds a directory structure and makes hard links to all the needed files. This is in a late alpha/early beta stage.

I'd now categorize this as late beta. I successfully tested it on Pork.


* We need to find out if the front end servers support mod_rewrite, user-level .htaccess, and referrer checking.

done. We won't use referrer checking, as per you. I need to put a module list for each of dvl/dev/prv in Twiki.


* My new hard drive should arrive this week, so I will need to reinstall Panther. I have everything backed up (most of my work is in CVS; I rsync my home directory to Splinter).

done. Drive goes to the general pool. I settled for an old 6GB.


* Bug 377: there is no PATH_INFO  on the domain results page.

permanently deferred


* I need a Python script that generates the latest billing statement for a given org. This will give me a huge speed up in testing FCR. I don't think it will take too long to write.

I estimate this at a half day's work.


* A code review for EvwConnectionManager, if still needed. I know you recently started to use it... did you add to it?

Still need an answer to this...


* Find script to auto-provision Mysql for Ops: I think this was lost when my hard drive failed a few months ago. It will have to be rewritten, but that's a small project.

Definitely gone. Please reschedule this.


* Clean out /opt/swain on two boxes: 10.1.1.50 and scn-1. This is left over from the Blastmail cleanup. There's a few gigabytes of disk space being wasted until I do this.

Still pending.


* Refactoring of the SupportRedirectServlet. In particular this needs two things: refactor the LdapConnection class, which should throw an exception when it can't reach ldap (currently it traps it and doesn't do anything), and someone should be notified when this happens (either email ops, support, or both; and display a useful error message to the end user).

Still pending.


---


Gautam replied and told me to send my todo lists directly to him (I
sent it to dev@ampira.com).

IIRC, Support Wizard implements its own cron facility in Perl to
rotate logs. This is probably a Windows feature.

Updated my authorized_keys file on the CVS server, so I can log in via
ssh without being prompted for the password. From
http://sourceforge.net/docman/display_doc.php?docid=761&group_id=1#sshkeyauth
I followed the basic recipe of:

$ ssh-keygen -t dsa -C "username@shell.sf.net"
Generating public/private dsa key pair.
Enter file in which to save the key (/home/username/.ssh/id_dsa):
Created directory '/home/username/.ssh'.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/username/.ssh/id_dsa.
Your public key has been saved in /home/username/.ssh/id_dsa.pub.
The key fingerprint is:
f3:31:a8:c6:82:18:c8:0f:dd:6b:fb:27:98:83:3d:3b username@shell.sf.net


The .pub key has to go on the remote server in the authorized_keys
file.

Having trouble finding where JeffO ever calls the database in the
stats project. It's as though it never happens...

Dvl database for Support Wizard:
mysql -uroot -p'w!zard!' -S /opt/isc/mysql/data/mysql.sock sw_std

AIM IM with jeffoatrulez
2:53 PM
Steve Wainstead: ping
2:55 PM
Steve Wainstead: i have two general architecture questions about the stats project, if you can remember that far back...
Steve Wainstead: 1) i can't find where the sql queries are called. they are defined in one of the DB modules but I don't see where it's ever called.
Steve Wainstead: 2) you kept all the queries in sw_queries.sql, but that file was never used, was it? the queries are all in DB.pm
jeffoatrulez: hrm.
3:00 PM
jeffoatrulez: the queries were called as callbacks from the template TOKENs so we didn't needlessly run long queries that weren't in the template.
jeffoatrulez: sw_queries.sql just holds my notes.
jeffoatrulez: the queries themselves should be in DB.pm or something like that.
jeffoatrulez: see FC::Stats::SupportWizard::DB
3:05 PM
Steve Wainstead: oh they are, and i found that file a while ago
Steve Wainstead: oddly though , reading the runCronWeekly() method, i can't see how they are ever called.
jeffoatrulez: see FC/Stats/SupportWizard/Engine?
jeffoatrulez: actually, ignore that.
jeffoatrulez: the TAG_QUERY_MAP maps queries to template tags.
Steve Wainstead: yeah i read that part too
Steve Wainstead: export CVSROOT=:ext:swain@65.244.88.50:/opt/cvs
Steve Wainstead: you can probably do a cvs checkout 
jeffoatrulez: ( i have a copy. )
Steve Wainstead: 
jeffoatrulez: 
jeffoatrulez: cvs.rulez.com/
Steve Wainstead: oh, nice.
Steve Wainstead: it's not that large a project
Steve Wainstead: but as with any object oriented application, seeing how the objects behave is the hard part
Steve Wainstead: and *what* they do is obvious, mostly, from the names
Steve Wainstead: you sure do love perl refs 
3:10 PM
jeffoatrulez: lol
jeffoatrulez: so what are you trying to figure out?
Steve Wainstead: well, we have a new spec from support
Steve Wainstead: they want a few queries added
Steve Wainstead: it's beena while since i went spelunking in the sw database
jeffoatrulez: ah, gotcha.
Steve Wainstead: but i figured it all out once before, i can do that again...
Steve Wainstead: integrating new queries will mean adding them to your DB class
Steve Wainstead: then i just have to figure out how to call them
Steve Wainstead: (acutally, explaining all that to you just now was helpful)
jeffoatrulez: once you add it to SupportWizard::DB, you just use the key name in the template.
jeffoatrulez: everything else should be taken care of.
jeffoatrulez: the only other place you may need to tweak is the excel code.
Steve Wainstead: ah! queries are executed in the templates?
Steve Wainstead: i didn't grep any of those files. doh.
jeffoatrulez: as callbacks from the templates....
Steve Wainstead: right.
3:15 PM
jeffoatrulez: and don't forget to add your new query to 'stored_stats_xml.tt2' so that it's stored.
Steve Wainstead: i wouldn't accuse you of putting executable application logic in a template 
jeffoatrulez: ( yuck. )
jeffoatrulez: thank you. 



#########################################################################
040210 Tuesday

So yesterday I read and read and read JeffO's code, but I think it's
like GG said: it's overengineered. I need to get an xml file to Ron
this morning; GG smacked me down because I was helping Jessy with
something not related.

Conversation with JeffO, which contains some important nuggets about
stats:

AIM IM with jeffoatrulez 11:27 AM
Steve Wainstead: ping!
Steve Wainstead: two quick questions. stats stuff.
jeffoatrulez: shoot.
Steve Wainstead: ok, in /opt/stats-data/xml
Steve Wainstead: these little xml files are used to construct the excel sheet?
Steve Wainstead: and the <tag>PD_ALL_OPENED_TICKETS_VISP</tag>
Steve Wainstead: is used for what? the query already ran
Steve Wainstead: so is that for display data?
jeffoatrulez: the xml docs are the stored results of the queries.
Steve Wainstead: ok
jeffoatrulez: so that the queries don't need to be run again.
Steve Wainstead: and the queries are not ... right
jeffoatrulez: i.e., for weekly summaries, etc.
Steve Wainstead: not run again, is what i was to say
Steve Wainstead: right
Steve Wainstead: now, the plain text reports, which look like ordinary mysql output...
Steve Wainstead: come from where? 11:30 AM
jeffoatrulez: ah! those are from a perl script which runs straight-up against the database using mysql.
Steve Wainstead: you don't say! so...
jeffoatrulez: that call should be in cron ... maybe.
Steve Wainstead: no, only the weekly thingie is in cron, which now runs daily
Steve Wainstead: for a rolling seven days report
jeffoatrulez: hrm. look at the function with TRT in its name.
Steve Wainstead: which i found out this morning that support no longer reads since christina "doesn't trust it"
jeffoatrulez: lol.
Steve Wainstead: and overall she doesn't understand what's in the current report
jeffoatrulez: look for swGenerateTRT.pl
Steve Wainstead: found it
jeffoatrulez: ./bin/swGenerateTRT.pl generates the text files.
jeffoatrulez: it's called from SupportWizard::Engine
Steve Wainstead: i think i know what i need to do for this morning
jeffoatrulez: _getTRTFileNames()
Steve Wainstead: gg wants me to hand-edit a .xml file for a guy we hired in support
Steve Wainstead: he's just out of college, cs grad
Steve Wainstead: and gg wants him to take over this project, mostly, somewhere down the road
jeffoatrulez: and tell christina: gigo.
Steve Wainstead: i need to take an output xml file and add three new <item>s to it
Steve Wainstead: (does she know what gigo means?)
Steve Wainstead: so i guess i'll fake some data baseed on the spec
11:35 AM

Interruptions today: lunch, Peter, Zlatin, Ron, the interview. Sigh.


#########################################################################
040211 Wednesday

In early; was up early. I have decided to work on the other queries
since I'm kinda stuck on the first one (all currently open tickets). I
found I couldn't login to support.ampira.com and had Jeff reset my
password. I tried to do it in the database but it didn't work.

I had an inspiration later: I was trying to extract the information
from the wrong table. There are two tables for tickets: "reports"
holds one entry per ticket, and "reports_h" holds all entries for each
ticket. I was trying to use the latter, since it tells what state a
ticket is in... but "reports" holds the current status after all. It
turned out to be a lot easier.

I got a message at 12:15 from my third floor tenant that she lost
power in two rooms so I had to take an extended lunch. I didn't get
back until 2:20.

I misread an email Gautam cc'd me on, thinking he meant for me to
investigate a ticket that might be FCR related. It was. In fact, Sunil
opened that ticket back before the fix was rolled out (it was a $6.04
error for Domain Forwarding) so I updated the SF ticket and the
Bugzilla ticket.

I worked until about 7:20. GG was out sick.


#########################################################################
040212 Thursday

In by 9:30. Meeting with GG at 10:30 for a status update. I have all
the queries written, except the weekly average one is not averaging
out the results as of yet... I have the time in hours/minutes/seconds
for each ticket, from open to close, and that has to be averaged out.

Status update meeting: I presented my six queries, illustrated the
problems with the sixth, and laid out my idea that JeffO's code base
is not worth maintaining. The problem with the sixth query is that an
average might not give them meaningful information; the longest to
close last week was over 3,000 hours while the shortest was under one
hour. GG recommeded computing the median. This, it turns out, is a
hard problem in SQL. Celko's book offers several solutions, almost all
of them requiring features not in mysql (nested selects, UNION, views,
etc). There is one solution that involves creating intermediate tables
that might work.

Updated the project page with a link to JeffO's docs on the deployment
of stats, which looks mostly up to date. I need to flesh out the
schedule.

Upgraded Bundle::CPAN on spt-1.dvl. Added several modules that stats
needed; probably because of the Perl upgrade done as part of the
Unified Login project.

Meanwhile, it took quite a while to get stats running on spt-1.dvl due
to it trying to use the wrong socket. I finally solved it by putting
this in:

<database>sw_std;mysql_socket=/opt/isc/mysql/data/mysql.sock</database>

That is, hardcoding the path to the socket in the database params. The
other problem was swGenerateTRT.pl had the wrong password hardcoded
in, and there is a (probably) harmless error:

[ info ]  FC::Stats::SupportWizard::Engine::_generateSpreadsheet->( Writing section to worksheet, tag => PD_ALL\
_OPENED_TICKETS_VISP )
Issuing rollback() for database handle being DESTROY'd without explicit disconnect() at /opt/stats/lib/FC/Stats\
/Data.pm line 133.
swain: eval error: Transactions not supported by database at
/usr/local/isc/perl5/lib/DBI.pm line 433.

I put in the print statement to show the value of $@. If the DESTROY
called disconnect() it would probably go away.

Now I need to shift the clock on spt-1.dvl to see if I can generate
the right data.

ugh. Since lunchtime I've gone 'round and 'round trying to get the
stats project to run against the dvl database. It took a long time to
satisfy the module dependencies and get the socket set right; with all
that done, I tried to import the data from the existing production
database but SW doesn't like the file from production. I tried
changing the system clock but just got a lot of empty files.

GG helped with the export of data. Then again; it turns out there are
two 'export' tabs in SW. I used the wrong one. I've been waiting
forever on a file transfer from production to bastion; while that's
happening I wrote the new methods for DB.pm. They are all in and the
syntax is clean (according to perl -I/opt/stats/lib -wc), so all is
good. I have to add the new TAG_QUERY_MAP entries to the template file
as JeffO specified; pretty straightforward.

OK, stuff added to stored_stats_xml.tt2. File transfer at 74% and I'm
outta here.



#########################################################################
040213 Friday

Changes:

bin/cronWeeklySWStats.pl
bin/swGenerateTRT.pl

Both have the shebang changed.

 doc/sw_queries.sql

Changed the p3 to p7.

lib/FC/Stats/SupportWizard/DB.pm 
templates/swstats/stored_stats_xml.tt2

Added new queries to these.

Today: 12:30 free lunch, followed by new HR meeting, followed by an
interview with a guy from Rochester. I was getting back into the
problem solving mode but had a 4:30 with GG and Ron about Stats. GG
then shoulder surfed as I showed the issues running stats on dvl and
prv; no data and a ref error, respectively. Got no help though.

Fixed, output to the xml file is correct. I had to use "name" and
"value" to name the outputs.


#########################################################################
040217 Tuesday

In by 9:24; no meeting today. Reviewing where the stats project is,
and the short of it is there is no specification written down so I
don't know what's next. On the other hand, I could work on the
new stuff making it into the spreadsheet. I also need to resolve the
issue of average versus median.

You can order by an expression that is evaluated at runtime!!! Dig the
ORDER BY clause here:

mysql> SELECT F_RecordID AS "Ticket #",
SEC_TO_TIME( UNIX_TIMESTAMP( F_Modification_date ) - UNIX_TIMESTAMP( F_Date ) ) AS 'Time To Close'
FROM p2_v_reports r, p2_v_reports_h rh
WHERE
(to_days(now()) - to_days(r.F_Modification_date) <= 7 )
AND
(to_days(now()) - to_days(r.F_Modification_date) >= 1 )
AND
( rh.F_RecordID = r.F_ReportID )
AND
rh.F_NewValue = 'Closed'
GROUP BY F_Time
ORDER BY (UNIX_TIMESTAMP( F_Modification_date ) - UNIX_TIMESTAMP( F_Date )) ASC
;

Wrote an email to Gautam, as we discussed. He will ask Victoria for
the best way to represent the data to Support: average, median,
distribution, etc.

Jessy out today. Oh, gotta file for my vacation.

---
	From: 	  swain@ampira.com
	Subject: 	TODO  to 2/20
	Date: 	February 17, 2004 12:00:41 PM EST
	To: 	  gautamg@ampira.com

Stats:

* Code the solution to the average/median problem. I'm going to work
on this today, and pending what Victoria has to say, this should be
wrapped up by day's end. At the very least I'll work out average and
median in Perl.  Est: Today

* Work out the last query, set aside for the next iteration. This is
for when UserContact="Phone" which Support needs to compare to the
phone logs in our new location.  Est: today

* Coming up: Ronny will have the UI stuff done and we will go into
testing and/or feedback from Support.  Est: we'll have a better idea
after our meeting this afternoon

Gallery:

* Update project page.
Est: today

* Check to see if we are affected by the exploit for 1.4.1.
Est: 2/17

* I need to verify Sunil's installation of PHP/Gallery on staging.
Est: 2/17

* Get URLs for Rob to create control panel links to Gallery functionality.
Est: 2/17

* Test deployment script on staging, if the PHP upgrade was a success.
Est: 2/17

* I need to rewrite the copy for the final page after the user changes the Gallery config.
Est: 2/17

* I did not record in my LOG.txt what the decision was on the
administrative interface. The issue was: Rob wanted a set of custom
PHP pages to do certain tasks in Gallery, and these would be linked to
from the CgiTree. You were going to push for using the existing
interface. Do you recall what the outcome was at the last meeting?
Est: depends on the outcome

Things get a little fuzzy at this point; by Wednesday COB I should
have a better idea on what remains for Stats and Gallery. Meanwhile,
here's the list of things I need to get done at some later point:


* I need a Python script that generates the latest billing statement
  for a given org. This will give me a huge speed up in testing FCR. I
  don't think it will take too long to write.

I estimate this at a half day's work.


* A code review for EvwConnectionManager, if still needed. I know you
  recently started to use it... did you add to it?

Still need an answer to this...


* Find script to auto-provision Mysql for Ops: I think this was lost
  when my hard drive failed a few months ago. It will have to be
  rewritten, but that's a small project.

Definitely gone. Please reschedule this.


* Clean out /opt/swain on two boxes: 10.1.1.50 and scn-1. This is left
  over from the Blastmail cleanup. There's a few gigabytes of disk
  space being wasted until I do this.

Still pending.


* Refactoring of the SupportRedirectServlet. In particular this needs
  two things: refactor the LdapConnection class, which should throw an
  exception when it can't reach ldap (currently it traps it and
  doesn't do anything), and someone should be notified when this
  happens (either email ops, support, or both; and display a useful
  error message to the end user).

Still pending.


---

Put in for vacation March 15th through March 19th.

Conversation with Rob: UserContact=='Phone' should be monthly for
now. We got into a discussion about Ampira, since I wistfully wish
we'd do a frontend redesign like V3 and FC, but he assures me it will
never happen. What they really want to do is unify the brands because
it's too much trouble to maintain them separately.

Rob asked about his changes to the marketing report, which I will now
spec:

ACCT NUMBER  (new)
FIRST NAME (new)
LAST NAME  (new)
ACTION DATE (Please merge dates together into one field.  Drop the hour and
minute)
ORG DATE (Please merge dates together into one field.  Drop the hour and
minute)

These should be trivial to add

PACKAGE LEVEL (See Notes below)
PACKAGE BUILD TYPE (See Notes below)
PACKAGE BILLING TYPE  (See Notes below)

This involves splitting a string, so it will be subject to GIGO. Easy
to do.

DOMAIN  (see notes below)

He wants the domain populated for every package event. I'm not sure
this is possible.

Met at 3pm with GG and Ron for a status update. Worked the remainder
of the day putting in the median code, which presented some issues
with integration into the framework. I used mysql to convert from
seconds to hh:mm:ss format.



#########################################################################
040218 Wednesday

Met with Ronny at 9:20 to see if he needed help. Cleared up some UI
issues about columns; explained median versus average to Christina,
which caused her and Rob to approach me about the subject. In short he
didn't trust median as the correct value; Christina and I went over
the values we got for averages, and found some fundamental problems:

1) Some tickets are closed and reopened a number of times. The time
   the ticket was closed is added to the average.

2) Some tickets go to the customer (they have been worked on) and may
   not be responded to for a long period of time. This also skews the
   average badly.

GG told me that we should give them the median and tell them it's the
average, that this is what he told me to do originally and not put us
in a position of explaining to management the difference between
average and median. Rob was emphatic that he didn't care where the
number came from, that we could just make it up, as long as he had
something to post for all to see, and a goal to beat.

I also spent time helping Ronny solve a bug with references. He was
overwriting some data for the week with a zero. He got the CGI to
work; I removed an xml file for him so he could place a test copy. I
told him to change 'median' to 'average' in the UI.

GG said I should focus all my efforts into Gallery now.

-- This query selects all tickets that were closed in the last seven
-- days, plus counts of how many times they were
-- closed/reopened. Christina pointed out the problem where 'Sent to
-- Customer' skews the result.

select F_RecordID as name,
count(F_RecordID) as numTimesClosed,
FROM_UNIXTIME( UNIX_TIMESTAMP( F_Date) ) as openingDate,
FROM_UNIXTIME( UNIX_TIMESTAMP( F_Modification_date) ) as modDate,
SEC_TO_TIME( UNIX_TIMESTAMP( F_Modification_date ) - UNIX_TIMESTAMP( F_Date ) ) AS value,
r.F_BillingReason, r.F_State, rh.F_NewValue
from p2_v_reports r, p2_v_reports_h rh
where
(to_days(now()) - to_days(r.F_Modification_date) <= 7 )
and
(to_days(now()) - to_days(r.F_Modification_date) >= 1 )
and
( rh.F_RecordID = r.F_ReportID )
and
r.F_State = 'Closed'
and
rh.F_NewValue = 'Closed'
group by name
order by (UNIX_TIMESTAMP( F_Modification_date ) - UNIX_TIMESTAMP( F_Date )) DESC
;

I used Gallery 1.4.1; 1.4.2 is out now and I'm going to check it into
cvs and test.

1.4.2 works fine on dvl. I found that php was no longer enabled,
probably since Zlatin and I worked out configuration
differences. There are a handful of config differences between dvl and
dev. It looks like Sunil compiled it correctly.




#########################################################################
040223 Monday

In by 9:15. Took minutes; ran tests on the stats program because
Christina thinks the numbers might be wrong for the "yesterday" stats
(she thought they were giving us the "today" numbers.) At least for
the two queries for "closed" and "worked on," they are correct.

GG out sick today. I'm tired and weak.

I've been battling a problem with Gallery. We don't want certain
options to appear in the admin interface, like path to the site. I can
preset those in a separate PHP file. But if I set the "enabled" = "no"
for these, so they don't show up in the interface, they are not passed
along. That is, what they are set to is conditional on them appearing
in the interface.

I was going round and round because I can't concentrate well and I was
making changes in multiple places, and sometimes forgeting to start
the wizard over from scratch (instead of hitting reload).

So in a nutshell, the problem is the two solutions were mutually
exclusive. Blocking the fields from the UI (enabled=no) left them
unset completely... which is weird because I reset them further down
the line. I can override the variables just fine now, but I have to
find another way to block them from the interface. CVS showed me how I
disabled the setup check so that's functional again.

Successful deploy on pork once again. This is close to the proper
deployment; that is, the options are correctly preset and I just have
to find a way to prevent them from being shown in the admin interface.

Test was to www.blippynews.com on pork:
./makeGallery.pl /opt/evw/var/webs/virtual/gallery
/opt/evw/var/webs/virtual/b/bl/bli/www.blippynews.com/web
www.blippynews.com > makegallery.sh



#########################################################################
040224 Tuesday

Talked with Rob at length about the spec; one issue I needed resolving
was how to put the customer's domain name in the tree nodes... we
experimented with this, using a workflow variable, but it didn't work
so we opened a ticket on it (#2105). If this is not doable we have a
backup plan, which would be to write a control panel page to access
Gallery.

I wrote up an update for Gautam with some delivery times. I also
checked with Christina on her question about the query, but Support is
very busy as of last Monday with an unusually high volume of tickets.

Talked with GG about my update. He decided the simplified setup should
be written, which would be a single HTML form with the needed fields;
the advanced setup would remain as is, with warnings on fields not to
be changed. He warned me against talking directly to Rob. I'm working
on the single page form and the "add photos to which gallery" page.

Took a side road after lunch: I wanted to create a new account on
devil, a web hosting account. Couldn't push the job through. Spent
time doing stuff like bouncing named, bouncing Resin, EVW, etc. but to
no avail. EVW cannot be reached at this point so I emailed ops.

Ugh. So round and round in circles again. The deal: write.inc writes
out config.php. All the PHP code for that file is stored in one hidden
variable, 'data'. So to do this the way GG proposes is to build the
PHP data structure from a simple form and save it.

OK, talked it over with GG. He whiteboarded an approach which looks
doable, with a couple of caveats.

1) We will hand provision initially. This will now generate the
   config.php file in its entirety, plus generate whatever ancillary
   files are needed (.htaccess).

2) A simplified index.php will read in config.php and the user will
   set a handful of options; this will post to confirm.inc and thus be
   saved as Gallery would save it.




#########################################################################
040225 Wednesday

Put up the results of the queries for the stats project in Twiki for a
1pm meeting, for convenience's sake.

Broke pork's config trying to undo the changes made yesterday... the
issue here is there's a template file for the httpd.conf that EVW uses
to generate a new one; see /opt/etc/Apache.conf for a list of the
files. I had to reenable php. Be careful that you always use
/etc/init.d/apache to start the server, which does it the correct
way. I also fixed the problem with index.php not being recognized as
the index file.

Gallery 1.4.2 definitely borks on the mod_rewrite; it's available and
1.4.1 has no problems with the config.

Success. I used a stripped down HTML form and configured Gallery on
www.blippynews.com (which lives on pork).

Rethinking this, I can just use a simple template file and populate
the hidden vars with echo statements. Funny you can't see the forest
for the trees sometimes.

I wrote/tested stuff to autogenerate the config.php file, which works
nice, but that leaves just the user.dat file to somehow generate. GG
suggested spitting out a URL on the command line that the admins
run. That should work, once the simple form is written.

I have to look at modifying the queries for stats now.


#########################################################################
040226 Thursday

Sent an email to Ronny, cc GG, on the issue of calculating the
average. It looks like what JeffO does in swGenerateTRT.pl is close;
it calculates how long a ticket spent in each state. We need to sum up
those times, sans Sent to Customer, for all tickets closed in the last
seven days (or previous week).

I think I have a query that is closer to what Christina wants, which
is the total number of tickets worked on (not closed) per rep. One
thing I did was to remove a DISTINCT clause and I added the "Assigned"
+ Contact in (Email, Phone). This upped the numbers slightly.

I need to finish the simple form for Gallery.

<?
include("config.template.ampira");

flatten($gallery->app);

// recursively walk nested arrays in php
function flatten($array) {
    foreach ($array as $key => $val) {
        if (gettype($val) == 'array') {
            //echo "<blockquote><h3>$key:</h3>";
            flatten($val);
            //echo "</blockquote>";
            continue;
        }
        $val = urlencode($val);
        echo "&lt;input type=hidden name=$key value=\"$val\"&gt;<br>";
    }
}

?>

OK, so I have a Perl script, merge.pl, which reads in config.php and
can insert PHP echo statements into the value="" part of the input
tags in the form. It turns out there are several form fields that do
not appear in config.php. I also have to insert the password fields.

I did an end to end test on Gallery installation on Pork. I installed
Gallery clean from CVS in the 'virtual' dir, did the makeGallery.pl
procedure, looked up the org password via ldapsearch, then hit
www.blippynews.com/setup/simpleform.php and set the password. Gallery
was then usable from www.blippynews.com.

Note for monday: bug when gallery is installed under gallery/. It's
probably a problem in how config.php is generated. It might need
www.fqdn.com/gallery.




#########################################################################
040301 Monday

In by 9:30, but Swolf was late so no staff meeting. The people who
stayed behind on Friday rearranged Swolf's and Walker's offices.

I exported the prod database for Support Wizard to the dvl machine for
Ronny. After that I started work on removing ampira.local.php, which
isn't needed anymore since we are using a template of config.php to
generate a config.php for the user. I worked the issues out and tested
on both dvl and staging and it looks good. That took me through to
2:30pm including lunch.

From my /etc/hosts file:

216.27.92.123   www.4tem101.com
216.27.92.123   www.gstest909.com
10.1.1.209      www.blippynews.com

OK, I modified the UI to makeGallery.pl. It uses getopts now, so the
args can come in any order. I force the user to specify new install or
addon package; I test for a variety of other cases. I tested this on
Pork, time for a quicky staging test.




#########################################################################
040302 Tuesday

I think I can do an automatic login like we do for Support Wizard. It
might not take much code.

Installed Emacs on cws-1.dev. Helped Trevor login to devil, do a cvs
checkout, and build the fcsignupwizard. Earlier I traced and fixed a
bug that was introduced when one changes the theme in Gallery, and the
stylesheets were then incorrectly referenced.

First dev meeting in a bit.


#########################################################################
040303 Wednesday

Worked yesterday afternoon on doxygen, then fixed the query in DB.pm
for "all tickets worked on yesterday, per rep" and regenerated the XML
for the last week; then, started the marketing report for all
visps. This morning I couldn't email the reports because the mail
server complained the attachements were too large so I dropped them on
Bababooey. I finished editing the doxygen conf file and generated
docs, checked them into CVS, but it doesn't look nice like Drupal's
docs do (which GG IM'd me).

Oops, forgot to remove the exit; statement from swGeneretTRT.pl. Done.

OK, problems problems. Gallery is very Javascript-dependent, so
calling pages from EVW is going to be difficult; the daughter pages
make references to the parent pages, and once the javascript is
broken nothing works.

Second, the problem with .htaccess and mod_rewrite not being
recognized is introduced in the setup process I devised; out of the
box, 1.4.2 recognizes them just fine. So somehow after deployment, it
can't load a file.

Filed a bug report on EVW not working on Devil. I emailed about two
weeks ago on this issue.

Fixed one bug: there was a missing .htaccess file in setup/ that
caused the error in configuration ("can't read your .htaccess
file"). Gallery uses the file to load a PHP file which sets a
variable. Now I have to solve the mod_rewrite problem.

Ack. Now, there are problems on staging. .htaccess isn't honored at
all.

Testing on production: 
/mnt/mss-1/vol4/web/j/je/jes/www.jessyhanley1234.com/web/foo
cws-5.prv.ampira.com
http://www.jessyhanley1234.com/foo/gallery/setup/index.php

OK, enough time spent on mod_rewrite. That will have to be solved in
the beta testing.




#########################################################################
040304 Thursday

Moving day. I'm going to mod the setup so the user's dir has a tmp
directory.

Some notes. First, the install process: after the admin runs the
scripts, they will have to go through the setup wizard to properly set
the URL. I think it does something funky the first time through; if I
try to add the gallery/ subdir at provision time, it gets doubled up
(gallery/gallery/) and the site is broken. However once the wizard is
run, it's all fine.

Under blippynews I have a foo directory where I have vanilla installs
of Gallery, to demo the issues with mod_rewrite and .htaccess.

Well, I can't test the redirect.vps since Devil is still
borked. Signing off until Friday.




#########################################################################
040307 Sunday

Worked out the issues with retrieving the user's password. I had to
resort to LDAP directly. I need to finish a PHP file now, one that is
called from redirect.vps, logs the user in, and sends them to the
gallery main page. After that I think it's just FCR changes.




#########################################################################
040308 Monday

In early today. Solved my DNS issue for the static boxen. Working on
EVW on devil; the System module cannot reach anything, and externally
things cannot reach the CORBA system.

Spent the morning up until 11am trying to find out why EVW on devil
was borked; see 2/24 for my first mention of it. 11am meeting squared
away the remaining work for Gallery and I should be able to do
everything by Friday, no problemo. After the meeting GG and I did more
searching for devil's ills, no avail, filed ticket with SF. I removed
the Donate button for Gallery.

Oy vey. So now the signup wizard is to be photo buddy branded and not
the fcr signup wizard. At first this looks like a lot of work but I
think it's really going to be a lot of work for Jessy. Outside of
starting a new cvs project, I really just have to streamline the
number of paths... packages.xml will have two entries, and paths.xml
will have (essentially) the Starter path and one hosting path. Tokens
passed in will be 'subdomain' and 'domain' (maybe). There's going to
be a lot of copy and style changes; and the free packages have to
default to "no". I feel like collapsing.

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; .emacs as of march 8th, prior to myphotobuddy
;;; Emacs/W3 Configuration
(setq load-path (cons "/usr/local/share/emacs/site-lisp" load-path))
(setq load-path (cons "~swain/.elisp" load-path))

(condition-case () (require 'w3-auto "w3-auto") (error nil))


;; local stops only

;; doesn't work on osx
;;(setq initial-frame-alist '((width . 115)
;;                            (height . 57)))


(when window-system
  ;; make pretty
  (setq default-frame-alist '((background-color . "#002929")
                              ;;(foreground-color . "#fff0af")
                              (foreground-color . "#ffff90")
                              (cursor-color     . "violet")
			      ;;(width . 115)
;;			      (height . 57)
)))

(setq sw-tail-file-alist '(
                          ("resin error log" . "/usr/local/resin/log/error.log")
                          ("resin stdout log"  . "/usr/local/resin/log/stdout.log")
                          ("resin stderr log"  . "/usr/local/resin/log/stderr.log")
                          ;;("Product Module log"  . "/opt/evw/logs/ProductModule.log")
                          ))

;; (setq sw-tail-file-alist '(
;;                           ("generic CC log" . "/opt/evw/logs/GenericCreditCardExtension.log")
;;                           ("billing log"  . "/opt/evw/logs/Billing.log")
;;                           ("eftnet log"  . "/opt/evw/logs/eftnet.log")
;;                         ("Product Module log"  . "/opt/evw/logs/ProductModule.log")
;;                           ))



(load "swainlib")

;; more local stuff
(defun sw-servlet ()
  "Jump to the servlet directory."
  (interactive)
  (switch-to-buffer (get-buffer "cli"))
  (goto-char (point-max))
  (insert "cd ~/public_html/projects/ampiradev/fcsignupwizard/src//com/ampira/fcsignupwizard/servlets")
  (comint-send-input))

(defun sw-jsp ()
  "Jump to the jsp directory."
  (interactive)
  (switch-to-buffer (get-buffer "cli"))
  (goto-char (point-max))
  (insert "cd /home/swain/public_html/projects/ampiradev/fcsignupwizard/pages/")
  (comint-send-input))

(defun sw-wizards ()
  "Jump to the wizards directory."
  (interactive)
  (switch-to-buffer (get-buffer "cli"))
  (goto-char (point-max))
  (insert "cd /opt/evw/evw-frontend/WEB-INF/classes/com/evolutionware/wizard/")
  (comint-send-input))

(defun sw-sfjsp ()
  "Jump to the SF jsp directory."
  (interactive)
  (switch-to-buffer (get-buffer "cli"))
  (goto-char (point-max))
  (insert "cd /opt/evw/frontend-fcgold/wizard/signup/")
  (comint-send-input))



(defun sw-projects ()
  "Jump to the project directory."
  (interactive)
  (switch-to-buffer (get-buffer "cli"))
  (goto-char (point-max))
  (insert "cd /home/swain/public_html/projects/ampiradev/fcsignupwizard/")
  (comint-send-input))

(defun sw-scripts ()
  "Jump to the scripts directory."
  (interactive)
  (switch-to-buffer (get-buffer "cli"))
  (goto-char (point-max))
  (insert "cd /home/swain/public_html/projects/ampiradev/fcsignupwizard/scripts/")
  (comint-send-input))


(defun sw-deploy ()
  "copy war file from my cvs copy to live site"
  (interactive)
;;  (shell-command "cp ~/public_html/projects/ampiradev/supportredirector/supportredirector.war /usr/local/resin/webapps/")
  (shell-command "cp ~/public_html/projects/ampiradev/fcsignupwizard/fcsignupwizard.war /usr/local/resin/webapps/")
  (message "war file deployed to devil.")
)

(defun sw-push ()
  "push files somewhere"
  (interactive)
  (shell-command "cp /home/swain/public_html/projects/ampiradev/fcsignupwizard/pages/signup/*.jsp /usr/local/resin/webapps/fcsignupwizard/pages/signup/")
  (shell-command "cp /home/swain/public_html/projects/ampiradev/fcsignupwizard/pages/design/*.jsp /usr/local/resin/webapps/fcsignupwizard/pages/design/")
  (message "Files pushed."))


(global-set-key [(meta f5)] 'sw-deploy)


;; set the default command for M-x compile
(setq compile-command
      "cd /home/swain/public_html/projects/ampiradev/fcsignupwizard/; ant -emacs -f build.xml build-war")

;; always scroll the buffer as compilation proceeds...
(setq compilation-scroll-output t)

;; (defun rollout ()
;;   "cvs checkout and all that"
;;   (interactive)
;;   (sw-projects)
;;   (insert "cvs update -d")
;;   (comint-send-input))


(defun do-applescript (&optional args)
  "Tell the user they ain't running Mac OS X."
  (interactive)
  (message "You are not running Mac OS X."))
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;



#########################################################################
040309 Tuesday

Phew.

Came in this morning and continued the battle with the wizard. I
copied the whole fcsignupwizard project and renamed it to
myphotobuddywizard. I did mass renaming, but my mistake was in not
being consistent: some things were renamed myphotobuddy and some
myphotobuddywizard. Had GG help when he came in and he finally found
it was that I named the web app id 'myphotobuddywizard' but the war file was
'myphotobuddy' and simply renaming the war file fixed it.

Yet another requirements shift came: they want the search boxes on the
same page. My first attempt before a late lunch failed; I backed out
and tried again, this time commenting out a lot of HTML to make it
easier, and succeeded. I had to hardcode the pathnames into the ACTION
fields of the searchbox's <form>s.


#########################################################################
040310 Wednesday

Switched hubs today; GG has a 16 port 100mb hub and we are all sharing
it now. I was trying to diagnose the problem where I get huge lag from
pork via X; but I guess it's just slow because it's a hoggish
protocol. Oh well. I should run a long ping later when the office is
idle, however, and see if it's something else.

I'm merging the html files for the simpleform. I wrote a tool
previously called merge.pl that reads in config.php and replaces the
value="" of any given hidden field; this will have to be expanded to
cover text fields, and I have to figure out something for select
statements, though I have an idea.

OK, wrote a new Perl script; the process went like so: I copied the
HTML from the two main config pages for Gallery. I merged them. I used
PHP comments to block out what we don't want to show. The one Perl
script knew how to print out only HTML form fields in the blocked out
parts; some text processing turned these into HTML hidden input
fields. I merged the output with the original file, then used the
second Perl script (merge.pl) to replace the values of the hidden
fields with echo statements.

In the evening was helping Jessy with pushing files to staging so she
could reskin the wizard.



#########################################################################
040311 Thursday

In by 9:30 as usual. Devil is back up; SF found that the hostname was
not set in full, just "evw-1" which was then resolving incorrectly.

OK, restarted eftnet; updated the Twiki page on starting evw on devil
(to include eftnet); diagnosed and reported a problem on pork with the
Server agent; bought a package on devil but could not push it through
(due to the Server, prolly); I need to test the new simpleform now
even though Rob hasn't gotten back to me.

Yay! the new shortform.php works fine on pork. I'm gonna try a test on
staging.

Been complaining about lag to the boxen. Running ssh -v and Han is
doing some diagnostic stuff.




#########################################################################
040312 Friday

It's just one of those periods where I don't have much time to make
entries... was up late tweaking/bugfixing the shortform.php. I copied
the setup/index.php and some of the .inc files and changed the entries
in ampira/hardlink.list; this way we have custom versions and the
setup wizard is unchanged. I was just helping Jessy with another
Javascript problem. I'm going to have to fix the JS when she's done
with the layout pages. I still haven't done an end to end test.

After the 11:30am meeting, it was decided we'd do a soft launch by
Monday, which I think is doable. This means it's deployed to an app
server that's out of service. Jessy is to deliver the wizard in an
hour.

Updated a ticket  on the problem on staging. Ran: 
perl -pi -e 's/216.27.95.123:80/216.27.92.123:80/' `find . -name \*.conf|xargs grep -l '216.27.95.123:80'`

which fixes virtual sites. I knew www.gstest909.com worked so I just
compared the conf files for that and www.mystartadv.com.




#########################################################################
040322 Monday

Nine days away. Whew. Issues:

1. Broken conf on Staging when provisioning sites; this is the 92
   versus 95 problem in bug
   390. https://bugs.corp.fortunecity.com/show_bug.cgi?id=390

2. 401 lists three bugs that are under Systems that must be resolved.

3. No action on 404, where Rob needs to update the packages.

4. 403 details the apache template travails. Sunil repeatedly reported
   this as fixed and GG found it otherwise.

5. 402 is about ADM crashing on Pork; GG and Zlatin have gone back and
   forth on this one.

6. Eric worked on some jsps for FC Gold; might need to replicate
   changes.

7. Email from jingram is fixed, apparently.

8. galleryprovsioners@ampira.com was created.

9. 405 is about the conf issue on Pork, same as staging.

10. GD support might be added.

11. No action on 406: buddyendtoend.com on devil. No domain link in
    control panel.

---


12:16pm: conf file comes out wrong still for provisioned web site.

Links in control panel have not been updated.




#########################################################################
040323 Tuesday

Updated the Twiki page which instructs how to install Gallery and
provision it. Sunil didn't understand that you had to run the shell
script that was generated. Also, gallery is installed on one of the
drives, not locally on the cws server.

Had an 11am and then demo'd screen.

I found the variables needed in the data of a job, and added fields to
the email sent to ops. Thusly:

Please install Gallery for the following customer: 

Org: %InstallOrganisationDn%

Domain: %RegistrationDomain%

Filesystem: %WebDomainBaseDirectory%

Server: %WebServerDn% (%WebExternalIP%)

FQDN: %FQDN%

username: %username%

password: %password% (Use this for the admin password in the user's Gallery installation. Go to http://%FQDN%/setup/shortform.php and set the password there after you provision Gallery for this customer).

User email: %email%
%firstname% %lastname%

Still, dvl is not working (evw down).




#########################################################################
040324 Wednesday

In by 9am. Wrote Rob to verify that PHP is enabled. Need to bounce the
TreeModule.

I can do a slight rework of the provisioning script to execute the
shell commands in an eval{}; block. Alternately I can just write a
wrapper script.

Confirmed with Rob that PHP was never included in the fotomojo
packages. They will have to be rebuilt now.

TreeModule stuff: to set links, go to Products->Workflows (on the
Amira level, not the visp), enter Advanced config. Restart the
treemodule by killing the process (but don't kill the
TreeModuleRunner.



#########################################################################
040325 Thursday

Yesterday: in the afternoon I worked out the details of
autoprovisioning. I was banging my head this morning trying to figure
out why it wouldn't work; sendmail runs uid daemon, for one
thing... GG recommended chown root galleryProvisioner.pl; chmod u+s
galleryProvisioner.pl. But on top of that I had to add -U (allow
unsafe operations) and $< = $>; which sets the UID to the
EUID. Finally the thing worked, but what I have is a script that runs
fully as root that executes commands that arrive in an untrusted
email. We will have to do a security audit of this.

We have a 1pm on fotomojo. Showstoppers include the credit card
gateway not checking zero dollar amounts; the transaction also
bypasses vetting; Rob needs to rebuild the packages to include PHP;
the control panel needs reviewing; and I need to audit shortform.php
to guarantee all vars are correct. We will do "monkey provisioning"
for the first release, where an ops person will have to do copy/paste
of the commands.

If I run the provisioning script as user www, the issue is the dirs
are owned by user 'webuser'; and I need to be able to create certain
things as owned by www, so it probably has to be root.

Meeting good. Rob said he'll ditch the free idea to get around the
problem of the gateway. This is moving to be a major company product,
versus a small addon to fortunecity. Rob talked about forking from the 
Gallery code base.

I worked out the remaining issues with the shortform.php. It was easy
to fix most of it; I just commented out the email crap that was set in
checkboxen. No need. Can't check it into cvs yet since 10.1.1.50 is
being rebuilt.

This project has involved a lot of testing and testing testing
testing. Buy a package, push it through, provision it... etc etc
etc... the redundancy is making me spacey.




#########################################################################
040326 Friday

Can't login to staging, thus, can't test packages there. For some
reason the new fotomojo packages on staging do not provision right;
the Apache virtual conf is wrong. I get the server's index
page. Meanwhile I need a package sync to devil, since the wizard uses
the new packages now.

Zlatin found Staging can't get a valid token from SF, he's filing a
ticket. Rob bought a package for me under the account fcgtest003, pw
112233. I should get the email for it. Which makes me think: I should
compose the email for ops with all the copy/paste commands needed to
provision an account.


#########################################################################
040329 Monday

Sent email about resolving issues with adding files to Gallery. I
worked from home for a few hours yesterday (Sunday). The 9:30 was
moved to 10:30; plus I have the dev meeting (2pm) and Rob wants a
Gallery meeting (also 2pm).

Current issues with Gallery:

* provisioning is delayed due to the conf file not loading
* autoprovisioning problem: must run as root
* may want to add files in the future.
* block setup form from outside world; have to enter from EVW

So, tried to start EVW on devil. Turns out Han discovered the power
cord came undone on Friday. DB2 was down, even. I restarted everything
in sequence (db2, then evw, then apache/resin) but I see what looks
like the token error (resin can't talk to evw). Detailed email to ops.

Been going through the bug list for MPB. Updated several.

Meetings complete. I put my notes and GG's in a Twiki page. Sent bug
419, Safari wizard problem, to Eric.

images deployed to app servers.

Debugged a problem with the new version of the makeGallery.pl, which
uses symlinks for all top level dirs and hardlinks for all top level
files.

GG needs IP address from wizard data.


#########################################################################
040330 Tuesday

Worked through the shortform changes Jessy and Rob wanted.


#########################################################################
040331 Wednesday

Well, another very busy day yesterday... I hacked up the shortform.php
as requested, had the 2:30 meeting, and did a wide range of assorted
small tasks: uploading image files, verifying bugs, tested the Wait
For Response, etc.

Today I should focus on one thing: getting MyPhotoBuddy
launched. There are two things to resolve: the login problem in
frames, and securing shortform.php.

Hurray for desktop-auto-save. My Mac no longer accepted keyboard
input. I rebooted to be on the safe side.

Rob conceded to making Admin Gallery a popup link; this might solve
both the problems of the secure/insecure links and login failing on
the first attempt.

mailspool/waiting.vps is where jobs awaiting emails are waiting.

<form method=get>
<input type=hidden name='sessionkey' value='DMFC_ifYoUcAnReadtHisgEtaLifE'>
<input type=hidden name='action' value='SetComplete'>
<input type=hidden name='mailId' value='2433'>

<input type=image src='/images/update.gif'  border=0 value='Update'>
</form>

Drat. We need a mailid? It looks like it doesn't make it into the job
data until after the mail is sent, or queued to be sent. Which means
we'll have to look it up somehow.




#########################################################################
040401 Thursday

Very stressful day. Jessy made wholesale changes to shortform.php and
that consumed most of the day (bugfixing, text changes, pushing,
reprovisioning). Gautam and I tried to work out the mod_rewrite issues
to no avail. Rob decided to push the launch to Monday.




#########################################################################
040405 Monday

Well, Friday was a day of bugfixing, testing, rolling out, etc. I was
really busy right up until the end of the day.

Today we had the 9:30am: Swolf dropped the bomb that we're leaving
Springboard. I'm looking at some bug issues for Gallery; folks missing
an image are doing so because they were provisioned prior to a rollout
that fixed a bug.

I've got a minimal email processing script in place... though it's
throwing errors somehow. Lunch and the dev meeting intervened.

OK, email receiver script works. On cws-1.dev, in
/opt/evw/scripts/ampira/provisioners, is galleryEmailReceiver.pl. It
writes the emails to pending/ in the same directory.




#########################################################################
040406 Tuesday

10am, demo'd the Gallery provisioning for Ops, using staging. Went
well. Gallery went live last night; no orders yet.

I haven't tried buying a package on devil in a while. Let's give it a
try.

Success! I bought the package. But IIRC they sail right through the
system.

Hmm. The job hung; user devildevil already exists, according to the
system. Must find out why this happened.

From the wizard:
EvwSignupClient: Organisation Name devildevil is available.
EvwSignupClient: Username devildevil is available.

Event Description:
The user [devildevil] alread exists.

OK, filed two bug reports. Devil is still unusable as far as FotoMojo
is concerned. Two jobs hung claiming user exists; one job hung because
the parent zone could not be found.

Worked out the mechanics of testing the referer on Pork. Going to test
this against production: replace swain.myphotobuddy.com/index.php
with the redirect. That should allow me to test it. For the control
panel I'll replace ampira.redirect.php.

Well. Long long ways to this point: I tried to change the setting for
the workflow under Products->Workflows->Advanced Configuration. But
EVW thinks a full pathname is a URL, so that's out.

Hmm. Maybe I can do the same on the frontend?

I moved the vps files out of cgi-bin and that hosed the app, so
caching is not an issue. HTTP_REFERER simply isn't passed from the
application servers to the frontend servers.

Going back to the autoprovisioner: I have a script that takes incoming
emails and stores them in a "pending" directory. I'm working on the
cron job now. I had to solve the problem of testing the url, and for
now I call wget directly.

Conferred with GG on the redirect problem. (On a side note, explained
it all to Heller on Avalon, and his response finally was "You have one
confusing ass setup.") Watching the headers, we saw that referer was
still being lost by the vps file. Grr. I wonder why they differ from
staging to production.

I can search for an EVW redirect in the vps files; or try a Python
redirect, in an http class (says GG), or lastly query LDAP somehow
from Gallery. But I think the last bit only will help if we block
shortform.php from loading if the user is not logged in. This might
run into the same problem as opening Gallery in the frame though --
some issue where the top window has to be Gallery.


#########################################################################
040407 Wednesday

Very frustrating day yesterday trying to implement auth with Gallery's
setup page. Swolf stressed the need for autoprovisioning today, so I'm
shifting my focus back.

Finally, here is the diff of before and after Gallery is
configured. Synopsis: I provisioned Gallery, did an ls -lRa > before,
then ran the shortform.php and saved, and then did: ls -lRa > after.


[cws-1 /tmp]# diff before after
2c2
< total 590
---
> total 591
5c5
< -rw-r--r--   1 www      www             0 Apr  7 10:36 .htaccess
---
> -rw-r--r--   1 www      www           517 Apr  7 10:37 .htaccess
13c13
< drwxr-xr-x   2 www      www           512 Apr  7 10:36 albums
---
> drwxr-xr-x   3 www      www           512 Apr  7 10:37 albums
20c20
< -rw-r--r--   1 www      www          7370 Apr  7 10:36 config.php
---
> -rw-r--r--   1 www      www          7250 Apr  7 10:37 config.php
76c76
< drwxr-xr-x   2 www      www           512 Apr  7 10:36 tmp
---
> drwxr-xr-x   2 www      www           512 Apr  7 10:37 tmp
89,90c89,90
< total 3
< drwxr-xr-x   2 www      www           512 Apr  7 10:36 .
---
> total 4
> drwxr-xr-x   3 www      www           512 Apr  7 10:37 .
91a92,102
> drwxr-xr-x   2 www      www           512 Apr  7 10:37 .users
> 
> albums/.users:
> total 5
> drwxr-xr-x   2 www      www           512 Apr  7 10:37 .
> drwxr-xr-x   3 www      www           512 Apr  7 10:37 ..
> -rw-r--r--   1 www      www            31 Apr  7 10:37 .htaccess
> -rw-r--r--   1 www      www           401 Apr  7 10:37 1081348651_448132854
> -rw-r--r--   1 www      www             0 Apr  7 10:37 1081348651_448132854.lock
> -rw-r--r--   1 www      www           848 Apr  7 10:37 userdb.dat
> -rw-r--r--   1 www      www             0 Apr  7 10:37 userdb.dat.lock
1428c1439
< drwxr-xr-x   2 www      www           512 Apr  7 10:36 .
---
> drwxr-xr-x   2 www      www           512 Apr  7 10:37 .
[cws-1 /tmp]# 

Detail of changes:

1. .htaccess goes from zero bytes to 517
2. config.php overwritten
3. tmp file is touched, somehow
4. .users dir created
5. .htaccess written into .users (very simple file)
6. unix timestamp-named lock file created; contains admin password
7. lock file for same created (zero byte)
8. userdb.dat written: is a serialized php array
9. userdb.dat.lock is a zero byte file

And that's it. If we have a php binary installed, we can do this
ourselves and avoid that step of autoprovisioning; that is,
autoprovisioning can happen automagically without waiting for the
domain name to happen.




#########################################################################
040408 Thursday

Gallery provisioner scripts are now working on Staging and I want to
deploy/test on cws-1.prv now. Hopefully by lunch I can have it
working.

This release does not test the FQDN for availability.

OK, I made a super dumb mistake where I changed "print LOG" in the
&log sub to &log, just let cron test it. Oops! Deep recursion! Rah ran
out of memory. Fortunately I managed to reign it in.

Copied down from rah, checked in, reuploaded, tested. Works. On to
production.

Added to /etc/aliases:
# automatically provision gallery for myphotobuddy
gallery-provisioner: "|/opt/evw/scripts/ampira/provisioners/gallery/galleryEmailReceiver.pl"


bash-2.04# mkdir -p /opt/evw/scripts/ampira/provisioners/gallery
bash-2.04# mkdir -p /opt/evw/scripts/ampira/provisioners/gallery/pending
bash-2.04# chown daemon  /opt/evw/scripts/ampira/provisioners/gallery/pending

touch /opt/evw/logs/galleryprovisioning.log
chown daemon /opt/evw/logs/galleryprovisioning.log


I changed the shebang to #!/opt/gnu/bin/env perl -w for the scripts,
since they all need a different one. This way it's generalized. I
debugged the setup on cws-1; wrote an email about how I need to get
the provisioning emails to cws-1, but only Zlatin and Gautam have
gotten back to me so far.

Meeting with GG: on Rob's next desire, an Access database from which
he can do lots of neat things. (How about this: we dump the ldap stuff
in to db2 tables instead? muhahaha). By COB Monday I need to have an
estimate. I restarted my star list. Meeting with Ferry shortly about
getting autoprovisioner set up.

Set up MS Access to talk to Splinter's Mysql. Works. No idea how to
make Access do anything though.

Whew. So, with Ferry's help, got all the config tweaks done to get
autoprovisioning working. It worked!


#########################################################################
040412 Monday

Long weekend. A few MyPhotoBuddy accounts were bought and successfully
created. 9:30 meeting went fine, posted minutes. Met with Rob and GG
on the data mining project Rob wants. Am working on tracking down a
problem in the MPB wizard reported by a friend of Peter.

The issue: 
fcsw: Exception received from the jsp templates:
javax.servlet.jsp.JspException: DomainRegistrationAction was not set.
        at _pages._signup._outertemplate__jsp._jspService(_outertemplate__jsp.java:811)

Note this is for the FCSW, not the MPBW. But the bug might exist in both.

Where it occurs:

[evw-1 myphotobuddywizard]$ find . -type f |xargs grep -l "DomainRegistrationAction was not set"
./pages/signup/summary_order.jsp

Somewhere in these three pages:

./pages/signup/domain_results_body.jsp
./pages/signup/domain_search_box.jsp
./pages/signup/subdomain_search_box.jsp
./pages/signup/subdomain_results_body.jsp

DomainRegistrationAction is not being set, or not being set to either
Update or New. Since the exception is thrown in summary, perhaps it's
the domain results pages that are not behaving. However: config
occurs between the two steps. In review:

search
results
config
summary

So going from the results to config, DomainRegistrationAction is not
being carried though... ah, it's probably not tested in the config
stage. summary pulls the value out of the session object.

Now, I haven't seen any subdomains so it's probably in
domain_results_body.jsp.

Well, it's bulletproof. If it's not passed in to the results page, an
exception is thrown. I've seen where it seems to be created in the
user data form data... perhaps the test is faulty when the bean is
set?

Dev meeting went OK. MyPhotoBuddy roadmap meeting was mostly about
Phase 2 items and current bugs.

Dataminer project:

I can run Perl scripts on db2-1.prv to extract the tables from the
billing and production databases. I can use evw-1.prv to do the ldap
extraction... what's needed is a closer data analysis. I wonder how
large a total dump is of ldap, for all orgs and their owners. That
would work something like:

ldap search for all orgs
ldap search for all first users under each org

I know I've solved this one before... anyway, looking at some
ldapsearch results I can do this:

 ldapsearch -h ldap-1.prv.ampira.com -p 400  -D "cn=Directory Manager"
 -w "********" -b "o=wainstead,ou=Clients,o=HostV3,ou=Clients,o=FCTY"
 "(|(objectclass=organization)(objectclass=person))"

This returns both the phpwiki org and phpwiki org owner (me). The
trick is to filter out the non-owners. Theory: email addresses match.

	From: 	  gautamg@fortunecity.com
	Subject: 	Database approach for Dataminer project
	Date: 	April 12, 2004 2:45:40 PM EDT
	To: 	  dev@ampira.com

Swain,
	As discussed here's the approach for dumping data from db2 to mysql

* identify tables to dump in db2
* create identical tables in mysql (allowing for type changes etc)
* name tables in mysql with evw_ (or similar) prefix
* create simplified tables in mysql according to Rob's spec
* limit permissions to read, execute for system tables
* test with access

Let me know if you have any questions
--
Gautam



This pretty much sums it up. So:

tables: domainhistory, packageaction, and accounts
ldap: all orgs and their owners

Estimates:


* Perl code to extract evwprod.domainhistory, evwprod.packageactions,
  and evwbill.accounts: ~1 day (done on db2-1.prv)
* Perl code to extract user/org data from ldap: ~1 day (on evw-1.prv)
* Create tables specified by Rob, populate them (probably with SQL
  queries, in the form: select from evw table into rob table. ~1 day.
* Move from dev to production environment, set up Rob's computer so
  Access can connect to mysql, test: ~1 day
* Create recurring job to automatically update the mysql database from
  ldap and db2: Perhaps this should be a round 2 issue? TBA


#########################################################################
040413 Tuesday

GG says my top priority is solving the bug where
DomainRegistrationAction is not set. I think this is a Javascript on
IE bug. I'm going to try to weed out the JS in the MPB wizard.

First, I should see if I can get around setting the DRA in JS.

This is crappier than I thought. The two search boxes are self
contained forms... we must read all the info out of them, and populate
the outertemplate's form. Must comfirm.

A dead end! The DomainRegistrationAction is set in a hidden var in the
subdomain search (hardcoded to New), and is a plain radio button in
the domain search form.

After a day of banging my head against the problem I rolled out two
new copies of the wizards. They are putting out extra debug info. I
worked out the issues with a standalone vps file to update the
mailspool... this is the last step taken when provisioning Gallery to
a customer.




#########################################################################
040414 Wednesday

I went to Eric and Jessy today with the user agent string written out
on a Post-It. (Mail was down. Still is). Jessy suggested that URLs
were being truncated, which totally fit the symptoms. I find the
longest URL we see is 943, but that's when the customer info is
submitted. GG suggested going to POST over GET. First I'd like to see
evidence that IE has a bug.

Looking only at strings coming off the results page: some exceed 300
chars.

I need to do more time with grep-find and find-grep. I tend to fall
back on the find command in the shell and my F8 to read the file,
which is kinda less efficient. If the problem is changing find's
params I should wrap the command in something interactive to make it
more flexible, or alternately, a function or two that preset values
the way I want. I frequently do find . -type f | xargs grep
<something>.

Jitterbug pages:             6.0.2600.0000.xpclient.010817-1148
((merlin)) [to Wainstead \]: 6.0.2800.1106.xpsp2.030422-1633



#########################################################################
040415 Thursday

GG found that in stdout.log, the EvwSignupClient fails silently in the
gettax() method. The errors, I think, are showing up in stderr.log and
error.log. And I think the NullPointerException with no message is
being caused by the Product Module. Reason: In gettax() we throw a new
exception and try to print the error message via e.getMessage(); but
this just returns a null! That should not be.

I have an idea to echo a timestamp into the resin logs, say every five
minutes, to narrow down the timeframe where these things happen.

This is done on app-1. It's cron'd.

I modified MakePackageXml.java so it would send bad data to the
product module:

// 4/15/4. Test GIGO.                                                                                     
try {
    String badProductId = null;
    //String badProductId = "1067352906.401137";                                                          
    String[] goat = prodmodule._getSetupChargesForPackage(sessionKey,
                                                                0, 
                                                                orgDn, 
                                                                badProductId, 
                                                                "", 
                                                                new
                                                                ProductConfig[100]);

    stdout("Success sending in the nulls. Number of costSeqs: " + goat.length);
} catch (Exception e) {
    e.printStackTrace();
    stdout("No dice: " + e.getMessage());
}

This fails in the following ways:

1) with a null productId and ProductConfig[0], it throws:
org.omg.CORBA.BAD_PARAM:   minor code: 1398079489 completed: Maybe
        at com.sun.corba.se.internal.iiop.CDROutputStream.write_string(CDROutputStream.java:364)
        at com.sun.corba.se.internal.corba.TCUtility.marshalIn(TCUtility.java:124)
        at com.sun.corba.se.internal.corba.AnyImpl.write_value(AnyImpl.java:380)
        at com.sun.corba.se.internal.corba.RequestImpl.doInvocation(RequestImpl.java:282)
        at com.sun.corba.se.internal.corba.RequestImpl.invoke(RequestImpl.java:223)
        at com.evolutionware.CORBA.StubForProductModule._getSetupChargesForPackage(StubForProductModule.java:1051\
)
        at MakePackageXml.main(MakePackageXml.java:65)


2) with productId == 1067352906.401137 and ProductConfig[0]:

com.evolutionware.CORBA.SystemUnavailable
        at com.evolutionware.CORBA.SystemUnavailableHelper.read(SystemUnavailableHelper.java:67)
        at com.evolutionware.CORBA.SystemUnavailableHelper.extract(SystemUnavailableHelper.java:34)
        at com.evolutionware.CORBA.StubForProductModule._getSetupChargesForPackage(StubForProductModule.java:1072\
)
        at MakePackageXml.main(MakePackageXml.java:66)


3) With a package ID and ProductConfig[100] OR package ID == null:

java.lang.NullPointerException
        at com.evolutionware.CORBA.ProductConfigHelper.write(ProductConfigHelper.java:91)
        at com.evolutionware.CORBA.ProductConfigSeqHelper.write(ProductConfigSeqHelper.java:76)
        at com.evolutionware.CORBA.ProductConfigSeqHelper.insert(ProductConfigSeqHelper.java:26)
        at com.evolutionware.CORBA.StubForProductModule._getSetupChargesForPackage(StubForProductModule.java:1047)
        at MakePackageXml.main(MakePackageXml.java:66)



I retested this to verify. The reason I did this: the
EvwSignupClient.java for FCR was failing... the error was showing in
stderr.log as this:

java.lang.NullPointerException
        <<no stack trace available>>
java.lang.Exception: Error getting setup charges for package: null
        at com.ampira.fcsignupwizard.util.EvwSignupClient.getTax(EvwSignupClient.java:788)
        at com.ampira.fcsignupwizard.util.EvwSignupClient.performPreAuth(EvwSignupClient.java:598)
        at com.ampira.fcsignupwizard.servlets.FortuneCitySignupWizard.doPost(FortuneCitySignupWizard
.java:522)
        at com.ampira.fcsignupwizard.servlets.FortuneCitySignupWizard.doGet(FortuneCitySignupWizard.
java:29)


It was the lack of a stack trace that intruiged me. Our own error
output was misleading (where it says "Error getting setup charges for
package: null"... the "null" is from e.getMessage(), not the
productId).

Wrote testMech.pl on splinter. Sent email announcing success.




#########################################################################
040416 Friday

In by 9:29, oddly. I left the house late.

I believe I tunneled from devil to evw-1.prv to do the ldap
stuff. Testing... works.

I spent some time looking at the ampira.redirect.php issue. I replied
to Rob about the three issues for MPB: the Jay bug seems to have
vanished with the repeated reboots of EVW/DB2, Kurt's garbled vps page
was useless (no source code) and I think it was a one time issue, and
Kurt's upload problem cannot be duplicated here.

Read spiffy article on JavaMail and SOAP. Sketched the idea of using
SOAP over SMTP to replace Autoprovisioner. Overkill? Mebbe
not... hmm... I wonder... how about mod_python and SOAP?

Nope. Was reading up on mod_python and it requires 2.2.1 or
later. We're still at 1.5.




#########################################################################
040419 Monday

In by 9:03. Meeting was short. Looked through the stdout.logs for the
weekend and no sign of the DomainRegistrationAction bug; I marked it
as invalid but didn't close it.

;; Fixing backward-kill-word on crappy Sun boxes:
(global-set-key "\M-\C-h" 'backward-kill-word)


Note that the problem with galleryFormfiller.pl might be with name
resolving.




#########################################################################
040420 Tuesday

Towards the end of the day I was helping Trevor buy/push packages on
staging and pushing images for Jessy. I think the problem with
provisioning on staging is a matter of name resolving not working... I
don't think setting /etc/hosts will trick WWW::Mechanize into using
the localhost for the web call. I need to work out the interface
details anyway. There's a bug in Bugzilla on the Perl version being
too old on cws-1.prv.

Diagnosed and fixed the bug for MAXCAROLYNwedding. I was not getting a
css directory out of CVS for the retro style; I thought Jessy had not
checked it in. On her wincvs client they first showed as unknown, then
they showed as checked in! And they came out of CVS on my end! I ran
cvs2cl.pl and generated a ChangeLog and nothing showed up as checked
in for today except for my changes to the file and dir lists. I
manually fixed the customer's web site. I also sketched out the
algorithms for fixing all sites retroactively; the idea is a Perl
script that will take dirs and files as config data, and search all
sites on all volumes, linking and creating directories as needed.

Two thoughts on bug
https://bugs.corp.fortunecity.com/show_bug.cgi?id=445. One, it might
be a problem where the shopping cart object is the victim of race
condition; if someone tries to use the wizard at the same time the
other user might lose their selections. Two, it's something to do with
the session being reset when the user hits the search page, which was
a refactoring that happened back in January. Somehow, after one of the
redirects, the session info is lost.

I updated the bug, and noticed that two params less were showing (in
the bad, it had 10 elements, in the good, 12 elements.)

Good news: the WWW::Mechanize script works great. It fills in
shortform.php and it had no bugs the first time it ran under cron. I
just whipped out the unstick script, and that can't be tested until
staging is back online. I need to do an images push for Eric.

Wrote a testbed for unsticking the job. I put the vps file in cgi-bin
on production; forgot about that. It's under fcgold on dev. Can't
login to staging; shadow file was lost. Chris figuring out why. Says
staging has all kinds of problems since the filling of the db2
partition.





#########################################################################
040421 Wednesday

GG out sick today. Staging should be up, testing...

Swolf forwarded an email about Rob getting a search error... this is
the SOAP exception I've been seeing in the logs. Filed a detailed
Bugzilla ticket. Did I file one for V3? The line 325 bug? I did.

We need a process whereby we cull the logs daily and resolve these
exceptions. It's costing the company in lost sales.


----
Strange error I need to grok later on staging:

Connecting to User Session
pushing: 1082582137.473989      Insert info for [autoprovtestone.myphotobuddy.com] into D\
omainHistory table
pushing: 1082582238.413295      Create a launch wizard entry
pushing: 1082582293.818245      Add any extra extension related tasks
[ERROR] Could not retrieve jobId 1082582297.212881
pushing: 1082582293.818245      Add any extra extension related tasks
Traceback (innermost last):
  File "./jobSubmitByString.py", line 118, in ?
    system.setJobStatus(sessionkey, currentJob.id, evw.Core.CommandTaskActive)
  File "/usr/lib/python1.5/site-packages/evw/Core/__init__.py", line 2555, in setJobStatu\
s
    # Create a request object.
  File "/usr/lib/python1.5/site-packages/Fnorb/orb/DII.py", line 160, in invoke
    (forwarded, self.__results) = client.synchronous(self, args)
  File "/usr/lib/python1.5/site-packages/Fnorb/orb/GIOPClient.py", line 146, in synchrono\
us
    result = self.__process_reply(request, reply)
  File "/usr/lib/python1.5/site-packages/Fnorb/orb/GIOPClient.py", line 448, in __process\
_reply
    raise typecode._fnorb_unmarshal_value(cursor)
evw.Core.CommandNotFound: <evw.Core.CommandNotFound instance at 3007f0>

-----


Autoprovisioning is done. It needs more testing but it works.




#########################################################################
040422 Thursday

I think I'll outline the autoprovisioner in today's dev meeting,
asking for points of failure.

/usr/bin/enscript -2Gr file

Today's dev meeting: I got to whiteboard the basic architecture of
autoprovisioner. GG said this was a good thing for Trev since he'll be
doing something similar. Which makes me realize, we have no
deprovisioning. We can do an email-on-uninstall.

Some ideas given to me:

* move galleryEmailReceiver.pl to evw-1. It has the responsibility of
  copying between machines.Maybe use Net::SSH to handle the call.
* The cron job that cleans out the 'done' directory can email a report
  on what was provisioned.
* NetSaint alerts on the directories where the emails move through the
  workflow. If one has count(emails) > N then send an alert.
* A supervisor scrip that calls the three cron scripts in turn would
  alleviate any issue with race conditions. "do command if fail send email"
* Test for a full partition. GG thinks the number one worry should be
  disk space. Number two, network issues. Three, DNS problems.
* It just occured to me we can make a deprovisioner script that sends
  an email which kicks off a deprovisioning process (basically, delete
  the gallery site.)

Lunch with Lysa, who's interviewing with Ziff/Davis today. Got three
queries from Ronny to add to the support wizard code.

Domain searches broken on staging. Emailed ops. Dealing with Ronny's
stuff first.

Ronny's stuff completed. Regenerated data for the 20th of April, looks
good.

Puzzle: 
-rw-r--r--   1 root     other       74235 Apr 22 17:42 stagingtest422.myphotobuddy.com.sh
-rw-r--r--   1 root     other           0 Apr 22 17:45 stagingtest422B.myphotobuddy.com.sh

The host is unreachable:
ketelone:~ swain$ nslookup stagingtest422B.myphotobuddy.com
Note:  nslookup is deprecated and may be removed from future releases.
Consider using the `dig' or `host' programs instead.  Run nslookup with
the `-sil[ent]' option to prevent this message from appearing.
Server:         67.109.98.227
Address:        67.109.98.227#53

** server can't find stagingtest422B.myphotobuddy.com: NXDOMAIN



Locally on Rah:
ketelone:~ swain$ curl http://stagingtest422B.myphotobuddy.com/
<br />
<b>Fatal error</b>:  Failed opening required './util.php' (include_path='.:/opt/php4/lib/php') in <b>/export/home/evw/var/webs/virtual/s/st/sta/www.stagingtest422B.myphotobuddy.com/web/init.php</b> on line <b>98</b><br />



We see:
[root@cws-1 web]# ls
Version.php            css                  html              move_album.php          rename_album.php
add_comment.php        delete_album.php     html_wrap         move_photo.php          reset_votes.php
add_photo.php          delete_photo.php     images            multi_create_user.php   resize_photo.php
add_photos.php         delete_user.php      index.htm         new_password.php        rotate_photo.php
adv_search.php         do_command.php       index.php         nls.php                 save_photos.php
album_permissions.php  docs                 init.php          photo_owner.php         search.php
albums.php             edit_appearance.php  java              platform                session.php
ampira                 edit_caption.php     js                po                      setup
ampira.redirect.php    edit_field.php       layout            poll_properties.php     skins
captionator.php        edit_thumb.php       locale            poll_results.php        tools
classes                errors               login.php         progress_uploading.php  user.local.php
config.php             extra_fields.php     manage_users.php  publish_xp.php
copy_photo.php         gallery_remote.php   manifest.inc      publish_xp_docs.php
create_user.php        gallery_remote2.php  modify_user.php   register.php


So: unreachable, no util.php, and the shell script is empty. I need to
fix the provisioner so that the perl and shell script output is
captured in the log (stderr).


#########################################################################
040423 Friday

Rolled out Autoprov to cws-1.prv. I updated the Twiki pages and
emailed Ops notifying them of the changes. Rollout showed another bug:
when galleryEmailReceiver.pl can't open the file, all info was simply
lost.

Tried to cvs co the new gallery2; cvs coredumps on pork. Can't do it
on ketelone either, as some funky char causes cvs to barf. Downloading
a nightly build.

But the code base is described as pre-alpha. It may very well never be
finished.



#########################################################################
040426 Monday

I thought Gprov worked fine over the weekend, but it turns out it
didn't unstick the jobs. My bad. I should have looked at the
unstick.vps page, but all I did was look at the dirs on cws-1.prv:

bash-2.04$ ls -l need* done*
done:
total 15
-rw-r--r--   1 autoprov autoprov     2669 Apr 25 22:21 STUDIOS357.myphotobuddy.com
-rw-r--r--   1 autoprov autoprov     2557 Apr 24 18:17 amysmegasite.com
-rw-r--r--   1 autoprov autoprov     2688 Apr 25 16:47 markmardon.myphotobuddy.com
-rw-r--r--   1 autoprov autoprov     2678 Apr 25 16:44 mzpiggeepig.myphotobuddy.com
-rw-r--r--   1 autoprov autoprov     2547 Apr 23 13:58 swain.myphotobuddy.com

needfiles:
total 0

needformfilled:
total 3
-rw-r--r--   1 autoprov autoprov     2731 Apr 26 09:40 szegedchicky.myphotobuddy.com

needunstuck:
total 0


This fooled me into thinking that they succeeded; and I saw in the
shortforms the email addresses had been added.

Failed assumptions: 

1. That calling the shortform, and getting a 1 back (success) means we
   got to the form. But if the form is not there, wouldn't there be an
   error? I should think; it happened in testing.


2. That the job ID will always be there before we call the vps
   file. It may be that unstick.vps gets called before the job lands
   in "Awaiting reply."

In a sense I lucked out that these jobs were not unstuck... though a
few of them were actually provisioned, one was not.

-rw-r--r--   1 autoprov autoprov     2669 Apr 25 22:21 STUDIOS357.myphotobuddy.com
-rw-r--r--   1 autoprov autoprov     2557 Apr 24 18:17 amysmegasite.com
-rw-r--r--   1 autoprov autoprov     2688 Apr 25 16:47 markmardon.myphotobuddy.com
-rw-r--r--   1 autoprov autoprov     2678 Apr 25 16:44 mzpiggeepig.myphotobuddy.com


amysmegasite.com is registered with GoDaddy. This has to be a domain
transfer. We now have a chicken and egg problem: domain transfers
cannot happen until the site is provisioned, and the site cannot be
provisioned until the domain is transferred.

For the other three, they were correctly provisioned but the jobs were
not unstuck. I've updated those jobs and they are off on their merry
way.

DOH! I left the URL for development in the fachunking code! That's why
the jobs weren't updated!

I put a bunch of fixes in for autoprovisioner. I'm calling `hostname`
to determine what machine to call; I put all WWW::Mechanize calls into
a try/catch (eval/if $@) block.

Rolled out, did some detective work after testing, and provisioned the
site with the domain transfer.




#########################################################################
040427 Tuesday

	From: 	  gautamg@fortunecity.com
	Subject: 	OpenSRS verfication steps
	Date: 	April 26, 2004 11:24:04 PM EDT
	To: 	  ops@ampira.com
	Cc: 	  dev@ampira.com

to verify that our connection to opensrs is working fine, there are two methods

1. on web-?.v3.com run (as root)

/opt/opensrs-client-2.73/cgi/verify_install.cgi

this verifies that our opensrs client library install is working ok

2. on web-?.v3.com run (as root)

 ~gautamg/src/dnaservice/bin/lookup.pl futuredead.com

(or some other domain)

this verifies that we can lookup a domain availability against their production server

--
Gautam

----------------------------------

Converting to MyPhotoAlbum:

* created new directory in CVS
* mass changed all instances of buddy, Buddy, and mpbw
* compiled
* changed resin.conf on devil and staging (added entry for mpaw)
* pushed wizard to both devil and staging, it compiles (nothing bought
  though)
* packages.xml updated with new product IDs
* bought package on staging, job stuck though
* changed the text in the gallery files
* created dotproject project for myphotoalbum


#########################################################################
040428 Wednesday

Whew. Busy from the moment I arrived. Swolf is pressing to complete
Autoprovisioning. I need to run a test on doing a setup/copy using a
dummy site.

Jessy and I needed to catch up on MyPhotoAlbum; I put the query in the
wrong method for Ronny and had to recitfy that.

Rats. My idea won't work. It's too complicated to set up a gallery on
one site, and then copy/change the files to another. It couldn't be
done in an afternoon, not easily... too hackish.

images.myphotoalbum.com: Images only live on on app-2. There is an
entry in httpd.conf on that machine to accept requests from both
secure and insecure ports (80 and 443). I added, under GG's direction,
a ServerAlias directive. Though the conf file shows 192.168.4.132,
there is some NAT going on somewhere so in my hosts file I have to put
216.27.95.132. This addition to the httpd.conf was to the block for
images.myphotobuddy.com. Images from dynamic pages are referenced
relative, and static pages reference them dynamically.

Battled weird problem where the signup wizard for MPAW kept finding
the wrong package ID (the old one); had to restart Resin to clear out
the old number, ultimately.

Tackled Swolf's bug about html email... turns out he uses AOL's web
mail. No matter; Outlook can't render the html email, nor Mail.app,
nor Mozilla on Windows. I added a line to the header and deployed to
staging, but to no avail: mail sent off Rah vanishes into the Twilight
Zone.

Well, adding Content-type: text/html is a start. At least that got the
tags rendered.


#########################################################################
040429 Thursday

Conversation with JeffO from yesterday about fooling WWW::Mechanize as
though we'd edited /etc/hosts:

AIM IM with jeffoatrulez
4/28/04, 2:26 PM
Steve Wainstead: ping
2:35 PM
jeffoatrulez: s'up?
2:55 PM
Steve Wainstead: got a hard perl question
jeffoatrulez: no such thing. 
Steve Wainstead: i need to fool resolving
Steve Wainstead: i'mm using WWW::Mechanize
Steve Wainstead: to fill and submit a form
Steve Wainstead: on a remote server.
Steve Wainstead: but the domain name isn't ready, sometimes
3:00 PM
Steve Wainstead: so how i do it by hand is to put the IP of the box and the FQDN in my /etc/hosts
jeffoatrulez: and it's a virtual host?
Steve Wainstead: this perl script runs under cron.
Steve Wainstead: yeah
jeffoatrulez: are the domains in ldap?
Steve Wainstead: getting the domains is a nonissue; it comes as input
Steve Wainstead: and i can map the cws server to its ip address
Steve Wainstead: so, say example.com is on cws-3
jeffoatrulez: right, but they're stored in ldap right? ( go with me... )
Steve Wainstead: hmm
Steve Wainstead: not sure
Steve Wainstead: the domain name is def. in ldap. yes.
jeffoatrulez: ok. well i was thinking, isn't there a way to use ldap for name resolution? maybe you can get the server to fall back to ldap is the dns record isn't found....
Steve Wainstead: sounds pretty esoteric 
jeffoatrulez: it was a perl question, right? 
Steve Wainstead: on a low level it does a gethostbyname, right?
Steve Wainstead: so i just want a hack to return the ip address of the cws box.
jeffoatrulez: yup. but i think you can tell the system to use ldap in gethostbyname calls.
Steve Wainstead: so to speak.
Steve Wainstead: hmm
jeffoatrulez: yeah, but it's a virtualhost, so you need to actually request it by name, otherwise apache will give you the default server.
Steve Wainstead: for virtual hosting to work, it has to call the ip address with the server name of example.com
Steve Wainstead: right
3:05 PM
jeffoatrulez: maybe all you have to do it hack the headers in the http module.
jeffoatrulez: you'd have to make some changes to www::mechanize and whichever http module it uses.
Steve Wainstead: i was hoping there was a perl module way to do it...
Steve Wainstead: etc::hosts.pm 
jeffoatrulez: 
Steve Wainstead: i can't believe this hasn't been encountered and solved.
jeffoatrulez: but it's a system level thing. unless you can override perl's call to gethostbyname()......
3:10 PM
Steve Wainstead: since all the HTTP communications take place via Perl and a socket, the total control of the process is there...
Steve Wainstead: so i would imagine HTTP::UserAgent would have a feature, like a method mapHostToIPAddress(127.0.0.1 => 'example.com')
Steve Wainstead: or 'example.com' => '127.0.0.1'
Steve Wainstead: rather
3:15 PM
jeffoatrulez: maybe ... but i'd guess not.
jeffoatrulez: but since it's open source.....
3:20 PM
jeffoatrulez: ok. you can do it.
jeffoatrulez: pass a HTTP::Headers object into HTTP::Request before the call the HTTP::UserAgent.
Steve Wainstead: hmm
jeffoatrulez: you'll need to modify the appropriate header like this: $h->header('Content-Type' => 'text/plain');
Steve Wainstead: i have no fear of http headers 
jeffoatrulez: ( or i should say, "you may be able to do it!" )
jeffoatrulez: not sure what the appropriate http header is, off the top of my head.
3:25 PM
Steve Wainstead: if you haven't tried it yet: firefox has an extention , "Live HTTP Headers"
Steve Wainstead: way cool
Steve Wainstead: like your own proxy server. prints all headers to a window.
jeffoatrulez: how do you enable it
jeffoatrulez: ?
Steve Wainstead: if you hve firefox, then go to hte link Plug-in FAQ
Steve Wainstead: or http://plugindoc.mozdev.org/faqs/
jeffoatrulez: cool. 
Steve Wainstead: from that page..
Steve Wainstead: mac osx
Steve Wainstead: the next page, extensions
jeffoatrulez: found it. installing....
Steve Wainstead: ok
jeffoatrulez: i guess 'Host' is the field you need to hack, right?
jeffoatrulez: unless that'll screw up the lookup.
3:30 PM
Steve Wainstead: i'm dealing with ten things at once, sorry...
jeffoatrulez: but maybe http doesn't let you do what you want to do....
3:35 PM
jeffoatrulez: i think you're screwed - http://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html#sec5.3
jeffoatrulez: but it's an interesting problem ... really.
3:50 PM
Steve Wainstead: http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.23
Steve Wainstead: now, the cws server already has a virtual host conf file for the new site
Steve Wainstead: so it's aware that it hosts that virtual host
Steve Wainstead: it's a matter of the dns not being able to resolve it yet
Steve Wainstead: so i was just waiting until it did become available; but it turns out when the user buys a package, and *is transferring a domain*, it will never be available until the package is bought/installed.
Steve Wainstead: butthe package cannot be installed until the domain name is available.
3:55 PM
jeffoatrulez: chicken ... egg .. chicken ... egg?
4:05 PM
Steve Wainstead: exactly
Steve Wainstead: and it's the case where every other situation, the site is provisioned correctly. except this one. 


----

Busy morning with lots going on; I've sorta run into trouble with
swolf though, since I have been working on things other than the
marketing report. I was doing work on a plethora of things centered
around myphotoalbum. Yesterday afternoon I fixed the HTML email bug.

GG proposed that autoprovisioning simply unstick the job after the
files are in place, and let the form filling script loop until the
form is actually filled. This is a simple workaround and only took me
about 45 minutes to implement and test. Sent an email asking if the
copy of the welcome letter should change before I roll it out. This
solves the problem with domain transfers.

I need to knock off the marketing report project asap.

Rolled out autoprovisioner; cvs committed all entries; blew away my
photobuddy on rah and checked out photoalbum.

I have a match on the evwtrustlist entry to the person objects in
ldap. I decided for now to go with a persons table and an orgs
table. I've also decided to err on the side of caution and load as
much info as I can into the database; hopefully it's not all that much
for 13K entries.




#########################################################################
040430 Friday

Didn't sleep well early this morning. Stressed about the marketing
report stuff, but where I shouldn't be, I suppose. Got hung up on a
stupid bug today: I wasn't using chomp on data read from the <DATA>
filehandle.

Adequate test data for the marketing report: nine new accounts on
devil on 11/25/04.

db2 "select organisationdn from accountholders, accounts 
where instyear=2003 
 and instmonth=11
 and instday=25
 and accounts.accountholderid = accountholders.accountholderid"


Ack. Need Python to talk to the Product Module. Or Java mayhap.


#########################################################################
040503 Monday

Hmm. Thought I updated this on Friday.

I ran into a roadblock with the marketing report. The problem was a
call to the Product Module for the package name; no way to do this in
Perl as of yet. It could probably be looked up without calling the PM
but time was short.

I found that I could add what was needed to the marketing report
fairly easily because the org owner is in the evwtrustlist field; I
only had to split it out, do a second query (per org) for the
firstname/lastname and add them. The accountid was just an extra field
added to the annivesary date query. Two date fields were added, and
then I split the package names into columns. Tested, cron'd, all done.

Today I went through all my scratch sheets and compiled a list of
everything that needs doing. It was quite long. By chance a customer
decided to cancel their gallery account, and it turns out
deprovisioning will delete their gallery site, so I don't need to do
anything extra for that.

I'm trying to keep the MyPhotoAlbum project updated in dotproject. So
far I'm not too excited about it. It's not nearly as useful as
Bugzilla.

Worked with Zlatin to get the domains myphotobuddy.com and
myphotoalbum.com set up on development. Sent an email to Rob to get
them tweaked into legit subdomains. GG says my priorities are #1
marketing report, #2 myphotoalbum, and we have to work out priorities
on the bug list.




#########################################################################
040504 Tuesday

Chatted with Swolf when I arrived... he emphasized that bugfixes took
precedence over anything else, even the Marketing report. He asked
about, and I described, Rob's extremely positive reaction to the
change to the marketing report on Friday.

I was fighting against bad input yesterday on the parsing script,
to-ms-access.pl. I neglected to convert tabs to commas. It's now
generating the data for the accounts table Rob wants; next I need to
get the data printed out for the package history table; then build a
database on borgcube; then set up Rob. If I get all that done today it
will be a good day.

I finished the conversion script; I got access to borgcube and mysql;
just created a database; next, spec out a schema.

Jay bug: no occurances on app-2. The string "Error from jsp input"
hasn't appeared since April 22nd.

Tue May  4 03:10:00 2004 (ampira timestamp)
java.lang.NumberFormatException: 
        at java.lang.Integer.parseInt(Integer.java:435)
        at java.lang.Integer.parseInt(Integer.java:463)
        at _pages._signup._outertemplate__jsp._jspService(_outertemplate__jsp.java:762)
        at com.caucho.jsp.JavaPage.service(JavaPage.java:87)
        at com.caucho.jsp.JavaPage.subservice(JavaPage.java:81)
        at com.caucho.jsp.Page.service(Page.java:474)
        at com.caucho.server.http.FilterChainPage.doFilter(FilterChainPage.java:166)
        at com.caucho.server.http.Invocation.service(Invocation.java:277)
        at com.caucho.server.http.CacheInvocation.service(CacheInvocation.java:129)
        at com.caucho.server.http.QRequestDispatcher.forward(QRequestDispatcher.java:213)
        at com.caucho.server.http.QRequestDispatcher.forward(QRequestDispatcher.java:99)
        at com.caucho.server.http.QRequestDispatcher.forward(QRequestDispatcher.java:76)
        at com.ampira.myphotobuddy.servlets.MyPhotoBuddyWizard.doPost(MyPhotoBuddyWizard.java:579)
        at javax.servlet.http.HttpServlet.service(HttpServlet.java:165)
        at javax.servlet.http.HttpServlet.service(HttpServlet.java:103)
        at com.caucho.server.http.FilterChainServlet.doFilter(FilterChainServlet.java:82)
        at com.caucho.server.http.Invocation.service(Invocation.java:277)
        at com.caucho.server.http.CacheInvocation.service(CacheInvocation.java:129)
        at com.caucho.server.http.RunnerRequest.handleRequest(RunnerRequest.java:334)
        at com.caucho.server.http.RunnerRequest.handleConnection(RunnerRequest.java:266)
        at com.caucho.server.TcpConnection.run(TcpConnection.java:140)
        at java.lang.Thread.run(Thread.java:484)
javax.servlet.ServletException: Error from jsp input.
        at com.ampira.myphotobuddy.servlets.MyPhotoBuddyWizard.doPost(MyPhotoBuddyWizard.java:124)
        at com.ampira.myphotobuddy.servlets.MyPhotoBuddyWizard.doGet(MyPhotoBuddyWizard.java:29)
        at javax.servlet.http.HttpServlet.service(HttpServlet.java:126)
        at javax.servlet.http.HttpServlet.service(HttpServlet.java:103)
        at com.caucho.server.http.FilterChainServlet.doFilter(FilterChainServlet.java:82)
        at com.caucho.server.http.Invocation.service(Invocation.java:277)
        at com.caucho.server.http.CacheInvocation.service(CacheInvocation.java:129)
        at com.caucho.server.http.RunnerRequest.handleRequest(RunnerRequest.java:334)
        at com.caucho.server.http.RunnerRequest.handleConnection(RunnerRequest.java:266)
        at com.caucho.server.TcpConnection.run(TcpConnection.java:140)
        at java.lang.Thread.run(Thread.java:484)



#########################################################################
040505 Wednesday

Came in, updated the marketing db for Rob, spent over an hour
explaining vps control panel files and paths.xml/packages.xml to
Trevor. Closed Swolf bug on servlet error when clicking links on the
test page. Analyzed the log for Jay's bug; remarkably, when he goes
from the config page to the summary page his session is lost. Sadly,
the user data bean doesn't have a toString() method.


#########################################################################
040506 Thursday

Did all the work yesterday of moving the DNA search code into the JSP
template system. Rationalization: in the later days of an app, you
optimize it, and sometimes optimization compromises the design.

Stepped into a conversation Jessy and Swolf were having over the
"search in progress" issue. Swolf was adamant that the system be
checked for pending jobs that are for a given fqdn, that we do not
allow two people to register for the same fqdn. I assured him the test
would come later in the buy process.

I culled the Resin logs on both app servers after overhearing Peter
press Swolf about the lack of MyPhotoBuddy sales (none in two
days). There have only been two errors in five days: Jay's and Kurt's,
and the wizard has seen almost no action at all in the last two days.

At COB today we lose the staging environment for over a week.




#########################################################################
040507 Friday

Only one bug overnight for MyPhotoAlbum: Jay Metcalfe, of course. I
can rule out a race condition because he's the only one attempting to
do anything at 3:25am.

What if it's an issue of the servlet sitting too long? I think in the
past he tried twice in a row, so that would probably rule that out.

OK, *finally* I've reproduced it. I must not have noticed before that
the servlet thinks it's a new shopper and creates a new selections
bean. It's a cookie problem. When Jay goes from the results page to
the config page, his browser is not returning the cookie with the
session ID. The servlet thinks it's a new shopper.

We can test for this: if the selections bean is null, and we are not
going to the search page (choice == "search") then there is an error.

I realized that if Jay has cookies disabled, then every time he hits
the servlet he's going to get a new selection bean, and indeed, the
log reflects this.




#########################################################################
040510 Monday

Support closed the ticket on
maxcarolynwedding.myphotobuddy.com. Unfortunate; I'm sure the problem
will resurface.

Jay Metcalfe could not sign up again over the weekend and I'm punished
for not buying a site myself... I would have seen that the package ID
is lost going from summary to config. This is because there is no
cookie and url rewriting is hosed by the path_info. Today in the
morning tech staff meeting I proposed the three solutions: we don't
allow anyone to register who has cookies disabled; we do away with
path_info so url rewriting works (but we lose hitslink); or we upgrade
the app server to either tomcat or the latest resin, either of which
should be able to discern between session IDs and path_info.

Weirdly, of the five Galleries bought over the weekend, one was a
domain transfer and it worked. It may be that once the server knows it
hosts the domain, our DNS is updated with the address; and the outside
world cannot see it but internally autoprov can see it.

I need to update the database again for Rob. I wonder if I drop the
session ID into a form variable, will it work? Instead of url
rewriting. Probably not.

Putting the session ID into the html form was useless. I just ran a
test on that and confirmed url rewriting won't work that way.


#########################################################################
040511 Tuesday

Yesterday afternoon I updated the dotproject for MPA phase 2 and gave
an estimate of COB Friday for phase 2 issues; also in the dev meeting
we discussed a plan for migration to Tomcat 5 and Java 1.4.2, and GG
is going to present a plan to mgmt today.

I figured out a faster way to clear the spam out of my mail account; I
discovered I had a quarter of a million mails in my 'system' folder;
I'm cron'ing the loading of daily data into the database for the
marketing report. The Python script is failing late in the process due
to some issue with the accountid. Right now I'm timing the Python
script for getting data for the last five and a half weeks.

I emailed Trevor on how emails are moved from evw-1 to cws-1. He needs
to do something similar for the ecommerce stuff.

I should set up autoprovisioning on the devil environment.


#########################################################################
040512 Wednesday

Well. Came in to a failed autoprov. Turns out Ops "upgraded" the perl
installation on cws-1 and didn't include WWW::Mechanize. They are
undoing the mistake now.

Meanwhile something weird happened with the automatic loading of the
database for the marketing report. 60K rows for may 10th? I think it
must have loaded the data for ... uh oh... I left the cron job running
every minute. :o)

OK, updates. Phase 2 of MPA was delayed, unbeknownst to me. Today I
dealt with a slew of interruptions; I had to manage the rollout of the
MPA wizard, updating the resin.conf files and switching app servers. I
cleaned out my folders on ims-1. I talked with Rob at length; he
emailed about the V3 exceptions. I have been doing work on the
marketing report, and I think the way to go is with individual
programs.... each generating a data set, all tied together ultimately
by the orgDn. Will it fit in mysql? yeah, it should. That box has
several gig. Product info is stored in a blob, likely. Hey! We can
cache that info every time Rob makes/changes packages! That will save
on processing.

Metrics: about 41K package ids in the packageaction table (unique),
meaning that many hits on the product module.

22K rows of anniversary data

35MB of org/person data. I can discard the uneeded fields.

I think simple Perl scripts to get/print the db2 data are in
order... unless I can find how to specify a delimiter in output from
the db2 command.

I don't think the quantity of data is going to be that great, in the
end.

An org and its owner:


[evw-1 perl]$   ldapsearch -h localhost -p 400 -D "cn=Directory Manager" -w "11223344" -b "o=blippynews,ou=Clients,o=FCDE" "(|(objectclass=organization)(objectclass=person))"
o=blippynews,ou=Clients,o=FCDE
cn=blippynews
evwaccountholder=0000004381
evwdescription=blippynews
evwemailaddress=blippy@ampira.com
evwispdn=o=FCDE
evwmanagerdn=Organisation Manager
evworgtype=ORG
evwpostal1=blippynews
evwpostal2= 
evwpostalcity=blippynews
evwpostalcountry=US
evwpostalstate=IA
evwpostalzip=blippynews
evwprofile=011111110*
evwstreet1=blippynews
evwstreet2= 
evwstreetcity=blippynews
evwstreetcountry=US
evwstreetstate=IA
evwstreetzip=blippynews
evwtrustlist=W||username=blippynews,ou=People,o=blippynews,ou=Clients,o=FCDE||0111111111*|00001000000*
facsimiletelephonenumber= 
o=blippynews
objectclass=top
objectclass=organization
objectclass=evwAddressableEntity
objectclass=evwObject
objectclass=evwAccountHolder
telephonenumber=2223334444

username=blippynews,ou=People,o=blippynews,ou=Clients,o=FCDE
cn=blippynews
evwcleartextpassword=blippynews
evwdescription=blippynews
evwemailaddress=blippy@ampira.com
evwhintanswer=blippynews
evwhintquestion=blippynews
evwispdn=o=FCDE
evwmanagerdn=User Manager
evworgdn=o=blippynews,ou=Clients,o=FCDE
evwprofile=111010010*
objectclass=top
objectclass=person
objectclass=evwAuthObject
objectclass=evwObject
objectclass=evwAddressableEntity
sn=blippynews
username=blippynews
userpassword=blippynews


About 0.5K for this user and org, in bytes. I can probably just go
the route of "fetch all orgs; fetch each user in the org's trust list"
and output that data. A tab delimited file for output. Yes, this will
work: as I originally intended, separate tables in mysql for package
history, anniversary, orgs+owners, and pacakge names. I need to puzzle
over the IP bit though.

cn=blippynews
evwaccountholder=0000004381
evwdescription=blippynews
evwemailaddress=blippy@ampira.com
evwispdn=o=FCDE
evworgdn=o=blippynews,ou=Clients,o=FCDE
evwpostal1=blippynews
evwpostal2= 
evwpostalcity=blippynews
evwpostalcountry=US
evwpostalstate=IA
evwpostalzip=blippynews
evwstreet1=blippynews
evwstreet2= 
evwstreetcity=blippynews
evwstreetcountry=US
evwstreetstate=IA
evwstreetzip=blippynews
evwtrustlist=W||username=blippynews,ou=People,o=blippynews,ou=Clients,o=FCDE||0111111111*|00001000000*
facsimiletelephonenumber= 
o=blippynews
sn=blippynews
telephonenumber=2223334444
username=blippynews,ou=People,o=blippynews,ou=Clients,o=FCDE


EVW on production is being kind of weird about giving me the package
info though. Strange.


#########################################################################
040513 Thursday

Doh. Forgot to rebuild the database for the marketing
report. Done. Apology sent to Rob.

Testing hostv3 uglyboy on production:
https://secure.hostv3.com/cartwizard/pages/cartwizard/outertemplate.jsp?domain=thishoochydomain.com&period=1

Had lunch with Jeanne.

I inadvertently solved a different bug: #440, the "line 325" error,
was due to cookies not set.

The weird thing about bug #436 is a lot of the clients are Nokia
phones or somesuch. I was able to duplicate the error exactly by
removing the productid from the GET data.

Yup, so, weird browsers hit www.v3.com, do a domain search, and the
search is sent to /wizard/signup/signup. An html parsing problem on
those clients, likely.

Back to the marketing report.

Parse an EVW config file:

sub getConfig {
    my $pattern = shift; # should look like [Database] or [Ldap]
    #print "using pattern $pattern\n";
    my $configfile = "/opt/evw/etc/ProductModule.conf";
    my %hash;

    open CONFIGFILE, $configfile
        or die "Can't read the config file '$configfile': $!\n";

    # skip all lines up to $pattern
    while (<CONFIGFILE>) {
        next unless /\[$pattern\]/o;
        #print "found pattern: " . $_;
        last;
    }

    # make key/value pairs until the next line starting with '['
    while (<CONFIGFILE>) {
        next unless /\w/;
        last if /\[/;
        chomp;
        my ($key, $val) = split /\s*=\s*/, $_, 2;
        $hash{$key} = $val;
    }
    
    return %hash;
}




#########################################################################
040514 Friday

GG wrote a new deploy procedure for fc gold last night, which blew
away myphotoalbum's images. That was the emergency this morning.

I updated/ran the two ldap scripts on borgcube and the two db2 scripts
on db2-2. Huge win: taking out the ORDER BY in the package activity
query reduced the runtime from hours to seconds (no exaggeration). It
probably helps that there's no network call either. Now on to the
program that gets all package information.

Table to hold package activity data:

ORGANISATIONDN                 SYSIBM    VARCHAR                 250 0 No
ACTIONTIME                     SYSIBM    INTEGER                   4 0 No
EVWPACKAGEID                   SYSIBM    VARCHAR                  25     0 No    
PACKAGEACTION                  SYSIBM    VARCHAR                  50     0 No    
ISPDN                          SYSIBM    VARCHAR                 250     0 No    
FQDN                           SYSIBM    VARCHAR                 100     0 No    
PRODUCTID                      SYSIBM    VARCHAR                  25     0 No    

Table to hold anniversary data:

ORGANISATIONDN                 SYSIBM    VARCHAR                 255     0 No    
INSTYEAR                       SYSIBM    INTEGER                   4     0 Yes   
INSTMONTH                      SYSIBM    INTEGER                   4     0 Yes   
INSTDAY                        SYSIBM    INTEGER                   4     0 Yes   
INSTHOUR                       SYSIBM    INTEGER                   4     0 Yes   
INSTMINUTE                     SYSIBM    INTEGER                   4     0 Yes   
ACCOUNTID                      SYSIBM    INTEGER                   4     0 No    

Zzzzzzzzzz... zzzzz.... zzzz... it takes a long time to query for
package names. We hit the product module about 40 or 50 thousand
times.

Here, then, is a candidate for caching. Or at least, we only collect
data for the prior month and use mysqlimport -i to ignore duplicate
entries. Best to overlap a bit.

I added the domainhistory table to mysql as well, since Rob wants
expiry dates on the domain names (it appears). Perhaps the 201K
warnings it made were about the TIMESTAMP field.

Meanwhile, all orgs and users are in the database, keyed on orgdn and
userdn, respectively. I did a join to count orgs and owners and it
looked good.

Anniversary dates are in the database. When this python script is done
I'll load the package history, and then the data will hopefully be
complete. I have to select into Rob's desired tables.

Here's the skinny: shell into db2-2 and run the three perl scripts to
dump the respective datasets. scp two of those down to borgcube and
mysqlimport.

Next run the two ldap scripts via ssh tunnel on borgcube. mysqlimport
the data.

Next scp the packagehistory file made on db2-2 to evw-1.prv and run
the script getProductNames.py in
/opt/evw/scripts/batchprocessing. This will take hours to run
(literally) and then scp the output file down to borgcube and
mysqlimport.

To create Rob's tables I still need the proper select statements.

Yay. package activity loaded.


#########################################################################
040515 Saturday

Emergency call from GG, opensrs is off the net. I'm looking at whether
we can hack the subdomain search client to pinch hit for the dns
service.




#########################################################################
040517 Monday

Rolled back the changes to the wizards. Rob got emails from OpenSRS on
a scheduled maintainence outage but they wound up in his spam folder.

SELECT INTO OUTFILE: first, you need FILE privileges. Default is tab
delimited (yay!).

Doh. I was deleting the table and importing to it at the same
time. mysql is probably in some very long recovery operation now.

I really, really need a recovery hook for shell buffers. I
inadvertently lost useful data when I ran sw-sql and the old shell
contents were stomped out. Although, one single backup copy is going
to rectify that... but I don't see where it would be any harder to
code it the other way (load contents at point-min).




#########################################################################
040518 Tuesday

Investigated setting up mpa.dvl.ampira.com for myphotoalbum stuff on
devil... but setting up a copy of the static site seems impractical. I
dunno. I'm shelving this for now. One thing I did learn is that
ampira.dvl.ampira.com resolves to the default site on devil,
evw-frontend, which explains prior entries in this log.

OK, time to make a few notes about the procedure before I forget it
all. First, ssh into db2-2.prv.

bash-2.04$ ls -lt
total 14130
-rwxr-xr-x   1 swain    sysadmin     2411 May 14 17:06 domainHistory.pl
-rw-r--r--   1 swain    sysadmin  5867468 May 14 16:48 domainhistory.out
-rw-r--r--   1 swain    sysadmin  7028193 May 14 11:09 actions.out
-rwxr-xr-x   1 swain    sysadmin     3120 May 14 11:08 packageActions.pl
-rw-r--r--   1 swain    sysadmin  1527802 May 14 10:49 anniversaries.out
-rwxr-xr-x   1 swain    sysadmin     2418 May 14 10:48 orgAnniversaryData.pl

Each of the three perl scripts dumps a particular table.
actions.out has to be moved over to evw-1.prv as input, to get all the
package names. The other two are brought down to borgcube.

On evw-1.prv:/opt/evw/scripts/batchreports, lies
getProductNames.py. It takes actions.out as input. It generates
actionsandnames.out, which has to be copied down to borgcube. It takes
hours to run.

On borgcube, meanwhile, I have two perl scripts in my cvs
project. One pulls all orgs, the other all users.

So: five evw tables in mysql. Each is derived from this source:

 evw_domainhistory    domainHistory.pl on db2-2
 evw_org_anniversary  orgAnniversaryData.pl on db2-2
 evw_organizations    ~/cvs/pgms/perl/ldap-get-orgs.pl on borgcube
 evw_package_activity packageActions.pl on db2-2, getProductNames.py on evw-1.prv
 evw_users            ~/cvs/pgms/perl/ldap-get-users.pl on borgcube

Once these three tables are populated, Rob's other four can be filled
by doing SELECT INTO OUTFILE statements, and mysqlimport on the
outfiles. Note that for currently_installed, the input file has to be
preprocessed with prep_current_installed.pl first. This omits the
installedpackagename 'unknown' records and splits the package name
into subsequent fields.

-- this dumps stuff from two tables to be loaded into the 'domains'
-- table for Rob
select 'NULL', accountid, vispdn, orgdn, fqdn, expirydate, initialdate
into outfile '/tmp/domains.in'  from evw_domainhistory,
evw_org_anniversary where orgdn=organisationdn;

-- dump data for currently_installed; needs postprocessing with
-- prep_currently_installed.pl
select 'NULL', ispdn, accountid, installedpackagename into outfile
'/tmp/currently_installed_unprocessed.out' from evw_package_activity
epa, evw_org_anniversary eoa where epa.organisationdn =
eoa.organisationdn;

Created makeAccountsTable.sql, which is a good way to do this in a
verbose documented manner. Discovered the CONCAT() function, which let
me combine three columns (year month day) into one.

Created makePackageActivity.sql and preprocessPackageActivty.pl to
split the package names into columns.

Well, outside of mispopulated columns, or somesuch, this project is
entering maintenence phase.

I created a bugzilla project for the marketing database; Twiki
documentation; and a cvs project. Filed two bugs. I think I can come
at other things fresh tomorrow... kinda hard to get started on
something else right now.

GG emailed about a token idea for free signups for myphotoalbum;
sounds doable. Not sure why he wants a separate xml file though.




#########################################################################
040519 Wednesday

GG out sick today. Asked that we update our dotprojects.

Looking at the max file size upload problem:

1) PHP limits the user to 2MB per file. No word on groups of files.

2) The form uses POST with enctype="multipart/form-data"

3) It also uses <input type="hidden" name="max_file_size"
   value="10000000">, which I think is set in config.php

4) see http://www.squirrelmail.org/wiki/en_US/AttachmentSize

OK, tested and confirmed. I only have to change two params in php.ini,
upping them from 8M to 15M to solve the problem.

max_execution_time = 30     ; Maximum execution time of each script, in seconds
memory_limit = 8M      ; Maximum amount of memory a script may consume (8MB)

; Maximum size of POST data that PHP will accept.
post_max_size = 8M



#########################################################################
040521 Friday

Out sick yesterday. Today Keith successfully uploaded 14MB of image
files; but oddly, some were over 4MB in size and they succeeded, while
the php.ini file still specifies 2MB. Hrmm. Keith has a 6mp digital
camera and said the files come out between 2 and 3 MB each.

OK, some thoughts on authentication with Gallery and why funny things
happen with logging in. Way back when, it turned out that we couldn't
log them into gallery in the right hand frame from evw. I think that's
because the session somehow can't be set that way... the topmost
window retains the evw url. But a new window has the url of the
gallery site. This might be some browser limitation.

I'm wondering if the SupportRedirctorServlet can't help us here or
teach a lesson. We don't want them to be able to update their password
from two locations; so for a start, the shortform.php should have the
password fields removed.

Next is the question of how to authenticate. We pass the admin
password and username via GET.  This is safe to do with the SRS
because we update the password via SOAP. With galler, doing it via
GET would be a serious security hole.

Can it be done solely through LDAP for the admin user? If they login
to their gallery direct, we could auth through ldap; the vps file
would just emulate this process. I'd have to pick apart the process
further.

A situation to avoid: any legal username/pw could be used to login as
admin to any gallery site. It has to auth to that specific
gallery. Perhaps the answer here is to query for evwzone first, and
get the org name.

OK, so I have done a proof of concept... I can intercept the username:
if it's 'admin' or matches $gallery->app->evwusername, we can query
LDAP. If we get a result back, the uname/gallerypassword are correct,
else not. Simple. This solves both password sync and username versus
admin issues. I can plop a chunk of code into the shortform and remove
the fields to set the password. I've updated dotproject.ldapsearch -h ldap-1.prv.ampira.com -p 400 -D "cn=Directory Manager" -w "Ld@p416." -b "o=FCTY" "(username=mgcreate)"




#########################################################################
040524 Monday

Sunil let go after the weekend. members.fortunecity.com was not
available because he botched config changes, again, and instead of
checking his work he simply called Chris Ferry to fix it.

We left incorrectly during the file drill.

Emailed Ops with a request to add me to cron.allow on the mail server,
and two requests to upgrade PHP and add a new ldap user for Gallery to
authenticate with LDAP.

I ran a test on cws-1 to make sure it can hit ldap-1.prv.ampira.com
and it can.

OK, after introducing some bugs (what else is new) I got all the stuff
working on the low level for Gallery. By that I mean, a hand
provisioned Gallery is successful. There is one odd bug where the user
uses the EVW username and the Gallery password and this succeeds
because we set the username to 'admin'. I also resurrected
user.local.php for this feature set, which previously was obsolete
(not called from anywhere). It's now a mechanism to avoid Gallery
stomping out variables we set/add to the main $gallery data structure.

I made a unique index on ACCOUNTS.accountid for Rob. I think I
originally went with a separate primary key, int, auto_increment
because of the daily update to the database, which tried to add
duplicates. Rob needs a duplicates-free table. Next up: Autopublisher
changes.




#########################################################################
040525 Tuesday

Busy day. Done lots. Got the provisioner scripts debugged, shortform
secured, vps file updated; all seems to work happy. Found bug on Pork
where default page is index.html and not index.htm. Filed bug report;
almost added custom stuff to makeGallery.pl but then decided that ops
should fix Pork.

Just remembered that there's the chdir bug in
galleryProvisioner.pl. Or is it the target dir?


#########################################################################
040526 Wednesday

Very productive day yesterday. GG whiteboarded an architecture for
handling free, no credit card purchases with the wizard with an eye to
the future. I need to start on that ASAP but first I need to test the
phase two items I just wrote on dvl, on the stg system.

First I want to test moving the primarey gallery directory, which
shouldn't affect user sites... unless... no, we didn't use symbolic
links.

I did a cvs update on the MPA project; I still had changes from the
time opensrs was out, over a week ago. I committed those changes for
posterity and rolled back to the previous versions; but there was a
minor bug where the call to dnaservice in the wizard was still
commented out, so I fixed and committed that. Now it's in a stable
state and I can roll out the autoprov scripts.

OK, the big holdup was Rah didn't have the Sun ldap package
installed. Ferry took care of it, compiled/installed PHP. Time to
test. I also dropped the index column on ACCOUNTS and made the
accountid the primary key. Solved a problem for Andreea.




#########################################################################
040527 Thursday

Twilight zone time. I was hacking and hacking at a weird bug that
showed up in the shortform: when I submitted it the confirm page
complained that "locale_alias" was unset.. but the value was in
shortform, it was in the confirm page in the HTML source.. the bug did
not exist in the code base on devil or the old code base on rah.

After editing and saving the shortform, making NO REAL changes, it
worked. I must have spent close to two hours trying different things
and the bug "just went away." wtf.

Meanwhile, I couldn't push my job through this morning; showed Trev
how to restart Apache/Resin/Evolutionware, and that unstuck the
job. But then it got stuck at the Send Mail task, where no doubt it
still is. Yup. Sent an email to Ops this morning asking for help, to
no effect. Waiting on GG for xsd files to generate beans for the
credit card fakeout; and I need to fix a bug in the data loading of
the MDB. What happened is the columns were reversed when I inserted
data into PACKAGE_HISTORY. Come to think of it, mayhap my query to
extract the data from the evw_* tables had them switched; also
inserting a Unix timestamp into a Mysql DATE field doesn't seem to
pass muster.




#########################################################################
040528 Friday

Swain,
	I've checked in basic special offers functionality to mpaw.
The process went something like this.

write a sample specialoffers.xml file
write an XML schema for it in specialoffer.xsd
modify build.xml to autogenerate from this schema
write SpecialOfferInventoryBean.java with a singleton pattern to load the xml file using autogen classes
(this was adapted from CwPackagesBean class)
write TestSpecialOffers.java to test everything

two things are left ( i left them deliberately for you to do :)
Add fake credit card to this scheme.
Allow multiple allowed wizards.

you should be able to take it from here and add the functionality we discussed.
Let's discuss after you've had a chance to browse the source.

--
Gautam


/opt/cvs/ampiradev/myphotoalbumwizard/build.xml
/opt/cvs/ampiradev/myphotoalbumwizard/lib/specialoffer.xsd
/opt/cvs/ampiradev/myphotoalbumwizard/lib/specialoffers.xml
/opt/cvs/ampiradev/myphotoalbumwizard/src/com/ampira/myphotoalbum/beans/SpecialOfferInventoryBean.java
/opt/cvs/ampiradev/myphotoalbumwizard/src/com/ampira/testbeds/TestSpecialOffers.java



More chaos as Ronny can't connect to db2 on staging; Trev cannot
access the fc wizard on devil (it was blown away); earlier the
marketing reports didn't happen and that's because evw-1.prv is
missing in action (being moved).

Thought: GG wrote an xsd file for generating beans for special
promotions. One future approach is we give people coming in from a
certain link, or through a special code, a free trial. Like an Amazon
gift certificate, in principle. This means another item passed along,
and the JSP file could test for it; if valid no credit card field is
presented.

---

Made progress on the zero dollar amount / token credit card number
front. I got the bean/xml stuff integrated with the mpa wizard. All I
have to do is some extra coding to test the incoming token, add the
bogus credit card number to the bean's xml file, etc.

Meanwhile I was asked by GG to test the frontend wizards as they just
moved... and lo, I found I could edit the totalAmount field quite
easily with Firefox's form editing tool; I set the amount to zero and
I was able to buy any package! I can't believe I never thought of this
before. This dates back to last year, a design flaw in the CartWizard
where the dollar amount is taken from the form data and submitted to
the credit card gateway. Tainted data.




#########################################################################
040601 Tuesday

Ops in a tizzy over move problems. cws servers are periodically
failing and there's plenty of tickets for email not working, sites not
available, Trellix and Frontpage not working...

I'm going to look for the job sun.myphotoalbum.com; Rob emailed that
it didn't provision, which is an interesting and unexpected outcome.

------------------------------------------------------------------------
Algorithm:

if I received something dropped on me:
   try to convert it unix to human
else if there's something in the clipboard:
   try to convert it unix to human
or provide this as a service

Accept either hex or decimal
------------------------------------------------------------------------

There are four jobs waiting in the queue on evw-1. One is the Friday
test I did; the other four are later, and I never received an email
for them. Makes it hard to provision them.

I found that PHP is not working for some newly provisioned sites. This
means their apache conf files are wrong. Older sites are still
working.

This is probably where the email failed on evw-1.prv for the sun.myphotoalbum.com:

May 28 16:46:56 evw-1.prv.ampira.com sendmail[17720]: [ID 801593 mail.info] i4SKksf17720: from=<workflow@ampi\
ra.com>, size=2310, class=0, nrcpts=1, msgid=<E1BToC2-0007Tr-LJ@ims-1.prv.ampira.com>, proto=SMTP, daemon=Dae\
mon0, relay=ims-1.prv.ampira.com [192.168.6.26]
May 28 16:47:00 evw-1.prv.ampira.com sendmail[17721]: [ID 801593 mail.info] i4SKksf17720: to="|/opt/evw/scrip\
ts/ampira/provisioners/gallery/sendToCWS.sh", ctladdr=gallery-prov (1/0), delay=00:00:05, xdelay=00:00:04, ma\
iler=prog, pri=61919, dsn=5.3.0, stat=unknown mailer error 255

---

So in addition to the gallery files being corrupted on transfer; and
there being no permission to send the file to cws-1; something goes
wrong when the email is sent to the provisioner's list:

bash-2.05a$ grep  73965 MailSpool.log
[Tue Jun  1 15:13:55 2004 |001|evwModule=MailSpool,o=FCTY                   |MailSpoolImpl::sendMailCommand][\
 4] Successfully added a message id [73965] to the mail que for [evwModule=Product,o=FCTY][WorkFlow Product][\
Gallery Install] Subject [Install Gallery] Job Id [1086117021.200800]
[Tue Jun  1 15:18:23 2004 |003|evwModule=MailSpool,o=FCTY                   |MailSpoolImpl::processQue     ][\
 1] Failed to send the mail for id [73965] because [SmtpException: 554 SMTP synchronization error
[Tue Jun  1 15:23:05 2004 |001|evwModule=MailSpool,o=FCTY                   |MailSpoolImpl::processQue     ][\
 1] The mail has been sent successfully for [73965].
[Tue Jun  1 15:23:33 2004 |001|evwModule=MailSpool,o=FCTY                   |MailSpoolImpl::sendMailCommand][\
 4] The mail has been sent successfully for [73965] wait for a reply


In a nutshell, the email enters the queue, cannot be sent, and is
marked as sent. Bleh. Also the script is not executed... or is it?

No record of the script being called... not in syslog anyway. Found
that I had to approve the domain name again for the list of known
hosts (?). I thought I saw Ferry do this.

Sent an email around after retesting operations.myphotobuddy.com. This
is the site I deployed on staging to test the ldap functionality. I
think it's ready to be rolled out.

---

MPA wizard changes regarding special offers: for specialoffers.xsd, I
changed the number of allowed wizards to "unbounded." Note this
returns a List:


	String sp1 = "98765"; // unknown offer
	FcSpecialOfferType offer1 = specialOffersBean_.lookupSpecialOffer(sp1);
	if (offer1 != null) {
	    stdout("special offer " + sp1 + " details");
	    stdout ("\t Name:" + offer1.getName());
	    stdout ("\t Token:" + offer1.getId());
	    stdout ("\t Start Date:" + offer1.getStartDate());
	    stdout ("\t End Date:" + offer1.getEndDate());
	    stdout ("\t Comment:" + offer1.getComment());
	    stdout ("\t Description:" + offer1.getDescription());
            List foo = offer1.getAllowedWizard();
            for (Iterator i = foo.iterator(); i.hasNext(); ) {
                String blippy = (String)i.next();
                stdout ("\t WizardsAllowed:" + blippy);
            }
	} // end of if ()




#########################################################################
040602 Wednesday

Conferred with Swolf on the status of autoprovisioning. He's waiting
for the ops guys to come in. I think I'm about done with the wizard
end of the special offers modification.

Was discussing UI changes needed for the promo code stuff. I pointed
out that for the domain path, we'd be charging. We decided we could
add the promo code to the package.xml file, and arbitrarily render the
CC field in the form.

I'm thinking now, since that discussion, that we would never give
anything away for free except subdomain packages. When would we ever
give away anything but subdomain packages? Perhaps if we offered
something to our existing customers... adding a product that doesn't
require a domain name.

I think the problem we set out to solve was that zero dollar values
were a problem but the gateway doesn't really care.

Well, the promo code added to the subdomain package allows us to skip
rendering the cc fields, at any rate.

Talked with Rob over UI issues:

* billing info will not be asked for. We will copy the street address
  data.
* No credit card info asked for... we will insert bogus values

Looks like all of summary_billing.jsp gets left out.

    // first, determine if this is some promotional offer.
     e = null;
basket = (SelectionsBean) session.getAttribute(SelectionsBean.SELECTIONS);
if (basket != null) {
    e = basket.getPackages();
}

while (e!=null && e.hasMoreElements()) {
    CwPackageType pkg = (CwPackageType) e.nextElement();
    if (pkg != null) {
        String promo_code = pkg.getPromotionalCode();
        if (promo_code != null && !"".equals(promo_code)) {
            java.lang.System.out.println( "PROMO CODE: " + pkg.getPromotionalCode() );
        } else { 
            java.lang.System.out.println("PROMO CODE: no promo code.");
        }
    }
}



I have the stuff working for the most part... I'm against the wall
with a crappy UI problem. The billing info contains SELECT boxes,
which we don't want anymore. In order to copy the street address into
the billing info, I need invisible select boxes, and there appears to
be no way to construct new select boxes, nor to clone existing ones.

<form>
<input type="text" value="hello sailor">
<select name="foo"></select>
<br>
<script>
document.forms[0].elements["foo"]["blippy"] = "hooha";

for (key in document.forms[0].elements["foo"]) {
   document.write("key: " + key);
   document.writeln(" | val: " + document.forms[0].elements["foo"][key] + "<br>");
}
</script>

</form>

There's a lot of stuff in the modern select object. No
visible/invisible property though.


#########################################################################
040603 Thursday

The plan: the special offer stuff is working; there's a javascript
problem I want to pass on to Eric. I have to look at Trevor's ldap
problem this morning.

Pork's /home was at 100%. Brought it down to about 79% by cleaning out
my stuff, and down to 62% by blowing away .gz files in Han's and
Snair's directories.

Spelunking for Trev: I had to break down the session info for the
admin user. I don't recall if I've done this before, so here's the
rundown. This is for admin of fc gold on staging, for user
'operations' (a myphotobuddy site/user):

--------------------------------------------------------------------------------
try:
    si = session.getSessionInfo()
    print si.dn + "<br>"
    #print si.ip                                                                          
    print si.password + "<br>"
    #print si.ispDn                                                                       
    #print si.type                                                                        
    print len(si.vars)
    print "<p>"
    for i in (si.vars):
        print i.key
        print " : "
        print i.value
        print "<br>"
        #print si.vars["key"]                                                             
        #print si.vars["value"]                                                           
except:
    print "Error accessing session info:<p>"
    errstuff = sys.exc_info()
    print "0: "
    print errstuff[0]
    print "<br>1: "
    print errstuff[1]
    print "<br>"
    traceback.print_exc()
    sys.exit(1)

This will yeild:

username=admin,ou=People,o=FC Gold,ou=Clients,o=DMFC
fmj984
16

loginDn : username=admin,ou=People,o=FC Gold,ou=Clients,o=DMFC
hasMessages : 0
pageDn :
organisationDn : o=operations,ou=Clients,o=FC Gold,ou=Clients,o=DMFC
installationBaseDn : o=DMFC
evwIspDn : o=FC Gold,ou=Clients,o=DMFC
currentTreeNodeId : 64
parentTreeNodeId : 6
secureDn : username=operations,ou=People,o=operations,ou=Clients,o=FC Gold,ou=Clients,o=DMFC
secureComponent :
secureDescription : operations operations
installedProductId : IP1081259454.187517
installedProductComponentId : 1080252233.687301
installedProductType : 1080252233.687292
installedProductComponentType : 1.3.6.1.4.1.3999.1.11.1.6.1.1
installedComponentId : 

--------------------------------------------------------------------------------

1. the correct email address is in the workflow. I emailed from the
   command line; both the mail list and the script rec'd it.
2. there is no #2

The issue after all was sendmail not running on evw-1.prv. I changed
the workflow email address to the human list, which works. I found
that there's an option to view the email through the gui, so it was
easy to hand provision the customers (there were three, I think). All
done. Test jobs were pushed though but not provisioned.




#########################################################################
040604 Friday

Wrapped up writing/testing the change for the vps files so admins can
login as the user automagically. Checked in, works on staging.

Long meeting on wizard architecture; but a great idea came out of it:
we can move all the code into one cvs project and build separate war
files by using separate build.xml files.

I loaded data for 4/15 though 4/28 for Rob, for the PACKAGE_HISTORY
table. Dunno how it got left out to begin with.

Helped Trevor and then Ferry with LDAP and then Python.


#########################################################################
040607 Monday

Pushed a job through for Gallery; turns out Ferry installed Perl 5.6.1
and WWW::Mechanize on Friday or so, but never told me. I don't
understand how anyone can misplace so much energy.

Finally got Trevor's code into the mpaw and tested. Checked everything
in. Javascript still needs fixing.

-rw-r--r--   1 www      www          2997 Jun  7 07:56 album.dat

-rw-r--r--   1 www      www          5293 Jun  7 05:57 album.dat
-rw-r--r--   1 www      www          5293 Jun  7 05:57 album.dat.bak
-rw-r--r--   1 www      www             0 Mar 22 17:32 album.dat.lock


./sa/sam/www.sample1.myphotobuddy.com/web/albums/Album1/album.dat
./sa/sam/www.sample1.myphotobuddy.com/web/albums/Album2/album.dat
./sa/sam/www.sample1.myphotobuddy.com/web/albums/children/album.dat
./sa/sam/www.sample2.myphotobuddy.com/web/albums/dinner/album.dat
./sa/sam/www.sample2.myphotobuddy.com/web/albums/slumber/album.dat
./sa/sam/www.sample2.myphotobuddy.com/web/albums/party/album.dat
./sa/sam/www.sample3.myphotobuddy.com/web/albums/jan/album.dat
./sa/sam/www.sample3.myphotobuddy.com/web/albums/gardens/album.dat
./sa/sam/www.sample3.myphotobuddy.com/web/albums/asain/album.dat
./se/sea/www.seancourtney.com/web/albums/album01/album.dat
./se/sea/www.seancourtney.com/web/albums/album02/album.dat
./se/sea/www.seancourtney.com/web/albums/album03/album.dat
./se/sea/www.seancourtney.com/web/albums/album04/album.dat
./se/sea/www.seancourtney.com/web/albums/album05/album.dat
./se/sea/www.seancourtney.com/web/albums/album06/album.dat
./sp/spa/www.space.myphotobuddy.com/web/albums/Earth/album.dat
./sp/spa/www.space.myphotobuddy.com/web/albums/planets/album.dat
./sp/spa/www.space.myphotobuddy.com/web/albums/Nebulas/album.dat
./st/ste/www.steve.myphotobuddy.com/web/albums/RidgeRideNJ/album.dat
./st/ste/www.steve.myphotobuddy.com/web/albums/British-Columbia/album.dat
./st/ste/www.steve.myphotobuddy.com/web/albums/IdahoSummer2001/album.dat
./st/ste/www.steve.myphotobuddy.com/web/albums/Colorado/album.dat
./su/sui/www.suicidenotesmusic.com/web/dysfunction/gallery/gallery/albums/album02/album.dat
./su/sui/www.suicidenotesmusic.com/web/dysfunction/gallery/gallery/albums/album03/album.dat
./su/sui/www.suicidenotesmusic.com/web/dysfunction/gallery/gallery/albums/album04/album.dat
./su/sui/www.suicidenotesmusic.com/web/dysfunction/gallery/gallery/albums/album05/album.dat
./su/sui/www.suicidenotesmusic.com/web/dysfunction/gallery/gallery/albums/archive/album.dat
./su/sui/www.suicidenotesmusic.com/web/dysfunction/gallery/gallery/albums/album06/album.dat
./su/sui/www.suicidenotesmusic.com/web/dysfunction/gallery/gallery/albums/dysfunctionbirthday/album.dat
./sw/swa/www.swain.myphotobuddy.com/web/albums/album01/album.dat
./sw/swa/www.swain.myphotobuddy.com/web/albums/pppipe/album.dat
./sw/swa/www.swain.myphotobuddy.com/web/albums/album03/album.dat



#########################################################################
040608 Tuesday

Answer to my SF ticket question: is there a way to ask EVW for the
full path to the user's web directory?:

Yep, there is:

webDomainBaseDirectory = webAgent.getFqdnRoot(sessionkey, webFqdn)

You will have to 'import evw.Apache' inside python and then resolve
the IOR from System and then narrow the webAgent via the orb. Lemme
know if you need more details for this.

Regards
Rainer

---

I spent time/effort solving the problem with user sites having the
wrong permissions on their lock files. I didn't find out what caused
it; it was easier to just fix the eight or so sites by chowning the
lock files to user 'www'.




#########################################################################
040610 Thursday

Tsk tsk, no entry for yesterday. I spent a lot of time getting
MPA/Gallery/Autoprov fully working on devil/pork, and now it's all in
place. I can *finally* do end to end development/testing on
devil/pork.

One last little bit would be to automagically add the ip/fqdn to
/etc/inet/hosts on pork, so autoprovsioning is instantaneous.

Flux Capacitor phase one issues. Items I marked "minor" are small
enough that we don't need an estimate.

1. MPA Login screen text changes: minor

2. Website login change: We can accomplish this by calling a script I
   wrote earlier, ampira.redirect.php; but this script does no error
   handling as of yet. Estimate about one day's worth of work. I wrote
   this script some time ago to handle logging the user into their
   Gallery from their Evolutionware control panel, but the script was
   guaranteed to always receive the correct username/password. We need
   to handle the case where the user mistypes their username or
   password. I was thinking about this in the shower this morning, and
   realized we can probably create a better version of Gallery's
   login.php that handles this... optionally, there may be a
   Javascript solution where we open the appropriate daughter
   window.

3. Welcome panel text change: minor

4. Setup page linked in toolbar, if the user is the admin: difficulty
   medium. Estimate about a day's work. Gallery uses a complicated set
   of PHP and javascript actions to render this.

5. Spelling change for setup : minor

6. Hide confirm page: Cannot remove it, but can make it less
   frightening. The idea Gautam and I have is to only show the
   "Finish" button if the error_count equals zero... for every error
   made, an error message appears, so we would render only the error
   messages. One example is to have mismatched passwords, or a missing
   gallery title. We propose displaying only the errors. Estimate
   about one day's work for this.

I reran the marketing script for Rob, but there was no data for the
date 5/27. This is probably due to the move.

GG and I couldn't get daemon to magically login from Vader to Rah as
user autoprov. We took all the right steps, vis. key generation and
all.




#########################################################################
040611 Friday

GG fixed the problem with ssh from Vader to Rah. Turns out the target
machine's user's home directory had to be set 755, where I set it 775.

Provisioned two Gallery sites this morning; tested autoprov on
cws-1.prv but it still fails, even with the 5.6.1 Ferry put up there;
sent a note that I would handle provisioning over the weekend, and
asking when the swing box would finally go down swinging.

My spam problem has been greatly ameliorated. Every morning, I put all
the emails Spamassassin missed into a folder called 'missed' and at
6pm every day a cron job runs the SA learning tool on this folder.

Endless battle with staging today to get autoprovisioning done. It's
working OK, but Apache keeps crashing.


#########################################################################
040614 Monday

Installed Gallery on cws-1 under the account Chris created,
www.fptest069.com. Pertinent info:

This has been installed on cws-1.ampira.com.
The test domain is www.fptest069.com 
DocumentRoot /mnt/mss-1/vol4/web//f/fp/fpt//www.fptest069.com/web

www.fptest069.com/test2.php

I did quite a bit of playing with Gallery and it looks good. I
created, moved, renamed albums as well as uploading 10 large images
and editing various fields. The search works really well; you can
indeed add keywords to the images.

I need to focus on an MPA rollout today.




#########################################################################
040615 Tuesday

After some spelunking I found the webDn:

webDn =
"evwService=Web,evwHostname=cws-1.dvl.ampira.com,evwNetwork=Control,ou=Infrastructure,o=FCDE"

This is on devil.

Well, wrote a longish email to Darren this morning explaining all I
did yesterday (ten hour day). Today I was distracted by helping Chris
debug customer problems with Gallery sites, and compiling the
fcsignupwizard for Eric. In the morning I had to fix the problem with
the vetting screen -- I did the zero dollar total yesterday and that
broke it. Didn't know that was an issue.

I finally got a stretch of time to work out the script that gets the
full pathname per fqdn, but I think I have a smallish problem with
querying the correct Apache agent. Each fqdn is hosted on a particular
web server, so the webDn is going to differ, I think.



#########################################################################
040616 Wednesday

Updated .project (funny I never noticed the name before). 30min
meeting for dev team, outlined all the things I've done last two days
and blocking issues. GG supportive.

Last night while waiting for the R train I quizzed Lysa on the webDn
issue: how do I find out which Apache agent knows about which fqdn?
She said there was a script for this called WhereIsMyDomain.py or
something. Sure enough, working late at home last night I found it but
couldn't get it to work for external reasons (I think it uses an
outdated method for authenticating). The funny thing is it just
instantiates all the Apache agents and asks them round-robin if they
have the install directory. So I need a quickie test bed to answer two
questions: does this approach work for me, and does it work on cws-1?

I got the script, findFqdnPath.py working with all cws agents. It only
runs on evw-1.prv, so alas. It works nicely though and Milch saved me
a ton of time. I need to merge the code into the script from
yesterday.

I'm transferring work to evw-1.prv.

Yay! Work is done on updating the existing sites. Time to make sure
they didn't break.

OK, the sites seem OK with the patches. I've updated .project again.

Updating future installs prior to rollout: if the directory has a .bak
file, skip it. Also it might be something that can be fixed by hand.

An outline of how the retroactive fix was done:

1) I generated a list of organisationdn/fqdn for all customers that
   have a "my photo" named package.

2) This list was input to the script listPhotoBuddies.py in my cvs
   project on evw-1.prv. This script output a tab delimited file of
   all fqdns, their full paths, and owner's EVW username.

3) This file was used as input on cws-1.prv for a small Perl script
   that made the changes. Each site got an updated user.local.php file
   that defines a variable \$gallery->app->evwusername =
   $evwusername;.

4) The script also backed up the original user.local.php file as
   user.local.php.bak.

Thought: I could add a bit of code to ldapauthenticate. If the login
name given is 'admin' we will automatically convert it to the
evwusername; but supposing that fails, we could then test to see if
the admin of FC Gold is trying to login; we would then query ldap for
admin/password, and if successful, auth the user.


#########################################################################
040617 Thursday

Query that, given only the username and password, returns the orgdn:

ldapsearch -h localhost -p 400 -D "cn=Directory Manager" -w "11223344" -b "o=FC Gold,ou=clients,o=fcde" "(&(objectclass=person)(username=autoprovagain)(evwcleartextpassword=autoprovagain))" evworgdn

username=autoprovagain,ou=People,o=autoprovagain,ou=Clients,o=FC Gold,ou=Clients,o=FCDE
evworgdn=o=autoprovagain,ou=Clients,o=FC Gold,ou=Clients,o=FCDE

Given the result of that, get the fqdn:

ldapsearch -h localhost -p 400 -D "cn=Directory Manager" -w "11223344" -b "o=autoprovagain,ou=Clients,o=FC Gold,ou=Clients,o=FCDE" "(objectclass=evwZone)" evwzone

evwzone=pork.myphotoalbum.com,ou=MIB,o=autoprovagain,ou=Clients,o=FC Gold,ou=Clients,o=FCDE
evwzone=pork.myphotoalbum.com


The problem with using a vps page is that we don't have a session. A
servlet is so much better for this job. So I think for now, a PHP
solution is easiest.


[evw-1 myphotoalbumwizard]$   export JAVA_HOME=/usr/jdk1_4_2
[evw-1 myphotoalbumwizard]$   export PATH=$JAVA_HOME/bin:$PATH




#########################################################################
040618 Friday

Making headway on Flux phase 1. Running test for Jessy: can we skip
the config page? Theory: it's all determined in paths.xml, and the
wizard only cares about getting a package id after that point. So far
looking good... waiting for it to provision.

Also made an important discovery yesterday: Emacs renames the file you
want to edit and opens a new copy. This is Very Bad when you are
editing a file that is hard linked. There is a variable to control
this, (setq backup-by-copying t).




#########################################################################
040621 Monday

I am remembering now that my efforts to test on staging an update of
Gallery via tarball to the main tree was sidetracked by Emacs' mving
the file to edit and creating a new copy... which was resolved, see
above. Busy weekend with autoprov failing due to Ferry not setting up
the symbolic links mss-1 to nfs-1. Two sites failed to provision
because of corrupted config.php files.

Today is the big day, the day to roll out Gallery. I'm working on
making sure the tarball is stable for release.

PHP segfaulting on Pork. Took me a while to diagnose this; I thought
it was something I had done. Turns out Apache is out of date on that
box. Ferry compiled on staging and rolled down to dev. Doh.

Double doh: cws-1 swing box was where I wrote the Perl script to visit
all Gallery sites. It was only a page long or so. Hrmm. Mebbe I'll
compile Emacs on cws-1.prv.

So I missed one piece. I tested upgrading Gallery on staging, and I
forgot I had to hardlink ldap.php from the customer sites. No
biggie. This is a shell script away. I have to recreate the script I
wrote last Wednesday though. Bummer. But I also need a new one, one
that parses all the emails I have and makes an input list: path,
username.




#########################################################################
040622 Tuesday

It's 4:12 and I'm fried. The rollout of Gallery took a little longer
than I expected; I had some faulty logic in my auth code where
ldapauthenticate was called twice, for one thing. Jessy later found
that mixed case usernames broke auth. This is because it's mixed case
in the job data gprov gets, but evw stores it lowercase. EVW then
passes the lowercase username to gallery, which does a case sensitive
comparison. Also killing me is $password in some files,
$gallerypassword in others. Right now there is duplicate code in
login.php, shortform.php and ampira.redirect.php that should be
abstracted.

I wrote a perl script to list all sites with albums, most recently
modified first.

Another oddity was rafaelmonico.myphotoalbum.com. Somehow this user
changed his password before gprov set the shortform. Weird.


#########################################################################
040625 Friday

Busy, busy, busy. Too busy to update my log.


#########################################################################
040628 Monday

Perhaps the problem is, we are testing the username, finding it
invalid, but this happens too late or we never check to see what the
result was? With a bad credit card number the error appears.


#########################################################################
040629 Tuesday

Two meetings this morning: 9am at McDonald's with Swolf, discussing
the tech staff as time moves forward; and a 10am for MPA where Peter
outlined the broad vision. The impetus seems to be keeping the new
signups in EVW so we can upsell.

i solved the bug but it exposed another one and it's this new bug
that's killing me well this turns out to be more deep seated than i
thought. sigh.  in short... a few weeks ago trevor moved the test that
checks for pending jobs in evw for a domain name. he moved it to the
end of the signup process.  but this introduced a bug that was not
caught: the form data was no longer being validated.  then eric comes
along and does some javascript changes for hiding the billing
field. worked fine.  well, worked fine because the wizard was already
broken!  yesterday suddenly all these people are signing up, with
usernames that have @ and _ and ! and you name it. so the jobs are
hanging on Create a new user i applied a quickie javascript fix to the
wizard. today i've been diagnosing the problem. it's a mess.





#########################################################################
040630 Wednesday

Since I arrived I've been answering emails, answering people, looking
at Gallery problems, and filling out a new index card system I read
about on c2.com. It's already 12:15. I need to flush four jobs out of
gprov, which cannot fill out their shortform.php.

Well, the config.php files are corrupted. I wonder how that
happens. First galleryProvisioner.pl opens the config.template file,
reads it in, then interpolates the info and writes it out as
config.php. There must be some veracity test I can do at that
point. Question: does the formfiller screw it up? Nope. From the first
time it requests the shortform it gets garbage. One difference in how
things are done is the config.php is written from inside a block where
$/ gets undef'd. But that wouldn't seem to explain an intermittent
failure... but removing it might get around whatever is causing this.

I need to put in a test to see if the file was written
successfully. One cheap solution is to reopen it, loop over the
contents and look for bad chars.


#########################################################################
040701 Thursday

More meetings. Finally got Flux phase 2 in to .project; set up Jessy
with www.blippynews.com so she can add advertising stuff; and I'm
working on the buy wizard problem. Gautam had a good suggestion that a
separate script handles the process of setting the email, username and
password.

Key:
InstallOrganisationDn

String Value:
o=bwizard,ou=Clients,o=FC Gold,ou=Clients,o=DMFC

This looks like the key to use. Algorithm:

query for evwtrustlist on InstallOrganisationDn
break out userdn
query for objectclass=person on userdn, get email, username, password
interpolate that into the file
return file to the needfiles folder





#########################################################################
040702 Friday

11am covered ClearCommerce, with a mini-finale on the Emacs
JDEE. Lunched at Stage Deli. Peter requested disk usage
numbers. Meanwhile, discussed again the buy wizard issue and Trevor is
going to get his hands dirty with it. It's probably going to be
easiest to have the email receiver catch this, and place the file in
the right folder.

230pm mini architecture review for this; 3pm with GG and Swolf for
planning remaining knowledge transfers; and 4pm will cover code
generation for the autogen beans.




#########################################################################
040706 Tuesday

181 galleries installed over the weekend. One gprov failure, on the
4th.

The file listPhotoBuddies.py is what builds the input file for
applyGalleryChanges.pl. I am having a panic attack, I think... it's
hard to concentrate and my shoulder and neck are stiff.




#########################################################################
040709 Friday

I've updated my notecards in an attempt to hold mgmt at bay, so to
speak. Rob was out today though so I can't have my stuff
prioritized. I should read up on the process though.

The week has been dominated by 11am and 4pm meetings with Gautam,
covering EFTNet, ClearCommerce, V3, and more. In between the meetings
I try to get odd jobs done, most of them MPA maintainence. I installed
sites for Jessy, for example. I also updated Bugzilla, closing some
old tickets and updating others.




#########################################################################
040712 Monday

Helped Trevor solve a problem where a vps file couldn't read a conf
file on evw-1.prv (nebula). Read Tim's email finally on fc bozo
filtering... Swolf set an 11:30am meeting for MPA and we will set
priorities.




#########################################################################
040713 Tuesday

Made the 10am meeting. Kurt's projections show good and bad; but Swolf
pointed out it was only a model based on wild assumptions. One
projection is that the bandwidth cost will kill us. Throttling won't
help because there are so many sites and in the aggregate the
consumption is great.

Trying to figure out a way for Jessy to call the execAdminOptions
function in a new way. Also been working on a new tree structure so we
can just use one symlink for Gallery instead of two hundred
hardlinks. I can't get enough continuous time to figure it out
completely. Jessy dicked me around yesterday and broke my
concentration.

Wrote a Perl script to parse the Apache logs and calculate the
bandwidth usage. This revealed (to me anyhow) a porn site of women
with really big breats; that site used over 2GB yesterday. That and
the anime porn site were deleted by Rob, as well as a site of some
naked fat guy. I need to cron the script on all front end servers.

Meanwhile, I changed permissions for Jessy on the Naked Cowboy
site. On a side note someone was uploading gay porn to his site last
night and Darren had the procedure changed to "you email us your
photo."




#########################################################################
040714 Wednesday

Regenerated the stats; moved all stats stuff into ~swain/stats, and
the web pages generated now all fall under the doc root of each
server. Logged a bug from fruzelina.myphotoalbum.com which causes a
huge line to show up in the html output... this line must somehow
appear in the Apache log.

Solved all of Rob's marketing database woes. For June 2nd, there were
duplicate rows. I truncated the cron log on June 4th,
unfortunately. So I dropped those rows, regenerated on Nebula for 6/2
and reloaded. For the problem of missing data from his queries, the
cause was the delaying of jobs in EVW and we saw a spike the following
days.




#########################################################################
040716 Friday

Came in, evw-1.dev not working again. /d0 filled up again just like
yesterday. Spent a good amount of my time cleaning out crap. I
accidentally deleted my home directory. No biggie.

I was on the verge of fixing the Clear Commerce problem. Swolf had me
trace a problem yesterday with the ip address not being passed in;
there was no way it ever worked. Unbelievable. Today I was so close to
fixing this problem ... I had a class casting error, but I had to test
on staging but Rob and Christina were trying to test the new FC
packages. Extremely frustrating. Hulk smash puny company.

You say, "yay. staging failed again."
tiResias . o O ( stagging failed again )
tiResias goes shopping
You say, "and the development web server isn't coming back. sysadmin tried 
rebooting it and it won't come up at all."
You say, "and it was not getting regularly scheduled backups."
You say, "and my boss did a bunch of development on it and probably checked 
nothing into cvs."
draco [to Wainstead \]: bitchin'.
heller [to Wainstead \]: backups are overrated and cvs is irrelevant. you must 
go and drink. 

Set up Darren with an intranet account. I found I goofed on the MPA
stats cron job on borgcube and spent time regenerating three day's
worth of results by hand. There were duplicate keys, which requires
investigation. I prefixed the files with the date name in my home dir
on borgcube.

Pork is dead, but luckily GG put his slideshow stuff in CVS.




#########################################################################
040720 Tuesday

For calculating disk usage, the start of the problem is that I can't
easily obtain a list of all currently installed MPA packages. The data
lies in the marketing database but that is not real time and is
blocked by the firewall.

Oops, didn't change my crontab. Fixed.

I note here also that I feel funny today, like lightheaded at times;
and a weird pain has been bugging me near the top of my head on the
left side. It kind of feels like it's on the surface of the skull and
it's been bothering me since last night. It's an area about the size
of my fingertip if I press down. Rubbing it doesn't seem to make a
difference though. I've had these before, but coupled with feeling
weird -- a little shaky even -- it's something to note somewhere. I've
had these weird little pains before.


<avalon>
[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
This lots to effect alot of events but not all.

------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
You say, "i see lines like this so often from our biz dev guy i hardly notice 
them anymore"
DrDaByGoD [to Wainstead \]: BRAIN EXPLOSION
the Optimized hybrid knowledge user heller [to Wainstead \]: wow. . .
chilly_willy [to Wainstead \]: people at your place are on crack
DrDaByGoD [to Wainstead \]: reply: "English to learn in words assist to me".
chilly_willy [to Wainstead \]: i prefer the response of "Big large birds 
swopping down on head makes sleep needed."
</avalon>

I have traced back the duplicate entries for the package_history
table, and they appear to be correct. I ran both
packageActivityReport.py and makeMktReport.py; they each generate a
report file. For July 16th, they differ by two lines. That is because
the latter Python script drops two lines because there is no org
information:

now hitting ldap for the org data...
Removing the org o=bruce goldhagen,ou=clients,o=fcty from the report as no LDAP details exist
oops, failed to get the trustlist
ldap.NO_SUCH_OBJECT {'desc': 'No such object', 'matched': 'ou=people,o=klikotuni,ou=clients,o=fcty'}
Removing the org o=klikotuni,ou=clients,o=fcty from the report as no LDAP details exist
Removing the org o=lonestar leads report,ou=clients,o=fc gold,ou=clients,o=fcty from the report as no LDAP de\
tails exist
oops, failed to get the trustlist
ldap.NO_SUCH_OBJECT {'desc': 'No such object', 'matched': 'ou=people,o=mr william gemmell,ou=clients,o=fcty'}
Removing the org o=mr william gemmell,ou=clients,o=fcty from the report as no LDAP details exist

For every line in the report there is a corresponding line for the
ACCOUNTS table and the PACKAGE_HISTORY table.

OK, problem found. The same goddam data was loaded two days in a
row. So there has to be a way to prevent this.. and there
is... generate unique filenames.




#########################################################################
040721 Wednesday

12:35. No useful work done. Meetings and a constant stream of people
looking for help.

1:25 back from lunch.

Solved the dumb problem with msaccess logging into mysql on
borgcube. Flush privileges. Teh duh.




#########################################################################
040722 Thursday

Test for an extra variable ala "pathname".


#########################################################################
040723 Friday

What a week. Yesterday helped Trevor figure out the problems with
ClearCommerce. This was the same bug I solved months ago. I finally
had him insert print statements for three points: where CC is called,
where he sets the string, and where the productConfig array gets
set. Sure as day, they occured in the wrong order.

I had a late inspiration, sitting here at 7:30 or so: pathname and
pagename made it into the product config data in the job, so it must
be possible to pass the CC string this way. I proved it this morning
and Trevor now has it working. Problem is, staging is super slow.

There are 44 active and 392 hung jobs on staging.

PHP was broken by Chris Ferry on staging. The ldap library isn't being
found, for some reason, in PHP. Pork failed a week ago with no backup,
so the dev environment is gone for a long time. Staging is not being
backed up, according to Chris. I asked him yesterday over lunch and he
said backups for staging would be in place by the "end of the week." I
didn't feel like pointing out to him it was Thursday.

Stats for MPA are mostly in shape, but I have to finish the detail
work on the database and on loading stuff. Ronny rebuilt the whole
thing from scratch, following my path as laid out in Twiki, and found
some bugs I missed. I think the marketing database is in much better
shape now. Kurt and Christina are now using it in addition to Rob,
Andreea and Darren, and Kurt is going to use Crystal Reports on it so
some nice things should happen.

Found that eftnet gateway has uncommitted changes. It queries Clear
Commerce in production. Copied (cp -a) the fcsignupwizard tree in
webapps on app-2 to my home dir, fcwiz.bak.

Thus ends one hell of a week.


#########################################################################
040726 Monday

Realized over the weekend that the regen script that builds a new
config.php didn't explicitly chown it to www. Fixed. Working on a
caching mechanism for the disk usage. I really want to wrap up this
phase of the stats project.

Ronny solved a duplicate key problem with the package history
table. He changed one column from DATE to DATETIME, fixing the input
script so it can generate the right string (year month date hours
minutes seconds), and changing the table so fqdn and datetime are the
primary key.

Trevor is backed up doing hand provisioning of ecommerce sites. I
asked him if he has any time at all to look into compiling eftnet. GG
has uncommitted changes in his copy of the repository.




#########################################################################
040728 Wednesday

Ronny moving in today... yesterday I added the "pending" feature to
gprov. Ronny's ready to cut over to the new marketing database.

Went through all my notes, made a new todo list and some new
cards. Updated Bugzilla. dotproject is languishing.

spt-1.dvl is dead. SCSI drive failed. No backup.

Back to the hardlinking issue. It's not scalable and is killing us:
provisioning has to do hundreds of calls to ln per customer
provisioned, and when Jessy wants to add a new file, all old sites
must be retroactively fixed. This is not equitable.

When I move all but the most local of files into gallery/, which is a
symlink to some far away directory where all the PHP files live, the
fundamental problem is you can't "go backwards." When a PHP file
refers to something that's ../, it can't be found. Symlinks work one
way.

I think at this point the need is to change all paths everywhere to
refer to gallery/ in the code, and move any file that refers to
something local (config.php, user.local.php, albums, etc) to the local
level. This is nonoptimal because files like login.php then live in
the user's directory. That sucks.

All calls to setup and login have to call local files that are only
program code to determine what to include and nothing more. All
relative paths in the code base will have to reference things under
gallery/, that is a call to css/logo.gif has to be rewritten as
gallery/css/logo.gif.

<?php
/*                                                                                                              
 * This is just program logic to include the Gallery login page. SW.                                            
 *                                                                                                              
 * $Id: LOG.txt,v 1.1 2007/11/27 22:54:23 swain Exp $                                                         
 */
?>
<?php
// Hack prevention.                                                                                             
if (!empty($HTTP_GET_VARS["GALLERY_BASEDIR"]) ||
        !empty($HTTP_POST_VARS["GALLERY_BASEDIR"]) ||
        !empty($HTTP_COOKIE_VARS["GALLERY_BASEDIR"])) {
    print _("Security violation") ."\n";
    exit;
}
?>
<?php if (!isset($GALLERY_BASEDIR)) {
    $GALLERY_BASEDIR = './gallery/';
    $GALLERY_USER_DIR = './';
}
require($GALLERY_BASEDIR . 'login.php');
?>

This is a sample of mpalogin.php, which only sets the base dir and
user dir and then loads the desired file. A chdir might also be
desirable but who knows. For setup, the process will be much more
involved.http://www.php.net/manual/en/function.virtual.php




#########################################################################
040729 Thursday

In early today; couldn't sleep.

Bashed my head all day against the symlink problem; the last few hours
I thought I had broken the gallery build on staging, but the problem
appears to be Ferry's caching mechanism.

Detailed explanation:

[Thu Jul 29 13:25:55 2004] [error] PHP Fatal error:  Cannot redeclare class abstract_user in /export/home/evw/v\
ar/webs/virtual/t/te/ter/www.terms.myphotoalbum.com/web/classes/User.php on line 0
[Thu Jul 29 13:37:07 2004] [error] PHP Fatal error:  Cannot redeclare class abstract_user in /export/home/evw/v\
ar/webs/virtual/h/he/hel/www.helphelp.myphotoalbum.com/web/classes/User.php on line 0
[Thu Jul 29 13:37:10 2004] [error] PHP Fatal error:  Cannot redeclare class abstract_user in /export/home/evw/v\
ar/webs/virtual/h/he/hel/www.helphelp.myphotoalbum.com/web/classes/User.php on line 0
[Thu Jul 29 13:37:12 2004] [error] PHP Fatal error:  Cannot redeclare class abstract_user in /export/home/evw/v\
ar/webs/virtual/h/he/hel/www.helphelp.myphotoalbum.com/web/classes/User.php on line 0
[Thu Jul 29 13:37:15 2004] [error] PHP Fatal error:  Cannot redeclare class abstract_user in /export/home/evw/v\
ar/webs/virtual/h/he/hel/www.helphelp.myphotoalbum.com/web/classes/User.php on line 0
[Thu Jul 29 13:37:18 2004] [error] PHP Fatal error:  Cannot redeclare class abstract_user in /export/home/evw/v\
ar/webs/virtual/h/he/hel/www.helphelp.myphotoalbum.com/web/classes/User.php on line 0
[Thu Jul 29 13:37:20 2004] [error] PHP Fatal error:  Cannot redeclare class abstract_user in /export/home/evw/v\
ar/webs/virtual/h/he/hel/www.helphelp.myphotoalbum.com/web/classes/User.php on line 0
[Thu Jul 29 13:38:06 2004] [error] PHP Fatal error:  Call to a member function on a non-object in /export/home/\
evw/var/webs/virtual/w/wh/wha/www.whathappened.myphotoalbum.com/web/login.php on line 77
[Thu Jul 29 13:40:04 2004] [error] PHP Fatal error:  Cannot redeclare class abstract_user in /export/home/evw/v\
ar/webs/virtual/h/he/hel/www.helphelp.myphotoalbum.com/web/classes/User.php on line 0
[Thu Jul 29 13:40:07 2004] [error] PHP Fatal error:  Cannot redeclare class abstract_user in /export/home/evw/v\
ar/webs/virtual/h/he/hel/www.helphelp.myphotoalbum.com/web/classes/User.php on line 0


This comes from apache's error_log. This error is generated when
galleryFormfiller tries to save the config changes. We saw this error
on production as well. It went away when we turned off Ferry's PHP
optimizer on staging.




#########################################################################
040802 Monday

Did a lot of MPA testing Friday. Did a lot on Friday but can't
remember what anymore. We had a brief tech staff meeting, which turned
out to be a little useful. I kept it short.

I am supposed to work on an interface for MPA to the fxFoto tool this
week. This will mean an XML interface for Gallery.

Meanwhile Christina wants Trevor to add ClearCommerce to Uglyboy. That
might be quite a trick; the code would have to go into the jsp files,
perhaps, and set the results in hidden variables.

Had a meeting via conference call from Steve up in New
Hampshire. Looks like they are ready to go.

Notes:

release 2.something. will do all the things we discussed. pre-release.

1) login script post uname password, return text error, list folders, session number allow to add new name (folder)

as well.

could pass back login/password again for upload

2) separate post for each file (gets around windows problem)

multipart form data, name/filename. steve 603 890 9200 x202

foreach post return error tag, if blank continue

third url for browser to go to, mebbe log them in

plain text file contains config info. encrypted.

they need an NDA signed. for giving away the little utility. 




#########################################################################
040804 Wednesday

Whew. Time is flying. Today I've been playing with the latest Gallery
Remote, and it indeed does support nested folders.

This is all done via the Gallery Remote Protocol, a home rolled
protocol understood by the java app Gallery Remote and the php file
gallery_remote2.php.

Insanity! I spent some time trying to login to Gallery using the
Galler Remote protocol, not remembering I had to use 'admin' since it
uses the Gallery auth system. Duh.




#########################################################################
040805 Thursday

Yay. Got the one-file post form working with any user-supplied album
name. Sadly this adds new files to the project and thus requires a
massive backlinking effort once again.

Tweaked the mpa disk usage stats script. It will include sites with no
disk usage now, so Rob can better delete sites that are inactive. It
was hard to test because the machine ramped up to a 89:


bash-2.04# uptime
5:44pm  up 14 days,  3:21,  2 users,  load average: 89.93, 58.50, 29.34




#########################################################################
040806 Friday

Emailed Steve at Triscape. API done. Needs finessing. Spent the day
hacking at gprov to get it working on mpa-1. Done, pretty much. Have
to rig the stats crap to d/l it now.


#########################################################################
040809 Monday

939am meeting. Took minutes. Am looking for Perl script for Ronny for
CORBA interfacing. Meanwhile, I have to answer Steve at Triscape on
the interface issue. That will require some comparison of the API he
proposed and what Gallery is looking for.

Couldn't find the Perl script Ronny wanted. Oh well. I wish I'd
written it down.

Moved the stats scripts out of my home directory, and into the
/opt/marketing directory Ronny set up. It's a good layout he came up
with.

Cleared the autoprovisioning queue. About nine or ten jobs hung
between 4am and 9am on August 8th.

Finished mpa stats work, wrote a Twiki page. Also spent the last hour
hacking up an hourly bandwidth monitor, now cron'd to run every 15
minutes on mpa-1. Sent email around.


#########################################################################
040810 Tuesday

I have made a test site, tocacheathief.mpa.com. I've created hardlinks
for all top level files, and symlinks for all top level directories.

The first problem was the setup didn't work. I rm web/setup and cp -a
gallery/setup web/setup. That seemed to solve that.




#########################################################################
040812 Thursday

Yesterday I did a lot of intensive work on the rollout of
Gallery. Jessy had some last minute changes, then things needed
fixing, then rolled out again... then I had to wait.. then it turned
out I needed to update all existing sites ASAP, and in turn found that
updating them takes a super long time; and there were numerous rmtree
errors from Find::Path. But it happens that running the script again
resolves errors from the prior run; perhaps mpa-1 is too fast.

Meanwhile, Steve Simonoff from Triscape sent a link to a test version
of fxfoto. It only worked with cachingup.myphotoalbum.com, and when I
asked how to change the URL he complained that feature was not
requested nor in Darren's visio. So we have a conference call later
today, or we should anyway, to resolve this. The short of it is they
will have to add it.

Had a design meeting with Trevor and Ronny for the job queue caching
servlet. It's quite clear that a flat file limits us; Trevor realized
that this servlet could be the key to speeding up the Clear Commerce
results pages. This is a huge win. The meeting was great and we really
fleshed things out.

I moved updating of existing Gallery sites from cws-1, where overnight
it had only made it into the low Cs, to mpa-1. It's on 'copic' right
now. This thing will take all weekend.

Just did an experiment: move all the PHP files under ./classes into
the include path. Fails. Class files are loaded this way:
"./classes/User.php" and this will never work. Perhaps rewrite rules
will work. This is, really, just a matter of whether symlinks are a
performance degrader or not.

Peter figures we can increase the number of active users versus
signups if we can speed up provisioning. Wrote him back at length,
explaining the limitations. This road leads to outside registration.

Spent some time trying to come up with a patch file, generated from
the initial commit of Gallery 1.4.2 against the current HEAD. Got a
file, but couldn't see how to use 'patch' to apply it thus far.




#########################################################################
040817 Tuesday

Bleh. No log entry yesterday? Ferry rolled out mpa-2 without telling
me, so the bandwidth usage stats were borked for 8/13 to 8/15
inclusive. Spent yesterday fixing this, then renaming files and
commiting to CVS to make the mpa stats more understandable.

MPA meeting today. Apparently TriScape is rethinking their photo
management tool because few people are upgrading. That's all in flux
now. I wrote out some new requirements coming down the pike.

I looked at awstats for hourly stats reporting, but sadly the project
has no installer (though the online docs show its usage). Weird. Lots
of complaints in the forums on how hard it was to install/configure.

I've been researching how to do bozo filtering today. One immediate
need is a relational database on production. I wrote up some
requirements for Chris Ferry to ponder. Another is a way to generate
image files for the password. This could be done as a Perl CGI, I
suppose; FC Free already has this. I looked at doing it in Java and it
would be a piece of cake if we had Java 1.4. We are trapped in 1.3.

Darren also came to me with a problem with his Gallery; one of the
album.dat files was ruined at 1:00am August 16th, and so was its
backup file. They are identical: a partial JPG image.

Reviewed Tim's paper again. All sounds doable. The key is a production
database.




#########################################################################
040818 Wednesday

Eric resigned yesterday; wrote a reply to Peter about what we need to
replace him.

I installed/tested phpLDAPadmin this morning on staging. It works
great. I found Chris disabled PHP for the web server's root
directory. I emailed him stating this was needed as a business rule
because myphotoalbumlogin.php lives there for all front end servers
now.

Oh wait, no it doesn't. Duh. It lives under myphotoalbum.com. Doh! I
thought some active file lived there.

Test: accessing DB2 from app-1 via Java. No DB2 driver installed
(probably db2java.jar, in /opt/evw/java on devil). So storing the
email ID on the app server is nontrivial.

Wrote a standalone test for emailing from java. Works on devil. Am
working on clearing jobs on devil. Zlatin has set up pork, but it
needs to be configured. I requested a package sync to help clear out
hanging jobs.

Cleared about 300 jobs from devil. Emailed Ops.

Tomorrow I'll rejigger gprov to do the work in proper sequence. That
is, I'll undo the hack to get around domain transfers.

I think I have enough preliminary work done to estimate how long bozo
filtering will work. I have to make the argument against using
Evolutionware's emailing system, because it cannot receive emails and
act on them, only send them.


#########################################################################
040819 Thursday

Revised the gprov sequence; I rolled back the change we made to
accomodate domain transfers. But staging is almost unusable.

So I spent considerable time -- it's now 3:35 -- trying to clear the
job queue on staging. I managed to move 30 jobs out of over 700. I
spent time trying to figure out why, but eventually we find in the
Product Module log:

[Thu Aug 19 15:31:20 2004 |000|evwModule=Product,o=FCDE                     |getInstalledProduct           ][15] Getting installed product with Id (IP1074554061.154451)
[Thu Aug 19 15:31:20 2004 |000|evwModule=Product,o=FCDE                     |getInstalledProduct           ][15] Found installed product dn (evwInstalledProduct=IP1074554061.154451,o=testtesttesting,ou=Clients,o=FC Gold,ou=Clients,o=FCDE)
[Thu Aug 19 15:31:20 2004 |000|evwModule=Product,o=FCDE                     |getInstalledProduct           ][15] Before checking access to installed product (IP1074554061.154451)
[Thu Aug 19 15:31:20 2004 |000|evwModule=Product,o=FCDE                     |getInstalledProduct           ][15] Access granted to installed product (IP1074554061.154451)
[Thu Aug 19 15:31:20 2004 |000|evwModule=Product,o=FCDE                     |getInstalledProduct           ][15] Returning installed product (IP1074554061.154451)
[Thu Aug 19 15:31:20 2004 |002|evwModule=Product,o=FCDE
|processJob                    ][ 4] Unable to call getCost(...) on
product extension (1.3.6.1.4.1.3999.1.7.6.6) with name (Personal - FTP
- Yearly) to retrieve setup cost

So that was all for naught.... ah, just looked at some other logs. In
Products.log:

[Thu Aug 19 15:37:30 2004 |003|Web Traffic Product                          |getTrafficUsed                ][36] Could not retrieve the web traffic used by the installed product with id (IP1074554061.154451) for the domain (www.testtesttesting.info) on port (0) between timestamps (1090260966) and (1092957036) since the web server with dn (evwService=Web,evwHostname=cws-1.dvl.ampira.com,evwNetwork=Control,ou=Infrastructure,o=FCDE) could not be contacted.
[Thu Aug 19 15:37:30 2004 |003|Web Traffic Product                          |getCost                       ][36] Could not retrieve the traffic used by the Web Traffic Product with installed product id (IP1074554061.154451) and domain (www.testtesttesting.info) since an error occurred. Please consult the logs prior to this and the Product Module logs for more information.

Can't reach Pork. No surprise. Maybe staging will clear some of the
jobs itself overnight if they all got their retry count reset to
zero. (They should have).

The network is horrendously slow today.

We did a code review for Ronny's job caching servlet. It went well. I
think we caught a few items that needed addressing. Overall his code
was great.




#########################################################################
040823 Monday

Swolf out still on vacation. I wrote a bash script that makes daily
dumps of the marketing database and copies the latest dump over to
int-1 (10.1.1.50) into /opt/borgcube. Currently the dump is 12MB.

Rolled out all scripts, both gprov and stats, to pork and made sure
they all ran. Filed a bug report. EVW won't run at all on pork, sent
an email to ops.

Been doing more battle with Pork. I've recreated
pork.myphotoalbum.com. I blew away most of the virtual host confs.




#########################################################################
040824 Tuesday

Swolf back. Sent email on Ronny's doings. MPA meeting. Told them
fxfoto is ready to roll, as far as I know; but I heard Triscape was
rethinking their giveaway strategy.

Devil was rolled back to April 2003. I asked Zlatin to configure
eftnet on it. He's fixing config issues with Pork as well.

Spent time diagnosing the problem with missing images. No surprise,
it's corrupted files.

Also recompiled Emacs on evw-1.prv, and found the problem was a bug in
swainlib.el all along.

I flushed all the jobs waiting in Awaiting Reply; some were from
Saturday. Updated the bug I filed about jobs being left in
"needunstuck."

Making a tags table for Gallery on pork:
 /usr/local/bin/etags --language-force=php `find . \( -name \*.php -o -name \*.inc \) -print`

Generated documentation for Gallery via doxygen. Unfortunately they
have few comments. But I can browse the members easily.




#########################################################################
040825 Wednesday

Came in, Swolf set an 11:30am meeting with dev to discuss moving
registration out of EVW. Peter mandated it. We sketched out some
scenarios; Swolf's idea is to pass this off to Tim. Trevor had a good
idea where we mod the mpa wizard to send the email; I had the idea
that we create a minimal account in evw for the user.

I rolled out the Gallery with the credit to the Gallery project
stripped out. I also put in a fix for testing the site after the form
is filled; I must have hand fixed 25 sites this morning that made it
into the 'done' folder but the config.php was corrupted.




#########################################################################
040826 Thursday

Hi Tim,

I thought I'd start with a description of the genesis of the
MyPhotoAlbum project.

Back in February Rob Walker decided he wanted to offer two products to
our FC Gold customers: a photo gallery and better web based
email. Gautam picked Gallery and Squirrelmail.

Adding these products to Evolutionware was somewhat ambitious, since
we had no idea how to do that. I looked at how existing products are
added by EVW; for a user's web directory they have a "skel' directory
which contains certain binaries for them to use. These are hardlinked
to.

I chose this strategy. It seemed reasonable because Rob didn't expect
to sell more than a thousand a year.

I wrote a Perl script that would build the directory structure,
generate the config.php file (the main configuration for a Gallery
installation), and generate a very long shell script to do all the
hardlinking. This worked fine. At first provisioning was to be done by
the Ops team, by hand, per customer.

Up to this point the project had the name "Fotomojo" or "Photomojo,"
but at some point Rob and Peter decided they wanted to launch a new
product line, MyPhotoBuddy.com. This would appear to be a new company
selling Gallery.

I had to clone the signup wizard we wrote for FC Gold, Jessy rebranded
it, and back in March we launched MyPhotoBuddy. The traffic was small
at first because we weren't linking to it much, and noone else was,
and we didn't register with Google, etc. etc.

Rob kept experimenting with the idea of "First 30 Days Free," first
year free, etc. It was then decided we would move to a totally free
product and ways to upsell to the users would be figured out
later. The name was changed to MyPhotoAlbum.

So in a few short months what was to be a small add on product for FC
Gold, of which no more than a thousand a year were sold, it became a
new property with aspirations to be a web application, the same way
eBay, Amazon, Yahoo!, et al are web applications and a goal of 100,000
active users before the end of the year (now upped to a target of
150,000).

A couple of days ago Evolutionware started to grind to a halt under
the load of 200+ users signing up per day. On a technical level the
reason why this is, is because of the domain management agent they
wrote stores all the myphotoalbum.com subdomains in LDAP in one node,
and it would read out all the subdomains, add the new one, reindex,
and reinsert it. After the 7,000 mark it just couldn't keep up using
this inefficient algorithm.

This is where you come in. Enter stage left.

Currently we use two web hosts, both Sun boxen, called mpa-1 and
mpa-2. Chris set up Apache mass hosting, and is currently using a
wildcard in dns, *.myphotoalbum.com.

Under the current system, Evolutionware sends an email to mpa-1. This
is piped to a Perl script and from there it's in the "Gallery
autoprovisioning" system I wrote which is 100% pure Perl. When a site
has gone through the provisioning steps, the last step is to call a
CGI on the Evolutionware box to tell EVW the site has been set up. I
will forward an example email after I finish writing this. (I made the
email message both human and machine readable, so either entity could
provision the site).

The way sites are provisioned happens in two steps. First
Evolutionware picks a place to put the directory. This follows an easy
pattern to remember:

/path/to/nfs/volume/webs/t/ti/tim/www.timlloyd.myphotoalbum.com/web/

using t/ti/tim parsed out of the domain name. Why they then add www to
the domain name is a mystery but one I can live with.

This path is included in the email sent to the Gallery
autoprovisioning system. The key data points for "gprov" are:

path to site username password email address domain name
(somesubdomain.myphotoalbum.com) machine it was provisioned to (but
currently that's always mpa-1) mail id (an Evolutionware ID used to
update the job in Evolutionware)

If you can provide this data in an email, we should have little
problem transitioning from EVW signups to Tim Lloyd signups. The data
comes through at the bottom of the email in the format:

Key:: value

where key and value are separated by two colons and a space.

A week ago I did a massive revision of how we do the provisioning of a
customer's Gallery site. There were almost 700 hardlinks from the
customer site to the "main tree" of Gallery. First the whole Gallery
directory structure was created under the customer site (with mkdir
-p) and then all the files were hardlinked with ln.

This was slow and made it severely difficult to add new files to
existing sites. For reasons I won't go into, symlinking introduced a
whole new set of worse, harder to solve problems; so I found a simple
middle ground that's working really well so far:

* all files on the top level are hardlinks all directories on the top
* level are symlinks

This made it a hell of a lot faster to provision the files, easy to
add files, etc. But it's still far from a good solution. In the end
MyPhotoAlbum wants to be a monolithic web application but we are
building little sites left and right. The reason why is because of the
genesis of this project and the continually shifting requirements from
management.

I'll forward a sample email from Evolutionware. Let me know what else
you need.

~swain



#########################################################################
040827 Friday

47 and 56. That's how many signups resulted in corrupted config files
for Wednesday night and last night, respectively. Told Rob; based on
the signups, for yesterday that was a 16% failure rate.

Merged the changes from findBorked.pl into
galleryFormsetter.pl. Tested. Looks good. Things provision quickly
now.

Drunk. Yay.


#########################################################################
040830 Monday

Removed the step galleryUnstick.pl, and changed the workflow so it
doesn't wait for a reply. A Gallery signup is provisioned in about 2
or 3 minutes now.




#########################################################################
040831 Tuesday

Looking at solving the problem: how to highlight an entire
<form></form> block that spans lines via hi-lock, I'm reading the
Emacs manual page for regexps. Shoulda done this long ago. First, when
occur or isearch-forward-regexp prompt one for a regexp, the metachars
are not escaped. However curly braces are indeed escaped. No idea why
this is. In Lisp backslashes have to be doubled.

I highlighted all occurances of the two letters f,x like this:

[fx]\{3,\}

Any combination of three consisting of the two letters was
highlighted... this is progress. 

Now, there are "special constructs" in the Emacs regexp library that
are not metachars, whereas I think they are metachars in the Perl
regexp library. That's why things like the pipe (OR) and the curly
braces are "escaped." They are not technically escaped, they are two
character constructs. To match any three chars in a row (the same
char, like XXX):

\(X\)\1\1

Equivalent in Perl: (X)$1$1 (untested though)

\s- matches a space. When interactively matching a newline you have to
insert ^q^j.

It seems to me that once a regexp is crafted to highlight a form, the
next step is to capture this in a keyboard macro and later on rewrite
it as a function.

To highlight <form or </form> do: </?form>?

I got hi-lock to highlight all HTML forms, but it doesn't want to
 highlight the largest ones. Something causes it to crap out, some
 char not encompassed in the character set:

 <form\(.\|[
]\)*?</form>

Note the newline appears verbatim here but I input it as ^q^j.


This I came up with after running the largest HTML form through a
filtering Perl script:

<form\([ !"%&'()-./012345678:;<=>?CDEFHMNOPRT_abcdefghijklmnoprstuvwxyz]\|
\)+?</form>

But it still didn't work. It did match the small forms though.

---

Created a new branch in CVS, pre-shopping-cart-20040831. I can now
commit any changes I make to the main branch.

splinter test gallery for 144p2:
http://splinter/~swain/gallery144/gallery/albums.php

doxygen on splinter:
http://splinter/~swain/projects/ampiradev/gallery/doxygen/annotated.html

Got the form working in the view photo page as well; and a button to
add all photos to cart works too. Jessy wants to revise the user
experience. Meanwhile, I'm guessing they will want to have the caption
and whatnot imported as well. This is probably doable.




#########################################################################
040901 Wednesday

Traded emails over database design. Had lunch with Gautam in Bryant
Park. Fixed two MPA sites; researched why one was broken, found it was
caused by the disk space problem over the weekend.

We're being sent home early due to a disruptive labor rally outside
our offices.




#########################################################################
040902 Thursday

Fixed a Gallery for a customer; looks like the config file was ruined
at 6:24am on 8/31.

Updated log rotation for gprov. Happens nightly now.

Kurt reported that :80 was appearing in the FQDN for bandwidth
stats. I updated the bwusage.pl, rolled it out to the servers, and
fixed the data in the marketing database with a one-off perl script.



#########################################################################
040903 Friday

Yesterday Zlatin hooked up a second NFS server, or disk array or
somesuch, and it caused the main nfs server to fail. This took
everything offline.

Today I only had two borked jobs overnight, plus a third that was a
top level domain (arunarajkumar.com) that came through with missing
job data. The job ID was dated Tue Aug 31 17:52:26 2004. Sent email to
Rob, Xtina and Swolf.

Converted the toolbar buttons to <a> links for Jessy, as she and I
discussed yesterday. I've prepped for an 11am meeting with Swolf, Rob,
and Jessy on the V3->FC conversion.




#########################################################################
040907 Tuesday

Reported a problem on Saturday, where I was seeing massive numbers of
500 errors when I ran the findBorked.pl script to test the Gallery
sites provisioned over the last 24 hours. No reply... I even emailed
Swolf and Ferry directly in addition to cc'ing Ops. This morning a
tired looking Swolf said whoever got there first (me or him) should
follow up on it. I'll wager Ferry fixed the problem and never replied.

While adding the thumbnail image for Trevor, in the POST data, I found
that the image path was wrong... it turns out you can pass any string
into the function (method) and the result is incorrect; it does little
more than concatenate the string to the filename. I had to call the
right method on the right object, in this case the AlbumItem object,
to get the right path.

$full_image_path = $image->getPath($gallery->album->getAlbumDir(), 1);

Also had a conf call with Tim about the registration system. It seems
we are being delayed in deleting old MPA accounts due to a bug in an
SF module, a solitary instance of case sensitivity.

I have been testing changing the name of the admin, and it looks like
PHP caching is breaking it. Nope: it was me, and here's what needs
doing.

In login.php I've hardcoded the admin username as 'admin' and that's
why the error in error_log is "calling method on nonmember object" or
whatever. This is the offending block:

    if ($uname == 'admin' || strtolower($uname) == strtolower($gallery->app->evwusername)) {
        // authenticate via ldap
        $ampiraIsValid = ldapAuthenticate($gallery->app->evwusername, $gallerypassword);
        $uname = 'admin';
        
    }
    
This should probably do $uname = $userdb->getUserByUid(0) or whatever
the userid is of the admin, which should be the same for all
installations.



Unfortunately this:
    
    if ($uname == 'admin' || strtolower($uname) == strtolower($gallery->app->evwusername)) {
        // authenticate via ldap
        $ampiraIsValid = ldapAuthenticate($gallery->app->evwusername, $gallerypassword);
        $uname = 'admin';
        $adminUser = $gallery->userDB->getUserByUsername("admin");
        $adminName = $adminUser->getUsername();
        echo "<h1>uid zero: $adminName</h1>";
        echo "<h1>" . $adminUser->uid . "</h1>";
        die("hello sailor");
    }

Produces this:

Login to Gallery

uid zero: admin
1093895526_250722845
hello sailor


#########################################################################
040908 Wednesday

1:45 to get in to work today. A cell unrelated to Hurricane Frances
(now Tropical Depression Frances) caused a lot of flooding in the
train tunnels. On Manhattan bound lines in Queens the switching was
fouled up; from Brooklyn they were turned away at the station.

No NFS destruction today; Zlatin turned on file locking over
NFS. Hopefully that solves it.

11:30am meeting: new mandate is to upgrade Gallery to 1.4.4 p2.

Wrote longish email to Tim about Gallery upgrading issues... wrote to
Jessy asking what she needs for ESPN site.

Solved the problem of creating a new album via fxfoto. Once again
reading the code in gallery_remote2.php showed the way. It wasn't all
that hard.

For custom sites like metrosearch.mpa.com, Rob has to upgrade the site
to an FTP package. Then I reproviosion Gallery and make sure the
directories are writable.




#########################################################################
040909 Thursday

I feel ill. Spent the morning diagnosing broken sites for MPA.


Conversation on commenting out TLD searches in V3:

AIM IM with jeffoatrulez
1:00 PM
jeffoatrulez: s'up?
1:10 PM
Steve Wainstead: care to field a v3 architecture question?
jeffoatrulez: is that a trick question?
Steve Wainstead: nope 
jeffoatrulez: ok, sure. 
Steve Wainstead: i think it's an easy one
jeffoatrulez: k
Steve Wainstead: the search results page. we just want to drop the tld search results. (and not search at all.)
Steve Wainstead: it should just return subdomain searches
Steve Wainstead: mgmt's idea is v3 will be only subdomains and totally free
jeffoatrulez: find the section in the template you want to remove.

jeffoatrulez: then you can remove the items from the code.
jeffoatrulez: give me a second, i'll look and see if i can find it.....
1:15 PM
jeffoatrulez: V3Core::Presentation::AvailableView::_handleAvailableForm()
1:20 PM
jeffoatrulez: lib/perl/VCCore/....
Steve Wainstead: i'm checking out v3.com right now
Steve Wainstead: lots of files
jeffoatrulez: all the !@#$% gifs.
jeffoatrulez: actually, check _handleAvailableQuery()
jeffoatrulez: in that module, there are three subroutines:
jeffoatrulez: _getTLDDomainAvailability()
jeffoatrulez: _getPremiumDomainAvailability()
jeffoatrulez: and _getFreeDomainAvailability(0
jeffoatrulez: you can probably just comment them out in _handleAvailableQuery().
Steve Wainstead: #
# query the available packages / domains
#

my $params = {
'rm'=> 'handleAvailableForm',
'v3url'=> $v3url,
#
'toplevel_domains'=> ( $self->_getTLDDomainAvailability( $v3url, $tld ) || [] ),
'premium_domains'=> ( $self->_getPremiumDomainAvailability( $v3url ) || [] ),
'free_domains'=> ( $self->_getFreeDomainAvailability( $v3url ) || [] ),
} ;
1:25 PM
jeffoatrulez: yup.
jeffoatrulez: just comment out the 'toplevel_domains' line, and try it.
jeffoatrulez: 
Steve Wainstead: or pass in []
jeffoatrulez: yup.
jeffoatrulez: ( i love it when planning ahead makes things easier a year and a half later.... )
Steve Wainstead: and the thing runs with no downtime ever


Two sites were corrupted on provisioning at 10:20am today, or
so... since those are the times they arrived via the pipe, it might
have been 10:21 or 10:22.

bash-2.03# ls -l /mnt/nfs-1/mpa1/web//g/gr/gre//gretchenlichtman.myphotoalbum.com/web/config.ph\
p /mnt/nfs-1/mpa1/web//m/mi/mik//mikesmontess.myphotoalbum.com/web/config.php
-rw-r--r--   1 www      www          7444 Sep  9 10:13 /mnt/nfs-1/mpa1/web//g/gr/gre//gretchenl\
ichtman.myphotoalbum.com/web/config.php
-rw-r--r--   1 www      www          7420 Sep  9 10:13 /mnt/nfs-1/mpa1/web//m/mi/mik//mikesmont\
ess.myphotoalbum.com/web/config.php

Note that even though both sites render exactly the same, the file
sizes are different.  The top part of config.php contains HTML code
and the bottom part unreadable binary crap. I see html for something
Fortune City related. The end of the file is padded with a lot of
nulls, which show up as @ symbols; in hexl-mode they appear to be
nulls.

Updated the php files that send data to Trevor. Took a while to work
out how to send the thumbnail image. Not happy with how I did it, but
I still feel ill and it's hard to concentrate.

$mpa_thumb = $gallery->app->photoAlbumURL 
. "/albums/" 
. $gallery->album->fields["name"]
. "/"
. $photo->image->getName("")
     . ".thumb."
. $photo->image->type;

Works, is hackish, but oh well.




#########################################################################
040910 Friday

In late. Fixed a javascript bug for Trevor: wasn't properly imploding
the list of choices for Gallery. Made it perfect, and handled the
zeroeth case while I was at it.

Cleaing out the MPA bug list... many are invalid because they apply to
the current registration system.




#########################################################################
040913 Monday

Spent the morning running down the assorted MPA corruption issues;
specifically, wrote a longish reply to Peter's email and cc'd a lot of
folks on it, on what I keep finding.

Also there's a site that won't finish provisioning because it won't
auth against LDAP, though the username and password appear to be
correct. I can't finish diagnosing it because Evolutionware is
failing.

I note here some super high weirdness: for kjduque.myphotoalbum.com
the password differed by one character. I don't know how this could
have happened, and this tiny difference made it really hard to find.

Discovered that metrosearch.myphotoalbum.com was hosed. The photos.dat
file was in fact a zip file that contained a document on how to use
ms-access.

bash-2.03# unzip photos.dat
Archive:  photos.dat
  inflating: ms_access_primer.mdb




#########################################################################
040914 Tuesday

29 sites hosed overnight, 6 stuck in provisioning. Zlatin says his
screen session died (!) so the rsync failed. nfs-1 is now at 99%, with
only 3.0GB left. They think they will be able to cut over tonight.




#########################################################################
040915 Wednesday

Fixed 13 sites via scanning; fixed 1 that Darren sent me. The odd
thing is that one had four chars missing from one line.

Updated mpa-diagnose to accept paths and fqdns.

Conversation with Swolf brought the realization that Gallery's click
counts result in a file write every time. Gonna disable this.

Ferry says the mpa-1 is in fact the correct nfs server now, so sites
are going to the right place.




#########################################################################
040916 Thursday

One site corrupted overnight, at least among those provisioned in the
last 24 hours.

A new problem on the horizon: SF wants to change the timeout on LDAP
queries to ten minutes, which impacts the marketing database
updates. I outlined in an email how we'll have to redo this in Perl,
but fortunately we can do all the work on evw-1.prv (LDAP and DB2
queries combined).




#########################################################################
040921 Tuesday

I've been reading the code base for File Manager. This app is the
source of one of our ills: filling up the disk space on the RAID. Here
is a snippet from the debug.log on cws-5:

/mnt/mss-1/vol3/web//t/th/the//www.theanimekingdom.com/tmp:
total 53210876
-rw-r--r--   1 webuser  webgroup 54632054784 Sep 19 21:38 FM.D:\Remi
Stuff\Anim?\Site Transfer\ryogakun.gif

I installed File Manager on splinter, and it took me a while to find
my way down to the upload function, the getfile function, and the
dosyscmd function... it turned out there was a timeout on the system
command of twenty seconds, so that's not where the problem is. So I
can't wrap the whole operation in an eval{} and time it out, since
it's done internally... or can I?

But anyway I think the creation of the temp file is where the
problem is.

Perhaps Richard Rebel and Petris decided to have local tmp directories
for this thing to write to... one way to isolate the problem would be
to write the file to tmp on the local webserver. If this problem
happens again, only /tmp on that one web server is maxed out.

Anyway, I have a timeout system in place on Splinter and will have to
devise a test plan for staging tomorrow.




#########################################################################
040922 Wednesday

PHP was crashing on mpa-2 and I had to pressure Ferry into looking
into it... some monitoring thing he set up didn't work. Management
were blaming Jessy because the voteheisman site wasn't loading. Also
reverted add_photos.php for Jessy so she could use sftp to upload the
Heisman photos to that site.

I might have a cold. We'll see. Dry throat today.

How the userdb.dat file is opened:

1) init.php is loaded
2) this instantiates a Gallery_UserDB class
3) the constructor for this class looks in $gallery->userdir for
   userdb.dat
4) the file is loaded via getFile() and assigned to $this

The file 1093895526_250722845 is probably a User object that's
serialized. It represents the admin user.

1.  stuff after the underscore?
http://www.php.net/manual/en/function.mt-rand.php
		$this->uid = time() . "_" . mt_rand();

2. what is the encryption scheme?

MD5:

	function salt($len = 4)
	{
	       	srand ((float) microtime() * 10000000); // for php v < 4.2
		$salt = '';
		for($i = 0; $i < $len; $i++)
		{
			$char = mt_rand(48, 109);
			if($char > 57) $char += 7;
			if($char > 90) $char += 6;
			$salt .= chr($char);
		}
		return $salt;
	}

	function setPassword($password) {
		$salt = $this->salt();
		$this->password = $salt.md5($salt.$password);
	}





#########################################################################
040923 Thursday

Spent some time doing housecleaning on pork. /home was at 99%, now
down to 49%. /usr at 98% but ferry says not to worry.

Fixed bug: users can enter spaces into the gallery name in fx
foto... but Gallery's error handling in this arena isn't exactly
robust. Swolf already submitted another bug.


#########################################################################
040924 Friday

Set up copies of the bwusage.pl scripts: paidhostingbw.pl in
~swain/stats on cws2-5.

Set up a site for Lakeisha, tweaked it, fixed it when it broke, etc.

Working on short circuiting mpaAuthenticate() when the username prefix
is mpatest.

function mysqlAuthenticate($uname, $password) {
    return true;
}

function mpaAuthenticate($uname, $password) {

    if ( preg_match("/^mpatest/", $uname) ) {
        return mysqlAuthenticate($uname, $password);
    }
[snip]

But I found the user 'read' on development is missing in
action. Probably from the rollback. And I had the auth short
circuited, so we never noticed.




#########################################################################
040928 Tuesday

Out sick yesterday. Bad fever all weekend.

Culled the user data for Tim today. Did work for Jessy setting up
pork; wound up moving the whole works to the site directory and giving
her access to that. I'm doing some php work. Started the day
investigating stats discrepencies for Kurt. I think some of the
numbers can be explained by borkage but not all.

Started on a cli php script that is supposed to ping mysql (I think,
have to follow up with Tim).




#########################################################################
040929 Wednesday

Well, the madness that is testing on production has caused
trouble. Since Tim is developing his registration system on
production, one line of code made it though by accident: "return true"
in mpaAuthenticate(). This is why we are not supposed to develop on
production.




#########################################################################
041001 Friday

So yesterday our efforts were mostly focused on switching over to the
new registration system. What suck. Tim developed it on the production
machines, nothing in CVS, and when we cut over it turns out there were
rudimentary bugs in his PHP code, the conf file to connect to mysql
was wrong, nothing had been planned for the cws provisioned
users... bleh. It sucked. His idea of a backup is making a tarball.

Got a switch from Ferry and some kind of direct link to the equipment
room... I'm so poor on networking stuff. But so far it looks like an
improvement.




#########################################################################
041004 Monday

Swolf out sick today.

Finished fixing links for Jessy. No doubt there will be more to
come. I organized a brief meeting this morning: me, Ronny, Chris,
Kevin and Jessy, just to cover what we're working on.

Lunch with Rob, Kurt, Chris. We talked about needs of the company vis
development and operations in the light of MPA and possibly moving to
Hostopia.

I have to update the stats stuff next.

Now that I think about it, I loaded the database for mpa on devil on
Friday.




#########################################################################
041005 Tuesday

on mdb-1:
mysql -S /tmp/mysql.mpa.sock -umpauser -p mpa




#########################################################################
041006 Wednesday

Spent the morning fixing links for Jessy which was so tedious it makes
me think about a career change. I'm now hunting for the bug that
causes the "method called on a non object" error, which is fatal. How
to reproduce: login; view an album; logout; in that album only,
thereafter, you cannot view it. You can go to the top and view other
albums... until you login/logout in that album and the same problem
occurs.




#########################################################################
041007 Thursday

Found and fixed the bug in LOGOUT. It turns out it was just an
undefined PHP variable, $page. There was code to define it. So it was
actually a trivial fix once I noticed that there was a variable in the
mix and tested to see if it got set or not.

I also fixed a problem with the paid hosting bandwidth
stats... sometimes the day's data is not in the access*.r files, but
the access*00 files.

Assembled my little bookcase and cleaned up. Desk looks nicer.

Looking into a Rob request to make credit card rejection notices more
informative...

EvwSignupClient.java calls the Generic Credit Card Extension to do the
credit card preauth:

		/// ########################
		/// EFTNET CALL  
		stdout("starting eftnet check...");
		int id = 
		    ccExtension.externalRequestAuthorization(sessionKey, 
							     merchantAccountId,
							     card, 
							     avs, 
							     total,
							     getAttribute("email", ""), 
							     msgHolder);

Note the last param is msgHolder, defined thusly:

		org.omg.CORBA.StringHolder 
		    msgHolder = new org.omg.CORBA.StringHolder();


At a later point this value is written to the stdout log:

		stdout("eftnet message: " + msgHolder.value);

But it only contains stuff like this:

bash-2.04$ grep "eftnet message:" stdout.log*
stdout.log:EvwSignupClient: eftnet message: APPROVED 007657                 ,Y,M|56,0,0,1,None,Approve,|
stdout.log.1:EvwSignupClient: eftnet message: APPROVED 971488                 ,N,M|29,0,0,1,None,Approve,|
stdout.log.1:EvwSignupClient: eftnet message: APPROVED 145882                 ,Y,M|31,0,0,1,None,Approve,|


When the transaction is declined, EVW throws an exception instead of
just returning "false" as it should. Crappy programming. Anyway, we
only ever print the stack trace:

Thu Oct  7 13:00:00 2004 (ampira timestamp)
com.evolutionware.CORBA.CreditCardGatewayPackage.TransactionDeclined
        at com.evolutionware.CORBA.CreditCardGatewayPackage.TransactionDeclinedHelper.read(TransactionDeclinedHelper.java:75)
        at com.evolutionware.CORBA.CreditCardGatewayPackage.TransactionDeclinedHelper.extract(TransactionDeclinedHelper.java:34)
[...]

But this exception object contains more info we've never looked at, as
far as I know.

http://evw-1.dvl.ampira.com/javadoc/com/evolutionware/CORBA/CreditCardGatewayPackage/TransactionDeclined.html

Building needs this:

  535  export ANT_HOME=/usr/local/apache-ant-1.6.1
  536  export JAVA_HOME=/usr/jdk1_4_2
  537  export PATH=$JAVA_HOME/bin:$PATH
  539  ant -f build.xml clean autogen build-war





#########################################################################
041008 Friday

Tim points out it's better to just update mysql with the datetime the
user modified the site; then we only need to cull the list once a
night and run du -s on all the sites that changed. Far more efficient
than the way we do it now, and more effiecient than the way I was
going to do it.

Solved a javascript problem for Jessy with the voteheisman site: to
upload photos you have to login via the /gallery/ url and not the
front page.

/tmp filled up today on mpa-2. Tim and I discussed how to handle this
going forward. I had already coded config.php's template to write to a
user directory, so Tim rightly points out that all we need to do is
pull all the usernames and visit each directory by computing the path.




#########################################################################
041011 Monday

930 meeting minutes posted. Solved issue for customer cole2mrl (or
somesuch) whose site had moved to the new server but the dns was out
of date. This is stupid. Why are the sites being deleted before the
dns is removed? Started up again on my note cards.




#########################################################################
041013 Wednesday

Adding someone to the ndbm file:

  515  export LD_LIBRARY_PATH=/opt/evw/lib:/usr/local/lib::/opt/muddleftpd/lib:/opt/evw/lib:/usr/local/lib:/opt/evw/lib:/usr/local/lib
  516  ndbm_tool -f mass -c -k  janice.myphotoalbum.com -v /mnt/nfs-1/mpa1/web/j/ja/jan/janice.myphotoalbum.com/web
  527  ndbm_dump mass |grep janice
  530  /etc/init.d/apache graceful


Added code, tested, checked in for updating mysql when photos/albums
are added/deleted. I should update the script to query for them. The
script that measures disk usage that is.





#########################################################################
041014 Thursday

Jeebus. I completely forgot about the work I did on FileManager. As I
recall, we could not test it on staging because, according to Ferry,
it was never set up properly on staging. Made a note card for it.

I'm puzzled why I can't find the config info for the CGIs Tim wrote in
httpd.conf on mpa-1.

Update all my CPAN modules:
perl -MCPAN -e 'CPAN::Shell->install(CPAN::Shell->r)'

Note this will probably try to upgrade Perl. Best to just upgrade Perl
first, then run the command. For Apache and mod_perl stuff you'll need
the Apache source code.

Worked out a testbed for the getInstalledProduct method.


#########################################################################
041015 Friday

Finally found out why etags - doesn't work anymore... you have to
specify stdin via the input file flag:

find . \( -name "*.pl" -o -name "*.cgi" \)  | etags --language-force=Perl -L -

Trading emails with Steve Simonoff at Triscape. We're talking about
the ambiguities in the Galley interface, name versus title of an
album. I found it was a simple two line addition to print out
name/title pairs.

I think I can write a simple script to provision test sites. It would
just be a sequence of function calls.

For Monday: fix Javascript bug in the Login tab on view_photo.php via
blippy.mpa.com or portman.mpa.com; give Trev the data he needs (pass
more data to him); finish setting up the signup system Pork->Devil.




#########################################################################
041018 Monday

Today, found that term and terminal are two different packages in
Emacs. That makes four ways to run a shell in Emacs. Ronny is killing
me by pasting Dan Quayle quotes over IM.

Here is a breakdown of the difference between two admin files. The
first is the original as generated by Tim's code and the second after
I changed the admin's username and name. I opened both in Emacs, side
by side via C-x 3 and ran M-% : RET C-q C-j RET !.

O                                          |O
12                                         |12
"gallery_user"                             |"gallery_user"
13                                         |13
{s                                         |{s
8                                          |8
"username";s                               |"username";s
5                                          |7
"admin";s                                  |"fucking";s
8                                          |8
"fullname";s                               |"fullname";s
13                                         |7
"Administrator";s                          |"Fucking";s
8                                          |8
"password";s                               |"password";s
36                                         |36
"pq3F3c0957a2dc0b2d8d2d94b2f325679011";s   |"pq3F3c0957a2dc0b2d8d2d94b2f325679011";s
5                                          |5
"email";s                                  |"email";s
19                                         |19
"fucking@example.com";s                    |"fucking@example.com";s
7                                          |7
"isAdmin";b                                |"isAdmin";b
1;s                                        |1;s
15                                         |15
"canCreateAlbums";b                        |"canCreateAlbums";b
1;s                                        |1;s
3                                          |3
"uid";s                                    |"uid";s
21                                         |21
"1098130473_1000312382";s                  |"1098130473_1000312382";s
15                                         |15
"defaultLanguage";s                        |"defaultLanguage";s
0                                          |5
"";s                                       |"en_US";s
7                                          |7
"version";i                                |"version";i
5;s                                        |5;s
15                                         |15
"recoverPassHash";N;s                      |"recoverPassHash";N;s
10                                         |10
"lastAction";s                             |"lastAction";s
5                                          |5
"login";s                                  |"login";s
14                                         |14
"lastActionDate";i                         |"lastActionDate";i
1098130598;s                               |1098130598;s
9                                          |9
"origEmail";N;}                            |"origEmail";N;}
                                           |

We see only two fields change significantly: username and fullname.

Aha! I forgot to change the character count. Note that username
'fucking' is 7 chars while 'admin' is five. Doh!




#########################################################################
041019 Tuesday

Worked out the solution for Trevor's request: add the return URL to
the data sent to the cart. Done on view_album and view_photo.

Interesting meeting today... wherein I finally argued that we need a
project manager; Rob was unhappy with the idea of the tech staff
spending their time entering data into dotproject.




#########################################################################
041021 Thursday

I have not been updating. I've been working on getting dev and staging
set up with the signup process; it works, but name resolution fails.

I had to install /opt/netpbm, which I copied from mpa-1; install
/opt/mpa from cvs; make sure I can connect to mysql, which usually
invovled getting drivers and accounts and permissions; creating the
ndbm file; making changes to the httpd.conf and making an included
conf file for the domain (either myphotodevel or myphotostage).

I also added new things to the API for Trevor, namely the URL from
which the user selected pix and the image dimensions.

Hanleyisms:

jessyhanley: allt he files in my dir are green
jessyhanley: noting hasbeen changed
jessyhanley: want me to do an update?
Steve Wainstead: sure
Steve Wainstead: dont' be working on this if you have CS to do though
Steve Wainstead: we gotta get CS out of the way
jessyhanley: o wpnmt
jessyhanley: if it something quick and easy
jessyhanley: np
jessyhanley: bnut

Steve Wainstead: peter et al said they'd seen this before
jessyhanley: he was in a "hpsotial" for whle
jessyhanley: but I dont know if was rehab or nut house
jessyhanley: but one of the 2


jessyhanley: wha tdo I have cooties lately
jessyhanley: wanna go downwith me?

jessyhanley: HOT DAM
jessyhanley: great fix
Steve Wainstead: got my headphones on :)
jessyhanley: for stuone stuff
Steve Wainstead: stuone?
Steve Wainstead: sutone
Steve Wainstead: ustone
jessyhanley: i dont know what that was sopsoed to be
Steve Wainstead: hmm
jessyhanley: but I think I just found an easy soution for the new style additions!
jessyhanley: LOL


jessyhanley: I htink its causde you dont have the layouts
jessyhanley: try uploading that dir
jessyhanley: again?
jessyhanley: mayne?
Steve Wainstead: mayen?
Steve Wainstead: what?

Steve Wainstead: is that file in cvs?
jessyhanley: he
jessyhanley: a
jessyhanley: yea
Steve Wainstead: i can't find it
jessyhanley: in html
jessyhanley: -domriynh
jessyhanley: the file
Steve Wainstead: oh, all.header.default!
jessyhanley: yea
jessyhanley: sorry

Steve Wainstead: dev is staging
Steve Wainstead: you want development == devil ==dvl
Steve Wainstead: not staging == stg == dev
jessyhanley: this are stupid names
jessyhanley: it shoudl be stage


jessyhanley: so I make thatits onlpl
jessyhanley: file?
jessyhanley: and then do a ninclude
jessyhanley: >
Steve Wainstead: yeah if i read that garble correctly :)

Steve Wainstead: mebbe if we tinker with the files directly we can figure it out
jessyhanley: i think you need to see it here
jessyhanley: k
jessyhanley: cxomin
jessyhanley: fab
jessyhanley: making promise
jessyhanley: prgreass
Steve Wainstead: ok

Steve Wainstead: are you busy
Steve Wainstead: ?
jessyhanley: yea
jessyhanley: on the photn with someone for anotyher thing wit afa
Steve Wainstead: ok


Steve Wainstead: ack
jessyhanley: cuase y woudl u try to log in before youf innich sign up
Steve Wainstead: it's everywhere. never noticed.

jessyhanley: well I get no conten
jessyhanley: i dont get anything
jessyhanley: all the douce has here
jessyhanley: is hust what you see
jessyhanley: <html><body></body></html>
Steve Wainstead: douce?
jessyhanley: source


jessyhanley: GRRRR
jessyhanley: u there aloenm/
Steve Wainstead: not today. i'm on nyquil. :)
Steve Wainstead: i'm a big smiley face :)
jessyhanley: oh good...

jessyhanley: I made a emw album
jessyhanley: and nothign is teher

jessyhanley: but you have been doign wll
jessyhanley: thougth right/?
jessyhanley: i need cofffe
jessyhanley: fell liek going down to get omes

Steve Wainstead: i cc'd you on that email, the reply to peter...
Steve Wainstead: just as a professional courtesy so you know what's going on...
jessyhanley: hmmm
jessyhanley: I meed tp scjecl
Steve Wainstead: huh?

----


We are experiencing network problems since two days ago. Today I was
talking to Tim on the phone and got cut off four times. I overheard
Ferry tell Swolf that XO finally looked at our ticket at
3:15. Presumably it was filed yesterday at some time.




#########################################################################
041025 Monday

Disabling the unique index on the 'users' table:

alter table users drop index email_address;





#########################################################################
041026 Tuesday

Swolf canned yesterday, told us today, split by 10am. New day rising
and all that. Peter met with me, Jessy and Chris and put us in charge.

Meanwhile, I have MPA working on devel but there's a bug. I filed it
in Bugzilla: 


#########################################################################
041028 Thursday

Things are really... eclectic right now. What with the CTO gone, there
are lots of little things demanding attention versus one big thing
demanding my attention. That is, I prefer to have one big project with
lots of things needing doing as opposed to the trillion details of
managing stuff. Hmm. Meet with Peter at 2pm.

I have a full working version of signup.cgi on devel, and the staging
one is now blocked by email not working. Talked/emailed Chris about
it.

Found the table with the cc's and cvv2's:
genericcccreditcardaccountinfo, or somesuch. Search for cvv2 in twiki.

Met with Peter, 2pm. Met with Jessy, Trevor and Kurt at 3pm. We went
over ideas for the shopping cart interface. We still don't have a
partner for printing though. Still Kurt wants to roll out the cart
before Thanksgiving.




#########################################################################
041101 Monday

Ronny thought I had written a script for regenerating the domains
table in the mkt database; but I don't recall anymore. The steps to
load the thing are quite detailed, beyond the remembering of anyone
really, and I last did that on Sept. 2nd, two months ago. I should
have detailed the steps in Twiki, and fail that in this log.

I've been working on Gallery stuff for Jessy: had to debug some
javascript errors. Some were coming from tabs that shouldn't display
at all, as they don't show in the dropdown if the album contains no
photos. I also recreated pork.mpa.com for her.




#########################################################################
041105 Friday

Ronny found bugs when he creates a user without admin privledges. It
will take a while to solve. I created a new site on myphotodevel
(swain) to test with, and while I thought of it wrote up how to do
that since one missing step cost ronny two or three hours
yesterday. Right after I finished it, Trevor needed it!

Filed three or four bugs in Bugzilla. Being bombarded on AIM so I'm
staying off.




#########################################################################
041108 Monday

Updated my card system.

The bug in the tabs stems from a test that was originally in a
loop. It fails when the user cannot create albums. (Only two classes
of user in Gallery: can create albums and cannot. But I think it may
be that finer grained changes are possible.)



#########################################################################
041109 Tuesday

Worked a little late yesterday (7:15) fixing bugs introduced by the
toolbar. I am down to two small bugs now: one I can fix readily (don't
show two tabs to users who can make albums) and "edit photo info" is
broken.

Unfortunately the ability to edit a photo's info (caption, etc)
doesn't exist on the photo level, only the album level. sigh.




#########################################################################
041111 Thursday

Was out yesterday waiting for the cable guy to reconnect me. But I
still spend considerable time on the phone with Tim and on IM with
Jessy and Ronny, and answering email.

Today we wrapped up fixes to the toolbar release; I did repeated
releases to devel and staging, and finally to production. Then I met
with Ronny and Jessy and we spec'd out her tool for the sales
people. I think it will take 4 days of Ronny's time. The issue of
making this a priority with mgmt is unresolved. Ronny and I
collaborated with Tim to roll out the MPA signup wizard, which is
done. Lots of good accomplishments for the week.


#########################################################################
041112 Friday

Fixed a nasty bug. FxFoto passes us the title over and over if the
album doesn't exist. The fix was to compute the album name from the
title passed in and try to get the album again. Works. Ronny saw this
bug posted on the boards.




#########################################################################
041115 Monday

Over the weekend Tim was looking at a site Jessy reported. I had
somehow manipulated the ldap.php file. But this lead Tim to discover
some 100 accounts with no ldap.php file at all, and these appeared
post-migration.

Posted my to-do list. Gonna meet with Peter in a bit.

That went well; I'll send him a summary on Fridays or Monday
morning. Meanwhile: handled about five user problems from Kurt via the
message board. I helped Ronny test the new login code. I did a
frequency count of missing UIDs in activation URLs, which came to
almost 1% (11 in 1400 or so). We moved the gallery.mysql.conf file on
all systems.

Disabled bandwidth scripts for MPA on cws boxen.

All the work I did on the FileManager is on splinter, and my Emacs
desktop shows who what where.


#########################################################################
041116 Tuesday

Spent a LOT of time in meetings today, which netted me a ministack of
notecards with tasks. I pushed some stuff off to Ronny. Trevor's
really got his hands full.

Meanwhile:

(defun sw-yank-last-N-kills (numyanks)
  "Yank numyanks back in the kill ring."
  (interactive)
  (save-excursion
    (while (not (= 0 numyanks))
      (yank)
      (rotate-yank-pointer 1)
      (setq numyanks (- numyanks 1))
      )
    )
  )


(sw-yank-last-N-kills 3)

This is an attempt to yank the last N things from the kill ring. It's
often the case I want to jump around to different points and kill
things (cut). Then restore them to one place. This is a nonoptimal
solution though. I suppose the right thing is to append to a register.

Hmm. Just found this:

append-next-kill              C-M-w
  Command: Cause following command, if it kills, to append to previous kill.

That would be a way to clump kills together and yank them in one
shot.


#########################################################################
041117 Wednesday

Got a lot of code work in today. Solved the hardlink/symlink problem
(yay!) and added the CVS Log tag to all .php and .inc files:

	From: 	  swain@ampira.com
	Subject: 	Adding $Log: LOG.txt,v $
	Subject: 	Adding Revision 1.1  2007/11/27 22:54:23  swain
	Subject: 	Adding Initial revision
	Subject: 	Adding
	Subject: 	Adding Revision 1.115  2007/11/27 22:14:20  swain
	Subject: 	Adding updating. ing. ing.
	Subject: 	Adding
	Subject: 	Adding Revision 1.114  2007/11/15 16:56:49  swain
	Subject: 	Adding updated: wrote up my work on refactoring and testing gallery
	Subject: 	Adding
	Subject: 	Adding Revision 1.113  2007/10/31 16:09:03  swain
	Subject: 	Adding notes on mpp
	Subject: 	Adding
	Subject: 	Adding Revision 1.112  2007/10/29 21:07:12  swain
	Subject: 	Adding updated
	Subject: 	Adding
	Subject: 	Adding Revision 1.111  2007/08/24 17:19:49  swain
	Subject: 	Adding changes from kristalle
	Subject: 	Adding
	Subject: 	Adding Revision 1.110  2007/08/20 20:08:40  swain
	Subject: 	Adding latest stuff
	Subject: 	Adding
	Subject: 	Adding Revision 1.109  2007/08/20 14:53:56  swain
	Subject: 	Adding Last commit before moving to torque, the new machine.
	Subject: 	Adding
	Subject: 	Adding Revision 1.108  2007/08/17 19:36:55  swain
	Subject: 	Adding updated
	Subject: 	Adding
	Subject: 	Adding Revision 1.107  2007/07/18 21:59:52  swain
	Subject: 	Adding hello, sailor!
	Subject: 	Adding
	Subject: 	Adding Revision 1.106  2007/06/11 20:45:10  swain
	Subject: 	Adding updated the typolesbianisms
	Subject: 	Adding
	Subject: 	Adding Revision 1.105  2007/02/23 16:06:17  swain
	Subject: 	Adding Updates to Thur 22 2007
	Subject: 	Adding
	Subject: 	Adding Revision 1.104  2007/02/10 22:41:36  swain
	Subject: 	Adding Most recent stuff.
	Subject: 	Adding
	Subject: 	Adding Revision 1.103  2007/01/24 18:25:57  swain
	Subject: 	Adding There are things going bump in there.
	Subject: 	Adding
	Subject: 	Adding Revision 1.102  2006/12/07 23:01:24  swain
	Subject: 	Adding updated instructions for adding a class..
	Subject: 	Adding
	Subject: 	Adding Revision 1.101  2006/11/17 15:36:00  swain
	Subject: 	Adding meh
	Subject: 	Adding
	Subject: 	Adding Revision 1.100  2006/10/26 22:40:24  swain
	Subject: 	Adding meh
	Subject: 	Adding
	Subject: 	Adding Revision 1.99  2006/09/14 20:39:44  swain
	Subject: 	Adding list of eu countries. tired of looking that up and munging the output.
	Subject: 	Adding
	Subject: 	Adding Revision 1.98  2006/08/16 14:27:46  swain
	Subject: 	Adding added some old conversations for posterity
	Subject: 	Adding
	Subject: 	Adding Revision 1.97  2006/08/09 18:02:58  swain
	Subject: 	Adding it's log! it's log!
	Subject: 	Adding
	Subject: 	Adding Revision 1.96  2006/07/20 18:51:59  swain
	Subject: 	Adding added instructions to create new product in store.
	Subject: 	Adding
	Subject: 	Adding Revision 1.95  2006/07/18 22:13:46  swain
	Subject: 	Adding It's A. Tree! With Arthur Tree!
	Subject: 	Adding
	Subject: 	Adding Revision 1.94  2006/05/23 14:55:36  swain
	Subject: 	Adding chris ferry is a noob
	Subject: 	Adding
	Subject: 	Adding Revision 1.93  2006/05/23 14:17:18  swain
	Subject: 	Adding backing up before bork bellies up
	Subject: 	Adding
	Subject: 	Adding Revision 1.92  2006/05/05 20:58:01  swain
	Subject: 	Adding yay friday
	Subject: 	Adding
	Subject: 	Adding Revision 1.91  2006/04/20 13:23:57  swain
	Subject: 	Adding etc etc
	Subject: 	Adding
	Subject: 	Adding Revision 1.90  2006/02/24 15:39:15  swain
	Subject: 	Adding Latest.
	Subject: 	Adding
	Subject: 	Adding Revision 1.89  2005/09/15 15:52:34  swain
	Subject: 	Adding commit!
	Subject: 	Adding
	Subject: 	Adding Revision 1.88  2005/09/09 19:50:24  swain
	Subject: 	Adding cvs commit -m
	Subject: 	Adding
	Subject: 	Adding Revision 1.87  2005/09/07 22:56:35  swain
	Subject: 	Adding Haven't checked this in, in ages.
	Subject: 	Adding
	Subject: 	Adding Revision 1.86  2005/05/23 19:04:43  swain
	Subject: 	Adding Most recent entries, before I'm off to Italia.
	Subject: 	Adding
	Subject: 	Adding Revision 1.85  2005/04/21 20:27:49  swain
	Subject: 	Adding Last entry from Pork.
	Subject: 	Adding
	Subject: 	Adding Revision 1.84  2005/04/04 15:47:00  swain
	Subject: 	Adding Latest stuff.
	Subject: 	Adding
	Subject: 	Adding Revision 1.83  2005/02/23 23:06:44  swain
	Subject: 	Adding Oh my, over two months since a commit. For shame.
	Subject: 	Adding
	Subject: 	Adding Revision 1.82  2004/12/10 21:16:25  swain
	Subject: 	Adding For week ending 12/10.
	Subject: 	Adding
	Subject: 	Adding Revision 1.81  2004/12/03 20:22:16  swain
	Subject: 	Adding Update for the week ending 12/3
	Subject: 	Adding
	Subject: 	Adding Revision 1.80  2004/11/24 20:18:42  swain
	Subject: 	Adding Checking in for the long holiday weekend.
	Subject: 	Adding
	Subject: 	Adding Revision 1.79  2004/11/17 23:06:01  swain
	Subject: 	Adding Added entry for today, covering the work of updating the MPA Gallery code base
	Subject: 	Adding to all files
	Date: 	November 17, 2004 6:01:10 PM EST
	To: 	  dev@ampira.com

$Log: LOG.txt,v $
Revision 1.1  2007/11/27 22:54:23  swain
Initial revision

Revision 1.115  2007/11/27 22:14:20  swain
updating. ing. ing.

Revision 1.114  2007/11/15 16:56:49  swain
updated: wrote up my work on refactoring and testing gallery

Revision 1.113  2007/10/31 16:09:03  swain
notes on mpp

Revision 1.112  2007/10/29 21:07:12  swain
updated

Revision 1.111  2007/08/24 17:19:49  swain
changes from kristalle

Revision 1.110  2007/08/20 20:08:40  swain
latest stuff

Revision 1.109  2007/08/20 14:53:56  swain
Last commit before moving to torque, the new machine.

Revision 1.108  2007/08/17 19:36:55  swain
updated

Revision 1.107  2007/07/18 21:59:52  swain
hello, sailor!

Revision 1.106  2007/06/11 20:45:10  swain
updated the typolesbianisms

Revision 1.105  2007/02/23 16:06:17  swain
Updates to Thur 22 2007

Revision 1.104  2007/02/10 22:41:36  swain
Most recent stuff.

Revision 1.103  2007/01/24 18:25:57  swain
There are things going bump in there.

Revision 1.102  2006/12/07 23:01:24  swain
updated instructions for adding a class..

Revision 1.101  2006/11/17 15:36:00  swain
meh

Revision 1.100  2006/10/26 22:40:24  swain
meh

Revision 1.99  2006/09/14 20:39:44  swain
list of eu countries. tired of looking that up and munging the output.

Revision 1.98  2006/08/16 14:27:46  swain
added some old conversations for posterity

Revision 1.97  2006/08/09 18:02:58  swain
it's log! it's log!

Revision 1.96  2006/07/20 18:51:59  swain
added instructions to create new product in store.

Revision 1.95  2006/07/18 22:13:46  swain
It's A. Tree! With Arthur Tree!

Revision 1.94  2006/05/23 14:55:36  swain
chris ferry is a noob

Revision 1.93  2006/05/23 14:17:18  swain
backing up before bork bellies up

Revision 1.92  2006/05/05 20:58:01  swain
yay friday

Revision 1.91  2006/04/20 13:23:57  swain
etc etc

Revision 1.90  2006/02/24 15:39:15  swain
Latest.

Revision 1.89  2005/09/15 15:52:34  swain
commit!

Revision 1.88  2005/09/09 19:50:24  swain
cvs commit -m

Revision 1.87  2005/09/07 22:56:35  swain
Haven't checked this in, in ages.

Revision 1.86  2005/05/23 19:04:43  swain
Most recent entries, before I'm off to Italia.

Revision 1.85  2005/04/21 20:27:49  swain
Last entry from Pork.

Revision 1.84  2005/04/04 15:47:00  swain
Latest stuff.

Revision 1.83  2005/02/23 23:06:44  swain
Oh my, over two months since a commit. For shame.

Revision 1.82  2004/12/10 21:16:25  swain
For week ending 12/10.

Revision 1.81  2004/12/03 20:22:16  swain
Update for the week ending 12/3

Revision 1.80  2004/11/24 20:18:42  swain
Checking in for the long holiday weekend.

Revision 1.79  2004/11/17 23:06:01  swain
Added entry for today, covering the work of updating the MPA Gallery code base
I have always found to be useful in finding out right away when
a file was last edited, and what changes it's undergone (see the
bottom of this file:
https://cvs.corp.fortunecity.com/cgi-bin/viewcvs.cgi/ampiradev/fcsignupwizard/src/com/ampira/fcsignupwizard/beans/DNAResultsBean.java?rev=1.5&content-type=text/vnd.viewcvs-markup).

Today I've been doing a lot of cleanup of the MPA Gallery code base,
$Log: LOG.txt,v $
Revision 1.1  2007/11/27 22:54:23  swain
Initial revision

Revision 1.115  2007/11/27 22:14:20  swain
updating. ing. ing.

Revision 1.114  2007/11/15 16:56:49  swain
updated: wrote up my work on refactoring and testing gallery

Revision 1.113  2007/10/31 16:09:03  swain
notes on mpp

Revision 1.112  2007/10/29 21:07:12  swain
updated

Revision 1.111  2007/08/24 17:19:49  swain
changes from kristalle

Revision 1.110  2007/08/20 20:08:40  swain
latest stuff

Revision 1.109  2007/08/20 14:53:56  swain
Last commit before moving to torque, the new machine.

Revision 1.108  2007/08/17 19:36:55  swain
updated

Revision 1.107  2007/07/18 21:59:52  swain
hello, sailor!

Revision 1.106  2007/06/11 20:45:10  swain
updated the typolesbianisms

Revision 1.105  2007/02/23 16:06:17  swain
Updates to Thur 22 2007

Revision 1.104  2007/02/10 22:41:36  swain
Most recent stuff.

Revision 1.103  2007/01/24 18:25:57  swain
There are things going bump in there.

Revision 1.102  2006/12/07 23:01:24  swain
updated instructions for adding a class..

Revision 1.101  2006/11/17 15:36:00  swain
meh

Revision 1.100  2006/10/26 22:40:24  swain
meh

Revision 1.99  2006/09/14 20:39:44  swain
list of eu countries. tired of looking that up and munging the output.

Revision 1.98  2006/08/16 14:27:46  swain
added some old conversations for posterity

Revision 1.97  2006/08/09 18:02:58  swain
it's log! it's log!

Revision 1.96  2006/07/20 18:51:59  swain
added instructions to create new product in store.

Revision 1.95  2006/07/18 22:13:46  swain
It's A. Tree! With Arthur Tree!

Revision 1.94  2006/05/23 14:55:36  swain
chris ferry is a noob

Revision 1.93  2006/05/23 14:17:18  swain
backing up before bork bellies up

Revision 1.92  2006/05/05 20:58:01  swain
yay friday

Revision 1.91  2006/04/20 13:23:57  swain
etc etc

Revision 1.90  2006/02/24 15:39:15  swain
Latest.

Revision 1.89  2005/09/15 15:52:34  swain
commit!

Revision 1.88  2005/09/09 19:50:24  swain
cvs commit -m

Revision 1.87  2005/09/07 22:56:35  swain
Haven't checked this in, in ages.

Revision 1.86  2005/05/23 19:04:43  swain
Most recent entries, before I'm off to Italia.

Revision 1.85  2005/04/21 20:27:49  swain
Last entry from Pork.

Revision 1.84  2005/04/04 15:47:00  swain
Latest stuff.

Revision 1.83  2005/02/23 23:06:44  swain
Oh my, over two months since a commit. For shame.

Revision 1.82  2004/12/10 21:16:25  swain
For week ending 12/10.

Revision 1.81  2004/12/03 20:22:16  swain
Update for the week ending 12/3

Revision 1.80  2004/11/24 20:18:42  swain
Checking in for the long holiday weekend.

Revision 1.79  2004/11/17 23:06:01  swain
Added entry for today, covering the work of updating the MPA Gallery code base
and in the last 30 minutes or so decided to add to all .php and
.inc files.

I wrote up a small Perl script which will make a backup copy of all
matching files, append the current CVS log information for that file
in a comment block, and print a shell script file called export.sh
which will copy all the modified files over the exisiting files once
I've done a lint check.

What's neat here is the PHP command line version has a lint checking flag:

[cws-1 web]$ /opt/php4/bin/php -l add_photos.php
No syntax errors detected in add_photos.php


This way I could check all the files to make sure appending to them
didn't introduce a syntax error. Here's the command sequence:


# run perl script; copies of all files are generated with a .copy extension.
./appendlogs.pl

# lint check all files ending in .copy
 for i in `find . -name \*.php -print`; do /opt/php4/bin/php -l $i; done;

# copy all the files over the originals
sh ./export.sh

# remove the copies (though mv in the last step would have sufficed)
find . -name \*.copy -exec rm {} \;

Here's a finished version:
https://cvs.corp.fortunecity.com/cgi-bin/viewcvs.cgi/ampiradev/gallery/util.php?rev=1.26.2.2&only_with_tag=CENTRALIZED_GALLERY_BRANCH&content-type=text/vnd.viewcvs-markup

Here's the Perl script. If you have a code base you want to modify,
this should do the trick.



#!/opt/perl5/bin/perl -w

use strict;

my @files = ();

open PIPE, "find . -type f \\( -name \\*.php -o -name \\*.inc \\) |grep -v CVS |"
    or die "couldn't open pipe: $!\n";

open EXPORT, ">export.sh" or die $!;

my $counter = 0;

while (my $file = <PIPE>) {
    chomp $file;
    #print "jeebus: $file\n";
    my @logging = `cvs log $file`;
#     for (my $x = 0; $x < $#logging; $x++) {
#         print "$x: $logging[$x]";
#     }
    `cp $file $file.copy`;
    open FILE, ">> $file.copy" or die "$!\n";
    print FILE "\n\n<?\n\n/*\n * \$Log\$\n";
    for (my $x = 16; $x < $#logging; $x++) {
        print FILE $logging[$x];
    }
    print FILE "\n */\n?>\n";
    close FILE;

    $counter++;
    #last if $counter > 2;

    print EXPORT "cp $file.copy $file\n";
    print STDOUT "done: $file.\n";
}

close EXPORT;


---

Whew. Lots done today. Tagged the version we last rolled out (MPA
Gallery). Meeting with Zlatin and Chris on hardware/software needs the
next three months. Another with Trevor and Chris about the interface
of OSCommerce to the printer. Then a schema discussion for all aspects
of MPA. Finally all the coding after that.

When I'm here this late, I feel the need to move to the corner cube
since the lights hurt my eyes.




#########################################################################
041118 Thursday

Solved the nakedcowboy.myphotoalbum.com problem today: it's an old
site out of sync with CVS. The issues were:

1. login.php, ampira.local.php, fxfoto-login.php were out of date. Any
   code doing auth needed updating.
2. user.local.php had the old username; Tim changed these.

I emailed Jessy asking for a list of the sites that are known to be
custom standalone sites.

Met with Kurt and went over the roadmap, explaining the items I wanted
to add. It went very well. Rolled out Gallery to production: this has
Ronny's changes that fix emailing the admin password, etc. Then
struggled with Excel and added/modified items. Peter was very happy
with it. Gonna meet with Ferry shortly to write out a job description
for the AcitiveX person we want.

I moved the current copy of Gallery aside on pork and rolled out the
linkless version. I think I'm ready to test the provisioner. The
config.php will come out wrong.




#########################################################################
041119 Friday

Figured out how to extract metaglobal variables... Apache SetEnv
directive.

SetEnv MPA_GALLERY_ROOT
/opt/evw/var/webs/virtual/m/my/myp/www.myphotodevel.com/web

To render:

foreach ($_SERVER as $key => $val) {
    echo "<h3>$key: $val</h3>";
}


Can't complete the work on this for now, as it's causing Trevor
headaches. Ultimately the store cannot live in the same namespace, per
se, as the user sites.




#########################################################################
041122 Monday

Dealt with a child porn issue this morning. The most I could do was
coordinate; Tim moved the Apache logs off somewhere, so he'll get to
do the searching. I hope they understand what they are looking for in
the logs.




#########################################################################
041123 Tuesday

So... yesterday met with Chris and reviewed a stack of resumes. Kurt
wants to interview them first, then have them sign the NDA, but that
sounded backwards to me: NDA, bid, hire, I think. Was still
conflicting with Trevor on the linkless testing, had to roll back
development; so I think I'll try to do this on staging since the
change is quite trivial. Five lines in httpd.conf.

I updated the scripts to pull data from the front end; borgcube was
configured to use devil for DNS, and devil thought myphotoalbum.com
lived on 10.1.1.209!

Morning MPA meeting went well. Got my vacation put off until next
year. I'll have four weeks next year.

Helped Tim for a while after lunch trying to solve a SQL
puzzle. Avalon had the answer: temp table.

Then crunch time and I got linkless Gallery working on
staging. Finally! Victory!




#########################################################################
041124 Wednesday

Peter wants the weekly dev report today... I neglected to send one
last Friday. I emailed dev asking for week ending summaries.

Ron asked if we should tag the mpa signup wiz based on the date of the
last release; I did this; it turned out to be a lot easier than I
remember, and I figured it out just by typing 'cvs tag' and reading
the help message.




#########################################################################
041129 Monday

Did some thinking over the weekend about sundry issues for MPA. One
idea, which is probably a flight of fancy, is to write Perl classes
that are compatible with their PHP originals: User, Image, Album,
etc. They would read the .dat file and reconstitute accordingly.

I was pulling apart some dat files on Wednesday. Oh, my email to Peter
was warmly received, so I'm on the right track with that. Anyway,
here's the notes from that bit of object/taffy pulling:

[snip]

// here is the original session string:

gallery_session_ef27176a4bbd57027f62cee47b4908d3|O:14:"gallerysession":7:{s:7:"version";s:5:"1.4.2";s:9:"albumName";s:7:"album01";s:13:"offlineAlbums";a:0:{}s:8:"username";s:0:"";s:7:"offline";b:0;s:10:"viewedItem";a:1:{s:7:"album01";a:1:{s:8:"P1010006";i:1;}}s:9:"albumPage";a:1:{s:7:"album01";i:1;}}


// Gallery session ID is first.

gallery_session_ef27176a4bbd57027f62cee47b4908d3

// separated by a pipe, then the object name. 'gallerysession' is defined in session.php.

|

// '14' is the number of characters in the class name.
O:14:"gallerysession":

// it has seven key/value pairs, resulting in 14 items at the top level. Some items are arrays themselves.

7:{
   s:7:"version";
   s:5:"1.4.2";
   s:9:"albumName";
   s:7:"album01";
   s:13:"offlineAlbums";
   a:0:{}
   s:8:"username";
   s:0:"";
   s:7:"offline";
   b:0;
   s:10:"viewedItem";
   a:1:{
      s:7:"album01";
      a:1:{
         s:8:"P1010006";i:1;
      }
   }
   s:9:"albumPage";
   a:1:{
      s:7:"album01";i:1;
   }
}

// before login:
gallery_session_13af5b010fcac4e2061185b5ebf600e0|O:14:"gallerysession":6:{s:7:"version";s:5:"1.4.2";s:13:"offlineAlbums";a:1:{s:10:"albums.php";b:1;}s:8:"username";s:0:"";s:7:"offline";b:0;s:9:"albumName";s:0:"";s:13:"albumListPage";i:1;}

// after login:
gallery_session_13af5b010fcac4e2061185b5ebf600e0|O:14:"gallerysession":6:{s:7:"version";s:5:"1.4.2";s:13:"offlineAlbums";a:1:{s:10:"albums.php";b:1;}s:8:"username";s:5:"admin";s:7:"offline";b:0;s:9:"albumName";s:0:"";s:13:"albumListPage";i:1;}


[snip]

Jessy needs the sample sites updated. I called Ferry and spoke about
dev needs from ops; Ronny is waiting on XML::Twig.

Dealt with a few user config issues on the frontend. I'm afraid we're
seeing file system errors again.

For usinwa.com, which I've been handling personally for a while, I
duplicated their problem by raising either IE's security or its
privacy settings.

Notified Ferry that we might be seeing filesystem I/O errors again.

In reverse order:

/setup/fcindex.php: 54
/setup/index.php: 55
/add_photos.php: 80
/save_photos.php: 126
/myphotoalbumlogin.php: 145
/captionator.php: 156
/view_photo.php: 287
/gallery/albums.php: 350
/create_user.php: 422
/user_preferences.php: 785
/manage_users.php: 1377
/view_album.php: 1750
/setup/shortform.php: 2668
/progress_uploading.php: 8971
/login.php: 12067
/albums.php: 84951
/index.php: 835870

This spans the period from Nov. 11th to the 29th on mpa-1.

Files included by the top 3:

index.php: only includes albums.php
albums.php: only includes init.php
login.php: init.php and user.local.php

On the second level of includes:

[cws-1 gallery]$ egrep "include|require" init.php
require($GALLERY_BASEDIR . "Version.php");
require($GALLERY_BASEDIR . "util.php");
	include($GALLERY_BASEDIR . "platform/fs_win32.php");
	include($GALLERY_BASEDIR . "platform/fs_unix.php");
        include($GALLERY_USERDIR . "config.php");
require($GALLERY_BASEDIR . "classes/Album.php");
require($GALLERY_BASEDIR . "classes/Image.php");
require($GALLERY_BASEDIR . "classes/AlbumItem.php");
require($GALLERY_BASEDIR . "classes/AlbumDB.php");
require($GALLERY_BASEDIR . "classes/User.php");
require($GALLERY_BASEDIR . "classes/EverybodyUser.php");
require($GALLERY_BASEDIR . "classes/NobodyUser.php");
require($GALLERY_BASEDIR . "classes/LoggedInUser.php");
require($GALLERY_BASEDIR . "classes/UserDB.php");
require($GALLERY_BASEDIR . "classes/Comment.php");
    require($GALLERY_BASEDIR . "session.php");
	include ("${GALLERY_BASEDIR}errors/$gallerySanity");
        include($GALLERY_BASEDIR . "classes/Database.php");
		include($GALLERY_BASEDIR . "classes/postnuke/UserDB.php");
		include($GALLERY_BASEDIR . "classes/postnuke/User.php");
		include($GALLERY_BASEDIR . "classes/postnuke0.7.1/UserDB.php");
		include($GALLERY_BASEDIR . "classes/postnuke0.7.1/User.php");
	    include($GALLERY_BASEDIR . "classes/database/mysql/Database.php");
	    include($GALLERY_BASEDIR . "classes/nuke5/UserDB.php");
	    include($GALLERY_BASEDIR . "classes/nuke5/User.php");
		include($GALLERY_BASEDIR . "classes/nuke5/AdminUser.php");
	include($GALLERY_BASEDIR . "classes/gallery/UserDB.php");
	include($GALLERY_BASEDIR . "classes/gallery/User.php");
	include($GALLERY_BASEDIR . "upgrade_users.php");
			include($GALLERY_BASEDIR . "upgrade_album.php");
    include($GALLERY_BASEDIR . "ampira.local.php");

Here is where the real meat is... and here we'd have to be more
selective, perhaps.


Handled issue with Tim about turning off error logging on
production. He thought noone cared; the logs were 2GB.

Been tweaking the sample sites. Curious: can't logout of sample1:

Warning: Cannot modify header information - headers already sent by
(output started at /mnt/nfs-1/mpa1/web/mpa/conf/gallery.mysql.conf:10)
in
/mnt/nfs-1/mpa1/web/s/sa/sam/www.sample1.myphotobuddy.com/web/do_command.php
on line 83




#########################################################################
041130 Tuesday

10am meeting went OK. Tim blew away the archived sites he set aside
from the data xfer a few weeks ago; that freed up a lot of space and
we shouldn't see any errors for a few days. I wrote a script to
generate a new userdb.dat, and had Ronny write a script to decompose a
given dat file. I'm working on solving the "these are not albums"
error now. It's not in albumdb.dat. That file is tiny and only lists
which directories are albums. Ones Gallery claims "are not photo
albums" still appear in albumdb.dat.

I'd guess that the AlbumDB class holds Album objects for each
directory, and the message results when the album cannot be loaded. It
probably has to be loaded to fetch the highlight.

For every file 'album.dat' print the first several chars:

for i in `find . -name album.dat`; do echo " $i"; head -1 $i | perl -ne 'm/^(...................)/; print "$1\n"'; done

Had a long conversation with Tim. Got him to enter a bug in Bugzilla!
We looked over linkless Gallery and had no issues with it. Tim wants
to do a rewrite for the image request though... and on top of that
wants to eliminate ndbm before moving to linkless gallery, but I think
that might just take too long. Mostly it came down to him having to
rewrite bits of log crunching code. He owes me an email detailing what
he wants to change about linkless gallery.

Pitched an idea to Kurt that we could rotate the ads as the slideshow
runs, but he has other ideas (partnering with a few key sponsors) to
make this work.

Am having a conversation on Avalon about the 20K directories problem
(the 3 vs. 5 issue).

(Old conversation on CVS merging pasted below.)

merging stuff

http://cachingup.myphotoalbum.com/fxfoto-login.php?uname=cachingup&password=cachingup

http://cachingup.myphotoalbum.com/fx_add_photo.php

http://cachingup.myphotoalbum.com/ampira.redirect.php?uname=cachingup&password=cachingup

http://localhost/~swain/uploadTest.html


needfiles:
dave.myphotoalbum.com  djursjukhusetimalmo.myphotoalbum.com  tutti.myphotoalbum.com

You say, "we are running Gallery, 1.4.2 with a lot of modifications"
You say, "and Gallery 1.4.4 is out now"
You say, "i'm thinking of how, going forward, i can merge the two..."
You say, "and right now i'm thinking maybe i should create a branch in our CVS 
and check in 1.44 there. then perhaps try to merge the two."

/dev/null>merlin [to Wainstead \]: i'd suggest grabbing a virgin 1.4.2, doing 
a diff to create a patch set between it and your hacked 1.4.2, then try 
applying those patches to 1.4.4. thats how i did avalon's moo 1.7.something -> 
1.8.1 and kept our hacks in tact without going insane
-'-merlin-,-{@ orates, "it'll also help you fully understand whats been 
"customized" on your 1.4.2 install"
((merlin)) enigmatically intones, "applying 1.4.4 against your hacked 1.4.2 
will create lots of conflicts you wont necessarily understand without 
investigation where as applying the changes you (or people there) made on 
1.4.2 will be more understandable"



Wainstead \ [to .oO(merlin)]: can cvs generate the patch for me?
the honorary linebacker edwin [to Wainstead \]: we have a back patching tool!
the two shots of nyquil edwin says, "it calculates the delta"
the multi-layered edwin says, "and applies it to whatever you want."
the pen hunting edwin says, "james and greg wrote it. very handy."
-[merlin]- [to Wainstead \]: yup, this is for cocoon, but it applies to you 
when it gets to the cvs diff -u stuff: 
http://cocoon.apache.org/2.1/howto/howto-patch.html
[merlin@avalon.org]$ [to Wainstead \]: something like "cvs diff -u -r 
vOriginal -r HEAD code" if you have a tag on the original 1.4.2 stuff called 
vOriginal


http://www.loria.fr/~molli/cvs/doc/cvs_5.html
http://cvsbook.red-bean.com/cvsbook.html#tag
http://cocoon.apache.org/2.1/howto/howto-patch.html


Finished fixing the sample sites for Jessy. They've been hosed since
the filesystem issues in August.




#########################################################################
041201 Wednesday

It was not feasible to reconstruct the dat files for the sample sites
programmatically, or even hand editing the dat files. For now the only
answer to a lost album (if the photos are still there) is to move the
images into an upload directory, change add_photos.php so it has the
ftp box in the botton (like voteheisman.mpa.com) and use that
mechanism to recreate the album.

Checked borgcube; stats data loading correctly for the last
week. Cleaned out my home dir.

Chilly turned me on to memcached. Looks really useful to us.

Had a short productive planning meeting with Trev and Ronny. Trev ran
it mostly; we went over the needed infrastructure for moving orders
from production to a local system.

Ronny has been doing tickets today. Support is behind.

Rolled back staging to linked Gallery; I decided we'd stick with five
character account names. This decision was made by Tim in August and I
don't feel it's worth the effort to revive it. I hate arbitrary
limits as much as anyone... disallowing hyphens is wrong, imo.

Spent a long time on the phone with Tim as well, helping him do CVS
commands for the first time. He seemed to pick it up right away.




#########################################################################
041202 Thursday

Met with Jessy, Kurt, Peter this morning to plan the new app
features. It's pretty basic stuff. It introduces the new problem of a
myphotoalbum.com user, who is not a customer, is not a subuser, is not
a customer. Intruiging. Peter reiterated his wish to clear out all
other work and get the dev team focused on MPA. 

Trev and Ronny like the idea of an internal blog for us to write in
every day.

Played with flickr.com today; emailing photos looks to be a snap. I
suppose I could write a Mac client in my spare time. It would be a
little Cocoa app.

I rolled out the new DeriveUserDirectory function to prod for Tim;
this creates five levels deep directories. I need to work on a
mod_rewrite now.

Yay! I lucked out a bit on solving the mod_rewrite problem. There was
an example on the document page that showed how to do almost exactly
what we want to do. Part of the trick was to concatenate the HTTP_HOST
into the URI.

RewriteEngine on
RewriteLog logs/mod_rewrite_log
RewriteLogLevel 9

RewriteCond   %{HTTP_HOST}                 ^splinter.nyc.fortunecity.net$
RewriteRule   ^(.+)                        %{HTTP_HOST}$1          [C]
RewriteRule   ^(.)(.)(.)(.)(.) /home/swain/public_html/$1/$1$2/$1$2$3/$1$2$3$4/$1$2$3$4$5/hello.html



#########################################################################
041203 Friday

OK, hammered out the first working version of the mod rewrite rule:

RewriteCond   %{HTTP_HOST}                 ^(.*)\.myphotostage.com$
RewriteRule   ^(.+)                        %{HTTP_HOST}$1          [C]
#RewriteRule   ^(.)(.)(.)(.)(.)(.*).myphotostage.com(.*)$ /opt/mpa/sites/$1/$1$2/$1$2$3/$1$2$3$4/$1$2$3$4$5/$1$2$3$4$5$6$7
RewriteRule   ^(.)(.)(.)(.)(.)(.*).myphotostage.com(.*)$ /opt/evw/var/webs/virtual/$1/$1$2/$1$2$3/$1$2$3$4/$1$2$3$4$5/$1$2$3$4$5$6$7

Initially I tried to move all the config stuff around, as Tim pointed
out it should all be in the vitual conf file for mpa. But this just
made a mess and I had to undo it. It turns out production and devel
are set up the same way, so I left it.

I also found that hotlinking didn't work for no referer. Worked out a
solution to that. Interviewed two guys today for the ActiveX project;
first was eh, second was pretty good.

Zen Cart and x-cart are mentioned as competitors to osC. Zen Cart gets
poor marks for codebase though; apparently it's just a hacked up osC.


#########################################################################
041206 Monday

Sent my todo list. Also drew up a schedule for vacation days; by
chance someone will be here every day over the holidays. I also note
here that lpr in emacs works again on my mac but ical makes a prettier
calendar.

usinwa.com have been having problems again. It might be SP2 causing
problems. I have half a mind to move them to a newer free site and
have their $ refunded.

10am was moved to 11am. Rob needs Ronny for some stuff relating to
Platypus bugs, but according to Chris they are minor things. Trev and
Ronny estimate sneakernet might be in testing by tomorrow: Trev lists
two items as blockers: 1. Product attributes are not being passed to
Paypal, and 2. thumbnails are not showing on development.

Phillip Smith found the ActiveX control was already available for
licensing, asking $100 for his research. For about $700 per IP address
we can license the control. This is neat because we can go right to it
now.

I think I'll leave the config.php alone after all. It's not updated
much. So by extension we'd only want searchable items in Mysql, plus
users. That would winnow it down to the Images class and User class.

Picked apart userdb.dat. Note that it only defines the static user
types NOBODY, EVERYBODY, and LoggedUser. I defined two users, crusoe
and friday, and they only show in the usermap. Intriguing,
captain. Also note the subusers are defined in the common Gallery
scheme of Epoch time plus hash.

O:14:"gallery_userdb":5:{
    s:7:"userMap";a:10:{
        s:5:"admin";
        s:21:"1100548322_1920879344";
        s:21:"1100548322_1920879344";
        s:5:"admin";
        s:6:"crusoe";
        s:20:"1102364189_289639879";
        s:20:"1102364189_289639879";
        s:6:"crusoe";
        s:9:"EVERYBODY";
        s:9:"everybody";
        s:9:"everybody";
        s:9:"EVERYBODY";
        s:8:"LOGGEDIN";
        s:8:"loggedin";
        s:8:"loggedin";
        s:8:"LOGGEDIN";
        s:6:"NOBODY";
        s:6:"nobody";
        s:6:"nobody";
        s:6:"NOBODY";
    }
    s:6:"nobody";
    O:10:"nobodyuser":7:{
        s:8:"username";
        s:6:"NOBODY";
        s:8:"fullname";
        s:6:"Nobody";
        s:8:"password";N;
        s:5:"email";N;
        s:7:"isAdmin";
        b:0;
        s:15:"canCreateAlbums";
        b:0;
        s:3:"uid";
        s:6:"nobody";
    }
    s:9:"everybody";
    O:13:"everybodyuser":7:{
        s:8:"username";
        s:9:"EVERYBODY";
        s:8:"fullname";
        s:14:"Anonymous User";
        s:8:"password";
        N;
        s:5:"email";
        N;
        s:7:"isAdmin";
        b:0;
        s:15:"canCreateAlbums";
        b:0;
        s:3:"uid";
        s:9:"everybody";
    }
    s:8:"loggedIn";
    O:12:"loggedinuser":7:{
        s:8:"username";
        s:8:"LOGGEDIN";
        s:8:"fullname";
        s:14:"Anonymous User";
        s:8:"password";N;
        s:5:"email";N;
        s:7:"isAdmin";
        b:0;
        s:15:"canCreateAlbums";
        b:0;
        s:3:"uid";
        s:8:"loggedin";
    }
    s:7:"version";
    i:5;
}

To break this down and indent it nicely, 

replace-regexp \([;\}]\)\([Osib]\): with \1^q^j\2:

There should be a simple way to debabelize with a function, working on
a region, switching to sh-mode to indent the region. Perhaps narrowing
will help. I'm also slightly puzzled by the use of stdClass(), which
is an internal Zend function that isn't documented anywhere.

#!/opt/php4/bin/php
<?php

$foo = new stdclass();

echo get_class($foo);
echo "\n";

?>

prints "stdClass."

Also: any object or array prints out in this loop.

echo "gallery:\n";
foreach ($gallery as $key => $val) {
    echo "$key: $val\n";
}


I checked in a script that, run in a Gallery root directory, can
access the objects. This would be the basis for migrating any data to
the database.

Hmm. How about: whenever the user updates an album or image, we write
that to special tables in mysql? And searches just ref the page? That
is, limit searches to just the database. 


#########################################################################
041207 Tuesday

So... last night I had quite a thrill when I did a rollout on
development for Trevor and Ronny; I created a new site, uploaded pix,
selected one to buy, and when I landed in the store the pix I selected
last week from a different site were present. I gave credit to both of
them for their work so far, and Trevor for staying late on Friday to
do Conway Stewart stuff.

Fixed two user problems today for Kurt; gotta look at usinwa.com on
the XP box.

Intermittently been reading about PHP and sessions. Testing a GPL
class for doing sessions in mysql; so far it's simple to use, because
no configuration changes are needed. In theory we'd only need to
change the session.php file in Gallery to convert.

http://www.code.dearneighbor.com/ is the site from where db_eSession
comes from.


#########################################################################
041208 Wednesday

Overnight, 56 reports of PHP crashing from Turck on mpa-2; but 17,000+
segmentation faults from Apache.

So, found a thread that said to turn off the optimizer. That seems to
have done the trick. Somehow moving to the emc the ndbm file got
corrupted... Ferry has been cursing, mostly at Tim for the state of
the custom sites. These should have been moved to virtual host files
and separated long before anything else happened. Oh well... I sent
that email two days ago. He was complaining about two sites not
showing up, but they have no PHP files when I look in the new tree.

Ronny just showed me the first burned disk! I've started him on Kurt's
task to find a new BBS for support forums.

Chris now reports rsync is fixing all the hardlinks. Good news.

                                   


#########################################################################
041210 Friday

Busy busy times. Chris cut over to the EMC on Wednesday; and we
eliminated the NDBM file via mod_rewrite; and we re-enabled Turck
MMCACHE.

In turn, I found via Google a suggestion to disable optimization of
PHP in Turck. This solved the problem with PHP crashing, at least for
a while. Overnight it started segfaulting at the suspicious number of
3700 times per hour (3600 being the number of seconds in an
hour). Chris cron'd a script to gracefully restart every hour.

The changes to hotlinking were not necessary; apparently we allow
direct calls to an image. A comment block would have prevented all the
work I did changing the rewrite rules. Or else I should have asked.

The xfer was severely botched, and I note here that I insisted Ferry
redo the rsync from scratch and he refused... so we spent a lot of
time fixing places where it broke. One severity was the hardlinking
was all ruined, with dozens of ghost trees floating around the
filesystem. I had to write a Perl script, now in CVS, which took about
seven hours to run, to rm the files in every site and link to the main
tree. What a mess.

Ronny has been doing a lot of support tickets this week. Trevor set up
the store on staging yesterday; I made sure the latest greatest MPA
gallery was up. I rolled out some minor changes yesterday: no more
password fields in the shortform, robots.txt and favicon.ico for all,
and the new hardlinks.txt file. When I ran the link fixing script all
sites got copies of these. This should reduced error log clutter in a
big way.

Looking over the error logs, they are very clean this morning. If we
turn off Turck debugging we'll save hundreds of MB.

Tim thinks we are having some kind of memory problem on mpa-2. He's
seen signups fail for wrong reasons. I seem to recall seeing similar
wonkiness yesterday (Wednesday?) when Chris cut over to the emc.

Tim found that fx_add_photo.php wasn't updating last_updated. Rolled
out a fix. swain.myphotoalbum.com wouldn't show the change; other
sites do. Weird.

Bugger. swain is an orphan site, as well as johnny1985. Fucking
hardlinks.


#########################################################################
041213 Monday

Over the weekend, users were getting other user's config.php
files. This probably happens because config.php gets cached and when
users call up the shortform... maybe they get that config.php's
variables, which are for some other site. But if that's true, we'd see
widespread issues in just viewing. So then it might be at the time the
data gets written out that it goes to the wrong filesystem.

Finished the script I started on yesterday that prints out a chart of
broken sites and their numbers. It's scanConfig.pl. Also wrote
fixConfig.pl, a looping version of regenConfig.pl.

Ronny is working on PHPBB, Trevor on the shopping cart. I should get a
todo list out.

Fixed the bug #545, where users saw the error message when they logged
in. Root cause was Gallery does isset($invalid) so no matter what the
value was, it evaluated true. All they needed was (isset($invalid) &&
$invalid == true) or somesuch; but it'd be even clearer if the wording
read (isset($isValid) && $isValid == false). But it works now.

Ran scanConfig.pl again and again; since 130pm we've seen another 5
botched configs, and I ran fixConfig.pl to reset them.

Tested usinwa.com on the XP box, no problems. Replied to their email.

Talked over the navigation with Jessy. I don't want to store sessions
for the nobody users, since that would be a huge waste of database
requests. I don't see a real need for it unless they login... but
then, perhaps it's a common thing.


#########################################################################
041214 Tuesday

Came in to an evaluation form on my chair for Ronny. Usinwa.com
replied that they can login but they can't upload. At least she
outlined the steps... IE crashes on them for some reason. I need to
get my todo list out. Also, it seems we need more dev environments on
development for MPA.


#########################################################################
041215 Wednesday

Whew. Busy busy still. I've been trying to help Trevor with bugfixes
with the MPA store. I'm so fried now I can't remember what I did since
the meeting yesterday... I've been doing battle with the PHP caching
stuff, fixing sites as they get borked. Chris might have that wrapped
up now since we switched to PHPA. I ran a new count of themes used by
users for Jessy, rolled out the new holiday themes, answered lots of
questions by Ronny, talked with Tim at length... late yesterday was
taken up trying to solve the parse error with view_album.php. When I
finally got back to that point today I just checked in Trevor's copy,
then fixed the javascript bug. The problem was JS returns just an
element when there's only one check box instead of an array with one
element. So much for zero, one, infinity.

Ronny did tickets most of this week. I set up
exlodingdietcokes.mpa.com. Trevor got pulled into conway stewart again
but it turned out to be a replication error between the two Mysql
servers.


#########################################################################
041216 Thursday

Had a planning session with Ronny, Trevor and Chris on the database
schema. Things are looking good. The idea is to move to email address
as login, which OSCommerce already does. This would solve a raft of
problems including subusers with multiple names.

Regarding sessions: we only track sessions for logged in users. That
should greatly reduce the number of sessions. The steps there would
be:

1. Only store sessions for logged in users
2. Move session data to Mysql
3. Write Perl class to handle session data

The will power is there to move all users into one table... owners,
subusers, customers. This would mean:

username is not unique, can be empty
email address is unique, not null, no default value
site name is unique, has one userid as owner
users_sites maps users to sites, including subusers
users_sites can have multiple entries for a given user (a user can
belong to more than one site)

A thought: write a PHP script to visit every single userdb.dat and
compile a list of email addresses.

For each class in Gallery, add a db_save() method to call in place of
save(). This new method will write to the database.




#########################################################################
041217 Friday

What a rippoff. I got up on time but the E train ran slower than a
snail. 


----------------text pasted by Wainstead \ to Emrys' Tavern----------------
Steve Wainstead: how goes it?
Steve Wainstead: you got a store to work on?
Jessy Hanley: I was workin on the prok
Jessy Hanley: party
Jessy Hanley: pork
Jessy Hanley: part
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
Wainstead \ . o O ( ... )
the underwater camera mooning heller . o O ( she was working on partying with 
the pork? )
zahn [to Wainstead \]: lol!
draco . o O ( porking the party )
zahn . o O ( she really must've had pork on the brain... )
suck me, beautiful, heller . o O ( your part is to give her a porking at the 
party?  )
zahn . o O ( and if she calls out the wrong name, don't be surprised... )
zahn [to Wainstead \]: think she might be a bit dyslexic?
back to save the universe DrDaByGoD [to zahn]: <ackbar>it's a part</ackbar>



----------------text pasted by Wainstead \ to Emrys' Tavern----------------
Jessy Hanley: do you know the map team photoalbum
Jessy Hanley: ur;?
Steve Wainstead: map team?
Jessy Hanley: map?
Jessy Hanley: nope
Steve Wainstead: i don't even know what that site is
Jessy Hanley: ites office photos
Steve Wainstead: oh
Jessy Hanley: I was going to add mine from the ski trip
Jessy Hanley: would be fun to ahve one for the whole office
Jessy Hanley: I know kurt set one up
Jessy Hanley: for the team
Steve Wainstead: did you mean mpa team?
Jessy Hanley: yea
Jessy Hanley: the mpa
Steve Wainstead: doh!
Jessy Hanley: hee hee
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
chilly_willy [to Wainstead \]: you mean you don't have a team that creates 
maps?
Wainstead \ [to chilly_willy]: we do. but they were poor mapmakers, and they 
got lost somewhere, never to be found. they're still on the payroll though.
chilly_willy [to Wainstead \]: not a bad job :)
chilly_willy [to Wainstead \]: you don't show up, and still get paid :)


It would seem the key here is to place the DB_eSession object into the
$gallery->session spot.

Meanwhile... it would appear Gallery only accesses session data via
$gallery->session. This object, in our case, is the stdClass(). One
possible hack would be to alter DB_eSession to allow the form:

$gallery->session->somevariable = "foo";

and any call ... no, I was thinking if the variable doesn't exist we
could set it and vice versa. I don't think PHP has that functionality,
much like Perl does the AUTOLOAD business which would make that
possible.

Whipped up the Programming Perl example for AUTOLOAD. This is not the
solution. I think the answer is to revise all calls to
$gallery->session. One downside is the expense of calling a subroutine
on a nested object. Alas.

Hmm. Rather than hand edit all the files, a Perl script could apply
the code change for me.




#########################################################################
041220 Monday

Ran late today: alarm clock was hosed by power outage, then E train
took forever. Got here just before 10am. Am aching from two days
backbreaking hard labor for landlady.

Skimmed an article in Dr. Dobb's that contained an interesting idea:
converting an app from using the Java Vector class to a new ArrayList
class. The intermediate step was to create a custom Vector class that
extends ArrayList, convert to that, then refactor to eliminate the
Vector class, slowly changing over to ArrayList and finally dropping
the custom Vector class. Refactoring, then, can pose some fun problems
to solve.

This might seem to apply to my problem with sessions. I could change
the class used for Gallery sessions, but retain the current
behavior. I had a similar idea last week but it wasn't fully realized.

DB_eSession cannot be tested from the command line. It bitches about
missing Apache stuff, and it cannot send headers. I did find, however,
one can add new scalars at will to PHP objects:

$foo = new stdclass();

echo get_class($foo);
echo "\n";

$foo->key = "value";
echo "object as hash? eh? '" . $foo->key . "'\n";

Not so surprising, since it's a dynamically typed language.

grep-find for all uses of the string 'session' minus the top level
'session' directory I created:

find . -type f \( -name \*.inc -o -name \*.php \) -print0 | xargs -0 -e grep -n -e session | grep -v 'session/'




This seems to be the list, thus far, of things in the session class
(or might be):

$gallery->app->sessionVar = "gallery_session";
$gallery->session->language = "";

$sessionVar = "gallery_session_".md5(getcwd()); 

$sessionVar = $gallery->app->sessionVar . "_" . md5($gallery->app->userDir);

$gallery->session->version, $gallery->version)) {

$$sessionVar = new stdClass();
$$sessionVar = new GallerySession();

$gallery->session =& $$sessionVar;

$args['PHPSESSID']=session_id();
$args['PHPSESSID']=session_id();

$gallery->session->albumPage[$gallery->album->fields['name']])) {

$page = $gallery->session->albumPage[$gallery->album->fields["name"]];

$gallery->session->albumPage[$gallery->album->fields["name"]] = $page;

$fullOnly = (isset($gallery->session->fullOnly) &&

$gallery->session->fullOnly, 'on') &&

$do_fullOnly = isset($gallery->session->fullOnly) &&

$gallery->session->albumPage[$gallery->album->fields['name']] = $page;

albumListPage
username
albumName
offline


I don't find any way of iterating over an object's fields and
functions, unless there's a hidden magic Zend function to do this.

I added this:

<?php

foreach ($gallery->session as $key => $val) {
    stderr("session: $key: $val");
}


?>

and found this:

session: version: 1.4.2
session: offlineAlbums: Array
session: username: admin
session: offline: 
session: albumName: album01
session: albumListPage: 1
session: viewedAlbum: Array
session: viewedItem: Array
session: albumPage: Array

Unsurprisingly, one only need use get/set on the vars and it's all
transparent. I've done a lot of exploratory work today but really it
could have been skipped and I would have guessed right in the
beginning.

Just encountered a strange bug where I could not set session vars. I
blew away the table and that fixed it. That, however, should not
be. It is possibly related to a timeout of some kind.


#########################################################################
041221 Tuesday

930am, meeting with Kurt, Jessy and Trevor. They decided the store
could launch the 17th with a week of testing. Peter was in a
conference call with the board so there was no MPA meeting.

I had Trevor give me details on making a change to OSCommerce and
through some hacking I worked it out... found a small bug where he was
not passing in {txt_5}, he fixed it, and everything worked. I created
a link that Jessy can turn into a button for "Continue Shopping." I
filed a bug for not having "Select All".

I then went back to hacking at the session stuff. I finally got the
logic right which was kinda tricky; I understand the interface a
little better. One file handles creating a brand new session; the
other sends the user to that file when the session is dead. We know
about the dead session because of this:

// if 'count' is not in the session anymore the default '0' is returned...
$count = $sess->getSessVar('count', 0);

// and if it's zero, the session expired, so we send user to preswain
if ($count == 0) {
    session_destroy();                   // Delete session created (new DB_eSession)
    header("Location: preswain.php");
    exit();
}

So now it works. I have to apply some brain power to figure out if
this works with Gallery or not.




#########################################################################
041222 Wednesday

More Conway Stewart issues. Zlatin hoarked the databases again. Chris
was beside himself this morning.

Peter called a meeting on next year's plans.


AIM IM with jessyhanley
11:38 AM
Jessy Hanley: I dant seem to connect to bugzilla
Steve Wainstead: lemme try
Steve Wainstead: works for me
Jessy Hanley: hmm
Jessy Hanley: I can't get to prok either
Jessy Hanley: timing out
Jessy Hanley: pork.mpa
Jessy Hanley: the sftp
Jessy Hanley: I mean
11:40 AM
Steve Wainstead: lemme try
Steve Wainstead: also works for me
Jessy Hanley: that is werid
Jessy Hanley: I can get to otehr sites
Jessy Hanley: thoguh
Steve Wainstead: did you hoark your hosts file?
Jessy Hanley: didnt touch it
Jessy Hanley: all good
Jessy Hanley: let me stop streaming mucis
Jessy Hanley: think tha twoudl do it?
Jessy Hanley: nope
Steve Wainstead: streaming mucus? that shouldn't affect your network.
11:45 AM


Figured out how to enable the $lastAlbumViewedURL in the templates for
OSC. The trick was just to add a key/value to an array, which is later
interpolated. Kinda dumb to use $variable for your template variables
versus %%variable%%. Combed over all the recently updated MPA sites.

Chris has had a lot of trouble from Zlatin lately, Zlatin sent around
a huge email detailing all actions viz CS over the last week.




#########################################################################
050103 Monday

Got MPA Gallery and the store rolled out on both devel and
staging. Met with Tech, met with Chris; fixed bug #584; wrote a
rollout script for the store. Also tweaked the album library tab in
the store for Jessy. Going to look at a spreadsheet for Hostopia.


----------------text pasted by Wainstead \ to Emrys' Tavern----------------
Revision 1.52 / (view) - annotate - [select for diffs] , Wed Dec 22 19:44:36 2004 UTC (11 
days, 22 hours ago) by jhanley
Branch: MAIN
Changes since 1.51: +11 -4 lines
Diff to previous 1.51 (colored)

added variable to make shopping cart go to teh right url that i sin the conf file
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
cr@ckh3@d [to heller]: but i sold my pipe.  and i'm tired of taking my crack in 
suppository form...
You say, "hanleyisms everywhere. "
draco . o O ( that i sin )
heller . o O ( she sins the conf file? kick ass!  )
xorian . o O ( We'd all like to see her sin, but probably not with the conf file )
tiResias . o O ( some of us aren't that picky )
darky [to tiResias]: haha.
Wainstead \ . o O ( teh sin )
xorian . o O ( OTOH, since it was her typing, who knows what "conf
file" really means )

----------------text pasted by Wainstead \ to Emrys' Tavern----------------
Jessy Hanley: upsated a bug and assiend it to you
Jessy Hanley: its.... # 587
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
Jessy Hanley: I lied = 584
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
You say, "hahahahaha"
[to Wainstead \] heller laughs "I was going to tell you to double check and make sure 
that's the number she meant. 
Wainstead \ [to heller]: i was already thinking that :o)
heller [to Wainstead \]: you need an automated message for messages she sends you. ''are 
you sure you typed what you meant?''




#########################################################################
050104 Tuesday

find . -type f |grep -v CVS | xargs egrep -i "select|delete|update" | egrep "accounttotals|banlist|blacklist|decodetable|eSessions|messages|photouploads|users|userstats"


#########################################################################
050106 Thursday

Yesterday: did rollouts, did a lot of testing and filed several
bugs. We did our first standup meeting. I also did the email form for
Jessy on Tuesday; Tuesday afternoon I factored the table names out of
the signup code.

Did some bug fixing and feature enhancements... solved the big
blocker, the broken javascript in IE and Safari, which was caused by
Jessy copy/pasting the buttons in a second time on view_album.php. One
careless act meant almost a day lost in testing.

Got the word from Peter to work solely on the migration tomorrow.


#########################################################################
050118 Tuesday

Bah. Too long since any entries.

New plan: at the start of a new project, cvs tag the code. At release,
cvs tag the code again. During daily standup meetings, estimate the
amount of time worked on what projects the day before.

Over time, we will have some coarse metrics on productivity.

Tevor estimates Project D at 7 days of Ronny's time.


#########################################################################
050121 Friday


Rolled out more updates to the logging for Tim's signup
wizard. Yesterday I removed all system() calls and replaced them with
their Perl equivalents, and loaded it with &log() calls. Today I
traced a failed signup Kurt reported, but in the end we proved the
email was sent and his mail host received it.

Helped Jessy roll out to devel and staging. She can put up the full
myphotoalbum.com sites.




#########################################################################
050126 Wednesday

Steve Wainstead: Wainstead \ | Jessy Hanley: its pain fu;
Steve Wainstead: heller says, "some new martial art? "
Steve Wainstead: heller . o O ( "you are strong in the ways of pain fu. )
Jessy Hanley: AWWWW
Jessy Hanley: Hi YA!





#########################################################################
050202 Wednesday

Closed bug #640, where nonexistent sites resulted in "Gallery not
configured." Solved about 4 user issues for MPA; ran the findDotzeroes
script again, which fixed four more sites in addition to the one I did
by hand. 

We did our second ever code review. Trevor did a bangup job showing
the refactoring done for address fields in the store. Tim pointed out
some extraneous things in the states list and Ronny the need for more
comments where it counts, like the use of extract(). Fernando is at
Mardi Gras so he couldn't join us.




#########################################################################
050203 Thursday

Had a late brainstorming session on Twiki with Ronny. We fleshed out a
broad set of categories of the page types we see in Twiki. Brought in
my book for him today.

Wrote an album viewer last night. This views albums public or private
and renders all thumbs on one page.

This error:

[Thu Feb  3 11:36:19 2005] [error] PHP Fatal error:  Call to a member
function on a non-object in
/opt/evw/var/webs/virtual/gallery/move_photo.php on line 132

happened when I tried to "move photo" which is for moving photos to
another album, or a range of photos to another album. "reorder photo"
is what I really wanted.

Applied the patch for Gallery 1.4.4 in do_command.php and tested it
some... I don't think it will apply to us though. The variable $return
is tested; the patch is to solve a cross site scripting
vulnerability. At some point, I should think, $return is defined
because it's used in our version.

OK, some more testing and I see the patch does do what it's meant to
do... committed to cvs.

Rolled out the two fixes for gallery to production: security fix and
redirect fix for nonsites. I've been looking at a problem Chilly_Willy
found signing up for mbs. It looks like activate.cgi craps out. Hard
to say why though. I wrote up a script to group the lines by ip
address.




#########################################################################
050204 Friday

Chris rolled out virtual host conf files for all the custom MPA sites
yesterday. He hadn't tested them in two months. It broke the sites
because we switched to linkless Gallery and the document root was no
longer defined.

Spent an enormous amount of time with Tim working on solving the
problem with activate.cgi failing. It just disappears into the Bermuda
Triangle; no errors or anything. Even weirder, in the access log a 200
is returned.

I worked out how to turn on debug output in the RPC::XML client. This
dumps to stderr so now anything the module does will be logged. Dunno
if this will help. It's the same behavior I saw with the mail server,
this disappearing act.




#########################################################################
050207 Monday

Spent the morning going over the user manuals for Twiki and Bugzilla
to get a feel for their full feature set. There's probably an easy
hack for Bugzilla to autolink to Twiki words. Ferry said Ops could
upgrade both by the end of the week.

I worked with Tim some more on diagnosing the MBS issue; turns out
mdb-2 had the timeout set to 5 seconds, where the other servers had 60
seconds. This was clobbering the slow rpc connection to Tucows.

I created new mysql accounts on development for each application, and
ops is rolling this out to staging and then production. The goal is to
isolate which app is leaving behind stale mysql connections. We only
use mpauser on the front end currently. mpastore and mpasignup are
being added.

I configured www.myphotodevel.com to use SSI directives for Jessy.

I'm running the scanForDotzeroes.pl again and it's finding stuff. Tim
speculates the .0 files are from timeouts.

Our mail server is being hammered again, causing great lag to/from the
office.

Worked with Ferry and Lloyd on this timeout business. Ferry saw fit to
raise it to 300 again (or 60?). For a while he had the notion to have
a separate server for signups, something I've asked for, but alas.

Also conferred with Jessy on the idea of farming out some ops work.




#########################################################################
050208 Tuesday

Wrote function to explode .dat files in a buffer. Met with Kurt to
measure expectations on the coupons; he explained Peter had changed
the requirements on Friday, which necessitated more development
time. Trevor and Kurt have been having email exchanges and I've been
out of that loop. 10am meeting for MPA covered a lot of ground; I
locked horns with Jessy over the uploading issue, me favoring the max
possible ways and her only wanting to have to do one page explaining
how to upload. All I really want is the Gallery Remote interface to
work.

Tweaked ampira.redirect.php for Jessy to send to a welcome
page. Checked it in and tested it. Rah was having disk I/O problems;
Ferry fixed with fsck. Been running around all afternoon helping
people.

Wrote emails.cgi for Kurt. So tired I made a bunch of dumb typo
mistakes. I can't wait to go to bed.

I'm on the hunt for the solution to the view_album versus view_photo
issue. The entire string passed to the store is used, and if there's
any variation then the image appears twice.

imageHref contains the link to the photo's page:
$href = $gallery->html_wrap['imageHref'];


#########################################################################
050210 Thursday

Store rollout last night was a success. I bought some pix.

Migration meeting done; code review at noon. I need to wrap up the web
gems count I started on production. Doing a skin count for Jessy right
now. Trevor is going to take over Project D for a while.

I think my note card system doesn't work because I mix my own tasks
with dev team tasks; I think the note cards are for more minute
things. They don't do well with weekly or large scale tasks because
they sit there. Perhaps any task that should take less than a day
should go up.

I read in "Software Inspections" about change management within a
company. Fascinating. One of those things I've always seen and
perceived but never verbalized correctly.

Yawn. Did a LOT of tech support for MPA. It's 4pm now. Code review
went well but we need to start doing reviews of stuff before it goes
into production.




#########################################################################
050214 Monday

After the 10am, been working on rollout procedures, rolling out for
Jessy. Combined the three lists of MPA paying customers and clicked on
all 80+ sites to weed them out. Forwarded that. Just did some MPA
support and am doing more but stupid ezboard doesn't let me do more
than one post per minute.




#########################################################################
050216 Wednesday

After the standup, at 11:30 we whiteboarded risks to the project. It
was a start. I need to push on this every day.

I configured devel and staging for mpa-signup rollout. This involved
setting group permissions. I then rolled out to production, setting
that up too.

Skimmed first 100 pages of a book on web app testing.

Wrote a Perl script for Jessy, countslideshow.pl, to see how often the
slideshow is accessed in the last 4 weeks.


#########################################################################
050217 Thursday

Late yesterday was consumed with fixing a bug. The shortform didn't
work in Safari and IE. In the end I think the problem was how Gallery
uses the value and name of the submit button; those browsers might not
honor those attributes in an image submit tag.

Fixed Jessy's install of MPA. Set one up for Trevor. Went to the ski
trip meeting. Where did the day go again? Also been working on
extacting the service name from some files, so on development and
staging they go to those respective platforms.




#########################################################################
050218 Friday

Standup done; almost done reading Ch 5 of RD; fixed two MPA sites.

Steve Wainstead: i'm sore
Steve Wainstead: i need a new bed
Jessy Hanley: LOL
Steve Wainstead: my futon is down to about two inches thick
Steve Wainstead: from eight
Jessy Hanley: 
Jessy Hanley: there is a bed sail this weekend...
Steve Wainstead: sale
Jessy Hanley: I think its
Jessy Hanley: yea
Jessy Hanley: yea
Jessy Hanley: whateva
Jessy Hanley: umm....
Jessy Hanley: I cnat rememebnr
Jessy Hanley: but i know i saw it on tv


Got pulled into a meeting with Chris on disk space partitioning. He
was mad that I included Tim. In the end I think he's going to do it
the way he wants to do it... I told him there was no development time
available to write a balancing script and he muttered he'd have to do
it himself.

We had another risk management meeting; too short, and I didn't have
enough time to prepare but we found most of what was on the list was a
high risk to the project.




#########################################################################
050222 Tue Feb 22 14:46:06 2005

After meetings and more more meetings, did tech support for MPA,
lunched, then set up SmartCVS for Jessy, but I think she's having
problems with her upgrade to XP.




#########################################################################
050223 Wed Feb 23 17:58:31 2005

Exhausted. Today we had an MPA meeting and a disaster occured: I
handed out a list of top ten risks and it was totally
misunderstood. So new rule: pass out docs long before a meeting. Also,
it read all wrong to them. They thought it was a list of excuses, so I
had to diplomatically extract ourselves from that situation; but Ronny
and Trevor really stepped up to the plate so I was really happy about
that. I think a lot of good came out of it because Jessy and Kurt
spent over an hour diagramming stuff (separately), and Chris
diagrammed Plat for us and it looks a lot easier now than we thought.

After lunch I plowed through about 40 support emails; I had to prove
to Chris that mup-1 was failing all logins via www; then got started
on my scripting for the 80. I got all the contact info out of ldap,
and I have the basis of a provisioning script in place now. The crappy
part that awaits is copying over the data, which makes me even more
tired to think about it.

Chris also gave me the ms help docs for the uploading tool. This
presents new problems for the project, but not huge ones. Jessy wants
to do the code work for Gallery, WRT turning things on and off
depending on the site's premium qualities.


#########################################################################
050224 Thu Feb 24 09:53:30 2005

Two meetings today, very productive. Got docs from Jessy. I need to
churn out a tech spec next. Jessy needs to flesh out the Plat
signup/upgrade process better.

Went round and round with Keisha trying to set up a fucking custom
site. I hate them. What a mess.

Played briefly with the Geo lookup module for perl. Spent time on the
phone with Tim, repeatedly.


#########################################################################
050225 Fri Feb 25 14:04:50 2005

Long standup, followed by standup around Kurt's desk. Trevor has a nod
to prototype some pages. I have been working on the 80. I have a
script that creates accounts now, which is handy.


#########################################################################
050228 Mon Feb 28 11:15:08 2005

11:15am and finally done with my email. Well, I have three flagged for
followup. Tim emailed all the sites that hadn't activated and I had
about 2,500 bounces in my mailbox this morning.

Had a conversation with Jessy and Tim; he's cron'd the config.php
fixing script, it runs every night at midnight and emails the user
that their site was fixed.

Deleted a terrible child porn site. Conversation with Tim re:
config.php corruption tracking, updating a stats page for the end
user. Been running a script to copy the site data over for the lost
80.




#########################################################################
050301 Tue Mar 01 10:46:22 2005

Light MPA support thus far. 10am meeting went well. Need to update the
risks list.

mdb-1 is going down today. Gonna cut over to mdb-2. Chris plans on
some mdb.prv. address to handle this going forward.

Finished the file, comma separated, of mpa customers in EVW and sent
that off to Rob and Kurt. Fixed the password for Keishe for
portraitsofcarnival.

Conf call with Tucows; went over current server architecture with
Ferry for the FC signup. He moved up the priority for building a
staging box for Plat. Trevor and Ronny expressed their concern over
the possible delay involved here. And Ronny on showing up to the next
MPA meeting with no progress.

I fixed the password issue for Keisha for the carnival site; then I
had to debug a php problem. ampira.local.php and ldap.php were both
declaring the same functions.

Started reading an article on flickr.com; very interesting. Passed it
to Jessy who forwarded the link for Sprint's photo hoster. Peter is
going to contact them (Litesurf).

But Jessy wrongly says that moblogging is getting Flickr press, when
it's really the social networking aspect.




#########################################################################
050302 Wed Mar 02 11:07:36 2005

Tested Jessy's Gallery changes, as well as Ronny's tagrelease
script. All worked out well. Chatted with Tim about nslookup and the
Geo module again.

Had a protracted conversation with Ferry. We argued over putting
custom Gallery sites into the general MPA pool (as he advocated),
relying on some kind of marking (dotfile, db entry) to check if it's
custom.

I advocated a separate setup elsewhere. If we keep going the way we
are, if we have 8 front end MPA servers and 50 custom sites we'll have
8x50=400 virtual host files.

We agreed that the Conway Stewart boxes would make a good home; he
first has to add NFS to that box, something he wanted to do.

Provisioned yet another custom site for Andreea. Tested Tim's changes
to the MPA signup wizard. Copied the data for natas7a.com over to the
free mpa version; this site was skipped because the person already
signed up for a new site.

I also made progress on the technical spec. Traded some emails with
Jessy and Kurt on how some behavior works when a premium account
expires.




#########################################################################
050303 Thu Mar 03 17:05:13 2005

In late; TWC screwed me. Got here 11:10am. Landed in the middle of
this controversy over Rob's schematic, which put everyone in
Plat. After clearing my email we had a 2:30 meeting and he presented
it; Chris objected to using Plat for everything, citing the
Evolutionware situation. In the end we agreed the premium services
project can continue, but Plat is only "90% done" according to Rob. We
also have to consider whether to sell via OSC or not, since the
functionality we want is being written by Tucows (billing page for
MPA) but won't be ready for some time.

Tweaked the scanforDotZeros script to count how many sites add
users. Quite a lot. 



#########################################################################
050304 Fri Mar 04 10:44:05 2005

It turns out 10% of active MPA sites have created subusers; most only
two, one as many as 61.

Posted the tech spec last night on Twiki. Asked Trevor to tackle the
bit with the 10% discount for premium sites. We'll meet at 11am and go
over three topics: using the Store in place of Gallery for selling
premiums, my initial idea for a premium object, and how Trevor's Photo
object is going to interact with Gallery (if at all).


#########################################################################
050307 Mon Mar 07 10:28:35 2005

I remember on Friday working out how we might use myphotoalbum.com as
the domain for cookies; the HTTP book says it works and Yahoo does it
this way. Leaned on Trevor to do the technical spec for the store
today; I want to be ready tomorrow for the mpa meeting. I'll be in
late Wednesday as I have a cable appointment, and we leave Thursday
afternoon for the ski trip.

I've been reading up this morning on PEAR, PHP caching, Mysql caching,
memcached, and PHP session stuff. I'm a bit ahead of myself in that
I'm looking at needed infrastructure work again, but I was motivated
because we need to do a lot of scalability work after the premium
services stuff rolls out.

I think the way to go with session management in Gallery will be to
rewrite the low level functions ourselves. This will mean we don't
have to change Gallery as an application, as we would have with the
GPL'd object I found

Next, Mysql caching is not recommended by the guy who wrote
memcached. I think the way to go here is memcached for the config.php
file; we need to move this out of the filesystem and into the
database. We could create a global config.php, containing all the
stuff that never changes (paths to binaries etc) and put the rest of
it into a table. That query is going to cache, for certain, because it
rarely changes.

After that we need to get all the .dat file stuff off the filesystem,
but I haven't done extensive research into that; I only know I can
manipulate the objects from the command line, which is something I
experimented with some time ago.

As far as caching HTML output, I'm not so certain, but it provides a
huge boost to PHP processing.

Hacked up a Perl script for Chris since it turned out logins were
failing through Fozzy. /tmp was corrupted. Script:

https://cvs.corp.fortunecity.com/cgi-bin/viewcvs.cgi/operations/monitoring/general/mpalogintest.pl

Spent long time on the phone with Tim, helping him tag mbs signup for rollout.

Long conversation with Jessy and Chris on the issue of Plat as a
centralized login, and the problems thereof.




#########################################################################
050310 Thu Mar 10 12:26:27 2005

02/Mar/2005 2969
03/Mar/2005 2650
04/Mar/2005 2406
05/Mar/2005 2436
06/Mar/2005 3246
07/Mar/2005 4429
08/Mar/2005 3493
09/Mar/2005 3047

Ran a count of how many logins per day for MPA. Tim says for FC Free:

From March 9th:

14440 authenticated requests

1399 distinct users

We met yesterday with the sales guys from Tucows. They were presented
with Rob and Peter's plan to put everyone into Platypus. I want to
build up a set of numbers that Plat will have to meet now and in the
future.

Meanwhile, last night on mdb-1 I ran getposts.pl, a Perl script I
hacked up based on Winer's API: http://www.xmlrpc.com/metaWeblogApi

I made a small mistake in telling it only the last 5 posts, so I
didn't get counts. I reran it this morning upping it to 500 and got a
lot back. Interesting thing I learned from Jessy is people can import
their blogs from elsewhere.

I signed up for airblogging.com and sent a picture to my livejournal
but the img src is wrong. Wrote support@airblogging.com and asked how
mbs can get supported.




#########################################################################
050314 Mon Mar 14 11:16:30 2005

Spent over two hours clearing out my email. Chris did call a tech
meeting and the #1 priority for Ops is to migrate all MPA data to the
two 500GB devices. I have to audit the code for MPA to make sure we
find all the places where the root path is coded.

Slashdot linked to an MSNBC article on photo sharing sites like
Flickr, Fotolog and the like. Seems like we're on the verge of joining
the trend. We could push the fact that we support the Gallery Remote
API.

I realized there's no way MPA can tell what the expiration date is for
a user's premium membership. This info will have to be carried over
somehow. We talked in our 1pm standup about this; I wonder how MBS
packages are going to be stored? In Platypus?

Emailed Steve Barnes with questions about how he's going to store
package info for Plat.




#########################################################################
050315 Tue Mar 15 13:35:29 2005

Steve Barnes says that MBS premiums will be stored in Plat. Rate
groups will have services attached to them.


#########################################################################
050316 Wed Mar 16 16:49:20 2005

Discarded changes from view_album.php:

Index: view_album.php
===================================================================
RCS file: /opt/cvs/ampiradev/gallery/view_album.php,v
retrieving revision 1.64
diff -c -r1.64 view_album.php
*** view_album.php	1 Mar 2005 23:46:22 -0000	1.64
--- view_album.php	16 Mar 2005 21:48:58 -0000
***************
*** 186,192 ****
        <link rel="prev" href="<?php echo makeAlbumUrl($gallery->session->albumName, '', array('page' => $previousPage)) ?>" >
    <?php }
    if (!isset($last)) { ?>
!       <link rel="next" href="<?php echo makeAlbumUrl($gallery->session->albumName, '', array('page' => $nextPage)) ?>" >
        <link rel="last" href="<?php echo makeAlbumUrl($gallery->session->albumName, '', array('page' => $maxPages)) ?>" >
    <?php } if ($gallery->album->isRoot() && 
    	(!$gallery->session->offline || 
--- 186,192 ----
        <link rel="prev" href="<?php echo makeAlbumUrl($gallery->session->albumName, '', array('page' => $previousPage)) ?>" >
    <?php }
    if (!isset($last)) { ?>
! nn      <link rel="next" href="<?php echo makeAlbumUrl($gallery->session->albumName, '', array('page' => $nextPage)) ?>" >
        <link rel="last" href="<?php echo makeAlbumUrl($gallery->session->albumName, '', array('page' => $maxPages)) ?>" >
    <?php } if ($gallery->album->isRoot() && 
    	(!$gallery->session->offline || 
***************
*** 263,270 ****
         prints += checkboxen.value;
     }
  
!    //alert("Size of the array: " + checkboxen.length);
!    //alert("contents:\n" + prints);
     document.forms["addtocartform"].elements["print_selections"].value = prints;
     document.forms["addtocartform"].submit();
  }
--- 263,270 ----
         prints += checkboxen.value;
     }
  
!    alert("Size of the array: " + checkboxen.length);
!    alert("contents:\n" + prints);
     document.forms["addtocartform"].elements["print_selections"].value = prints;
     document.forms["addtocartform"].submit();
  }





#########################################################################
050317 Thu Mar 17 12:05:19 2005

Just completed two bug fixes. From the log:

Two changes:

1. Don't bother inserting the GPL flowerbox. We kept seeing on
   production config.php files with just the flowerbox. My guess is
   the copy() succeeded but the fopen() failed; well it's not a guess,
   it's a total certainty.

2. Do an fopen('w') instead of 'a'. Overwrite the file, since we
   removed the copy() call.

And:

albumDir, tmpDir and userDir are now hardcoded with the string
'$GALLERY_USERDIR'.

and:

Commented out require-write-dir for albumDir and tmp. This skips the
test of the filesystem to make sure they are there. This is necessary
as we use $GALLERY_USERDIR as a string in place of the actual path
name, so the test of the filesystem would always fail trying to find,
literally, '$GALLERY_USERDIR/albums'.


Kurt says bye:

Guys, I'm not much for big fc-all good-byes [besides peter gets all pissed
off].  I just wanted to thank you all for everything over the last few
years.  You all do really good, professional work and I have enjoyed being
your co-worker.  I want to wish you all a lot of luck both here and beyond,
because there's always a beyond.

This is my personal email address so if anyone needs/wants a recommendation
or a reference and are unable to use a current manager [for obvious
reasons] please feel free to use me as a reference.  I will have absolutely
no problem doing that for any of you.

Kurt Tietjen
me@kurtteej.com




#########################################################################
050324 Thu Mar 24 10:31:40 2005

Sadly, I've fallen behind again in my log. Yesterday I spent a couple
of hours moving all bugs from old projects into The Attic (a new
"project" to dump them all in) and deleting the old projects, which
was kind of sad. Only existing projects are in Bugzilla now.

I've written a premium services object and yesterday I was going to
get the schema created to handle populating the object; but was pulled
in a few directions, including Ferry disregarding Trevor's rollout
instructions and so causing a disaster on the front end for the MPA
store.

This morning I was perusing the error logs and there's a lot of
"connection reset by peer" about mmap being sent on Fozzy while it's
nowhere to be seen on mdb-2. In theory they are identical machines. We
already know mup-1 has hardware problems because the /tmp has become
corrupted more than once.

Was trying to convert a list into a set of hypertext links. I kept
typing ^.*$ to match the whole line, but that didnt' work; forgot to
escape the metachars. So: ^\(.*\)$ works, and \1 is the correct
positional parameter:

<a
href=http://nakedcowboy.myphotoalbum.com/xxx/foo.php?z=\1>\1</a><br>




#########################################################################
050329 Tue Mar 29 16:42:27 2005

Updated the existing "the80" in MPA so status = 3. This is so Tim does
not delete them for alleged TOS violations.

Set up porky.myphotodevel.com for Jessy. In a 1pm meeting Chris, Tim
and I went over FC Free development possibilities. We argued a lot. It
really comes down to having everything in one database.




#########################################################################
050331 Thu Mar 31 11:52:47 2005

Yesterday did a bit of coding: percent and disk usage stuff for Jessy
plus I refactored the constructor. Chris did some stress testing for
mysql sessions and found we might be able to support as much as 12
million queries/day, but Tim fought long and hard over the phone to
dissuade the notion. Testing on the store for 18 free prints
continued. Trevor did 5 rollouts. Ronny did a lot of migration stuff
and worked on the ActiveX component with Jessy. She has gotten her way
and all users will get it free. We are now filling 10-20 GB per day in
disk space.

I did a flowchart for using the XmlHttpRequest object to solve the
Janet problem: users click checkboxes and then go to the next page,
but stuff doesn't get added to their cart. The problem is we'd have to
support browsers that won't allow XHR objects. The short solution
would be an alert telling them they've selected stuff but haven't
added them to the cart.

We are looking at a store rollout tomorrow afternoon for 18 free
prints. This was a classic case of a deadline being imposed on the
development staff with the edict "do what you have to do to make this
happen."

I updated the risks board; I added a date to motivate myself to keep
it up to date.




#########################################################################
050401 Fri Apr 01 10:18:25 2005

Store rollout today: 18 free prints. First order only. 11am coming up
with Rob and Chris on the big picture.




#########################################################################
050407 Thu Apr 07 15:07:54 2005

create table mpa_photos (
phid int(11) NOT NULL auto_increment,
subdomain varchar(64) not null,
album varchar(64) not null,
name varchar(64) not null,
uploaded datetime not null default '0000-00-00 00:00:00',
PRIMARY KEY (phid),
KEY uploaded_index (uploaded)
) type=MyISAM;


#########################################################################
050408 Fri Apr 08 16:38:46 2005

select count(uploaded) as cnt, date_format(uploaded, "%H") from mpa_photos group by date_format(uploaded, "%H");




#########################################################################
050412 Tue Apr 12 14:09:36 2005

In the cvs log for login.php:

----------------------------
revision 1.9
date: 2004/10/05 14:46:20;  author: jhanley;  state: Exp;  lines: +10 -7
changed so that pop ups launch correctly and no more uers, refred ot as member
----------------------------

dk wtf she means :o)




#########################################################################
050414 Thu Apr 14 17:56:16 2005

Fixed the bugs in the rendering of the tabs. Added new popup when they
do not have permission to do the command. Jessy will have to sort out
the look and text. One last case to test: Crusoe sees tabs when logged
out, which is correct, but does not see them when logged in!




#########################################################################
050421 Thu Apr 21 16:27:11 2005

Last entry from Pork. Goodbye, Pork.

        _________________
   .-"""-----..._    _..-`-._
  ";--.  <^"o";  "."" ."o"^> "-.      _____________________
    \_/\  `"""         ^^^^_/"/      *                     *
     /( "-._.-""/    \""--" |"\      *   "I like pork!"    *
    // \      _.-""""-.     |  |     *_____________________*
    |/ |\   ." \ TTTT /   _./  |
   //. | ";\ \|\Y    Y/|"| | | |
  / // |_/  \ |_ LLLL _|/  | | |
 (_/ | |     \  """""" /   / / /
   | / |      \       /   | |_/
   \/| |       """""""    | |  
     ( |                  | /

Sun Microsystems Inc.	SunOS 5.8	Generic	February 2000


#########################################################################
050425 Mon 25 Apr 2005 02:19:04 PM EDT

We are nearing the end of our disk space once again, and that lead to
a heated exchange in the Monday morning tech staff meeting. Best case
scenario: 500gb by tomorrow morning.

I have been doing some research into why mpa_photos is so far
off. 5000+ photos are in the table that are apparently not on the
filesystem anymore.

I also need to hack in file size.

Wrote a tool for Jessy to toggle her premium membership. Been doing
work on the mpa_photos table; precarious business since I'm supposed
to be talking to the WOW object by Wednesday.

Just hacked up "delete from mpa_photos" functionality. May as well
handle renames, moves and copies next.




#########################################################################
050427 Wed 27 Apr 2005 09:53:42 AM EDT

(defun sw-grepv (pattern)
  "Do a grep -v on the fracking buffer."
  (interactive "sPattern: ")
  (shell-command-on-region (point-min) (point-max) (format "grep -v '%s'" pattern) 1 1 "*error crap*")
  )

Scanned activation.log; nothing found. Jessy thinks there's an email
issue for signups. Asked Ops to check if mup-1 and mup-2 can send
email.

Worked out some last details for decodeGallery.php and checked it in;
and knocked up a script to clean out users in the users table on bork.



#########################################################################
050428 Thu 28 Apr 2005 11:53:52 AM EDT

11:51am. Finally done with MPA support, plus brief BADASS meeting with
Chris. Plus standup, flushing out email etc. Also rolled back
user_preferences.php for Jessy, which contained the disk usage bar.

Rough meeting today. I have no working code; am waiting on a reply
from Steve Barnes on the Wow object problems I'm having. Also a new
requirement was added: when people go into Plat to upgrade their blog
they will not be prompted for a credit card if they have not entered
it.




#########################################################################
050429 Fri 29 Apr 2005 09:27:25 AM EDT

In 8:45am. Still no reply from Barnes. Got the Plat Windows client
installed yesterday with Nathan's help.

Steve Barnes sent sample code that works. Now I have to create an
account.

<?php

accesslog("hello, sailor!");

// define our own logging
// http://www.php.net/manual/en/function.syslog.php

function accesslog($msg) {

    define_syslog_variables();
    // open syslog, include the process ID and also send
    // the log to standard error, and use a user defined
    // logging mechanism
    openlog("swlog", LOG_PID | LOG_PERROR, LOG_LOCAL0);

    $access = date("r");
    syslog(LOG_WARNING, "[$access] $msg");


    closelog();
}

?>




#########################################################################
050503 Tue 03 May 2005 04:47:41 PM EDT

Had a long conversation with Peter on hiring, large projects, etc. I
think it turned out well. Got some good resumes today; gonna follow up
on them in a bit. Hacking away at the account creation via Wow. I had
two meetings this morning and then worked with Fernando to get him
going on the next and last bug on his list.




#########################################################################
050504 Wed 04 May 2005 01:46:24 PM EDT

Went through all the resumes -- about 20 -- and there were nine
worthwhile ones. Almost had lunch with Jeffo today to talk about
Badass/theOracle/theGreatOz, but his stomach was not cooperating so it
has been moved to tomorrow (the lunch date, not his stomach). Did a
couple support jobs for Jessy. Printed all the resumes and cover
letters. Helped Fernando a little.




#########################################################################
050506 Fri 06 May 2005 02:08:57 PM EDT

In late yesterday. Met with Jeffo; he's free starting next Wednesday
to do the data warehouse work. Interviewed three guys, with help from
Chris and Trevor. Got two more lined up.

Meanwhile, worked this morning with Jessy on getting the GET string
right to purchase the premium membership. I fixed destroy.php in the
bargain, learned something new about PHP scoping (a file require()'d
in a function is in that scope), and now I need to get something new
for Fernando to work on.




#########################################################################
050509 Mon 09 May 2005 10:56:50 AM EDT

Friday, Ronny worked out a sql query to get the earliest and most
recent uploads per album per day. This is a really great, simple way
to look at what's been uploaded. Late Friday I worked on a script to
visit all sites and extract information about each photo; the only
missing piece is the file size, which should be easy to get but
somehow I'm calling the interface wrong. By sheer chance I found the
upload date, so that was a win. Perhaps later some time I'll load
all that info into a test table.

Friday I also assigned new bugs to Fernando and showed him the
issues. I spent a good deal of time trying to reproduce a bug I filed
a while ago, but I think we simply cannot shut off comments anymore.

Set up an interview for tomorrow, 12 noon. There's one today at 2pm
and another tomorrow at 10am.

Set up virtual site on bork for Trevor; emailed ops that sendmail is
not running there. Fixed assorted sites for Jessy and suggested to Tim
he run php -l instead; had to follow up with an example.

Steve Barnes is out for two more days. I have no answers yet. But
grepping the ccs codebase, I found I was calling addProperty instead
of addParameter for the whereclause; that resolved it but I can only
ask "Does username foo with email address foo@bar.com exist?" and not
"Does username foo exist? Does email address foo@bar.com exist?"




#########################################################################
050510 Tue 10 May 2005 10:19:05 AM EDT

Got an email from Tucows on the programming issue. I should reply
straight away; I will. Had the standup, then interviewed a guy with a
long systems programming background and an EE degree.

We have a site with a corrupted photos.dat file. I'm looking at a way
to regenerate it. Hmm. If albumitems had get/set for all their fields,
or else I could just reassign them, then I could do it based on the
directory information.

I'm also thinking now might be the time to start throwing the dat
files into Mysql.

Excellent. Justin answered my questions exactly. I will try them out
soon; there is indeed a freeform sql query method.

Whipped out a copy of the Premium package toggler for Fernando.

I'm looking at recreating photos.dat. Here's some notes on the file
itself.

It's an array of albumitem objects, to start. The subclass is
specified right after the class name; the three items sized, thumb and
original are in the object.

This will probably come back to the idea of moving the originals to a
temporary folder, then recreating the album (mostly it can be done by
hand).



#########################################################################
050511 Wed 11 May 2005 02:51:27 PM EDT

Did the back and forth with Tucows on the create.php script. It works
on their end but not ours. Phillip has done some traces and found some
weirdness; he's talking to one of their vendors now and I'm waiting to
hear back.

I spent some time during lunch deleting porn and copyright infringing
sites, but it's a drop in the bucket.

Currently we have almost 50K active users taking up 2TB of space. So
500K users would need 20TB. One TB per year from Inflow == $30K, so
$600,000 a year in storage.

I keep trying to start again on the premium object but I'm constantly
being interrupted by Jessy, Chris, Tim, email or Ronny.




#########################################################################
050512 Thu 12 May 2005 11:55:51 AM EDT

Sent an email bitching about noone using Bugzilla. Jessy said I was
being dramatic. No bugs have been filed, not one, for the club
project.

Been testing the premium stuff. Found on staging that the package_type
column is not updated upon purchase; filed it.

Noone reads email anymore. It's all AIM here.




#########################################################################
050516 Mon 16 May 2005 04:17:23 PM EDT

Whirlwind day. Fixed the problem with the shortform, where free users
who changed their config and then buy the club membership have
printing turned off. In the end, used an IF statement to show either a
checkbox or a hidden var.

Tried to print out the code samples but everyone sent huge files,
resulting in the printer spitting out reems of crap. It's already
4:15pm. Tim is here too, and he has needed occasional help.




#########################################################################
050517 Tue 17 May 2005 06:06:21 PM EDT

In late today (1pm). Club was launched, already got two
signups. Helped Fernando work out how to create a new report for
Jessy. Did a lot of testing of Gallery; had to do two live fixes:
comment out the declaration of stderr() in fcwrite.inc, and comment
out debug statements that were filling the error logs. Had a
conversation with Tim and Chris on moving original images off to cheap
disk space. Got Nathan to hook up the SQL Server software on my
Windows box; got the same results as Phillip and forwarded that to
him. Reminded Jessy and Peter they are interviewing Julian tomorrow.




#########################################################################
050518 Wed 18 May 2005 10:27:45 AM EDT

Eight people have bought club membership! Not bad. Cash on the barrel.

Got an 11am with Plat on 5.1. 2pm for Badass.

Told Trevor to tweak the update statement to change the status of the
user. 4 is the magic number.




#########################################################################
050519 Thu 19 May 2005 10:56:17 AM EDT

In late today. Jessy's fault. We get the afternoon to watch Star Wars
Episode 3.

Have my arm in a sling. I think I've been leaning on the armrest while
I type. Made the offer to Julian, then upped it, but I'm not
optimistic.




#########################################################################
050523 Mon 23 May 2005 12:12:19 PM EDT

AIM IM with Ron Gonzales <ronatkaplan>
11:54 AM
Steve Wainstead: ping
Ron Gonzales: pong
Steve Wainstead: hey. if you have 60 seconds i could use a pointer on resolving a dpi issue
Steve Wainstead: From: Bill Schmidt [mailto:bschmidt@districtphoto.com]
Sent: Friday, May 20, 2005 10:30 AM
To: 'Jessy Hanley'
Subject: Orphan Orders on FTP Site

Hello Jessy,

Just FYI, I noticed two orders on your FTP site that have image files, but no XML file. This means they will not download for fulfillment. They are:

Order 1181 - has 30 image files andadate of 5/17
Order 1195 -has 41 image files anda date of 5/18

Just wanted to make you aware, in the event there was a glitch.

Bill
Steve Wainstead: aha
Steve Wainstead: [/opt/mpa/dpi/bin/ftp_files_to_dpi.pl][1182] ERROR: Could not create dir 1182. Timeout (900 seconds): closing control connection.
Steve Wainstead: same with the other. i just have to resend them.
12:00 PM
Ron Gonzales: ftp timeout?
Ron Gonzales: net::ftp doesn't have ping functionality.. it has to be implemented
Ron Gonzales: i increased the timeout but i guess it didn't solve the issue
Ron Gonzales: you can set the orders_status of those two to 5 , processing_state to 'ready' that will get those up there
Ron Gonzales: the ftp timeout issue does have to be addressed
12:05 PM
Steve Wainstead: ok
Ron Gonzales: sorry you can change the status to whatever number ready_to_be_ftped is
Steve Wainstead: cool. it looks like your .mysql_history file goes all the way back to when you started this project
Ron Gonzales: nice
Steve Wainstead: 3298:update dpi_invoice set date_added = NOW() where orders_id IN (767,768,770,774,776,777);
3301:update osc_orders set orders_status = 3 where orders_id IN (767,768,770,774,776,777);
Steve Wainstead: do i need to do that too?
Ron Gonzales: no
Ron Gonzales: just the second one
Steve Wainstead: 4 7 READY_TO_BE_FTPED ftp_files_to_dpi.pl
Steve Wainstead: that's from your table in twiki. that would seem to indicate i should set order status to 7.
Ron Gonzales: yup that's the one
Ron Gonzales: update osc_orders set orders_status = 7, processing_state = 'ready' where orders_id in ()




#########################################################################
050602 Thu 02 Jun 2005 06:16:28 PM EDT

Back from vacation. Spent the day catching up: a week of email, fixing
sites for Jessy, fixing a bug in the shortform, sundry things, and my
new desk was organized in a rather weird way. The bookcase was
blocking my elbow.

Almost nothing was connected correctly when I came in; the monitor
wasn't even plugged into the mac.




#########################################################################
050603 Fri 03 Jun 2005 02:16:21 PM EDT

pbwiki.com (org?) is David Weekly's venture. How about that.

Removed the armrests from my chair. It's going to take some getting
used to...

Been testing and trying to figure out bugs for Gallery/Store today. We
were about to roll out but bugs held it up.



#########################################################################
050606 Mon 06 Jun 2005 02:49:10 PM EDT

Helped Ferando with some php/javascript stuff. Sat in on a meeting for
the store pages rewrite. Suggested micro thumbnails for the store only.


#########################################################################
050607 Tue 07 Jun 2005 12:10:54 PM EDT

Finished refactoring view_album.php for now. "Order whole album"
appears to work, and I moved duplicate code into a function.

MPA meeting happened this morning. Trevor is working on the payment
gateway; Tree will do the AJAX stuff for the checkboxen when he
starts; emailed Tim on automatic store account creation; gave Fernando
instructions on a test plan for "Order whole album."


#########################################################################
050608 Wed 08 Jun 2005 03:21:49 PM EDT

Put in a fix for ftp timeout: after each file is sent I do a
'pwd'. Let's see if that solves it.

Worked with Fernando on the invoice discrepency again for DPI and our
report. 781 is the mystery order that got sent... more than once?
There was 611 which was flat out missing and Trevor thinks that was
because of the mysql replication failure. The third one Fernando is
taking another look at, since I showed him how to grep the log file
for the dpi stuff.

Rolled out Gallery. There were conflicts from my edits to debug the
"woman in Texas" problem. cvs update -C moves (copies, really) any
locally modified files out of the way:

[04:33 PM][cvssync@mdb-1:/mnt/cel-1/vol01/linkless/gallery]$ cvs -q update -C -r R_2005_06_08_wholealbum 
(Locally modified add_photos.php moved to .#add_photos.php.1.13)
(Locally modified easy_upload-first.php moved to .#easy_upload-first.php.1.8)
(Locally modified easy_upload.php moved to .#easy_upload.php.1.18)
(Locally modified init.php moved to .#init.php.1.21)
(Locally modified move_photo.php moved to .#move_photo.php.1.8)
(Locally modified session.php moved to .#session.php.1.3)
? classes/class.phpmailer.php
? classes/class.smtp.php
P ChangeLog
P TagHistory
P add_comment.php
U add_photos.php
P ampira.local.php
P delete_album.php
U easy_upload-first.php
U easy_upload.php
P edit_caption.php
U init.php
U move_photo.php
U session.php
U view_album.php
U classes/HTMLParser.class.inc
cvs update: move away classes/class.phpmailer.php; it is in the way
C classes/class.phpmailer.php
cvs update: move away classes/class.smtp.php; it is in the way
C classes/class.smtp.php
P css/main.css
U images/mpa-easy-upload.gif
U images/n-big-button.gif
U setup/shortform.php
[04:36 PM][cvssync@mdb-1:/mnt/cel-1/vol01/linkless/gallery]$ 

                                   


#########################################################################
050609 Thu 09 Jun 2005 10:58:51 AM EDT

In late due to train problems. Was bombarded with more crap about the
ceiling leaking. Oy vey.

No problems overnight with photo processing; two orders were
successfully resent. 


Returning to the problem with users unable to delete albums (or move
them, &c.. which was a problem I dealt with prior to vacation) here is
an interesting entry from mup-2. The second and third entries are the same.

Changing albumName to album03 for popsy for /delete_album.php

SESSION NOW: O:14:"gallerysession":7:{s:7:"version";s:5:"1.4.2";s:13:"offlineAlbums";a:1:{s:10:"albums.ph
p";b:1;}s:8:"username";s:5:"admin";s:7:"offline";b:0;s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:
"frames";b:0;s:9:"emoticons";b:0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"d
iskspace_allowed";i:100;s:17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b
:0;s:10:"disk_usage";i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"22
9055";s:13:"store_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action=add_product";}s:9:"albumName";s:7:"album03";s:13:"albumListPage";i:1;}

Changing albumName to album02 for popsy for /delete_album.php

SESSION NOW: O:14:"gallerysession":8:{s:7:"version";s:5:"1.4.2";s:13:"offlineAlbums";a:2:{s:10:"albums.ph
p";b:1;s:7:"album02";b:1;}s:8:"username";s:5:"admin";s:7:"offline";b:0;s:4:"prem";O:7:"premium":5:{s:7:"p
remium";a:11:{s:6:"frames";b:0;s:9:"emoticons";b:0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"t
hemes";b:0;s:17:"diskspace_allowed";i:100;s:17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_d
isable_printing";b:0;s:10:"disk_usage";i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:
6:"userid";s:6:"229055";s:13:"store_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action
=add_product";}s:9:"albumName";s:7:"album02";s:13:"albumListPage";i:1;s:11:"viewedAlbum";a:1:{s:7:"album02";i:1;}}

Changing albumName to album02 for popsy for /delete_album.php

SESSION NOW: O:14:"gallerysession":8:{s:7:"version";s:5:"1.4.2";s:13:"offlineAlbums";a:2:{s:10:"albums.ph
p";b:1;s:7:"album02";b:1;}s:8:"username";s:5:"admin";s:7:"offline";b:0;s:4:"prem";O:7:"premium":5:{s:7:"p
remium";a:11:{s:6:"frames";b:0;s:9:"emoticons";b:0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"t
hemes";b:0;s:17:"diskspace_allowed";i:100;s:17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_d
isable_printing";b:0;s:10:"disk_usage";i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:
6:"userid";s:6:"229055";s:13:"store_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action
=add_product";}s:9:"albumName";s:7:"album02";s:13:"albumListPage";i:1;s:11:"viewedAlbum";a:1:{s:7:"album02";i:1;}}

Fatal error: album not set.
User is: O:12:"gallery_user":13:{s:8:"username";s:5:"admin";s:8:"fullname";s:13:"Administrator";s:8:"pass
word";s:36:"y4Lucf2bcb18ac633b0a0aa3e1e53c2ce4fc";s:5:"email";s:19:"un_chap@hotmail.com";s:7:"isAdmin";b:
1;s:15:"canCreateAlbums";b:1;s:3:"uid";s:20:"1114094436_602237875";s:15:"defaultLanguage";s:0:"";s:7:"ver
sion";i:5;s:15:"recoverPassHash";N;s:10:"lastAction";s:5:"login";s:14:"lastActionDate";i:1117618349;s:9:"origEmail";N;}

Session is: O:14:"gallerysession":8:{s:7:"version";s:5:"1.4.2";s:13:"offlineAlbums";a:2:{s:10:"albums.php
";b:1;s:7:"album02";b:1;}s:8:"username";s:5:"admin";s:7:"offline";b:0;s:4:"prem";O:7:"premium":5:{s:7:"pr
emium";a:11:{s:6:"frames";b:0;s:9:"emoticons";b:0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"th
emes";b:0;s:17:"diskspace_allowed";i:100;s:17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_di
sable_printing";b:0;s:10:"disk_usage";i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:6
:"userid";s:6:"229055";s:13:"store_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action=
add_product";}s:9:"albumName";s:0:"";s:13:"albumListPage";i:1;s:11:"viewedAlbum";a:1:{s:7:"album02";i:1;}}
Album is: N;
PHPSESSID => 5a652e7eb9684391bd63af16ecce8983





#########################################################################
050610 Fri 10 Jun 2005 09:35:03 AM EDT

In at 8:50 today.

No missing album name failures overnight on mup-1 or mup-2. All print
orders succeeded. Jessy out today; asked Fernando to cover
support@myphotoalbum.com.

Yesterday added new debugging statements for trapping the missing
album name bug. This happens only to a few people; they select an
album to delete. At this point the album name is in the session
data. When they click OK the next iteration fails, and the session
data does not contain the album name (as shown above). In sequence:

User clicks delete album
session is read
session is written
page is rendered

User clicks OK
session is read
album name not in session
fail

Changed the status of order 1384. There was no evidence it was ever
resent; only on entry in the OFT (Order Fulfillment Thing) when it
failed (the photos could not be found, perhaps due to a filesystem
problem.)

Added delete link to the foo.php page when rendering an album.

Thought: on line 833 of the Album.php class, the original upload file
is copied to the album directory. There could be a new method to get
the user's slow storage directory and it gets stored there.

Test plan:
1. Sign up. New site should have two storage types in its config, and
paths built in each.
1. Upload pix. Originals should go to RCS, resized to fast.
2. Rotate pix. No surprises should be here.
3. Delete pix. Should be removed from both stores.
4. Reordering photos. Should not have any effect.

Also we need a migration plan: moving all user content to RCS. Should
we support both?




#########################################################################
050614 Tue 14 Jun 2005 01:11:53 PM EDT

ma:: f665ed7fa1febafc5933b0271beccea3 ilatui Setting: 'albumName' to album05 for subdomain ilatui fo\
r script /delete_album.php
ma:: f665ed7fa1febafc5933b0271beccea3 ilatui User is not loaded yet. Check for username in session.
ma:: f665ed7fa1febafc5933b0271beccea3 ilatui Session is: O:14:"gallerysession":9:{s:7:"version";s:5:\
"1.4.2";s:13:"offlineAlbums";a:1:{s:10:"albums.php";b:1;}s:13:"last_accessed";d:1118767715.766635894\
775390625;s:10:"session_id";s:32:"f665ed7fa1febafc5933b0271beccea3";s:8:"username";s:5:"admin";s:7:"\
offline";b:0;s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"emoticons";b:0;s:\
4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed";i:100;s:17:"\
bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk_usage";i:0;\
}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"269891";s:13:"store_ur\
l_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action=add_product";}s:9:"albumName";s:\
7:"album05";s:13:"albumListPage";i:1;}
ma:: f665ed7fa1febafc5933b0271beccea3 ilatui Album is not loaded yet. Check for albumName in session\
.
ma:: f665ed7fa1febafc5933b0271beccea3 ilatui mpa_fqdn => http://ilatui.myphotoalbum.com
ma:: f665ed7fa1febafc5933b0271beccea3 ilatui fcwt => myphotoalbum.com
ma:: f665ed7fa1febafc5933b0271beccea3 ilatui __support_check => 1
ma:: f665ed7fa1febafc5933b0271beccea3 ilatui PHPSESSID =>
f665ed7fa1febafc5933b0271beccea3

ma:: f665ed7fa1febafc5933b0271beccea3 ilatui Fatal error: album not set.
ma:: f665ed7fa1febafc5933b0271beccea3 ilatui User is: O:12:"gallery_user":13:{s:8:"username";s:5:"ad\
min";s:8:"fullname";s:13:"Administrator";s:8:"password";s:36:"GMxV9fbf8119cfa5fb9dee424e27866b9ee6";\
s:5:"email";s:18:"mnn4ever@yahoo.com";s:7:"isAdmin";b:1;s:15:"canCreateAlbums";b:1;s:3:"uid";s:18:"1\
118696036_2108599";s:15:"defaultLanguage";s:0:"";s:7:"version";i:5;s:15:"recoverPassHash";N;s:10:"la\
stAction";s:5:"login";s:14:"lastActionDate";i:1118767713;s:9:"origEmail";N;}
ma:: f665ed7fa1febafc5933b0271beccea3 ilatui Session is: O:14:"gallerysession":9:{s:7:"version";s:5:\
"1.4.2";s:13:"offlineAlbums";a:1:{s:10:"albums.php";b:1;}s:13:"last_accessed";d:1118767721.738256931\
304931640625;s:10:"session_id";s:32:"f665ed7fa1febafc5933b0271beccea3";s:8:"username";s:5:"admin";s:\
7:"offline";b:0;s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"emoticons";b:0\
;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed";i:100;s:1\
7:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk_usage";i\
:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"269891";s:13:"store\
_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action=add_product";}s:9:"albumName"\
;s:0:"";s:13:"albumListPage";i:1;}
ma:: f665ed7fa1febafc5933b0271beccea3 ilatui Album is: N;
ma:: f665ed7fa1febafc5933b0271beccea3 ilatui mpa_fqdn => http://ilatui.myphotoalbum.com
ma:: f665ed7fa1febafc5933b0271beccea3 ilatui fcwt => myphotoalbum.com
ma:: f665ed7fa1febafc5933b0271beccea3 ilatui __support_check => 1
ma:: f665ed7fa1febafc5933b0271beccea3 ilatui PHPSESSID => f665ed7fa1febafc5933b0271beccea3
ma:: f665ed7fa1febafc5933b0271beccea3 ilatui browser: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT \
5.1; SV1)


---

ma:: 98c7a208c51e6e26c203c201fb581a4c kbalu Setting: 'albumName' to album15 for subdomain kbalu for \
script /delete_album.php
ma:: 98c7a208c51e6e26c203c201fb581a4c kbalu User is not loaded yet. Check for username in session.
ma:: 98c7a208c51e6e26c203c201fb581a4c kbalu Session is: O:14:"gallerysession":10:{s:7:"version";s:5:\
"1.4.2";s:13:"offlineAlbums";a:3:{s:7:"album14";b:1;s:10:"albums.php";b:1;s:7:"album15";b:1;}s:13:"l\
ast_accessed";d:1118768851.5831520557403564453125;s:10:"session_id";s:32:"98c7a208c51e6e26c203c201fb581a4c";
s:8:"username";s:5:"admin";s:7:"offline";b:0;s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:\
{s:6:"frames";b:0;s:9:"emoticons";b:0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b\
:0;s:17:"diskspace_allowed";i:100;s:17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disa\
ble_printing";b:0;s:10:"disk_usage";i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";\
s:6:"userid";s:6:"220837";s:13:"store_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php\
?action=add_product";}s:9:"albumName";s:7:"album15";s:11:"viewedAlbum";a:2:{s:7:"album14";i:1;s:7:"a\
lbum15";i:1;}s:13:"albumListPage";i:1;}
ma:: 98c7a208c51e6e26c203c201fb581a4c kbalu Album is not loaded yet. Check for albumName in session.
ma:: 98c7a208c51e6e26c203c201fb581a4c kbalu mpa_fqdn => http://kbalu.myphotoalbum.com
ma:: 98c7a208c51e6e26c203c201fb581a4c kbalu PHPSESSID => 98c7a208c51e6e26c203c201fb581a4c

ma:: 98c7a208c51e6e26c203c201fb581a4c kbalu Fatal error: album not set.
ma:: 98c7a208c51e6e26c203c201fb581a4c kbalu User is: O:12:"gallery_user":13:{s:8:"username";s:5:"adm\
in";s:8:"fullname";s:13:"Administrator";s:8:"password";s:36:"k8gyef793aa07d51479266205828baa610d3";s\
:5:"email";s:23:"balu_kbv@rediffmail.com";s:7:"isAdmin";b:1;s:15:"canCreateAlbums";b:1;s:3:"uid";s:2\
1:"1112869981_1824767752";s:15:"defaultLanguage";s:0:"";s:7:"version";i:5;s:15:"recoverPassHash";N;s\
:10:"lastAction";s:5:"login";s:14:"lastActionDate";i:1118768537;s:9:"origEmail";N;}
ma:: 98c7a208c51e6e26c203c201fb581a4c kbalu Session is: O:14:"gallerysession":10:{s:7:"version";s:5:\
"1.4.2";s:13:"offlineAlbums";a:3:{s:7:"album14";b:1;s:10:"albums.php";b:1;s:7:"album15";b:1;}s:13:"l\
ast_accessed";d:1118768860.335937976837158203125;s:10:"session_id";s:32:"98c7a208c51e6e26c203c201fb581a4c";
s:8:"username";s:5:"admin";s:7:"offline";b:0;s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{\
s:6:"frames";b:0;s:9:"emoticons";b:0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:\
0;s:17:"diskspace_allowed";i:100;s:17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disab\
le_printing";b:0;s:10:"disk_usage";i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s\
:6:"userid";s:6:"220837";s:13:"store_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?\
action=add_product";}s:9:"albumName";s:0:"";s:11:"viewedAlbum";a:2:{s:7:"album14";i:1;s:7:"album15";\
i:1;}s:13:"albumListPage";i:1;}
ma:: 98c7a208c51e6e26c203c201fb581a4c kbalu Album is: N;
ma:: 98c7a208c51e6e26c203c201fb581a4c kbalu mpa_fqdn => http://kbalu.myphotoalbum.com
ma:: 98c7a208c51e6e26c203c201fb581a4c kbalu PHPSESSID => 98c7a208c51e6e26c203c201fb581a4c
ma:: 98c7a208c51e6e26c203c201fb581a4c kbalu browser: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5\
.1; {517C2FD6-5C94-61E3-F385-634D84E48ACB})

So I have conclusively verified that the session data is the SAME
session data across requests by putting the session id into the
session at the time it's created. It remains the same. I didn't trust
userid to be the same because something might be setting it for every
session.

So this leads me back to the idea that it's a browser issue. The woman
in Texas could duplicate the problem every time. If it's the browser,
how does the albumName get nulled in the session data?


[Tue Jun 14 16:23:51 2005] [error] PHP Warning:  Unknown(): A session is active. You cannot change t\
he session module's ini settings at this time. in Unknown on line 0


ma:: f762c424381e84a957e452e536763e4d twelve Setting: 'albumName' to album05 for subdomain twelve fo\
r script /delete_album.php

ma:: f762c424381e84a957e452e536763e4d twelve User is not loaded yet. Check for username in session.

ma:: f762c424381e84a957e452e536763e4d twelve Session is: O:14:"gallerysession":9:{s:7:"version";s:5:\
"1.4.2";s:13:"offlineAlbums";a:1:{s:10:"albums.php";b:1;}s:13:"last_accessed";d:1118780268.644592046\
7376708984375;s:10:"session_id";s:32:"f762c424381e84a957e452e536763e4d";s:8:"username";s:5:"admin";s\
:7:"offline";b:0;s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"emoticons";b:\
0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed";i:100;s:\
17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk_usage";\
i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"198231";s:13:"stor\
e_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action=add_product";}s:9:"albumName\
";s:7:"album05";s:13:"albumListPage";i:1;}

ma:: f762c424381e84a957e452e536763e4d twelve Album is not loaded yet. Check for albumName in session\
.
ma:: f762c424381e84a957e452e536763e4d twelve mpa_fqdn => http://twelve.myphotoalbum.com
ma:: f762c424381e84a957e452e536763e4d twelve PHPSESSID => f762c424381e84a957e452e536763e4d


ma:: f762c424381e84a957e452e536763e4d twelve Fatal error: album not set.
ma:: f762c424381e84a957e452e536763e4d twelve User is: O:12:"gallery_user":13:{s:8:"username";s:5:"ad\
min";s:8:"fullname";s:13:"Administrator";s:8:"password";s:36:"SLcc7dae03b987591ea77540f1da2d3f6c61";\
s:5:"email";s:22:"common_yeah@rambler.ru";s:7:"isAdmin";b:1;s:15:"canCreateAlbums";b:1;s:3:"uid";s:2\
1:"1109861566_1177588896";s:15:"defaultLanguage";s:0:"";s:7:"version";i:5;s:15:"recoverPassHash";N;s\
:10:"lastAction";s:5:"login";s:14:"lastActionDate";i:1118780263;s:9:"origEmail";N;}

ma:: f762c424381e84a957e452e536763e4d twelve Session is: O:14:"gallerysession":10:{s:7:"version";s:5\
:"1.4.2";s:13:"offlineAlbums";a:1:{s:10:"albums.php";b:1;}s:13:"last_accessed";d:1118780658.86099100\
1129150390625;s:10:"session_id";s:32:"f762c424381e84a957e452e536763e4d";s:8:"username";s:5:"admin";s\
:7:"offline";b:0;s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"emoticons";b:\
0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed";i:100;s:\
17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk_usage";\
i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"198231";s:13:"stor\
e_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action=add_product";}s:9:"albumName\
";s:0:"";s:13:"albumListPage";i:1;s:14:"wasNoAlbumName";s:48:"false; I had an album name in init.php\
 (album05)";}
ma:: f762c424381e84a957e452e536763e4d twelve Album is: N;
ma:: f762c424381e84a957e452e536763e4d twelve mpa_fqdn => http://twelve.myphotoalbum.com
ma:: f762c424381e84a957e452e536763e4d twelve PHPSESSID => f762c424381e84a957e452e536763e4d
ma:: f762c424381e84a957e452e536763e4d twelve browser: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT \
5.0)



#########################################################################
050615 Wed 15 Jun 2005 10:10:01 AM EDT

Orders 2026, 2028 and 2031 failed to upload last night: the connection
had closed. I just reset their status in the database so they get
resent.

Yesterday I started adding debug statements to a block in init.php
where, if there is an albumName in the session, the album is then
loaded. Whoa! The behavior here is really really weird. So it's a bit
of a setback; and this may be quite expensive for Gallery in terms of
performance, if indeed it's constantly trying to load albums it
doesn't need.

My most recent catch is this:

"wasNoAlbumName";s:56:"true; I could not load the album, albumname
was: album01";}

From this block in init.php:


/* Load the correct album object */
if (!empty($gallery->session->albumName)) {
	$gallery->album = new Album;
	$ret = $gallery->album->load($gallery->session->albumName);
    $gallery->session->wasNoAlbumName = "false; I had an album name in init.php (" 
        . $gallery->session->albumName 
        . ")"; // swain
	if (!$ret) {
        $gallery->session->wasNoAlbumName = 
            "true; I could not load the album, albumname was: " . $gallery->session->albumName; // swain
		$gallery->session->albumName = "";
	} else {
		if ($gallery->album->versionOutOfDate()) {
			include($GALLERY_BASEDIR . "upgrade_album.php");
			exit;
		}
	}
}

Checked out photobucket for Jessy to see if they still allow
hotlinking; they do.

I keep forgetting what script counts skins for Jessy. I have a
generalized script, scanConfig.pl, in the 'migration' directory of the
cvs project mpa-signup. This, depending on what version, writes to
skins.out and a second Perl script, skinCount.pl, formats the output.


jeremie [to Wainstead \]: i think you were looking for something like 
this
------------------text pasted by jeremie to Emrys' 
Tavern------------------
$ host -t txt 
99.233.128.202.country-rirdata.dnsiplists.completewhois.com
99.233.128.202.country-rirdata.dnsiplists.completewhois.com text "HK -  
Hong Kong"
--------------end of text pasted by jeremie to Emrys' 
Tavern---------------
jeremie [to Wainstead \]: you can put any ip in & they will kick back 
the country code it's
registered in
Wainstead \ [to jeremie]: i was. that's a neat thing to know. thx!

---

So, rolled out more debug code that I worked out this morning;
meetings this afternoon, plus tending to skin counting and blog
counting. 


#########################################################################
050616 Thu 16 Jun 2005 10:17:22 AM EDT

New debugging output overnight:

ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose Setting: 'albumName' to album01 for subdomain marge\
nrose for script /delete_album.php
ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose User is not loaded yet. Check for username in sessi\
on.
ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose Session is: O:14:"gallerysession":10:{s:7:"version"\
;s:5:"1.4.2";s:13:"offlineAlbums";a:1:{s:10:"albums.php";b:1;}s:13:"last_accessed";d:1118891511.3500\
330448150634765625;s:10:"session_id";s:32:"4f2c9cd398eb1cbe052566b2e764eb84";s:8:"username";s:5:"adm\
in";s:7:"offline";b:0;s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"emoticon\
s";b:0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed";i:1\
00;s:17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk_us\
age";i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"266551";s:13:\
"store_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action=add_product";}s:9:"albu\
mName";s:7:"album01";s:13:"albumListPage";i:1;s:15:"wasAlbumNameSet";s:46:"true; I had an albumName \
in init.php (album01)";}
ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose Album is not loaded yet. Check for albumName in ses\
sion.
ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose mpa_fqdn => http://margenrose.myphotoalbum.com
ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose fcwt => albumheader
ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose PHPSESSID => 4f2c9cd398eb1cbe052566b2e764eb84
ma:: didn't get an object when deserializing '/mnt/cel-1/vol01/m/ma/mar/marg/marge/margenrose//album\
s/album01/album.dat'
ma:: got:  boolean
ma:: second attempt to deserialize also failed.
ma:: got:  boolean
ma:: loadFromFile returning zero.
ma:: could not load album 'album01' in Album->load! Trying to load from backups...
ma:: didn't get an object when deserializing '/mnt/cel-1/vol01/m/ma/mar/marg/marge/margenrose//album\
s/album01/album.dat.bak'
ma:: got:  boolean
ma:: second attempt to deserialize also failed.
ma:: got:  boolean
ma:: loadFromFile returning zero.
ma:: didn't get an object when deserializing '/mnt/cel-1/vol01/m/ma/mar/marg/marge/margenrose//album\
s/album01/album.bak'
ma:: got:  boolean
ma:: second attempt to deserialize also failed.
ma:: got:  boolean
ma:: loadFromFile returning zero.
ma:: couldn't load 'album01' from backups either... returning zero...
ma:: could not load album: album01
ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose delete_album.php called without delete (first call)
ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose end of line.

ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose delete_album.php called with Delete
ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose Fatal error: album not set.
ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose User is: O:12:"gallery_user":13:{s:8:"username";s:5\
:"admin";s:8:"fullname";s:13:"Administrator";s:8:"password";s:36:"jyIrd983a421688d0b0ae68b7444206b94\
b9";s:5:"email";s:15:"rose@exit45.com";s:7:"isAdmin";b:1;s:15:"canCreateAlbums";b:1;s:3:"uid";s:20:"\
1118352058_190757721";s:15:"defaultLanguage";s:0:"";s:7:"version";i:5;s:15:"recoverPassHash";N;s:10:\
"lastAction";s:5:"login";s:14:"lastActionDate";i:1118891488;s:9:"origEmail";N;}
ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose Session is: O:14:"gallerysession":10:{s:7:"version"\
;s:5:"1.4.2";s:13:"offlineAlbums";a:1:{s:10:"albums.php";b:1;}s:13:"last_accessed";d:1118891531.6276\
080608367919921875;s:10:"session_id";s:32:"4f2c9cd398eb1cbe052566b2e764eb84";s:8:"username";s:5:"adm\
in";s:7:"offline";b:0;s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"emoticon\
s";b:0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed";i:1\
00;s:17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk_us\
age";i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"266551";s:13:\
"store_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action=add_product";}s:9:"albu\
mName";s:0:"";s:13:"albumListPage";i:1;s:15:"wasAlbumNameSet";s:59:"(ret: 0) I could not load the al\
bum, albumName was: album01";}
ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose Album is: N;
ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose mpa_fqdn => http://margenrose.myphotoalbum.com
ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose fcwt => albumheader
ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose PHPSESSID => 4f2c9cd398eb1cbe052566b2e764eb84
ma:: 4f2c9cd398eb1cbe052566b2e764eb84 margenrose browser: Mozilla/4.0 (compatible; MSIE 6.0; Windows\
 NT 5.1; SV1; Hotbar 4.6.1)

So... interesting! The album cannot be loaded the FIRST time the page
is called, and that is when the albumname is removed from the session
data.

So far, nothing interesting in terms of error_log; it's 5pm and I
rolled out util.php and init.php around lunchtime. There were a couple
but they didn't make much sense. I'm doing a stat() on the so-called
missing file. But it looks like the file is being reported as not
there in the first place so the function getFile returns early.

Thinking about the Really Cheap Storage solution:

1. The provisioning process will have to create two directories, one
   on each store.
2. As files are uploaded they go to the slow storage; thumbs sized and
   highlight go to fast storage.
3. Delete has to delete from both stores.
4. Rename has to handle both stores.
5. Tim's tools (or anyone's) need to delete from both stores, or move
   the evidence or restore it.
6. A migration plan will have to happen to move all full sized images
   over to the slow storage.

What about the issue where the image uploaded is undersized, and no
sized image is created? Chris suggested we force the creation of a
sized, but that would just be a waste. But we don't want to serve
images off the RCS unless we really have to.




#########################################################################
050617 Fri 17 Jun 2005 10:26:40 AM EDT

ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui Setting: 'albumName' to album06 for subdomain ilatui for sc\
ript /delete_album.php
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui User is not loaded yet. Check for username in session.
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui Session is: O:14:"gallerysession":9:{s:7:"version";s:5:"1.4\
.2";s:13:"offlineAlbums";a:1:{s:10:"albums.php";b:1;}s:13:"last_accessed";d:1118965958.15949392318725585\
9375;s:10:"session_id";s:32:"d5b1255b9f7be78366fc643da8cb10c6";s:8:"username";s:5:"admin";s:7:"offline";\
b:0;s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"emoticons";b:0;s:4:"html";b:0;\
s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed";i:100;s:17:"bandwidth_allowed\
";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk_usage";i:0;}s:12:"package_type";\
i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"269891";s:13:"store_url_add";s:66:"http://store\
.myphotoalbum.com/shopping_cart.php?action=add_product";}s:9:"albumName";s:7:"album06";s:13:"albumListPa\
ge";i:1;}
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui Album is not loaded yet. Check for albumName in session.
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui mpa_fqdn => http://ilatui.myphotoalbum.com
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui fcwt => myphotoalbum.com
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui cookie_test => please_accept_for_session
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui __support_check => 1
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui PHPSESSID => d5b1255b9f7be78366fc643da8cb10c6
ma:: in function 'getFile': Successfully read in '/mnt/cel-1/vol01/i/il/ila/ilat/ilatu/ilatui//albums/al\
bum06/album.dat'
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui delete_album.php called without delete (first call)
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui end of line.

[Thu Jun 16 19:52:58 2005] [error] PHP Notice:  Undefined property:  album in /mnt/cel-1/vol01/linkless/\
gallery/delete_album.php on line 45
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui delete_album.php called with Delete
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui Fatal error: album not set.
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui User is: O:12:"gallery_user":13:{s:8:"username";s:5:"admin"\
;s:8:"fullname";s:13:"Administrator";s:8:"password";s:36:"GMxV9fbf8119cfa5fb9dee424e27866b9ee6";s:5:"ema\
il";s:18:"mnn4ever@yahoo.com";s:7:"isAdmin";b:1;s:15:"canCreateAlbums";b:1;s:3:"uid";s:18:"1118696036_21\
08599";s:15:"defaultLanguage";s:0:"";s:7:"version";i:5;s:15:"recoverPassHash";N;s:10:"lastAction";s:5:"l\
ogin";s:14:"lastActionDate";i:1118965947;s:9:"origEmail";N;}
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui Session is: O:14:"gallerysession":10:{s:7:"version";s:5:"1.\
4.2";s:13:"offlineAlbums";a:1:{s:10:"albums.php";b:1;}s:13:"last_accessed";d:1118965978.2419021129608154\
296875;s:10:"session_id";s:32:"d5b1255b9f7be78366fc643da8cb10c6";s:8:"username";s:5:"admin";s:7:"offline\
";b:0;s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"emoticons";b:0;s:4:"html";b:\
0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed";i:100;s:17:"bandwidth_allow\
ed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk_usage";i:0;}s:12:"package_type\
";i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"269891";s:13:"store_url_add";s:66:"http://sto\
re.myphotoalbum.com/shopping_cart.php?action=add_product";}s:9:"albumName";s:0:"";s:13:"albumListPage";i\
:1;s:15:"wasAlbumNameSet";s:46:"true; I had an albumName in init.php (album06)";}
[Thu Jun 16 19:52:58 2005] [error] PHP Notice:  Undefined property:  album in /mnt/cel-1/vol01/linkless/\
gallery/delete_album.php on line 64
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui Album is: N;
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui mpa_fqdn => http://ilatui.myphotoalbum.com
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui fcwt => myphotoalbum.com
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui cookie_test => please_accept_for_session
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui __support_check => 1
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui PHPSESSID => d5b1255b9f7be78366fc643da8cb10c6
ma:: d5b1255b9f7be78366fc643da8cb10c6 ilatui browser: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;\
 SV1)

A setback! This doesn't conform at all to the previous cases. Let's
check the session timestamps:

Thu Jun 16 19:52:38 2005
Thu Jun 16 19:52:58 2005

Twenty seconds. The cookie IDs match.


Command for filtering error logs:

grep -i error error_log.1118966400 | grep -v 'Nonfatal Error' | grep -v 'File does not exist' |  grep -v
 'Duplicate entry' | grep -v 'A session is active' | grep -v 'PHP
 Warning' | grep -v 'Invalid URI' | head -200

Finding method calls on non-objects:

#!/opt/perl5/bin/perl -w                                                                                 

use strict;

my %h = ();

open LOG, "< error_log.1118966400" or die $!;

while (<LOG>) {
    next unless /Call to a member function on a non-object/;
    chomp;
    my ($crap, $stuff) = split /non-object in /, $_, 2;
    $h{$stuff}++;
}

foreach my $key (keys %h) {
    print "$key: $h{$key}\n";
}

And another today:

ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears Setting: 'albumName' to album02 for subdomain electr\
ictears for script /delete_album.php
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears User is not loaded yet. Check for username in sessio\
n.
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears Session is: O:14:"gallerysession":11:{s:7:"version";\
s:5:"1.4.2";s:13:"offlineAlbums";a:3:{s:10:"albums.php";b:1;s:7:"album01";b:1;s:7:"album02";b:1;}s:13:"l\
ast_accessed";d:1119034043.8032329082489013671875;s:10:"session_id";s:32:"c9743bfa2e71e172d9476a9eea30c8\
43";s:8:"username";s:5:"admin";s:7:"offline";b:0;s:9:"albumName";s:7:"album02";s:13:"albumListPage";i:1;\
s:15:"wasAlbumNameSet";s:46:"true; I had an albumName in init.php (album02)";s:11:"viewedAlbum";a:2:{s:7\
:"album01";i:1;s:7:"album02";i:1;}s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"\
emoticons";b:0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed"\
;i:100;s:17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk_us\
age";i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"273415";s:13:"sto\
re_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action=add_product";}}
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears Album is not loaded yet. Check for albumName in sess\
ion.
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears fcwt => joinlink
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears mpa_fqdn => http://electrictears.myphotoalbum.com
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears __support_check => 1
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears PHPSESSID => c9743bfa2e71e172d9476a9eea30c843
ma:: in function 'getFile': Successfully read in '/mnt/cel-1/vol01/e/el/ele/elec/elect/electrictears//al\
bums/album02/album.dat'
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears delete_album.php called without delete (first call)
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears end of line.


[Fri Jun 17 14:47:31 2005] [error] PHP Notice:  Undefined property:  album in /mnt/cel-1/vol01/linkless/\
gallery/delete_album.php on line 45
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears delete_album.php called with Delete
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears Fatal error: album not set.
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears User is: O:12:"gallery_user":13:{s:8:"username";s:5:\
"admin";s:8:"fullname";s:13:"Administrator";s:8:"password";s:36:"cc6C1f87c2fc6f5f54130e7bc4775aca4bd0";s\
:5:"email";s:23:"themoonlitsun@yahoo.com";s:7:"isAdmin";b:1;s:15:"canCreateAlbums";b:1;s:3:"uid";s:21:"1\
119032987_1938520687";s:15:"defaultLanguage";s:0:"";s:7:"version";i:5;s:15:"recoverPassHash";N;s:10:"las\
tAction";s:5:"login";s:14:"lastActionDate";i:1119032999;s:9:"origEmail";N;}
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears Session is: O:14:"gallerysession":11:{s:7:"version";\
s:5:"1.4.2";s:13:"offlineAlbums";a:3:{s:10:"albums.php";b:1;s:7:"album01";b:1;s:7:"album02";b:1;}s:13:"l\
ast_accessed";d:1119034051.9873120784759521484375;s:10:"session_id";s:32:"c9743bfa2e71e172d9476a9eea30c8\
43";s:8:"username";s:5:"admin";s:7:"offline";b:0;s:9:"albumName";s:0:"";s:13:"albumListPage";i:1;s:15:"w\
asAlbumNameSet";s:46:"true; I had an albumName in init.php (album02)";s:11:"viewedAlbum";a:2:{s:7:"album\
01";i:1;s:7:"album02";i:1;}s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"emotico\
ns";b:0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed";i:100;\
s:17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk_usage";i:\
0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"273415";s:13:"store_url_\
add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action=add_product";}}
[Fri Jun 17 14:47:31 2005] [error] PHP Notice:  Undefined property:  album in /mnt/cel-1/vol01/linkless/\
gallery/delete_album.php on line 64
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears Album is: N;
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears fcwt => joinlink
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears mpa_fqdn => http://electrictears.myphotoalbum.com
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears __support_check => 1
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears PHPSESSID => c9743bfa2e71e172d9476a9eea30c843
ma:: c9743bfa2e71e172d9476a9eea30c843 electrictears browser: Mozilla/4.0 (compatible; MSIE 6.0; Windows \
NT 5.1; SV1; .NET CLR 1.1.4322)

For this situation my guess is the albums.php page is not
reloading... well, but, the album.dat file is loaded! Hrmm.


I can't remember what I needed this for; so I document it here. This
matches lines output to a comint-mode buffer (shell buffer) and
performs an action. I had this all along, in
comint-watch-for-password-prompt. This is functionally like Expect.


(defvar swain-regexp "foo" "This is a documentation string.")

(defun swain-watch-for-stuff (string)
  "Copied from `comint-watch-for-password-prompt'. This function should be in the list `comint-output-filter-functions'."
  (when (string-match swain-regexp string)
    ;; perform action when output is matched
    (message "I see the foo.")))

(add-hook 'comint-output-filter-functions
          'swain-watch-for-stuff)


Hacked up a way to order the entire album from the albums.php
page. Works fine, but I'm still ill thinking about all the extra
cycles used for that.


#########################################################################
050620 Mon 20 Jun 2005 11:18:56 AM EDT

Updated one order that failed to upload last night: 2287. Emailed
Jessy and Fernando just in case. Jessy is in Miami until tomorrow.

Tucows guys are here and we are supposed to start looking at skinning
and such on CCS starting at 2pm. This is of less interest to me, since
CCS is not what we want to use to build a signup wizard. Then again
there's the lame duck factor. We had a kickoff meeting about 10am.

I spent some time spelunking on web-1.ampira.com looking for survey
form stuff. Fernando got very little from Chris, as it happens. I need
to pay closer attention to this sort of thing.

It would appear that sometimes users are clicking OK to delete more
than once on the same album. Here's my theory:

The user clicks "delete album" and they get the pop up. They click OK,
and the popup goes away. But the main page does not reload, so they
click "delete album" again. This time we see a flurry of errors as the
album dat file cannot be loaded. At this point the popup should fail,
telling them the album they want to delete cannot be found.

But this is not the only case I'm seeing in the error logs, as this
sequence shows:

ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 Setting: 'albumName' to album04 for subdomain imze\
r0 for script /delete_album.php
ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 User is not loaded yet. Check for username in sess\
ion.
ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 Session is: O:14:"gallerysession":12:{s:7:"version\
";s:5:"1.4.2";s:9:"albumName";s:7:"album04";s:13:"offlineAlbums";a:4:{s:7:"album01";b:1;s:10:"a\
lbums.php";b:1;s:7:"album04";b:1;s:7:"album03";b:1;}s:13:"last_accessed";d:1119237837.208872079\
8492431640625;s:10:"session_id";s:32:"15c399fc4c235d17df2ad6af2be62978";s:8:"username";s:5:"adm\
in";s:7:"offline";b:0;s:15:"wasAlbumNameSet";s:46:"true; I had an albumName in init.php (album0\
3)";s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"emoticons";b:0;s:4:"h\
tml";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed";i:100;s:17:\
"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk_usage\
";i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"269932";s:1\
3:"store_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action=add_product";}s:\
11:"viewedAlbum";a:3:{s:7:"album01";i:1;s:7:"album04";i:1;s:7:"album03";i:1;}s:13:"albumListPag\
e";i:1;s:9:"albumPage";a:1:{s:7:"album03";s:1:"2";}}                                            
ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 Album is not loaded yet. Check for albumName in se\
ssion.
ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 mpa_fqdn => http://imzer0.myphotoalbum.com
ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 fcwt => albumlogo
ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 PHPSESSID => 15c399fc4c235d17df2ad6af2be62978
ma:: in function 'getFile': Successfully read in '/mnt/cel-1/vol01/i/im/imz/imze/imzer/imzer0//\
albums/album04/album.dat'
ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 delete_album.php called without delete (first call\
)
ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 end of line.

ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 delete_album.php called with Delete
ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 Fatal error: album not set.
ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 User is: O:12:"gallery_user":13:{s:8:"username";s:\
5:"admin";s:8:"fullname";s:13:"Administrator";s:8:"password";s:36:"1LDQ6339819e5590df79be77bce8\
637ae8f7";s:5:"email";s:20:"kayler28@hotmail.com";s:7:"isAdmin";b:1;s:15:"canCreateAlbums";b:1;\
s:3:"uid";s:20:"1118700950_873031044";s:15:"defaultLanguage";s:0:"";s:7:"version";i:5;s:15:"rec\
overPassHash";N;s:10:"lastAction";s:5:"login";s:14:"lastActionDate";i:1119235441;s:9:"origEmail\
";N;}                                                                                           
ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 Session is: O:14:"gallerysession":11:{s:7:"version\
";s:5:"1.4.2";s:9:"albumName";s:0:"";s:13:"offlineAlbums";a:4:{s:7:"album01";b:1;s:10:"albums.p\
hp";b:1;s:7:"album04";b:1;s:7:"album03";b:1;}s:13:"last_accessed";d:1119237889.5945029258728027\
34375;s:10:"session_id";s:32:"15c399fc4c235d17df2ad6af2be62978";s:8:"username";s:5:"admin";s:7:\
"offline";b:0;s:15:"wasAlbumNameSet";s:46:"true; I had an albumName in init.php (album03)";s:4:\
"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"emoticons";b:0;s:4:"html";b:0\
;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed";i:100;s:17:"bandwid\
th_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk_usage";i:0;}s\
:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"269932";s:13:"store\
_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action=add_product";}s:11:"view\
edAlbum";a:3:{s:7:"album01";i:1;s:7:"album04";i:1;s:7:"album03";i:1;}s:13:"albumListPage";i:1;}
[Sun Jun 19 23:24:49 2005] [error] PHP Notice:  Undefined property:  album in /mnt/cel-1/vol01/\
linkless/gallery/delete_album.php on line 64
ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 Album is: N;                                       
ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 mpa_fqdn => http://imzer0.myphotoalbum.com
ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 fcwt => albumlogo
ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 PHPSESSID => 15c399fc4c235d17df2ad6af2be62978
ma:: 15c399fc4c235d17df2ad6af2be62978 imzer0 browser: Mozilla/5.0 (Windows; U; Windows NT 5.1; \
en-US; rv:1.7.8) Gecko/20050511 Firefox/1.0.4                                 

Note that the user clicked album04 to delete; but in the session it
says album03, for both the first and second requests to
delete_album.php.

So, when the album cannot be loaded when delete_album.php is called,
this shoud be an error that gets trapped. By commenting out the line
dismissAndReload() I was able to recreate the former bug described
above.

I should also check the official Gallery project's ChangeLog or bug
database to see if this has already been addressed, or more to the
point, install the latest 1.x and test it there.

In delete_album.php I tried:

if (isset($gallery->album)) {
    stderr("We have an album.");
    // this will be 1 if the photos were 'loaded' (even if there were no photos, it's still set to 1.)
    stderr("photosloaded: '" . $gallery->album->transient->photosloaded . "'");
} else {
    stderr("We do NOT have an album.");
}


But it turns out I'm using wrongheaded thinking. If there is no
albumName in the session then $gallery->album is not set at all on the
next call to delete_album.php. So... isset() is sufficient.

Rolled out new copy of delete_album.php. It's the new version that
shows you the album cover. If they click the "delete" button and the
popup cannot load the album, they get an error message. This should
whittle down the number of instances by quite a bit.

ma:: c7edc2a805a091fe74ec7d733653780a ilatui Setting: 'albumName' to album06 for subdomain ilat\
ui for script /delete_album.php
ma:: c7edc2a805a091fe74ec7d733653780a ilatui User is not loaded yet. Check for username in sess\
ion.
ma:: c7edc2a805a091fe74ec7d733653780a ilatui Session is: O:14:"gallerysession":9:{s:7:"version"\
;s:5:"1.4.2";s:13:"offlineAlbums";a:1:{s:10:"albums.php";b:1;}s:13:"last_accessed";d:1119303308\
.7925970554351806640625;s:10:"session_id";s:32:"c7edc2a805a091fe74ec7d733653780a";s:8:"username\
";s:5:"admin";s:7:"offline";b:0;s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:\
0;s:9:"emoticons";b:0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"di\
skspace_allowed";i:100;s:17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_pr\
inting";b:0;s:10:"disk_usage";i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s\
:6:"userid";s:6:"269891";s:13:"store_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart\
.php?action=add_product";}s:9:"albumName";s:7:"album06";s:13:"albumListPage";i:1;}              
ma:: c7edc2a805a091fe74ec7d733653780a ilatui Album is not loaded yet. Check for albumName in se\
ssion.
ma:: c7edc2a805a091fe74ec7d733653780a ilatui __support_check => 1
ma:: c7edc2a805a091fe74ec7d733653780a ilatui fcwt => myphotoalbum.com
ma:: c7edc2a805a091fe74ec7d733653780a ilatui mpa_fqdn => http://ilatui.myphotoalbum.com
ma:: c7edc2a805a091fe74ec7d733653780a ilatui PHPSESSID => c7edc2a805a091fe74ec7d733653780a
ma:: in function 'getFile': Successfully read in '/mnt/cel-1/vol01/i/il/ila/ilat/ilatu/ilatui//\
albums/album06/album.dat'
ma:: c7edc2a805a091fe74ec7d733653780a ilatui delete_album.php called without delete (first call\
)
ma:: c7edc2a805a091fe74ec7d733653780a ilatui end of line.
ma:: title of album selected for deletion (not its name!): 'Jun 14 2005  1:40pm'
ma:: photosloaded equals 1

[Mon Jun 20 17:35:33 2005] [error] PHP Notice:  Undefined property:  album in /mnt/cel-1/vol01/\
linkless/gallery/delete_album.php on line 45
ma:: c7edc2a805a091fe74ec7d733653780a ilatui delete_album.php called with Delete
ma:: c7edc2a805a091fe74ec7d733653780a ilatui Fatal error: album not set.
ma:: c7edc2a805a091fe74ec7d733653780a ilatui User is: O:12:"gallery_user":13:{s:8:"username";s:\
5:"admin";s:8:"fullname";s:13:"Administrator";s:8:"password";s:36:"GMxV9fbf8119cfa5fb9dee424e27\
866b9ee6";s:5:"email";s:18:"mnn4ever@yahoo.com";s:7:"isAdmin";b:1;s:15:"canCreateAlbums";b:1;s:\
3:"uid";s:18:"1118696036_2108599";s:15:"defaultLanguage";s:0:"";s:7:"version";i:5;s:15:"recover\
PassHash";N;s:10:"lastAction";s:5:"login";s:14:"lastActionDate";i:1119303283;s:9:"origEmail";N;\
}                                                                                               
ma:: c7edc2a805a091fe74ec7d733653780a ilatui Session is: O:14:"gallerysession":10:{s:7:"version\
";s:5:"1.4.2";s:13:"offlineAlbums";a:1:{s:10:"albums.php";b:1;}s:13:"last_accessed";d:111930333\
3.0340530872344970703125;s:10:"session_id";s:32:"c7edc2a805a091fe74ec7d733653780a";s:8:"usernam\
e";s:5:"admin";s:7:"offline";b:0;s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b\
:0;s:9:"emoticons";b:0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"d\
iskspace_allowed";i:100;s:17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_p\
rinting";b:0;s:10:"disk_usage";i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";\
s:6:"userid";s:6:"269891";s:13:"store_url_add";s:66:"http://store.myphotoalbum.com/shopping_car\
t.php?action=add_product";}s:9:"albumName";s:0:"";s:13:"albumListPage";i:1;s:15:"wasAlbumNameSe\
t";s:46:"true; I had an albumName in init.php (album06)";}                                      
[Mon Jun 20 17:35:33 2005] [error] PHP Notice:  Undefined property:  album in /mnt/cel-1/vol01/\
linkless/gallery/delete_album.php on line 64
ma:: c7edc2a805a091fe74ec7d733653780a ilatui Album is: N;                                       
ma:: c7edc2a805a091fe74ec7d733653780a ilatui __support_check => 1
ma:: c7edc2a805a091fe74ec7d733653780a ilatui fcwt => myphotoalbum.com
ma:: c7edc2a805a091fe74ec7d733653780a ilatui mpa_fqdn => http://ilatui.myphotoalbum.com
ma:: c7edc2a805a091fe74ec7d733653780a ilatui PHPSESSID => c7edc2a805a091fe74ec7d733653780a
ma:: c7edc2a805a091fe74ec7d733653780a ilatui browser: Mozilla/4.0 (compatible; MSIE 6.0; Window\
s NT 5.1; SV1)                                                                                  


Here then is a true mystery delete. I wonder why the init.php stuff
does not print the session data on the second call to
delete_album.php? It never has. Time to test it out.




#########################################################################
050621 Tue 21 Jun 2005 11:35:36 AM EDT

So here's the new inconsistency. Now that I've handled the case where
the parent does not seem to reload, I'm left with the mystery of why
the second call to delete_album.php (where the user clicks "OK") does
not show any debug output for loading the dat file:

ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb Setting: 'albumName' to album01 for subdomain darsweb fo\
r script /delete_album.php
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb User is not loaded yet. Check for username in session.
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb Session is: O:14:"gallerysession":11:{s:7:"version";s:5:\
"1.4.2";s:13:"offlineAlbums";a:2:{s:10:"albums.php";b:1;s:7:"album03";b:1;}s:13:"last_accessed";d:1119\
318986.7040379047393798828125;s:10:"session_id";s:32:"0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8";s:8:"username"\
;s:5:"admin";s:7:"offline";b:0;s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"e\
moticons";b:0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed\
";i:100;s:17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk\
_usage";i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"275316";s:13\
:"store_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action=add_product";}s:9:"album\
Name";s:7:"album01";s:13:"albumListPage";i:1;s:15:"wasAlbumNameSet";s:46:"true; I had an albumName in \
init.php (album03)";s:11:"viewedAlbum";a:1:{s:7:"album03";i:1;}}
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb Album is not loaded yet. Check for albumName in session.
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb fcwt => myblogsiteNAV
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb mpa_fqdn => http://darsweb.myphotoalbum.com
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb PHPSESSID => 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8
ma:: in function 'getFile': Successfully read in '/mnt/cel-1/vol01/d/da/dar/dars/darsw/darsweb//albums\
/album01/album.dat'
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb delete_album.php called without delete (first call)
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb end of line.
ma:: title of album selected for deletion (not its name!): 'Jun 20 2005  1:25am'
ma:: photosloaded equals 1

[Mon Jun 20 21:57:39 2005] [error] [client 71.97.157.137] File does not exist: /mnt/cel-1/vol01/linkle\
ss/gallery/css/mpa.css
[Mon Jun 20 21:57:41 2005] [error] [client 202.156.2.18] File does not exist: /mnt/cel-1/vol01/linkles\
s/gallery/Blue

[Mon Jun 20 21:57:45 2005] [error] PHP Notice:  Undefined property:  album in /mnt/cel-1/vol01/linkles\
s/gallery/delete_album.php on line 45
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb delete_album.php called with Delete
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb Fatal error: album not set.
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb User is: O:12:"gallery_user":13:{s:8:"username";s:5:"adm\
in";s:8:"fullname";s:13:"Administrator";s:8:"password";s:36:"JBRZ6be4cadbd3199f80055b8ed7a184a61a";s:5\
:"email";s:19:"darsweb@hotmail.com";s:7:"isAdmin";b:1;s:15:"canCreateAlbums";b:1;s:3:"uid";s:21:"11192\
45123_1627823706";s:15:"defaultLanguage";s:0:"";s:7:"version";i:5;s:15:"recoverPassHash";N;s:10:"lastA\
ction";s:5:"login";s:14:"lastActionDate";i:1119318842;s:9:"origEmail";N;}
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb Session is: O:14:"gallerysession":11:{s:7:"version";s:5:\
"1.4.2";s:13:"offlineAlbums";a:2:{s:10:"albums.php";b:1;s:7:"album03";b:1;}s:13:"last_accessed";d:1119\
319065.0271999835968017578125;s:10:"session_id";s:32:"0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8";s:8:"username"\
;s:5:"admin";s:7:"offline";b:0;s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"e\
moticons";b:0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed\
";i:100;s:17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk\
_usage";i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"275316";s:13\
:"store_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action=add_product";}s:9:"album\
Name";s:0:"";s:13:"albumListPage";i:1;s:15:"wasAlbumNameSet";s:46:"true; I had an albumName in init.ph\
p (album01)";s:11:"viewedAlbum";a:1:{s:7:"album03";i:1;}}
[Mon Jun 20 21:57:45 2005] [error] PHP Notice:  Undefined property:  album in /mnt/cel-1/vol01/linkles\
s/gallery/delete_album.php on line 64
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb Album is: N;
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb fcwt => myblogsiteNAV
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb mpa_fqdn => http://darsweb.myphotoalbum.com
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb PHPSESSID => 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8
ma:: 0a6a7b2ab5c47ec78fbe7b9ce6b5fdd8 darsweb browser: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5\
.1; SV1)

Note the first line of the second request is about the undefined
$gallery->album. This means the album was not loaded in init.php.

Well, a few print statements solved that. In the second call, no form
variable is passed to update_session_var that triggers the stderr
calls. So that has to be worked out; for every call to
delete_album.php I want the session printed out once and only once.



in ah_register.php if someone ever adds code to blow away the options
passed in, then the short circuit approach will be broken. This would
happen after an upgrade.




#########################################################################
050622 Wed 22 Jun 2005 05:14:25 PM EDT

TypoLesbo: are pi sire
TypoLesbo: are upi sire ots pit
TypoLesbo: one more time...



#########################################################################
050623 Thu 23 Jun 2005 12:10:36 PM EDT

What a *trying* last couple of days. The CCS/Plat stuff has drained
me; I've been doing tweaks and rollouts for Jessy; and I added code
right this morning for the missing albumname issue and barely had time
to test it.

At this point I think I have done what I need to do for the CCS
stuff. Joel unfortunately did more work than he should have, work that
I should have done, but then my opinion on those modifications are
well known to myself.




#########################################################################
050624 Fri 24 Jun 2005 09:39:25 AM EDT

This is the most complete picture yet of the missing albumName
bug. Still, it seems it disappears when the session is written to the
database or read from the database at the end of call 1 or beginning
of call 2, respectively.

ma::   User is not loaded yet. Check for username in session.

ma::   Session is: O:14:"gallerysession":11:{s:7:"version";s:5:"1.4.2";s:9:"albumName";s:7:"album02";s\
:13:"offlineAlbums";a:4:{s:7:"album01";b:1;s:10:"albums.php";b:1;s:7:"album05";b:1;s:7:"album06";b:1;}\
s:13:"last_accessed";d:1119593718.7900130748748779296875;s:10:"session_id";s:32:"5d0123179af01bc2248ec\
5d3b7689bfb";s:8:"username";s:5:"admin";s:7:"offline";b:0;s:15:"wasAlbumNameSet";s:46:"true; I had an \
albumName in init.php (album02)";s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:\
"emoticons";b:0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allow\
ed";i:100;s:17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"di\
sk_usage";i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"251767";s:\
13:"store_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action=add_product";}s:11:"vi\
ewedAlbum";a:3:{s:7:"album01";i:1;s:7:"album05";i:1;s:7:"album06";i:1;}s:13:"albumListPage";s:1:"1";}

ma::   Album is not loaded yet. Check for albumName in session.
ma::   PHPSESSID => 5d0123179af01bc2248ec5d3b7689bfb
ma::   mpa_fqdn => http://vipin.myphotoalbum.com

ma:: 5d0123179af01bc2248ec5d3b7689bfb vipin Setting: 'albumName' to album02 for subdomain vipin for sc\
ript /delete_album.php

ma:: in function 'getFile': Successfully read in '/mnt/cel-1/vol01/v/vi/vip/vipi/vipin/vipin//albums/a\
lbum02/album.dat'

ma:: 5d0123179af01bc2248ec5d3b7689bfb vipin delete_album.php called without delete (first call)
ma:: 5d0123179af01bc2248ec5d3b7689bfb vipin end of line.
ma:: title of album selected for deletion (not its name!): 'Jun 24 2005  1:43am'
ma:: photosloaded equals 1

ma:: 5d0123179af01bc2248ec5d3b7689bfb vipin first call to delete_album.php Session is: O:14:"galleryse\
ssion":11:{s:7:"version";s:5:"1.4.2";s:9:"albumName";s:7:"album02";s:13:"offlineAlbums";a:4:{s:7:"albu\
m01";b:1;s:10:"albums.php";b:1;s:7:"album05";b:1;s:7:"album06";b:1;}s:13:"last_accessed";d:1119593813.\
1890509128570556640625;s:10:"session_id";s:32:"5d0123179af01bc2248ec5d3b7689bfb";s:8:"username";s:5:"a\
dmin";s:7:"offline";b:0;s:15:"wasAlbumNameSet";s:46:"true; I had an albumName in init.php (album02)";s\
:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"emoticons";b:0;s:4:"html";b:0;s:8\
:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed";i:100;s:17:"bandwidth_allowed"\
;i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk_usage";i:0;}s:12:"package_type"\
;i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"251767";s:13:"store_url_add";s:66:"http://st\
ore.myphotoalbum.com/shopping_cart.php?action=add_product";}s:11:"viewedAlbum";a:3:{s:7:"album01";i:1;\
s:7:"album05";i:1;s:7:"album06";i:1;}s:13:"albumListPage";s:1:"1";}


[start second call]

ma::   User is not loaded yet. Check for username in session.
ma::   Session is: O:14:"gallerysession":11:{s:7:"version";s:5:"1.4.2";s:9:"albumName";s:0:"";s:13:"of\
flineAlbums";a:4:{s:7:"album01";b:1;s:10:"albums.php";b:1;s:7:"album05";b:1;s:7:"album06";b:1;}s:13:"
last_accessed";d:1119593839.0706179141998291015625;s:10:"session_id";s:32:"5d0123179af01bc2248ec5d3b768\
9bfb";s:8:"username";s:5:"admin";s:7:"offline";b:0;s:15:"wasAlbumNameSet";s:46:"true; I had an albumNa\
me in init.php (album02)";s:4:"prem";O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"emotic\
ons";b:0;s:4:"html";b:0;s:8:"printing";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed";i:1\
00;s:17:"bandwidth_allowed";i:1;s:11:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk_usag\
e";i:0;}s:12:"package_type";i:0;s:19:"packages_history_id";s:1:"0";s:6:"userid";s:6:"251767";s:13:"sto\
re_url_add";s:66:"http://store.myphotoalbum.com/shopping_cart.php?action=add_product";}s:11:"viewedAlb\
um";a:3:{s:7:"album01";i:1;s:7:"album05";i:1;s:7:"album06";i:1;}s:13:"albumListPage";s:1:"2";}
ma::   Album is not loaded yet. Check for albumName in session.
ma::   PHPSESSID => 5d0123179af01bc2248ec5d3b7689bfb
ma::   mpa_fqdn => http://vipin.myphotoalbum.com
[Fri Jun 24 02:17:34 2005] [error] PHP Notice:  Undefined property:  album in /mnt/cel-1/vol01/linkles\
s/gallery/delete_album.php on line 57
ma:: 5d0123179af01bc2248ec5d3b7689bfb vipin delete_album.php called with Delete
ma:: 5d0123179af01bc2248ec5d3b7689bfb vipin Fatal error: album not set.
ma:: 5d0123179af01bc2248ec5d3b7689bfb vipin albumName: ''
ma:: 5d0123179af01bc2248ec5d3b7689bfb vipin User is: O:12:"gallery_user":13:{s:8:"username";s:5:"admin\
";s:8:"fullname";s:13:"Administrator";s:8:"password";s:36:"v5Oo682d8cbc1fa2da995c598c07b275b1f0";s:5:"\
email";s:18:"pv_vipin@yahoo.com";s:7:"isAdmin";b:1;s:15:"canCreateAlbums";b:1;s:3:"uid";s:21:"11168368\
63_1951612197";s:15:"defaultLanguage";s:0:"";s:7:"version";i:5;s:15:"recoverPassHash";N;s:10:"lastActi\
on";s:5:"login";s:14:"lastActionDate";i:1119587593;s:9:"origEmail";N;}
ma:: 5d0123179af01bc2248ec5d3b7689bfb vipin Failed delete call's session Session is: O:14:"gallerysess\
ion":11:{s:7:"version";s:5:"1.4.2";s:9:"albumName";s:0:"";s:13:"offlineAlbums";a:4:{s:7:"album01";b:1;\
s:10:"albums.php";b:1;s:7:"album05";b:1;s:7:"album06";b:1;}s:13:"last_accessed";d:1119593854.243642091\
7510986328125;s:10:"session_id";s:32:"5d0123179af01bc2248ec5d3b7689bfb";s:8:"username";s:5:"admin";s:7\
:"offline";b:0;s:15:"wasAlbumNameSet";s:46:"true; I had an albumName in init.php (album02)";s:4:"prem"\
;O:7:"premium":5:{s:7:"premium";a:11:{s:6:"frames";b:0;s:9:"emoticons";b:0;s:4:"html";b:0;s:8:"printin\
g";i:1;s:3:"ads";b:0;s:6:"themes";b:0;s:17:"diskspace_allowed";i:100;s:17:"bandwidth_allowed";i:1;s:11\
:"has_expired";b:0;s:20:"can_disable_printing";b:0;s:10:"disk_usage";i:0;}s:12:"package_type";i:0;s:19\
:"packages_history_id";s:1:"0";s:6:"userid";s:6:"251767";s:13:"store_url_add";s:66:"http://store.mypho\
toalbum.com/shopping_cart.php?action=add_product";}s:11:"viewedAlbum";a:3:{s:7:"album01";i:1;s:7:"albu\
m05";i:1;s:7:"album06";i:1;}s:13:"albumListPage";s:1:"2";}
[Fri Jun 24 02:17:34 2005] [error] PHP Notice:  Undefined property:  album in /mnt/cel-1/vol01/linkles\
s/gallery/delete_album.php on line 77
ma:: 5d0123179af01bc2248ec5d3b7689bfb vipin Album is: N;
ma:: 5d0123179af01bc2248ec5d3b7689bfb vipin PHPSESSID => 5d0123179af01bc2248ec5d3b7689bfb
ma:: 5d0123179af01bc2248ec5d3b7689bfb vipin mpa_fqdn => http://vipin.myphotoalbum.com
ma:: 5d0123179af01bc2248ec5d3b7689bfb vipin browser: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0\
)

While monitoring my latest changes, I may have seen the answer: I saw
a "write called" string, which I left in for kicks, and then a great
many seconds later, I the session data written to the log. Very
weird. It might do to add timestamps to every debug statement.

So... it could be a race condition where albums.php clears the
albumName from the session before delete_album.php manages to do its
job. Curious. If I put a variable in the session I might be able to
track that.




#########################################################################
050627 Mon 27 Jun 2005 11:37:22 AM EDT

Friday I solved the issue, finally. It was a race condition of sorts;
I changed delete_album.php so that the album name is passed explicitly
in the page. It turned out a user could:

click delete album
navigate in the main page to a new album
click delete in the popup
gallery deletes the wrong album because albumName changes in the
session.

Created a page in Twiki explaining how to deal with child
porn.
https://twiki.corp.fortunecity.com/bin/view/Fortunecity/MpaDeletingChildPorn




#########################################################################
050629 Wed 29 Jun 2005 11:58:54 AM EDT

Swamped again from all sides. Today I debugged a problem introduced in
view_album.php, presumably by Tree's ajax stuff. I just added a new
sub to Ronny's ftp uploader to timestamp the error messages. Sent more
orders through again: six failed yesterday afternoon.

Yesterday I found Jessy had been committing changes to the branch of
Gallery from May 23rd, so that was a disaster that had to be cleared
up. She did most of the fixing. It was giving Fernando fits because he
couldn't find her changes in HEAD.

I'm up against a deep problem at this point... I have a new album
being created on both stores, and the original is loaded to the mass
store but it somehow also winds up in the fast store.

I think my first approach might be wrong. Copying from tmp to mass
might be a needless step. Not sure yet.


#########################################################################
050630 Thu 30 Jun 2005 10:45:28 AM EDT

Rolled out another change to the ftp script: connect/disconnect per
order.

Rolled out pwgif for Fernando. One order failed yesterday; DPI does
timeout after 15 minutes.




#########################################################################
050701 Fri 01 Jul 2005 02:37:53 PM EDT

Found the text for the error message for Keisha, emailed her. Also
found that the selector.shtml page linked to the wrong ccs page,
emailed how to fix that too.

Pushed a bunch of jobs through for Jessy.




#########################################################################
050705 Tue 05 Jul 2005 09:54:14 AM EDT

The rollout of the store was blocked when Plookfish showed that the
database slowed to a crawl. The problem is we keep 21 days of
temporary shopping carts; OSC does a full text search on these. I
stated that if dropping these after 12 hours solved the problem for
now, we should do that for a rollout. Trevor is about 80% done with a
new indexing scheme. Jessy said she had no problems with one penny
rounding errors.

Showed Tree how to create new Twiki pages and set him off on the
badass project. Thursday he's to give a presentation on the secure
storage of credit card numbers.

3pm, finally done with meetings, site fixing, detective work etc.

One order failed over the weekend, still looks like a timeout issue.

Worked out a new function for ampira.local.php that returns the five
levels path. Updated method in Album.php to use it. Now I just have to
store the bob-1 path somewhere.

Modified mysql.sessions.inc per Ferry's request to redirect to
maint.shtml. Merged changes from branch to trunk.




#########################################################################
050714 Thu 14 Jul 2005 10:34:48 AM EDT

Back from four days off. Disappointed that neither Trevor nor Tree
have any documentation to show me. Had to quibble over the need for
this with Jessy in the standup.




#########################################################################
050715 Fri 15 Jul 2005 05:17:40 PM EDT

Busy day so far. Rollouts for Jessy and Fernando; cleaned 182 pages
out of Twiki (almost all Evolutionware) and moved a bunch into a new
MPA web; filed a bug for Ops on the config.php file writing issue,
which is clearly some nfs bug; helped Jessy, helped Chris with Perl
coding, helped Keisha and Ching Yi with FC.com, Fernando with stuff,
and on and on. Also we had another goodbye lunch for Rob, this being
the official company goodbye at Rub.




#########################################################################
050718 Mon 18 Jul 2005 11:21:42 AM EDT

Peter pushing for due dates. Long discussion in the Monday tech staff
meeting. Trev thinks 2.5 weeks just on payment gateway; a bunch of
things have to happen there. But the store is on staging, and I found
the magickwand extension for PHP this weekend. Jessy will spec it, I
am on the third stage of the dual storage solution (image
manipulation, now that uploading and displaying work).


#########################################################################
050720 Wed 20 Jul 2005 11:37:21 AM EDT

It's 11:30 and I just finished processing orders for Jessy.

On Monday evening Fernando mistakenly updated all orders to
orders_status of 2 with an errant UPDATE statement. This, on top of
mdb-1 failing, and Inflow botching a storage upgrade, left MPA order
processing in a shambles. We are still recovering from it.

Working late on Monday to undo Fernando's mistake, we used the data in
the order status history table to fix the orders table. I don't think
the status history table is being updated correctly though. We had 210
orders of status 5, meaning they were ready to ship to DPI! That can't
be right. So we set them at 99 for the time being. The system has been
updating them as they are shipped.

Yesterday morning I wrote a Perl script to rotate the logs and email
the list of errors in the log. Today I did not receive the email. I
then spent the afternoon writing a script to fix the missing album of
one of the lost 80; I succeeded, and this is a precursor to writing a
script to create .sized. images for all sites that lack them.

I then spent the evening working on the orders mess. Today I finished
up looking at the ones Jessy requested and carefully documented the
state of all of them.

Trevor is ready to release the store to production. Last minute fix:
the paths to the images purchased is stored differently now. He's
"putting in a fix" which makes me wary because it might mean a new
bug.




#########################################################################
050726 Tue 26 Jul 2005 03:45:05 PM EDT

I duplicated all my work on Bork on staging for CCS, since there's no
way to sync the two. Alas. It's in Keisha's hands now to get the
template right.

I think I can make Gallery aware of both storage units for raw
images. fmarte2 continues to stymie me though... is it the
permissions?




#########################################################################
050728 Thu 28 Jul 2005 06:34:34 PM EDT

Today: order fixing for Jessy. Wrote quicky cgi tool; tried to
diagnose why dpi.exp stopped working. Rollouts for Tim. Rewrote
provisioning-lib.pl changes for same. Then had to do detective
work/problem solving for LaKeisha/Dashon. Thought: skunkworks project:
add userid to user.local.php.

Found a bug in my verify.pl script. I was printing out the sized name
where I meant the raw image. Fixed.


#########################################################################
050729 Fri 29 Jul 2005 12:06:46 PM EDT

Continually vexed by makeSized.php. It feels like I'm manipulating
copies of objects. I've half a mind to edit the photos.dat directly.

I also had a thought that if !$item->isResized() then $full=1.

pretty printing your source code: enscript -2GrC




#########################################################################
050801 Mon 01 Aug 2005 10:55:31 AM EDT

Doing a skin count again for Jessy. Mayhap this should go in the
database.

Reading through Jessy's design docs for the christmas card stuff.

1. Images need to be generated and stored somewhere. Do we create a
   special holding place for them?

2. The correct product code must be passed to DPI.




#########################################################################
050804 Thu 04 Aug 2005 05:07:05 PM EDT

Arrays and objects are build differently, so I should probably
separate them into decomposeObject and decomposeArray.




#########################################################################
050805 Fri 05 Aug 2005 03:46:15 PM EDT

Cleaned out all debug code for the missing albumname thing.

Helped Fernando, Ching Yi, Dashon, Chris, Tim so far today. Plus others for
little things.




#########################################################################
050808 Mon 08 Aug 2005 11:44:43 AM EDT

Worked on my photosdat.pl file yesterday. It's about ready for prime
time. In fact I just did a run that should link to existing photos and
ones that should not display...




#########################################################################
050809 Tue 09 Aug 2005 05:17:21 PM EDT

Architectural risks to mpa:

1. Image crunching happens on the front end servers.
2. Image crunching happens over NFS.
3. Image serving happens from NFS.
4. Flat file programming and data integity



#########################################################################
050810 Wed 10 Aug 2005 11:36:05 AM EDT

Solved an issue where Christina put a place holder in Plat for domain
regisration: 0.00. This resulted in the interface saying "0.00/12
years" or somesuch. In enterccinfo.htm under the FC templates dir I
put an {if} block in to skip displaying domain registration.




#########################################################################
050816 Tue 16 Aug 2005 04:47:18 PM EDT

   2419:mysql> select left(username, 2) as letter, count(left(username, 2)) as cnt from users where regexp '[^q]' group by letter;
   2426:^Gmysql> select left(username, 2) as letter, count(left(username, 2)) as cnt from users where username regexp '[^q]' group by letter;
   3476:mysql> select left(username, 2) as letter, count(left(username, 2)) as cnt from users where username regexp '^[q]' group by letter;
   3507:mysql> select left(username, 1) as letter, count(left(username, 1)) as cnt from users group by letter;
   3550:mysql> select sum(cnt) from select left(username, 1) as letter, count(left(username, 1)) as cnt from users group by letter;
   3552:^Gmysql> select sum(cnt) from (select left(username, 1) as letter, count(left(username, 1)) as cnt from users group by letter);
   3554:^Gmysql> select sum(cnt) from (select left(username, 1) as letter, count(left(username, 1)) as cnt from users group by letter) as foo;
   3562:mysql> select left(username, 2) as letter, count(left(username, 2)) as cnt from users where username regexp '^[q]' group by letter;
   3593:mysql> select left(username, 2) as letter, count(left(username, 2)) as cnt from users where username regexp '^[t]' group by letter;

  


#########################################################################
050823 Tue 23 Aug 2005 03:57:17 PM EDT

Some sites are unsizable due to the lack of an admin user.
Some are unsizable because the albums are empty but they have full
sized images.

Key here: makeSized.php goes by what's in the dat files. It starts
with all the account names like countUnsized.pl does, but the latter
actually lists files in the directories.

aaamy: has one file aaa.jpg that is not listed in the photos.dat, it
would seem:

site ------------> aaamy
Number of albums in this site: 1
Number of accessible (?) albums: 1
Album name: album01
in explodeLP: album name: album01
album01: number of AlbumItems in this album (album01): 14
resize_size: 640 resize_file_size: 0album01: This item is resized. 1: aab
album01: This item is resized. 2: aac
album01: This item is resized. 3: aad
album01: This item is resized. 4: aae
album01: This item is resized. 5: aaf
album01: This item is resized. 6: aag
album01: This item is resized. 7: aah
album01: This item is resized. 8: aai
album01: This item is resized. 9: aaj
album01: This item is resized. 10: aak
album01: This item is resized. 11: aal
album01: This item is resized. 12: aam
album01: This item is resized. 13: aan
album01: This item is resized. 14: aao

But countUnsized.pl says:
/mnt/cel-1/vol01/a/aa/aaa/aaam/aaamy/aaamy/albums/album01/aaa.jpg




#########################################################################
050907 Wed 07 Sep 2005 06:32:23 PM EDT

We got a file from DPI today for Sept 2, but I think it was just all
of September. I ran it and moved it to the 9-2 filename:

mv  orderCompletion.xml.2005-9-6  orderCompletion.xml.2005-9-2


Finding people who didn't get upgraded to club:



mysql> select username, userid, osc_orders.orders_id, orders_status, package_type from users, osc_orders, clubbers where clubbers.products_options_values=users.userid and osc_orders.orders_id=clubbers.orders_id and package_type=0 and osc_orders.orders_status not in (0,1,4,11);
+-------------------------+--------+-----------+---------------+--------------+
| username                | userid | orders_id | orders_status | package_type |
+-------------------------+--------+-----------+---------------+--------------+
| blitz95                 | 243599 |      1209 |            10 |            0 |
| mygardenexchange        | 230969 |      1233 |            10 |            0 |
| rorystark               | 227504 |      1296 |             3 |            0 |
| poison                  | 269305 |      1980 |            10 |            0 |
| panamacitybeach         | 236732 |      2249 |            10 |            0 |
| rebelins                | 304085 |      3920 |            10 |            0 |
| tomoka                  | 244263 |      3942 |            10 |            0 |
| terispring50andfabulous | 295824 |      3978 |            10 |            0 |
| greff                   | 289060 |      4164 |             3 |            0 |
| cgoodden                | 270984 |      4519 |            10 |            0 |
| katieo                  | 289564 |      5545 |            10 |            0 |
| ziggyspics              | 281125 |      5604 |            10 |            0 |
+-------------------------+--------+-----------+---------------+--------------+




#########################################################################
050908 Thu 08 Sep 2005 10:25:33 AM EDT

-- turn someone into a clubber

-- get their userid first. save in @id.
select @id := userid from users where username = 'blitz95';

-- now create a new row in prem_packages_history. set the expiration
-- date for INTERVAL (365*N) DAY.
insert into prem_packages_history 
       (customer_id,  products_id,  date,   start_date,  expire_date)
VALUES (@id,          '148',        NOW(),  NOW(),       DATE_ADD( CURDATE( ) , INTERVAL (365*2) DAY ));

-- now get the primary key just created for that user. save in @ptype.
select @ptype := packages_history_id from prem_packages_history where customer_id = @id;

-- finally, update the 'users' table setting package_type to the new key from prem_packages_history
UPDATE users SET status = '4',  package_type = @ptype WHERE userid = @id;

-- and confirm:
select * from users, prem_packages_history where userid=@id and package_type=packages_history_id and customer_id=@id\G

And worked that into lisp:


(defun mpa-make-clubber (username interval)
  "Turn a frog into a prince."
  (interactive "sUsername to upgrade to club: \nnNumber of years to make premium member: ")
  (switch-to-buffer "sql")
  (goto-char (point-max))
  (insert (format "
BEGIN;
-- get their userid first. save in @id.
select @id := userid from users where username = '%s';

-- now create a new row in prem_packages_history. set the expiration
-- date for INTERVAL (365*N) DAY.
insert into prem_packages_history 
       (customer_id,  products_id,  date,   start_date,  expire_date)
VALUES (@id,          '148',        NOW(),  NOW(),       DATE_ADD( CURDATE( ) , INTERVAL (365*%d) DAY ));

-- now get the primary key just created for that user. save in @ptype.
select @ptype := packages_history_id from prem_packages_history where customer_id = @id;

-- finally, update the 'users' table setting package_type to the new key from prem_packages_history
UPDATE users SET status = '4',  package_type = @ptype WHERE userid = @id;

-- and confirm:
select * from users, prem_packages_history where userid=@id and package_type=packages_history_id and customer_id=@id\\G

" username interval))
  (comint-send-input)
  (message "Don't forget to type COMMIT or ROLLBACK!")
  )


Count all distinct order IDs for orders that have been paid for, and
contain at least one print:


mysql> select count(distinct(opa.orders_id)) from osc_orders_products_attributes opa, osc_orders o  where products_options='fs_path' and o.orders_id=opa.orders_id and o.orders_status != 1;
+--------------------------------+
| count(distinct(opa.orders_id)) |
+--------------------------------+
|                           4107 |
+--------------------------------+
1 row in set (0.72 sec)


Count all prints that have been paid for (orders_status is not 1).


mysql> select count(*) from osc_orders_products_attributes opa, osc_orders o where products_options='fs_path' and products_options_values is not null and products_options_values != '' and opa.orders_id = o.orders_id and o.orders_status != 1 ;
+----------+
| count(*) |
+----------+
|   109326 |
+----------+
1 row in set (3.44 sec)


This produces a lot of the freebies. It's almost: select all users who
have not paid for their club membership, and indeed there are a lot of
'kr' and test accounts:


mysql> select username, userid from users where package_type != 0 and status=4 and userid not in (select userid from osc_orders o, sw_clubbers c where o.orders_id=c.orders_id and o.orders_status !=1);




#########################################################################
050909 Fri 09 Sep 2005 12:28:57 PM EDT

Perhaps a better idea than converting files on upload is to convert
them on order.

And:


{foreach from=$templatestatus key=key item=thing}
<!-- templatestatus: {$key} -> {$thing} -->
{/foreach}

{foreach from=$info key=key item=thing}
<!-- info: {$key} -> {$thing} -->
{/foreach}

{php}
foreach ($_SESSION as $key => $val) {
    echo "<!-- $key: $val -->\n";
    if (is_array($val)) {
        foreach ($val as $k => $k) {
           echo"<!--        $k: $v -->\n";
        }
    }
}
{/php}


This failed to find the goddam bundle name in the session.x


#########################################################################
050915 Thu 15 Sep 2005 11:52:41 AM EDT

When the gift card is made by Tree's script, at that point it is
already in the orders/orders_id directory. As a result, the
osc_orders_products_attributes table entry does not contain the
fs_path to the christmas card; it contains the ID to the entry in
gift_cards.

*************************** 1. row ***************************
              orders_id: 1041
         order_datetime: 2005-09-15 11:35:29
 order_item_description: Gift Card 4X8
order_item_product_code: 898
    order_item_quantity: 1
       products_options: fs_path
                fs_path: /mnt/bob-1/vol01/s/sw/swa/swai/swain/swain/albums/fire/P1010100.jpg
*************************** 2. row ***************************
              orders_id: 1041
         order_datetime: 2005-09-15 11:35:29
 order_item_description: Gift Card 4X8
order_item_product_code: 898
    order_item_quantity: 1
       products_options: gc_id
                fs_path: 209
2 rows in set (0.00 sec)




#########################################################################
050916 Fri 16 Sep 2005 12:23:03 PM EDT

Two small tools I've created to help order fulfullment testing:

#!/bin/bash

# reset an order for fulfillment.
# sw sept 2005

if [ $1 ]
    then
    #echo $1
    if [ -d /opt/mpa/dpi/orders/$1 ]
        then
        rm -rf /opt/mpa/dpi/orders/$1
    fi
    
    if [ -e /opt/mpa/dpi/to_be_ftped/$1 ]
        then
        rm -rf /opt/mpa/dpi/to_be_ftped/$1
    fi 
    mysql -S /tmp/mysql.mpa.sock -uroot mpa -e "update osc_orders set orders_status = 2, processing_state = 'ready' where orders_id in ($1)"
else
    echo "usage: $0 <orders_id>"
fi


#!/bin/bash

# view an order

if [ $1 ]
    then
    orderdir=/opt/mpa/dpi/orders/$1
    if [ -d $orderdir ]
        then
        echo "$orderdir:"
        ls -l $orderdir
    else
        echo "no dir: $orderdir"
    fi

    ftpdir=/opt/mpa/dpi/to_be_ftped/$1
    if [ -d $ftpdir ]
        then
        echo "$ftpdir:"
        ls -l $ftpdir
    else
        echo "no dir: $ftpdir"
    fi
    


else
    echo "usage: $0 <orders_id>"
fi


#########################################################################
050920 Tue 20 Sep 2005 11:53:59 AM EDT

Rolled out OFS to production. Monitoring.


#########################################################################
050926 Mon 26 Sep 2005 04:08:26 PM EDT

Trevor gave his achitecture overview today. What's alarming is he's
been moving away from OO and towards... mostly a function library that
talks to the database, with no representation on the application level
of the shopping cart, or the user, or anything. Hrmm. I expressed my
worry that this would be brittle. He and Tree also want to do a Ruby
on Rails project.

Did a phone conversation with Tim and Chris on the Directory
project. After I sent them copies of albumdb.dat, album.dat and
photos.dat with a breakdown of the contents Tim replied:

"That's truly fucking horrid."

They can now see the difficulty in decomposing everything into
tables. I wonder if there are threads on the Gallery dev list about
this. Tim wants to see a flattened version of the dat files; and I
think they both finally saw a little merit in my idea of storing only
metadata in the DB and the dat stuff in the same row in the DB. Still,
this might not be optimal. I don't like the idea of querying the photo
table for all photos in an album... when all the data is right there
in photos.dat.




#########################################################################
050928 Wed 28 Sep 2005 03:55:34 PM EDT

flush the clubber:

(select orders_id from maybeclub where orders_id not in (select
distinct(orders_id) from osc_orders_products where products_id != 148)


#########################################################################
050929 Thu 29 Sep 2005 12:20:12 PM EDT

Wrote up a short spec and emailed around on the ajax project; commited
order_prints.php which is a copy of select-photo.php.

Cleared out the rest of the OFS queue this morning. Found and fixed
the bug with build_order.pl where it was not correctly updating
club-only purchases to 3, done.

Had some discussions on doing low rent profiling via the
database. UPDATE statements seem adequate.





#########################################################################
051004 Tue 04 Oct 2005 12:26:40 PM EDT

Turns out new skins were not merged to trunk. Maybe because I used -P?
Fixed. Jessy out again today. Yesterday I devoted my time between Zend
Studio and Gallery bugs.




#########################################################################
051013 Thu 13 Oct 2005 02:35:33 PM EDT

Collected materials for goodshot88. Tested signup wizard for Tim;
found bug with banlist. Oops, still gotta finish verify.pl for Chris!



#########################################################################
051020 Thu 20 Oct 2005 11:02:05 AM EDT

Had a talk with Tree about tardiness; he also says he came back
yesterday after his doctor's appointment. To be fair, he left around
5pm, though he'd come in late due to an errant bicycle chain. He was
late again today for the same bike chain. He was all apologies and
promised to try to make it in on time.




#########################################################################
051025 Tue 25 Oct 2005 04:59:46 PM EDT

In around 7am today. Wrote up the GoodStanding class, via TDD. By the
945am meeting I had a good deal done on that; by lunchtime most of it
done; spent a good deal of time with Fernando writing tests and fixing
the db class. The cool thing is this is a Singleton class, and we
tested it to prove that it was. All is honky dory.


#########################################################################
051028 Fri 28 Oct 2005 11:22:11 AM EDT

Today Jessy found out from Bill that we have to ship cards and prints
separately. Well. There's a fine "how do you do."

This is probably the time to fix the underlying flaw where prints are
numbered based on database order. I think this thing can be teased
apart to accomodate gifts as well.

Spent some time looking into unit testing for Perl; spent some time
experimenting with 'use constant' to see if I can replace Ronny's
extensive configuration maze, but I realized constants do not
interpolate very well. Still, it would be nice to reduce the amount of
verbage.




#########################################################################
051103 Thu 03 Nov 2005 11:03:38 AM EST

1. Remove orders, place file in Receipts
2. Generate orderCompletion.xml

 8222_10_26_2005__12_32.txt 


#########################################################################
051114 Mon 14 Nov 2005 10:44:03 AM EST

I will continue to process orderCompetion.xml by hand for the
week. There are still outstanding orders with four digit order IDs.

Over the weekend the trash filled up with 900 folders. This is far too
much; I need to limit the trash to deletions only and not to moves.

Over the weekend I also envisioned a scenario where users add prints
to their cart over a period of time, deleting them as they go. When
they place the order the order will go through just fine, and OFS will
choke on it. Filed in Bugzilla as an enhancement. Trevor thinks it's a
small fix.

Reviewed Chris's galleryadd.pl script, which he got off the net. It's
pretty awful in some places. It will not do what he thinks it will do,
which is to recreate the mpa on the go album if it does not exist. I
could not, at the time, explain how calling add_dir created a catch 22
situation because it would try to add a dir to the dir you wanted
created.

I worked extensively (between interruptions) on the hidden album
problem, writing a standalone script to test the functionality. The
short of it is, if you know the URL to a hidden album, you can view
it. That's standard Gallery.


#########################################################################
051115 Tue 15 Nov 2005 10:25:04 AM EST

I verified the way hidden subalbums work in Gallery 1.5RC5. I also
demoed the RSS functionality for Jessy.

So, hidden albums can be viewed by anyone if they know the URL. This
is Gallery, out of the box, as of 1.5 R5. So I think I'm not going to
tinker with that.

One reason this came about is because Jessy used a function that is
only available to admins. It lists all albums pretty much regardless
of permissions (not entirely, but almost).

Time to reaccess dark matter.

Done. Can't believe I forgot about my weekend's worth of work writing
verify.php and gverify.php. They still need to be merged. Moving on to
ftp script.




#########################################################################
051116 Wed 16 Nov 2005 09:20:50 AM EST

Rolled out new ftp_files_to_dpi.pl yesterday. It times the uploads;
Chris needs this to figure out when we will have to set up our own ftp
server.

Put in a kludge on the trashcan functionality. In roughly 24 hours we
already have 4,400 items in the trash, just over 3GB. Copied foo.php
to trashman.php and hacked it up to view the trash. Wrote a find
command into trash2.php this morning to view contents of the trash.

Also updated the script "photosdat.pl" which finds dark matter. Tested
it, looks good to go. It reminded me that I have gverify.php and
verify.php, and they need to be merged somehow; the goal is a script
that does data integrity checking of every site. This could run
continuously on a very low (high?) nice level, pausing 5 sec between
sites, something like that, so it's really low intensity.






#########################################################################
051117 Thu 17 Nov 2005 11:25:59 AM EST

Had a few meetings yesterday surrounding Trevor's leave of absence
request. We had a card order problem with DPI, something about a
transparency issue. I'm waiting on Bill for some clarification. I
revisited the GoodStanding class and found a bug, thanks to my unit
testing! I populated the last_purchase_date column for all users.

The missing processing_state bug has returned; emailed Trevor.

Bill found the problem with order 8777: two cards of different
sizes. This can't happen in one order. Bleh.




#########################################################################
051118 Fri 18 Nov 2005 11:27:38 AM EST

Last night: got build_order.pl to split gift cards into two orders
(4x8 versus 5x7).

Today: testing FC free, took up a lot of time this morning. Helped
Julian with the bug with gift cards.

<?php 
// test tree

for ($i = 1; $i < $numAlbums; $i++ ) {
    $tmpalbum = $albumDB->getAlbum($gallery->user, $i);
    $isRoot = $tmpalbum->isRoot();
    if ($isRoot) {
        echo printChildren($tmpalbum->fields["name"]);
        echo "<br>";
    }
}

//echo printChildren("ROOT"); 
?>

Sample code to print out a tree. It's wrong though because the header
"Sub Albums" appears between each on... but the function call would
show the way, anyhow.




#########################################################################
051121 Mon 21 Nov 2005 05:42:11 PM EST

Fixed orders; wrote up examples for Jessy vis: GoodStanding
project. Very frustrated that Julian checked code into CVS without
even testing it. He wrote a loop that flat out wouldn't work. The
whole config business was quite a hassle too... I need to separate
local box differences from the globally shared stuff, which the
OFSConfig.pm does not do. Also sent email to Chris about persistent
Mysql errors. Rolled stuff out for Jessy. I leave for Cle tomorrow.


#########################################################################
051130 Wed 30 Nov 2005 12:14:58 PM EST

Back from vacation. Worked on 3 days of my vacation; maybe more. Not
full days but lots to do.

Two hours later, still haven't finished this log entry... still can't!

Today started with the first manager's meeting. Then we did a standup
right after; I am pushing all print orders; cleared out my mailbox;
updated my Apple; reviewed Tim's regexp; answered about 4 questions
from fmarte, one from stow; lord knows what else so far. OK, it's
Dashon now. Wants me to play with some popup code. Done. Helped Julian
with some Perl issues; it turns out a script was failing for want of
the correct input params.




#########################################################################
051202 Fri 02 Dec 2005 06:04:27 PM EST

Another seemingly long day. We had an afternoon meeting, after which I
was pulled in one direction after another. I worked on the javascript
for Ching Yi a lot today, not solving the problem, and not getting
much help from Tim. I spent a lot of time trying to figure out why two
orders had corrupted files, according to DPI. In the end I regenerated
them from scratch and resent them. I rolled back a couple of files
this morning; Jessy hosed the upload tool. 


#########################################################################
051212 Mon 12 Dec 2005 10:46:35 AM EST

Steve Wainstead: you were late again
Steve Wainstead: and you didn't phone
Steve Wainstead: and you missed the standup meeting
Steve Wainstead: i don' t ask for a whole lot, julian
Steve Wainstead: please at least call me if you're going to be late
Julian Tree: my aplogies
Steve Wainstead: you need to coordinate with jessy with your progress on the editing tool
Julian Tree: I had to take the train this morning
Julian Tree: I didn't realized I was going to be late
Julian Tree: I didn't go out of my apt for a few days
Julian Tree: so I didn't realized I parked my bike somewhere else this morning
Julian Tree: so I didn't realized the train was going to take so much longer
Steve Wainstead: well, just be sure to talk to jessy asap.
Julian Tree: ok

Spent time today working on the new report. Getting closer. I think a
UNION will resolve some of the differences.

Worked with Tree on the issue of shutting off logging again. Ajax
broke on production briefly because the log file filled up again
(/tmp/itreelog).




#########################################################################
051213 Tue 13 Dec 2005 10:54:40 AM EST

Made crack5 live last night. Been working on the report crap for
Lilia. I think a UNION will work to combine old and new orders. Then I
need to see what happens with orders that have multiple parts.

Posted to craigslist yesterday and have received a number of resumes,
so far most of them crap. But that's normal. Attaching a zip file is
pretty dumb, and so is sending me a link that won't open.


#########################################################################
051219 Mon 19 Dec 2005 06:12:26 PM EST

It seems that gc_add_message.php has a lot of gift card stuff
hardwired in, so reusing it for eCards is not exactly simple to
do... in fact, it looks like copying/modifying both gc_add_frame.php
and gc_add_message.php is the best way to go. They really won't be
sharing very much; the database calls will be way different. It would
be a refactoring challenge to do. Well, not even! They live in
different projects.

We have /opt/mpa/lib, so I think we should start moving shared items
into this directory (or even in some subdirectory
arrangement. /opt/mpa/lib/php would be a good start).


#########################################################################
051222 Thu 22 Dec 2005 06:39:59 PM EST

Yesterday I fixed and rolled out the solution for cards, where they
now use mysql sessions. Today I refereed over the issue of cards and
gallery sharing more stuff, mainly the card generation stuff. Tree is
doing that. I thought I might finally tackle the hardcoded crap in the
OFS, but Bill wrote asking again that we don't send orders with a date
more than 30 days old; so as I went to work on that, I got slammed
with a gallery bug.

This one site has a top level album:

http://narcisguam.myphotoalbum.com/view_album.php?set_albumName=album12

It contains stuff but nothing is visible. Slideshow works. I can
create albums in it, I think, but cannot upload anything. It doesn't
contain itself, so I dunno what it could be. Nothing in the error log.

Then Peter was convinced something was wrong with the store so I spent
time placing orders and looking at logs and tables to figure it
out. Couldn't see anything wrong. Had Tree check the authorizednet
log; nothing there either.

Finally tested/bugfixed the OFS and got that out. Placed another order
to test it.

Been looking at how to solve Chris' problem with the license key for
the ActiveX uploader. Turns out only mup-1 and mup-2 are licensed, and
someone finally noticed (!) the "trial version only" popup when
loading to mup-3.

So the question is can we have uploads.myphotoalbum.com to upload to?
Initially no; the problem is init.php parses the $_SERVER[HTTP_HOST]
or thereabouts to get the subdomain name, and a lot of other things
follow from there. The hack would be to check the mpa_fqdn and use
that; but that just opens up a huge security hole. Anyone could upload
to any site if they hack their cookies. Or could they? We would still
have the session. Hrmm. Perhaps if the subdomain name is the only
issue, it might work.

Before anything is processed, we'd have to set $my_domain_name to
either the server name (swain.myphotoalbum.com) or, if we are on an
upload server, set $my_domain_name based on the cookie. Then, we need
the right session... no, don't think that would work. mpa_fqdn could
be set to any site and then highjack that session.

Perhaps logging in could auth them with the upload server too. That
would kind of suck because we'd have two of the same thing.

Emailed Chris.


#########################################################################
051227 Tue 27 Dec 2005 01:34:10 PM EST

No bug in the store; must have been caused by my switching from the
panix.com account to the corp.fortunecity account... but then, I did
see it on staging this morning...

There are two bugs at work against movies; one has to do with file
size, even though all limits are above 9mb. The other has to do with
there being no file on the RCS.

Solved the size problem: there was a hidden variable max_file_size
that was limiting uploads to just under 10mb.




#########################################################################
051228 Wed 28 Dec 2005 09:50:49 AM EST

Tree late again; he left me a voice mail. He'll probably be in by
10am. Yesterday I had to call him; by 10:10 he wasn't here. He thought
it was Monday.

I found and replaced all instances of "GB" to "UK" for Ching Yi
yesterday. I spent time debugging movie uploads; I found that we were
limiting uploads to 10,000,000 bytes (which is less than ten meg) in
add_photos.php. That lead to a different bug, now
solved. add_photo.php also has this limit coded in. The upload fails
when the system tries to make a thumbnail for the image.

I fixed one order with a bad stateprov; and I thought I'd found a bug
in the store but could not reproduce it. (I thought logging out and
logging in again lost the order. It still may be the case but it
appears to be time sensitive.)

/opt/video/bin/ffmpeg -i movie.mpg -ar 22050 -ab 32 -f flv -s 320x240 -aspect 4:3 -y movie.fvl

is the first command Chris wants me to run.

ffmpeg is located in /opt/video/bin
/opt/video/bin/flvtool2 (videofilename)
is the second command.



#########################################################################
051229 Thu 29 Dec 2005 11:15:26 AM EST

Tree late again; wasn't here at 9:48 but was here around 10am when I
looked. Spoke with him yesterday about his high distractability,
disappearing act, etc. Told Fernando to take the rest of the year off
rather than lose his days off.




#########################################################################
051230 Fri 30 Dec 2005 11:49:25 AM EST

22 lines matching "function" in buffer unit_tester.php.
     28:         *    with test methods for a functional test case.
     33:        function UnitTestCase($label = false) {
     47:        function assertNull($value, $message = "%s") {
     62:        function assertNotNull($value, $message = "%s") {
     80:        function assertIsA($object, $type, $message = "%s") {
     97:        function assertNotA($object, $type, $message = "%s") {
    113:        function assertEqual($first, $second, $message = "%s") {
    129:        function assertNotEqual($first, $second, $message = "%s") {
    146:        function assertWithinMargin($first, $second, $margin, $message = "%s") {
    163:        function assertOutsideMargin($first, $second, $margin, $message = "%s") {
    179:        function assertIdentical($first, $second, $message = "%s") {
    195:        function assertNotIdentical($first, $second, $message = "%s") {
    211:        function assertReference(&$first, &$second, $message = "%s") {
    232:        function assertCopy(&$first, &$second, $message = "%s") {
    254:        function assertPattern($pattern, $subject, $message = "%s") {
    264:        function assertWantedPattern($pattern, $subject, $message = "%s") {
    278:        function assertNoPattern($pattern, $subject, $message = "%s") {
    288:        function assertNoUnwantedPattern($pattern, $subject, $message = "%s") {
    299:        function assertNoErrors($message = "%s") {
    315:        function assertError($expected = false, $message = "%s") {
    342:        function _coerceToExpectation($expected) {
    352:        function assertErrorPattern($pattern, $message = "%s") {

     47:        function SimpleTestCase($label = false) {
     58:        function getLabel() {
     67:        function &createInvoker() {
     80:        function &_createRunner(&$reporter) {
     92:        function run(&$reporter) {
    107:        function before($method) {
    118:        function setUp() {
    126:        function tearDown() {
    134:        function after($method) {
    147:        function tell(&$observer) {
    156:        function pass($message = "Pass") {
    166:        function fail($message = "Fail") {
    181:        function error($severity, $message, $file, $line, $globals) {
    196:        function signal($type, &$payload) {
    204:        function swallowErrors() {
    218:        function assert(&$expectation, $compare, $message = '%s') {
    227:        function assertExpectation(&$expectation, $compare, $message = '%s') {
    240:        function assertTrue($result, $message = false) {
    261:        function assertFalse($result, $message = false) {
    273:         *                             backtrace function.
    278:        function getAssertionLine($format = '%d', $stack = false) {
    294:        function dump($variable, $message = false) {
    309:        function sendMessage($message) {
    319:        function getSize() {
    343:        function GroupTest($label = false) {
    347:            $this->_xdebug_is_enabled = function_exists('xdebug_is_enabled') ?
    356:        function getLabel() {
    368:        function addTestCase(&$test_case) {
    380:        function addTestClass($class) {
    395:        function addTestFile($test_file) {
    416:        function _requireWithError($file) {
    437:        function _enableErrorReporting() {
    450:        function _disableErrorReporting() {
    466:        function _selectRunnableTests($existing_classes, $new_classes) {
    487:        function _createGroupFromClasses($title, $classes) {
    504:        function _getBaseTestCase($class) {
    521:        function collect($path, &$collector) {
    531:        function run(&$reporter) {
    551:        function getSize() {
    580:        function BadGroupTest($label, $error) {
    590:        function getLabel() {
    599:        function run(&$reporter) {
    612:        function getSize() {



#########################################################################
060104 Wed 04 Jan 2006 11:02:13 AM EST

Tree in at 10:08am. Peter remarked that we should all be in by 9am
every day.


#########################################################################
060106 Fri 06 Jan 2006 09:30:19 AM EST

daysoff: Julian called off sick today.


#########################################################################
060107 Sat 07 Jan 2006 03:18:04 PM EST

In around 12:30pm. Worked about six hours; figured out how to inject
POST data into Mech while it's going from page to page. This will get
us around the problem of Javascript links for now... though perhaps I
should revisit httpunit at this point.


#########################################################################
060109 Mon 09 Jan 2006 11:07:42 AM EST

Fixed order 11193. Missing statprov in two of three fields. Passed
8779 over to Fernando; that error made no sense. Gonna cull the logs
for any other borked orders. We have had a lot lately since District's
FTP server has been failing.

[/opt/mpa/dpi/bin/ftp_files_to_dpi.pl][Order 10945] Uploading 270121.jpg to ftp server at Tue Jan  3 00:34:20 2006
[/opt/mpa/dpi/bin/ftp_files_to_dpi.pl][10945] [Tue Jan  3 00:34:36 2006] ERROR: Could not upload image file on ftp server: Connection closed; t\
ransfer aborted.
'ABOR': command not understood

[/opt/mpa/dpi/bin/ftp_files_to_dpi.pl][10945] [Tue Jan  3 00:34:36 2006] ERROR: Attempting to reconnect to server...

[/opt/mpa/dpi/bin/ftp_files_to_dpi.pl][Order 10945] cd into 1000010945 on ftp server
[/opt/mpa/dpi/bin/ftp_files_to_dpi.pl][Order 10945] Uploading 270121.jpg to ftp server at Tue Jan  3 00:34:37 2006
[/opt/mpa/dpi/bin/ftp_files_to_dpi.pl][10945] [Tue Jan  3 00:34:42 2006] ERROR: Could not upload image file on ftp server: Connection closed; t\
ransfer aborted.
'ABOR': command not understood

[/opt/mpa/dpi/bin/ftp_files_to_dpi.pl][10945] [Tue Jan  3 00:34:42 2006] ERROR: Attempting to reconnect to server...

[/opt/mpa/dpi/bin/ftp_files_to_dpi.pl][Order 10945] cd into 1000010945 on ftp server
[/opt/mpa/dpi/bin/ftp_files_to_dpi.pl][Order 10945] Uploading 270121.jpg to ftp server at Tue Jan  3 00:34:42 2006
[/opt/mpa/dpi/bin/ftp_files_to_dpi.pl] xfer time: | 907118 | 10.2819 |


There's a sample. It causes the log to fill up with a couple megabytes
of this gup.

AIM IM with zlatinman
1:24 PM
Steve Wainstead: ping
ZlatinMan: pong
ZlatinMan: peter cho?
Steve Wainstead: question. did kyung cho work with lysa?
1:25 PM
ZlatinMan: i do not know.
ZlatinMan: but she did recommend him
Steve Wainstead: she was at ziff davis last i heard
ZlatinMan: i have not seen his resume
ZlatinMan: but lysa insists he's very good in her humble opinion
Steve Wainstead: ok thanks 
ZlatinMan: i hope this circumvention will not adversely impact peter's application
ZlatinMan: peter cho's
1:45 PM
Steve Wainstead: well, it does place an interesting spin on it 
Steve Wainstead: no, it won't
Steve Wainstead: i'm interested in ablility, and how they would integrate with our team
ZlatinMan: i am glad
1:50 PM
ZlatinMan: mind if i opine?
Steve Wainstead: not at all
ZlatinMan: "(13:51:40) Lysa: all subtly aside, the kid is a friggen genius"
Steve Wainstead: well. that's not your opining, that's hers 
1:55 PM
ZlatinMan: my telling you this carries a bit more meanings, perhaps
ZlatinMan: hence, "opine"
ZlatinMan: but you are correct
Steve Wainstead: to "opine" on a subject is to give one's opinions... but, now we are discussing the English language ...
ZlatinMan: been writing essays non-stop for 3 weeks now. i'm lost in english 

More database fun today. Fixed one order (stateprov). Reviewed all
resumes; emailed two others requesting phone interviews
tomorrow. Firefighting with the database connection failures.


#########################################################################
060110 Tue 10 Jan 2006 12:48:39 PM EST

Progress on the store. Solved why it's not logging on development: it
couldn't write to the logs directory (perms) and the fopen did not
catch the error.

                                   


#########################################################################
060111 Wed 11 Jan 2006 10:38:08 AM EST

"We create the dots." -- Chris Ferry




#########################################################################
060113 Fri 13 Jan 2006 09:13:36 AM EST

Yesterday, this new Mac. Theory: X11 is unstable because I installed
it after the 10.4.4 upgrade. I could see going back to Panther just
for a stable X11. This morning when I logged in my X11 windows
instantly vanished; the xterm I used to login to Bork was all askew:

http://slim.deasil.com/~swain/screencaps/beforekeystrokes.png
http://slim.deasil.com/~swain/screencaps/afterkeystrokes.png

Also yesteday, solved the video conversion problem. All the right
stuff happens now. It's up to Chris and Jessy to get the rest working
for the moment. I need to do a tiny bit of cleanup on the code and I
need to mass change all config.php files on production to fix the URL
for the movie image.

                                   


#########################################################################
060116 Mon 16 Jan 2006 11:31:06 AM EST

Friday I ran the script to update all user's config.php files. They
all point to the movie icon now.

Continue to have X11 weirdness. Cubist xterms, screen buffer runnning
amok (closing the xterm, starting a new one, reconnecting solves it);
and worst of all, command-tab does not raise the windows. I'll have to
set aside time to re-OS the box to try to solve it. Although... I
might try the nondestuctive reinstall.

Did a thorough test of cards per an inquiry from Peter. Also this
morning Tree had questions on how to solve race problems --
specifically the Lost Update Problem -- with image editing. I also
realized there was a risk that if the editing failed for some reason
the original is lost. (i.e. the cropping comes out wrong due to a
bug).

We continue to see occasional mysql query failures. It still looks to
me like lost db connections.

RSS complete. One bug: clicking an image in the rss reader dumps you
on the album page. The "id" is a number, not the name of the image.




#########################################################################
060118 Wed 18 Jan 2006 09:24:58 AM EST

Tree called at 9:40 on Monday saying he'd be late; yesterday he
arrived around 9:50.

I worked out a script to change all links to static content; it
involved recursively calling two functions. This was necessary to
separate the HTML from the PHP, which kept getting in the way. I did a
test run on the whole code base and some things came out broken in the
html_wrap default files.

A bit warm in the office today.

Tested my parser on staging; looks pretty good. One header comes out
borked because, it would seem, there's missing quotes on an attribute.

NO: I think the bug lies in how I do the join '>' at the end of the
chunk.

So we had a meeting and this blogging thing is kind of all over the
map and needs leadership and direction, from a technical point of
view. My job.




#########################################################################
060119 Thu 19 Jan 2006 09:42:09 AM EST

Methodology so far: 

search freshmeat.net for all php blogs with a stable/production
release
search sourceforge for the word "blog"

google: turns up a log of blogs about PHP. Few tell you what package
they used (probably rolled their own).

Criteria: 
* must have released in 2005
* must have a home page or demo

Releasing an OSS project is not unlike submitting a resume and cover
letter for a job. If I go to your home page on sourceforge and see:

* Parent Directory ..
or
* Could not connect to Mysql DB:
or
* Congratulations! Your Apache Installation Worked!

the project is not evaluated.




#########################################################################
060123 Mon 23 Jan 2006 12:13:02 PM EST

I'm keeping the emails about child porn in a folder 'evidence' which
appears to live on the mail server.


Second round of evaluation for blogs: install and glance over source
code.


1. Journalness: Cannot install it so far. PEAR DB class error:

Fatal error: Call to undefined method DB_Error::query() in
/home/swain/blogs/journalness-3.5.4/install/install.php on line 326

I upgraded DB via 'pear upgrade DB', which gave me version 1.7.6. But
that didn't solve the problem. Sometimes I get the above error, and
other times it tells me success but then dumps me back on the
installer page.


2. Wheatblog: Got it installed, connecting to DB. Fooled me by
   creating its own database. No idea how to create a new account;
   online docs are unfinished. Unable to create entry or account.

3. plog installed nicely. Interface looks suspiciously like
   blogware. Very simple features.

4. bblog: Nice setup! Editing window has no tools though, unlike
   plog. Dicked me by creating files in ../, not where I wanted them,
   in the project dir. My fault, didn't specify bblog.


5. phpblogger -- super easy to install. flat files. almost no
   features.

6. sphpblog -- another simple setup. Also flat files. Has a calendar.

7. minb -- is a flat file content management system, and explicitly
   pleads the user to not user it as a blog. Recommends wordpress or
   moveable type or serendipity.

8. Wordpress is ultra featureful, but needs a database. It does have a
   blog theft capability.




#########################################################################
060124 Tue 24 Jan 2006 09:40:28 AM EST

[Tue Jan 24 09:12:55 2006] [error] [client 213.131.241.73] File does not exist: /mnt/cel-1/vol01/linkless/gallery/xmlrpc.php
[Tue Jan 24 09:12:56 2006] [error] [client 213.131.241.73] File does not exist: /mnt/cel-1/vol01/linkless/gallery/blog/xmlrpc.php
[Tue Jan 24 09:12:57 2006] [error] [client 213.131.241.73] File does not exist: /mnt/cel-1/vol01/linkless/gallery/blog/xmlsrv/xmlrpc.php
[Tue Jan 24 09:12:58 2006] [error] [client 213.131.241.73] File does not exist: /mnt/cel-1/vol01/linkless/gallery/blogs/xmlsrv/xmlrpc.php
[Tue Jan 24 09:12:59 2006] [error] [client 213.131.241.73] File does not exist: /mnt/cel-1/vol01/linkless/gallery/drupal/xmlrpc.php
[Tue Jan 24 09:13:00 2006] [error] [client 213.131.241.73] File does not exist: /mnt/cel-1/vol01/linkless/gallery/phpgroupware/xmlrpc.php
[Tue Jan 24 09:13:01 2006] [error] [client 213.131.241.73] File does not exist: /mnt/cel-1/vol01/linkless/gallery/wordpress/xmlrpc.php
[Tue Jan 24 09:13:03 2006] [error] [client 213.131.241.73] File does not exist: /mnt/cel-1/vol01/linkless/gallery/xmlrpc.php
[Tue Jan 24 09:13:04 2006] [error] [client 213.131.241.73] File does not exist: /mnt/cel-1/vol01/linkless/gallery/xmlrpc/xmlrpc.php
[Tue Jan 24 09:13:05 2006] [error] [client 213.131.241.73] File does not exist: /mnt/cel-1/vol01/linkless/gallery/xmlsrv/xmlrpc.php

Interesting. A probe, it would appear. This is from Bork's Apache
error_log.

Did a code review of Tree's cropping tool; looked really good, though
zero comment blocks once again.


#########################################################################
060125 Wed 25 Jan 2006 09:29:13 AM EST

magic ferry frame:

 /opt/video/bin/ffmpeg -i
 /mnt/bob-1/vol01/c/ch/chr/chri/chris/chrisferry/albums/album02/stuffedanimals.flv
 -ss 1 -t 0.016 -an -y %d.jpg

Briefly: worked on Grasshopper.pl for a bit. This is a breadth-first
web spider from Higher Order Perl.

Found I was trying to use PHP 5.1 constructs for veracity.php. This
means I'll have to hand roll everything which sucks.




#########################################################################
060126 Thu 26 Jan 2006 04:46:46 PM EST

Tree took a personal day today.

I just came out of a looooong descent into... well, I had to figure
out a bug that was causing certain albums to not load. The bug was my
session contained invalid data; this resulted in Gallery trying to get
the first image from index zero, which is impossible since Gallery
counts from one. Calling destroy.php worked. Perhaps logging out
should do the same.

Now I can't remember what I was working on; I think it was
loginpage.php.




#########################################################################
060127 Fri 27 Jan 2006 11:39:32 AM EST

Reported another case of Million Faces to the NCMEC. This guy won't go
away.

No svn on our servers. Put in a notice to ops.

X11 still being flaky.

Bug: move photo, row is deleted from mpa_photos. Should be an update.

So, today: one rollout for Hanley; long debate over video capping;
wound up staying late implementing Ferry's crap via TDD. Met with
Peter, wrote offer to Jacob and rejection to Cho. Wrote and ran script
to add userid to all user.local.php files. That should be done
shortly. Added small change where mysql_insert_id is added to Image
object.




#########################################################################
060130 Mon 30 Jan 2006 09:50:37 AM EST

Tree late: 9:51am. No call.

Had a meeting with the team over the two major bugs pending: AJAX
pages hammering osc_sessions_info, and orders with no products. These
seem somewhat related; in fact the former was intended to be a
solution to the latter.

My suggestion was: once a user has logged in, the basket should be
associated with the customer_id. Currently there's a scheme where the
session ID is kept in their cookie for six weeks, and this is the
lynchpin. I can plainly see this is fatal in the long term. Trevor,
though, said it made the hairs on his neck stand up to think of making
this change. It would require gazillions of if/else statements. I
wrote on the board STATE PATTERN, because I recall reading that it was
a common solution to this problem. Trevor was insistent though that if
he solved the problem with outlet.php and API_getSessionKey(), which
is more of a performance issue, that the latter problem would clear
up. I'm letting him go this route for now.




#########################################################################
060201 Wed 01 Feb 2006 09:31:50 AM EST

Fernando out sick today. Hosting has been sold, this being 2/1 and the
deadline met.

I think capping uploads is a twofold problem. Setting the limit is
easy. However, I don't want users to upload a 75mb file only to be
told they can't add it because they are over limit. It seems the popup
is the place to cap it.

Today I did a rollout to staging, which lead to some debugging of the
tests; actually prior to that I implemented upload caps for
video. Capping is done and seems pretty robust. Had a meeting on the
Points program, which needs significant fleshing out still, but we are
on our way. The data needs to be modeled.

I spent the evening working on getting a destructor workaround
implemented for DBConn. I think there's some mysql timeout thingie
going on now, because it works for short requests but not long ones,
like those that process video. I'm supressing the warning I get.

Updated gallery_remote2.php so it uses MPA authentication.


#########################################################################
060203 Fri 03 Feb 2006 09:41:52 AM EST

Yesterday: spend an inordinate amount of time playing with Firefox
extensions. I have a pretty good idea of how they are built now, and
how they work (just DOM1 manipulation for the most part). Could a
testing tool be written? Dunno yet. Don't see a reason why not yet.

Also took way too long working on outlet.php. I did do a TDD page for
it though. I was fooled by all errors and warnings being shut off.

I then debugged the RSS feed. getGUID() is missing in our
Gallery. Then I installed 1.5 from CVS on bork and configured it. They
have caching features!




#########################################################################
060206 Mon 06 Feb 2006 11:46:39 AM EST

On Friday, wrote ads.php for Jessy.

Just added genGUID() to the code, and re-enabled the guid in
rss.php. This looks OK now, since it's initialized to zero when the
class is instantiated.

On the downside, RSS won't work for all sites until they update their
config.php.

Checked on the security of the system calls for film. Gallery seems to
filter out the filenames in save_photos.php:

"Maybe I'll go to Cleveland and get a tattoo or something, I dunno. My
brother in law lives there." -- Tom Waits


#########################################################################
060207 Tue 07 Feb 2006 03:03:48 PM EST

    // loop through all files, test the file extensions for things
    // they cannot upload

    display = window.open('', 'display_winder', 'height=500,width=600');

    function println(x) { display.document.writeln(x + "<br>"); }

    println(extensions);
    println("length: " + filearray.length);


Tree called off sick today.


#########################################################################
060208 Wed 08 Feb 2006 02:08:26 PM EST

Have to write a bio for the whole business of fund raising.


#########################################################################
060209 Thu 09 Feb 2006 11:02:19 AM EST

Yesterday:
* error detection for system() calls to ffmpeg in Album.php
* opener.showProgress() added to add_movie.php
* debugged loginpage.php for Jessy
* debugged mysql warnings, which led to:
* major refactoring of ampira.local.php so everything uses DBConn

Today:
* Debugged select-photo and order_prints
* Multiple rollouts, lotsa testing
* Removed dependencies in DBConn
* Huge bugfix with moving videos
                                   


#########################################################################
060210 Fri 10 Feb 2006 04:46:09 PM EST

dawnpiburn@mac.com: "ex FEMA chief: I'm a scapegoat"
dawnpiburn@mac.com: no, you're an doofus




#########################################################################
060215 Wed 15 Feb 2006 12:20:31 PM EST

Consuela, the js output window.

var consuela = "unset";

function log(msg) {
    if ( typeof consuela == "string" || consuela.closed) {
        consuela = window.open('', "console", "height=600,width=500,scrollbars=yes");
        consuela.document.writeln(new Date() + "<br>");
    }
    consuela.document.writeln(msg  + "<br>");
    consuela.scrollBy(0,50); // horizontal and vertical scroll increments
}



#########################################################################
060216 Thu 16 Feb 2006 03:55:24 PM EST

wcbaasnk
swain.fortunecity.com

Clearly we need to prevent users from adding their own ads to the
blogs.

trackbacks
captcha
rss
customization: give it all to the user, i say.

Wordpress cannot do flat file caching.


#########################################################################
060221 Tue 21 Feb 2006 11:30:58 AM EST

Out yesterday for Prez day. Trevor came in though. Tree was out
Thur/Fri for jury duty, though he did not call me Friday. He continues
to work on the point system. I need to work out an estimate for the
remaining work for him; seems like days that he's been working on
database issues.

Jacob has come along nicely with Zend Studio and the moblog monitoring
script. Fernando doing testing, support etc. Jessy's page redesigns
are on staging.

Fixed "bug": really, it was from Trevor dropping tables. The Premium
class was grossly unhappy about being a club member but having nothing
in the prem_packages_history table.

Wasted a bunch of time debugging the premium services problem on bork;
turns out to be fallout from Trevor hosing the database. Wrote a test
class to verify integrity. Then refactored all tests so we could run
alltests.php. Looks nice but needs more work.


#########################################################################
060222 Wed 22 Feb 2006 02:30:30 PM EST

xorian's way to make X frames after starting Emacs in screen:

(defun make-x-frame (display)
  "Open a new X frame on a particular display."
  (interactive)
  (make-frame default-x-frame-plist (make-x-device display))
  )


#########################################################################
060224 Fri 24 Feb 2006 12:37:17 AM EST

Yesterday (Thursday): Trevor and I both out sick.

I am afraid I'm borking Mech's cookies because I am giving them to the
Request object. So that's something to investigate. I need to filter
out image requests (maybe? 404s here are useful, after all).

The response would contain the new cookies, so I need to be careful to
honor that.

Harumph:

COOKIES
       Some sites like to play games with cookies.  By default LWP ignores
       cookies provided by the servers it visits.  LWP will collect cookies
       and respond to cookie requests if you set up a cookie jar.

         use LWP::UserAgent;
         use HTTP::Cookies;

         $ua = LWP::UserAgent->new;
         $ua->cookie_jar(HTTP::Cookies->new(file => "lwpcookies.txt",
                                            autosave => 1));

         # and then send requests just as you used to do
         $res = $ua->request(HTTP::Request->new(GET => "http://www.yahoo.no"));
         print $res->status_line, "\n";

       As you visit sites that send you cookies to keep, then the file lwp-
       cookies.txt" will grow.


So, good thing I did that stuff on my free time :o) 


#########################################################################
060225 Sat 25 Feb 2006 10:39:07 PM EST

It works. lhhrerun.pl will take a liveHTTPheaders script as input,
login to gallery, order prints, login to the store, pay for them and
logout. Note that *logging out of the store* was crucial; it wasn't
until I did dumps of all the page content that I found that there was
something strange going on when it tried to login the second time.

Alternately I probably could have used a new cookie jar every
time. That might be a bit safer. It certainly was a case of one test
hosing another.


#########################################################################
060227 Mon 27 Feb 2006 09:43:21 AM EST

Tree and Trevor out sick today; Trevor will take a personal day
tomorrow.

Pivot looks good. It only has a little block of PHP at the top and the
rest is HTML.

Wrote little css testing tool for Jessy. Fixed bug in Usage for Chris,
rolled out. Rolled out video ads. Worked on Pivot.



#########################################################################
060228 Tue 28 Feb 2006 10:38:35 AM EST

Tree in 9:50; I started the meeting without him. Trevor out today on a
personal day.

Talked to Tim about Pivot, seems happy; Jessy too. No one package can
really meet both product's needs. Learned a boatload about blogging
though.

Here are the files it modifies via the server.

./
./pivot/db/rsscache
./pivot/db/rsscache/406847980a3814f299497d8b27d453eb
./pivot/db/ser-cats.php
./pivot/db/ser-dates.php
./pivot/db/standard-00000
./pivot/db/standard-00000/index-standard-00000.php
./pivot/db/standard-00000/00006.php
./pivot/db/standard-00000/00007.php
./pivot/pv_cfg_settings.php
./pivot/pv_cfg_weblogs.php
./archives
./archives/archive_2006-m02.php
./archives/archive_2005-m10.php
./index.php
./rss.xml
./atom.xml


Here are the dir perms needed:

weblog                                                 -> 777
weblog/archives                                        -> 777
weblog/images                                          -> 777
weblog/pivot/db                                        -> 777
weblog/pivot/templates                                 -> 777
weblog/pivot/pv_cfg_settings.php                       -> 777
weblog/pivot/pv_cfg_weblogs.php                        -> 777
weblog/pivot/db/(all files and folders)                -> 777 
weblog/pivot/db/standard-00000/(all files and folders) -> 777 
weblog/pivot/templates/(all files and folders)         -> 777 

The db class appears to be the only access to the data store;
goodo. It extends db_lowlevel, which is the interfact to the XML
database.




#########################################################################
060301 Wed 01 Mar 2006 01:57:11 PM EST

Meetings. Three of them. Just now getting back to coding stuff.




#########################################################################
060303 Fri 03 Mar 2006 06:40:17 PM EST

Fixed Usage class; big mess around the last_viewed, which Ferry had in
his original spec. Not used. The problem there was I went against his
email spec, which would have created a completely redundant table for
videos; and the usage/limits table was curtailed somewhat. He was
angry about all this. I think this has lead, in the long term, to the
total mess that is the video capping/Usage class situation.

Did some bugfixing/rollouts; researched serving XUL files (not gonna
use it), started Jacob on reimplementing the class for Pivot.


#########################################################################
060306 Mon 06 Mar 2006 10:53:55 AM EST

Trevor out sick Friday. Tree in at 11:20am, lost his bag yesterday and
had to wait for the locksmith.

Last night, we disabled the Usage class since Jessy and Dashon were
seeing videos showing the "over limit" message, but when Chris listed
the table there were very few views on anything. I wonder why that
would be? One cause might be commenting out the block that resets the
column 'views_today'. (Misnamed, of course).




#########################################################################
060308 Wed 08 Mar 2006 09:18:27 AM EST

Yesterday: bugfixing, testing, rollouts. Part of the problem was
twofold: Chris changed perms incorrectly in the CVS repository (chmod
-R -ow, where -ow is indeed 'ow!') and I rolled out live instead of to
plookfish. Bad Steve. In short order we fixed production, then got
things working again in CVS. Bork locked up. Tim complained about
albums.php loading slow.

Finally Trevor gave a demo of Flash development; very enlightening.




#########################################################################
060309 Thu 09 Mar 2006 09:26:52 AM EST

Tree out with a fever today.

Met with Dashon and Chris. Dashon wants to do a promotion: 100 people
win a free trip per month. On our end we have to select 100 random new
signups, send an email telling them they've won, providing them a link
to a form that auths against mpa.users; this form collects a mailing
address so we can send them the form to fill out and mail to the
company that gives away the trips.

In a cfg file, pv_cfg_weblogs.php, I changed the file extensions to
html and that worked for the frontpage and an archive file. It looks
like individual posts are still served dynamically, i.e. parsed out of
a file and stuffed into a template. I haven't dug in yet to see.

/usr/bin/svn co --username chris --password password https://cvs.corp.fortunecity.com/svn/trunk/MODULE


#########################################################################
060313 Mon 13 Mar 2006 02:51:46 PM EST

Picked apart some of an extension Chris found over the weekend. It has
neat file manager like features.


So potentially we *can* use mpa_photos for counting uploads:

mysql> select count(*) from mpa_photos where month(uploaded) = month(now());

+----------+
| count(*) |
+----------+
|   647112 |
+----------+
1 row in set (32.85 sec)

mysql> select count(*) from mpa_photos where '2006-02-28 23:59:59' < uploaded and uploaded < '2006-03-31 23:59:59';
+----------+
| count(*) |
+----------+
|   647196 |
+----------+
1 row in set (0.56 sec)

mysql> select count(*) from mpa_photos where '2006-02-28 23:59:59' < uploaded and uploaded < '2006-03-31 23:59:59' and \
subdomain='swain';
ERROR 2006 (HY000): MySQL server has gone away
^GNo connection. Trying to reconnect...
Connection id:    59556
Current database: mpa

+----------+
| count(*) |
+----------+
|        7 |
+----------+
1 row in set (0.46 sec)

But if we use the usage table, perhaps we can just truncate it. That
would be more efficient.

Uploading would have to be blocked, ultimately, in
Album->addPhoto(). This is the one single choke point where we could
guarantee no photo is added. We would, of course, make an effort to
block it in the various points in the UI or API so they don't waste
time and bandwidth uploading the images, which would probably be
stranded on the filesystem.

Thought there might be a bug in creation of the Premium object but I
don't see a lot of redundancy. Then again, only careful debugging
would really show it. (Redundancy in the query logging, that was).


#########################################################################
060315 Wed 15 Mar 2006 10:42:27 AM EST

Yesterday, deleted some accounts off the dev box. It turns out dev was
linked to off production in a handful of shtml files; so I fixed
those. I did some finishing work on lhhrerun.pl and committed it. I
worked on setting up Pivot to live in one place but provision to
several places, ala Gallery.

Wrote Lindsey Hardy at Apple about Quartz 2D. My first call to the
sales line got me routed to the applecare section. Duh.

Two meetings; helped Tree and Chris; reported days of to Tom. Jacob
done on his end of Pivot; got him started on the captcha replacement
for MPA. Verified we can run pxn8. Ferry installed the module.

Tree found a Selenium tool on Digg. Played with that briefly.

polandspringln12: oh I forgot to tell you two important things
polandspringln12: on line 53 in pvlib.php I hardcoded the default weblogs setting file
polandspringln12: I had a pretty hard time putting it into a query so I figured it would be just as easy to load the default one from a file if people have not made any changes
polandspringln12: if they do change it, it saves and loads to the database
polandspringln12: and in module_db_mysql.php I just set the userid to a random number in the constructor
polandspringln12: so that will have to be gotten through a superglobal or whatever
polandspringln12: and thats it



#########################################################################
060316 Thu 16 Mar 2006 04:37:01 PM EST

christoferferry: whats wrong with this?
christoferferry: insert into mpa_albumitem_stats (phid,date,views) values(20134887,"2006-03-07",2) ;
bash: syntax error near unexpected token `('

Be sure to copy changes to veracity.php over to svn.

/usr/bin/svn co --username swain --password ****** svn+ssh://cvs.corp.fortunecity.com/opt/svn/trunk/swain




#########################################################################
060317 Fri 17 Mar 2006 01:18:36 PM EST

Tree, Trevor, Zlatin, Keisha let go today. Keisha is going to grad
school so it's all good for her.


#########################################################################
060318 Sat 18 Mar 2006 05:01:17 PM EST

The general problem with veracity.php is: I want to visit a site,
collect the data about its files from two perspectives, and then
perform one or more actions.

But perhaps I should just hardwire the first problem: deleting dark
matter. Let's think about the rules for a minute:

1. If it's on the filesystem and Gallery doesn't know about it, it
   gets deleted. But "it" could be a thumbnail or a full sized
   image. So those are different issues.
2. If it's in Gallery but not on the filesystem, then we are going to
   skip this case for now. In the future we'd probably use the Gallery
   API to remove the object. The attempt to delete the actual file
   will probably result in a warning.

It works under PHP5 so I suppose I should go ahead and take advantage
of that. I seem to recall there being good array functions in 5 that I
needed.




#########################################################################
060320 Mon 20 Mar 2006 05:05:28 PM EST

So... never, ever were temp files deleted since we rolled out the
ActiveX tool. Tim's cron job generally found them and deleted
them. When we started running out of space this weekend I found this
out. I thought perhaps the last_updated wasn't being updated, but
found no proof; no biggie as I added one line to Album.php to unlink
the temp file. Looks OK now.

Fixed signups on dev. Tree's query simply broke it. Commented it
out. Admin was broken due to my db-lib hack, and a brain fart.

Jacob has taken over the points project. Chris named a column 'date'.


#########################################################################
060321 Tue 21 Mar 2006 05:08:47 PM EST

Been working on a Java applet, trying to get it to work on the
easy_upload_j.php page. It redirects to a page, which is hardwired
into the applet. I found I can compile it quite easily but signing it
is a pain.

Cleaned out Trevor's desk. Sadly, when he was in the vestibule Jessy
and Cheryl were heading out to smoke and I think that's exactly the
kind of attention he didn't want. Chris continues to struggle with
SVN.


#########################################################################
060323 Thu 23 Mar 2006 09:45:21 AM EST

Yesterday, struggled with the siging of the applet. What a pain. Chris
"took it over" for now. Meanwhile, hacked on the store and got a
couple files rolled out for Jessy; fixed the whole shebang so that my
personal copy of the store (swainstore) works transparently.


#########################################################################
060327 Mon 27 Mar 2006 12:22:53 PM EST

jarsigner -keystore codesignstore -storepass 'secret' -signedjar
  signed.jar GalleryRemoteAppletMini.jar www.myphotoalbum.com

Documented my work in Twiki:
https://twiki.corp.fortunecity.com/bin/view/MPA/GalleryJavaApplet




#########################################################################
060329 Wed 29 Mar 2006 10:53:52 AM EST

Yesterday, got the applet working correctly. The key was to read the
Java API and do away with the frames hack Gallery uses.

Did rollouts for Jessy plus testing. Wrote Twiki doc for Jacob on the
Points project.

Today we have a meeting on the sales book for MPA.

This was a very typical long interruption: Jessy needed help mixing
Javascript and PHP; and then Jacob needed help finding the store code
that activates a membership; and Fernando needed a rollout to
production. Well that's three interruptions. And Chris called to relay
a message to Nathan who wasn't at his desk. And Cheryl asked me what
happens if she skips jury duty.

Saw this after signing up on staging:
 [Wed Mar 29 18:57:02 2006] [error] PHP Warning:  mysql_fetch_assoc(): supplied argument is not a valid MySQL result\
 resource in /var/cel-1/vol01/linkless/gallery/classes/Premium.class.inc on line 133



#########################################################################
060330 Thu 30 Mar 2006 09:38:13 AM EST

Warning: mysql_fetch_assoc(): supplied argument is not a valid MySQL
result resource in
/var/cel-1/vol01/linkless/gallery/classes/Premium.class.inc on line




#########################################################################
060331 Fri 31 Mar 2006 09:43:33 AM EST

Yesterday: bug fix for the store. Coupons were not being incremented,
thus they could be used over and over until they expired.

It does not appear Trevor created a new product for club
renewals. Also this morning Jessy put the onus on me for deactivating
premium things in the config.php file, which she apparently put on
Tree to do as part of the points program. In this case we only need to
revert the frames, skin, and.. printing? something else. She's
supposed to give me a spec.

Peter dropped the bomb that we are consolidating our space so we can
rent more out; this led to a big battle between Jessy and Chris over
who gets Trevor's old desk, and I volunteered to move back to my old
cube as a compromise.

Friday, March 31st, 14:27. Splinter halted.



#########################################################################
060403 Mon 03 Apr 2006 10:57:40 AM EDT


http://pxn8.com/pxn8.pl?rand=e823
operation=bsh
opNumber=5
brightness=100
saturation=100
contrast=3
hue=100
image=http%3A//pxn8.com%3A80/upload/57d537a59f46d319d2eececb5897298e.jpg
PXN8SESSIONID=df982e927af183d4bc5f07fc86a24002

Based on previous work, I made in a few minutes a script (long http
headers) and tested it with my lhhrerun.pl script. It resets
everything, which might be too much since I think Jessy wants to
restore original settings if they pay up; and I think other config
info does not change.

Here's a diff of config.php before and after. On the "right" side it's
the original settings:

< $gallery->app->skinname = "default";
< $gallery->app->gallery_thumb_frame_style = "fancy2";
---
> $gallery->app->skinname = "red";
> $gallery->app->gallery_thumb_frame_style = "shadows";
145,147c145,147
< $gallery->app->default["album_frame"] = "fancy";
< $gallery->app->default["thumb_frame"] = "none";
< $gallery->app->default["image_frame"] = "none";
---
> $gallery->app->default["album_frame"] = "shadows";
> $gallery->app->default["thumb_frame"] = "shadows";
> $gallery->app->default["image_frame"] = "shadows";


MyPhotoAlbum software

* Based on open source projects Gallery and OSCommerce.
* Extensive proprietary additions to both.
* Extensive customizations with Ajax, DHTML, and Flash
* Runs on open source architecture of Linux, Apache, MySQL, Perl and
  PHP.


MyPhotoAlbum makes great use of open source technnologies on two
levels: the application level (the photo albums and store) and at the
system level (supporting programs and code). This means no licensing
fees and a vast pool of available developer talent.

"Gallery," the open source project that is original basis for
MyPhotoAlbum, offers a level of customization for the user that is
unmatched by any other photo site. Users can choose from a wide range
of "skins" and frames, make albums public or private, add users to
their site, and activate features like polls and commenting.

To this we've added features like a point-based incentive program,
photo editing, "sharing" features like RSS, link generators, and
electronic postcards.

We have extensively rewritten the store, originally based on
OSCommerce, to handle the special needs of a photo site (club
memberships, holiday cards, and various print sizes).

The foundations for MyPhotoAlbum are the open source systems and
languages that are the darlings of the Internet: the Linux operating
system, the Apache web server, the MySQL relational database and the
dynamic languages Perl and PHP (in industry parlance, the "LAMP
stack").

---

Started by cobbling together a small lib file to do the database
connectivity. I wanted to avoid Tim's stuff. But ultimately, I'll
probably want to use the email/templating stuff, so it's gonna be for
naught. Suckitude.

Got a small script going to handle this stuff. Passed the blogging
project off to Jacob for now.

chrisatfcity: @test.myphotodevel.com


#########################################################################
060404 Tue 04 Apr 2006 03:04:21 PM EDT

Dump for testing/restoring expiry:

/d0/mysql/mpa/bin/mysqldump -S /tmp/mysql.mpa.sock -uroot mpa
prem_packages_history mpa_redeemed_features prem_packages_history_arch
mpa_redeemed_features_arch > restore.sql

Fleshed out the cron job; only remaining task is to swap out the
user's config stuff. I found bugs in the shortform and RSS and have
been fixing those. I wonder how the shortform can be thoroughly
tested.





#########################################################################
060406 Thu 06 Apr 2006 05:20:27 PM EDT

Rolled back Album.php to version 1.43 of 2/6, no change.


#########################################################################
060410 Mon 10 Apr 2006 09:56:54 AM EDT

The previous entry was about trying to fix a problem on production
where full sized images were being copied to the fast storage. This
was a bug Fernando introduced a long time ago.

Worked Saturday on the veracity script; made some progress. Might redo
how I organize the data. The whole rules-based approach continues
to... something between haunt me and intrigue me.

Friday I took the day off, but wound up working from 7:40am to 12:30pm
straight (with one coffee run) on the rollout.


$id = preg_replace('/\.[^.]+$/', '', $filename);
$rurl = "http://$p.myphotodevel.com/view_photo.php?full=1&set_albumName=$albumname&id=$id";
glog("for: $filepath");
glog($rurl);
$browser = new HTTPRequest($rurl);
$browser->getResponseCode();


I tried a hacked up request class but the end result was muddled
thinking: even if the image is missing we get a 200 back because the
page loads correctly, just the image does not.

My thinking now is veracity.php should generate output that is
digestible to another script. This sort of simplifies things: veracity
simply builds the big picture, and some other script can do the
lifting.

Long detour into store-land for Jessy. Seems her client cannot check
out a branch that is on a subtree. This lead to a hilarious (to me)
but frustrating conversation (to her) about branching versus
tagging. I could not make her understand tags and branches are the
same; or more accurately, a tag can be a branch or not.

Anyway I wound up throwing out all of Trevor's work and commiting the
current release to the trunk again. A branch called TREVORS_LAST_STAND
holds all his changes.




#########################################################################
060411 Tue 11 Apr 2006 09:24:58 AM EDT

Veracity, phase one, looking ok so far. Been running tests on
production this morning.

After a few successively larger runs, found that there are images with
a .sized extension. Jessy thinks there will be .thumb as well, which
means .highlight is possible. Fixed for that event.

Then got sidetracked with the following:

* Jessy couldn't get an ad to link correctly. Wrong store URL code.

* Jacob couldn't solve a problem with a user's profile. We found,
  after debugging live on production, that the user's userid was wrong
  in the user.local.php file. Wrote a Perl script to test them all;
  about 16 are wrong. On the phone with Tim, figured out that these
  were people who had been deleted and restored. Emailed Tim the list;
  he'll fix the delete code.

* Helped Chris to uniq an array, then solve a problem iterating over a
  hash.

* Set up phone call with Babbage and Jessy.

Finally, back to veracity. 3pm already. Was in at 8am, opened the
office.




#########################################################################
060412 Wed 12 Apr 2006 11:16:13 AM EDT

Reported a child porn case. The dumbass uploaded a picture of himself
and gave his phone number. Some tard in the Netherlands.

Have been hacking away at the store today. My notes:

[snip]
A short primer on the session and the basket. Here, I clicked "buy
club" in my gallery.

My osCsid cookie is 5a22ed7cb07d5558fab33af6f4cb0379.
This is my sess_key:


mysql> select * from osc_session_info where sess_key='5a22ed7cb07d5558fab33af6f4cb0379'\G

*************************** 1. row ***************************
         session_info_id: 1849
                sess_key: 5a22ed7cb07d5558fab33af6f4cb0379
           txn_signature: 
               orders_id: 0
          payment_method: 
           payment_title: 
                   cc_id: 0
        payment_currency: USD
             order_total: 15.00000000
                  sendto: 0
                  billto: 0
                language: 
             language_id: 1
         shipping_method: flat_rate
         shipping_amount: 0.00000000
              tax_amount: 0.00000000
                 tax_pct: 0
                tax_name: 
            customers_id: 0
            content_type: virtual
        shopping_cart_id: 5a22ed7cb07d5558fab33af6f4cb0379
                  offers: N;
validated_coupon_code_id: 0
      validated_offer_id: 0
         subtotal_amount: 15.00000000
                navTrail: a:2:{i:0;s:17:"shopping_cart.php";i:1;s:9:"login.php";}
             express_qty: 0
            express_size: 0
                mpa_fqdn: 
           last_accessed: 2006-04-12 16:07:50
 row in set (0.90 sec)



This links to a basket, via session_info_id:


mysql> select * from osc_customers_basket where session_info_id=1849\G
*************************** 1. row ***************************
      customers_basket_id: 1557
             customers_id: 0
          session_info_id: 1849
              products_id: 148
            unique_string: swain
              full_string: 148{mpa_user_id}142687{subdomain}swain
customers_basket_quantity: 1
                price_set: 15.0000
        price_set_comment: 
           running_amount: 15.0000
                subdomain: swain
                  cart_id: 
               sort_order: 0
            last_accessed: 2006-04-12 16:07:50
1 row in set (0.01 sec)



This links to the attributes table via customers_basket_id:


mysql> select * from osc_customers_basket_attributes where customers_basket_id=1557\G
*************************** 1. row ***************************
customers_basket_attributes_id: 22235
           customers_basket_id: 1557
                  customers_id: 0
                       cart_id: 
                           key: mpa_user_id
                         value: 142687
                 last_accessed: 2006-04-12 16:07:50
*************************** 2. row ***************************
customers_basket_attributes_id: 22236
           customers_basket_id: 1557
                  customers_id: 0
                       cart_id: 
                           key: subdomain
                         value: swain
                 last_accessed: 2006-04-12 16:07:50
2 rows in set (0.00 sec)

[snip]


I fixed a configuration bug on development where tax was being
charged. I had to fix the admin interfact to do this; Trevor had
dropped a couple of tables it depended on.




#########################################################################
060417 Mon 17 Apr 2006 11:04:21 AM EDT

Sick day today: left heel. Ouch. Ben Franklin, I heed thy call.

I borked replication by creating the mpa_albumitems table on mdb-2
first. I suck. Helped Jessy track down the release date of the new
design.




#########################################################################
060418 Tue 18 Apr 2006 05:19:35 PM EDT

Spread to left toe. Heel seems better though. Tired. Forced to go
drinking later; no choice. 

Meanwhile; integrated and tested the new IPC stuff for run-veracity.pl
and that's ready to go. Cleared dark matter on bork and
staging. Updated tables.

Multiple rollouts for Jessy; and she found a bug where tax was not
listed as a line item (just the amount of the tax). In Trevor's Tax
class I defined a default of "Tax" for the name, when none was
supplied. A reasonable first stab I guess. But now display data is
tied into the code, so that's bad.

Reading about the "Functional Decomposition" antipattern in my
Antipatterns book, it remarks this is a common antipattern in C shops
going C++. PHP: like C++ but without the typing!




#########################################################################
060419 Wed 19 Apr 2006 04:21:27 PM EDT

Home again today; took another sick day. Third this year I
think. Foot's much better; was horribly swollen last night when I came
home.

Meanwhile: found two more bugs in veracity. 1: the table schema I have
uses a composite unique key for username, albumname, photoname. It
turns out it's case insensitive by default, and you have to sprinkle
the column declaration with some special "collate" syntax. Tested and
rolled out. I dropped the whole mpa_albumitems table and recreated it;
gonna repopulate it tomorrow.

The second bug led to false positives for dark energy. For movies the
gallery collection was still getting a sized image. This was a trivial
fix and is committed.

Spent time with Chris on AIM with Perl questions; spent time on the
phone with Jessy trying to figure out a javascript problem. She is
trying to assign a src attribute of a <script> tag, and it wasn't
loading. Seems to me that it would not be legal. Will pick it up again
tomorrow.

   1105:s36:"37_040205_Schneewanderung_Baumspitze";
   1113:s42:"37_040205_Schneewanderung_Baumspitze.sized";
   1130:s42:"37_040205_Schneewanderung_Baumspitze.thumb";
   2952:s36:"37_040205_Schneewanderung_Baumspitze";
   2960:s42:"37_040205_Schneewanderung_Baumspitze.sized";
   2977:s42:"37_040205_Schneewanderung_Baumspitze.thumb";
   2996:s36:"37 040205 Schneewanderung Baumspitze";

Here's a case in manjaree, album06, where the same image appears
twice. No idea why. Also encountered a site with the same photo name
but different extensions. Added 'extension' to the composite key.

marianbejan:
===============================================================
marianbejan: xlp: Missing full sized image:
/mnt/bob-1/vol01/m/ma/mar/mari/maria/marianbejan/albums/PackingandContainer/.jpg
marianbejan: done
marianbejan: Sizes: g_disp 18 g_mass 18

marianbejan: Building filesystem snapshot.
marianbejan: User has the correct album layout. 18 albums found.
marianbejan: gallery data check (sized): Missing full sized image:
PackingandContainer .jpg or .flv
marianbejan: gallery data check (thumb): Missing full sized image:
PackingandContainer .jpg or .flv
marianbejan: There were 2 failures in the fs collections.
marianbejan: dark energy :
/mnt/bob-1/vol01/m/ma/mar/mari/maria/marianbejan/albums/PackingandContainer/.jpg

In this case, the user does indeed have a .thumb.jpg, a .sized.jpg,
but no .jpg. The thumb displays on the album page, but you cannot view
the sized image unless you hand code the URL. It's possible in the
past I deleted all .jpg files, and it turns out Gallery allows this.




#########################################################################
060420 Thu 20 Apr 2006 08:58:41 AM EDT

"Innovation has nothing to do with how many R&D dollars you have. When
Apple came up with the Mac, IBM was spending at least 100 times more
on R&D. It's not about money. It's about the people you have, how
you're led, and how much you get it." -- Steve Jobs





#########################################################################
060421 Fri 21 Apr 2006 10:05:41 AM EDT

Yesterday made progress on the club renewal. I'm working on the SQL
statements I'll need; I have tests set up with the LHH runner script I
wrote.

I should kick off the next run of veracity too.

Worked for a while on a script to try to figure out what files aren't
in user anymore. But there are tricks like files being defined() and
then required() using the constant; and shopping_cart.php won't be
included, so... tough row to hoe.

Whoops! filled up the table space. We had about a 10 minute outage for
MPA. Dropped the mpa_albumitems table, may try again tomorrow.




#########################################################################
060424 Mon 24 Apr 2006 10:47:59 AM EDT

Ran veracity over the weekend; 18.5 million photos. mysql5 held up
fine. Ran 20 at a time, load hovered around 12. Done in about 7 hours,
versus 22 last time.

This is a left outer join that shows club members with no rows in
prem_packages_history:

select username, status, package_type, customer_id from users left
outer join prem_packages_history on userid=customer_id where status =
4;


You ask, "typolesbo has putty on her pc. does anyone know if that's scriptable, such that it would 
automattically ssh to the dev box and tail the apache error log?"
merlin [to Wainstead \]: absolutely
merlin [to Wainstead \]: set up a private key to log in using and you can set a command to execute 
in putty's config
merlin declares, "beyond that you can call the putty.exe with a session name so she can have a 
single icon on the desktop that will login in, tail the log and wait for her to close the window"
DrDaByGoD [to frontpage]: jesus CHRIST you are evil.
merlin [to Wainstead \]: the bundled avalon tf client does just 80% of what you're asking as a 
self executing rar archive that cleans up after itself.  phealy has more details
merlin decisively orates, "just 80% -> just about 80%"
merlin intones, "the last little bit is simply pluging in the tail command to the command to run"
merlin [to Wainstead \]: Connection -> SSH has a remote command text box

Been updating/cleaning up the tests for Gallery, so I can do TDD on
the Premium object. Still haven't reconciled the impedence mismatch
between the USERS and PREM_PACKAGES_HISTORY tables. Found a note from
Jessy in the loginpage.php source about not directing subusers to the
profile, and found a bug in the process. Filed with Jacob. Added
Jessy's email to Twiki as a faux project spec. It has the basic
requirements in it.




#########################################################################
060425 Tue 25 Apr 2006 11:26:08 AM EDT

With club renewals it's easy to go off on one tangent after another. I
found the magic number 20 hardcoded into the Premium class; this
should be in prem_packages_features, and drawn from there if they are
a club member. But there are several NULL rows that have offer_ids. So
that has to be traced. On and on it goes.

Mostly done, as far as the Premium class goes. All TDD on it, looks
OK.

So, to fix the crack pages so they correctly show videos... well, it's
all read from the filesystem. I suppose I could kludge it to stat for
a flv; or else I'll have to redo the crack pages to use the new table,
which isn't too bad an idea. But the nice thing now is we just see
everything on the filesystem, table be damned.


#########################################################################
060427 Thu 27 Apr 2006 11:35:07 AM EDT

Most of my ills were due to a typo. packages_history_id, and I was
typing package_history_id. Fucking true names and other dangers!

So I wrapped it in a method and gave it a better name in the bargain:
$thia->getClubPackageId(). Now, a typo will cause compilation to fail.

And another: I forgot to declare $gallery as global in the new private
methods I added to make the constructor more readable. Damn. Took a
while to diagnose. So that is obviously bad, and a good reason to look
up the Registry pattern and see if that is a solution.




#########################################################################
060428 Fri 28 Apr 2006 03:28:48 PM EDT

Converted lhhrerun.pl into a Perl class,
LHHReplayer.pm. Changed/rolled out files for Jessy; that involved
changing rand(1,100) to rand(1,30). Wrote and ran bunches of store
test scripts.




#########################################################################
060501 Mon 01 May 2006 02:16:10 PM EDT

Didn't work over the weekend, though I did write two Greasemonkey
scripts. Very enlightening.

Did a rollout for Jessy and then quickly refactored debug output from
AlbumItem.php, as it was polluting the error logs on production; have
been fighting the broken test code in the store. Cleared up the log
stuff. I think Trev was pretty far along in something when he was let
go. The test code at the end of the last set of commits he did was
more plentiful.




#########################################################################
060502 Tue 02 May 2006 12:16:21 PM EDT

Tried to get Mech to create a new store account; but this is a no-go
because Mech cannot populate the state or country fields. The reason
is they are dynamic Javascript; they have no options list to start
with and I think this chokes Mech. It claims the fields don't exist
(and this was evident in mech-dump for that matter).

Wrote tests for Jessy's sharing after rolling out to staging, found a
bug that was captured in the script; and every time I rerun the test
the bug occurs, but I cannot manually reproduce it. Very frustrating.




#########################################################################
060503 Wed 03 May 2006 11:47:28 AM EDT

Rollouts done; bought two prints. Need to roll out the cron job still.

DrDaByGoD says, "she staff purchases an off-lease computer and then bitches and moans when it 
doesn't work and she's got this poor IT guy in columbus feeling like a bastard because it's 
overdue in the ticket system for a solution because i'm busy with real work and we shouldn't have 
to fucking support this shit anyways and fuck this stupid bitch. now she's going to actually try 
to convince the company and dell that they need to take it back because she shouldn't have to pay 
money for a computer that doesn't work. when really the moment we handed it to her we should have 
never heard of it again. god fuck god damn."
Pope Benedict XVI condemns DrDaByGoD to hell.
heller says, "copy & paste that into the ticket. "

mysqlbinlog `ls -tr prs-1-bin.* | tail -1` | tail -50

better:

echo $TIMESTAMP; mysqlbinlog --start-datetime="$TIMESTAMP" `ls -tr /d0/mysql5/mpa/data/prs-1-bin.* | tail -1`; TIMESTAMP=`date '+%Y-%m-%d %H:%M:%S'`

It would be cool to have that in a lisp function and dump the output
into a sql-mode buffer, but one must be root to run it.

removing new customer:
delete from osc_customers where customers_id=26; delete from
osc_address_book where customers_id=26; 

    673:INSERT INTO `credit_card` (`customers_id`,`creationtime`,`cc_owner`,`cc_type`,`cc_number`,`cc_expiration_date`) VALUES ( 28, NOW(),'european test account','Visa','ko9oZ2R8e1mEZJSjZKWjWw==','2012-01-31');
    679:SET INSERT_ID=356;
    684:INSERT INTO `cvv` (`creationtime`,`cc_id`,`cvv2`) VALUES ( NOW(), 828, '111' );


Some good heads down time today, and built up some good tools to deal
with the store. Interesting: not that many tables are hit through the
process of add products, login, buy. Mainly osc_sessions_info and the
basket table.


#########################################################################
060504 Thu 04 May 2006 11:27:26 AM EDT

Having recovered my "PHP and Mysql" book, just read up on PHP5
OOP. Mostly what I expected; interfaces work like Java's and we can do
the cool stuff like passing instances around by interface only. Very
useful.

Fernando and I are dropping five columns and renaming one today; I
used grep-find to track down all the places where the columns occur
and changed the php code. I've run four test orders through twice to
make sure things work; they look good so far but I cannot test paypal
on developement. Paypal complains that the invoice number has already
been paid.

With the columns dropped the only problem we ran into was I forgot to
update the store code on bork and Fernando found the ez_sql error. The
bonus here is I got to add that string to lhhrerun.pl. Store looks
fine on staging.

I ran some queries on mdb-2; we have three million rows in the
osc_orders_products_attributes table. If I count rows from more than
one year ago I only get around 116K. Not much. So I think the growth
of that table will not be an issue for some time, and ultimately we
can just archive older orders.

I made an account for Germany on bork, and the test I created does not
get the VAT tax.

Next newest trick: dump entire database, run tests, dump again; do
this:

 sdiff dump.before.sql dump.after.sql  > delme
 grep '<\||\|>' delme

Output looks like this:

[prs-1 tests]$ grep '<\||\|>' delme
INSERT INTO `gift_cards` (`gc_id`, `gc_session_id`, `products |	INSERT INTO `gift_cards` (`gc_id`, `gc_session_id`, `products
INSERT INTO `osc_orders` (`orders_id`, `customers_id`, `custo |	INSERT INTO `osc_orders` (`orders_id`, `customers_id`, `custo
INSERT INTO `osc_orders_products` (`orders_products_id`, `ord |	INSERT INTO `osc_orders_products` (`orders_products_id`, `ord
INSERT INTO `osc_orders_products_attributes` (`orders_product |	INSERT INTO `osc_orders_products_attributes` (`orders_product
							      >	INSERT INTO `osc_orders_products_attributes` (`orders_product
INSERT INTO `osc_orders_status_history` (`orders_status_histo |	INSERT INTO `osc_orders_status_history` (`orders_status_histo
INSERT INTO `osc_orders_total` (`orders_total_id`, `orders_id |	INSERT INTO `osc_orders_total` (`orders_total_id`, `orders_id
INSERT INTO `osc_session_info` (`session_info_id`, `sess_key` |	INSERT INTO `osc_session_info` (`session_info_id`, `sess_key`
INSERT INTO `prem_packages_history` (`packages_history_id`, ` |	INSERT INTO `prem_packages_history` (`packages_history_id`, `
INSERT INTO `users` (`userid`, `username`, `email_address`, ` |	INSERT INTO `users` (`userid`, `username`, `email_address`, `


This takes advantage of mysqldump's one long line for INSERT.

VAT bug: this happens when one adds to cart, THEN logs in and buys. If
the user is already logged in when they add to cart they get the VAT.

Helped Hanley with some API stuff.


#########################################################################
060505 Fri 05 May 2006 12:05:47 PM EDT

The VAT bug lies somewhere here:

When items are added to a tmp cart, we don't know whether to figure in
the VAT. But when the user is already logged in we know to add the VAT
if they are from the EU. So, when they log in and the cart is updated,
it should figure this bit out.

Did a trace of adding a photo to the cart, from the JS click to the
store function call.


This removes all info for a user from the store (given their email address):

-- erase customer from memory for all time. well, doesn't handle OFS tables.
BEGIN;
select @id := customers_id from osc_customers where customers_email_address='mister@test.myphotodevel.com';
delete from osc_orders_products where orders_id in (select orders_id from osc_orders where customers_id = @id);
delete from osc_orders_products_attributes where orders_id in (select orders_id from osc_orders where customers_id = @id);
delete from osc_orders_total where orders_id in (select orders_id from osc_orders where customers_id = @id);
delete from osc_orders_status_history where orders_id in (select orders_id from osc_orders where customers_id = @id);
delete from osc_orders where customers_id = @id;
delete from osc_session_info where customers_id=@id;
delete from osc_address_book where customers_id = @id;
delete from osc_customers_basket where customers_id=@id;
delete from osc_customers where customers_id=@id;
COMMIT;

Cleaned up the orders on dev and staging:

mysql>  delete from osc_orders_products_attributes where orders_id in (select orders_id from osc_orders where processing_state != 'ready');

Query OK, 9819 rows affected (1 min 11.00 sec)

mysql>  delete from osc_orders_products where orders_id in (select orders_id from osc_orders where processing_state != 'ready');
Query OK, 1364 rows affected (8.13 sec)

mysql>  delete from osc_orders_status_history where orders_id in (select orders_id from osc_orders where processing_state != 'ready');
Query OK, 1089 rows affected (0.74 sec)

mysql>  delete from  osc_orders where processing_state != 'ready';
Query OK, 389 rows affected (0.07 sec)

Also divided up the dev tests between swainstore and store.


#########################################################################
060506 Sat 06 May 2006 01:35:24 PM EDT

I can begin to talk about the store in terms of Fowler's patterns. For
example it uses Page Controllers versus a single Front
Controller. Gallery is the same. The Tax class is really a "finder"
object -- it's a wrapper around a SQL query.

He talks quite a bit about three main designs for accessing the DB; of
course I'd like to do the OO one, which is also the most
sophisticated, but also the hardest for outside programmers to
understand.




#########################################################################
060508 Mon 08 May 2006 11:02:40 AM EDT

Made a couple of code format changes on Saturday. Blog now needs one
serious revision, the deal with the page generation; which grows
linearly but is slow. Jacob will work on that now.

Blue is working from her new home in Atlanta. Chris and Jessy continue
to work on the slideshow. Dashon is back; which means Ching Yi should
return shortly, and she will be reskinning the blog for FC.




#########################################################################
060509 Tue 09 May 2006 02:45:39 PM EDT

pxn8 notes: first, every transform causes new tmp images in the
'cache' directory. 


#########################################################################
060510 Wed 10 May 2006 11:30:18 AM EDT

Jacob late again; had to call him. He did this yesterday too.

Meanwhile... manager's meeting, and a long phone conversation between
me, Tim, Dashon and Ching Yi. Sorted all that out. Tim will see to her
access needs.

pxn8 will not be easy. It will have to work on the sized image, for
performance reasons, and then the changes must propagate to the full
and thumbnail (and album cover if needed).

Jessy is done with the email for expired clubs, so... I need to finish
that up. Apparently the early mailings via email labs hasn't happened.

PhpWiki has two files, loadsave.php and ziplib.php. Between them is a
function to create a new ZipWriter class which builds/sends a zip file
on the fly.

Wow, the FC blog is really nice.

Finished the cron job, debugged the email template. Talked to Chris
about write access for the store to the fast storage; looks like it
will happen.

Lots of rollouts and stuff today.


#########################################################################
060515 Mon 15 May 2006 09:33:10 AM EDT

Friday, wrote two fixes for the problem of people deleting photos from
their site after putting them in the cart. This got rolled out as
well, though I missed that; it happened on Friday afternoon when I was
doing link checking throughout Gallery and the store. I found about
five or so bad links that Jessy then fixed.




#########################################################################
060516 Tue 16 May 2006 10:15:13 AM EDT

Maybe it's the Nyquil, but I've been seeing things very differently
since yesterday. I wrote and debugged a simple Gallery class to
instantiate the site.

Uncommented the Amex stuff; waiting on Hanley so we can make it live.

Walter at Pxn8 has been extremely helpful and wants to implement the
feature I mentioned -- applying all the steps to the large image. In
fact in our case we wouldn't even need to save the intermediate; we'd
regenerate the sized and thumb at that point. Or we could.

Jessy wants me to shift to the CD project now... it's hard to
concentrate though since I'm ill.




#########################################################################
060518 Thu 18 May 2006 09:50:45 AM EDT

Home sick yesterday. Feel crappy today. We'll see how it goes.

Shifting gears to the CD project; have to refactor the OFS. I think
the config file, upon some thought yesterday, can easily be converted
into a DB class. Dunno why I never thought of this before.




#########################################################################
060519 Fri 19 May 2006 12:09:38 PM EDT

I've written two small scripts, one Perl and another PHP, to try to
call a stored procedure. I get the same error: 

PROCEDURE mpa.test_proc can't return a result set in the given context




#########################################################################
060523 Tue 23 May 2006 10:43:30 AM EDT

Bork failing yesterday, after Nathan upgraded the RPMs. Likely a re-OS
of the system will fix it; it doesn't sound like a hardware issue,
though it could be just flakey after reboots, hardware wise. It failed
at 1am last night when noone was on it.

Did cleanup work on staging after I filled up /opt running the
OFS. Only 4gb there, not enough. Been locking horns with Ferry all
day; had to resolve an issue with the address books.




#########################################################################
060524 Wed 24 May 2006 02:53:25 PM EDT

Managers meeting. Conflict resolution. MBS meeting. Clubphoto
meeting. Spork is the new Bork.




#########################################################################
060525 Thu 25 May 2006 10:56:47 AM EDT

I am cranky from all the interruptions, and now I've been off AIM for
an hour or so and it's annoying everyone. Chris doesn't have enough to
do, and not enough important things to do, to keep him busy.

Spent the morning trying to help diagnose the ad problem, which of
course is on the ad network's end. Refactored mpa.el so I have more
generalized commands to tail store logs as I wish.

I'm realizing that the updating of the shopping cart is really, really
complicated and it happens twice when I update the cart with the
"update" button. Sad. It basically deletes and reinserts everything
somehow, then computes the costs twice. Hrmm. Perhaps because I set
the quantity to 2 for all prints? Nope; setting it to 3 still results
in 2 sets of UPDATE statements.

Finally got a stored procedure working:

#!/opt/php5/bin/php
<?

error_reporting(E_ERROR & ~E_WARNING);

require("/opt/mpa/conf/gallery.mysql.conf");

$mysqli = new mysqli( 'spork.dev.fortunecity.com',
                    $gallery->app->mpa_mysql_username,
                    $gallery->app->mpa_mysql_password,
                    $gallery->app->mpa_mysql_db,
                    3309
                    );

if (mysqli_connect_errno()) {
    printf("connection failed: %s\n", mysqli_connect_error());
    exit(1);
}

$query = "call test_proc()";

echo("query:\n# $query\n");

$results = $mysqli->query( $query );

if ($mysqli->errno <> 0) {
    printf("query failed: %s\n", $mysqli->error);
}

while ( $row = $results->fetch_object() ) {
    printf("username: %s\n", $row->username);
}

?>



The procedure is thus:

create procedure test_proc() reads sql data select username from users where username like 'sw%';
grant execute on procedure mpa.test_proc to mpauser;

Troubles I had: the signature of the mysqli constructor is
picky. Can't have port number and hostname in the same string.


#########################################################################
060530 Tue 30 May 2006 10:25:27 AM EDT

Dropping work on the OFS for now; as it looks extremely likely we'll
use phototlc for photofinishing.

Fixed up the shortform for Hanley; loops to output the table rows,
plus some DOM1 goodness to load the images only when requested. Chris
bugging me about how to get the stylesheet's images loaded via the
static server. The spec says they have a base url of the stylesheet
and not the referring document. Hanley hammering it out now.




#########################################################################
060531 Wed 31 May 2006 03:37:55 PM EDT

Trying to get this rollout done! The better part of a day! Currently
Chris and Jacob are trying to get the db changes live. Jacob did not
document it very well and Chris is being anal.




#########################################################################
060601 Thu 01 Jun 2006 02:17:31 PM EDT

Did more static server call debugging; rolled out more files; added a
method to the Abstract_User class to help Jacob solve a problem;
reworked the layout of gc_add_frame.php for Jessy. That page is a huge
farking mess. Just returned from the post office, mailed out Ubik.




#########################################################################
060602 Fri 02 Jun 2006 02:02:11 PM EDT

Imported the country codes and such into staging and production. This
involved doing a mysqldump of osc_zones and osc_countries. I then
debugged an order from this morning, for Austria, which has a
stateprov of 4 chars. I didn't want to roll out my new OFS code so I
edited the live file (it was just a regexp change).

Also helped Jessy a bit.

Yesterday I was playing around with coupons and offers. It looks like
a lot of the functionality for the admin interface works.

from inc.checkout_authorizenet.php:

// we're no longer using any $_SESSION variables, so $_SESSION['txtn'] becomes $sess_info['txn_signature']

I think lhhrerun has a small bug when dealing with 302s. The store
does a lot of 302s and this results in double requests for the same
page from the store. The store doesn't seem to mind much. The orders
always turn out correct.

I got it. The LWP follows the 302, and then the next instruction in
the script follows the 302 as well; so it gets requested twice. So the
solution is to cache the previous request in the lhhreplay and see if
we already loaded the URL. Or, turn off 302 following.

Doing this:

my $mech = Test::WWW::Mechanize->new( max_redirect => 0);

results in a lot of false errors because the 302 is the last thing
seen.




#########################################################################
060606 Tue 06 Jun 2006 12:01:27 PM EDT

Solved an interesting problem via the LWP today: needed to change the
form's action field to use the raw IP address, and set the Host header
to plookfish.

my $ip = '66.179.231.211';

my $mech = WWW::Mechanize->new();

$mech->cookie_jar(HTTP::Cookies->new(file => "uploader_cookies.txt", autosave => 1));
$mech->agent_alias( 'Linux Mozilla' ); # don't give us the java applet.                                                              

$mech->add_header( Host => "plookfish.myphotoalbum.com" );

$mech->get( "http://$ip/loginpage.php" );
my $form = $mech->form_name("login_form");
$form->action("http://$ip/loginpage.php");

$mech->submit_form(
                   form_name => 'login_form',
                   fields => {
                       returnpage => '/albums.php',
                       uname => 'admin',
                       gallerypassword => '112233'
                       }
                   );

Here we use a cookie jar, set the host header field and change the
action. Fun!

Time spent trying to debug a problem with trashcan dirs being made
with the wrong perms. It was a PHP5/Apache2 issue.





#########################################################################
060607 Wed 07 Jun 2006 04:49:15 PM EDT

Today... well... wrote a new tool to create sites from the command
line. Got that done around lunch. Wrote a new method for Hanley to
tell if the site has any albums or not. Rolled out store, bought three
orders. Helped Jacob with Ajax wonkiness. Wrote regexp for Tim.

Some guy in France got charged eight times. Store logs prove
it. Dunno why yet. Store logging sucks ass.


#########################################################################
060608 Thu 08 Jun 2006 10:25:42 AM EDT

Proposed we add a quick-jump-to-album to albums.php. Might do it
ajaxian. Spiffy.

Wanna add logging to the point of the credit card transaction and see
wtf the store is doing.



#########################################################################
060609 Fri 09 Jun 2006 11:41:12 AM EDT

Tested and tested this morning on Plookfish; found two bugs, filed in
bugzilla, decided to not releaes, called Jessy.

Didn't need to test Safari with FCFree, really; Tim disables the
editor b/c Safari is not supported. Whiteboarded a problem with Jacob
and solved it in about two minutes.

There are two major engines of change for the store, and they are:
promotions and adding new products. So to that end, what we need are:

* fast flexible creation of new promotions.
* A UI that can be changed quickly
* easy to add new products to the store

I realized I was thinking of the store front and the admin interface
as one app but really they are two.

sgml-tags-invisible hides all the html tags.

Wonders shall never cease. Log::debug writes to /tmp/debug.log (it's
hardcoded). The AuthNet stuff goes there; no cc numbers fortunately.

Another log detour into project maintenance. Recompiled ctags with a
patch to support PHP5. Cleared out some cruft that prevented the Log
and Cart classes from being found by find-tag. More code formatting
and logging statements added.




#########################################################################
060612 Mon 12 Jun 2006 10:09:15 AM EDT

Yesterday (Sunday the 11th) Peter noticed store sales were down. He
couldn't place an order; ultimately the problem was Apache2/PHP5 were
segfaulting on OSC-2.

When one redeems the coupon from joining MPA, the following tables are
updated when the coupon is applied:

osc_customers_basket
osc_session_info
osc_coupon_codes



#########################################################################
060614 Wed 14 Jun 2006 03:26:54 PM EDT

Pretty much done with moving gifts into gallery. Left it as its own
project, fought for almost a day getting configuration issues fixed.



#########################################################################
060616 Fri 16 Jun 2006 09:36:14 AM EDT

Personal day yesterday; though I did the rollout (and debugging) for
Jessy, and was in on a conference call in the afternoon.

Renaming all file extensions with sed:
for x in `find . -name *.vb`; do mv "$x" `echo $x | sed s/vb$/VB/`; done

Long painful detour into debugging the goddam gifts app again; font
wasn't working. Now I'm not even sure what I did to fix it! But I did
lots of code cleanup again. Also fixed the store so the links to
change frame or caption on a card work.


#########################################################################
060619 Mon 19 Jun 2006 09:54:39 AM EDT

DNS down this morning; the A/C failed in the server room.

Rolled out the new gifts setup to staging and documented all the
changes I had to make; this will require a rollout of the OFS as well,
I think... may as well get it out of the way... also make a small
change so Dashon can do his promotion (send them right to the frames
page).

Then a big hullabaloo when goodshot88 disappeared. Deleted by user
request on 6/16. Found all the photos in the trash. Why, then, was
nothing showing in the http logs?

Everything rolled out; probably should roll this stuff live tomorrow.




#########################################################################
060620 Tue 20 Jun 2006 10:05:01 AM EDT

Off to a busy start; spent time on the phone with Tim after Jessy
accidentally pasted him a project spec and he freaked out. Followed up
with an email. Got two orders to check on: 18477, via Marte, no
authorizenet info in store, changed in authorizenet though. From
Hanley, 19196, which was charged multiple times like the guy in
France.

Did detective work to find out how two orders went wrong; the main
problem, though, is the logs rotated out already and there's no info
left to look at.

Wrote a small shell script to rotate the logs to /opt/mpa/logs, but I
need to ask Chris where he thinks I should switch osc logging to;
/home/www seems like a good first choice but /var/osc might work too.

So, this was an easy bug to duplicate, fortunately. Just click STOP
after submitting the order; I wait until I start to see log output and
stop it. The nitty gritty is the redirect to checkout_success.php
never happens, and thus the cart is never cleared.

I added a test to see if the order has been paid for, and
ignore_user_abort(true) to make sure the transaction completes. But
since they never get the redirect, the cart is never cleared. This is
a pretty bad bug. So that code needs to move over to the
checkout_process.php file. Placed a FIXME in it.




#########################################################################
060621 Wed 21 Jun 2006 11:47:47 AM EDT

chrisatfcity: # Database settings
$DB_HOST = '10.20.0.60:3309';
$DB_NAME = 'mpa';
$DB_USER = 'mpauser';
Steve Wainstead: k
chrisatfcity: so if we run it on mdb-2 it should connect to the primary server
Steve Wainstead: k
chrisatfcity: someof the other cron scripts use the socket... they will need to change...
chrisatfcity: that will take time..

Manager's meeting, and then was helping Fernando with an order that
would mysteriously hang... turned out to be a stale NFS filehandle.

Sorted through my todo lists; lots to do! Need to get rollouts done.




#########################################################################
060622 Thu 22 Jun 2006 03:22:51 PM EDT

Have been pouring through the spec for TLC; turns out the one online
is dated 2005 and the printout I was given is from 2003.

I've looked at different Perl XML interfaces, but XML::Writer looks
adequate. I thought about just using simple templates and
interpolation but I think the module handles escaping stuff for you.

Have been drawing up a list of things needed to be done; one thing
looks like a must, Veracity. My idea of a "permalink" is going to get
around a number of issues versus if we just give tlc the link via
rawimages, which might be bogus by the time they query for it.

So before that can happen the CRUD operations in Gallery have to be
perfect. Deleted photos will have to remain on the filesystem and some
simple mark and sweep thingie will have to run via cron.

Adding a new product to OSC is a total mystery.

Renamed about 10 tables that don't appear to be in use anymore in
osc. Also, found that 24 is the category for clubs, and it's the only
category; it appears to be used to exclude clubs from the cart during
certain calculations.


#########################################################################
060626 Mon 26 Jun 2006 10:08:42 AM EDT

Have to switch gears today and change all the photo prices in the
store. Probably should start with a few new automated tests.

Regexp to highlight all keywords via F11: 

SELECT\|select\|INSERT\|insert\|UPDATE\|update\|DELETE\|delete

Tried to cast the method arguments in Cart::addProduct, but Gallery
chokes on it. Bleh.


I am mostly done with price changes; it's pretty complicated. Oh,
changing the base price on prints is simple:

update osc_products set products_price=0.1900 where products_id in
(114,143,152,899);

But I had to update the club discounts as well, which took a while to
figure out:

update osc_offers set amount=0.1500 where amount=0.1800;

This is cheating, of course. But now I have display issues; the old
prices are displaying.

Well, those are hardcoded into thumbDisplay.class.php. Changed.
Changed shipping costs too, which live in  product.class.php.

Also updated prices in shipping.php, and on www: pricing.shtml.

Rollouts done: www and the store. What a pain. Should I even go into
it here? Sure. Ching Yi needs her own copy of www and know how to
update it... Jessy shouldn't be updating www on production.

Fixed a bunch of small bugs; one involved mpa_fqdn being used in
gifts.header, which was masquerading as all.header.default due to
non-updating CVS keywords (id) again. Wtf? It's too noisy in here and
I am getting very angry.

Hmm. So reading "Refactoring To Patterns" I learned that one can
manage complex XML documents via the Composite Pattern, which it turns
out I haven't read up on yet; I read up in Head First Design Patterns
today and now I see it's just an Iterator for a
hierarchy. Well. Fernando was just asking me about visiting every
album, which Veracity does, and it dawned on me that Composite can
also be used for the album hierarchy as well. Anyway.




#########################################################################
060629 Thu 29 Jun 2006 02:13:11 PM EDT

Cable and broadband fixed yesterday. I was home all day, in other
words. Chris took back www on production from Jessy, and I think set
up Ching Yi on development to control www.

Basic CRUD correctly updates the mpa_photos table. I think getting the
sizes in there is going to be major suck though.

Long letter detailing what lies ahead for me:


I'm going to go into a long ramble here on what I've been working on;
I'll try not to be too technical so you can get a flavor of what I'm
doing....

First, the main issue is doing business with TLC. They will handle all
products for us (books, calendars, mugs, mouse pads, etc) and District
will do prints, cards and discs.

So this first seems to necessitate some major rework of the
architecture of the Order Fulfillment System. I'd already been doing
work on that, starting a few weeks ago, to handle new products; now it
will need to generate different XML files and send them to different
destinations depending on what the product is.

Actually, I think I have a pretty good handle on this. Going with TLC
doesn't pose any huge problems, on a technical level. There's just a
lot of coding and testing to do.

But there's an old bug, and a big one: TLC needs the URL to the photo
for the product. That is, Jane orders a calendar with 12 pix of Dick;
we generate the order XML for TLC, which has 12 URLs to the photos of
Dick. (Insert joke here, if you will).

The bug is, Jane places her order, then goes and moves the photos
around to other albums (or, deciding she doesn't want anyone else to
see Dick's photos, deletes all the pictures). This is a problem that
has plagued us from day 1 of selling prints, and lately Fernando has
to deal with this on an almost daily basis.

I've put two kludges in to help alleviate this (the Trashcan, and
checks in delete_photo and delete_album to see if any of them are in
the cart); but still our wily users figure out how to remove their
photos and cause us grief. As print sales go up this gets worse.


So, in order to work with TLC, we need to finish step 1 of
Veracity. Then we can have "permanent links." Explanation:

All photos and movies are currently stored in a table in the database;
but this table doesn't meet all our needs anymore and Veracity is all
about replacing that table with another, then making sure that table
stays in sync with the filesystem.

The current table is missing at least 5 million photos (because it was
started late in the game) and the current count of prints via Tim's
numbers appears to be off by about 2 million.

So all that said, what needs to happen to make Veracity phase one done? 
* All of Gallery's CRUD operations -- Create, Read, Update, Delete -- need to be up to date. 
* Then they need to update this new table. 
* Then this new table needs to be created, merging data from the old table into the new table. 

Phew! Lots of work there.

But that's pretty close to completion. Today I tested Gallery's CRUD
operations and they currently update the old table correctly. So they
need to operate, probably in parallel, on the new table.

And when all that's done, we have "permanent links." We can tell TLC
that Jane's photo of Dick is at:

janes.myphotoalbum.com/get_photo.php?id=5900900

and ignore the filename, the albumname, and all that. Similarly, when
Jane deletes all her photos because Dick was cheating on her, in the
new table we will mark her photos with a "D." At some later date we'll
delete them off the filesystem, but not before we're sure they are not
part of an order-in-progress.

Now, Chris also needs Veracity phase one because it will give him a
very accurate picture of our filesystem use, which will let Peter hold
off on buying new storage until the last possible nanosecond. That,
however, is a big hairy ball of nasty coding to do... because the new
table will need to be updated whenever Jane does the following:

* resizes her thumbnails
* resizes her "sized" images
* makes a new highlight for her album
* probably ten other things I'm not thinking of

And, whenever Jane uploads new photos, the sizes for thumbnail,
intermediate and highlight images all need to be recorded, and this is
all code that hasn't been written yet. And it looks to be really
tedious to do.

So I think for now I"m going to fall back on Veracity to do what it's
intended to do: keep the filesystem and database in sync, and not
bother with the above unwritten operations just yet. Well, sized and
thumb sizes have to go in, no getting around that... but I'm thinking
that, going forward, we'll run the Veracity program once every month,
or two weeks, or whatever's practical, and everything will be brought
up to date. This will probably mean the new table will, by month's
end, be off by a couple of gigabytes but no more. I think that's
accurate enough for now.

Now the problem with all of this is just the sheer scope of it. For
example: Tim's command line tools and admin CGI scripts do not update
the old table. Delete a user, like our old friend ronniepak, and:

mysql> select count(*) from mpa_photos where subdomain='ronniepak';
+----------+
| count(*) |
+----------+
|     7775 |
+----------+
1 row in set (0.06 sec)

Oops!  Well, there's 7,775 images of Asian porn that are still in the
table but not on the filesystem (unless Bleu hid them somewhere;
highly doubtful).

Anyway, the point is the changes are so far reaching, and in some
cases fundamental, that it can be a bit overwhelming at times. It's
hard to not go down other alleys where things need doing: this week
Chris, Tim and I had an email exchange over "Why do we need the
banlist?" And the answer was: "It was projected as a need at the time,
but we can probably just change the user's status in the users table."

And why was I thinking of banned users at all? Ha. Well, we have had a
case where a banned user had *ordered prints* and the order broke
because his site was removed. Bleh.

And banned sites don't have their photos removed from the table,
meaning things are not updated properly, etc. etc. You get the idea.

Then, getting into the CRUD operations for Gallery, the functions are
in the file Chris dearly loathes: ampira.local.php. (He hates the name
mostly). So today I'm moving those functions to where they should be,
DBConn.class,inc, and whoops! I broke the password retrieval. (But
fixed that. I anticipated it).

Anyway that's pretty much where I'm at. It's the long answer to "What
are you working on, Swain?" To recap, in order, I need to make the
following happen:

* Veracity phase 1, yielding a new mpa_albumitems table
* A script that can pull up any photo from any gallery, via the ID from mpa_albumitems
* Gallery updates this new table correctly (sans shifting file sizes, for now)

Then for TLC I can do the following:
* build the XML file for an order
* transmit that to TLC, as proof of concept.

Then for the store, I'll need to:
* add new products, make them show up, pick quantities, etc.
* write a script which TLC will POST to, via HTTPS, to update the
  order's status. (Though I might write this as part of the OFS to
  keep it all Perl so I'm not writing the same thing in two
  languages).

So that's the grand overview. When can it all be done? The devil is in
the details. Until I wrote this out I didn't even realize that if TLC
posts order status to the store, then I've got a race condition where
either the OFS or the store is finishing the order... so dates I put
on this stuff are greatly in flux:

I think I can get Veracity phase 1 done by end of next week.  The
script to pull up photos shouldn't take more than a day after that.
Gallery updating the new table should be another day or two.

For the TLC stuff, this is going to take much longer because (glaze
your eyes over for a minute):

* Figure out how to build the order based on the current store schema

* refactor the build_order.pl script to use a small object hierarchy,
  with a Factory method, polymorphism and all that stuff, so we can
  quickly add new products (and I mean QUICKLY) in the future

* refactor create_dpi_xml.pl to build more than one kind of XML file
  depending on the people doing the order fulfillment. Might use the
  Composite pattern here. Might cheat and write simple templates but
  that's more brittle.

* refactor the ftp_files_to_district.pl script to handle sending
  orders generically

This is really hard to estimate, but we're looking at a couple weeks or more.

For the store, my least favorite part to do:

* add new products
* accept the input from whatever tools we get from Primary Development
* display, quantities,  navigation and all that joyous stuff in the store

Since this is a ways out, I'm not going to put a date on it now. I've
been telling Peter all along that this work on the store is a "fixed
cost," one we incur no matter who fills our orders or what we sell.

But it's now July, for all practical purposes, and the holiday season
starts in just two months (my mom does her Christmas shopping in
September, so to me that's the start of Christmas shopping). So time
is running short. I'd like to get all this done before the end of
September, three months from now.

~swain

--------
Steve Wainstead
Software Development Manager
http://www.myphotoalbum.com/
(212) 981-8635






#########################################################################
060630 Fri 30 Jun 2006 02:50:38 PM EDT

Well, all CRUD working just fine this morning after adding secondary
queries where needed; except... well... moving causes major
problems. It deletes old rows and inserts new ones; not the behavior
we want! Unless.. hmmm.. what if I just pass the mpa_id around instead
of using NULL? Wow. That sounds dirt simple. Except... we would need
to delete the old row before creating the new one. Hrmm. And info is
still lost.

So I've been reading and reading the super long methods that happen
during these operations. Tedious. Office is very quiet, most people
are not here (away or left early).


#########################################################################
060705 Wed 05 Jul 2006 04:10:56 PM EDT

Peter trapped in Canada.

Meanwhile, auto increment IDs and "REPLACE INTO" syntax are bad:

mysql> replace into delme values(NULL, 'swain', 'album02', 'double', 'jpg', 'D');
Query OK, 1 row affected (0.02 sec)

mysql> replace into delme VALUES(NULL, 'swain', 'album01', 'sipping', 'jpg', '');
Query OK, 1 row affected (0.00 sec)

mysql> select * from delme; 
+----+----------+-----------+----------+-----------+--------+
| id | username | albumname | filename | extension | status |
+----+----------+-----------+----------+-----------+--------+
|  1 | swain    | album02   | double   | jpg       |        |
|  2 | swain    | album01   | sipping  | jpg       |        |
+----+----------+-----------+----------+-----------+--------+
2 rows in set (0.00 sec)

mysql> replace into delme values(NULL, 'swain', 'album02', 'double', 'jpg', 'D');
Query OK, 2 rows affected (0.00 sec)

mysql> select * from delme; 
+----+----------+-----------+----------+-----------+--------+
| id | username | albumname | filename | extension | status |
+----+----------+-----------+----------+-----------+--------+
|  2 | swain    | album01   | sipping  | jpg       |        |
|  3 | swain    | album02   | double   | jpg       | D      |
+----+----------+-----------+----------+-----------+--------+
2 rows in set (0.01 sec)


It, indeed, deletes the row and inserts a new one.

I found the SQL standard specifies ON DUPLICATE KEY UPDATE for insert
statements:

drop table if exists delme;
create table delme (
                    id int(11) not null auto_increment,
                       username varchar(32),
                       albumname varchar(32),
                       filename varchar(32),
                       extension varchar(32),
                       status varchar(4),
                       timestamp DATETIME default 0,
                       UNIQUE KEY `image_unique_key` (`username`,`albumname`,`filename`,`extension`),
                         PRIMARY KEY  (`id`)
);

INSERT INTO delme VALUES(NULL, 'swain', 'album01', 'sipping', 'jpg', '', NOW()) ON DUPLICATE KEY UPDATE status='T', albumname='album01', filename='sipping', extension='jpg', timestamp=NOW();


mysql> select * from delme;
+----+----------+-----------+----------+-----------+--------+---------------------+
| id | username | albumname | filename | extension | status | timestamp           |
+----+----------+-----------+----------+-----------+--------+---------------------+
|  1 | swain    | album01   | sipping  | jpg       |        | 2006-07-05 16:27:23 |
+----+----------+-----------+----------+-----------+--------+---------------------+
1 row in set (0.00 sec)

mysql> INSERT INTO delme VALUES(NULL, 'swain', 'album01', 'sipping', 'jpg', '', NOW()) ON DUPLICATE KEY UPDATE status='T', albumname='album01', filename='sipping', extension='jpg', timestamp=NOW();
Query OK, 2 rows affected (0.00 sec)

mysql> select * from delme;
+----+----------+-----------+----------+-----------+--------+---------------------+
| id | username | albumname | filename | extension | status | timestamp           |
+----+----------+-----------+----------+-----------+--------+---------------------+
|  1 | swain    | album01   | sipping  | jpg       | T      | 2006-07-05 16:27:38 |
+----+----------+-----------+----------+-----------+--------+---------------------+
1 row in set (0.00 sec)

mysql> INSERT INTO delme VALUES(NULL, 'swain', 'album01', 'sipping', 'jpg', '', NOW()) ON DUPLICATE KEY UPDATE status='T', albumname='album01', filename='sipping', extension='jpg', timestamp=NOW();
Query OK, 2 rows affected (0.00 sec)

mysql> select * from delme;
+----+----------+-----------+----------+-----------+--------+---------------------+
| id | username | albumname | filename | extension | status | timestamp           |
+----+----------+-----------+----------+-----------+--------+---------------------+
|  1 | swain    | album01   | sipping  | jpg       | T      | 2006-07-05 16:27:50 |
+----+----------+-----------+----------+-----------+--------+---------------------+
1 row in set (0.00 sec)





#########################################################################
060707 Fri 07 Jul 2006 02:38:22 PM EDT

So, yesterday and today... did a lot of testing of the points
system. Found mostly superficial bugs, filed or emailed them all. Then
tweaked veracity to give every photo object a new mpa_id, which is the
key in mpa_albumitems; and lo, worked on the first run. Pretty
exciting. Been trying to get delayed video processing working
again... mostly there... I just committed a copy of view_photo.php
where the video does not play. I stripped the ad stuff and commented
out the damn capping crap.

Worked out the bug with Veracity, where it quit on a duplicate key. In
ysabella, album10, on production there are two entries for the
filename 'jan' in the DAT file. I accomodated for this. Yesterday I
tested saving the photo with a new field, mpa_id; this worked, so I
started a new run around 4pm to save all the photo.dat files with the
new ID's in them.


#########################################################################
060711 Tue 11 Jul 2006 10:32:18 AM EDT

So far today: helped Jessy with javascript stuff for
dropdowns. onMouseOver creates an event e, but onClick does not.

Meanwhile, been merging gifts and gallery yesterday and today. The
huge PNG files make everything super laborious, and I postponed
eliminating duplicate files for now in gifts and gallery. Jessy can do
that later; she'll be able to do it 10x faster than I can.




#########################################################################
060713 Thu 13 Jul 2006 05:03:43 PM EDT

Points rolled out today. Tons of work the last three days getting this
all together, including the last minute changes (mostly stifling debug
output).

Gonna have to run Veracity again this weekend, since the table was not
getting mirrored to the slave. Alas.


#########################################################################
060714 Fri 14 Jul 2006 09:11:47 AM EDT

In early today; like 8 something. Hanley still sick, the poor
thing. Has a fever.

Store ran smoothly overnight. Whew. I introduced a bug for a window of
5-10 minutes yesterday evening when I rolled out a changed
checkout_process.php and didn't roll out the corresponding
auth_gateway.class.php. Doh. Some dude in AU's order was borked.

OK, the order was charged; I found the transaction in
/tmp/authorizenet.log on osc1. Updated the order, cleared the
customer's cart and emailed him. All is well now.

It's time to kick off Veracity again. Bugging Chris to make sure
mirroring works. The table was not being mirrored to mdb-2 (grrr) so
it has to be done all over again.




#########################################################################
060715 Sat 15 Jul 2006 11:23:24 AM EDT

Aha. mpa_id does not make it into osc_customers_basket_attributes. I
need to revive abbrev mode; tired of typing these long long things
out. Also tired of typing the same queries over and over.

Listing all key/value pairs in the basket:

SELECT cba.customers_basket_id, 
       cba.key,
       cba.value 
FROM
       osc_session_info si, 
       osc_customers_basket cb,
       osc_customers_basket_attributes cba 
WHERE
       cba.customers_basket_id=cb.customers_basket_id AND
       cb.session_info_id=si.session_info_id AND
       si.sess_key='57104d06936ff8f019cd5eebc871ebf2';

Time it took to solve the bug, where mpa_id was not being passed
through: approximately 4 hours. Why: duplicity. Though I defined
{txt_10} to be the mpa_id, in a case statement I only added {txt_10}
and not its corresponding {mpa_id}. So the case statement filtered it
out. Sad.

The short of it is: txt_NN should probably be factored out
completely. I think Trevor used to use the numbers as part of an
array; I don't see a need for them anymore.


#########################################################################
060717 Mon 17 Jul 2006 04:07:40 PM EDT

I should note what I've done and what needs doing, at this
moment... spent the morning working on Veracity again; new
features. In short, there was a bug in the last release of Gallery: in
Album, in addPhoto, I was assigning the mpa_id to $item AFTER it had
been added to the Album's photo array. This meant I was working on a
copy and the data was not getting written out.

So everyone since the last Gallery release has not been getting mpa_id
or phid written to their objects. No big deal, I guess. But now we
need to bring all those photos up to date. So I wrote a lot of code
today to handle that. Sadly there is now another big new chunk to be
done that I'll put off for now: verify that all the contents in the
mpa_albumitems table for a given site is valid. My new code only
validates the other way (if it's on the filesystem, make sure it's in
the database). Some other big new things made it to the todo list
today.

Like Saturday, now I'm kind of exhausted and don't want to start the
next thing. But I shall try.

So I'm realizing that in order to test the OFS with new products, one
must be able to buy new products. (Duh). So I have to grok how to add
new things to the store. Which I'm half way there, aren't I? I just
have to see how cards do it.

Product is the base class for photoClass and cardClass. So to add a
book, we'll need a bookClass. Perhaps I should start with something
easier?

cardClass:
     22:    function giftCard( $_product_id, $qty, $_attr ) {
     32:    function getFullString() {
     39:    function getAttributesString() {
     54:    function getThumb()   { return $this->attributes['gc_tmp_img']    ; }
     56:    function getUnique()  { return 'gc_' . $this->attributes['gc_id'] ; }
     58:    function getGcId()    { return $this->attributes['gc_id']         ; }
     60:    function getCaption() { return $this->attributes['caption']       ; }
     62:    function getFrame()   { return $this->attributes['frame']         ; }
     64:    function getWidth()   { return $this->attributes['width']         ; }
     66:    function getHeight()  { return $this->attributes['height']        ; }
     68:    function getImg()     { return $this->attributes['full_image']    ; }
     71:    function parseFullString( $full_str ) {
    150:    function getImagePath( $pp, $which = '' ) {
    170:    function buildNestedPath($p) {
    176:    function getPixelsMin($_id) {


photoPrint:
     14:    function photoPrint( $_product_id, $qty, $_attr ) {
     21:    function getFullString() {
     27:    function _setImagePaths() {
     49:    function getAttributesString() {
     61:    function getThumb()      { return $this->attributes['thumb']; }
     63:    function getFullImage()  { return $this->attributes['full_image']; }
     65:    function getSizedImage() { return $this->attributes['sized_image']; } 
     67:    function getUnique()     {  return  $this->product_id 
     72:    function getImage()      { return $this->attributes['image'] . $this->attributes['extension']; }
     76:    function getJustImage() { return $this->attributes['image']; }
     78:    function getExtension() { return $this->attributes['extension']; }
     80:    function getWidth()     { return $this->attributes['width']; }
     82:    function getHeight()    { return $this->attributes['height']; }
     84:    function getAlbum()     { return $this->attributes['album']; }
     86:    function getFsPath()    { return $this->attributes['fs_path']; }
     98:    function parseFullString( $full_str ) {
    168:    function getImagePathFromArr($args,$which = '') {
    202:    function getImagePath( $pp, $which = '' ) {
    222:    function buildNestedPath($p) {
    228:    function getPixelsMin($_id) {
    247:    function extractLegacyImagePath($old_str) {
    264:    function recommend4XD( $photo ) {


Product:
     31:    function Product( $_product_id, $_qty = 1, $_attr ) {
     40:    function getSubdomain()          { return $this->attributes['subdomain']  ; }
     42:    function getQty()                { return $this->qty                      ; }
     44:    function getAttributes()         { return $this->attributes               ; }
     46:    function setId($_i)              {  $this->id = $_i                       ; }
     47:    function getId()                 { return $this->id                       ; }
     49:    function setProductName($_i)     { $this->product_name = $_i              ; }
     50:    function getProductName()        { return $this->product_name             ; }
     52:    function setProductId($_i)       { $this->product_id = $_i                ; }
     53:    function getProductId()          { return $this->product_id               ; }
     55:    function setPriceSet($_i)        { $this->price_set = $_i                 ; }
     56:    function getPriceSet()           { return $this->price_set                ; }
     58:    function setPrice($_i)           { $this->price = $_i                     ; }
     59:    function getPrice()              { return $this->price                    ; }
     61:    function setFinalPrice($_i)      { $this->final_price = $_i               ; }
     62:    function getFinalPrice()         { return $this->final_price              ; }
     64:    function setPriceSetComment($_i) { $this->price_set_comment = $_i         ; }
     65:    function getPriceSetComment()    { return $this->price_set_comment        ; }
     67:    function getSortOrder()          { return $this->attributes['sort_order'] ; }
     79:    function buildFromString( $_string , $qty = 1) {
     89:    function build( $_product_id, $qty, $attr ) {
    144:    function getShippingCost( $categories_id, $qty , $tier ) {
    203:    function getProductCodes( $class ) {
    222:    function getCategory( $pid ) {

I think tomorrow I'll define a simple new product. It's just a
subclass of Product, has to have a Trevor protocol array, and know how
to store that in osc_customers_basket_attributes, perhaps.


#########################################################################
060718 Tue 18 Jul 2006 10:47:12 AM EDT

Adding a new product: first, subclass Product: 

class NullProduct extends Product {}

This will need to define its own parseFullString() method, which takes
a string like:

{foo}blippynews{bar}wingwongblee{sell_by}august_2006

and converts that to an array; the method is called statically in the
build() method of Product. (Factory Pattern).

Product display in the cart: shopping_cart.php figures out if there
are any of that product type, and if so, builds a string to render
them. This string contains (I think) a table. The real meat is at the
bottom of the file:


    print <<<EOS

        <tr><td>$order_prints_str</td></tr>
		<tr><td>$packages_to_buy</td></tr>
        <tr><td>$express_select_str</td></tr>
		<tr><Td>$update_and_return</TD></tr>
        <tr><td align="center" >$photos_in_cart_str</td></tr>
      	<tr><td>$other_products_table</td></tr>

	
EOS;

I realized last night or this morning that
osc_orders_products_attributes is not a scalability problem, really,
for the end user. They never hit it unless they view their order after
it's placed. The real action is in cart and cart_attributes; as long
as we keep them flushed periodically we should be OK. The OFS will
eventually have problems with OPA but we can archive the stuff.

 
This probably represents the most interesting stuff for products, via
the database:

mysql> SELECT p.products_id, 
              products_name,
              products_quantity, 
              products_price,
              ofs_prefix_code, 
              products_name 
       FROM osc_products p,
            osc_products_description pd 
       WHERE p.products_id = pd.products_id;
+-------------+-----------------------------+-------------------+----------------+-----------------+-----------------------------+
| products_id | products_name               | products_quantity | products_price | ofs_prefix_code | products_name               |
+-------------+-----------------------------+-------------------+----------------+-----------------+-----------------------------+
|         114 | 4X6                         |                 1 |         0.1900 |      1000000000 | 4X6                         |
|         143 | 4X6 Matte                   |                 1 |         0.1900 |      1000000000 | 4X6 Matte                   |
|         152 | 4XD                         |                 1 |         0.1900 |      1000000000 | 4XD                         |
|         899 | 4XD                         |                 0 |         0.1900 |      1000000000 | 4XD                         |
|         115 | 5X7                         |                 1 |         0.9500 |      1000000000 | 5X7                         |
|         144 | 5X7 Matte                   |                 1 |         0.9500 |      1000000000 | 5X7 Matte                   |
|         118 | 8X10                        |                 1 |         4.0000 |      1000000000 | 8X10                        |
|         146 | 8X10 Matte                  |                 1 |         4.0000 |      1000000000 | 8X10 Matte                  |
|         148 | Club Membership             |                 1 |        15.0000 |               0 | Club Membership             |
|         149 | Flat Rate Shipping          |                 1 |         1.7500 |               0 | Flat Rate Shipping          |
|         150 | Flat Rate Shipping (Canada) |                 1 |         1.7500 |               0 | Flat Rate Shipping (Canada) |
|         898 | Gift Card 4X8               |                20 |        15.9500 |      2000000000 | Gift Card 4X8               |
|         172 | Gift Card 5X7               |                20 |        17.9500 |      3000000000 | Gift Card 5X7               |
+-------------+-----------------------------+-------------------+----------------+-----------------+-----------------------------+
13 rows in set (0.06 sec)

The contents of products is.. not used, really. Neither is
osc_products_to_categories ever used, except for sorting, as far as I
can tell. Whatever the category ID applies to, no idea... a table long
vanquished I am guessing. Although note I put ofs_prefix_code in
osc_products, which seems pretty logical.

So all print sizes will need entries in osc_products and
osc_products_description, and probably the useless
osc_products_to_categories, and then they will need stuff added to the
photoPrint class. Note there is a getPixelsMin() in photoPrint; I
don't think the values in the db are used.

useful for fetching order from opa:
select opa.products_options, opa.products_options_values from osc_orders_products_attributes opa where orders_id=519;

Today: managed to create a Swain product, which was a good exercise. I
even got it to display in shopping_cart.php. But it gets lost on the
way to checkout_payment.php. So another bug to solve. Product codes
are spread out and repeated too much; Cart uses the defined constants
so it's another place where they are known... there needs to be one
point for all products; I think maybe a ProductsCollection class which
handles everything about products and their codes. Hell, it could even
be the factory for new Product subclasses.

There'a  pattern to solve the problem of photos versus everything
else; thought briefly today that the Decorator pattern might do it,
but perhaps not. But we have photos, cards, clubs, and now zillions of
other products coming up; so each has its own needs but all are things
in the cart, things to show on the page.

Meanwhile... Tim found I had not populated the userid column in
mpa_albumitems correctly; bug in veracity caused it (fixed, load
user.local.php for every iteration) and I wrote and tested a stored
procedure to update the mpa_albumitems table. It allegedly broke
replication on production.

Also tried to drop a few columns that were not in use, but that broke
the store. Some queries call for the columns even though they contain
nothing.




#########################################################################
060719 Wed 19 Jul 2006 12:10:53 PM EDT

Been putting around trying to figure out why my test product gets
dropped by the shopping cart after _updateCart() is called... and I
think it has something to do with the Trevor strings, or an associated
form element in the page. Dunno. It's so ridiculously complicated,
though, that I'm looking for anything else to do but that.

Got it. Adding a product: you have to have two form input elements for
a given product. 'product_id[]' and 'cart_quantity[]'. It would be a
benefit if we used key/value pairs here instead of relying on array
sequences, would be my first guess; but perhaps this enforces a
standard order for things placed in the cart (iirc, customers want to
see the prints come out of the envelope in the same order in which
they were taken, which is the same order in which they were
photographed, or else organized in their Gallery).





#########################################################################
060720 Thu 20 Jul 2006 09:44:17 AM EDT


Giving up, for about the fourth time, on battling Chris over where the
store should log to. At this point, both servers log to the same file
on shared storage, which is probably about as good as I can hope for.

Best I create a full summary (is that an oxymoron?) while it's fairly
fresh:

1a. One must subclass Product (product.class.php) first.
1b. Then update the Factory method "build()" in the ProductFactory class.
1c. And require() the new subclass in productfactory.class.php (in the
    case statement)
1d. And add to the case statement in Product::getCategory().
1e. And add the product code(s) to Product::getProductCodes($class)

2. In shopping_cart.php:

* Add a function _addYourProduct() in inc_shopping_cart_functions.php
  for the case "action=add_product"

* Create a string to display in the HTML form, which has hidden fields
  of product_id[] and cart_quantity[].

3. In the database: insert/update the tables like so:

    -- define the Attic Key product.
    -- $Id: LOG.txt,v 1.1 2007/11/27 22:54:23 swain Exp $
    DELETE FROM osc_products               WHERE products_id=2000;
    DELETE FROM osc_products_description   WHERE products_id=2000;
    DELETE FROM osc_products_to_categories WHERE products_id=2000;
    
    INSERT INTO osc_products               (products_id, ofs_prefix_code, constant_name) VALUES(2000, 0, 'PRODUCT_ATTIC_KEY');
    INSERT INTO osc_products_description   (products_id, products_name)   VALUES(2000, 'Key to the Attic');
    INSERT INTO osc_products_to_categories (products_id, categories_id)   VALUES(2000, 24); 
    
    UPDATE osc_products SET products_date_added=NOW() WHERE products_id=2000;
    UPDATE osc_products SET products_price=9.95       WHERE products_id=2000;


Note: ALWAYS ALWAYS define the primary key yourself. Commit your SQL
to the myphotoalbum/mysql/mpa project. NEVER let auto_increment choose
the primary key for you.


4. In store.conf: define constant YOUR_PRODUCTS_CATEGORY_ID. Propagate
   this constant to staging and production right away; don't wait till
   later. You'll pay in pounds of flesh trying to figure out why
   something doesn't work later if you don't do it now. Example:
   PHOTO_BOOKS_CATEGORY is 35.

5. In checkout_confirmation.php:

* Add a block that creates HTML output for your product
  ($yourproduct_table)
* Add $yourproduct_table to the echo statement to display it.

6. In inc_email_functions.php: add formatting code for your product in
   the email to the user.

7. In account_history_info.php you need to add another HTML block
   similar to the one added to shopping_cart.php.

8. In shipping.class.php in the store project, you need to add code to
   calculate shipping for your new product IFF it's not a single photo
   gift.



You say, "my head of ops made a boo boo. he ran an alter table create index on the new table i 
made; 23 million rows. this is a live table, and every file uploaded by an mpa user results in an 
INSERT to the new table"
You say, "so he kicks off his create index, table locks, uploads queue up inserts for a while 
until the magic number 1000 is hit, and then db errors start showing up"
heller laughs. 
You say, "so what does he do? control-c. well, i know from experience thats a bad thing to do 
during index creation"
You say, "so he does a flush tables and nothing's happening, and i'm like, gee no kidding"
You say, "so i had to comment out live code to stop writing to the table"
campgod [to Wainstead \]: hm.  so i don't want -you guys- to host my new website.  


Tried to see the subdomain cookies coming from the Gallery end in the
store, but no dice. Too bad. I would like a better solution to
resetting their session when they buy a club membership.

Went through my todo lists; only crossed a couple of things off, but I
think I made a lot progress this week. Making a new product and buying
it was an accomplishment. 

Gonna have to rerun veracity this weekend if only to clean out the
filesystem.

Also, yesterday I found where the subtotal is wrong (it's in the sql
query to build a table showing the completed order).

Cleaned out my home dir; probably about 2-3 gigs of crap.


#########################################################################
060721 Fri 21 Jul 2006 10:05:15 AM EDT

Jessy wants the "key" as the first new product to the
store. Interesting. So: user clicks something, pass in a {Stow}string,
pays, and the OFS, or the store, has to undo their locked site. It
turns out the store merely needs to update the last_purchase_date
column in the users table; the GS object should get reloaded via
reloadPrem=true from the store. I should think that we can make a
display string for the product: "Click me!" (ala "Drink me!") to do
the reloadprem=true for folks that go some other route and find the
site didn't update. Would be nice if we could do something to their
session.

I can see now that the stowstring passed via Gift Cards is completely
unnecessary; it duplicates data already in the GC table. But the
implementation of the Product hierarchy requires the stowstring to
create the object. So perhaps this should be refactored thus: create
class, then either initialize it via stowstring or some other method.

We don't care how the class intializes itself, only that it goes and
gets the data it needs.

-- list products and their relevant fields
SELECT p.products_id, 
 p.products_price, 
 pd.products_name,
 constant_name, 
 categories_id, 
 ofs_prefix_code 
FROM
 osc_products p,
 osc_products_to_categories pc,
 osc_products_description pd
WHERE p.products_id=pd.products_id 
AND  pc.products_id=pd.products_id
ORDER by p.products_id;

So... got rid of a lot of the constant definitions in store.conf;
next, need to eliminate the "category" thing since it's not being
used. as far as I can tell.

Created an Attic Key product, needs some polish but it works
correctly.




#########################################################################
060724 Mon 24 Jul 2006 11:23:37 AM EDT

Watched 60 Minutes last night; piece on how the digital era leads
people to work 60-80 hours a week. The interviewer could not believe
this married couple sent instant messages back and forth when they
were in the same house. She's old.

Three workers at Best Buy were profiled. Most of their time was spent
doing email, from the sound of it.

It's now 11:25 and to a large extent I've done email as well, but also
some detective work for chrisfelishawhitaker. A whole album's full
sized images were missing.

So... I deleted some full sized images. I dunno why I didn't change
the INSERT statement so it ON DUPLICATE KEY UPDATEd the row; when a
user deleted an album, then recreated it and uploaded the same pix,
this resulted in an error because of the duplicate secondary key. The
culling script then deletes the full sized image because status='D'. I
fixed this and rolled it out.

Hanley was pretty understanding; said to just use the sized image if
it's a problem with orders.

I wrote a testbed to try out a dispatch table for shopping_cart.php,
which is going to get unmanagable after a while.




#########################################################################
060725 Tue 25 Jul 2006 09:28:51 AM EDT

Two borked orders overnight; neither my fault.


#########################################################################
060726 Wed 26 Jul 2006 04:08:14 PM EDT

Today: fixed bug where duplicate attic keys appeared when cart
updated. Cause: hanley copied/pasted the input tags. Fixed the bug
where clubs and attic keys could not appear for the same site. Cause:
$pp->getUnique() was identical for both classes, i.e. my copy/paste
error. Found gift cards were busted, due to the cards app not loading
the new define()s via the database; fixed. Played with run-veracity.pl
and created new iterator, running veracity for Tim's 18K missing
sites.




#########################################################################
060727 Thu 27 Jul 2006 10:54:11 AM EDT

Checked veracity; runs complete; 181K+ in the db now. I'm doubtful
about continuing with the table though, in its current state.

Peter reported junipertea, a family site out of Canada with photos of
a little girl running around nude. The guy also had photographed his
wife nude in a park, and the rest of the albums were all travel and
family stuff.

http://www.law.cornell.edu/uscode/html/uscode18/usc_sec_18_00002256----000-.html

By US Code, this does not constitute child porn.

Spent time in the Perl Debugger trying to figure out why Test::Class
was failing during 'make test.' Posted results to cpanforum.com.

There are conflicting impulses in my mind these days. One is: we
could save a lot of grief if we rename the file when it's
uploaded. Then
some_long_filename_the_user_thought_up_but_it's_really_a_caption would
become something machine friendly like
127f988d52c661bfd84e80abe2719b36.

Well, Jessy has talked about club members getting mod_rewrite to make
prettier URLs; which I think is a good idea. Most photo services suck
ass that way.

My original motivation for the mpa_albumitems table has whithered; I'm
thinking now that we move all the files (build_order.pl) and make that
available via the Web to TLC. This is a better solution, and just
leaves us with the old problem of users deleting photos before they've
placed the order.

Spork went into a tailspin. Hard reboot.


#########################################################################
060728 Fri 28 Jul 2006 05:43:30 AM EDT

Was here quite late modeling the OFS; made great progress. Only have
to figure out how xml generation will work. Uploading should be pretty
easy; for DPI it's all done, for TLC it's just a matter of using the
LWP.

Another interesting part of the problem is dealing with matte finish
versus glossy. An order to District can only contain one or the
other. So when the user toggles that, all the print product codes
shift to the other; I suppose the answer is to pull District's codes
out of the form data. We really should only rely on keywords anyway,
which are human readable and separated from the finish type. At order
fulfillment time, we can select the correct codes (or more likely, at
the time the order is paid for).

Refactored a bunch of stuff in view_photo.php. The goal was to make
the "stowstring" come from one place only, which it now does.

   1. 1-25
        2. 26-50
        3. 51-100
        4. 101-150
        5. 151-200
        6. 200+


select count(photo_count) as _to25 from  swain_sixmonth where photo_count > 1 and photo_count < 26;

select count(photo_count) as _to50 from  swain_sixmonth where photo_count >= 26 and photo_count < 51;

select count(photo_count) as _to100 from  swain_sixmonth where photo_count >= 100 and photo_count < 151;

select count(photo_count) as _to150 from  swain_sixmonth where photo_count >= 150 and photo_count < 201;

select count(photo_count) as _to150 from  swain_sixmonth where photo_count > 200;




#########################################################################
060729 Sat 29 Jul 2006 02:00:34 PM EDT

Busy day yesterday: mass changed how we call the static server
(mostly; some vestiges still remain), factored out gunk Tree left in
view_photo.php that was calculating all these variables that were not
being used, and finally somewhere around 4:30pm ran out of gas. But
lots to show in the CVS log.

Today wrapped up the numbers Jessy wanted regarding photo uploads by
users signed up in the last six months.

Oh. refactored DBInterface.pm so all the status codes come from the
database. That was a win.

Something to work out: TLC will notify us by POSTing to a URL. If they
send us XML, which I think they do, we can write that to some
directory (or the database, better yet) and let
remove_completed_orders.pl pick it up. The same generic interface
approach for everything else should be applied here.




#########################################################################
060801 Tue 01 Aug 2006 09:37:59 AM EDT

Crummy day yesterday; demotivated for some reason. I created two new
tables on mdb-2 to test doing joins on userid versus username, and
started an email conversation with Tim and Chris. Adding five million
more rows this morning. I've identified a serious liability of the
mpa_albumitems table versus mpa_photos: mpa_photos is more or less
sorted by date already, but mpa_albumitems is not. Searches by date
are much slower on mpa_albumitems.

Moved the OFS forward, fixing a couple bugs. Went round and round with
the NCMEC, unable to report that child porn incident. Still have the
crap on my drive and in my browser.

Peter requests:

I think we should track MPA users as follows: 

1. Accounts - total active user accounts
2. Accounts with a minimum of one photo uploaded
3. Accounts in Good Standing - minimum of one purchase made from an
account in past 12 months
4. Club Membership

Can you run these stats for each month ending?  Starting as far back as
Dec 31st 2005?

These are very tricky numbers. I am currently working on number 3,
which would seem to require a "site purchase history" table. Such a
thing could be generated from the oscopa table.


#########################################################################
060802 Wed 02 Aug 2006 10:19:03 AM EDT




#########################################################################
060804 Fri 04 Aug 2006 10:51:56 AM EDT

Bizarrely, Tim reentered the fray on the auto_increment integer
vs. unique username debate, with a long treatise on entropy in strings
versus sequential integers. I search the web for discussions on this
and find very little; but I did learn that ID is a "surrogate key"
because it has no bearing whatsoever on the attributes of the tuple.

auto_increment IDs also have the advantage of already being sorted,
while the index on usernames gets them in truly random order.

Anyway. Big progress on OFS yesterday, though I'm way behind where I
want to be:

2006-08-03 17:12  swain

	* lib/WholeOrder.pm: Ooops. hardcoded the status id!

2006-08-03 16:06  swain

	* lib/DBInterface.pm: Ammended all method args for wrappers that
	call get_orders

2006-08-03 15:51  swain

	* interfaces.pl: oops. wrong filename.

2006-08-03 15:47  swain

	* import_files.pl: Looks like pretty much the final version. Might
	need to finalize the program output for the log.

2006-08-03 15:12  swain

	* lib/WholeOrder.pm: Added get_errors, implemented
	set_order_complete

2006-08-03 15:11  swain

	* lib/OrderPartPrints.pm: removed hardcoded prefix code. yay!

2006-08-03 15:11  swain

	* lib/OrderPartFactory.pm: corrected debug ouput

2006-08-03 15:11  swain

	* lib/DBInterface.pm: commented out noisy debug output

2006-08-03 14:29  swain

	* lib/: OrderPart4x8Cards.pm, OrderPart5x7Cards.pm: dropped in
	favor of a single class.

2006-08-03 14:27  swain

	* lib/OrderPartFactory.pm: Dropped the separate card classes, using
	one now.

2006-08-03 14:27  swain

	* lib/DBInterface.pm: Basically rewrote get_gift_cards, which now
	returns an array of hashrefs.

2006-08-03 14:25  swain

	* lib/: OrderPartPrints.pm, OrderPart.pm: Many changes. Some
	methods moved up to base class; some moved down; calling base class
	subs directly, using OFSConf, and probably more.

2006-08-03 14:24  swain

	* lib/WholeOrder.pm: added shipping_items_count methods; dropped
	had_nothing_to_ship; default value for shipping_items_count.

2006-08-03 13:52  swain

	* lib/OrderPartCDs.pm: default constuctor causes permanent death of
	the script

2006-08-03 11:23  swain

	* import_files.pl: First cut at the replacement of build_order.pl,
	which, per my notes in interface.pl, I am renaming to
	import_files.pl. This version seems to do the whole thing just fine
	(build the order) but the classes it depends upon currently only
	handle print orders. Next: cards.


I have shrunk my design to just this: every WholeOrder can produce an
array of OrderPart objects, which are for the importing of images from
the user's site; thereafter a WholeOrder can produce an array of
OrderShippingParts, which will only be a max of 4 parts for the
forseeable future: three to DPI and one to TLC. Each OrderShippingPart
has three tasks: copy to the shipping directory, create xml file, and
upload to the shipper. I originally thought I'd parameterize the XML
and uploading functionality to helper classes, but I think for now
that's overkill, and that can be a refactoring job later.




#########################################################################
060807 Mon 07 Aug 2006 10:38:42 AM EDT

Had a fight with Chris this morning. The mup servers went into their
tailspin again, and there was a 30 minute outage, according to
Chris. He wants to move image processing off to other boxes; it's hard
to restrain myself and I blew up at him. He said repeatedly last year
that it would not be a problem; I'd drawn up a project to offload the
image processing to other boxes using a simple xml-rpc arrangement.


From:   swain@corp.fortunecity.com
Subject: Re: [Fcdev] MPA Outage
Date: August 7, 2006 11:07:04 AM EDT
To:   fcdev@ims-1.corp.fortunecity.com
Cc:   jessy@corp.fortunecity.com, fcops@corp.fortunecity.com



Rather than shouting at you in a meeting (my apologies) let me address
these in a more civil fashion:

Approximately Aug 6, 2006, at 6:00 PM, Chris Ferry spake:

> From 5:15pm to 5:45pm we had a full MPA outage.
> 
> Looks as though the mup-X servers CPU resource usage hit a peak.
> 
> I am fairly confident this is due to the intense amount of uploads we
> are receiving.
 
Actually, more generally, we are seeing an intense amount of
everything, not just uploads. Is this not correct?

Many things happen when a user uploads a file; all these external
shell calls involve PHP doing a system() call. It's also possible PHP
has some issue that results in a memory leak from repeated system()
calls. It's possible stale NFS filehandles cause errors that cause the
servers to hang. It's possible that repeated PHP upgrades, and the mup
servers not following suite, have led to a library issue.

> When convert processes hang we'll see a rise in cpu traffic and
> automatically the load balancer will offload traffic from the slow mup
> servers to the properly functioning MUP servers which can then cause a
> failure as a stampeding herd occurs.
 
I don't argue this is a plausible scenario, and it is perhaps the
primary candidate.

> We need separate these processes( image processing and dynamic content
> generation) onto separate server farms to reduce risk and provide us
> with better insight as to what is causing these intermittent outages
> at times of high load.

My concern is the delayed video processing project took over three
months -- I wrote the project spec on March 3rd, 2006
(https://twiki.corp.fortunecity.com/bin/view/MPA/DelayedProcessingOfVideosProject)
and the first entry in the table on production is June 7th, 2006.

We simply don't have time for another project of that magnitude with
the holidays approaching. If we HAVE to do this project, all I'm
asking is concrete proof that the convert binary is the
cause. Wouldn't it be horrible if we devoted the time and effort to
moving convert off to a backplane server, only to find it doesn't
solve the problem?

Now, there *has* to be some way of recording what a server is doing at
the time it goes into a tailspin. My first guess, being a mere
developer, is this: two cron jobs. One dumps the process table, or the
output of top() or the apache scoreboard or something and appends it
to a file. The second cron job truncates this file periodically so it
doesn't get too large. (You don't want to null it out, cuz that might
happen when it's in the tail spin!)

Here is a very small project you can do in a couple hours. Will it
tell us what's wrong? I dunno; as I said, I'm a mere programmer. I
wouldn't know a UDP datagram from a device file. But I count on you to
know these things, and it's my great hope you can apply your very
considerable skills into diagnosing this before we leap into a project
that may or may not solve the issue.

~swain


--------
Steve Wainstead
Software Development Manager
http://www.myphotoalbum.com/
(212) 981-8635


About as well worded as I can hope to achieve.

Finished! Well, first part anyway. I have a drop in replacement for
the OFS that looks ready to roll out; I'll need to do some more
testing to be sure. But I've rearchitected it to a small object system
and I can add TLC now. I need to do some cleanup too, and there's a
few hardcoded things that need to be abstracted out. I really enjoy
doing Perl OO.


#########################################################################
060808 Tue 08 Aug 2006 04:25:14 PM EDT

Lots of cleanup and testing today. Looking pretty solid now.

Chris has been working on a rollout system to deploy the Gallery
codebase to the three mup servers. He thinks this might solve the
Apache tailspin problem.


#########################################################################
060809 Wed 09 Aug 2006 02:03:11 PM EDT

Whew. Came in early again; hacked away at the OFS to make it run under
cron. Figured out what was new in the store, tested on staging with
production code base and it was fine; but the store rollout failed
because I forgot to apply the SQL changes. That done, rolled it out,
placed order, yay. Then rolled out the OFS, placed order, yay.

I just realized today, duh, all I have to do to remove deleted photos
is to run veracity on all distinct usernames where status='D'. Running
now.

The current query for getting the prints for an order from the
database will only get fs_path from
osc_orders_products_attributes. This is problematic. Perhaps a fatter
query won't hurt; I want to add mpa_id so the OFS can find images.

Hmm. Perhaps delete_album.php should rename the album, then run an
update. All albumnames like 'album13_deleted' would make things snappy
to clean up. Then: don't delete anything (album deletions are fast)
and veracity can clean that up.




#########################################################################
060810 Thu 10 Aug 2006 03:15:46 PM EDT

What a day. Came outside to find someone ran over the bushes. Evelyn
Hernandez to be exact.

Veracity was still running and the buffer was running out of
memory. Cleaned that up. Veracity done. Need to purge the db now... 


#########################################################################
060811 Fri 11 Aug 2006 11:06:56 AM EDT

Bleh. Gonna really feel the need for Fernando by next Friday. Already
the stats and support are a distraction.

Chris has been going nuts over the import tool; in part because he and
Jacob seem unable to cooperate, in part because it's screen scraping,
in part because what works on dev doesn't work on production. (Told
him "welcome to my world"). The rollout yesterday, which Chris
managed, took forever, or so it seemed; maybe it's because I wasn't
involved much (other than testing and bugfixing) and I didn't know it
was live until well after the fact. 

It was then found IE users could not create new albums, and I walked
Fernando through the steps to debug the problem. (The input type=image
tag did something IE didn't like, which I think I've encountered in
the past). So that got solved and rolled out. We were here until 8ish.

I worked for a while on Omni and Opera compatibility, replying to
emails as needed; Omni 5.5 will work, which should be out in a month
or so.


#########################################################################
060812 Sat 12 Aug 2006 03:18:07 PM EDT

Wrote my fifth update on TLC and Veracity and all that. Fixed a user
site that was stuck in the attic b/c they used PayPal and probably
didn't return to MPA.


#########################################################################
060814 Mon 14 Aug 2006 10:26:36 AM EDT

I pinned Chris in the morning standup on monitoring of the MIMP (Mom
I'd Like to Pimp... well, the import-from-Webshots tool). We will have
no way of knowing whether it translates into money for us; we will
have no way to know if it's failing. I stressed that appearances are
very important to Chris by his own admission; and when these tools
don't work we look bad. I asked if he even knew whether moblogging was
working or not, and he admitted he'd shut the monitor off.

SQL/DB Error -- [You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'Briain','Mastercard','k5JqaGmCfV6Ia5SoZ6ypYQ==','2010-09-30')' at line 1 ] [sql] INSERT INTO `credit_card` (`customers_id`,`creationtime`,`cc_owner`,`cc_type`,`cc_number`,`cc_expiration_date`) VALUES ( 25199, NOW(),'Aoife O'Briain','Mastercard','k5JqaGmCfV6Ia5SoZ6ypYQ==','2010-09-30') 

#0 Util->dump(, , 

SQL/DB Error -- [You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'Briain','Mastercard','k5JqaGmCfV6Ia5SoZ6ypYQ==','2010-09-30')' at line 1 ] [sql] INSERT INTO `credit_card` (`customers_id`,`creationtime`,`cc_owner`,`cc_type`,`cc_number`,`cc_expiration_date`) VALUES ( 25199, NOW(),'Aoife O'Briain','Mastercard','k5JqaGmCfV6Ia5SoZ6ypYQ==','2010-09-30') 

) called at [/mnt/cel-1/vol01/custom/store/public_html/includes/custom/ez_sql/mysql/ez_sql.php:129] 
#1 ezdb->print_error(, INSERT INTO `credit_card` (`customers_id`,`creationtime`,`cc_owner`,`cc_type`,`cc_number`,`cc_expiration_date`) VALUES ( 25199, NOW(),'Aoife O'Briain','Mastercard','k5JqaGmCfV6Ia5SoZ6ypYQ==','2010-09-30')) called at [/mnt/cel-1/vol01/custom/store/public_html/includes/custom/ez_sql/mysql/ez_sql.php:198] 
#2 ezdb->query(INSERT INTO `credit_card` (`customers_id`,`creationtime`,`cc_owner`,`cc_type`,`cc_number`,`cc_expiration_date`) VALUES ( 25199, NOW(),'Aoife O'Briain','Mastercard','k5JqaGmCfV6Ia5SoZ6ypYQ==','2010-09-30') ) called at [/mnt/cel-1/vol01/custom/store/public_html/includes/ccdb.class.php:235] 
#3 CCDB::query(INSERT INTO `credit_card` (`customers_id`,`creationtime`,`cc_owner`,`cc_type`,`cc_number`,`cc_expiration_date`) VALUES ( 25199, NOW(),'Aoife O'Briain','Mastercard','k5JqaGmCfV6Ia5SoZ6ypYQ==','2010-09-30') ) called at [/mnt/cel-1/vol01/custom/store/public_html/includes/ccdb.class.php:139] 
#4 CCDB::insert(Array ([customers_id] => 25199,[cc_type] => Mastercard,[cc_number] => 5432673658164877,[cc_owner] => Aoife O'Briain,[cc_expiration_month] => 09,[cc_expiration_year] => 2010,[cvv2] => 415)) called at [/mnt/cel-1/vol01/custom/store/public_html/checkout_payment.php:97]



#########################################################################
060815 Tue 15 Aug 2006 01:33:09 PM EDT

Fixed the above bug and rolled out. Did a lot of everything yesterday
(tech support, rollout diagnosis, sales report). Probably a typical
Fernando day. Put in for third week of September off.


#########################################################################
060816 Wed 16 Aug 2006 10:20:12 AM EDT

Below is a conversation from Avalon on the performance of the
five-levels-deep design. This conversation dates from the time Chris
and Tim were arguing over three levels versus five levels; I sided
with Tim on the argument that it didn't make any difference.


You ask, "OS question. Unix. Solaris even. A directory has more than 20,000 
subdirectories; this creates a performance penalty?"
You say, "the reason i ask is, the one developer wants to move to a scheme of 
/some/root/a/ab/abc/abcd/abcde"
You say, "right now it's /some/root/a/ab/abc"
You say, "where the first three letters are the subdomain"
You say, "he claims if we get 20000 or more users under abc, that it slows the 
OS down a lot"
You say, "the box uses xfs. but it's mounted ufs/nfs."
You say, "actually the xfs box is linux. the web server is solaris, which 
mounts it via nfs."
You say, "one of our sysadmins claims it's not necessary to go five deep in 
the directory hierarchy"
draco asks, "maybe you could go with some sort of dynamic scheme?  if any 
directory ab..n has more than X entries, change it to a/b...n instead?"
the Extended modular data-warehouse heller [to Wainstead \]: it all depends on 
a bunch of things. in solaris, it probably doesn't make that huge a difference,
 but moving won't necassarily help either. :-> 
the Assimilated stable hub heller says, "i say, don't worry about it till 
you've got it on kick ass hardware. . ."
chilly_willy [to Wainstead \]: it _can_ produce a performance penalty if the 
box is not configured properly
chilly_willy [to Wainstead \]: what version of solaris are you running?
Wainstead \ [to chilly_willy]: solaris 8
chilly_willy [to Wainstead \]: what kernel version?
chilly_willy [to Wainstead \]: hell, just run 'kstat -n dnlcstats'
chilly_willy [to Wainstead \]: hopefully it will return info :)
chilly_willy [to Wainstead \]: i want the pick_* section of output
chilly_willy [to Wainstead \]: also the dir_hits and dir_misses values
chilly_willy [to Wainstead \]: and hits/misses
Wainstead \ [to chilly_willy]: checking
[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
bash-2.03# kstat -n dnlcstats
module: unix                            instance: 0     
name:   dnlcstats                       class:    misc                         
 
        crtime                          33.501038301
        dir_add_abort                   0
        dir_add_max                     0
        dir_add_no_memory               0
        dir_cached_current              0
        dir_cached_total                14
        dir_entries_cached_current      0
        dir_fini_purge                  0
        dir_hits                        9683
        dir_misses                      1182559
        dir_reclaim_any                 2
        dir_reclaim_last                7
        dir_remove_entry_fail           0
        dir_remove_space_fail           0
        dir_start_no_memory             0
        dir_update_fail                 0
        double_enters                   4859596
        enters                          209925418
        hits                            38156852449
        misses                          185501433
        negative_cache_hits             1648481030
        pick_free                       198495972
        pick_heuristic                  11540742
        pick_last                       10826292
        purge_all                       0
        purge_fs1                       0
        purge_total_entries             168658831
        purge_vfs                       19053
        purge_vp                        7589376
        snaptime                        3714833.72235834

You say, "however that's the solaris box that mounts the nfs server. just to 
be clear."
chilly_willy [to tag]: whts the uptime on that box?
chilly_willy [to Wainstead \]: you too
You say, "43 days"
Wainstead \ |   4:25pm  up 43 days,  0:03,  5 users,  load average: 2.62, 
1.88, 1.84
chilly_willy [to Wainstead \]: ok, you have a problem :)
Wainstead \ [to chilly_willy]: what's that?
Wainstead \ [to chilly_willy]: aside from a load exceeding 2
chilly_willy [to Wainstead \]: you need to incresae the seize of ncsize in 
/etc/system
Wainstead \ [to chilly_willy]: what will that do?
chilly_willy [to Wainstead \]: increase the size of the dnlc cache
chilly_willy [to Wainstead \]: dnlc is directory name lookup cache
chilly_willy [to Wainstead \]: it caches inodes :)
chilly_willy [to Wainstead \]: the high number of pick_last/heuristic is the 
number of valid entires in the dnlc it has had to flush because it ran out of 
room
Wainstead \ [to chilly_willy]: mind you i don't think we have the problem yet. 
there are only about 15K MPA users total.
chilly_willy [to Wainstead \]: right now you're purging 4 entries from your 
dnlc cache every second
chilly_willy [to Wainstead \]: thats bad
Wainstead \ [to chilly_willy]: ack
chilly_willy [to Wainstead \]: as you get larger directories, that number will 
keep going up and up
chilly_willy [to Wainstead \]: is the box running 64 bit solaris?
chilly_willy [to Wainstead \]: and do you have root on it?
Wainstead \ [to chilly_willy]: dunno, and yes. i'm a mere developer and not a 
sysadmin. :o)
chilly_willy [to Wainstead \]: as root 'echo ncsize/D | adb -k'
[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
bash-2.03# echo ncsize/D | adb -k
physmem 3dfe4
ncsize:
ncsize:         128252

------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
chilly_willy [to Wainstead \]: have the admins add 'set ncsize=384756'
chilly_willy [to Wainstead \]: thats 3x the current value
Wainstead \ [to chilly_willy]: i'll tell them.
chilly_willy [to Wainstead \]: you don't want to go too large tho
chilly_willy [to Wainstead \]: a 64bit system uses 64bytes of memory per item, 
so 384756 will use about 24M of memory for caching inodes
chilly_willy [to Wainstead \]: all the pick_* are on my main mysql server are 
0 as i forced ncsize to 32k
---------------text pasted by chilly_willy to Emrys' Tavern----------------
min1rtgs00-Tue Nov 30 15:44:33# pwd
/opt/mysql/data/rtg
min1rtgs00-Tue Nov 30 15:44:35# ls -la | wc -l
22390
------------end of text pasted by chilly_willy to Emrys' Tavern------------
chilly_willy [to Wainstead \]: thats 22k files in my mysql data directory :)
chilly_willy [to Wainstead \]: solaris, especially solaris pre-9, uses really 
really conservative defaults
chilly_willy [to Wainstead \]: they finally updated alot of defaults in
solaris 9 to 21st century levels :)
Wainstead \ [to chilly_willy]: heh
chilly_willy [to Wainstead \]: for instance, before solaris 9, solaris would 
only cache 384k of a write to a UFS file system in memory :)
chilly_willy [to Wainstead \]: solaris 9 upped that to 16M :)
chilly_willy [to Wainstead \]: another thing to check is the output of kstat 
-n biostats
chilly_willy [to Wainstead \]: you want the cache_hits and cache_lookups to be 
as close to the same as possible
chilly_willy [to Wainstead \]: another thing to check is the output of kstat 
-n biostats
chilly_willy [to Wainstead \]: you want the cache_hits and cache_lookups to be 
as close to the same as possible
chilly_willy [to Wainstead \]: if not, bufhwm might need to be raised, but 
that would have more of an issue on actually reading the files on the disk 
instead of looking for specific files
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
bash-2.03# kstat -n biostats
module: unix                            instance: 0     
name:   biostats                        class:    misc                         
 
        buffer_cache_hits               189442785
        buffer_cache_lookups            190355163
        buffers_locked_by_someone       72585
        crtime                          27.17091864
        duplicate_buffers_found         6
        new_buffer_requests             0
        snaptime                        3717388.82356849
        waits_for_buffer_allocs         0

------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
Kyo Sa Nim xorian . o O ( biostats?  When did Solaris start using biological 
components? )
chilly_willy [to Wainstead \]: ok, bufhwm seems okie dokie
chilly_willy [to Wainstead \]: you said the nfs server is running xfs on linux?
chilly_willy says, "and no, tihs isn't a linux dig, it's a linux nfs server is 
crap compared to solaris dig"
Wainstead \ [to chilly_willy]: no argument there
chilly_willy says, "supposedly on solaris 9 serer, with a solaris 9 client, 
you can have 1M packet sizes and can basically do NFS at line speed (assuming 
the NFS server on the remote end can read from disk at line speed)"
Wainstead \ [to chilly_willy]: tim asks: if you're using the same linux on the 
front and back, then is there a better standard than standard nfs?
Wainstead \ [to chilly_willy]: tim is my developer in austin
Wainstead \ [to chilly_willy]: we are weirdly beholden to mandrake linux.
chilly_willy [to Wainstead \]: no :)
chilly_willy [to Wainstead \]: not if you want to share the same filesystem 
and want write access to it
chilly_willy [to Wainstead \]: assuming you're having more then one client
chilly_willy [to Wainstead \]: #1 option tho is to get rid of a general 
purpose server as an NFS/SMB server and get a toaster
chilly_willy [to Wainstead \]: preferably a netapp
Wainstead \ [to chilly_willy]: yeah we want a netapp. i guess our senior 
sysadmin is on to something.
chilly_willy [to Wainstead \]: also what does 'nfsstat -cn' on the solaris box 
show?
[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
bash-2.03# nfsstat -cn

Client nfs:
calls          badcalls       clgets         cltoomany
1616787552     220            1616820753     36450
Version 2: (0 calls)
null           getattr        setattr        root           lookup
0 0%           0 0%           0 0%           0 0%           0 0%
readlink       read           wrcache        write          create
0 0%           0 0%           0 0%           0 0%           0 0%
remove         rename         link           symlink        mkdir
0 0%           0 0%           0 0%           0 0%           0 0%
rmdir          readdir        statfs
0 0%           0 0%           0 0%
Version 3: (1616831730 calls)
null           getattr        setattr        lookup         access
0 0%           1260001256 77% 1964161 0%     193279464 11%  53677256 3%
readlink       read           write          create         mkdir
6729419 0%     44027534 2%    32408865 2%    4811867 0%     68056 0%
symlink        mknod          remove         rmdir          rename
140842 0%      0 0%           1761376 0%     38496 0%       6957310 0%
link           readdir        readdirplus    fsstat         fsinfo
1257310 0%     2730934 0%     1633016 0%     2146 0%        1714 0%
pathconf       commit
369600 0%      4971108 0%
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
chilly_willy [to Wainstead \]: yay, it's all using nfs3 :)
august they made a big effort to switch to 3"
You say, "but the problem was the nfs server was oat 90% capacity"
chilly_willy [to Wainstead \]: wow you do alot of traversing of directories :)
chilly_willy [to Wainstead \]: and very little reading and writing :)chilly_willy [to Wainstead \]: the increased ncsize should really help 
performance
Wainstead \ [to chilly_willy]: that's gallery for you. i want to move all the 
flat file data into mysql.
chilly_willy [to Wainstead \]: it will cut down dramaticlly on the number of 
getattr and lookup calls you'll have to make


Also a conversation with JeffO on DNS and Perl:

conversation with jeffo on how to get around dns in perl

function welcome_email($show_default=false) {
        global $gallery;

        $default=_("<tt>Hi !!FULLNAME!!,  <br><br>Congratulations and welcome to the
MyPhotoBuddy Gallery <b><nobr>&lt;%s&gt;</nobr></b>.  You have
just been subscribed to <b><nobr>&lt;%s&gt;</nobr></b>.
<br><br>Your account name is !!USERNAME!!.  Please visit the gallery soon,
and create a password by clicking this
link:<br><br><a href=!!NEWPASSWORDLINK!!>!!NEWPASSWORDLINK!!</a><br><br>Thank You,<br>
<b><nobr>&lt;%s&gt;</nobr></b> Administrator.");

AIM IM with jeffoatrulez
4/28/04, 2:26 PM
Steve Wainstead: ping
2:35 PM
jeffoatrulez: s'up?
2:55 PM
Steve Wainstead: got a hard perl question
jeffoatrulez: no such thing. 
Steve Wainstead: i need to fool resolving
Steve Wainstead: i'mm using WWW::Mechanize
Steve Wainstead: to fill and submit a form
Steve Wainstead: on a remote server.
Steve Wainstead: but the domain name isn't ready, sometimes
3:00 PM
Steve Wainstead: so how i do it by hand is to put the IP of the box and the FQDN in my /etc/hosts
jeffoatrulez: and it's a virtual host?
Steve Wainstead: this perl script runs under cron.
Steve Wainstead: yeah
jeffoatrulez: are the domains in ldap?
Steve Wainstead: getting the domains is a nonissue; it comes as input
Steve Wainstead: and i can map the cws server to its ip address
Steve Wainstead: so, say example.com is on cws-3
jeffoatrulez: right, but they're stored in ldap right? ( go with me... )
Steve Wainstead: hmm
Steve Wainstead: not sure
Steve Wainstead: the domain name is def. in ldap. yes.
jeffoatrulez: ok. well i was thinking, isn't there a way to use ldap for name resolution? maybe you can get the server to fall back to ldap is the dns record isn't found....
Steve Wainstead: sounds pretty esoteric 
jeffoatrulez: it was a perl question, right? 
Steve Wainstead: on a low level it does a gethostbyname, right?
Steve Wainstead: so i just want a hack to return the ip address of the cws box.
jeffoatrulez: yup. but i think you can tell the system to use ldap in gethostbyname calls.
Steve Wainstead: so to speak.
Steve Wainstead: hmm
jeffoatrulez: yeah, but it's a virtualhost, so you need to actually request it by name, otherwise apache will give you the default server.
Steve Wainstead: for virtual hosting to work, it has to call the ip address with the server name of example.com
Steve Wainstead: right
3:05 PM
jeffoatrulez: maybe all you have to do it hack the headers in the http module.
jeffoatrulez: you'd have to make some changes to www::mechanize and whichever http module it uses.
Steve Wainstead: i was hoping there was a perl module way to do it...
Steve Wainstead: etc::hosts.pm 
jeffoatrulez: 
Steve Wainstead: i can't believe this hasn't been encountered and solved.
jeffoatrulez: but it's a system level thing. unless you can override perl's call to gethostbyname()......
3:10 PM
Steve Wainstead: since all the HTTP communications take place via Perl and a socket, the total control of the process is there...
Steve Wainstead: so i would imagine HTTP::UserAgent would have a feature, like a method mapHostToIPAddress(127.0.0.1 => 'example.com')
Steve Wainstead: or 'example.com' => '127.0.0.1'
Steve Wainstead: rather
3:15 PM
jeffoatrulez: maybe ... but i'd guess not.
jeffoatrulez: but since it's open source.....
3:20 PM
jeffoatrulez: ok. you can do it.
jeffoatrulez: pass a HTTP::Headers object into HTTP::Request before the call the HTTP::UserAgent.
Steve Wainstead: hmm
jeffoatrulez: you'll need to modify the appropriate header like this: $h->header('Content-Type' => 'text/plain');
Steve Wainstead: i have no fear of http headers 
jeffoatrulez: ( or i should say, "you may be able to do it!" )
jeffoatrulez: not sure what the appropriate http header is, off the top of my head.
3:25 PM
Steve Wainstead: if you haven't tried it yet: firefox has an extention , "Live HTTP Headers"
Steve Wainstead: way cool
Steve Wainstead: like your own proxy server. prints all headers to a window.
jeffoatrulez: how do you enable it
jeffoatrulez: ?
Steve Wainstead: if you hve firefox, then go to hte link Plug-in FAQ
Steve Wainstead: or http://plugindoc.mozdev.org/faqs/
jeffoatrulez: cool. 
Steve Wainstead: from that page..
Steve Wainstead: mac osx
Steve Wainstead: the next page, extensions
jeffoatrulez: found it. installing....
Steve Wainstead: ok
jeffoatrulez: i guess 'Host' is the field you need to hack, right?
jeffoatrulez: unless that'll screw up the lookup.
3:30 PM
Steve Wainstead: i'm dealing with ten things at once, sorry...
jeffoatrulez: but maybe http doesn't let you do what you want to do....
3:35 PM
jeffoatrulez: i think you're screwed - http://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html#sec5.3
jeffoatrulez: but it's an interesting problem ... really.
3:50 PM
Steve Wainstead: http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.23
Steve Wainstead: now, the cws server already has a virtual host conf file for the new site
Steve Wainstead: so it's aware that it hosts that virtual host
Steve Wainstead: it's a matter of the dns not being able to resolve it yet
Steve Wainstead: so i was just waiting until it did become available; but it turns out when the user buys a package, and *is transferring a domain*, it will never be available until the package is bought/installed.
Steve Wainstead: butthe package cannot be installed until the domain name is available.
3:55 PM
jeffoatrulez: chicken ... egg .. chicken ... egg?
4:05 PM
Steve Wainstead: exactly
Steve Wainstead: and it's the case where every other situation, the site is provisioned correctly. except this one. 
4:45 PM
5:45 PM
jeffoatrulez has gone offline.
6:15 PM
You left the chat by logging out or being disconnected.





#########################################################################
060817 Thu 17 Aug 2006 04:04:10 PM EDT

The store will have to generate the order xml for the TLC part of the
order, because the shipping charges are calculated by posting it to a
special URL for TLC. Intruiging. But this just means that I have to
put the xml somewhere (db?) where the OFS can fetch it.




#########################################################################
060818 Fri 18 Aug 2006 10:18:05 AM EDT

Going to Paul Van Dyk tonight with Jessy. Meanwhile: after a lot of
thought last night I decided that the dev team should take over all
monitoring and handling of the OFS. I kept coming back to my email
from July 20th, 2005, addressed to Chris: I wrote that Jessy and I had
decided it was in the company's best interest that the Dev Team do all
the monitoring. The reality of it is: no matter how much we browbeat
Chris, he's never going to monitor it. He will never care. Forcing him
via Peter really wouldn't work in the long run and would make him even
more resentful. So he wins this battle but will probably lose the war.

I have a false positive to fix in the OFS today: ftp timeout resulted
in "Order failed!"

OK, fixed the error reporting in upload_files.pl; also added code to
download_receipts.pl to append ls -ltr to the receiptlist and remove
the zero byte files.

Yay. I successfully loaded an order XML file and populated the
address2. Conceptually a small leap: it's exactly like DOM programming
in Mozilla or Javascript, so there's no new things to learn,
really. It will come down to a set of functions or methods operating
on the dom of the order file, adding info and stuff. In the end I can
POST to tlc to get the shipping data with $eorder->saveXML(), which
returns the whole thing.


From:   Bfritts@clubphoto.com
Subject: My Photo Album test account 
Date: June 20, 2006 4:02:55 PM EDT
To:   swain@corp.fortunecity.com, darrens@phototlc.com
Reply-To:   Bfritts@clubphoto.com

Steve,

You all have been set up as a test affiliate

Company Name: MyPhotoAlbum.com
Affiliate Initials:  PA
Username: myphoto
Password: album620

Here's a link to our specifications page.  http://affiliatestest.clubphoto.com/spec/

Let me know if you have any further questions

Brian

-- 
Brian Fritts
-------------
Account Manager Club Photo A division of PhotoTLC 512 444 0958 ext. 116
512 444 6336  Fax
512 228 9268 Cell



Next step: TDD a new class to handle the TLC order xml file. Use the
PHP5 DOM extension for fun and profit.

[spork bin]$ ./post_to_shipping_calc.pl example_order.xml 
Success!  Got response: <Order AffiliateID="PA">
<OrderID>
123456</OrderID>
<Shipment Zone="7" EstimatedWeight="1.268" PackageID="123456-1">
<ShipMethod Name="USPS-Priority Mail" Cost="11.15"/>
<ShipMethod Name="FedEx-2 Day" Cost="19.86"/>
<ShipMethod Name="FedEx-Ground Home Delivery" Cost="27.59"/>
<ShipMethod Name="FedEx-Standard Overnight Next Day" Cost="28.9"/>
<ShipMethod Name="FedEx-Priority Overnight Next Day" Cost="29.36"/>
</Shipment>
</Order>
[spork bin]$ 


#########################################################################
060821 Mon 21 Aug 2006 11:33:21 AM EDT

Been chugging away at Trevor's test code this morning. I want to do
TDD for the TLC stuff, so I am tracing the history of the TDD for the
store project. I just applied all the sql changes to mpa_test. I
should probably drop the whole db and recreate it though.

'109', '4 WALLETS PRINTS ON 4 X 6 SHEET - GLOSSY'
'138', '4 WALLETS PRINTS ON 4 X 6 SHEET - MATTE'
'231', '16 X 20 PRINT - MATTE'
'233', '20 X 30 PRINT - MATTE'
'127', '12 X 18 PRINT - GLOSSY'
'139', '12 X 18 PRINT - MATTE'
'111', '11X PRINT - GLOSSY'
'140', '11X PRINT - MATTE'
'112', '4 WALLETS PRINTS ON 5 X 7 SHEET - GLOSSY'
'141', '4 WALLETS PRINTS ON 5 X 7 SHEET - MATTE'
'113', '3X PRINT - GLOSSY'
'142', '3X PRINT - MATTE'
'114', '4X PRINT - GLOSSY'
'143', '4X PRINT - MATTE '
'115', '5X PRINT - GLOSSY'
'144', '5X PRINT - MATTE'
'152', '4xD - GLOSSY'
'153', '4xD - MATTE'
'118', '8 X 10 PRINT - GLOSSY'
'146', '8 X 10 PRINT - MATTE'
'167', '8 X 12 PRINT - GLOSSY'
'168', '8 X 12 PRINT - MATTE'
'879', '4 X 8 GREETING CARD - GLOSSY'
'898', '4 X 8 GREETING CARD - MATTE'
'171', '5X PRINT - GREETING CARDS - GLOSSY'
'172', '5X PRINT - GREETING CARDS - MATTE'
'716', '4X FLIP ALBUM PRINT - GLOSSY'
'717', '5X FLIP ALBUM PRINT - GLOSSY'
'718', '12X15 PHOTOGRAPHIC PAPER CALENDAR'
'888', 'INDEX PRINT - WITH PRINT PLUS CD ORDER - GLOSSY'
'887', 'INDEX PRINT - WITH PRINT PLUS CD ORDER - MATTE'
'864', 'PLAYING CARDS'
'826', 'CD FOR PRINT WITH PRINT PLUS CD'

After some parsing and cleanup here's the DPI codes.


#########################################################################
060822 Tue 22 Aug 2006 11:15:32 AM EDT

More running battles with Ferry. Almost got the mug showing in the
cart; thank the Maker for this LOG.txt because my notes have just
shown me why it's not showing in the cart.

I think I'll create two tables, one each for DPI and TLC, which is
where the product info will be as they view it.

Goodo! There's an osc_manufacturers table. This simplifies my work a
little. I will use one table for products; keyed on products_id and
manufacturers_id.

My long battle today: getting all the product codes, descriptions,
categories aligned. There was a mismatch between dev and prod: on dev
we were using matte 4x8 cards and there was no category assigned to
5x7 cards. Finally got it all sorted out.

Bill says 16X and 20X prints are shipped separate. Good to know. Only
come in matte.

Whooo boy. All TLC and DPI products are in the DB, and I checked in
all my little SQL files. Dev and staging should be good to go. I only
need to set the constant_name and the products_price where
appropriate.




#########################################################################
060823 Wed 23 Aug 2006 04:48:24 PM EDT

Had to report two child porn incidences today. Manager's meeting in
the morning. Then I worked all day on adding gifts to the store. I
have mugs/mouse pads working now, but I still need to add shipping
cost. I need to aggregate all the gift products to build an XML block
that gets sent to the shipping calculator.


Never realized until today that 'categories' are critical to shipping
calculations. Good thing I separated all TLC stuff into category 20.

Example path to a gift's image file:

http://images.myphotodevel.com/s/sw/swa/swai/swain/swain/gifts/4557492373a958d8a5eadbf5e4fb12c8.jpg




#########################################################################
060824 Thu 24 Aug 2006 12:31:01 PM EDT

Chris could not build a satisfactory environment on staging for
Primary, so I suggested we just go with spork and I did most of the
work of setting things up for them. Emailed them and that's done. This
should be much better anyway.

Been looking at why my tax on spork, for a French address, was "Sales"
and 7%. Wound up finally importing all Jhan's changes from
production to staging and dev.

Funny, two or three times now I've thought of hardcoding the order XML
for TLC in the store code, just to make things really fast. But what I
lose is escaping of the data. Foreign chars will no doubt cause
trouble if I don't use the DOM library.




#########################################################################
060829 Tue 29 Aug 2006 01:29:56 PM EDT

-- get all the product ids for gifts
SELECT 
   p.products_id 
FROM o
   sc_products p,
   osc_products_to_categories c 
WHERE p.products_id=c.products_id
AND categories_id=20




#########################################################################
060830 Wed 30 Aug 2006 10:44:09 AM EDT

By the way, was off Monday, camping in the Dacks.

Yesterday I got importing, copying to shipping dir, and half of
creating the XML done for OFS. Good meeting this morning: I made three
columns, one each Gallery, Store and OFS, and where what features were
at in terms of commpletion. Also gave a report on Veracity's run and
the number of errors generated.

Yay. Got all the OFS work basically done, sans notification. That
shouldn't be too hard to do. I had to write a special PHP file to
return the order image to TLC, since their CGI died on the ampersand
in the URL attribute. Shame shame. I exploited PHP's ability to parse
some basic Perl to read the config.pl file for the OFS to get the ftp
directory.




#########################################################################
060831 Thu 31 Aug 2006 04:06:36 PM EDT

Debugged staging: gifts would not post into the store because Jacob
was using POST and the store expected GET. Changed the store to use
$_REQUEST so we don't have to think about it anymore. Pushed a test
mug through and worked fine. Been working on status
update/notification; I created a PHP file to receive the status and
append it to a log. remove_completed_orders.pl is going to deal with
it.

Found a lot of orders we sent on 8/16 that we got no notice for, put
Fmarte on the case.

Found a bug I'll have to fix later: two copies of a method in
DBInterface.pm to update the ofs_orders_parts_status table. One takes
two args, the other three: the timestamp. Not sure how to handle this
but for the moment it's no biggie. Now the table is updated correctly
all throughout; I have to resolve notification for TLC stuff or users
will never see an "order complete" email.


#########################################################################
060901 Fri 01 Sep 2006 02:34:44 PM EDT

Spent the morning and part of the afternoon cranking out the script
for Chris: move attic people to some other mount. Or move criminals to
the penal colony, for fun's sake. This bit was interesting:

        if ( ! -e $userdir ) {
            warn "WARNING: no such user directory $userdir\n";
            next;
        } elsif ( (stat($userdir))[4] != $<) {
            warn "$userdir: not owner!\n";
            next;
        } else {
            $sites{$hash->{'username'}} = $userdir;
        }

here, (stat($userdir))[4] != $< says "if not equal to current UID."




#########################################################################
060905 Tue 05 Sep 2006 09:45:57 AM EDT

Didn't do any work over the weekend, save for checking my email and
fixing one problem where Fernando requested another XML file and
didn't move it out of the FTP directory. The error showed up in the
morning email.

Didn't report 12dream to the NCMEC because there was only nude camp
photos and swimsuit photos. Curse that fucker for making me look
through about 500 pictures of the crap.




#########################################################################
060906 Wed 06 Sep 2006 03:07:42 PM EDT

Can't remember what I was working on, so now I'll note here things
done in the last 24 hours or so.

Yesterday another outage as the old fast storage failed; cause was an
old Cisco router or switch.

Meanwhile, spent time whacking at a problem with internat'l shipping
again and finally found that TLC was returning nothing for the XML I
posted. The cause looks like I had too many items; Brian is typically
weak about getting back to me on that stuff so we'll see. For the
moment it's working. I found I had hardcoded USPS First Class into the
OFS (oops!) so today I fixed that. I probably need to do some work on
the store for this because the spec says they kick it up to Priority
Mail for anything over 13 oz. (Oh that's what I should work on).

Also yesterday looked at a child porn thing Tim sent me last week but
it was just the usual crap: nudist colony photos. Nothing against
Federal code. Clive from the Kent police contacted me on some FC site
and Tim looked it up; nothing there really, site hadn't been updated
since 2000.

We are damned close to the finish line for gift products. I have my
coffee cup with the Tracy + shot glass photo. Still waiting on a 14X
photo from DPI of the same.

Spoke with Dave, a techie who does stuff for the magnet people Peter
knows. Discussed order fulfillment possibilities.


Still need to finish off the remove_completed_orders thing.




#########################################################################
060907 Thu 07 Sep 2006 10:16:36 AM EDT

When I was waking up this morning, for some reason I was thinking of
the path through the application and realized that the ShipMethod is
not getting passed through. Also Hanley posted a bug for me: the gifts
do not show in the order status.

Fixed. Updated the list above for things to do when adding
products. account_history_info.php also needs a block of html added.

So: spent time debugging a Hanley bug this morning. Turned out to be a
stray newline was preventing the redirect header from being sent.

Spent the rest of the time solving the problem with shipping. (Yet
another shipping problem; just when I think I'm done there's another.)
In a nutshell I changed the store to write TLC's calculator's return
value to osc_session_info.shipping_method. Previously it was just
being set to 'flat_rate'. In the OFS, DPI's shipping method is
determined by testing the ship-to country. The column was not being
used but there were comments from Trevor to the effect that he was
going to use it at some point; and along with promotional offerings
(i.e. coupons) they constitute a lot of work to be done.

Dunno if TLC handles file formats besides JPG; emailed Brian but have
not heard back. We will def. send them GIFs and PNGs at the moment.

Also had a powwow with Hanley, Fmarte and Jacob about keeping expired
clubbers around for a year after expiration; suggested we create a
status code; Tim not convinced; time marches on. Hanley stressed,
Peter doesn't want to commit to a business rule here.





#########################################################################
060908 Fri 08 Sep 2006 10:11:43 AM EDT

In very early; rolled Gallery on staging back to the production
release, found I had to add two methods to the Product class for
backwards compatibility, and for some reason select-photo.php on
production is a version that doesn't work... it tries to call
gifts/cards/gc_add_message.php instead of
gifts/gc_add_message.php. Hrmm.




#########################################################################
060911 Mon 11 Sep 2006 09:46:50 AM EDT

Came in yesterday for about four hours. Opened all the windows and
papers blew all over; but the weather was so lovely out and it smelled
funny in the office. Jessy was still picking up when I came in this
morning.

I made good progress and then backtracked a little on my design for
capturing order status from TLC. I decided to have the PHP script post
to the database, using the DOM API, instead of crafting my own parser
in the remove_completed_orders.pl file. By the time I left I had that
all sorted out and I only needed to figure out how to modify
remove_completed_orders.pl; I did that at home last night and made
some notes. Today we have three blockers:

1) Cannot POST to TLC from mdb-1 or 2;
2) Cannot enter the capture URL in TLC's interface;
3) Little grey images not showing in the basket.

2006-06-21 11:13  swain

	* checkout_process.php, checkout_success.php,
	includes/custom/inc_order_functions.php,
	includes/functions/password_funcs.php: Added
	ignore_user_abort(true) to checkout_process.php, and a test in the
	offer functions to see if they already paid, and report that to the
	error log if true.

This is my best guess as to when I rolled out a fix for multiple
charges. I need a recent one as we only have one month's logs for the
store, currently.


#########################################################################
060912 Tue 12 Sep 2006 03:36:11 PM EDT

Pretty smooth rollout. Blew up at Chris again; he was being a pest
about shipping charges and page layout. Wants to go back to tagged
releases of Gallery. Ain't gonna happen. I updated the sales report
and rolled that out.



#########################################################################
060913 Wed 13 Sep 2006 03:11:01 PM EDT

Had a small scare this morning when an order came through as "ERROR:
order has no products." It turned out Fernando emailed the link to put
the club in the store to a customer, but a linewrap cut off the domain
name. I put in a test in the club class to make sure it got a
subdomain or else die.

Four orders, nine pieces yesterday; three coffee mugs in two orders
today.




#########################################################################
060914 Thu 14 Sep 2006 11:02:42 AM EDT

Bugs in the daily sales report, per Peter's email; one was a Fernando
bug, a tiny one (attic key count was wrong), and the other was pretty
off: photo gifts underreported by about $100. Lilia asked again about
VAT, said:

1. if ships to EU, charge VAT.
2. if no product to ship, and billing is EU charge VAT.

Added categories after noticing Matt and Jessy were planning a one day
only gifts coupon ($5). Fortunately this works. Dunno why products and
descriptions don't work in the admin interface.

Traded emails about a cron job to clean out 'gifts'. Fortunately Jacob
pointed out some errors and I wrote a couple of sql queries to deal
with them.

Damn. I know I figured out what 'S' and 'F' are before. (Which are
values for osc_offers.type).


EU:

('AT', 'BE', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU',
'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'SK', 'SI',
'ES', 'SE', 'GB')

also:

AT
BE
CY
CZ
DK
EE
FI
FR
DE
GR
HU
IE
IT
LV
LT
LU
MT
NL
PL
PT
SK
SI
ES
SE
GB

also:

Austria         AT      Greece          GR      Poland          PL
Belgium         BE      Hungary         HU      Portugal        PT
Cyprus*         CY      Irish Republic  IE      Slovakia        SK
Czech Republic  CZ      Italy           IT      Slovenia        SI
Denmark         DK      Latvia          LV      Spain           ES
Estonia         EE      Lithuania       LT      Sweden          SE
Finland         FI      Luxembourg      LU      United Kingdom  GB
France          FR      Malta           MT              
Germany         DE      Netherlands     NL




#########################################################################
060915 Fri 15 Sep 2006 05:47:12 PM EDT

The store contains 45 redundant queries to the DB. Figured this out
by:

function exit_notice() { 
    Log::write( $_SERVER['PHP_SELF'] . ": I'm finished! ==================================="); 
    $total = 0;
    foreach ($GLOBALS['query_cache'] as $query => $count) {
        $total += $count;
        if ($count > 1) {
            Log::write("$count: $query");
        }
    }
    Log::write("Total queries executed: $total");
}
register_shutdown_function( 'exit_notice' );


And:

$GLOBALS['query_cache'][$query]++;

everywhere in db.class.php.

Now, I tinkered with adding caching the results but there are
def. cases where an UPDATE is done and a subsequent SELECT expects new
results; so the two queries need to be paired and the UPDATE needs to
expire the cache.

Oh, the number 45 comes just from clicking "update" in the shopping
cart. You get various results from other pages.


#########################################################################
060919 Tue 19 Sep 2006 10:03:44 PM EDT

By the way, I walked in yesterday on my first day of vacation and
there was a disaster in progress. What it came down to was the XML
spec I coded against on TLC's web site, which they provided to me, was
incorrect and the orders were coming out wrong. I spent about 4.5
hours testing and reworking the OFS; fortunately the store did not
need changing because their shipping cost calculator didn't care how
the XML was formatted. Still, when I come back I should clean that up
as well. There are two order template files now in the mpa-signup
project where there should only be one.




#########################################################################
060926 Tue 26 Sep 2006 01:43:50 PM EDT

Back. Rolled out fix for TLC, where we now pass the product
description in the order XML so their people don't have to look up the
product code.

Wrote and tested a fix for the FTP timeout problem. Rolled out. Been
monitoring the OFS.

At some point I must have fleshed out all products and categories; it
would appear they all have one. Though I have not proved this.

Nope, did not. Did that, committed 132.sql and ran it against staging.




#########################################################################
060927 Wed 27 Sep 2006 12:12:39 PM EDT

Been formatting code and taking notes on the coupon/offer
stuff. The picture is becoming clearer.

update: All the functions now have flowerboxes; a few are called from
external files (like offer_trackOfferUse()), but most are called
internally from the first function, offer_processCustomerInput(). From
there all else flows. Now to figure out how the calculation is done
and if I can apply a percentage instead of a dollar amount.

So: I think that it comes down to the fact that every coupon results
in a call to offer_applyDollarAmount($). Here a branch is needed to
call a new function, theoretically
offer_applyPercentageDiscount(%). Something like that.


#########################################################################
060929 Fri 29 Sep 2006 12:03:07 PM EDT

All day long yesterday I worked on the "percent off" coupon code
stuff. I first spent time optimizing a query in the existing
offer_applyDollarAmount() to reduce the number of queries (more on
that in a bit), then just made a wholesale copy of the function and
rewired it to apply a percentage discount to appropriate products.

Today I was temporarily set back by the fact that I hadn't rolled the
code out to spork, and I was getting $10 off instead of 10% off when I
went through store.myphotodevel.com. Doh. I did several tests and
rolled to staging and tested there; all looks good so far. So at this
point I have a pretty good handle on the whole coupon thing.

On the train this morning I was thinking about the problem: a coupon
or offer has to first be validated (it's a valid code, not expired,
etc) and then applied to the order (where it might again fail, due to
lack of products).

The biggest culprit for performance is when the customer has maybe 30
or so photos in the cart and they mass change quantity and
update. This will result in about 1,000+ queries to the database. The
fundamental problem is how the store deletes every item from the cart,
then re-inserts it if the 'delete' checkbox was not checked. I suspect
the coupon thing happens twice due to redirects, so there is another
major problem. The redirect should probably include a flag or
something saying "don't recalculate everything."


#########################################################################
061002 Mon 02 Oct 2006 11:12:18 AM EDT

Friday I was working on consolidation of access to the session
table. I just found there were four paypal.php files, figured out
which one is actually used, and removed the other three. Doubtless
this will lead to a failure elsewhere, probably the admin
interface. Also removed ipn.php, and commented out several methods in
the paypal class that do not appear to be used. Now, the PayPal class
is instantiated at least twice judging from the logs, so it needs to
become a Singleton class, or tossed into a Registry.

Booya. Got a lot done on that front: all access to the session table,
except where joins with the cart occur, go through the Session class
now. I had one bug with coupons versus offers, which was a dumb
mistake on my part; fixed that, and then moved all cache deleting to a
single method and am using the cached session results for other
accessors. Also I should rename the methods from 'updateSomething' to
'setSomething' for consistency's sake. I plan on using a single
instance of the Session class soon anyhow. I noticed the Cart class
might need to be PHP4 compatible, which is a drag.


#########################################################################
061003 Tue 03 Oct 2006 01:15:26 PM EDT

Finally moved all session access to the Session class. The file
inc_session_functions.php is only used by Gallery/AJAX at the moment;
I can probably fix that in a jiff.

Done. Optimized the remaining queries too; so much for access to the
session.

In the Cart class, I changed a loop into a subselect in
Cart::removeAll(). It was just dumb programming: SELECT all ids, then
loop over all of them and DELETE the rows matching in the basket
attribs table. This eliminates one query per photo in the cart: I had
43 photos and 43 queries were eliminated. The crushers though are the
INSERTs into the basket attribs table, which clocks in at five per
photo.

In ez_sql I added this:

        if ( ! is_array($GLOBALS['secondary_query_cache']) ) $GLOBALS['secondary_query_cache'] = array();
        $query_substr = preg_replace('/\s{2,}/', ' ', substr($query, 0, 100));
        $GLOBALS['secondary_query_cache'][$query_substr]++;

Which nets:

6: SELECT si.*, c.customers_firstname, c.customers_lastname, c.custome
46: INSERT INTO osc_customers_basket (customers_id, 
523: INSERT INTO osc_customers_basket_attributes (`customers_baske
10: -- offer_applyClubDiscount() UPDATE osc_customers_basket 
2: -- offer_applyClubDiscount() SELECT o.*, od.* 
2: -- Get the contents of the cart for class 'Gift' in cart.class.php::getContents SELECT
47: -- get all key/values from the basket attribs to build a Product class 
3: -- Cart::subtotal() SELECT sum(c.customers_basket_quantity * c.price_set) 
3: SELECT products_id FROM prem_packages_history 
2: -- Cart::countContents(''): SELECT count(*) FROM osc_c
Total queries executed: 674
Redundant queries:      10
Redundancy:             624

It takes almost 4 seconds for the page to render just from my local
disk.

For every photo there's 12 rows in the
osc_customers_basket_attributes. Four of them should just be computed
at runtime, which would shave another 4 INSERTs per update:

fs_path     | /mnt/bob-1/vol01/s/sw/swa/swai/swain/swain/albums/album15/P8140044.jpg
thumb       | http://images.myphotodevel.com/s/sw/swa/swai/swain/swain/albums/album15/P8140044.thumb.jpg
sized_image | http://images.myphotodevel.com/s/sw/swa/swai/swain/swain/albums/album15/P8140044.sized.jpg
full_image  | http://rawimages.myphotodevel.com/s/sw/swa/swai/swain/swain/albums/album15/P8140044.jpg

For 43 photos that would be another 172 queries saved, which is fine;
but ideally we shouldn't be deleting everything and reinserting it at
all. That would save about 600 queries for an update.

I actually have 46 items in the cart (attic key, mug, club membership)
and that yeilds 523 rows total:

mysql> select count(*) from osc_session_info s, osc_customers_basket cb,  osc_customers_basket_attributes cba where s.sess_key='52872fcac5aa34e1ff6a506c8a0714d9' and s.session_info_id=cb.session_info_id and cb.customers_basket_id=cba.customers_basket_id;
+----------+
| count(*) |
+----------+
|      523 |
+----------+
1 row in set (0.00 sec)




#########################################################################
061004 Wed 04 Oct 2006 02:40:31 PM EDT

Spent three hours, from 9:30, in a meeting with the magnet guys. Cool
product.

So, I had a bug where 4xD was not getting the club discount. It took
me maybe an hour to whittle down the problem: databases out of
sync. There was no offer on development for that, so I backported the
prem_packages_features table from production and that solved
that... but then a photo from site 'piratelove' was still getting the
discount on everything, and that was due to the bug where package_type
was set to zero instead of the ID from prem_packages_history; that bug
I fixed the other day and was caused when I prefaced an INSERT with a
SQL comment: no ID is returned by mysql_insert_id().

Subclassed Product and made FoldingCard. We'll see how this fares.


#########################################################################
061005 Thu 05 Oct 2006 11:14:06 AM EDT

----------------text pasted by Wainstead \ to Emrys' Tavern----------------
typolesbo: I'm drafting an email for
typolesbo: peter
typolesbo: to send to mag ware
typolesbo: # System to recieve the order has been placed xml. In phase 1 that could be a simple 
email notification to your staff
# Page contining a script that allows MPA to pull the fact that order has been shipped
typolesbo: is that ccuratge
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
Wainstead \ . o O ( it's totally ccuratge )
heller [to Wainstead \]: I don't think so. . .
tiResias . o O ( duuude, that is soo ccuratge! )
heller says, "it seems more aoiefjie to me. "


Set Jacob on subclassing OrderPart for folding cards, and Fernando on
testing flock with the swing servers. Chris seems to be thinking of
actually setting up squid proxies; miracle of miracles.


So again, with 409 prints in the cart I click "update." I have a
second query counter that only uses the first 100 chars of the query,
which is close enough to see where the real action is...

6: SELECT si.*, c.customers_firstname, c.customers_lastname, c.custome
409: INSERT INTO osc_customers_basket (customers_id, 
4908: INSERT INTO osc_customers_basket_attributes (`customers_baske
12: -- offer_applyClubDiscount() UPDATE osc_customers_basket 
2: -- Get the contents of the cart for class 'Gift' in cart.class.php::getContents SELECT
3: -- Cart::subtotal() SELECT sum(c.customers_basket_quantity * c.price_set) 
409: -- get all key/values from the basket attribs to build a Product class 
2: SELECT products_id FROM prem_packages_history 
2: -- Cart::countContents(''): SELECT count(*) FROM osc_c
Total queries executed: 5784
Redundant queries:      9
Redundancy:             5735

The DELETE statements are gone now, since I optimized that; these
INSERTs are the killer. The page took 55 seconds to render.

More numbers: 408 photos. 33.19 seconds generation time. 1:19 render
time. LOOPCOUNT: 1632. For every photo in the cart, the entire array
of cart_delete[] is iterated over every time.

Well. Last couple of hours have been very productive. I figured out
how to add a new field to the array in the thumbNail class, 'cbid',
which defaults to zero; and set the customers_basket_id on the correct
one. I then fixed the factory method in Cart to set the
customers_basket_id on the Product objects it creates, and use that
(via the thumbNail) in shopping_cart.php in hidden fields that
populate a Javascript array. These numbers show up on the back end:

swain: doing 115{txt_4}P1010005{txt_9}.jpg{txt_6}1600{txt_7}1200{sbd}swain{mpa_id}4281{alb}bigO{so}2...
swain: cbid is: 0...
swain: quantity is: 0...
swain: doing 118{txt_4}P1010005{txt_9}.jpg{txt_6}1600{txt_7}1200{sbd}swain{mpa_id}4281{alb}bigO{so}2...
swain: cbid is: 4225...
swain: quantity is: 1...

So all was golden. I checked in my files, and next I have to solve the
logic of insert/delete/update/do nothing. The next single step will be
handling delete: where Trevor created an array, cart_delete[], in
Javascript and super inefficiently iterates over the array for every
single product object (doing a sloppy string match with strstr()), I
plan on wiring the JS in the page so that when they check "delete" the
quantities are set to zero; if they change a quantity the checkbox is
unchecked. This way I do away with the cart_delete[] array.



$query = "SELECT cb.customers_basket_id, 
                 cb.products_id,
                 unique_string,
                 full_string, 
                 customers_basket_quantity,
                 price_set,
                 price_set_comment,
                 running_amount,
                 subdomain,
                 sort_order,
                 customers_basket_attributes_id,
                 `key`,
                 value
          FROM osc_customers_basket cb, 
               osc_customers_basket_attributes cba 
          WHERE cb.session_info_id=" . Cart::getId() . "
          AND   cb.customers_basket_id=cba.customers_basket_id
          ORDER BY cb.customers_basket_id";

  
    $basket = DB::getResults($query);
    /*
    Log::write("is1: $basket");
    Log::write("is2: $basket[0]");
    Log::write("is3: " . $basket[0]['unique_string']);
    Log::write("is4: " . serialize($basket[0]));
    //exit(0);
    */
    $basket_count = count($basket);
    Log::write("rows in basket: $basket_count");
//     for ( $x = 0; $x < $basket_count; $x++ ) {
//         foreach ($basket[$x] as $key => $val) {
//             Log::write("$x: $key => $val");
//         }
//     }



#########################################################################
061009 Mon 09 Oct 2006 09:22:20 AM EDT

I was thinking on the train this morning that the old gift cards might
cause a problem with my changes to updateCart(). But no, that's not an
issue because when they update a card *in* the cart they can only
change the quantity. If they go back and edit the card, Trevor had the
function _addCard() delete the old one and then reinsert it.

Total queries executed: 454
Redundant queries:      4
Redundancy:             5
6: SELECT si.*, c.customers_firstname, c.customers_lastname, c.custome
6: -- offer_applyClubDiscount() UPDATE osc_customers_basket 
2: -- Get the contents of the cart for class 'Gift' in cart.class.php::getContents SELECT

3: -- Cart::subtotal() SELECT sum(c.customers_basket_quantity * c.price_set) 
408: -- get all key/values from the basket attribs to build a Product class 
2: -- Cart::countContents(''): SELECT count(*) FROM osc_c
Total queries executed: 455
Redundant queries:      6
Redundancy: 415
Total queries executed: 454

Page generation for 408 photos: 2.75 seconds.

That turned out to be really easy in the end: I only had to write one
little method to update quantities. I think refactoring is like that:
you'll do a lot of work to refactor the code, and then the actual
change you want to make is simple.

So, bummer of a bug: if you change the size of a photo from 4xD to
8x10, it appears somewhere else in the cart. Why this happens now is:
AJAX adds photos to the cart and they have no sort_order. They are all
zero. When the user changes quantities on the shopping_cart.php page,
in the old way of doing it, everything is deleted and then reinserted
using $i (the counter) for sort_order. This preserved the order of the
photos but at a hell of a cost.

I think the way out of this is: 

select @nextid := max(hippy)+1 from foo;
insert into foo values(@nextid);




#########################################################################
061010 Tue 10 Oct 2006 11:59:25 AM EDT

Noticed this while stress testing the store. What's the holdup?

  2006-10-10  11:58:11 :: cacheinfo: Session cache hit!
  2006-10-10  11:58:40 :: /shopping_cart.php: I'm finished!
  



#########################################################################
061011 Wed 11 Oct 2006 02:40:09 PM EDT

So what that was, was:

$page = ob_get_contents();
Log::write("Got ob contents. Size of page: " . strlen($page));
ob_end_clean();
Log::write("Cleaned ob.");

This took 20 to 30 seconds before the "Cleaned ob" showed in the
log. I did two things: got rid of $page in favor of ob_end_flush(),
and added ob_gzhandler to ob_start:


407: -- get all key/values from the basket attribs to build a Product class 
2: -- Cart::countContents(''): SELECT count(*) FROM osc_c
Total queries executed: 452
Redundant queries:      6
Redundancy:             413
Page generation time: 1160591974.7814 - 1160591971.4712 ==  3.3101689815521


So my optimizations to shopping_cart.php were this:

1) Don't delete and insert every item every time. Using a simple truth
   table I determine what needs doing. This shaved thousands of
   queries off the run of the page.
2) Don't embed every single javascript statement in its own tagset
   (<script>). Instead accumulate them and put them in one
   tagset. This shaved 24K off the size of the page source. Hanley
   reduced it another 12K by using divs, but that slows rendering down.
3) Don't make a copy of the output buffer; gzip it and send it
   directly. This saved 20-30 seconds.

In the end, the page that took over a minute to execute and render
will now do so in three seconds or less.


#########################################################################
061013 Fri 13 Oct 2006 09:37:00 AM EDT

Yesterday: I took over work on the OFS from Jacob. I had to write a
method to add the XML to the order XML for TLC. I found that the store
was not calculating shipping for the folding cards, due to the
hardcoding of class names in the factory; I never really noticed that
before as "programming to a concrete implementation." So that will
have to be rethought. Also this smattering of constant names
throughout is a pain, in particular when looking up what category a
product is in (this is especially bad in that a product might belong
to more than one category now).

So I fixed the store for now, and folding cards are back in category
20. I then got things working for the OFS and the XML looks good.

Brian told us only one type of folding card is available now so I
removed the single card from the DB. This broke Jacob's stuff, so I
cannot do a test order on staging.

Ops was pulling equipment last night: Chris called to tell me that the
data xfer was not done, about 180GB left, and we discussed a selective
service outage until Tuesday for those folks affected.

Overnight Bastion suffered a hardware failure so we're cut off from
production. Chris talked something about a backdoor IP address from
the mup servers to mdb-1; but I dunno how I'm going to get to the mup
servers without bastion, for the moment. I suppose I could go through
Panix.

I have quite a list of nasty bugs to fix.

Jus a thought: store queries can be thought of as belonging to two
types: the low level ones that directly manipulate the tables and read
that back; and the "fluff" ones that just read the data for display
purposes. All the optimization work I did involved the low level ones,
and for that matter they changed very little. The bugs all stem from
changing around categories. I kind of lied to Jessy about how undoing
categorization would take away percent-off coupons.





#########################################################################
061016 Mon 16 Oct 2006 10:45:40 AM EDT

Saturday, I fixed some bugs in the page display (mostly, subtotals
coming out wrong.) I may have only fixed one bug, really; I don't
recall anymore. I now have the "magic disappearing coupon" to deal
with. I think I just need to track session stuff for that.

Yesterday (Sunday) I worked from home a lot helping Chris. In the end
the mpa_photos and mpa_albumitems had to be left behind; that cut the
size of the db down from 10GB compressed to 1.8 GB uncompressed, I
think the numbers were. We lost a lot of time due to that... too bad
Chris didn't sit me down and go over it a week ago.

We'll need a Veracity run soon.

find [a-z0-9]  -maxdepth 5 -type d -user root | xargs chown www:www

This is the command I'm running to fix ownership. Chris thinks he ran
mkdir -p as root to fill out missing parts of the directory structure.

Fixed the bug with the magic disappearing offer. This bug currently
exists on production. When _updateCart() is called, it clears the
offer by setting offer=''. This does not remove the offer code,
though; only the string describing the offer. Perhaps this is an old
call that wasn't needed anymore. I commented it out and things work
now. I should test with a coupon next.


#########################################################################
061017 Tue 17 Oct 2006 11:26:46 AM EDT

Endless battles trying to get permissions fixed. What a catastrophe. I
had to go through every volume and run find/chown by hand to fix all
the directories "underneath" the symlinks.

Old store codebase with new schema changes: the only bug I see is the
doubling of quantities. I suppose for the short time it takes to roll
this out, we can put the store into maint mode for 15 minutes or so.

Ideally, I should add a flag in the conf file that, once set, puts
both Gallery and the Store in maintenence mode, as we did by hand
during the move. All Ajax pages need to be inaccessible during store
maintenance.




#########################################################################
061018 Wed 18 Oct 2006 09:39:55 AM EDT

I'm wondering: do our code bases block us from innovating? Are we
continually playing catchup? Can radical refactoring of the code base
bring us quickly to the forefront of photo sites?

Maybe thinking about the things that are hardest for us to do is the
place to start. It's hard to add new features to the store. We've been
moving fast on the Gallery front, mostly because we're building out
the store. (In this context, the "store" is products.php. Previously
I've talked about "the store" when I meant "OS Commerce," which is
really the "shopping cart."


#########################################################################
061019 Thu 19 Oct 2006 09:05:24 AM EDT

M905.

Meanwhile, put all the pieces in place and rolled out OFS, OSC and the
database schema updates. I have been monitoring it today. We only need
Ops to upgrade ImageMagick on production to support text wrapping and
we can launch Gallery.

http://slim.deasil.com/~swain/screencaps/twinkiemenner.png

Worked a bit on the Javascript problem but my lunch made me
sleepy... commiserated with Fernando on the travails of the data
center move; which led me to rereading portions of this log from two
years ago when we moved the office and then the data center. It's odd
I never recorded Gautam's last date.




#########################################################################
061020 Fri 20 Oct 2006 10:41:44 AM EDT

Looking back through my INBOX, I see Chris rolled out photo gifts on
September 12th.

Went through the ChangeLog for Gallery, starting from September
12th. 99% of the changes are in either gifts/ or skins/.

Waiting for Chris to roll out the ImageMagick libs.

It seems to me there can be little doubt that doing a join on
osc_customers_basket and osc_customers_basket_attributes would be way
faster than the looping process now used by the shopping cart. Even
more annoying is how it has to query for every class type: Gift,
FoldingCard, photoPrint, etc.

[snip]
   As you configure CC Mode, you might want to set the variable
`c-echo-syntactic-information-p' to non-`nil' so that the syntactic
component list and calculated offset will always be echoed in the
minibuffer when you hit `TAB'.
[/snip]

Spent some time reading up on cc mode. Any javascript-mode I've found
(one, really) is outdated.





#########################################################################
061023 Mon 23 Oct 2006 11:46:30 AM EDT

Finally fixed the daily sales report. That's been bugging me
forever. It really came down to adding sum() on one column.

I keep coming back to the idea of moving Gallery to SQLite. Why? Well,
there are all these dat files floating around; in fact last night I
emailed a Gallery developer asking what the serial.N.dat files were
for. I'm 99% certain they don't do anything. Removing them would not
be any great performance gain, since they only ever get written out
when the album is created or saved.

When I first proposed the idea to Chris a week or so ago, I prefaced
it by telling him he would hate the idea from the get-go. He did. Why?
He wants to put all the album and photo data in the database. I think
this is needless, for one, and it puts an undo strain on us in that we
have to build a cluster to support it. He dismissed this by saying the
DB server is not under any serious load right now. Bleh. Why create a
bottleneck for functionality you don't need?

But for Gallery... actually part of my thinking is that an object
database is better (which is what it has now, although entirely flat
file in separate files. It's all pickled objects). I meant to search
for an XML/XPath equivalent of SQLite.

I worked out a more efficient way to run Veracity, based on ranges of
usernames from the first three chars. It was a little algorithm using
a stack and was kind of fun to write. I've integrated it into the
scripts and tested it on spork; gonna run a quick test on staging now.




#########################################################################
061024 Tue 24 Oct 2006 02:24:06 PM EDT

Killed off Veracity this morning by adding exit(0); at the top of
veracity.php. As run-veracity.pl's children finished the next
invocations exited, so that was a clean (even "graceful") way to shut
it down.

Going over the error output: Lots of "cannot rename()" and "cannot
mkdir()" errors, and Nathan confirms there are filesystem problems. In
particular the performance is very poor: I've seen 'ls' take three
seconds to return.

There are a lot of errors involving mismatched albums. I think the
bulk of these are due to delete_album.php leaving the bob dir there,
photos and all; so I am going to write new code to handle this
finally. In fact I've worked out all the rules for that.

I went through several sites by hand and fixed the mismatched albums,
and after that there was just normal dark matter.

Also the penal colony thing led to some errors: the first several
users placed in the penal colony would up in /home/www on mdb-2. Oops! 

Dothill. RAID 5. Chunked into LUNs. 1TB LUNs. 8U. 5TB. 4 units. 20TB
total (more like 18). It was not specified that there is an optimal
way to create the LUNs; OnStore (also makes Dothill) recommends 4 LUNs
per volume. Due to journaling there's a long wait for large LUNs. They
will have to restructure the volumes.




#########################################################################
061025 Wed 25 Oct 2006 02:24:12 PM EDT

In late today: chimney sweep.

Made a new CVS project: veracity. Added the three primary scripts plus
a HISTORY file.

Adding this to DBInterface.pm:

$dbh->{mysql_auto_reconnect} = 1; # reconnect to the database if it went away

Our orders appear to be taking longer and longer to upload; the list
of errors we get by email every morning is filled with dropped db
connections. Testing now.

Added new functionality to Veracity: read usernames from a file. This
is to handle the job for Tim: building a sample file of user's album
titles and descriptions.

Rolled out small store bugfix.


#########################################################################
061026 Thu 26 Oct 2006 09:52:54 AM EDT

The data xfer for "fast" storage is only at 15% right now; so it might
take a couple of days. There is some deal where the fast storage was
on 15000rpm drives, and is now on 

We still don't know how many sites lost their data. We know 500 for
sure. Fernando's script that scans for them keeps crapping out; the
likely culprit is the I/O wait for the above mentioned fubar'd
storage.

I need to figure out a way to make interchangable spawn() and
make_iterator() subroutines in run-veracity.pl. Well, something along
the lines of a dispatch table would probably do it.

Whoever wrote the CGI for Jessy, that is supposed to edit the MOTD,
should be shot. It's a horrible piece of shit with no hope of ever
working. I don't know why this issue has gotten me so incredibly angry
for months, but it has.

Anyway I looked into our blog; partially motivated as well by my email
exchange yesterday with one of our users. I've wanted to make the blog
entries the MOTD and even better still we can categorize them ("System
Status") so only those wind up on the MOTD and we can have plenty of
other blog posts about other things.

I upgraded serendipity to version 1.02; we had .91 installed. It's
just an untar over the old version to do the job.

I worked out how to pull a particular post out of the database
(serendipity has its own database in mysql):

select se.title from serendipity_entrycat sec, serendipity_entries se
where sec.entryid=se.id and sec.categoryid=3;

where categoryid of 3 is "System Status."

---

Created new CVS project for Serendipity. Rolled out to
production. Next Jessy needs to check it out into her project dir,
we'll change the virtual host file and she can tweak the colors.

---

Well. An order to Mexico made it through with 0 dollars shipping; a
$200 order. Fortunately the fraud alert caught it. Fernando canceled
it at TLC.

I thought perhaps my "malformed" XML was the problem: I had coded it
exactly to TLC's spec. But the online spec they gave me is wrong. I
fixed the XML the OFS produces, but not what OSC produces... so... I
fixed that, but the results are the same.

On dev, I get a 1 back. Just a 1. On production I get a valid XML
string back, which contains the weight but not the shipping cost.

So my temporary solution is, if we get no shipping cost back, charge
them a thousand dollars. Should prevent them from putting the order
through. Meanwhile I'll wait on Brian to find out what the poop is.




#########################################################################
061027 Fri 27 Oct 2006 10:05:09 AM EDT

Chris has yet to tell Peter about the storage problem.

insert into db (Host, Db, User, Select_Priv) VALUES("192.168.10.%","serendipity","mpauser","Y");

I fixed just about everything there is to do for the blog: I blew away
that useless crappy CGI that Jacob wrote; I added a new method to
DBConn to pull the latest blog entry under category "System Status,"
and worked out the kinks of permission problems on spork and
production with Ferry's help (breaking replication along the way).

Traded emails with Brian today over the shipping calculator.

Just got off the phone with him: he thinks their lookup table does not
go beyond 20 lbs. He's going to add the numbers up to 30 lbs to try to
get around that issue.

--skip-opt Disable --opt. Disables --add-drop-table, --add-locks,
--create-options, --quick, --extended-insert,
--lock-tables, --set-charset, and --disable-keys.



#########################################################################
061030 Mon 30 Oct 2006 09:50:13 AM EST

Hanley back. Chris called me around 7:15am in frustration, trying to
set logins to maintenance mode. Briefed Hanley on most of what went
on.




#########################################################################
061101 Wed 01 Nov 2006 03:55:09 PM EST

So. Once again Ferry kept saying the performance problems were
"application level" and once again I proved it was not; turns out
files over 64K in size resulted in rename() taking up to a minute to
return, and it would return a false error. Likewise calling mv on the
command line gave the same result. OnStor has an engineer in a meeting
working on this. (?)


In the last day and a half I've mostly been working on veracity: I
narrowed down the issue yesterday to the rename() call by adding
timestamps to veracity. I added an optional callback function today to
explodeLP() to do something interesting with the album; in this case,
call print_r(). I think the creation of the schema and loading of the
DB won't be that bad; but having Gallery load from the db will be a
descent into spaghetti code once more.

Another thought recently: reimplement the Flickr API over Gallery. All
Flickr tools would then "just work" with MPA.




#########################################################################
061103 Fri 03 Nov 2006 01:39:57 PM EST

Thought: "click to add keyword." For any photo, start with a small
pallette of main categories. When they click one, the pallette
refreshes with new, narrower choices. The process repeats until they
click "done."

Where do the categories come from? Steal from somewhere else,
perhaps. 


#########################################################################
061106 Mon 06 Nov 2006 12:15:23 PM EST

Worked out my remaining vacation time: 7 days, which is two less than
I thought. Fortunately this log bears it all out.

I've been working out, on pen and paper, how I can abstract the
process of iterating over sites in PHP. I think I can reduce any given
script down to this:


$site_vistitor = new Gallery_Visitor();
$site_list     = new Gallery_Sitelist();

$site_list->buildList("some method"); // or use a subclass
$site_visitor->setSiteList($site_list);

$site_visitor->setAlbumItemCallback("some function the user wrote");
$site_visitor->setAlbumCallback("some other function the user wrote");
$site_visitor->setLogging("some log file");

$site_visitor->run();

Spent time on Wikipedia reading up on the Visitor pattern, double
dispatch and multi-dispatch. I got the neat idea of adding visitor()
and accept() methods. Coolio.

Also my Quartz 2D book arrived today.

Bleh. 20% off coupons have a bug. Why didn't the 30% off? Well, that
was a different set of products; basically category 20.

3113,879,171,3011,898,172 were Matt's original choices.

Ugh. It seems to work on development but not on production. I will
test it thoroughly on dev, and if it's all correct, then I will
compare the category tables.




#########################################################################
061107 Tue 07 Nov 2006 02:25:16 PM EST

You paged darky with: i think i might be putting together a sales pitch to do an internal project 
here at mpa... buying three xserves (apple), to do quartz 2d image stuff on the fly via python...

You paged darky with: so i might be looking for a good combination of python+http. anything stand 
out to you? i know there's a zillion web dev frameworks out there

You paged darky with: apple ships/supports python bindings to quartz 2d. though i won't rule out 
doing cocoa programming and getting paid for it. :o)
darky pages: ok, so i went off to wikipedia to attempt to understand how all these apple apis fit 
together.  your last page confuses me, though, since it sounds like you're saying you're not 
ruling out doing cocoa programming in lieu of python/quartz programming?  from what i've read, 
cocoa is the oo api for osx, which you can use through a number of languages including objective c 
and python.  also, it sounds like cocoa depends on quartz for drawing the ui.

darky pages: so i'm thinking your last statement is like "i might use python, or i might use 
objective c"?

You paged darky with: yeah, fairly so. quartz 2d is a library for doing 2d graphics stuff: draw, 
fill, etc.

You paged darky with: so i'm thinking, we could have a competitive advantage with this stuff. like 
most sites right now we use ... er...

You paged darky with: ImageMagick. had to think for a minute. and IM sucks at doing things like 
text wrapping

You paged darky with: i mean for an open source project it's quite amazing, and there's modules in 
php and perl and all... but quartz 2d can probably do much more. i'm still experimenting.

You paged darky with: so just to keep my options open, i imagine there might be a need to do 
python+http which would be better than having to make shell calls from apache, which is what we do 
now; and has some pretty lousy limitations

darky pages: as far as python web frameworks go, i only care about three of them.  my favorite is 
pylons (http://pylonshq.com/).  i think you've played with rails a bit?  if so, i'm told pylons is 
blatently trying to copy rails wherever it makes sense.  it's very much about letting you choose 
your own components, though it comes with some common choices for those components (two examples: 
myghty for templating, which is a lot like mason, has inline python like php; sqlobject for 
object-relational mapping, which i don't know if you'll use, and sqlalchemy is better).  you'll 
find yourself putting some other people's modules in probably (for example, maybe you'll want to 
use FormEncode (http://formencode.org/) for form validation) but in general it's a very expedient 
and easy framework to work with.  it doesn't get in your way imho.

You paged darky with: bookmarked. i'll take a look at it.

darky pages: the others worth mentioning are probably the two big ones, django (http://www.
djangoproject.com/) which has been somewhat blessed by guido, and (http://www.turbogears.org/) 
which, from what i've seen, has a lot in common with pylons.

darky pages: i've done two small projects using pylons so far and i've been pleased enough.

You paged darky with: what about cherrypy? isn't that another framework?

darky pages: hooking it up with something like apache/mod_python can be a little challenging, at 
least on linux (and that applies for python period, not just those frameworks).  pylons is built 
around wsgi, some sort of python web standard which tries to make it as easy as possible to make 
your applications modular (and succeeds to a large extent), and i think django and turbogears have 
wsgi support as well.  when you use wsgi you can do apache/mod_python, fastcgi, or all of them 
probably have their own web server built-in you can just proxy to from apache.

darky pages: my point there is that deploying these things, in practice, might be a little scary 
compared to the relatively well-known mod_php and mod_perl. :)

You paged darky with: point taken. maybe apple will come out with php bindings. or i can write 
them, since it's all C in the end :o)

darky pages: i originally started using cherrypy, but switched to pylons because pylons was much 
more about putting a web framework together in components rather than a single big framework, and 
because pylons had wsgi support.  frankly they're very similar.

From afar, darky | RhubarbTart is a light object publishing web framework built on WSGI and Paste. 
 (http://rhubarbtart.org/)

darky pages: so rhubarbtart is cherrypy rewritten to be based on wsgi and paste.  pylons was at 
one point going to be using rhubarbtart to replace what it does internally, and i remember noting 
that i really wouldn't see any change in my applications.  so i don't see any point in worrying 
about cherrypy.

You paged darky with: ok good. one less thing to worry about.

You paged darky with: what i have in mind would not be very high traffic. 95% of our traffic are 
just page views; things like uploading, customizing your albums etc. are fairly low volume

You paged darky with: so to base an online photo editing tool around quartz2d wouldn't demand a 
giant rendering farm and a custom web server written in asm

darky pages: (paste, i guess, is just a meta-framework of sorts that helps you develop and 
administer web applications.  i don't know just where it has its hooks in the system, but i'm 
pretty sure it's responsible for neat stuff like me being able to run "paster create --template=
pylons HelloWorld" and "paster serve --reload development.ini" to start a little web server with 
the development configuration of my application.  so while i don't know how it's done them, my 
impression is that it has provided some very useful services. :) )

You paged darky with: though i wouldnt' be so irresponsible as to just throw some cgi scripts out 
there

darky pages: gotcha.

darky pages: what kinds of operations do you do with imagemagick now?  i imagine resizing for 
creating thumbnails.  you mentioned text wrapping, so maybe you let people put text on their 
photos?

You paged darky with: we actually use convert, via a shell call. that's out of the box Gallery, 
and we haven't really touched it. and it hasn't been much of a performance issue.

You paged darky with: for more complex things like sandwiching photos with frames for christmas 
cards we use imagemagick

darky pages: on my system, /usr/bin/convert is part of imagemagick. :)

You paged darky with: so that involves: take user's small sized copy of the photo, sandwich it 
with a photo frame, then make another image with the text on it and mash them all together.

You paged darky with: the results are servicable, but less than stellar

darky pages: oh, are you saying you're calling directly to imagemagick from php?  rather than 
calling out to individual programs?

You paged darky with: due to some linux and/or imagemagick limititation we only havee one font. 
imagemagick used to be able to do zero text wrapping. none. so that was a huge problem.

You paged darky with: well, for displaying to the user..lemme give you a quick examplee

darky pages: and at any rate, i guess what you're saying, whether it's calling out to multiple 
programs or calling right into an imagemagick api (performance not being an issue), is that 
imagemagick basically doesn't do some of its image manipulation tasks so well.

You paged darky with: http://swain.myphotodevel.com/gifts/cards/gc_add_frame.php => http://216.com/
4tl

You paged darky with: http://swain.myphotodevel.com/gifts/cards/gc_add_frame.php

darky pages: and that's where you expect to gain an advantage from quartz, in the quality of the 
image manipulation functions.
Usage: page <person>=<message>

You paged darky with: ok, convert == imagemagick. will try to remember that :o) i didn't have a 
hand in writing that end of things.

You paged darky with:  start there, pick a frame, pick a photo, add a message. should only take 
you 30 seconds

From afar, darky picks picture of pretty girl giving a... lap dance?  then realizes that darkho's 
mom just came over. ;)

You paged darky with: heh

You paged darky with: you're going through our oversaturated t1 so it might seem unbearably slow.

darky pages: ok, done, looks ok.

darky pages: i guess the "only one font" thing isn't so good, perhaps.

You paged darky with: yeah, but just "ok". it would be nice to give you font choices, and give us 
more flexibility in placing the text

You paged darky with: to that end, i would not be above doing a flash front end for the user just 
to do the layout

You paged darky with: now this is more recent, just launched two weeks ago:
One moment, converting your URL to an AvalonURL...
AvalonURL: http://swain.myphotodevel.com/gifts/select_photo.php?product=folded_cards_20cards => 
http://216.com/4tm

darky pages: wow, a flash "editor" for the cards could be really cool.

You paged darky with: http://216.com/4tm

You paged darky with: because we place the text on a blank rectangle we got more fancy, and the 
latest imagemagick has text wrapping (finally). with the other cards, each frame means different 
text layout params. typolesbo has aged ten years trying to get all those to work right.

You paged darky with: yeah imaging a flash frontend and python/quartz 2d backend and we'd really 
be at the head of the pack in capability.

You paged darky with: currently we have no in house flash experience.

You paged darky with: well very little

You paged darky with: i meant "yeah imagine" not "yeah imaging"

darky pages: well, seeing what you're doing with imagemagick i can imagine why you'd vastly prefer 
to just talk directly to a competent 2d api.

You paged darky with: yeah. and i'd like to give the users an easy way to create album covers. i 
think a lot of them would do that if we gave them the ability. right now all they can do is choose 
one photo for the cover.

You paged darky with: thanks for your feedback. it will be a big help.

You paged darky with: and tell darkho to order some christmas cards. and send me one :o)

darky pages: i just made a couple that ended with "J2EE SUCKS HUGE DONKEY BALLS."

You paged darky with: hahahahah

You paged darky with: i accidentally ordered a batch that say "I WANT TEH HIGH" and have a booby 
shot from my rrw photos

You paged darky with: that was quite a surprise when they came in the mail

From afar, darky lol.



#########################################################################
061108 Wed 08 Nov 2006 11:12:43 AM EST

Yesterday: mostly worked on Veracity; the pot luck lunch took up more
time than it should have. I left at about... six? ten after? to go
vote.

Manager's meeting today. Went over Chris' new project roadmap, talked
about the move and such.

Can't make a free shipping or discounted shipping coupon via the admin
interface because... well really because the interface mixes one field
to multiple purposes.

Anyway, created type E, added a stub function, and I have to decide
whether I have to calculate shipping and then discount it, or just
skip calculating it. Hrmm. I suppose if we just *discount* the
shipping ($5 off shipping orders over $20 etc) then I have to
calculate it first, then apply the offer.




#########################################################################
061109 Thu 09 Nov 2006 03:06:07 PM EST

Veracity is running slower and slower. Hrmm.

I started hacking in free shipping yesterday; I think it will bolt
onto the existing offer feature. One key change I'm making is to
calculate shipping before applying discounts: currently there seems to
be no crossover (for example, calculating offers or coupons does not
seem to affect shipping in anyway; like blowing away session data, for
example). So I moved up shipping calculation. I'm going to break out
the session updating code into a function, and create a new function
for shipping stuff. Actually no: because I do shipping earlier I can
return the amount discounted.


#########################################################################
061110 Fri 10 Nov 2006 05:03:32 PM EST

Didn't get crap done today. I did figure out that the ActiveX
component keeps uploading, thinking it succeeded, even after I kill
the session. This is because the PHP script called exit() and did not
log a message. I'm having Fernando try to return a 500 to see if the
ActiveX tool will give up.


#########################################################################
061113 Mon 13 Nov 2006 10:53:29 AM EST

Read through the Amazon S3 API docs. No doubt in my mind we'll do
it. Last Friday Chris read a blog post by some guy at Smugmug on how
they are saving $500K a year in storage costs. To me the most
appealing thing is that we never have to do spreading, we never have
to buy more storage. That would be a huge savings in manpower, and
probably cost.

Well, been exploring the whole sessions thing. Nothing obvious. I
still want to move culling of old sessions (garbage collection, in PHP
terms) off to a cron job.

What it looks like: a user is uploading files, and at some point their
session goes away. I changed image_uploader3.php so that it returns a
500 if they are not logged in; that should go a long way to
alleviating the problem. I'll be a lot of these user complaints are
from people who leave the browser window open for days and then try to
upload more photos.

Can't use 302s for image_uploader3.php. Too bad. The ActiveX component
just says "Received some interruption. Contact the webmaster." Teh
suck.




#########################################################################
061115 Wed 15 Nov 2006 02:20:56 PM EST

Veracity running since yesterday; very slow. It spends .4 seconds per
insert statement to mpa_albumitems.

Yesterday I found and fixed a bug where free shipping would report
"successfully applied" even though the order did not meet the minimum
amount.

I found the magic disappearing coupon bug! Hallelujah! Some time ago I
removed the call to _calculateEverything() from updateCart() because
on shopping_cart.php it caused it to be executed twice. So when we
call shopping_cart.php and redirect to another page, we call
updateCart() but never _calculateEverything().




#########################################################################
061116 Thu 16 Nov 2006 03:47:57 PM EST

Whew. Finally took the Javascript for shopping_cart.php to the next
level. It finally does the right thing when you check/uncheck "remove
all."

The problem is: I want to treat groups of form elements as a
whole. For example, a photo has a remove checkbox and four text input
boxes. If they check "remove" we cache the values of the four text
inputs; if they uncheck "remove" we put the values back.

So for "remove all" we have to do the same thing for every "remove"
checkbox; but the rub was that there is not a one to one
correspondence from remove checkbox to "quantity" elements (one to
four for photos, one to one for everything else).

For now, I have hardwired every block to make the necessary calls, and
I add new fields to the remove checkboxes: "is_print" on the
checkboxes for photos, and "element _id" on the checkboxes for
everything else. Very messy and hard to understand.

What I would like is to draw a circle (so to speak) around one set of
form elements and put them in a new object; and that object has the
same behavior no matter what its contents (set quantities to zero,
restore quantities).

Now I have to add more logic to handle the case where:

1. user checks "empty cart" (remove all)
2. user unchecks one item in the cart

Unchecking has to set "empty cart" to unchecked and not disturb
everything else, which should be fine.

My other key issue is fixing RSS. We need a clone of Veracity that
will iterate over all recently updated sites, generate the xml file,
and way ho.





#########################################################################
061117 Fri 17 Nov 2006 09:48:27 AM EST

I've made little bits of progress with my Quartz 2D book; I'm
wondering if... oops, lost my thought. Anyway, did a bunch of
tinkering late yesterday. Read different web pages, ran the example
Python scripts Apple ships, looked at PHP extension writing... read
about Bezier curves, very neat. One Python script I ran reshaped a
photograph of me. I am updating my Gallery copy here on my Mac so I
have all the images handy; I want to sandwich a frame and a photo and
plop text on it later.

We definitely get a richer toolset with Quartz; there's a GUI tool
just for testing stuff out. I mean to follow Apple's introductory
article on it. We get Python examples, APIs in Cocoa, Carbon and
Objective-C; development can be done in XCode if need be (if we don't
use Python, and I don't see why we wouldn't).

Rolled out to all three levels (spork, stg, plook), Gallery to all and
store to the first two. I have to debug this issue with IE7 and I
suspect its' this syntax which I so dislike:

  var objCheckBoxes   = document.cart_quantity;
  var countCheckBoxes = objCheckBoxes.length;

I think the appropriate syntax is something like:

var objCheckBoxes = document.forms['formname'].elements['foobar'];

Because we use that wonky PHP syntax where form elements have the name
"cart_quantity[]" this might not work. Then again, why wouldn't it?




#########################################################################
061120 Mon 20 Nov 2006 10:22:43 AM EST

Came it to find the store could not access vol07; disabled the
filesystem check for deleted photos for Nathan. Peter said we had one
order yesterday. Jessy says signups are down over the last three week
period.

Well, there were a handful of errors for the store on November 19th;
most puzzling were the Internal Server Errors from TLC. I couldn't see
anything in the XML to cause it. There were a couple SQL errors where
the session_id was not passed in, which is also a bit puzzling (where
did the cookie go?)

From Saturday on Avalon:

You paged chilly_willy with: we are looking for someone to do a technical audit... nfs, network 
setup, etc. you interested in moonlighting?
chilly_willy pages: yes
chilly_willy pages: i'd love to do some moonlighting

You paged chilly_willy with: coolio. we can talk more about it later. probably on the phone to 
expedite things.

chilly_willy pages: np :)


chilly_willy pages: hell, if you want, i have the vacation, i could do a week onsite if you want 
to pay travel :)

You paged chilly_willy with: that might be doable. i don't think you'll need a week onsite :o)

chilly_willy pages: moonlighting works fine too
chilly_willy pages: extra money is always good, especially around xmas :)

You paged chilly_willy with: heh :o)
You paged chilly_willy with: we've had a lot of outages lately after a data center move and our 
ceo wants to make sure everything is being done as well as it can... 

chilly_willy pages: np
chilly_willy pages: can also help with monitoring if you need any help on that front

You paged chilly_willy with: i think chris is taking it very personally. well i know he is. i'm 
trying to convince him this is an opportunity and not a threat.

chilly_willy pages: understandable
chilly_willy pages: i deal with it at my place

You paged chilly_willy with: being audited you mean, and not auditing?

chilly_willy pages: there are so many things that need to be done, that you don't have the time to 
go back and bullet proof stuff

You paged chilly_willy with: so true

chilly_willy pages: and i'd bet most things i'd find he's already mentioned


chilly_willy pages: but, higher ups ignore their normal staff on that stuff
chilly_willy pages: i actually look for people to be able to tell my boss the same thing i tell 
him so he listens :)

You paged chilly_willy with: in your case i'd hope you'd uncover things that were missed, or maybe 
just not known. like the time you helped tune the nfs.
chilly_willy pages: i've grown to look forward to audits, as it means things i want to get done 
move to the top of th list :)
chilly_willy pages: yeah, things like that will be found
You paged chilly_willy with: our systems problems all come down to nfs these days

chilly_willy pages: you're using alot of linux still aren't you/
You paged chilly_willy with: it's all linux these days

chilly_willy pages: i've been doing a ton of linux nfs crap lately
chilly_willy pages: enough to really understand why it sucks :)

You paged chilly_willy with: chris picked this company, onstor, for our storage
You paged chilly_willy with: i think they are using us as beta testers. same old story.

chilly_willy pages: i've heard some good things about them

You paged chilly_willy with: for the moment, give me a rough time frame where you'd be able to 
take time off to do this

chilly_willy pages: asap, well not tonight, as i'm working on getting plowed :)

You paged chilly_willy with: i think our experience is very mixed, but we're really putting their 
shit to the test

You paged chilly_willy with: i'm probably heading out to chris' neighborhood to do the same :o)

chilly_willy pages: i'd probably take the time to setup RTG to do some monitoring of the onstor as 
well

chilly_willy pages: to find out exactly what the sucker is doing

You paged chilly_willy with: coolio. let's chat again tomorrow.

Brian O'Neill
8527 Kirkwood Lane North
Maple Grove, MN 55369

--
btoneill@misplaced.net




#########################################################################
061127 Mon 27 Nov 2006 10:10:23 AM EST

Meeting with Chris, Peter and Jessy on an action list for Onstor; and
talked about the tech audit. 

Lots of testing of Gallery; found a security hole in Jessy's
albumscroll.php.


#########################################################################
061128 Tue 28 Nov 2006 10:15:27 AM EST

Thought: gererate thumbnails from the sized image, instead of the full
sized image. Probably faster.

Wrote a Perl script to figure out the most common search engines; then
figure out what the most frequently requested files are. Based on that
I crafted a new robots.txt file which should reduce the loads on the
servers and bandwidth.




#########################################################################
061129 Wed 29 Nov 2006 10:08:46 AM EST

Steve Wainstead: for RSS, i think we will have to only allow public
stuff to be syndicated. The way it used to work is: if you were logged
in, then the feed would also show you private albums (if you had perms
to see them)
Steve Wainstead: if we generate xml as flat files this won't be possible anymore
typolesbo: yea
typolesbo: i agree
Steve Wainstead: it kind of makes sense anyways. you'd only want your
public stuff syndicated.
Steve Wainstead: there will be the main xml file at the site's top level
typolesbo: y
typolesbo: a
Steve Wainstead: and every album willhave its own xml file as well
10:05 AM
Steve Wainstead: which shows the photos in order of newnewss
Steve Wainstead: oh fernando is out sick today
typolesbo: k
typolesbo: oh ok
Steve Wainstead: i'm thinking a cron job will run every 5 minutes to
regenerate any sites that have updated

So I don't see any benefit to us or the end users by offering three
different feed formats. Most RSS readers handle any of the three
formats, so we only need to pick one. I think Atom might hold the
future as it's going to be more featureful in the long run. RSS 2.0
looks frozen, and RSS 1.0 looks like an also-ran.





#########################################################################
061130 Thu 30 Nov 2006 10:49:08 AM EST

Was looking at SWIG at the end of the day yesterday; I wanted to skim
through the Python module CoreGraphics.py, and the first two things I
noticed were 1) it's unreadable because it was machine generated and
2) it was machine generated, by SWIG. So... does SWIG do PHP?
According to the site, yes, but it's experimental.

So in the least, we should be able to generate a PHP module on the
order of complexity of the Python module.

RSS took some steps forward, but one of the key problems is how to
update an album's XML file. And for that matter, I think I might just
redirect everything to the site XML file for now and leave album XML
files for a later date.


#########################################################################
061201 Fri 01 Dec 2006 07:04:46 PM EST

Today: finished work on the cron job for rss feeds. Lotsa testing for
the rollout, which had to have the exit popup removed, in the end.


#########################################################################
061204 Mon 04 Dec 2006 09:41:05 AM EST

regenerate-feeds.php stopped three times over the weekend. Maybe four?
I'm running it off a custom Gallery codebase now. The changes involved
putting in tests whenever $someobject->getPhoto($number) is called. It
sometimes did not return an AlbumItem or Image, but a stdClass or
nothing. That resulted in the "method called on a non-object"
error. Then I started getting: 

Album::getPhoto(): ERROR: requested index [] out of bounds [ number of
photos in this album: 7]Feed generated.thematlockfamily done. time
passed: 21.838638067245

Doing winterville. time passed: 2.598762512207E-05
Tested config.php.. time passed: 0.022214889526367
loading init.php. time passed: 0.022279024124146
done loading init.php. time passed: 1.2281210422516
rssfile: /mnt/cel-1/vol01/w/wi/win/wint/winte/winterville/rss.xml
Segmentation fault

mysql> select count( date_format(last_updated, '%Y %m')),
 date_format(last_updated, '%Y %m') as last_update from users where
 last_updated > 0 group by last_update;

+--------------------------------------------+-------------+
| count( date_format(last_updated, '%Y %m')) | last_update |
+--------------------------------------------+-------------+
|                                          1 | 2004 05     |
|                                         27 | 2004 06     |
|                                        212 | 2004 07     |
|                                        604 | 2004 08     |
|                                       1009 | 2004 09     |
|                                       2059 | 2004 10     |
|                                       2574 | 2004 11     |
|                                       1785 | 2004 12     |
|                                       2449 | 2005 01     |
|                                       4093 | 2005 02     |
|                                       6783 | 2005 03     |
|                                       6802 | 2005 04     |
|                                       8422 | 2005 05     |
|                                       9951 | 2005 06     |
|                                      10911 | 2005 07     |
|                                       9898 | 2005 08     |
|                                       7924 | 2005 09     |
|                                       8536 | 2005 10     |
|                                       8240 | 2005 11     |
|                                       7599 | 2005 12     |
|                                       9510 | 2006 01     |
|                                       7528 | 2006 02     |
|                                       8840 | 2006 03     |
|                                       8463 | 2006 04     |
|                                       9182 | 2006 05     |
|                                      10156 | 2006 06     |
|                                      11007 | 2006 07     |
|                                      12019 | 2006 08     |
|                                      10521 | 2006 09     |
|                                      12110 | 2006 10     |
|                                      15850 | 2006 11     |
|                                       3097 | 2006 12     |
+--------------------------------------------+-------------+
32 rows in set (0.81 sec)


I've made changes to my copy of Gallery, mentioned above; I'm
wondering if I should merge them in. They might cover up a problem, or
work around it, instead of fixing it. Why are nonexistent photo
objects being requested? How do stdClass instances get pickled into
the dat file?

Wound up committing all my changes to the main branch. I factored out
the if() statements into one function, testIsAlbumItem($photo).
Prodigious error messages abound when this is encountered.




#########################################################################
061205 Tue 05 Dec 2006 05:29:25 PM EST

-- three queries to test for bogus order subtotals.

drop table if exists ordersums; create temporary table ordersums (select orders_id, sum(products_price) as products_final from osc_orders_products group  by orders_id);select ot.orders_id, value, products_final, oo.date_purchased, (value - products_final) as difference from osc_orders_total ot, ordersums o, osc_orders oo where ot.orders_id=oo.orders_id and ot.orders_id=o.orders_id and ot.title='Subtotal' and ot.value <> products_final;




#########################################################################
061207 Thu 07 Dec 2006 09:50:51 AM EST

Testing the store yesterday on staging, and I found that club prices
were not being applied to my order. Bleh. I wanted to roll the store
out, because Fernando put in a check to test if the subtotal came out
correctly; and I put in code to archive their session and basket, but
the tables on production are different. So that ended that. I just
went ahead and created arch tables based on the ones that are there,
but actually that's doubled the problem and I should fix the broken
window now.

Meanwhile, Lilia dos her dilligence and finds TLC charging us more for
shipping than the shipping calculator tells us. That damn thing! I
found in the log where they TOLD us $1.85 but invoiced us $9 and
change. Jessy is handling that.

Spent time yesterday solving why the store was WSODing on dev and
staging when I tried to buy a club membership. Cause: in PHP 5.2, it's
a "catchable fatal error" when you try to interpolate an object
reference into a string. PHP5's object model allows for a __toString()
method (which is magic) in any class, but the Log class has to be PHP4
compatible so... hmm... actually that might work.

Jacob late again.




#########################################################################
061213 Wed 13 Dec 2006 01:05:30 PM EST

Location:
https://swainstore.myphotodevel.com/shopping_cart.php?action=add_product&calendar=3121{calendar_id}495{subdomain}swain{thumb_name}http://images.myphotodevel.com/s/sw/swa/swai/swain/swain/albums/plingpling/P6130006.sized.jpg&quantity=3

Took me a while to figure out the problem here:

SELECT op.products_id AS id,
        pd.products_name,
        ( op.final_price / op.products_quantity ) AS final_price,
        op.*,
        SUM(op.final_price) AS subttl,
        SUM(op.products_quantity) AS count 
        FROM osc_orders_products op 
        INNER JOIN osc_products_description pd ON pd.products_id = op.products_id 
        INNER JOIN osc_products_to_categories pc ON pc.products_id = op.products_id 
        WHERE  op.orders_id = 20453
        AND pc.categories_id = 1
        GROUP BY id, final_price \G

The problem is: we group by final_price. So if I order three calendars
in quantities of 2, 2, and 1, then we see 4 and 1 in the output
because the 2 and 2 had the same final_price, so they are grouped.




#########################################################################
061214 Thu 14 Dec 2006 09:53:31 AM EST

Hanley late today.

Chrismas party tonight. The week flew by. Come to think of it I still
have that spreadsheet from Lilia. I have been in meetings for
limos.com, testing and fixing things in the store and OFS, and that's
about it. I spent a little time at COB working on chapter 1 of FOTB,
and last night I compiled PHP 4.4.4 on my laptop with --enable-debug,
and downloaded and fixed the HTML in an article on making PHP
extensions. I looked at SWIG yesterday and its support is for PHP4. I
think, on further reading, that we would not use SWIG (cool though it
may be). The way to go might lie in writing classes in Objective-C as
part of a small framework that does the things we need; in fact we can
move the "heavy lifting" into this framework to make the PHP end of it
as easy as possible. That is, the framework would present an API to
PHP that would make it as painless as possible to create the PHP
extension.

Spent time looking at three sites that have been suffering from the
logout problem. One common thing is they all have some kind of verbose
comment notification turned on. I emailed Jessy, Fernando and Lenny
suggesting we revert their config.php files for a time, with the
user's cooperation, and see if that resolves the problem. If it does
then we know some kind of configuration change users make triggers a
bug somewhere in the Gallery code base.

Yes, Virginia: the daily sales report shows only District's cards in
"gift cards." TLC cards show in "photo gifts."




#########################################################################
061215 Fri 15 Dec 2006 01:12:24 PM EST

Was working on a scratch refactoring of Gallery so the global $gallery
was an object, accessed via a static method in the new Gallery
class. But when I mass changed all instances of 

global $gallery;

to:

$gallery = Gallery::fetchGallery(getSubdomain());

I ran into some kind of order-of-operation problem:

Warning: mkdir(): No such file or directory in
/home/swain/public_html/projects/ampiradev/gallery/platform/fs_unix.php
on line 111 Error: Unable to create dir: Fatal error: Call to a member
function on a non-object in
/home/swain/public_html/projects/ampiradev/gallery/classes/gallery/UserDB.php
on line 110

Why mkdir is being called, who knows.

I spend time yesterday whiteboarding stuff. It was interesting. I want
to get the store "fixed" once and for all; that is, a design that's a
piece of cake to work with, much like the OFS. The OFS is so loosely
coupled now I don't even have to do anything for it: Jacob took care
of all the work for the calendar. By contrast, the store required me
to do some intense debugging to make it all work for him.




#########################################################################
061221 Thu 21 Dec 2006 10:32:22 AM EST

Was in Phoenix Monday through Wednesday for due diligence on
limos.com.


Testing the OFS using another lib dir:

for i in `find . -name \*.p[ml] | grep -v devstuff`; do perl -I /opt/mpa/dpi/bin.borked/lib -wc $i; done

5:18pm update: After a lot of work doing rollouts and testing, the OFS
and the store are live and everything looks honky dory. I had Jacob
use the debugger for a while to figure out why the title did not
appear on the cover of the calendar (I note here I'm tired of doing
the QA), and he hardcoded the font in one of the OFS files for the
time being and we tested it on production. Works. I sent an email
around that I'm too pooped to continue on to a Gallery rollout and
will tackle that tomorrow.




#########################################################################
061222 Fri 22 Dec 2006 03:34:47 PM EST

Rollout done, but there's a bug with nested albums (took a while to
diagnose it) and the survey was fubar as well (Matt fixed it).




#########################################################################
070104 Thu 04 Jan 2007 11:25:12 AM EST

Been back since Tuesday but no entries; was out all last week using up
my vacation time. On Sunday I got my PHP extension to make a new image
with Quartz 2D primitives, on Monday figured out a bug where the text
wasn't showing up (the font used was not available perhaps) and on
Tuesday Jacob resigned.

Yesterday I fixed a bug with Veracity where all user's albums were
marked as "last updated on" the day Veracity visited it. Wrote some
code to reset this on the next run and passed it off to Chris. He
disabled RSS without telling me and that's been out of date for over a
week.

So Tuesday was eaten up by time spent in meetings over Jacob's
resignation. Not much more to tell. Yesterday I finally hammered out
most of the technical review of limos.com, and got drawn into a
rollout of the signup wizard. There were some CVS issues I had to
resolve, basically doing cvs tag -F oldtagname doesn't work when the
file is new and wasn't tagged with the old tag. So I have to do:

cvs -q update -dPA
cvs tag -F oldtagname
cvs tag oldtagname

to cover all bases.

Long manager's meeting this morning.

I found a cheese stick wrapper on the floor in the kitchen! THIEF!

On a lark, I wondered if I could create my own separate dev
environment. I could. All I had to do was create a copy of the
database (already there, mpa_test, just needed updating); make three
conf file hacks (cp gallery.mysql.conf to gallery.conf, added one line
to store.swain.conf to define the database before loading the main
store conf file, and made a local copy of the OFS dbconfig.pl file.

I ran an order all the way through successfully. This means I could
embark on a major refactoring of the store without impacting anyone
else. I just dropped three or four columns in osc_session_info and
could not place an order because the session archiving code coughed a
hairball. Very useful to know.

So I should plan out a series of refactorings. My goals should be:

* more promotions, more flexibility to do promotions
* variable shipping rates

The session stuff needs to be separated from the cart stuff. Do I do
it all TDD? I suppose I should. One obstacle is PHP4. Gallery is all
PHP4 and parts of the store code are too. Hrmm. Perhaps there's a way
to simplify the interface between the two so this dependency goes
away? Maybe a code generator? (I'm thinking of how every request has
to hit the database to create all those product code constants).




#########################################################################
070105 Fri 05 Jan 2007 05:47:48 PM EST

I finally debugged and fixed the problem with international characters
breaking the eorder CGI on TLC's end. All I needed was to put back:

<?xml version="1.0" encoding="iso-8859-1" ?>

into the template xml file. I took it out long ago because it caused
PHP trouble. TLC should have defaulted to the right charset anyway but
what can one expect from them.

I polished and sent off my tech report on limos.com. I spent time
researching the current job market to gauge what Fernando is worth,
but all I got was there's a surplus of PHP jobs out there.

I finished the tiny Flash tutorial project. I still don't know why
labeling frames was such a problem: all the frames on the timeline
would have the same label. Very frustrating. I labeled them at
creation time and that worked. The whole thing worked so that was all
spiffy.




#########################################################################
070108 Mon 08 Jan 2007 10:27:37 AM EST

mysqldump by default creates one super huge line to do an insert. This
is not human friendly.

alias mpadump='/d0/mysql5/mpa/bin/mysqldump --extended-insert=false -S
/tmp/mysql.mpa.sock -uroot mpa'

The trick is to do --set-opts=false or just --extended-insert=false.

Going through the osc.log this morning, I found TLC's shipping
calculator returning 500s. The cause was an incomplete XML file; the
file stops at a special char in the user's city field. (An 'i' with a
tic over it). I cannot reproduce this on staging or
development. Weird.




#########################################################################
070110 Wed 10 Jan 2007 10:02:05 AM EST

Fixed an internationalization problem yesterday. Icelandic customer's
basket was hosed due to a character; on production the xml failed to
generate. I found the solution on a Swedish page: use utf8_encode() on
the string first. Worked like a charm.




#########################################################################
070111 Thu 11 Jan 2007 04:06:26 PM EST

Reviewed today. Out most of the afternoon at the eyeball
doctor. Helped Fernando branch Gallery so we could roll out without
Jacob's new code.

Brian Fitts asked:

Ok .Airmail to Iceland is not set up on test site.  It is set up for
live, however.  Can I ask why you are doing a test order to Iceland?

(duh!)

I ran some scripts to count how many skins are used by who. Overall
around 35% change their skin; paying customers, 45%. I would guess the
33% who would have their site listed in a directory are also
customizing their sites.

Turns out I'm a Director. Just "DIRECTOR" in Adminstaff's web site.




#########################################################################
070115 Mon 15 Jan 2007 11:26:49 AM EST

Spent time culling errors from the store log; nothing remarkable. Lots
of "ORDER ALREADY PAID FOR" entries, and a small handful of the
missing session ID errors. I should fix the store so those aren't
puking ezsql error pages back at the user.

Spent more time culling errors from the Gallery error logs. There are
periods where things like stale NFS filehandles or failed stat() calls
clump together; tons of TRANSMIT errors (gzip related), tons of those
"shutdown" calls made by the Java applet, loads and loads of "File not
found" for any dat file with the .0 extension, offset errors from
gallery.mysql.conf, and so on. I should see if I can get rid of those
right now.

Not operator in the find command:

find . \! -name \*.gif \! -name \*.jpg \! -name \*.png  \! -name \*[0-9] \! -name \*~  \! -name \*.html  | grep -v CVS

I've renamed gallery.mysql.conf to gallery.conf. Finally. And it
turned out the crap about sub1, sub2 was not used on production
according to a comment by Fernando; but I think it was used for
FIVE_LEVELS and that was used to define something else, so the new
Gallery code has to roll out first.

We leave at 4pm today.


#########################################################################
070116 Tue 16 Jan 2007 11:23:29 AM EST

I think my work on changing the configuration is done for the time
being. There's more that could be done, but it's not warranted. I
wanted to get those offset error messages out of the production logs.

mup-1 was having problems, spewing an error message over and over:
something about function get() called in UserDB.php. No such call
existed. Chris cursed and grunted a lot and didn't say anything, just
took mup-1 out of service.




#########################################################################
070117 Wed 17 Jan 2007 01:44:21 PM EST

chilly_willy pages: get my email? [1:10 p.m. 17]
heller | 
http://sportsillustrated.cnn.com/2007/football/nfl/specials/playoffs/2006/01/17/kfed/index.html?ere
f=rss_topstories => http://avln.us/57e [1:27 p.m. 17]
You paged chilly_willy with: did, replied, thx :o)
chilly_willy pages: sorry i've been scarce, fuckers here needed a new oracle box built in korea :(
chilly_willy pages: and we currently have 600ms latency to our site there
chilly_willy pages: and you guys have more damn OS versions then I do here :)
You paged chilly_willy with: you're fighting a nation of hardcore gamers. thus the latency. ;o)
You paged chilly_willy with: we do? really? hrmm.
chilly_willy pages: yeah
chilly_willy pages: mandrake 8, 8.2, 10, 10.2, 2006
You paged chilly_willy with: aah! well all mandriva but yeah, too many versions. 
chilly_willy pages: openbsd, solaris 8
You paged chilly_willy with: yeah bastion is openbsd
chilly_willy pages: and unpatched in 2+ years solaris at that
You paged chilly_willy with: dunno where we have solaris boxen
chilly_willy pages: img-* is, plus ns-*, and a couple others
You paged chilly_willy with: thx for getting back to me right away though
chilly_willy pages: and you need to definately patch boxes for the new TZ change in march
chilly_willy pages: ofcourse, all that will be in report
Wainstead \ [to elias]: got my 'eat to live' today. gonna read it tonight.
You paged chilly_willy with: TZ? time zone? new daylight savings stuff?
chilly_willy pages: yeah
chilly_willy pages: energy act of 2005
chilly_willy pages: DST changes this year
chilly_willy pages: starts in march now
You paged chilly_willy with: heard of it, but didn't know we had to patch for it
chilly_willy pages: if you want the servers to have the correct time :)


So, duh. I was fighting a problem I solved long ago, not reproducing a
bug on production. I ran one of my LHH scripts twice in a row and was
getting the SQL error where no session ID was passed in. This is
because the LHH script was only meant to fill the cart, not purchase
anything. I even titled it and a similar script "fillcart." Duh.

Still, my thoughts this morning (last night?) about stepping through
the process with the script lhhrerun.pl are valid, but... I can either
do it with the Perl debugger, which is free and has a billion
features, or write a simple set of command line args and avoid the
debugger. I think I side with the debugger. I wonder if there are
scripts out there that come with breakpoints preset just for this
purpose.




#########################################################################
070118 Thu 18 Jan 2007 04:57:12 PM EST

Lessee... started out helping Chris with PHP5.2 stuff. Figured out one
liners to convert short tags to long tags; lint checked; did Gallery
and Serendipity and committed it. Looks good so far.

Interviewed Chanu. I'm afraid I'd be holding his hand for weeks (or
forever) trying to get him going.

Rolled out the signup wizard and its cron scripts.

Peter had another paranoia attack about slow mpa sales so I bought two
more prints. No problems.




#########################################################################
070119 Fri 19 Jan 2007 06:09:08 PM EST

Well I solved my own problem by adding on to the front of the dumped file:
SET FOREIGN_KEY_CHECKS = 0;
and on to its end
SET FOREIGN_KEY_CHECKS = 1;




#########################################################################
070122 Mon 22 Jan 2007 03:12:50 PM EST

Long meeting this morning with Peter and Jessy. Dev roadmap. I think
the end result is we will not replace Jacob.

Made a script to update all user.local.php files. Also did the radical
refactoring of the store code to make all session calls on an instance
of the Session class, instead of all static method calls. Next step is
to do the same with the Cart, and then I can split osc_session_info
into two tables, the other being osc_shopping_cart.


#########################################################################
070123 Tue 23 Jan 2007 10:25:54 AM EST

The Session class has no private data, currently; all the data it
accesses is in the $GLOBALS array. No biggie. Later that data has to
come into the class; perhaps sooner rather than later. 

I'm running a Perl script to update all the user.local.php files on
production to have the long PHP tag, <?php. After that I need to flush
the backup files. We should be able to test PHP 5.2 on mup-1 then.

Chris found the session bug was due to long array names being enabled,
i.e. legacy array names $HTTP_GET_VARS and friends were enabled. That
would suggest one or more are still floating around in the Gallery
codebase, though I thought I got them all. Gotta check the
manual. It's a performance hit to have it turned on.

Ran into one blocker in making the Cart an instance: AJAX. It does not
instantiate a cart, or have an instance; it was relying on
manipulating the tables directly via static calls.

$GLOBAL[] is used by Trevor throughout. It reminded me of the Registry
pattern from the Flowler "Enterprise" book, so I read through that:
it's a pattern of last resort, he says. Hrmm. I'm wondering if I
should go ahead and wrap $GLOBAL[] in a Registry object just to hide
it.

Consolidated all functions that were in use in inc_cart_functions.php
into the Cart class and deleted that file.




#########################################################################
070124 Wed 24 Jan 2007 01:17:57 PM EST

You say, "oops:"
[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
About I say 15 - 20 people have complained about this ad.. Per customer below:

'Umm...I think your site has been hacked. I haven't logged on in a month or so, but I noticed some 
text at the top left of the screen that says "HELLO SAILOR NEED A DATE". It doesn't appear to be a 
clickable link. After I logged on, it appeared. I just thought that was really odd. I haven't seen 
it on any other web sites today, so I don't suspect that it is my computer.'

Most of the emails have been the same. It appeared once and then never again. We haven't received 
the reply from the person who said they saved the print screen image on their computer.
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
You say, "perhaps some of my test data escaped to production"
scott [to Wainstead \]: heh
KENtucky [to Wainstead \]: haha.
You say, "yup:"
[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
[root@mup-1 current]# find . -type f |xargs grep -i sailor
/ampira/wordlist.txt:sailor
/ampira/wordlist.txt:sailors
/lock.php:echo "hello sailor!\n";
/lock.php~:echo "hello sailor!\n";
/.#init.php.1.80:echo "HELLO SAILOR NEED A DATE\n";
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
You say, "not live anymore though"
elias [to Wainstead \]: haha
tiResias . o O ( disappointingly, it was not a clickable link )
xorian . o O ( Dear Sir: I am a sailor and I do need a date.  How do I
access this service? )


Did testing for a rollout; mgr's meeting this morning; wrote/started a
script to clean out backup copies of user.local.php. Got about six
sites without one. They all look like they were deleted, except one,
yayheaven. Fixed it but it's an empty site.

Very noisy in the office today.




#########################################################################
070125 Thu 25 Jan 2007 02:18:15 PM EST

Killed Veracity last night as mdb-2 was running 10.0 across the board;
it dropped to 2.4ish. But still the store performance sucks ass.

So Chris and I have been doing some digging: turns out mdb1 and mdb2
have different versions of mysql. He updated mdb1 to the latest and we
may or may not cut over... he's going on vacation, Las Vegas, for the
weekend.

The cron job that's supposed to cull the sessions table and basket
tables appears to have been failing: there were three million plus
rows in osc_session_info. Ran those by hand and culled all the crapola
out.

Meanwhile, archived about half of the osc_orders_products_attributes
table (four million rows). That seemed to bring the purchase
transaction time down to 1:08; culling sessions got it to 0:43. Still
a ways to go.



Subject: Store slowness resolved, finally

I've been working on this problem all day: the store would take up to
two minutes to complete the sale, which is the very last step.

There was no one culprit; it was a combination of things that caused
this, each contributing ten to thirty seconds of the slowness:

1) Veracity, which has been syrup slow and dragging the database down
   with it ever since the data center move. As it happens there are
   slight version differences between MySQL on mdb-1, which we used as
   the primary database in the old data center, and MySQL on
   mdb-2. Chris thinks the older version of MySQL on mdb-2 might be
   prone to a deadlocking issue (fixed in the version on mdb-1). So
   stopping Veracity last night helped, but not enough. (And this is a
   separate problem to be solved: why Veracity runs so slow now).


2) Old sessions cluttering the database. The cron job that flushes all
   the old sessions and carts for people who haven't logged in has
   been failing for days; I don't know how long, but my guess is
   because there were over three million rows in the sessions table,
   the cron job took too long and Mysql dropped the connection.  I ran
   these by hand. It took almost twelve minutes to clear out the old
   sessions. (note 2007-01-29: /d0/mysql symlinked to the wrong place
   on mdb2).


3) The next problem was some code I added to archive the session and
3) the cart. Fernando and I were interested in saving this data
3) because it might help us solving problems with orders. It was
3) taking up to 30 seconds to copy data from one table to another, via
3) a INSERT INTO archive_table (SELECT * FROM tablename WHERE id IN
3) (long list of ids).

It's that:

 "IN (long list of ids)"

syntax that's a killer. It's really slow. Which leads us to:


4) The code that empties the basket after the sale completes was
4) written the same way. It was taking up to 30 seconds to empty the
4) basket after the sale.

So: I have put the kibosh on archiving sessions for now, and rewrote
the query in #4 to use the multi-table DELETE syntax. This seems to
have led to a huge gain, as flushing the cart takes like 0.001 seconds
now as opposed to 30.001 seconds.


5) One of the tables that holds old order info had grown to 8 million
5) rows, and I archived about half of that to another table. That
5) helped as well. INSERTs into that table were taking a long time.

I've no doubt that this slowness has been the lead contributor to our
sluggish sales as of late, the post-holidays notwithstanding.

~swain

Changed the forwarding of root's email on mdb-1 and mdb-2 to
chris@corp.fortunecity.com.




#########################################################################
070129 Mon 29 Jan 2007 03:34:03 PM EST

Bobcats failed three times this weekend. I did store rollouts on
Thur/Fri to fix bugs, and I saw that my fixes worked. Yay. When they
don't get the redirect, and I think it's because output already
started but there are no php warnings, that's when they see the watch
spin forever. So if they click stop and continue again, they see the
transaction "complete" instantaneously. I moved the redirect into a
function so it could be reused for this purpose.

The cron job to cull old sessions for the store called
/d0/mysql/mpa/mysql/bin or something, and this was a bad symlink. So
nada. I changed the path and committed it. This has probably been
going on since the datacenter move.

I had a thought just now: rather than go through the pain of splitting
the osc_session_info table into two tables, maybe I can convert to the
native PHP session management; in which case, we could switch to the
sessions database to store that stuff. Then I'd just have to rename
osc_session_info to osc_cart and refactor the code that accesses
session specific stuff, using the $_SESSION array. Hrmm. Because I've
been thinking I'd split the table, isolate the session stuff, and then
convert anyway to PHP's native session stuff.

I'd have to write (really, copy) the functions used for MPA and
convert to that. Not a biggie really.

Have been completely sidetracked by the gift cards failing when I
switched to my mpa_test database. Problem: gift cards use their own
copy of ezsql, and their own conf file (gifts.conf).

Solution: require() my user.local.php file in gifts.conf, and define()
the database name there.


#########################################################################
070130 Tue 30 Jan 2007 12:39:02 PM EST

Long conference call this morning with Visanti, over their Weeblr
app. Basically del.icio.us with some graphics. They've been developing
it for six to ten years (not sure which) and they are about to go
under.

Detour: quote from "Write to the Point":

Does this chapter give you all the rules of standard written English?
Certainly not. There are far too many. Further, many of the rules --
like the rule about agreement between subject and  verb ("he was"
instead of "he were") -- are too well known and obeyed to need
repeating. Many other rules aren't worth knowing or obeying. In John
Barth's novel "The End of the Road," Jacob 'Jack' Horner, the
hero-villian, a teacher of grammar, announces to his freshman English
class:

    Predicate complements of infinitives of copulative verbs without
    expressed subjects go into the nominative case, whereas predicate
    complements of infinitives of copulative verbs *with* expressed
    subjects go into the objective case. "I was thought to be *he*,
    but I thought John to be *him*! Questions?

Yes, why would you want to remember a rule so trivial?

(End quote).

Spent time rereading and cleaning up the Ajax code. I managed to
retire two files whose only purpose was to load other files. I
answered the question I had in mind: can't the API to the store go
live with the store? The answer is no, because Gallery's PHP files use
the API functions to ask the store questions. It's not a simple matter
of the Javascript calling ajax.php with POST data.

That said, we can live with it since we've moving everything to PHP
5.2. My next question is: can Gallery instantiate the session and cart
classes in the store? This will get around the use of static method
calls. Shouldn't be impossible. Then: how to get around the store
cookie problem? If I want to migrate the store to use PHP's sessions,
which I do, then I have to figure out how to get a cookie from the
store and set it in Ajax. This might not be possible.

I found, again, the whole mess that is Prototype, Scriptilicious, and
Tree's code. Oy vey. There's about 4 pages of Javascript code in a
given Gallery page. Terrible.

I have to think about how we're going to move all the skins and other
image files to another project. I told Chris if he got PHP 5.2 working
with Gallery, I'd make this happen.




#########################################################################
070131 Wed 31 Jan 2007 02:37:37 PM EST

Between session_name() and session_start(), I think I can replace the
existing session framework for OSC and make it compatible with
Gallery. Yesterday I threw out some old Tree code and simplified some
other stuff; today I modeled for a bit how I thought it might work. I
suppose the key is to look at where the AJAX code calls
Session::whateverMethod() and see if that can be replaced.

./gifts/cards/gc_includes.php:34:Session::setCookie();

Herein lies part of the problem. Gallery code directly accesses the
Session class in the store. Where I think what Gallery needs should be
pretty limited and I can create... a Facade or Adaptor or something to
hide that away. Separate the part that varies from the part that stays
the same.

Actually, the API_* functions kinda sorta serve this purpose
already. I have to review why I'm at this point: I know I want to
separate the cart from the session in the store; and Gallery accesses
the session/cart via the store's classes. But my original goal was to
add more stuff for promotions and shipping.

A fundamental problem I'm up against is the store and gallery both
want to have their own sessions. This works fine now because Gallery
uses session_start() while OSC uses its own home grown stuff. You
cannot call session_start() twice though and have two separate
sessions going for two domains; so Gallery, if it has no osCsid in its
cookies, will have to create one. This is fine; on the OSC end  we
need to associate a Cart with that session ID and not worry about the
$_SESSION. The $_SESSION only cares if they are logged in or
whatever. I think a user is logged in, in the store, if they have a
customer_id in their session.

Yup:

    //****************************
    // what it does:  determines if a customer has logged in
    // returns:       a customers ID or NULL
    function isLoggedIn() {
    
        $get_info_sql = "SELECT c.customers_id
                         FROM osc_session_info si, osc_customers c 
                         WHERE c.customers_id = si.customers_id 
                         AND c.customers_id > 0 
                         AND si.sess_key LIKE '" . Session::getKey() . "' ";
    
        return DB::getVar($get_info_sql);
    }

(from Session)

So we can use the osCsid to track both the cart and the session. No
biggie. This feels like territory where Trevor has already been.

So, backtracking to my starting point: I started like I did with the
OFS, by trying to model (on paper) how the classes should look and
interact; who hasa what, who isa what and so on. I did very well with
the OFS by writing a script that... was not in fact a script, just how
I thought the thing should look... I think it's worth pasting the
whole thing in here (indented for practical reasons):

    # In the theoretical, how we'd do the new process.
    
    # renaming the scripts for more meaningful names:
    # build_order.pl      => import_files.pl
    # move_build_files.pl => copy_to_shipping_dir.pl
    # create_dpi_xml.pl   => create_orders_xml.pl
    # ftp_to_dpi.pl       => upload_orders.pl
    
    
    # Potentially, the WholeOrder class could implement the State
    # pattern. The benefit would be: if a method is called on an order
    # when it's not in the correct state, the error is
    # caught. Hmm. Anyhow, we might reduce this from four cron jobs to
    # just two: import_files.pl, which runs all the time, then merge the
    # other three into one script that uses the State pattern. The
    # weirdness there would happen when we call all orders... iterating
    # over the WholeOrder objects, we would do something blandly
    # meaningless like "$order->do_next_thing", which hurts
    # understandability of the program.
    
    
    # get orders
    package main;
    my @orders = $db->get_paid_orders();
    
    # set to pending, so no other cron job picks them up. Thought about
    # putting this in the Factory method: for each order ID returned, set
    # it to pending.. but keeping it here keeps it on the same level as
    # updating it to the next status.
    
    foreach my $order (@orders) {
        $order->set_order_pending;
    }
    
    
    # process each order
    foreach my $order (@orders) {
    
        @order_parts = $order->create_order_parts;
    
        # this can be in the script, or in the WholeOrder class.
        foreach my $order_part (@order_parts) {
            $order_part->build;
        }
    
        if ($order->has_errors) {
            print "order failed!";
        } elsif ($order->had_nothing_to_ship) {
            # an order of "club membership" or "attic key" has nothing to
            # ship
            $order->set_order_complete;
        } else {
            $order->update_order_status;
        }
    
    }
    
    # and in package WholeOrder...
    package WholeOrder;
    use OrderPartFactory;
    use OrderPartShippingFactory;
    
    sub create_order_parts {
        my $self = shift;
    
        foreach $type ( $self->get_order_part_types() ) {
            my $order_part = OrderPartFactory::create_order_part($orders_id, $type);
            push @order_parts, $order_part if ($order_part);
        }
        
        return @order_parts;
    }
    
    
    sub create_order_shipping_parts {
        my $self = shift;
    
        foreach $type ( $self->get_order_part_shipping_types() ) {
            my $order_shipping_part = OrderShippingPartsFactory::create_order_shipping_part($orders_id, $type);
            push @order_shipping_parts, $order_shipping_part if ($order_shipping_part);
        }
        return @order_shipping_parts;
    }
    
    
    # OrderParts are the individual products...
    package OrderPart;
    sub build {
        # subclasses implement this. base class dies.
        die "Pure virtual method yada yada\n";
    }
    
    package OrderPartPrints;
    use base qw(OrderPart);
    
    sub build {
        my $self = shift;
        # do all the stuff in build_order.pl, in sub copyPrintsToOrderDir
    }
    
    package OrderPart4x8Cards;
    use base qw(OrderPart);
    
    sub build {
        my $self = shift;
        # and do all the stuff for a 4x8 card
    }
    
    # and so on, and so on...
    
    
    
    # at this point we have to think about groupings.... all TLC parts go
    # out in one XML file, and all DPI parts go out as separate orders; so
    # all DPI parts get individual XML files and TLC all go into one...
    
    # An idea occured to me after leafing through the Head First Design
    # Patterns book: use an iterator to iterate over all orders for
    # building; maybe another for moving (or none at all... moving the
    # built order doesn't really require accessing the order parts. It's a
    # cp -r.) Then an iterator for building the XML, and for shipping,
    # which will return... well, stuff to ship. Hrmm. Because it dawned on
    # me that I'm using Perl arrays, which is fine for the initial part,
    # but later an Iterator will work better because I have three parts
    # for DPI and one part for TLC that contains many parts.
    
    # So a given order can be viewed as a set of OrderParts: a print, a
    # mug, a card. The same order, once built, is then viewed as a set of
    # OrderShippingParts: prints, 4x8card, 5x7card, and all the chotchkes
    # that go to TLC. Each OrderShippingPart will need two helpers: an XML
    # builder class and an Uploader class.
    
    # Another option: after we've built and moved the orders, we don't
    # deal at all with the WholeOrder class anymore. We then are only
    # interested it the four shipping types. Not convinced though that
    # this approach is worthwhile.
    
    
    
    # and a base class for the parts of an order that ship...
    package OrderShippingPart;
    
    
    
    ###
    ### move build order
    ###
    package main;
    
    my @orders = $db->get_built_orders();
    
    foreach my $order (@orders) {
        $order->set_order_pending;
    }
    
    foreach my $order (@orders) {
     
        # return an array of references to subclasses of OrderShippingPart
        foreach my $order_shipping_part ($order->create_order_shipping_parts) {
            # TLC orders go to a web accessible directory, DPI to where they go now
            $order_shipping_part->copy_to_shipping_dir;
        }
       
        if ( $order->has_errors) {
            print "order had errors!";
        } else {
            $order->update_order_status;
        }
    }
    
    
    
    ###
    ### create xml for the order
    ###
    package main;
    my @orders = $db->get_moved_orders();
    
    foreach my $order (@orders) {
        $order->set_order_pending;
    }
    
    foreach my $order (@orders) {
    
        # I think it kind of makes sense to expose the OrderShippingPart
        # at this level... otherwise we wind up with another
        # overobfuscated code base like V3...
    
    
        foreach my $order_shipping_part ($order->make_order_shipping_parts) {
            $order_shipping_part->make_xml_file;
        }
    
        if ($order->has_errors) {
            print "order failed!";
        } else {
            $order->update_order_status;
        }
    
    }
    
    
    
    ###
    ### send to dpi or tlc
    ###
    package main;
    my @orders = $db->get_orders_to_ftp();
    
    foreach my $order (@orders) {
        $order->set_order_pending;
    }
    
    foreach my $order (@orders) {
    
        foreach my $order_shipping_part ($order->create_order_shipping_parts) {
            $order_shipping_part->ship_to_printer;
        }
        
        if ($order->has_errors) {
            print "order failed!";
        } else {
            $order->update_order_status;
        }
    }
    
    
    
    ###
    ### dpi has finished the order
    ###
    
    &process_dpi_xml(); # ???
    
    
    # $Log: LOG.txt,v $
    # Revision 1.1  2007/11/27 22:54:23  swain
    # Initial revision
    #
    # Revision 1.115  2007/11/27 22:14:20  swain
    # updating. ing. ing.
    #
    # Revision 1.114  2007/11/15 16:56:49  swain
    # updated: wrote up my work on refactoring and testing gallery
    #
    # Revision 1.113  2007/10/31 16:09:03  swain
    # notes on mpp
    #
    # Revision 1.112  2007/10/29 21:07:12  swain
    # updated
    #
    # Revision 1.111  2007/08/24 17:19:49  swain
    # changes from kristalle
    #
    # Revision 1.110  2007/08/20 20:08:40  swain
    # latest stuff
    #
    # Revision 1.109  2007/08/20 14:53:56  swain
    # Last commit before moving to torque, the new machine.
    #
    # Revision 1.108  2007/08/17 19:36:55  swain
    # updated
    #
    # Revision 1.107  2007/07/18 21:59:52  swain
    # hello, sailor!
    #
    # Revision 1.106  2007/06/11 20:45:10  swain
    # updated the typolesbianisms
    #
    # Revision 1.105  2007/02/23 16:06:17  swain
    # Updates to Thur 22 2007
    #
    # Revision 1.104  2007/02/10 22:41:36  swain
    # Most recent stuff.
    #
    # Revision 1.1  2006/08/31 20:03:02  swain
    # cleanup
    #
    # Revision 1.10  2006/08/04 18:36:59  swain
    # minor update
    #
    # Revision 1.9  2006/08/04 18:26:15  swain
    # Updated my notes.
    #
    # Revision 1.8  2006/08/03 19:51:39  swain
    # oops. wrong filename.
    #
    # Revision 1.7  2006/07/29 22:01:01  swain
    # Have the WholeOrder tell us the types.
    #
    # Revision 1.6  2006/07/29 21:05:05  swain
    # more refinements to the interfaces and examples
    #
    # Revision 1.5  2006/07/29 20:28:07  swain
    # renamed 'build' to 'create' for object creation.
    #
    # Revision 1.4  2006/07/27 23:41:20  swain
    # More refinement.
    #
    # Revision 1.3  2006/07/27 23:30:07  swain
    # threw out the idea of an iterator; not really necessary.
    #
    # Revision 1.2  2006/07/27 23:04:09  swain
    # Further refining of the interface
    #
    # Revision 1.1  2006/07/27 22:08:34  swain
    # A collection of thoughts and psuedocode on how the OFS will operate at
    # the high level. The four current scripts are represented here, and it
    # looks a lot like they will shrink to nearly nothing. I suppose in that
    # sense they will look very JeffO, but I hope to make the intentions
    # extremely clear (unlike V3).
    #
    
    
A technical question to answer:

1. Gallery has no osCsid, so it sets one via setcookie(). This value
   is gotten from the store code via Session::getSessKey().
2. In truth, subsequent actions by the user (adding stuff to cart)
   means we use the cookie to populate a Cart. The store's Session
   don't really enter into it.
3. Now they hit the store for the first time. There is an osCsid. But
   there is nothing in the session table for it. What does PHP do?

It needs to honor this cookie, creating a new (not logged in) session
in the database. The value of the cookie is the way we access the
shopping cart too. Carts need to be found by either the osCsid, or by
the customer ID. This way when they log out the cart remains and is
found again by the customer ID. Ferry then gets his logout stuff, we
get unique sessions for all time, and so on.

So the answer from the beginning is this: I am looking at refactoring
the Gallery AJAX code because it accesses the store code which is a
tangled mess that is hard to work with and understand. One primary
difficulty is the Cart and Session are the same thing in the same
table; if I can move to PHP sessions, then: the session table becomes
the Cart table, and everything kinda clicks into place.

So this probaby calls for some scratch refactoring. If this plan works
then all I'll need to do is Rename Table (osc_session_info =>
osc_cart, plus probably osc_customers_basket => osc_cart_contents, and
osc_customers_basket_attributes => osc_cart_contents_attribs).

So, unsurprisingly, by copying all the methods from Session and Cart
to outlet.php and renaming them, everything worked. Hrmm. It seems if
Gallery creates the new store session, it has to create a new cart (in
this case, a "session" which is really a cart due to the store's
design). No problemo. Now I need to see if PHP's sessions will honor
the cookie.

So yes, doing a test on swainstore.myphotodevel.com:


<?php
setcookie( 'swainID', md5(uniqid(rand(), true)), time()+60*60*24*30, '', 'myphotodevel.com' );
?>

Hello sailor! Need a date?

<?php

if ( isset($_COOKIE['swainID']) ) {
    echo "swainID is set.";
} else {
    echo "swainID is not set yet. Though we just called setcookie().";
}
echo "<p>\n";

?>
<a href="/checkcookie.php">checkcookie.php</a>


And:


<?php

session_name('swainID');
session_start();
$_SESSION['counter']++;
?>

Hello sailor! Need a date?

<?php

if ( isset($_COOKIE['swainID']) ) echo "Session id is set.";
echo "<p>\n";
echo $_SESSION['counter'];
?>


This does the right thing. This means I can switch the store to PHP
sessions, let Gallery set the cookie if there isn't one already (gotta
be careful there), and everything should be happy. One bad thing right
now is I have store code+sql in the outlet.php file. Gallery, however,
needs to be able to create a shopping cart if there isn't one.

Also: at this point I've totally isolated swain.myphotodevel.com and
swainstore.myphotodevel.com via the databases, though there is a risk
as I had to hardwire something into the AJAX stuff. (defining a
constant that is). So I can do heavy duty surgery without hurting
Fernando or Jessy.




#########################################################################
070201 Thu 01 Feb 2007 10:10:40 AM EST

Wrote a quicky hit counter on mdb-1 and ran a few log files through
it. Most interesting was:

/js.php: 74022
/view_photo.php: 72265
/images/spacer.gif : 48464
/helloworld.php : 42747
/view_album.php: 36999
/robots.txt : 12677
/ : 9116
/albums.php : 5373
/image_uploader3.php : 5181
/gifts/products.php: 4699
/images/new.gif : 4099
/favicon.ico : 4051
/images/bar.gif : 3466
/gallery_remote2.php : 3422
/mpa-slideshow.swf: 3410

js.php is dead; I deleted it a day or two ago. view_photo.php makes a
new store session if they don't have one; a waste. I am going to set a
cookie only, and create a cart only if they add something. All the
image requests are from www; emailed Ops/Chris saying we should move
that site to another server. Even worse, that's all served off the
shared storage.

I have almost got all the store code out of the old gifts project
(which is/was just DPI's cards). I'm pretty much down to a dependency
on ez_sql, which in turn needs the Log class.

I found all the calls for Session::getKey() (which is the osCsid
cookie) where completely superfluous. I factored all that out, got rid
of the calls to Util::quote with just addslashes(), and that pretty
much did it. Not much store code left; in fact who cares if it uses
Log and ez_sql? For now that's fine.




#########################################################################
070205 Mon 05 Feb 2007 12:24:04 PM EST

The move is more or less done. Not all of our stuff has been moved
down; magically, Lila is my closest neighbor. She's one of the
noisiest people in the office. It's WAY too bright in here. My
monitor's contrast is reduced by at least half. I lost my second
ethernet jack; there's an eight port hub sitting on my desk now so I
presume Chris plunked it there. But I'll just set up a firewire
connection betwixt the mini and the laptop if need be.

Going back to the store refactoring: I need to rename osc_session_info
to osc_cart or somesuch, and find/change all relevant references. No
biggie. I had a thought about creating a new project to hold the
common code for all projects; in particular I see the mysql session
stuff being reused here. Later, I suppose, things like the product
classes and the cart, but perhaps not. As a next step I think I might
try to add PHP native sessions to the store, but without CVS access I
don't know which files I've modified.

The big deal: I renamed the tables thus:

RENAME TABLE osc_session_info TO osc_cart;
RENAME TABLE osc_customers_basket TO osc_cart_contents;
RENAME TABLE osc_customers_basket_attributes TO osc_cart_contents_attributes;

This accurately reflects their usage. cart has one row to one or many
contents; which has one to many attribs. Now I need to merge Session
and Cart.

The Cart class is going to be huge. I will be merging in almost all of
the Session methods and then everything in
inc_shopping_cart_functions.php. This would suggest I need to break it
down further.

Just a guess, but maybe a Cart will have a CartContents class to help
it out; that class could manage the contents/attributes tables. Cart
will only ever care about/look at the osc_cart table. In fact, that
might better reflect the existing setup: Cart becomes CartContents and
Session becomes Cart.



#########################################################################
070206 Tue 06 Feb 2007 12:24:39 PM EST

Ran into a sticky problem renaming the column
osc_cart.session_info_id. The problem was, it was the primary key and
my ALTER TABLE statement did not preserve this.

OK, all the alterations appear to be done for now.

In a fit I changed outlet.php to use instances of Session and Cart,
and not call the methods statically. Remarkably it worked the first
time.

Done, kinda. All the methods that pertain to a cart are in the Cart
class; still some renaming to do, and the Cart class is kinda
humungous now. Found that $sess_info was defined in
application_top.php and used by lots of files, which strikes me as
bad; but then $session and $cart are as well, at the moment.

Ended the day with a meeting with Peter and Jessy; Peter is clearly
not interested in pursuing new features in MPA. He wants to know if it
would be good to put Tim back on myblogsite.com; after a phone call
with Tim I sent this memo around:

[snip]
Had an informal chit chat with Tim on MBS; here's the rundown:

It could probably be done in a "solid two weeks" of development
time. The coming two weeks, however, will see Tim doing lots of
painting and whatnot because he has to vacate his apartment by
February 28th. But he thinks optimistically MBS could be live by
middle of March, depending on whether Operations can provide the
things he needs (like a production environment, for one).

Before he was pulled into the ad serving stuff, he'd taken Jacob's
Pivot code for FC Free and removed all the hardcoded strings. Tim also
had set up a proper staging environment for FC Free, so the next step
is to roll the new Pivot out there, test, then roll it out to FC Free
and test. If that's all yay, then we're a lot closer to getting it
done.

There was an issue with the ImageMagick library for PHP not working;
perhaps it was the wrong library version. This is another thing for
Operations to solve.

Now. Tim has set up a myblogstage.com as well, with a database schema
and the whole nine; he feels he's 90% there with the "It's not a
signup wizard" signup wizard. If he recalls correctly, he needs some
images from Jessy to finish that up.

(This sums up my notes from our phone conversation).
[snip]


#########################################################################
070208 Thu 08 Feb 2007 11:02:58 AM EST

Primary was unable to test overnight because they couldn't reach the
database. Typically Chris put in a fix but didn't test to see if
things worked.

The other big issue is "unified login." The big motivator right now
seems to be: people stop dead when they have to create a new account
in the store to order prints. Why do we do this? They already created
an account with MPA. Well, because they are separate apps, is why.

All previous discussions were based on the "Zap-O-Matic" project that
was the brainchild of Rob Walker. That involved unifying not just the
MPA accounts, but also MyBlogSite, paid hosting and Fortunecity free
accounts. By comparison this would be a cakewalk.

Three types of users are involved here, perhaps four:

1. MPA site owner
2. Store customer
3. "Subuser" of an MPA site
4. Anonymous user (i.e. can buy stuff without creating account)

One roadblock we saw in our phone call (me and Tim) was
ampira.redirect.php. So the time and effort of working around that
could be considerable.

We go from a Perl signup CGI to the PHP site; so somehow we have to
log them in without storing or showing the password.

There are other places where ampira.redirect.php is used and would
have to be removed. I'd have to find where...

Well. We put it in emails, so that would kill that off.

Provisioning would be affected: when the site is created, we add the
password to the user file. Now, in truth, this would go away with
unified login, but would be a problem during the transition.

One approach to provisioning: on activation, set a cookie and create a
new row in the mpa session database.

Password encryption and validation is done entirely from within
OSC. No MySQL functionality is used (i.e. the MySQL password()
function).

Subusers: this data has to be extracted via Veracity, visiting every
site and building lists of all the users. We could, for a time,
disallow creation of subusers while we transition to having all users
in the database.

In order for users to login to their MPA site and also be logged into
the store, we face a problem with sessions. Currently, you login to
yoursite.myphotoalbum.com and you have a session in the MPA session
database for that subdomain. When you log into the store you have
another session under another cookie for the domain
store.myphotoalbum.com. One answer is: you no longer see the domain
store.myphotoalbum.com; when you are in the store you still see
yoursite.myphotoalbum.com.

I think this is going to be the only way to do it. If you are logged
into yoursite.myphotoalbum.com, and then go login to
mysite.myphotoalbum.com, you now have two sessions with us and
(theoretically) two store sessions under the different subdomains. So
you cannot order prints from both at the same time, can you? Even if
you don't login to mysite.myphotoalbum.com, how will adding prints to
your cart work?

If you are a subuser of mysite.myphotoalbum.com, then perhaps you are
already logged into the site. This causes permissions problems though
so we enter the whole realm of user permissions. That is, in the
database we somehow have to honor the fact that you are admin of
yoursite.myphotoalbum.com and a read-only user of
mysite.myphotoalbum.com. Since these are physically separate accounts
currently, we'd have to devise some scheme to hold permissions per
site.

Quick sketch:


You login to yoursite; you are logged into the store
you add photos to your cart
you surf over to mysite from 'favorites'
you are already logged in as a subuser because I added you... can
mysite see your yoursite cookie?

no.

So the only answer is: a myphotodevel.com cookie for all sites. You
log in to myphotodevel.com, you have a store account, your site, and
perms on other sites to do various things.

Perhaps, then, when they change sites the first time they hit it we
will have to query for their perms and store that in the session.


We currently do not do wildcarding for https. I hope that it's as
straightforward to do as it is with http and apache 1.3.

Account reconciliation: We have users with accounts in both MPA and
the store; probably most of those who've bought. We have users only in
MPA and users only in the store. And we have users in both but use
different email addresses.

A whole program of reconciling the accounts is probably
necessary. Login to MPA, and be prompted for your store account; log
into the store and be prompted for your MPA account? That might be
messy. We might never get all the accounts reconciled, so we might
forever have osc_customers and users in addition to a new mpa_users
table. (Jessy has a spec of this in Twiki).

Which brings up other duplicate data: addresses are stored in both
applications, or some fraction thereof. Some of it is display data in
MPA, and for the store it was never meant to be displayed. In
particular, first name, last name, city, state and zip code are
duplicated.

Can cookies be seen across https and http? I think they can. Yes, says
an O'Reilly page.

---

Spent a couple hours hacking/testing Veracity to pull all subuser data
into the database; just a quick and dirty job to see the data. No
indexes, no nothing... just import all the data into a simple
table. The data is REALLY skanky: missing names, missing email
addresses (tested this, yes, Gallery does not require an email
address), mixed case usernames, mixed case email addresses. I'm
guessing now there's 30,000 subusers.

I only ran 5 copies at a time to minimize the impact but it's sailing
along pretty fast. Should be done well before midnight.


#########################################################################
070209 Fri 09 Feb 2007 10:22:15 AM EST

Well, 17,400 subusers. I was over in my estimate, but then, not by a
lot (I guessed 20K).

There is a lot of skanky data in there: mixed case usernames, mixed
case email addresses, no email address, no full name, usernames less
than five chars long, and of course the email addresses might be
invalid. Some users created subuser accounts but put their own email
address in the email address field.

The job of reconciling these accounts with the users table is probably
not worth the effort. Not unless we have a clear plan (i.e. some
social networking thing). Peter's mood, as of late, indicates he's not
interested in doing much more with MPA.

2,681 subusers have no email address.
6,863 have mixed case usernames. Usernames are case sensitive (user
  SteveW cannot login with 'stevew').
3,553 have usernames shorter than five characters.
645 email addresses have mixed case.
2,407 sites have 2 or more subusers.
6,373 have never logged in.

+-------------+-----------------------------+
| year_active | count(year(lastActionDate)) |
+-------------+-----------------------------+
|        2004 |                         165 |
|        2005 |                        7197 |
|        2006 |                        8101 |
|        2007 |                        1937 |
+-------------+-----------------------------+

select date_format(lastActionDate, '%Y-%m') as yearmo,
count(date_format(lastActionDate, '%Y-%m')) as num_users from
mpa_subusers group by yearmo;
+---------+-----------+
| yearmo  | num_users |
+---------+-----------+
| 2004-04 |         2 |
| 2004-05 |         1 |
| 2004-06 |         1 |
| 2004-07 |        20 |
| 2004-08 |        12 |
| 2004-09 |        15 |
| 2004-10 |        20 |
| 2004-11 |        38 |
| 2004-12 |        56 |
| 2005-01 |        91 |
| 2005-02 |       118 |
| 2005-03 |       318 |
| 2005-04 |       306 |
| 2005-05 |       377 |
| 2005-06 |       500 |
| 2005-07 |       569 |
| 2005-08 |      1250 |
| 2005-09 |      1143 |
| 2005-10 |       892 |
| 2005-11 |       882 |
| 2005-12 |       751 |
| 2006-01 |       771 |
| 2006-02 |       570 |
| 2006-03 |       639 |
| 2006-04 |       560 |
| 2006-05 |       662 |
| 2006-06 |       618 |
| 2006-07 |       728 |
| 2006-08 |       808 |
| 2006-09 |       747 |
| 2006-10 |       586 |
| 2006-11 |       733 |
| 2006-12 |       679 |
| 2007-01 |      1299 |
| 2007-02 |       638 |
+---------+-----------+

 select thecount as numusers, count(thecount) as sites_with_that_many
 from (select subdomain, count(subdomain) as thecount from
 mpa_subusers group by subdomain) as foo group by thecount order by sites_with_that_many desc;
+----------+----------------------+
| numusers | sites_with_that_many |
+----------+----------------------+
|        1 |                 2643 |
|        2 |                  813 |
|        3 |                  438 |
|        4 |                  240 |
|        5 |                  150 |
|        6 |                  115 |
|        7 |                  107 |
|        8 |                   76 |
|        9 |                   67 |
|       10 |                   54 |
|       11 |                   51 |
|       12 |                   44 |
|       13 |                   34 |
|       14 |                   25 |
|       16 |                   23 |
|       20 |                   21 |
|       17 |                   16 |
|       15 |                   11 |
|       21 |                   10 |
|       25 |                   10 |
|       19 |                   10 |
|       22 |                    8 |
|       26 |                    8 |
|       18 |                    7 |
|       27 |                    6 |
|       24 |                    5 |
|       28 |                    5 |
|       29 |                    4 |
|       23 |                    4 |
|       34 |                    4 |
|       30 |                    3 |
|       35 |                    3 |
|       38 |                    3 |
|       55 |                    3 |
|       33 |                    3 |
|       32 |                    3 |
|       57 |                    2 |
|       56 |                    2 |
|       31 |                    2 |
|       64 |                    2 |
|       50 |                    2 |
|       36 |                    1 |
|       96 |                    1 |
|       63 |                    1 |
|       53 |                    1 |
|       43 |                    1 |
|       65 |                    1 |
|       74 |                    1 |
|       42 |                    1 |
|       41 |                    1 |
|       45 |                    1 |
|       49 |                    1 |
|       39 |                    1 |
|       54 |                    1 |
+----------+----------------------+

---

Voice: (You don't have time for this. You must destroy the Hoover Dam. It is your destiny.)
Space Ghost: What if I get caught?
Voice: (You're Space Ghost, superhero to millions. Who would suspect you?)
Space Ghost: Yeah, I am Space Ghost. It's my destiny.
Voice: (You better hurry up!)
Space Ghost: What about my pants?
Voice: (What?!)
Space Ghost: My, my, my pants.
Voice: (Your pants are fine. Hurry!)
Space Ghost: Let me just say goodbye to Charlton, okay?
Voice: (Uh uh! Someone's going to beat you to it!)
Space Ghost: All right, all right! (aloud) Uh, Charlton, I gotta go. Pick up the kids. Who are, nnnot in Nevada.
Charlton Heston: Okay, Space Ghost. (waves) Absolutely.

---





#########################################################################
070210 Sat 10 Feb 2007 11:30:27 AM EST

I have already solved the problem I meant to solve when I came in this
lovely, not quite so chilly Saturday. If you delete a cookie you
cannot redirect them, it seems; the redirect causes the cookie to be
set again, or never unset or something. I now see more clearly than
ever the terrible flaw in Trevor's design: making the cart the
session.

I think my next step is to define Coupon and/or Offer classes and
migrate the code to them. Looks like pretty much everything prefixed
with offer_.

The previous cart is selected via customers_id, so that's good. I can
probably change Trevor's code to empty out the sess_key field
completely.

A coupon is indeed an offer:

mysql> select * from osc_coupon_codes limit 1\G
*************************** 1. row ***************************
 coupon_code_id: 2
       offer_id: 36
validation_code: mfixolvq
   uses_allowed: 1
      uses_done: 0
    used_amount: NULL
      used_date: NULL
         userid: 142825
      subdomain: testdriven
    expire_date: 2006-05-15 16:24:24
1 row in set (0.00 sec)


mysql> select * from osc_offers where offer_id=36\G
*************************** 1. row ***************************
              offer_id: 36
                  type: F
                  code: ae519a
                amount: 3.1500
         minimum_order: 0.0000
            start_date: 2005-09-29 00:00:00
           expire_date: 2018-09-29 00:00:00
       uses_per_coupon: 0
         uses_per_user: 0
  restrict_to_products: 
restrict_to_categories: 22
 restrict_to_customers: NULL
      joined_startdate: 0000-00-00
     joined_finishdate: 0000-00-00
            auto_apply: 0
        partial_redeem: 0
       grant_on_signup: 0
                active: Y
          date_created: 2006-08-16 17:19:59
         date_modified: 2006-08-16 17:19:59
1 row in set (0.00 sec)

So the coupon table really exists just to hold many copies of one type
of offer.



On signup, here's how the coupon is created:

./lib/db-lib.pl:	my $sth = $dbh->prepare("insert into osc_coupon_codes(offer_id,validation_code,userid,subdomain,expire_date) values($signup_offer_id,'$validation_code',$userid,'$username',sysdate() + interval $signup_offer_period day)");

---

Wow, fast work. Got the whole library of offer functions into a new
Offer class, and converted all calls to static method calls.

foreach $function (<DATA>) {
    chomp $function;
    $static = $function;
    $static =~ s/offer_/Offer::/;
    print "function $function to $static\n";
    $findcommand =  "find . -name \\*.php | xargs grep -l $function | grep -v inc_offer_functions.php";
    print "$findcommand\n";
    open POPE, "$findcommand |" or die $!;
    @files = ();
    while ( $file = <POPE> ) {
        print $file;
        push @files, $file;
    }

    foreach $file (@files) {
        chomp $file;
        print "s/$function/$static/g on $file\n";
        system("perl -pi -e 's/$function/$static/g' $file");
    }
}


Where <DATA> returned all the function names...

I think I need an OfferFactory class, which can create the correct
Offer type (Promotion?) based on whether there's anything in the
osc_cart table or not. That is: regardless whether this is an offer,
coupon, gift certificate, etc. the Factory returns the correct thing
and We Don't Care what it is. It's a Promotion. Or a Discount or
whatever it gets named in the end.

---

Wow. All done, really: all calls to Cart are done via
$cart->somemethod(); all calls to the new Offer class have moved into
the Cart; the cart holds an instance of Offer and all Offer's methods
are called as $this->someOfferMethod(). Dunno if I coulda hoped to get
this far today but it's a huge win.

Probably next thing to do is work out an Offer factory and make that
abstract in the Cart.



#########################################################################
070212 Mon 12 Feb 2007 10:27:13 AM EST

PHP 5.2.1 out, Chris compiling. Could still smell paint when I went
home on Saturday; wound up staying in all weekend save for working
Saturday and going to the diner on Sunday afternoon.

Been finding strange bugs today; I suspect Chris's upgrade to PHP
5.2.1 this morning. I sent him response headers of staging vs. spork
and the connection: close on spork looks fishy.




#########################################################################
070213 Tue 13 Feb 2007 11:40:10 AM EST

Promised Chris a bottle of Jameson's if he gets Zend Studio working on
spork. I'd love to have that profiler. Never did look to see if
Eclipse has a profiler for PHP; gotta skim the IBM developerworks
article. Don't think it does.

Whether or not I use a Decorator pattern for offers -- not sure I need
to -- I was thinking the store might be best served as a series of
events, each event with observers. Even that might be overengineering
though. The store is quite procedural though, leading to a spaghetti
like quality.

It's freaking hot in here. Matt already spilled coffee on the
floor. Over by the windows it's quite comfortable.

So I've been sketching designs, and met with Jessy and then Matt to
cover a variety of coupons or offers they might want to do in the
future. I think we have a pretty comprehensive set for now. The reason
the Decorator pattern came to mind is: each rule ("Order subtotal over
$100") can be an individual class; an Offer has a set of rules that
work as a Decorator pattern, which is a sorta recursive thing. So does
the Offer apply to the contents of the Cart?

// if we are given a coupon code:
$cart->validateDiscountCode($somecode); // if true, Cart hasa Discount

// at purchase time:
if ($autocoupon = $cart->orderQualifiesForFutureDiscount()) {
   $autocoupon->save(); // write it to the osc_auto_coupons table
}

// in _updateCart():
$cart->applyOffers();

    function applyOffers() {
        if ( $coupon_code_id = $this->getValidatedCouponCodeID()) {
            $this->offer->applyCoupon( $coupon_code_id);
        } else if ( $offer_id = $this->getValidatedOfferID()) {
            $this->offer->applyOffer($offer_id);
        } else {
            $this->offer->applyAutoCoupons();
        }
    }

This method might be rewritten slightly... the Cart will get a
DiscountFactory, which will return either an Offer, Coupon or
Autocoupon. Cart will do something like:

$discountfactory = new DiscountFactory($this);
Discount $discount = $discountfactory->validateCode($discount_code);
$this->applyDiscount( Discount $discount );
// or maybe:
$discount->applyToCart($this);

DiscountFactory might discover an AutoCoupon (we don't care); as I
said, the Discount returned might be Offer, Coupon or Auto.

Now on to the rules. The rules could be a set of subclasses of
Discount, each with one method of importance: qualifies() or
somesuch. Returns boolean.

Let's say we have a Coupon: 50% off first 100 prints for club
members. The rules go something like this:

1. Hasn't used it yet
2. Has 100 or more prints
3. Is a club member
4. Not expired
5. Not used up (the Coupon still has value)

Since there are a lot of rules, we can construct the Coupon's rules at
runtime based on a list. I see now that certain rules always apply:
hasn't expired, hasn't been used, hasn't been used up.

The other dimension lies in what's to be discounted:
one, more or all products
a category
shipping
tax

Perhaps each Discount hasa DiscountType class, which knows what to
discount in the Cart?

$cart->applyOffer($discount);
function applyOffer(Discount $discount) {
    // Discount hasa WhatToDiscount: subtotal, shipping, tax?
    if ( $discount->appliesTo($this) ) {
        $this->discount( $discount->type );
    }
}

// I'm a little fuzzy here but this is close
function discount(WhatToDiscount $type) {
   UPDATE osc_cart SET $type->columnname = $type->somevalue
   WHERE cart_id = $this->cart_id;
}

in the Discount subclass:

function appliesTo(Cart $cart) {
   return $this->ruleset->isValid($cart);
}

ruleset would be an array() of Rules, each a subclass of... well. they
don't have to be a Discount, do they? The pattern would hold I think.




Steve Wainstead: chrisatfcity: [root@spork ~]# cat .bash_logout 
# ~/.bash_logout

clear

touch CHRIS_FERRY_SUCKS_PENIS_JUICE_ALL_DAY
Steve Wainstead: that would be Jacob
chrisatfcity: yep.
chrisatfcity: was ticked because I saw that file and thought there might be an issue.
polandspringln12: hahahaha
polandspringln12: thats awesome
Steve Wainstead: 
Steve Wainstead: didn't i tell you about the .bash_logout file?
polandspringln12: yeah i think you suggested i do that



#########################################################################
070214 Wed 14 Feb 2007 10:01:30 AM EST

Mail down this morning; disk space used up. Ops didn't know  until
Nathan came in and I told him. Brian emailed his report last night, at
long last. Reads very bureaucratic.

So in principle, the Decorator approach works. I whittled it down to a
tiny abstraction; a given class looks like:

class MeetsSubtotalMinimum extends CartDiscountDecorator {
    function __construct(Cart $rule) { parent::__construct($rule); }
    function myrule(Cart $cart) { return $cart->subtotal >= 100.00; }
}

where the parent class is:

class CartDiscountDecorator extends Cart {
    
    protected $nextrule;

    function __construct(Cart $rule) {
        if (! is_object($rule)) die("Didn't get a FDD\n");
        $this->nextrule = $rule;
    }    

    function applies(Cart $cart) {
        return $this->nextrule->applies($cart) && $this->myrule($cart);
    }

    function myrule(Foo $foo) { die("Cannot call base clase's myrule()\n"); }
}


I build the "discount" ruleset this way:

$rules = array();
array_push($rules, "MeetsSubtotalMinimum");
array_push($rules, "IsInUnitedStates");
array_push($rules, "HasEnoughPrints");



$ruleset = new $rules[0](new NullCart());

$numrules = count($rules);
for ($i = 1; $i < $numrules; $i++) {
    $ruleset = new $rules[$i]($ruleset);
}

$cart = new Cart();
if ($ruleset->applies($cart)) {
    print "Success!\n";
} else {
    print "Failure!\n";
}


So it's all hidden away... but I'm not convinced of the utility of it
at this point, and I need to take it to the next level: setting the
values for the rules themselves (i.e. printquantity >= N, where N is
passed into the constructor).




#########################################################################
070215 Thu 15 Feb 2007 02:01:34 PM EST

Where is the day going? Gotta get on things.

Found $_SERVER['REQUEST_TIME'] by sheer chance today, which does
exactly what I want: records the time of the initiation of the
request. Been working that into Gallery. Already extended the
mpa_photos table.

Well. Another day down the drain. Been getting pulled into 3
directions all day. Chris with his optimizations and load testing,
Jessy with TLC shipping and broken AJAX, and Fernando to a lesser
extent. I finished my work on upload stats and sent an email around.





#########################################################################
070217 Sat 17 Feb 2007 02:24:48 PM EST

Came in around 11am, starting moving methods, and got in a tangle. I
can see now the admin interface is broken again; I got sidetracked
into mucking with club membership code when I should be sticking to
Discount and its subclasses.

Two days ago when I turned on my external drive it made horrible
noises: it was the fan. I've not shut it off since then. I think that
might have been the first time the fan worked though. The case is
still very warm to the touch but seems less so.

I applied for a new project on SF for lhhrerun.pl. I'll have to rename
it again to lhhreplay.




#########################################################################
070220 Tue 20 Feb 2007 02:48:24 PM EST

Just had a go-around with Ferry again over mpa_albumitems. I really
don't wanna rebuild it. It's a PITA and it always ends up being
rebuilt again. I dunno. Maybe that's the way to look at it?
Periodically rebuilding it might be a way of life.

Been toying with one thing or another today, not willing to plunge
back into the store code. I ran upload_orders.pl through the Perl
debugger to see why image uploads take ten seconds; definitely a
networking issue.

So it turns out I still have a ton of static method calls in the Cart
class on the Session class. I was blindly changing them and my tests
were crashing down all around. Wound up completely reverting the
files.




#########################################################################
070222 Thu 22 Feb 2007 01:34:48 PM EST

Spent the morning working with Fernando trying to diagnose the problem
with ampira.redirect.php. We finally narrowed it down to a PHP 5.2
issue after Chris compiled/installed PHP4 on spork for us, and the bug
went away.

As a last ditch effort Fernando wrote a second redirect, and this
kludge works. We're going to go with it for now.




#########################################################################
070226 Mon 26 Feb 2007 11:11:44 AM EST

Been neglecting my log again.

Chris cut over to mdb-1 on... Friday? And he didn't edit the
store.conf file, only gallery.conf. So DB errors were spilling all
over user's browser panes, showing the db username/password; so he had
fits about this and sent around a very insulting email. I pleaded
privately with Nathan to set up a runbook page on switching databases
and everything that needs to happen. Told him I'd give him a six pack.

Late on Friday I was single stepping through Gallery trying to solve
the issue with the session. When you hit ampira.redirect.php the first
time, for some reason session data is never passed into the
sessionWrite() function. It looks like a PHP bug.

Last week I did nothing for promotions... though it was a four day
workweek, so what the hay.

Ran the skin count for Jessy. I think the numbers are still dismal,
for all the work she puts into skins; about a third of our users
change their themes.




#########################################################################
070227 Tue 27 Feb 2007 11:31:13 AM EST

I keep feeling the need for TDD while developing the discount
system. It's proving much harder to develop than I thought, and this
is largely due to PHP5's OO behavior.


#########################################################################
070228 Wed 28 Feb 2007 11:42:37 AM EST

HOST=`basename $0`
ssh -C -c blowfish -t bastion.fortunecity.com "ssh -C -c blowfish
$HOST"

Chris thinks I found a way to solve the uploading problem (using
upload.mpa.com and honor the security para-diggum) by using a
different port number: 

http://swain.myphotoalbum.com:8080/image_uploader3.php?etc.etc.

and I guess the load balancer thingie can map that to another
server. Whether this allows us to solve the whole problem or not, I
dunno.

KENtucky [to Wainstead \]: I knew someone here invented the handle, but I didn't know if she 
actually used it.  that's awesome. :)
tiResias [to tiResias]: you made the right choice in calling a plubmer
tiResias says, "as judged by the grunting & swearing"
draco [to tiResias]: you're good enough, you're smart enough, and dog-gonnit, people like you!
Wainstead \ | typolesbo: just thuoght mabe it was a new ff weeror
xorian [to Wainstead \ and KENtucky]: At the risk of being immodest, I believe I was the one that 
first came up with her handle
Wainstead \ | typolesbo: which I thought is agoo sign
phealy [to xorian]: what handle?
phealy says, "typolesbo? :-p"
Wainstead \ | typolesbo: dont know if there's a differnce! '=_
tiResias [to xorian]: you work in technology, you're supposed to be immodest and brash. and the 
fact that you inveted the handle should be the defining moment of your life to date ;)
Wainstead \ | typolesbo: wha ate salad cheeses
Wainstead \ | typolesbo: ffrom yyou riema
heller . o O ( damn that wha guy. . .eating all the cheeses for your salad.  )
Wainstead \ | typolesbo: but the dev blok is fucied up
Wainstead \ | typolesbo: but I think they are suing that file
Wainstead \ | typolesbo: because we have a "MOST POPULAR"SEDION
Wainstead \ . o O ( yes we do! )
Wainstead \ | typolesbo: but it was ponking on vista
Wainstead \ | typolesbo: but it as a bad am!
heller [to Wainstead \]: you need feed that off to a web page and put gooogle ads on it. 
Wainstead \ [to heller]: it would crash their keyword matching algorithm.
draco says, "typolesbo moonlights as a random bayesian filter text bypasser spam generator, 
doesn't she"
articulately, merlin laughs
heller [to Wainstead \]: and thus hilarity ensues. 
Wainstead \ | typolesbo: werdly i hade it
Wainstead \ | typolesbo: it was just a phphph
[Type lines of input; use `.' to end or `@abort' to abort the command.]
>> Command Aborted <<
heller says, "yes it was. . ."
Wainstead \ | typolesbo: mp nrpcco;
You say, "translation: "no broccoli""
Wainstead \ | typolesbo: i think he's in the converence room
KENtucky [to draco]: ahahahha
KENtucky [to draco]: btw, http://news.yahoo.com/s/wlwt/20070228/lo_wlwt/11135293 ...
Wainstead \ | typolesbo: if orfogot what it was called
You say, "that was february 2007."




#########################################################################
070301 Thu 01 Mar 2007 01:13:00 PM EST

Blew up at Chris again. But first:

http://slim.deasil.com/~swain/screencaps/frozenapplet.png

I am running a test with the Java applet, uploading my entire iPhoto
library. Like 12000 photos. The applet interface froze around 3,347,
but according to the database the uploads are continuing.

Go figure:
http://slim.deasil.com/~swain/screencaps/frozenappletunfrozen.png

The applet unfroze.

Heh:

[spork unix-bin]# ./removeaccount.pl bigone "test data"
sh: /bin/mv: Argument list too long




#########################################################################
070302 Fri 02 Mar 2007 12:09:27 PM EST

Finally created a little stored procedure to speed up my work:

DELIMITER $$

DROP PROCEDURE IF EXISTS flushcarts $$

CREATE PROCEDURE flushcarts()
BEGIN

DELETE FROM osc_cart;
DELETE FROM osc_cart_contents;
DELETE FROM osc_cart_contents_attributes;

END$$

DELIMITER ;

Trying to wrap my head around the multi-table delete statement:

DELETE 
      osc_cart_contents, 
      osc_cart_contents_attributes
FROM 
      osc_cart_contents, 
      osc_cart_contents_attributes
WHERE osc_cart_contents.cart_id = " . (int)Cart::getId() . "
  AND osc_cart_contents.cart_contents_id = osc_cart_contents_attributes.cart_contents_id";

Here's what I want: delete from osc_orders_offers where customers_id=2
in osc_orders:

DELETE osc_orders_offers 
FROM osc_orders_offers, osc_orders 
WHERE osc_orders_offers.orders_id = osc_orders.orders_id 
AND osc_orders.customers_id=2;

UPDATE osc_coupon_codes
SET uses_done=0,
    expire_date = date_add(now(), interval 1 year)
WHERE validation_code='qqqqwwww';

Bully! It all seems to work.

---

Got two helper classes underway today to thin out all the
responsibilities of the Cart class. I think there really won't be a
way to reduce the class's interface, though; there will be a lot of
methods, but a lot of them will just make calls on some other
object. In this way the Cart will be a Facade sort of pattern.

Hmm. How to tell a coupon from an offer? By the code. In the cart
class there is confusion possible because it goes by the unique ID
from the given table (coupon or offer tables); well, screw that. Why
don't we just store the "promotion code" and let the DiscountFactory
figure out wtf it is? Seems simpler to me.


#########################################################################
070306 Tue 06 Mar 2007 09:41:02 AM EST

AIM IM with chrisatfcity.
9:35 AM
chrisatfcity: so sub-albums are in the photos.dat?!
Steve Wainstead: correct
Steve Wainstead: you and i went over this in detail before
chrisatfcity: nope
Steve Wainstead: the only way to find out if an album has subalbums is to iterate over all the photos
Steve Wainstead: your reaction was OMG THAT SUCKS
Steve Wainstead: we went over this ... actually i can probably check my work log
Steve Wainstead: but you were made full aware of it in the past
chrisatfcity: unaware of that,.
Steve Wainstead: no, you forgot 
Steve Wainstead: which is endemic with pot smokers 
chrisatfcity: only while smoking
chrisatfcity: well now out system can scale toa whjopping 30 concurrent connections
chrisatfcity: woohoo!
Steve Wainstead: huh?
chrisatfcity: memory_limit=256M
Steve Wainstead: for php or apache?
chrisatfcity: so we give 512 to the OS
chrisatfcity: leaves us with 6 MAX'd out php processes per server.
chrisatfcity: I've got to lower the max concurrent apache conns as well
chrisatfcity: if we ever have a user who is massively popular with a large amount of photos we'll likely bring down the whole system
Steve Wainstead: you're so mellowdramatic
Steve Wainstead: your other choice is to keep it at 64MB
Steve Wainstead: let the users suffer
Steve Wainstead: as they currently were doing
Steve Wainstead: and make the case to peter that it's more important for me to work on that problem -- which would involve rewriting the underlying storage for gallery -- than to work on the store and promotions
Steve Wainstead: which he would never go for
Steve Wainstead: it would be cheaper to add more front end servers for the time being
chrisatfcity: duct tape spit and glue
Steve Wainstead: well, you want a fix... try compiling sqlite into php for me
Steve Wainstead: because that's the way it's gonna get solved
chrisatfcity: nope
Steve Wainstead: the only way we'll ever migrate the data to mysql
Steve Wainstead: is by making baby steps
chrisatfcity: you should not have to load all photos to have an album drop down
Steve Wainstead: we can't do one huge monumental fucking project
chrisatfcity: sub aalbums should be kept in the albums.da file...
Steve Wainstead: actually, when your data is stored in serialized objects, chris... there is no other way
chrisatfcity: no comprende
Steve Wainstead: they are in albums.dat
Steve Wainstead: all subalbums are in albums.dat
Steve Wainstead: but they look like any other album
9:45 AM
chrisatfcity: they don't have a parent album field?
chrisatfcity: let me guess they store that in photos.dat
Steve Wainstead: nope. that's stored in the object. albumdb.dat contains a list of albums,, nothing more
Steve Wainstead: we've had this conversation before
chrisatfcity: well then why is photos.dat necessary to load then?
Steve Wainstead: this is not deja vu. this is deja suck.
chrisatfcity: if sub albums are in albums.dat
Steve Wainstead: because... albumdb.dat lists all albums, but says nothing about them. properly generic.
Steve Wainstead: abnd
Steve Wainstead: and
chrisatfcity: ok so why not list the albums generically in the drop down?
Steve Wainstead: album.dat contains metadata about the album. nothing more.
chrisatfcity: do we really need to have them indented?
chrisatfcity: risk a stable scalable architecture for eye candy
Steve Wainstead: and photos.dat holds all the albumitems. and that's how youfind the subalbums. but you knew this already.
chrisatfcity: I actually didn't
Steve Wainstead: well... frankly that's anothe solution
Steve Wainstead: i wonder if there isn't another way: if the album.dat file contains the parent album
Steve Wainstead: then we could just load all the album.dat files and build a tiny tree
Steve Wainstead: i'll have feranndo work on it
chrisatfcity: thats what i was saying !!
Steve Wainstead: dunno if hte data is there though
Steve Wainstead: and if it' snot
Steve Wainstead: then this won't work
Steve Wainstead: we could try to do it "gonig forward" but
chrisatfcity: just pass false to the load command
Steve Wainstead: all existing sites already lack this info
9:50 AM
chrisatfcity: loading emodelsil using over a 100+ megs for a single process
chrisatfcity: mapped: 153824K writeable/private: 108688K shared: 33756K
Steve Wainstead: yeah


AIM IM with typolesbo.
9:41 AM
Steve Wainstead: i'm picturing you, me and chris as little kids. kind of cartoon-like
Steve Wainstead: and the three of us are playing together in a sand box
typolesbo: ....
typolesbo: and...
typolesbo: i'm wearing a teaira
Steve Wainstead: and chris draws a line across the middle and says this side is mine!
typolesbo: right?
Steve Wainstead: and you and i say: but if the three of us share the sand box, we can build a really cool sand castle
typolesbo: so he's complaining about the call i just made
Steve Wainstead: yeah i know
typolesbo: (i'm guessing)
typolesbo: he doesnt want me to make the decision
typolesbo: but his only solution to everything is more work for everyone but him
typolesbo: and i'm saying...
typolesbo: let's test
typolesbo: and make sure you are right
typolesbo: we'll know fast
typolesbo: before we take on gold plateing work
Steve Wainstead: yeah
typolesbo: that's ALL im saying
9:45 AM
Steve Wainstead: so now we're making him share the sandbox and build the castle
Steve Wainstead: and what he really wants to do is take his pale and shovel and go home
typolesbo: yep
typolesbo: he's really not a team player
Steve Wainstead: Steve Wainstead: well, you want a fix... try compiling sqlite into php for me
Steve Wainstead: because that's the way it's gonna get solved
chrisatfcity: nope
Steve Wainstead: the only way we'll ever migrate the data to mysql
Steve Wainstead: is by making baby steps
chrisatfcity: you should not have to load all photos to have an album drop down
Steve Wainstead: we can't do one huge monumental fucking project
chrisatfcity: sub aalbums should be kept in the albums.da file...
Steve Wainstead: actually, when your data is stored in serialized objects, chris... there is no other way
chrisatfcity: no comprende
Steve Wainstead: they are in albums.dat
Steve Wainstead: all subalbums are in albums.dat
Steve Wainstead: but they look like any other album
typolesbo: got it!
typolesbo: i understand
typolesbo: his answer is just
typolesbo: its done wront
typolesbo: with no other reason
typolesbo: beucase he doesnt get it
typolesbo: well
typolesbo: the mail is done woring
typolesbo: cuase he
typolesbo: doesnt always have it running
typolesbo: he did his job wrong


---

Sent a detailed email to fcdev/Chris/Jessy. I'm asking Fernando to
investigate whether we can build the album dropdown without searching
all the albumitems.

Couldn't remember what tools I wrote last week; I wrote a couple
stored procedures to make my work easier. Huh! I must have made a
rmcust procedure long ago:

mysql> show create procedure rmcust\G
*************************** 1. row ***************************
       Procedure: rmcust
        sql_mode: 
Create Procedure: CREATE DEFINER=`root`@`localhost` PROCEDURE `rmcust`(email VARCHAR(96))
BEGIN
        DECLARE custid INT(11);
        SELECT customers_id into custid from  osc_customers where customers_email_address=email;
        SELECT concat('customer id: ', custid);
        delete from ofs_orders_parts_status where orders_id in (select orders_id from osc_orders where customers_id = custid);
        delete from osc_orders_products where orders_id in (select orders_id from osc_orders where customers_id = custid);
        delete from osc_orders_products_attributes where orders_id in (select orders_id from osc_orders where customers_id = custid);
        delete from osc_orders_total where orders_id in (select orders_id from osc_orders where customers_id = custid);
        delete from osc_orders_status_history where orders_id in (select orders_id from osc_orders where customers_id = custid);
        delete from osc_orders where customers_id = custid;
        delete from osc_session_info where customers_id = custid;
        delete from osc_address_book where customers_id = custid;
        delete from osc_customers_basket where customers_id = custid;
        delete from osc_customers where customers_id = custid;
END
1 row in set (0.00 sec)


You can list procs by doing SHOW PROCEDURE STATUS. I recall writing
the SQL for rmcust(email) some time ago (May 2006 says the database)
but I don't recall wrapping it into a stored procedure. Very slick. If
I ever refactor lhhreplay.pl properly... I can write a custom script
that tests store signups repeatedly.




#########################################################################
070307 Wed 07 Mar 2007 05:25:31 PM EST

I'll have to start tagging the OFS at the top level now, in
order_fulfillment. I really should separate it into a separate
project.




#########################################################################
070308 Thu 08 Mar 2007 10:23:29 AM EST

Had coffee today. McDeathknell's had an offer of a free small coffee.

Yesterday I threw out a lot of the TLC crap for the OFS. I didn't
throw out (move to the attic, really) the TLC_OrderShippingPart.pm
yet... I suppose it's inevitable... and I have to develope a database
patch to remove all the TLC products from the products tables.

I finally moved my HOWTO thingie from July 20 2006 to Twiki. It's a
comprehensive, if a bit obtuse, to-do list on adding a product to the
store. I guess I'm trying to put a project plan together for Fernando
so he can handle the whole conversion to District.




#########################################################################
070309 Fri 09 Mar 2007 02:22:55 PM EST

I probably have this elsewhere in this log, but since I looked it up
yet again... this is how to set the hostname but call a different IP
address using Mech.

        my $agent = WWW::Mechanize->new(
                                        autocheck => 1,
                                        quiet => 1
                                        );

        # Set the 'Host' header to the name of the subdomain. We call
        # the site by IP address. This circumvents any DNS issues.
        $agent->add_header( Host => $FQDN );

# try ###################
        eval {
            &log( "Trying '$FQDN'...\n" );

            $username = "\L$username"; # job data is mixed case, but stored evw data is not!
            $agent->get( "http://$ipaddress/setup/shortform.php?uname=$username&password=$password" );

(https://cvs.corp.fortunecity.com/viewcvs.cgi/*checkout*/ampiradev/myphotoalbumwizard/scripts/provisioners/gallery/galleryFormsetter.pl?rev=1.20)


The point of this is I yelled at Ferry this morning because I thought
we were serving up a parse error for nine hours straight. Turned out
to me swg-4 running php4. Long argument ended with me offering to help
write a script to manage this process.

So the script works, I passed it off to Chris and that will be the end
of that. Here, on March 9th, 2007, I wrote him a script that would
test production for parse errors, database errors, and a few others;
all he has to do is fine tune it and put it on production. Why it will
not work: he won't do it; or he won't do it for all servers (he wants
the script to run on every server... maybe he'll put it on the shared
storage though). He won't install Test::WWW::Mechanize, so he won't
install the script. He said, "Too bad this will never happen again."
Meaning, too bad he has to go through the trouble of installing this
script when we will never have one server giving out parse errors
again.

Filed a bug for the weird cookie issue. Bug 998.

Some hacking at the code of the OFS and I already have a passable XML
file. I need the proper codes from the database next: this is
Fernando's end of things. Should be able to put together a correct
order.xml file on Monday if all goes well.




#########################################################################
070313 Tue 13 Mar 2007 05:25:03 PM EDT

Spent the day debugging the store on staging. Turns out it was just
SQL changes Fernando had made, had not been rolled out yet.

I went over my project plan with Fernando and about half of it is
waiting on District. Bill hasn't replied to my last two emails.




#########################################################################
070314 Wed 14 Mar 2007 12:07:49 PM EDT

Manager meeting went well. I need to look up those two orders that
were over $100 and were nearly charged multiple times.

Ear ringing not too bad this morning. I'm trying to stay off iTunes to
see if that's the cause.

Turns out since the start of time, the store has been logging cc
number, expiration date and cvv2. Duh. I wrote a Perl script to remove
them from the logs. Running now.




#########################################################################
070315 Thu 15 Mar 2007 09:44:45 AM EDT

Left hand has been bothering me lately... I need a new keyboard, I
think, because this one, the keys don't go down smoothly sometimes and
I have to put undue pressure on it.




#########################################################################
070316 Fri 16 Mar 2007 11:24:40 AM EDT

This is from December 13th, 2006:

jeffoatrulez: okay, i could go on and on about people that want to do
              functional programming, but
jeffoatrulez: don't get the work at hand done.
jeffoatrulez: but i'll leave it at that.



#########################################################################
070319 Mon 19 Mar 2007 10:17:09 AM EDT

I didn't get the orders fixed on Saturday; when I was about to leave
on Friday, Jessy said I could change the XML on the orders and send
them to District. Well, I was half way out the door, so I told her I'd
do them on Saturday. It turns out several database patches had to be
rolled out, and I'll have to hand update all the orders in the
database to use the new product IDs.

OFS rolled out. Jacob uses the constant name in the DB to invoke the
class; so if you change the constant name, you try to invoke an
undefined class. Nice. Nice and stupid.




#########################################################################
070322 Thu 22 Mar 2007 04:49:12 PM EDT

Damnit. Gotta keep up on the log.

Today I debugged the issue  with duplicate osCsid
cookies. session_start was setting one for swainstore.myphotodevel.com
because it uses the hostname for the default; I had to call
session_cookie_set_params() and define the hostname. This also let me
set the duration, which will now be "life of browser." I named it
differently too: store_sess, more meaningful. Store sets two cookies
now.

I'm a lot more at peace with the situation here. Chris is my friend,
and I'm going to place that first. Better for my well-being. There's
nothing that he does that is worth getting worked up about; but Jessy
is worried that I'll grow complacent, that I've "lost my spark." I
think she was worried about that in the larger sense though; "lost my
spark" for life and not for my job.

I think we are just about over the hump for doing gifts with
District. At the moment we're not receiving order status notifications
and Fernando is working on it.

Yesterday I solved how to send individual order parts. I added new
command line options to the OFS. The only drawback is the OFS running
under crond might steal your order away. Solution: new
processing_state. Turnaround: too long. Easier to just disable the OFS
for the time you're doing it. I should write it up in the Twiki.

I'm off tomorrow; Mike Kole is in town. Tomorrow is Lila's last day as
well.




#########################################################################
070326 Mon 26 Mar 2007 11:32:20 AM EDT

Spend all morning trying to figure out why MPA On The Go is not
working on production. Can I reproduce the problem on staging or dev?
Nope: on dev the Perl script won't run at all. On staging I cannot
seem to send any email at all. I lost sudo access on mup-3. I give up.

I need to tweak mpa.el. The shells loaded on a given machine should be
locally defined in a list. Ditto the commands to initialize them;
currently on spork, it does the retardation of su - swain when I'm
already swain.




#########################################################################
070329 Thu 29 Mar 2007 03:04:27 PM EDT

Trying to get a store rollout done. Chris and Jessy have been fighting
all afternoon. I'm remarkably placid about it.

I emailed Ops this morning asking to have the DB patches rolled out
and Jessy emailed for a rollout. Chris finally admitted he didn't see
them.. oh... bother. I don't feel like spelling all this out. He's
been stonewalling all day, in a nutshell.

He's decided to change the store rollout procedure at the last minute
and we can't test the store because of a variety of ills from mixing
old and new code. I could be at home playing Grand Theft Auto.

I will throw in a ha! ha! though: Chris mispasted the sql, and that's
why shipping was busted.




#########################################################################
070330 Fri 30 Mar 2007 12:15:26 PM EDT

Fixed the sort order of countries. Store ran smoothly overnight.

Chris has been dying over the foreign key constraints.

So my recent thinking is the Cart is, in MVC terminilogy, the
Controller. And maybe it would be good to factor out a Controller
class to handle all the traffic cop stuff.

navTrail is little more than the Back button; from hundreds of
thousands of sessions on production, here's the content:

mysql> select distinct(navTrail) from osc_cart ;
+-------------------------------------------------+
| navTrail                                        |
+-------------------------------------------------+
| a:1:{i:0;s:24:"account_history_info.php";}      |
| a:1:{i:0;s:20:"checkout_success.php";}          |
| a:1:{i:0;s:17:"shopping_cart.php";}             |
| a:1:{i:0;s:19:"account_history.php";}           |
| a:1:{i:0;s:20:"checkout_payment.php";}          |
| a:1:{i:0;s:11:"account.php";}                   |
| a:1:{i:0;s:9:"login.php";}                      |
| a:1:{i:0;s:20:"checkout_process.php";}          |
| a:1:{i:0;s:29:"checkout_shipping_address.php";} |
| a:1:{i:0;s:16:"account_edit.php";}              |
| a:1:{i:0;s:18:"create_account.php";}            |
| a:1:{i:0;s:16:"address_book.php";}              |
| a:1:{i:0;s:12:"shipping.php";}                  |
| a:1:{i:0;s:9:"index.php";}                      |
| a:1:{i:0;s:20:"account_password.php";}          |
| a:1:{i:0;s:24:"address_book_process.php";}      |
| a:1:{i:0;s:28:"checkout_payment_address.php";}  |
| a:1:{i:0;s:22:"password_forgotten.php";}        |
| NULL                                            |
| a:1:{i:0;s:6:"cc.php";}                         |
+-------------------------------------------------+
20 rows in set (28.87 sec)





#########################################################################
070402 Mon 02 Apr 2007 10:25:58 AM EDT

I got rid of two globals Friday and this morning in the cart
class. This is a Good Thing generally, but the $GLOBALS array contains
so much that it's not much of a dent.

PHP's $GLOBALS array has some weird side effects:

#!/opt/php5/bin/php
<?php

echo "hello sailor!\n";
$GLOBALS['blippy'] = "hello, sailor boy!";
foo();

function foo() {
    global $blippy;
    print "blippy is $blippy.\n";
}


?>

This prints:

hello sailor!
blippy is hello, sailor boy!.

On the other hand this is a kind of low rent inflection.




#########################################################################
070403 Tue 03 Apr 2007 11:28:47 AM EDT

I'm working on eliminating those hokey CASE statements that make
adding new products so cumbersome. I created a tiny table of classes
and class IDs, and added a column to osc_products:

Commit from swain (2007-04-02 18:08 EDT)
-----------------

* Add a new column to osc_products: class_id
* Create a new table, osc_products_classes, mapping class_id to
  class_name
* populate osc_products_classes
* define a lookup function for class_id
* update all entries in osc_products, setting the new column to the
  class_id as looked up with the new function


This is going to shrink the code by a lot. I found getCategories()
wasn't even being used. Perhaps dufing my refactorings it became
obsolete?




#########################################################################
070404 Wed 04 Apr 2007 08:07:20 AM EDT

You ask, "sure, typolesbo can answer customer support questions. she has a spellchecker! what 
could possibly go wrong?"
[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
Hi Mary,

Please forgive me, I defiantly made a mistake, I was looking for a payment for the club on 
7-13-06, which I did not find.
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
heller laughs.
heller [to Wainstead \]: brilliant! 

merlin [to Wainstead \]: hahahahaha. defiantly :)
heller . o O ( they told me not to make a mistake but I made one anyway, damn it! )

---

I'm kind of feeling a "writer's block" at this point with the store
codebase, because I've achieved most of my goals: a tiny hierarchy
with the Discount superclass, lots of files like
inc_shopping_cart_functions.php eliminated, helper classes for the
Cart to reduce the amount of code -- I forgot to dig up Bitter Java to
see how to handle the Magic Servlet though. The Cart class is largely
the Controller as well, and that might not be so good. So I suppose
the next big thing is to refactor the code to MVC.


#########################################################################
070409 Mon 09 Apr 2007 10:44:44 AM EDT

Tiff with Chris. He complained about segfaults over the weekend and I
rolled out without testing the store. Apparently he changed a symlink
on Thursday without telling me so I could test on osc-1. Never told
me. I thought the setup never worked. Checking my logs, I was
mistaken: he failed to copy/paste the SQL correctly so that's why it
never seemed to work. In fact testing was working correctly: it was
showing a bug Chris introduced!

He's had replication turned off for days now while he fights with
Veracity. Sigh.

To get epoch time in Javascript, here's a little hack. It converts the
number to a string and lops off the last three numbers, which
represent the milliseconds:

<script>

now = new Date();
with_milliseconds = new String(now.valueOf());
unix_timestamp = with_milliseconds.substr(0, with_milliseconds.length - 3);
document.forms['trialpay'].elements['ts'].value = unix_timestamp;

</script>





#########################################################################
070410 Tue 10 Apr 2007 11:42:03 AM EDT

Tried to create a new "checkout page" in TrialPay but it won't save
it. Rather, it just disappears after I save it.





#########################################################################
070413 Fri 13 Apr 2007 10:35:13 AM EDT

typolesbo: is the image editor working
typolesbo: i just trie d to filp an images
typolesbo: and it jaucned
typolesbo: a proble
typolesbo: loading th
Steve Wainstead: i never touch it
Steve Wainstead: i'll have fernando look at it
typolesbo: sxoop
typolesbo: k
Steve Wainstead: sxoop?
typolesbo: yea
typolesbo: you have to ssee it
Wainstead \ . o O ( i get to see a sxoop! )
merlin venemously orates, "thats hot"
xorian . o O ( hot sxoop-on-sxoop action )
heller [to Wainstead \]: doood. you really need to log all those to a blog for posterity. 

Found a terrible bug while grokking autocoupons. The SQL query was
assigned to $getRows_sql, but $get_rows_sql was passed to
DB::getResults(). Duh. So an empty var was passed in and nothing
happened.




#########################################################################
070417 Tue 17 Apr 2007 02:13:30 PM EDT

This is close, but I can't make the (if) work right. Need my Little
Schemer book.

(defun make-five-levels-subpath (username counter)
  "O.K.!  Speak with a PHILADELPHIA ACCENT!!  Send out for CHINESE FOOD!! Hop a JET!"
  (if (eq counter 3) 'username)
  (concat (substring username 0 counter) "/" (make-five-levels-subpath username (+ counter 1)))
)

(make-five-levels-subpath "swain" 1)




#########################################################################
070418 Wed 18 Apr 2007 01:59:57 PM EDT

[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
typolesbo: i need to make some changes
typolesbo: ont eht decripted
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
Wainstead \ . o O ( .. )
heller says, "sheesh. can't even typo teh correctly."





#########################################################################
070424 Tue 24 Apr 2007 11:03:56 AM EDT

Chris has been getting on my nerves since yesterday sending emails
asking about /opt/mpa/tmp/video, which he was supposed to be
taking care of, and /opt/mpa/dpi/orders/allorders, which is 168GB. I
told him we told him last year (and once again since then) when we
decided to delete all orders over 90 days. Been in the middle of
Hanley and Lloyd over the issue of testing email templates; Lloyd is
being pressured very heavily by Peter to get MyBlogSite done. And on
and on it goes. I need a vacation.

Getting the localhost's hostname without doing a shell call:

$host = php_uname('n');
echo "host: $host<br>\n";



#########################################################################
070425 Wed 25 Apr 2007 05:59:03 PM EDT

Manager's meeting. Traced a bug where an order wasn't charged for the
one print it contained -- was charged for the one mousepad. Need a
cron job to email store errors daily. Also helped Fernando trace a bug
where a shopping cart failed to completely load when there was 250
prints in the cart; ultimately it turned out Chris hadn't configured
osc-2 correctly.

Posted my first test for folded cards to Zaah. Failed on their end;
waiting for their analysis. Spent about an hour on the phone debugging
Tim's stuff.

Randy and Darlene arrived. We were all wearing black pants and dark
red shirts.




#########################################################################
070427 Fri 27 Apr 2007 09:43:15 AM EDT

Got a rollout done yesterday... had to commit my change where NullUser
is not used at all. It made me a little leary of the rollout but looks
like everything went smoothly. Finally set up a cron job to email me
the errors from the osc.log every day.




#########################################################################
070508 Tue 08 May 2007 03:59:23 PM EDT

I spent some time exploring how address stuff is done. My first
objection was it didn't take advantage of PHP's ability to embed
arrays into HTML forms, in the way of:

name="array_name[form_element_name]"

But since validateAddress returns an array containing the validated
address, well, no point in fixing something that ain't broke.





#########################################################################
070511 Fri 11 May 2007 11:20:29 AM EDT

Dumping the cookies in the Perl debugger:

use YAML;
print YAML::Dump($mech->cookie_jar);

Semicolons are probably unnecessary.


#########################################################################
070514 Mon 14 May 2007 10:28:42 AM EDT

Am building Test::WWW:Mechanize on my Mac. This is probably busywork
as I'm trepidatious about starting on the new method to handle
anonymous orders.




#########################################################################
070515 Tue 15 May 2007 02:29:07 PM EDT

Steve Wainstead: he's not that bald or fat though
typolesbo: yea
typolesbo: but funny firht!




#########################################################################
070517 Thu 17 May 2007 03:30:25 PM EDT

Zend: fcops@corp.fortunecity.com/f0rtun3!




#########################################################################
070518 Fri 18 May 2007 11:31:05 AM EDT

Contact info for the detective from New Jersey:

Doug Gotfredsen
NJ State Police Task Force
609-882-2000 x567

Chris complains about Jacob's points tables (again). Claims it was the
first time.




#########################################################################
070524 Thu 24 May 2007 02:36:05 PM EDT

According to Wikipedia:

osCommerce was started in March 2000 in Germany by project founder and
leader Harald Ponce de Leon as The Exchange Project.

So that's where the tep_ prefix comes from in a lot of the store code.


#########################################################################
070530 Wed 30 May 2007 02:57:17 PM EDT

Counting how many users of what five letter prefix:

select letter, cnt from (select left(username, 5) as letter,
count(left(username, 5)) as cnt from users group by letter) as foo
where cnt > 9 order by cnt desc;



#########################################################################
070531 Thu 31 May 2007 02:45:18 PM EDT

[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
typolesbo: found a bug
typolesbo: foudn the bug
typolesbo: think if fixed it
typolesbo: just making sure
Steve Wainstead: eh?
typolesbo: the folded off senter frames
typolesbo: for large H
typolesbo: were wrong
typolesbo: fisking
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
Wainstead \ ignores her, continues reading google reader
heller says, "senter? "
draco fisks the senters of large H
[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
typolesbo: fisking
2:35 PM
Steve Wainstead: draco fisks the senters of large H
typolesbo: ok
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
Wainstead \ . o O ( ... )
heller laughs. 
heller [to Wainstead \]: I bet she's thinking "oh, good, I dont' have to do it now"
Wainstead \ [to draco]: get moving then!
heller says, "that girl really needs to get herself to a dyslexia therapist. "
KENtucky [to Wainstead \]: you need to get her here instead of you being the intermediary. reminds 
me of when I gave myself the nickname of "MIME" when my job at my first IT job was to go send and 
receive external email
heller says, "'for large H' made 'for great justice' start going through my head. damn you."
draco [to Wainstead \]: haha
Wainstead \ [to heller]: heh


---

Met with Chris today to discuss changing how we store stuff. He had a
simple idea: put the fast and slow storage locations in the
database. I think he was thinking of doing this per album, but I think
I got him to see that "all there ever is, is a path to a file."
Everything else is just meaning we extract from that: you can get all
the images for an album by asking the mpa_albumitems table for all
photos in album01. It's that simple. He will never have to spread
again, because when vol01 fills up we move on to vol02.

He pointed out that attrition would mean vol01 would shrink over time,
so there would have to be spreading still; but it's a whole other
problem.

It's so simple I love it. I think coupled with memcached, we could
greatly improve the system. All of this started with me thinking today
that I want to refactor Gallery into another simple object system like
the OFS and the store code. I think I'm getting bored with the store
code because all that's left is grubby stuff like "enter your shipping
address" (yawn). Anonymous users is pretty much done and works. I
don't think there are any major pieces left, except that the admin
interface is going to be broken again.




#########################################################################
070601 Fri 01 Jun 2007 10:34:34 AM EDT

Suggested to Hanley we shoot little demo videos to show off the canvas
and things like that. She likes the idea.




#########################################################################
070604 Mon 04 Jun 2007 05:09:05 PM EDT

Fixed a bug where paypal didn't work with anonymous users; and found
that I just had to set the sandbox to use a credit card so all the
test pp orders weren't fucking echecks. Excuse my language. So I'm
left with one mystery: why does checkout_success.php redirect you to
the order history page? Must fix this.


#########################################################################
070611 Mon 11 Jun 2007 03:11:52 PM EDT

typolesbo: i was in pr ;-)
Steve Wainstead: Paris Hilton was just ordered back to jail in Lynwood.
Hilton left the courtoom in tears, screaming, "Mom, Mom, Mom.'
typolesbo: and fowrked for a senitor

typolesbo: cooeko

typolesbo: cooeo!

Steve Wainstead: you must be hungry by now!
Steve Wainstead: i completely forgot about lunch
typolesbo: tyeas

typolesbo: thas that I was trying to explin to peter...
typolesbo: its sort of like...
typolesbo: well
Steve Wainstead: it couldn't have taken him more than a few weeks
typolesbo: wont it be a pin tto take that shit out
typolesbo: too complicated
typolesbo: and chris is going ot tell ricard
Steve Wainstead: nowadays a lot of programmers would probably write it in Ruby on Rails
typolesbo: because he keeps
typolesbo: calling
Steve Wainstead: just because the "time to market" is shortest
typolesbo: it ricards code
typolesbo: and its smyks cod
typolesbo: e
Steve Wainstead: i don't understand. smyks' code?

typolesbo: click the boto realted ones
typolesbo: too please

typolesbo: yea
typolesbo: kinda tinks
typolesbo: in that respect

typolesbo: out of curiusity...
typolesbo: why don't you gusy want help on this

typolesbo: can you send me a screen shot
typolesbo: of the "disabled"
typolesbo: java
typolesbo: so I can see the message?
Steve Wainstead: one sec
typolesbo: k
typolesbo: thansk!
Steve Wainstead: it has a grammatical error. http://slim.deasil.com/~swain/screencaps/please_to_download.png
Steve Wainstead: "please to download"
typolesbo: lol
typolesbo: sounds like an indian wrote it

typolesbo: lol
typolesbo: ywa

Steve Wainstead: retrieval is spelled wrong
typolesbo: fivures
typolesbo: figures
typolesbo: LOL

typolesbo: so ? fo ryou
typolesbo: if I think teh flickr community guidleines are really great
typolesbo: do you think i coudl use them on the wiki and thank them?
typolesbo: or is that a gray area?
Steve Wainstead: well, typically, the content of a site is copyrighted, no?
typolesbo: i guess
Steve Wainstead: somewhere on their site, they being yahoo, i sould think they have a copyright notice
Steve Wainstead: "no part may be copied in whole or in part without consent" yada yada
typolesbo: hmmm
typolesbo: ok
typolesbo: cak I sak you to "reword these thigns then?
typolesbo: ar eyo ubusy>

typolesbo: if thats the case
typolesbo: then the hardware that runds my prouct is my job too!


typolesbo: lunch
Steve Wainstead: salad?
typolesbo: ya
typolesbo: <-- humgry

typolesbo: i can't vigure oug why it won't vix
typolesbo: the vitical small is right
typolesbo: but not the large
typolesbo: dont know ehy

typolesbo: i was showing you thier view order
typolesbo: thigny

typolesbo: i think we are goldedn

typolesbo: yea
typolesbo: but funny firht!

typolesbo: Have you hard anythign about the cards yet?
Steve Wainstead: of course not
typolesbo: sam it

typolesbo: sane we send the url for the cars
typolesbo: non secure?

Steve Wainstead: http://swain.myphotodevel.com/ampira/zaah-fetcher.php/5000020897/11483.pdf
Steve Wainstead: hit that
typolesbo: ost tjat card nrotu!
typolesbo: woops
typolesbo: isnt that card prityy
typolesbo: pretty
typolesbo: i made the flowers by hdand
typolesbo: <-- fancy!
typolesbo: why is one small and wone big

Steve Wainstead: chris just sent me this. but i think she's more your type. kinda tan.
Steve Wainstead: http://www.withleather.com/post.phtml?pk=2811
typolesbo: my type!
Steve Wainstead: is that a confirmation?
typolesbo: yes ye

typolesbo: just a quick note....
typolesbo: 

typolesbo: well I dont think there are grammer errors anymore

typolesbo: but the review was ond in nov

typolesbo: have you heard from them?
Steve Wainstead: http://en.wikipedia.org/wiki/Them%21
typolesbo: LOL
typolesbo: I L
typolesbo: I LOVE YOU!@

typolesbo: clear you cash
typolesbo: the long sleve
typolesbo: my bad

typolesbo: wll you update dev and stage again
typolesbo: i broke the annn class by accidebt

typolesbo: with dheese
typolesbo: but yest
typolesbo: pealse

typolesbo: ont eht decripted

typolesbo: is the image editor working
typolesbo: i just trie d to filp an images
typolesbo: and it jaucned
typolesbo: a proble
typolesbo: loading th
Steve Wainstead: i never touch it
Steve Wainstead: i'll have fernando look at it
typolesbo: sxoop
typolesbo: k
Steve Wainstead: sxoop?
typolesbo: yea
typolesbo: you have to ssee it




#########################################################################
070612 Tue 12 Jun 2007 06:17:04 PM EDT

Solution: the DiscountHelper, maybe, could come from the WebUser. So
the Cart asks the WebUser for a DiscountHelper, which knows how to
make the correct coupon or offer. For anonymous users it will only
make coupons; for registered users, either.


#########################################################################
070613 Wed 13 Jun 2007 02:11:19 PM EDT

I see where I left off on the Discount class and its
subclasses... there's still a trackCouponUse and a trackOfferUse
method. There's still concrete implementation stuff being called. Work
to do.

Coupons work for anon users. Offers cause a fatal error if no
customers_id is provided... well not at the moment, since I removed
that restriction and it uses zero if none were provided.

But the bigger idea I have is there should be two Offer types:
AnonUserOffer and RegUserOffer.




#########################################################################
070618 Mon 18 Jun 2007 04:15:25 PM EDT

login as admin
(song)



#########################################################################
070626 Tue 26 Jun 2007 11:17:08 AM EDT

New idea: for the mpa_photos table, either maintain a view or create a
second table that contains only the most recent entries, or rather,
the most commonly accessed entries based on date. That is, for all
photos uploaded, they are probably not accessed much beyond two weeks
after they are uploaded. A table of two weeks of photos would be tiny.

This is just an optimization thought. A SELECT statement that returns
nothing would have to query the main table. CRUD stuff is going to
have to maintain two tables, which suggests a set of simple stored
procs or functions to do the job: addphoto, movephoto, deletephoto,
renamephoto, etc etc. Wrapping CRUD in stored procs simplifies things
in one respect: it removes duplicity up front.


#########################################################################
070628 Thu 28 Jun 2007 03:57:32 PM EDT

typolesbo: klof it
Steve Wainstead: you klof it?
Steve Wainstead:
typolesbo: LOVE IT
Steve Wainstead: i love you. you're the best!
typolesbo: hump
typolesbo: i just really can't stand him
typolesbo: and i feel like he's grandstanding
typolesbo: with his new little peion
Steve Wainstead: i know how you feel. really!
typolesbo: miossed the last line?
typolesbo: i missed the last line
Steve Wainstead: hrrm?
typolesbo: what id you see
typolesbo: say
typolesbo: before the one where i speed missed funty




#########################################################################
070702 Mon 02 Jul 2007 11:51:00 AM EDT

Been working on store bugs this morning. First one: guy in England was
entering his Gallery email address. This eventually got him a link to
create_account.php, which was die()ing on him. Fixed. Sent him a
coupon.

Now, somehow, people are going straight from their cart to
enter_address.php, which die()s becaues a NullUser's
getBillToAddress() fails. Hrmm.


#########################################################################
070703 Tue 03 Jul 2007 10:14:42 AM EDT

So the other problem turned out to be: the php.ini on osc-1 and osc-2
had the default session timeout, which was something like 24
minutes. That was the cause of the other issues. But in that case, the
customer did not lose their cart contents; they might have had to
enter their address info over again. Chris set the session timeout to
12 hours, per my request. This is how long carts are kept on
production, if they don't have a customer ID.

chat with igor on 7/3/7:

wainstead1
hello, igor? i'm the software development director for myphotoalbum.com, steve wainstead.
jessy hanley said you'd have time to talk today.
igor_mikhaylov
hello, steve! please ask me your questions!
glad to meet you!
Onlineigor_mikhaylov has signed back in
wainstead1
hi igor!
igor_mikhaylov
hi!
wainstead1
ok i'd like to hear a little more about your programming background
tell me about some of the more difficult projects you've done
igor_mikhaylov
well, please first take a look at my oDesk profile: http://profiles.odesk.com/e24818ce6b380b2b
wainstead1
yes, i've read through it already 
i wanted to be prepared 
the examples listed at the bottom are very motion-oriented projects, lots of animation
the things we have to work on will demand more of you as a programmer, i think, than as a flash designer (graphic designer)
igor_mikhaylov
thats why it is interesting to me. I have stronger skills in programming rather than in design/art.
11:54 AMMy skills: 
- Advanced knowledge of Flash and ActionScript 2, good knowledge of HTML, CSS and PHP. I have many years experience. 
- Experience using ActionScript to develop data-driven applications. I have developed many data-driven Flash websites integrated with PHP/server environment. 
- Experience using video and audio in Flash. I have developed websites for Austrian TV show and Theatre, and American gambling corp. with audio and video content. 
- General understanding of website design and usability. Although I'm not professional designer - I'm programmer - I can create User Interfaces, visual effects and other design stuffs in my projects. 
- Experience with PHP/Flash integration. Almost each my project is PHP+Flash project. 
wainstead1
ah! excellent. somehow i didn't see that on the site, and that's the info i was looking for...
have you worked with CVS before?
igor_mikhaylov
a bit
most of projects was developed by me as single programmer, so I didn't used CVS as often.
wainstead1
it's not too big a problem, as we can commit the work to cvs for you
igor_mikhaylov
great
wainstead1
we are thinking of trying you out on a smaller project first. we have a slideshow application that needs updating...
jessy can tell you more about that; but for now, i'm satisfied with your programming background
i'll talk it over with her. thanks for chatting! 
igor_mikhaylov
thank you! have a nice day. 
wainstead1

                                   


#########################################################################
070716 Mon 16 Jul 2007 12:40:49 PM EDT

Big hoopla today as I tell Jessy that RSS hasn't worked since the end
of 2006. Naturally Chris remembers nothing. See my entry from January
4th.

One customer triggered the "Subtotals don't match" check Fernando put
in many months ago. I added a new logging statement to try to narrow
it down should it happen again; but it looks like there's a bug
somewhere in the code that calculates the subtotal and places it in
the osc_cart table.

There were no bugs over the weekend except for that "missing product
ID" one! I think that bug comes from a search engine, but I'm not sure
yet. I solved two key issues on Friday:

Commit from swain (2007-07-13 12:07 EDT)
-----------------

fix:

     * Kinda wonky, but sometimes $this->email_address is not
     * set... so we brute force it. This is a workaround for a bug on
     * production, 7/13/07, where create_account.php fails because
     * this class threw a fatal error because $this->email_address was
     * not set; but it existed in the billto and shipto arrays. --sw

  ampiradev  gallery-sc/public_html/includes/webuser.lib.inc  1.44

Commit from cvssync (2007-07-13 15:38 EDT)
-------------------

Fix: use mysql_real_escape_string() on the serialized session
data. This fixes a bug where store users who had quotes in their names
(O'Connor) suffered a fatal error. Somehow the data gets *into* Mysql
just fine, but PHP cannot unserialize it coming out.

  mpa-signup  lib/mysql_sessions.inc  1.7





#########################################################################
070717 Tue 17 Jul 2007 10:50:14 AM EDT

Tom wants to start tracking my time spent per project for accounting
purposes... I'm guessing I spent about 20% of my time in June on
MPP. If that, really; anonymous purchases were launched June 29th, so
I was certainly doing a lot of work up to that point.

Yesterday was about 50/50 on the store. Made good progress with Rails
yesterday; I have a database schema largely fleshed out.

Chris bitches that the RSS feed generator nearly crashed mdb-2 last
night. ("Sally and Judy were standing next to me...") It made a 10 GB
log file in less than a day. This is, somehow, my fault. I disabled
verbose logging and reset the cron tab so it updates every 10 minutes.

I just realized Chris changed the crontab entry so it ran only once an
hour... and it would only pick up the previous ten minutes! Truly he
doesn't care.

And now he's sniping about how it's using php4. Sigh. I want to scream
at him.




#########################################################################
070719 Thu 19 Jul 2007 10:53:23 AM EDT

Spent quite a bit of time yesterday doing number crunching for the
store. Also did testing of Gallery and helped with the rollouts;
rolled out the store. Today I found that preview.php has been throwing
errors, and emailed the results to Fernando and Jessy.


#########################################################################
070720 Fri 20 Jul 2007 09:43:51 AM EDT

Yesterday, I implemented a login/logout system in Rails. Spent some
time looking at an IDE kind of environment for Emacs (specifically,
Emacs on Rails). The scope of it is daunting, and from a demo video it
looks like it's very mouse intensive (could be wrong on that) and I
don't wanna have to use the mouse.

Been trying to reproduce a bug a customer had last night. Looks like
they logged in, then changed their address (addresses?) via
account.php and address_book_process.php instead of the typical route
offered by the store. At some point the cart contained the old address
book ID:

mysql> select * from osc_cart where customers_id=35322\G
*************************** 1. row ***************************
                 cart_id: 49102671
                sess_key: 848e5a6443373c3b4f2285e49c91a343
           txn_signature:
               orders_id: 0
          payment_method:
           payment_title:
                   cc_id: 0
        payment_currency: USD
             order_total: 1.78999996
                  sendto: 39566
                  billto: 39566
                language:
             language_id: 1
         shipping_method: US
         shipping_amount: 1.49000001
              tax_amount: 0.00000000
                 tax_pct: 0
                tax_name: Tax
            customers_id: 35322
            content_type: physical
        shopping_cart_id: 25b4dda09666c4c3d61d92ac1d330cdf
                  offers:
validated_coupon_code_id: 0
      validated_offer_id: 0
         subtotal_amount: 0.30000001
             express_qty: 1
            express_size: 152
                mpa_fqdn: http://melahat.myphotoalbum.com/order_prints.php
           last_accessed: 2007-07-19 21:57:25
1 row in set (0.00 sec)


But the current address IDs for this customer are now:

mysql> select address_book_id  from osc_address_book where customers_id=35322;
+-----------------+
| address_book_id |
+-----------------+
|           57176 |
|           57177 |
+-----------------+
2 rows in set (0.01 sec)

(the current highest ID is 57195, so these addresses are new).

So the bug probably lies somewhere in deleting/editing the addresses
in the address book, and the cart does not update. I've also found a
bug where deleting an address probably gives you a confirmation page
but it doesn't say "Really delete this address?" Very confusing.


#########################################################################
070723 Mon 23 Jul 2007 03:29:23 PM EDT

Finally consolidated all my notes into a new 1.5 page todo list, and
added that to the much older ones (which need culling). I flushed out
the buglist for the store and added new ones. I tagged the release on
production after putting in a kludge for the bug where the guy used
account_info to edit his addresses and invalidated his cart address
ids.




#########################################################################
070724 Tue 24 Jul 2007 09:35:30 AM EDT

After cleaning up loose ends and flushing out the store's bugs in
Bugzilla, I worked on finishing the Agile book and wrote a page's
worth of Ruby to work out looping. Nothing great, but...

Jessy out sick today.

Another damn error in the store from "email not passed in" when trying
to create a new account.


#########################################################################
070726 Thu 26 Jul 2007 05:47:47 PM EDT

A long day of crap. Worked out a new CL ad. Mediated some stuff for
the Neilsen frames project.


#########################################################################
070727 Fri 27 Jul 2007 10:22:26 AM EDT

Mac hung this morning; had to reboot. QuickSilver? Meanwhile, Chris
blew away /opt/mpa/dpi/orders yesterday around 6pm. He didn't know it
was symlinked to a slow partition that he deleted. So the OFS was
failing all night and we got the morning report saying 2,000+
errors. Didn't take long for Chris to figure out what he did! In the
end about 29 orders were affected; we lost all xml files and receipts
from DPI, TLC and Zaah, but that's not too terrible (it's all in the
database anyway).


#########################################################################
070730 Mon 30 Jul 2007 09:49:16 AM EDT

Well, plans to work the weekend did not pan out. I did a tiny bit of
work yesterday from home, but mostly got sidetracked. Hard to really
plunge into this.

But I do know that I have to solve the account creation problem today:
that is, from the imported data, all these photographers need a
username/password. So a bit of perl scripting should move things
forward.

Got a standalone script to access the database. In this regard
ActiveRecord is amazing:

require "rubygems"
require_gem "activerecord"

ActiveRecord::Base.establish_connection(
                                        :adapter => "mysql",
                                        :host => "localhost",
                                        :database => "myphotopro_development")

class Photographer < ActiveRecord::Base
end

photog = Photographer.find(1163)
photog.company_name = "No name provided"
photog.save


"It just works."

Letter today to Peter and Chris:

I think I've been a little opaque about the project, to date, and
we're already at the end of July; and it even dismays me that there's
no actual "web pages" to look at yet, so I'm going to outline my
progress to date on this.

First, learning Ruby on Rails (RoR) is a very steep learning
curve. You can't do a whole lot until you master a lot of the basics;
and there's a lot to learn. One can retype commands from the book, but
so much plumbing is generated and so much magic happens behind the
scenes that all one knows is a lot of files were generated and
suddenly "stuff works." But to do something of even medium
sophistication means, pretty much, digesting nearly the entire 700
pages of the Rails book.

So at this point I've read about 400 pages of the Rails book (plus
several chapters of other books and dozens of web pages) and have
built several smaller applications. The way most projects are done, by
me anyways, is: you break it into several smaller problems (the
philosopher Descartes thought of this, not me) and solve those.

Some of the problems were quite sticky:

1. Creating new user accounts, storing passwords securely.
2. Building database tables with complex foreign key relationships.
3. Getting Rails to talk to two databases at the same time (needed for
   storing credit card info)
4. Getting Rails to talk to legacy database tables (see step 3)
5. Importing the data from our intern (nearly 600 photographers)

This weekend I figured out steps 3 and 4; I've done the other three,
and there's a real big one on the horizon: "Find photographers within
N miles of the user's address." It turns out there's a module we can
use that accesses Google Maps to do this. I don't know what the cost
to us will be, but I don't think it will be much. More on that
later. (There are free alternatives too).

I also have to work out sending mail, for which I found examples, so I
think that might not be much trouble (except we use Postfix and not
Sendmail, and Rails seems to prefer the latter).

So for the first time on Saturday I think I had a solid grasp of
everything left that needs to be done, and a mental picture of it all
that's only slightly fuzzy. I think a beta by the time Janet starts is
still the reality of it all.

~swain




#########################################################################
070731 Tue 31 Jul 2007 12:28:29 PM EDT

Send an email with ActiveMailer today. Hurray for tutorials.


Additional install for Rails:

gem install activemerchant

Looking into the OSC's authorizenet class, this is the crux of the
biscuit:

        $form_data["x_test_request"]   = $this->test_request;

which has a value of true or false. Or nothing, apparently.


Imagine this for Veracity:

// get stuff from db first
$result = select  * from mpa_albumitems;

// insert into sqlite. wish there were a faster way! how about a
// sqlite extension that queries msyql? pass the bong!
foreach $line $result:
        insert into sqlite $result;
$album = album.new(datfile);
insert into sqlite $album;
$filesystem = check_album(albumname);
insert into sqlite $filesystem;

I want to mix mysql tables with the sqlite local ones. it would be
fun.




#########################################################################
070802 Thu 02 Aug 2007 04:37:31 PM EDT

Michael killed off veracity after about an hour, because the Nagios
alarms were going crazy. It was kind of amusing really.

Did detective work on why so many "duplicate transactions" were
showing up in the store log. This happens when a billto is wrong, and
the person submits it again.

Wrote a couple of lisp functions to render an Authorize.net
transaction string. Pretty nifty. It was natural to use recursion, but
then, whenever I need a loop these days in lisp I use recursion.

Sketched out the search page from the view (doh!) of the controller
and the templates. Should be straightforward.

Our A/C is out again. A tad warm here, but I have my fan on me. Funny
how this ten dollar fan has come through for me time and again.

Some coolness:

[spork myphotopro]$ script/console
Loading development environment.
>> location = IpGeocoder.geocode('12.215.42.19')
NameError: uninitialized constant IpGeocoder
	from /usr/lib/ruby/gems/1.8/gems/activesupport-1.4.2/lib/active_support/dependencies.rb:266:in `load_missing_constant'
	from /usr/lib/ruby/gems/1.8/gems/activesupport-1.4.2/lib/active_support/dependencies.rb:452:in `const_missing'
	from /usr/lib/ruby/gems/1.8/gems/activesupport-1.4.2/lib/active_support/dependencies.rb:464:in `const_missing'
	from (irb):1
>> search = Search.find_all
=> []
>> search.to_string
NoMethodError: undefined method `to_string' for []:Array
	from (irb):3
>> search.to_yaml
=> "--- []"
>> search.methods
=> ["indexes", "instance_variables", "copy_instance_variables_from", "map", "frozen?", "require_gem", "first", "reject!", "__send__", "sort_by", "to_a", "group_by", "transpose", "to_json", "to_yaml_properties", "zip", "to_sentence", "class", "display", "require", "silence_stream", "indices", "subclasses_of", "compact!", "inject", "instance_variable_get", "method", "flatten", "blank?", "last", "grep", "to_s", "clear", "send", "each", "clone", "nil?", "partition", "instance_variable_set", "decode64", "push", "to_xml", "split", "inspect", "insert", "find", "unloadable", "fill", "index_by", "instance_eval", "include?", "sort!", "dup", "suppress", "flatten!", "equal?", "extend_with_included_modules_from", "delete", "nitems", "decode_b", "reverse", "pop", "methods", "length", "detect", "assoc", "`", "collect!", "sum", "sort_by_distance_from", "all?", "taint", "eql?", "instance_values", "index", "hash", "shift", "find_all", "singleton_methods", "size", "rassoc", "map!", "&", "instance_of?", "slice", "any?", "extend", "gem", "to_yaml", "values_at", "reverse!", "min", "instance_exec", "rindex", "to_set", "id", "*", "daemonize", "in_groups_of", "concat", "unshift", "+", "select", "protected_methods", "tainted?", "uniq", "-", "to_ary", "to_param", "untaint", "kind_of?", "require_library_or_gem", "delete_at", "pack", "max", "returning", "replace", "__id__", "b64encode", "empty?", "each_index", "silence_warnings", "<=>", "private_methods", "reject", "==", "slice!", "join", "===", "to_default_s", "is_complex_yaml?", "at", "freeze", "is_a?", "entries", "delete_if", "with_options", "|", "enable_warnings", "object_id", "remove_subclasses_of", "uniq!", "reverse_each", "=~", "extended_by", "public_methods", "collect", "compact", "to_formatted_s", "fetch", "sort", "member?", "[]", "encode64", "respond_to?", "to_yaml_type", "each_with_index", "[]=", "silence_stderr", "type", "load", "<<"]
>> include GeoKit::Geocoders
=> Object
>> res = MultiGeocoder.geocode('100 Spear St, San Francisco, CA')
=> #<GeoKit::GeoLoc:0xb74aef6c @zip="94105", @state="CA", @precision="unknown", @success=true, @lng=-122.393981, @city="San Francisco", @country_code="US", @lat=37.792528, @street_address="100 Spear St">
>> puts res.lat
37.792528
=> nil
>> puts res.full_address
100 Spear St, San Francisco, CA, 94105, US
=> nil
>> res = MultiGeocoder.geocode('322 8th Avenue, New York, NY 10001')
=> #<GeoKit::GeoLoc:0xb7478a5c @zip=nil, @state=nil, @precision="unknown", @success=false, @lng=nil, @city=nil, @country_code=nil, @lat=nil, @street_address=nil>
>> puts res.full_address

=> nil
>> res = MultiGeocoder.geocode('322 Eighth Avenue, New York, NY')
=> #<GeoKit::GeoLoc:0xb7432138 @zip=nil, @state=nil, @precision="unknown", @success=false, @lng=nil, @city=nil, @country_code=nil, @lat=nil, @street_address=nil>
>> res = MultiGeocoder.geocode('322 Eighth Ave, New York, NY')
=> #<GeoKit::GeoLoc:0xb73e73f4 @zip=nil, @state=nil, @precision="unknown", @success=false, @lng=nil, @city=nil, @country_code=nil, @lat=nil, @street_address=nil>
>> res = MultiGeocoder.geocode('322 Eighth Ave, New York, NY 10001')
=> #<GeoKit::GeoLoc:0xb73b5520 @zip="10001", @state="NY", @precision="unknown", @success=true, @lng=-73.997206, @city="New York", @country_code="US", @lat=40.747449, @street_address="322 8th Ave">
>> res = MultiGeocoder.geocode('322 8th Avenue, New York, NY 10001')
=> #<GeoKit::GeoLoc:0xb7397534 @zip="10001", @state="NY", @precision="unknown", @success=true, @lng=-73.997206, @city="New York", @country_code="US", @lat=40.747449, @street_address="322 8th Ave">
>> 


>> class Location
>> include GeoKit::Mappable
>> end
=> Location
>> Location.distance_between('', '915 Rhodes Tower, Cleveland OH 44115')
GeoKit::Geocoders::GeocodeError: GeoKit::Geocoders::GeocodeError
	from ./script/../config/../config/../vendor/plugins/geokit/lib/geo_kit/mappable.rb:250:in `normalize'
	from ./script/../config/../config/../vendor/plugins/geokit/lib/geo_kit/mappable.rb:35:in `distance_between'
	from (irb):20
>> from = MultiGeocoder.geocode('322 8th Ave, New York NY 10001')
=> #<GeoKit::GeoLoc:0xb75bb2fc @zip="10001", @state="NY", @precision="unknown", @success=true, @lng=-73.997206, @city="New York", @country_code="US", @lat=40.747449, @street_address="322 8th Ave">
>> dest = MultiGeocoder.geocode('956 Rhodes Tower, Cleveland OH 44115')
=> #<GeoKit::GeoLoc:0xb757c4bc @zip=nil, @state=nil, @precision="unknown", @success=false, @lng=nil, @city=nil, @country_code=nil, @lat=nil, @street_address=nil>
>> dest = MultiGeocoder.geocode('34-38 75th St, Jackson Heights, NY 11372')
=> #<GeoKit::GeoLoc:0xb7555114 @zip="11372", @state="NY", @precision="unknown", @success=true, @lng=-73.891407, @city="New York", @country_code="US", @lat=40.752292, @street_address="3438 75th St">
>> Location.distance_between(from, dest)
=> 5.55412844927348
>> 

Note here the address did not parse (the Rhodes Tower one) so the
whole stack of cards collapsed.


#########################################################################
070806 Mon 06 Aug 2007 03:22:37 PM EDT

So... around 776,000 photos removed by Veracity, but it missed 40% of
the photos because 200+ of the processes died due to mysql timeouts or
somesuch.

I wrote a new iterator maker that guarantees blocks of 200 users at a
time. Even going to five chars meant 'chris' would do 1000+ users. I
don't know why I ever went with such a complicated scheme; just
counting the users is more than adequate.

=======



#########################################################################
070719 Thu 19 Jul 2007 10:53:23 AM EDT

Spent quite a bit of time yesterday doing number crunching for the
store. Also did testing of Gallery and helped with the rollouts;
rolled out the store. Today I found that preview.php has been throwing
errors, and emailed the results to Fernando and Jessy.


#########################################################################
070720 Fri 20 Jul 2007 09:43:51 AM EDT

Yesterday, I implemented a login/logout system in Rails. Spent some
time looking at an IDE kind of environment for Emacs (specifically,
Emacs on Rails). The scope of it is daunting, and from a demo video it
looks like it's very mouse intensive (could be wrong on that) and I
don't wanna have to use the mouse.

Been trying to reproduce a bug a customer had last night. Looks like
they logged in, then changed their address (addresses?) via
account.php and address_book_process.php instead of the typical route
offered by the store. At some point the cart contained the old address
book ID:

mysql> select * from osc_cart where customers_id=35322\G
*************************** 1. row ***************************
                 cart_id: 49102671
                sess_key: 848e5a6443373c3b4f2285e49c91a343
           txn_signature:
               orders_id: 0
          payment_method:
           payment_title:
                   cc_id: 0
        payment_currency: USD
             order_total: 1.78999996
                  sendto: 39566
                  billto: 39566
                language:
             language_id: 1
         shipping_method: US
         shipping_amount: 1.49000001
              tax_amount: 0.00000000
                 tax_pct: 0
                tax_name: Tax
            customers_id: 35322
            content_type: physical
        shopping_cart_id: 25b4dda09666c4c3d61d92ac1d330cdf
                  offers:
validated_coupon_code_id: 0
      validated_offer_id: 0
         subtotal_amount: 0.30000001
             express_qty: 1
            express_size: 152
                mpa_fqdn: http://melahat.myphotoalbum.com/order_prints.php
           last_accessed: 2007-07-19 21:57:25
1 row in set (0.00 sec)


But the current address IDs for this customer are now:

mysql> select address_book_id  from osc_address_book where customers_id=35322;
+-----------------+
| address_book_id |
+-----------------+
|           57176 |
|           57177 |
+-----------------+
2 rows in set (0.01 sec)

(the current highest ID is 57195, so these addresses are new).

So the bug probably lies somewhere in deleting/editing the addresses
in the address book, and the cart does not update. I've also found a
bug where deleting an address probably gives you a confirmation page
but it doesn't say "Really delete this address?" Very confusing.


#########################################################################
070723 Mon 23 Jul 2007 03:29:23 PM EDT

Finally consolidated all my notes into a new 1.5 page todo list, and
added that to the much older ones (which need culling). I flushed out
the buglist for the store and added new ones. I tagged the release on
production after putting in a kludge for the bug where the guy used
account_info to edit his addresses and invalidated his cart address
ids.




#########################################################################
070724 Tue 24 Jul 2007 09:35:30 AM EDT

After cleaning up loose ends and flushing out the store's bugs in
Bugzilla, I worked on finishing the Agile book and wrote a page's
worth of Ruby to work out looping. Nothing great, but...

Jessy out sick today.

Another damn error in the store from "email not passed in" when trying
to create a new account.


#########################################################################
070726 Thu 26 Jul 2007 05:47:47 PM EDT

A long day of crap. Worked out a new CL ad. Mediated some stuff for
the Neilsen frames project.


#########################################################################
070727 Fri 27 Jul 2007 10:22:26 AM EDT

Mac hung this morning; had to reboot. QuickSilver? Meanwhile, Chris
blew away /opt/mpa/dpi/orders yesterday around 6pm. He didn't know it
was symlinked to a slow partition that he deleted. So the OFS was
failing all night and we got the morning report saying 2,000+
errors. Didn't take long for Chris to figure out what he did! In the
end about 29 orders were affected; we lost all xml files and receipts
from DPI, TLC and Zaah, but that's not too terrible (it's all in the
database anyway).


#########################################################################
070730 Mon 30 Jul 2007 09:49:16 AM EDT

Well, plans to work the weekend did not pan out. I did a tiny bit of
work yesterday from home, but mostly got sidetracked. Hard to really
plunge into this.

But I do know that I have to solve the account creation problem today:
that is, from the imported data, all these photographers need a
username/password. So a bit of perl scripting should move things
forward.

Got a standalone script to access the database. In this regard
ActiveRecord is amazing:

require "rubygems"
require_gem "activerecord"

ActiveRecord::Base.establish_connection(
                                        :adapter => "mysql",
                                        :host => "localhost",
                                        :database => "myphotopro_development")

class Photographer < ActiveRecord::Base
end

photog = Photographer.find(1163)
photog.company_name = "No name provided"
photog.save


"It just works."

Letter today to Peter and Chris:

I think I've been a little opaque about the project, to date, and
we're already at the end of July; and it even dismays me that there's
no actual "web pages" to look at yet, so I'm going to outline my
progress to date on this.

First, learning Ruby on Rails (RoR) is a very steep learning
curve. You can't do a whole lot until you master a lot of the basics;
and there's a lot to learn. One can retype commands from the book, but
so much plumbing is generated and so much magic happens behind the
scenes that all one knows is a lot of files were generated and
suddenly "stuff works." But to do something of even medium
sophistication means, pretty much, digesting nearly the entire 700
pages of the Rails book.

So at this point I've read about 400 pages of the Rails book (plus
several chapters of other books and dozens of web pages) and have
built several smaller applications. The way most projects are done, by
me anyways, is: you break it into several smaller problems (the
philosopher Descartes thought of this, not me) and solve those.

Some of the problems were quite sticky:

1. Creating new user accounts, storing passwords securely.
2. Building database tables with complex foreign key relationships.
3. Getting Rails to talk to two databases at the same time (needed for
   storing credit card info)
4. Getting Rails to talk to legacy database tables (see step 3)
5. Importing the data from our intern (nearly 600 photographers)

This weekend I figured out steps 3 and 4; I've done the other three,
and there's a real big one on the horizon: "Find photographers within
N miles of the user's address." It turns out there's a module we can
use that accesses Google Maps to do this. I don't know what the cost
to us will be, but I don't think it will be much. More on that
later. (There are free alternatives too).

I also have to work out sending mail, for which I found examples, so I
think that might not be much trouble (except we use Postfix and not
Sendmail, and Rails seems to prefer the latter).

So for the first time on Saturday I think I had a solid grasp of
everything left that needs to be done, and a mental picture of it all
that's only slightly fuzzy. I think a beta by the time Janet starts is
still the reality of it all.

~swain




#########################################################################
070731 Tue 31 Jul 2007 12:28:29 PM EDT

Send an email with ActiveMailer today. Hurray for tutorials.


Additional install for Rails:

gem install activemerchant

Looking into the OSC's authorizenet class, this is the crux of the
biscuit:

        $form_data["x_test_request"]   = $this->test_request;

which has a value of true or false. Or nothing, apparently.


Imagine this for Veracity:

// get stuff from db first
$result = select  * from mpa_albumitems;

// insert into sqlite. wish there were a faster way! how about a
// sqlite extension that queries msyql? pass the bong!
foreach $line $result:
        insert into sqlite $result;
$album = album.new(datfile);
insert into sqlite $album;
$filesystem = check_album(albumname);
insert into sqlite $filesystem;

I want to mix mysql tables with the sqlite local ones. it would be
fun.




#########################################################################
070802 Thu 02 Aug 2007 04:37:31 PM EDT

Michael killed off veracity after about an hour, because the Nagios
alarms were going crazy. It was kind of amusing really.

Did detective work on why so many "duplicate transactions" were
showing up in the store log. This happens when a billto is wrong, and
the person submits it again.

Wrote a couple of lisp functions to render an Authorize.net
transaction string. Pretty nifty. It was natural to use recursion, but
then, whenever I need a loop these days in lisp I use recursion.

Sketched out the search page from the view (doh!) of the controller
and the templates. Should be straightforward.

Our A/C is out again. A tad warm here, but I have my fan on me. Funny
how this ten dollar fan has come through for me time and again.

Some coolness:

[spork myphotopro]$ script/console
Loading development environment.
>> location = IpGeocoder.geocode('12.215.42.19')
NameError: uninitialized constant IpGeocoder
	from /usr/lib/ruby/gems/1.8/gems/activesupport-1.4.2/lib/active_support/dependencies.rb:266:in `load_missing_constant'
	from /usr/lib/ruby/gems/1.8/gems/activesupport-1.4.2/lib/active_support/dependencies.rb:452:in `const_missing'
	from /usr/lib/ruby/gems/1.8/gems/activesupport-1.4.2/lib/active_support/dependencies.rb:464:in `const_missing'
	from (irb):1
>> search = Search.find_all
=> []
>> search.to_string
NoMethodError: undefined method `to_string' for []:Array
	from (irb):3
>> search.to_yaml
=> "--- []"
>> search.methods
=> ["indexes", "instance_variables", "copy_instance_variables_from", "map", "frozen?", "require_gem", "first", "reject!", "__send__", "sort_by", "to_a", "group_by", "transpose", "to_json", "to_yaml_properties", "zip", "to_sentence", "class", "display", "require", "silence_stream", "indices", "subclasses_of", "compact!", "inject", "instance_variable_get", "method", "flatten", "blank?", "last", "grep", "to_s", "clear", "send", "each", "clone", "nil?", "partition", "instance_variable_set", "decode64", "push", "to_xml", "split", "inspect", "insert", "find", "unloadable", "fill", "index_by", "instance_eval", "include?", "sort!", "dup", "suppress", "flatten!", "equal?", "extend_with_included_modules_from", "delete", "nitems", "decode_b", "reverse", "pop", "methods", "length", "detect", "assoc", "`", "collect!", "sum", "sort_by_distance_from", "all?", "taint", "eql?", "instance_values", "index", "hash", "shift", "find_all", "singleton_methods", "size", "rassoc", "map!", "&", "instance_of?", "slice", "any?", "extend", "gem", "to_yaml", "values_at", "reverse!", "min", "instance_exec", "rindex", "to_set", "id", "*", "daemonize", "in_groups_of", "concat", "unshift", "+", "select", "protected_methods", "tainted?", "uniq", "-", "to_ary", "to_param", "untaint", "kind_of?", "require_library_or_gem", "delete_at", "pack", "max", "returning", "replace", "__id__", "b64encode", "empty?", "each_index", "silence_warnings", "<=>", "private_methods", "reject", "==", "slice!", "join", "===", "to_default_s", "is_complex_yaml?", "at", "freeze", "is_a?", "entries", "delete_if", "with_options", "|", "enable_warnings", "object_id", "remove_subclasses_of", "uniq!", "reverse_each", "=~", "extended_by", "public_methods", "collect", "compact", "to_formatted_s", "fetch", "sort", "member?", "[]", "encode64", "respond_to?", "to_yaml_type", "each_with_index", "[]=", "silence_stderr", "type", "load", "<<"]
>> include GeoKit::Geocoders
=> Object
>> res = MultiGeocoder.geocode('100 Spear St, San Francisco, CA')
=> #<GeoKit::GeoLoc:0xb74aef6c @zip="94105", @state="CA", @precision="unknown", @success=true, @lng=-122.393981, @city="San Francisco", @country_code="US", @lat=37.792528, @street_address="100 Spear St">
>> puts res.lat
37.792528
=> nil
>> puts res.full_address
100 Spear St, San Francisco, CA, 94105, US
=> nil
>> res = MultiGeocoder.geocode('322 8th Avenue, New York, NY 10001')
=> #<GeoKit::GeoLoc:0xb7478a5c @zip=nil, @state=nil, @precision="unknown", @success=false, @lng=nil, @city=nil, @country_code=nil, @lat=nil, @street_address=nil>
>> puts res.full_address

=> nil
>> res = MultiGeocoder.geocode('322 Eighth Avenue, New York, NY')
=> #<GeoKit::GeoLoc:0xb7432138 @zip=nil, @state=nil, @precision="unknown", @success=false, @lng=nil, @city=nil, @country_code=nil, @lat=nil, @street_address=nil>
>> res = MultiGeocoder.geocode('322 Eighth Ave, New York, NY')
=> #<GeoKit::GeoLoc:0xb73e73f4 @zip=nil, @state=nil, @precision="unknown", @success=false, @lng=nil, @city=nil, @country_code=nil, @lat=nil, @street_address=nil>
>> res = MultiGeocoder.geocode('322 Eighth Ave, New York, NY 10001')
=> #<GeoKit::GeoLoc:0xb73b5520 @zip="10001", @state="NY", @precision="unknown", @success=true, @lng=-73.997206, @city="New York", @country_code="US", @lat=40.747449, @street_address="322 8th Ave">
>> res = MultiGeocoder.geocode('322 8th Avenue, New York, NY 10001')
=> #<GeoKit::GeoLoc:0xb7397534 @zip="10001", @state="NY", @precision="unknown", @success=true, @lng=-73.997206, @city="New York", @country_code="US", @lat=40.747449, @street_address="322 8th Ave">
>> 


>> class Location
>> include GeoKit::Mappable
>> end
=> Location
>> Location.distance_between('', '915 Rhodes Tower, Cleveland OH 44115')
GeoKit::Geocoders::GeocodeError: GeoKit::Geocoders::GeocodeError
	from ./script/../config/../config/../vendor/plugins/geokit/lib/geo_kit/mappable.rb:250:in `normalize'
	from ./script/../config/../config/../vendor/plugins/geokit/lib/geo_kit/mappable.rb:35:in `distance_between'
	from (irb):20
>> from = MultiGeocoder.geocode('322 8th Ave, New York NY 10001')
=> #<GeoKit::GeoLoc:0xb75bb2fc @zip="10001", @state="NY", @precision="unknown", @success=true, @lng=-73.997206, @city="New York", @country_code="US", @lat=40.747449, @street_address="322 8th Ave">
>> dest = MultiGeocoder.geocode('956 Rhodes Tower, Cleveland OH 44115')
=> #<GeoKit::GeoLoc:0xb757c4bc @zip=nil, @state=nil, @precision="unknown", @success=false, @lng=nil, @city=nil, @country_code=nil, @lat=nil, @street_address=nil>
>> dest = MultiGeocoder.geocode('34-38 75th St, Jackson Heights, NY 11372')
=> #<GeoKit::GeoLoc:0xb7555114 @zip="11372", @state="NY", @precision="unknown", @success=true, @lng=-73.891407, @city="New York", @country_code="US", @lat=40.752292, @street_address="3438 75th St">
>> Location.distance_between(from, dest)
=> 5.55412844927348
>> 

Note here the address did not parse (the Rhodes Tower one) so the
whole stack of cards collapsed.


#########################################################################
070806 Mon 06 Aug 2007 03:22:37 PM EDT

So... around 776,000 photos removed by Veracity, but it missed 40% of
the photos because 200+ of the processes died due to mysql timeouts or
somesuch.

I wrote a new iterator maker that guarantees blocks of 200 users at a
time. Even going to five chars meant 'chris' would do 1000+ users. I
don't know why I ever went with such a complicated scheme; just
counting the users is more than adequate.




#########################################################################
070807 Tue 07 Aug 2007 06:16:24 PM EDT

Got the 'advertiser' accounts created today; but now, after describing
the system to Fernando, I'm wondering why I'm separating the person
from the company. Probably unnecessary. Would probably make the
project easier to just keep them united. I dunno. OTOH it's a one to
one relationship and the Rails book deals with that.




#########################################################################
070808 Wed 08 Aug 2007 03:35:59 PM EDT

I've spent all day so far (see timestamp above) working on the
production database. It turns out the cron job to cull the osc_cart
table was culling the slave database instead of the master; probably
my fault. I've corrected this by fixing the crontabs.

Deleting the old rows from osc_cart took almost an hour and the index
was hosed for a while; it took a while for mysql to get it updated (I
deleted 11 million rows, so I guess that's no real surprise).

Having done that, I removed rows from osc_cart_contents that had a
timestamp of zero, and wiped out another half million rows from
osc_cart_contents_attributes where the cart_contents_id was less than
the smallest one in osc_cart_contents. Doing some left outer joins
shows very few orphan rows now. I need a db patch to fix the foreign
key relationships.

Meanwhile, early this morning we had a huge downpour and the whole
subway system was affected. I walked to 61st and paid $5.75 to take
the LIRR, which got me into Penn at 9:23am! In like Flynn! Fernando
didn't get in until about 11am. He took the 7 to the 1. Jessy never
made it in today; MTA North wasn't running into Grand Central.

I also was involved in the Gallery rollout, and did a store
rollout/rollback/rollout. We fixed VAT finally -- I had Fernando
refactor it and then fix it -- and I put in a patch for a missing
email bug.

I still need to remove dupes from osc_cart_contents...

Had to recreate the tmp directory again on staging in
/opt/mpa/custom-sites/gifts... hrmm...

I should note here I did some prelim work on getting Rails to use the
store database; met with some simple success:

    credit_card.rb      120             Ruby ~/public_html/projects/orderviewer/app/models/credit_card.rb
    database.yml       1107             Text ~/public_html/projects/orderviewer/config/database.yml
    foo.rb               40             Ruby ~/public_html/projects/orderviewer/foo.rb


Connecting to a second database involves passing in a keyword from
database.yml:

class CreditCard < ActiveRecord::Base

  establish_connection(:test_credit_card)

  self.table_name = "credit_card"
end


Which looked like this:



test_credit_card:
  adapter: mysql
  database: store_cc
  username: cc
  password: secret!
  socket: /tmp/mysql.mpa.sock


An order class:

class Product < ActiveRecord::Base
  self.table_name = "osc_orders_products"
  self.primary_key = "orders_products_id"
end


I was able to run the console and manipulate store objects. It was
pretty sweet.



To use ActiveMerchant:

require 'active_merchant' 

>> creditcard = ActiveMerchant::Billing::CreditCard.new(
  :type       => 'visa',
  :number     => '4242424242424242',
  :month      => 8,
  :year       => 2009,
  :first_name => 'Bob',
  :last_name  => 'Bobsen'
)

=> #<ActiveMerchant::Billing::CreditCard:0xb7629788 @month=8, @first_name="Bob", @year=2009, @number="4242424242424242", @type="visa", @last_name="Bobsen">
>> ?> 
?> creditcard.valid?
=> true

?> gateway = ActiveMerchant::Billing::AuthorizeNetGateway.new(:login 'fortune212', :password => 'transaction key removed')
=> #<ActiveMerchant::Billing::AuthorizeNetGateway:0xb75d5804@ ssl_strict=false, @options={:password=>"transaction key removed", :login=>"fortune212"}>

>> response = gateway.authorize(1000, creditcard)
=> #<ActiveMerchant::Billing::Response:0xb759f40c @params={"response_reason_text"=>"This transaction has been declined.", "response_reason_code"=>"2", "response_code"=>2, "transaction_id"=>"1518277208", "avs_message"=>"Address information not provided for address verification check", "avs_result_code"=>"B", "card_code"=>nil}, @success=false, @authorization="1518277208", @test=false, @message="This transaction has been declined">
>> response.success?
=> false



#########################################################################
070811 Sat 11 Aug 2007 01:54:27 PM EDT

Doing the join thing: magic via inflection.

>> addr = Address.find(:first, :conditions => { :city => "Los Angeles", :state => "California" })
=> #<Address:0xb74bfba4 @attributes={"city"=>"Los Angeles", "company_phone"=>"3105592521", "company_cell"=>nil, "zip_code"=>"90034", "country"=>"U.S.A", "company_fax"=>nil, "id"=>"2277", "street_address1"=>"2303 Bagley Ave", "street_address2"=>nil, "state"=>"California"}>
>> photogs = addr.photographer
=> #<Photographer:0xb749726c @attributes={"company_name"=>nil, "business_start_date"=>nil, "advertiser_id"=>"2275", "website_address"=>"www.photobylinda.com", "id"=>"2275", "description"=>"\"Nature, Landscapes,  Portraits, and Enhancements\"", "address_id"=>"2277", "portfolio_id"=>nil, "specialties_id"=>nil, "willing_to_travel"=>"0"}>


Because I used has_one, a method "photographer" is added. With
has_many the method is "photographers".




#########################################################################
070813 Mon 13 Aug 2007 10:49:31 AM EDT

Came in on Saturday, as noted above.

Over the weekend I periodically checked the orders pending; I have
upload_orders.pl commented out in the crontab. We are waiting on an
order to be replaced by pc week for a folded card.

Just found a dumb bug that I released to production:
AnonymousUser->getEmailAddress() was set to private, and I started
calling it from AnonymousUserOrder. Fixed. This is to catch that weird
rare problem where sometimes the order cannot be built because the
email address is not in the billto address.

Random selection:

select website_address from photographers order  by rand() limit 9 ;




#########################################################################
070814 Tue 14 Aug 2007 10:50:51 AM EDT

Chris did work with Jessy yesterday on the folded cards; Kodak says we
aren't telling them if the orientation is horizontal or vertical. I
don't think we've ever specified that; and what's more, TLC is gone
and so is their documentation.




#########################################################################
070815 Wed 15 Aug 2007 11:29:47 AM EDT

I need to customize the list of shell buffers per server; for any
given machine, I'll probably always want: cli, root, and sql. (As a
sensible default).

This means I'll have to master alists, if that's the right name; and
recursing over them, calling (mpa-init-shell). Shouldn't be too hard.

On torque, however, my hack to initialize sudo is not working. Will
have to find a new hack.


#########################################################################
070817 Fri 17 Aug 2007 10:28:53 AM EDT

Yesterday: testing, rollout, trolling the crack pages for TOS
violations.

Fixed two store bugs today: the country dropdown was not defaulting to
United States because of a copy/paste error I made; and the continue
button on the same page didn't work right. It returned you to the page
and lost all your data. Bleh. Gonna file a bug on that
Template::rightCol() method which sucks hard. The method, not the bug
filing.



#########################################################################
070820 Mon 20 Aug 2007 10:26:23 AM EDT

Jessy out sick. Forgot to run the OFS over the weekend, so Peter
emailed that only 72 orders appeared in Sunday's report, but over 400
were placed. Oops. Running that now.

No fatal errors over the weekend for the store -- my "countries" bug
fix worked. Now we have to force people to choose billing address, and
I think that will make the store pretty much 100% done for the time
being (that is, no outstanding usability issues).

We've moved to Torque today, and there's all sorts of things broken
(of course). Too numerous to mention. To help sort things out I shut
down httpd and mysqld on spork.

via AIM on Thu Aug 16 2007, 1:11 PM:

chrisatfcity: i take pride in the sites i work on.
Steve Wainstead: no you dont

For some odd reason the compile of PHP5 on torque didn't pick up
sendmail, so mail does not work. There's no 'district' login via FTP
so end to end OFS testing does not work. These are the remaining two
issues I'm aware of. Oh, and port 3000 to torque is probably blocked
in the firewall. Chris takes forever to fix these things because he's
probably not working on them. It's now 3:45 pm and I haven't gotten
anything done, really. Unless you count testing a system he should
have had operational.



#########################################################################
070821 Tue 21 Aug 2007 01:17:42 PM EDT

Orders are taking forever to push through. I just talked to Peter and
first emphasized that this was entirely my fault; that orders had been
held for folded cards, which seemed to be news to him; and the pipe to
District is small so it's just taking an inordinate amount of time to
upload all the orders.

I have four upload_orders.pl running in parallel, and it's taking
roughly a minute per 2MB file.

Dunno what Chris's problem is today but he's having another Bad Chris
day. I wrote a Perl script to fix all the symlinks (changing from
bob-1 to slow) so Jessy could work.

Mail complains on startup:

2007-08-21 14:31:47.890 Mail[695] Exception raised during monitored invocation of openSynchronouslyUpdatingMetadata:, exception: *** -[NSConcreteData initWithBytes:length:copy:freeWhenDone:bytesAreVM:]: absurd length: -121, maximum size: -2147483648 bytes
2007-08-21 14:31:47.890 Mail[695] +[NSObject(LockingAdditions) clearLocks]: object 0x14d1fc20 still holds lock (count=1) in thread 0x186c000
2007-08-21 14:31:47.890 Mail[695] +[NSObject(LockingAdditions) clearLocks]: object 0x14d98180 still holds lock (count=1) in thread 0x186c000




#########################################################################
070823 Thu 23 Aug 2007 10:19:49 AM EDT

53 orders pending for District, as of this morning. I hit upon the
idea of reducing the size of images before uploading them to District;
this would save bandwidth, and hence, time. I'm thinking we are
throttled on their end and cannot upload more than X bytes per second
regardless of how many connections we make. Meanwhile, Chris got the
Pixami server installed, scheduled a conference call with Tom at
Pixami (because Chris had a number of implementation concerns), and
it's mostly up to Fernando now.

Logging:

>> log = Logger.new("log/development.log")
=> #<Logger:0x34aa698 @logdev=#<Logger::LogDevice:0x34aa648 @filename="log/development.log", @mutex=#<Logger::LogDevice::LogDeviceMutex:0x34aa620 @mon_owner=nil, @mon_waiting_queue=[], @mon_entering_queue=[], @mon_count=0>, @dev=#<File:log/development.log>, @shift_size=1048576, @shift_age=0>, @formatter=nil, @default_formatter=#<Logger::Formatter:0x34aa670 @datetime_format=nil>, @level=0, @progname=nil>
>> log.level = Logger::INFO
=> 1
>> log.info("Hello,sailor!")
=> true
>> 




#########################################################################
070824 Fri 24 Aug 2007 10:10:08 AM EDT

Made progress yesterday. Fixed some bugs and added some features. I
need to get the user choices saved, though, so the email part can be
written.

Merging this in from kristalle; the entry is from Aug 20th.

Installing the GeoKit plugin:
ruby script/plugin install svn://rubyforge.org/var/svn/geokit/trunk

Perhaps I should commit that.

Getting data from the session, via console:


?> @session=CGI::Session::ActiveRecordStore::Session.find_by_session_id("e4bbb1739ee17f31758bbfd313d3fa80")
=> #<CGI::Session::ActiveRecordStore::Session:0x34d83f4 @attributes={"updated_at"=>"2007-08-20 16:17:04", "session_id"=>"e4bbb1739ee17f31758bbfd313d3fa80", "id"=>"2", "data"=>"BAh7BzoLc2VhcmNobzoLU2VhcmNoCToNQGNob2ljZXNbCSIJMTM2MyIJMTQw\nMiIJMTU3OSIJMTU4OToQQGF0dHJpYnV0ZXN7DCIJY2l0eTAiC3RyYXZlbDAi\nDXppcF9jb2RlMCIHaWRpBiIRcGhvdG9ncmFwaGVyMCIPZXZlbnRfdHlwZTAi\nCnN0YXRlMDoQQG5ld19yZWNvcmRGOgxAZXJyb3JzbzoZQWN0aXZlUmVjb3Jk\nOjpFcnJvcnMHOgpAYmFzZUAGOwp7ACIKZmxhc2hJQzonQWN0aW9uQ29udHJv\nbGxlcjo6Rmxhc2g6OkZsYXNoSGFzaHsABjoKQHVzZWR7AA==\n"}>

But invoking the 'data' method, console can't find the Search class:

>> @session.data
ArgumentError: undefined class/module Search

But if I assign it, it works:

>> search = @session.data
=> {"flash"=>{}, :search=>#<Search:0x34d28b4 @errors=#<ActiveRecord::Errors:0x34d2684 @errors={}, @base=#<Search:0x34d28b4 ...>>, @choices=["1363", "1402", "1579", "1589"], @attributes={"city"=>nil, "zip_code"=>nil, "travel"=>nil, "id"=>1, "event_type"=>nil, "photographer"=>nil, "state"=>nil}, @new_record=false>}


Go figure.

(end merged entry from aug 20)

---

You say, "drama in the office today"
You say, "the elderly hispanic guy that comes in for an hour a day to clean up the office was 
drunk"
You say, "like, wobbly drunk. apparently urinated on the bathroom floor. building management 
complained about him."
draco . o O ( that's ... the *opposite* of cleaning. )

---




#########################################################################
070827 Mon 27 Aug 2007 10:55:07 AM EDT

Exhausted. The Heathers kept me up until 5am two nights in a row and
then did dinner at Chris's last night.

expired_premiums.pl: the reason it's "=" and not "<=" is because every
member would get 60 emails instead of one: one each day until they are
finally demoted.




#########################################################################
070830 Thu 30 Aug 2007 04:59:06 PM EDT

Been making more progress on MPP. Got a form that works on multiple
models going. Good stuff. Jessy says she's done with the design of
MPP.

I'm trying to figure out how to do migrations with two databases; I'm
guessing there's a way to do it like one does with ActiveRecord. I
have to go find that too.




#########################################################################
070831 Fri 31 Aug 2007 12:16:58 PM EDT

Jessy's coming along nicely with the gui design and the site is taking
shape. I've had to help her on some issues like getting an image
submit tag to work; a lot of it comes down to code examples, and they
aren't easy to come by.

In the event that I work this weekend (we have a three day weekend
coming up) I got Jessy to flesh out on paper a solution to the issue
of people entering their billing address. I want to make those cc
declines go away.




#########################################################################
070903 Mon 03 Sep 2007 03:09:23 PM EDT

I think it came to me in the shower today, this Labor Day of 2007. So
here I am at work.

I have been having trouble with this app (MPP) because it talks to two
databases. How do I create a migration that works with the other
database? I thought I'd just cheat, create a whole new project to
manage the migration, and move forward.

This now seems like an even better idea than before because I have a
totally separate credit card admin interface. I created my migration,
I run Mongrel in a seperate buffer on a different port, and I can
see the changes to the cc db in real time, using one of those
automatic scaffolds.

Since ActiveRecord builds the CreditCard class from the db schema,
there's no duplication of code either.


#########################################################################
070906 Thu 06 Sep 2007 11:12:39 AM EDT

Out sick two days. Stomach flu, or somesuch.

That search bug appears to be due to incomplete data:

 RuntimeError in Search#search

Showing app/views/search/_photographer.rhtml where line #22 raised:

Called id for nil, which would mistakenly be 4 -- if you really wanted
the id of nil, use object_id

Added a transaction for the advertiser creation form, and everything
nearly works; for some odd reason when the CC is not provided, no
message is given.


#########################################################################
070917 Mon 17 Sep 2007 03:17:09 PM EDT

Back from vacation. Jessy got Peter to reassign me to the Pixami
project. There were two child porn reports, and one call from some guy
at Customs and Immigration Enforcement: Ross Godwin, 530-917-5245.




#########################################################################
070920 Thu 20 Sep 2007 09:43:32 AM EDT

All excellent things are as difficult as they are rare."
-- Baruch Spinoza

Show me your flowchart and conceal your tables, and I shall continue
to be mystified. Show me your tables, and I won't usually need your
flowchart; it'll be obvious.
-- Fred Brooks, "The Mythical Man-Month"


#########################################################################
070921 Fri 21 Sep 2007 05:20:23 PM EDT

This week has been pretty much absorbed by FTP problems to District
Photo. It started when they informed us of a high number of corrupted
files; and OFS failures soared the day after I left for vacation.

My first fix was to measure the file size on the remote server. What
happened was a timeout would occur:

Net::FTP=GLOB(0x8842c9c): Timeout at /opt/mpa/dpi/ofs/lib/DPI_ShippingPart.pm line 476
[/opt/mpa/dpi/ofs/bin/upload_orders.pl] [pid 2597] [orders_id 75352] [Fri Sep 21 17:02:31 2007] ERROR: didn't get the filename back for /opt/mpa/dpi/orders/to_be_ftped/1000075352/1674934.jpg. (eval bloc\
k returned: ''). Retrying...
[/opt/mpa/dpi/ofs/bin/upload_orders.pl] [pid 2597] [orders_id 75352] [Fri Sep 21 17:02:31 2007] Failed to upload 1674934.jpg, no message returned by server
[/opt/mpa/dpi/ofs/bin/upload_orders.pl] [pid 2597] [orders_id 75352] [Fri Sep 21 17:02:31 2007] Quitting and reconnecting to server...

When it reconnected and resumed uploading, the current file and all
files thereafter were corrupted. Bill sent a few as attachements; they
were all blocky and colored.

So I failed the order if the file sizes differed. This allowed us to
resume uploading, but the timeout problem persisted. At one point we
had 170+ orders pending (District sent a long list of corrupted
orders). Bill also said if we didn't get the issue resolved they'd
have to take us out of order fulfillment until we solved it.

Chris found that we weren't using passive mode for ftp, and the
firewall was blocking a bunch of higher number ports; when he opened
those up, the corruption problems went away (but then, at the same
time we forced passive mode, so maybe that was it?) I don't understand
how closed ports would lead to remote file sizes that were larger.

As the week progressed I made more and more improvements to the OFS:
for example, we now list all files on the remote so we don't have to
upload them if the file sizes are the same. This is a huge win. I also
added get_connection to the DB class, and every method now gets a copy
of the handle via this method. I ping the db on every invocation, so
there should be no more fatal errors due to the db handle going
stale. Turns out the one place where I added this months ago was being
called all the time. I also added more debug output: timestamps on all
lines, number of image files remaining to be sent per order, number of
orders completed for this run.

It's late Friday and we're finally down to 24 orders pending.

Chris set up an FTP server on ims-2 and we tried running 4 processes
in parallel to upload actual orders to it. The same errors occured, so
the problem is on our end somewhere.

Addendum: it's worth noting swg-3's ip address is permitted by
District, as is torque's.

64.52.253.120
67.72.20.96


#########################################################################
070924 Mon 24 Sep 2007 09:30:47 AM EDT

On Friday I finally sold Jessy on the idea that we'll have to reduce
the images for 4x6 prints before uploading them to District; and
probably before Christmas. She thought I originally meant reduce
images on the slow storage. I told her since it was an inevitability
she should probably take ownership of the size reduction.




#########################################################################
070928 Fri 28 Sep 2007 11:35:13 AM EDT

Look at that -- a week without entries. Terrible. I've been moved to
the book project, if I didn't mention that already. This week I mostly
worked on it. I had to spend time running tests for Chris so he could
get tcp packet dumps for F5, since the load balancer seems to be the
culprit (probalby for FC too, but Chris doesn't think so because those
are imbound connections.)

Yesterday there was high drama as it was decided we should ask
Fernando to work longer hours, and he reacted very badly to it. As
feared. But after lunch he seemed to have coped, and he, Jessy and I
worked until 8pm. I had more than I thought to do on the OFS; I'd
worked with him to overcome the blocking issues with the Pixami
server. A bit of mindless hacking yielded great results: we only had
to set a variable in their AJAX file to get Gallery albums into the
browser. We had a conf call earlier in the week because there was a
lot of confusion over how the Pixami server was getting the images.

I think that was primarily it for the week. It always sucks when I
look back and it seems like I did *nothing* this week because I can't
remember it in detail. This is why I should log it all here. Bleh. But
it looks like, from my email, I was still doing some work on the OFS
for the ftp timeout issue.

I have also spent some time refactoring the store code, such as:

Commit from swain (2007-09-25 10:56 EDT)
-----------------

Many changes in this commit:

1. Category IDs come from the database now. This eliminates their
   duplication in ths file.
2. Prefix codes also come from the db now, same reason.
3. Status codes always did, but I simplified the code for them.
4. The instance of this class now holds the above in separate hash
   keys (just read the constructor and you'll see)
5. Subs get_prefix_codes and get_category_codes added.
6. sub pixami_prefix_codes added.
7. Eliminated the lexical variables for prefix codes; we only use the
   calls to this class's methods now. Example: $PRINTS_PREFIX_CODE is
   now always $self->PRINTS_PREFIX_CODE().
8. Added a stub method: get_order_books.
9. Added a broken nonfunctional code block for $BOOKS_DATA_SQL.

  ofs  lib/DBInterface.pm  1.19

Commit from swain (2007-09-26 10:59 EDT)
-----------------

To get rid of all the "magic numbers" in the HERE documents for all
the SQL queries, I wrapped them all in subroutines (so they could
access $self) and changed from HERE docs to sprintf. This trimmed out
a lot of the "our" variables too.

  ofs  lib/DBInterface.pm  1.20

Commit from swain (2007-09-27 14:55 EDT)
-----------------

Removed an old comment block from all files, pertaining to how classes
are instantiated; it was out of date.

  ampiradev  gallery-sc/public_html/includes/custom/archivecd.class.php    1.10
  ampiradev  gallery-sc/public_html/includes/custom/calendar.class.php     1.8
  ampiradev  gallery-sc/public_html/includes/custom/cart.class.php         1.134
  ampiradev  gallery-sc/public_html/includes/custom/foldingcard.class.php  1.11
  ampiradev  gallery-sc/public_html/includes/custom/giftCard.class.php     1.12
  ampiradev  gallery-sc/public_html/includes/custom/gift.class.php         1.10
  ampiradev  gallery-sc/public_html/includes/custom/poster.class.php       1.2
  ampiradev  gallery-sc/public_html/includes/custom/tie.class.php          1.2

Commit from swain (2007-09-27 16:06 EDT)
-----------------

Factored out buildNestedPath() into the base class.

  ampiradev  gallery-sc/public_html/includes/custom/archivecd.class.php    1.11
  ampiradev  gallery-sc/public_html/includes/custom/book.class.php         1.4
  ampiradev  gallery-sc/public_html/includes/custom/calendar.class.php     1.9
  ampiradev  gallery-sc/public_html/includes/custom/foldingcard.class.php  1.12
  ampiradev  gallery-sc/public_html/includes/custom/gift.class.php         1.11
  ampiradev  gallery-sc/public_html/includes/custom/giftCard.class.php     1.13
  ampiradev  gallery-sc/public_html/includes/custom/photoPrint.class.php   1.47
  ampiradev  gallery-sc/public_html/includes/custom/poster.class.php       1.3
  ampiradev  gallery-sc/public_html/includes/custom/product.class.php      1.97
  ampiradev  gallery-sc/public_html/includes/custom/tie.class.php          1.3
  ampiradev  gallery-sc/public_html/includes/custom/tiledtie.class.php     1.2


These are refactorings large and small. So quite a bit of coding this
week; hardly looked at Reddit or the news.

---

HOORAY! I did an end to end test for books. I composed and purchased
one. I then went on to whip up a PHP script to list albums or photos;
checked that in and passed it off to Fernando.

Last great obstacle for me: getting the price of the book into the store.


#########################################################################
071009 Tue 09 Oct 2007 10:56:19 AM EDT

You say, "i email my ops team: when i log in to staging, my .bash_profile is not being read"
You say, "he replies:"
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
When I do the following you'll notice all you entries are there.
root@stg-1:~# su - swain
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
You ask, "should i kill him now, or even better, go back in time and prevent his birth?"
heller [to Wainstead \]: send arnold back in time to kill his mother.
Wainstead \ [to heller]: ooooh, i like that idea best. unfortunately it has a very poor track
record; and then my head of ops will be in charge of saving the world, and that means the machines
will win after all
xorian [to Governor Schwarzenegger Doll]: Can't you do anything right?
heller says, "it sounds like the machines have already won at your office. "
merlin [to Wainstead \]: touch .bash*, log out, wait one minute, log back in, ls -l --time=access,
send log :)
merlin [to Wainstead \]: actually cat .bash* > /dev/null to keep the modified times alone
Wainstead \ [to merlin]: well he also said:
Wainstead \ | I can alsotry from logging in.. I'll just need to reset your password.
You say, "what a fucking rocket scientist"
heller [to Wainstead \]: wtf? 
heller [to Wainstead \]: how did this person become a sysadmin? 

Well, toyed a bit with svn and Emacs; ESR's file is broken. Had to
hardlink /usr/local/bin/svn to /usr/bin/svn to get the default one to
work. Auth is a bitch but once I've logged in it appears I don't have
to do it again.




#########################################################################
071011 Thu 11 Oct 2007 01:07:11 PM EDT

Excellent: found all the Pixami product codes.

mysql> select ProductID, ProductCode, ProductDescription from PxPrintProduct;
+-----------+-------------+----------------------------------------------+
| ProductID | ProductCode | ProductDescription                           |
+-----------+-------------+----------------------------------------------+
|      1700 | ALBUM       | Metropolitan Oversize                        | 
|       130 | ALBUM       | Pocket book 5.5x5.5                          | 
|       123 | ALBUM       | Softcover book - portrait                    | 
|       122 | ALBUM       | Hardcover book - portrait - tip-in cover     | 
|       121 | ALBUM       | Hardcover book - portrait                    | 
|       120 | ALBUM       | Hardcover book - portrait - laminated        | 
|       115 | ALBUM       | Hardcover book - landscape - laminated cover | 
|       113 | ALBUM       | Hardcover book - landscape - die cut cover   | 
|       110 | ALBUM       | Hardcover book - landscape - tip-in cover    | 
|       111 | ALBUM       | Hardcover book - landscape - no tip-in cover | 
|       112 | ALBUM       | Softcover book - landscape                   | 
|      1701 | ALBUM       | Metropolitan Standar                         | 
|      1702 | ALBUM       | Metropolitan Compact                         | 
|      1710 | ALBUM       | Everyday Standard                            | 
|      1711 | ALBUM       | Everyday Expandable                          | 
|      1712 | ALBUM       | Everyday Compact                             | 
|      1720 | ALBUM       | Photo Clutch Outer Wallet                    | 
|      1721 | ALBUM       | Photo Clutch                                 | 
|      1730 | CALNDR      | Calendar Style 1                             | 
|      1731 | CALNDR      | Calendar Style 2                             | 
|      1732 | CALNDR      | Calendar Style 2b                            | 
|      1733 | CALNDR      | Calendar Style 3                             | 
|      1734 | CALNDR      | Calendar Style 4                             | 
|      1735 | CALNDR      | Calendar Style 5                             | 
|      1750 | CARD        | Card - Round About                           | 
|      1751 | CARD        | Card - Joy                                   | 
|      1752 | CARD        | Card - PeaPod                                | 
|      1753 | CARD        | Card - Poster Card                           | 
|      1754 | CARD        | Card - Star                                  | 
|      1755 | CARD        | Card - Sleigh                                | 
|       809 | MINICAL     | Value Calendar (7x5.5x2 B)                   | 
|       808 | CALNDR      | Premium Calendar (11x8.5x2 B)                | 
|       807 | MINICAL     | Value Calendar (8.5x5.5x2)                   | 
|       806 | CALNDR      | Premium Calendar (11x8.5x2)                  | 
|      1100 | CARD        | Landscape mode (7x5) card                    | 
|      1101 | CARD        | Portrait mode (5x7) card                     | 
|       160 | ALBUM       | Portrait 5x5 book - die-cut cover            | 
|       161 | ALBUM       | Portrait 5x5 book - laminated cover          | 
|       170 | ALBUM       | Landscape 11x8.5 book - die-cut cover        | 
|       171 | ALBUM       | Landscape 11x8.5 book - laminated cover      | 
|       166 | ALBUM       | Portrait 12x12 book - die-cut cover          | 
|       167 | ALBUM       | Portrait 12x12 book - laminated cover        | 
|       131 | ALBUM       | Pocket 4x4 Book                              | 
|       168 | ALBUM       | Landscape 7x5 book - die-cut cover           | 
|       169 | ALBUM       | Landscape 7x5 book - laminated cover         | 
|       164 | ALBUM       | Portrait 8.5x11 book - die-cut cover         | 
|       165 | ALBUM       | Portrait 8.5x11 book - laminated cover       | 
|       162 | ALBUM       | Portrait 8x8 book - die-cut cover            | 
|       163 | ALBUM       | Portrait 8x8 book - laminated cover          | 
+-----------+-------------+----------------------------------------------+
49 rows in set (0.00 sec)





#########################################################################
071016 Tue 16 Oct 2007 01:11:08 PM EDT

Steve Wainstead: what were the time frames again?
chrisatfcity: 2:00am 5:00am
chrisatfcity: 8:17am 8:23am



#########################################################################
071022 Mon 22 Oct 2007 11:37:49 AM EDT

Books launched Friday; never did find out what fixed the 500
error. Jessy said Chris did something, and he's probably not going to
tell us.

Six orders over the weekend. One had to be redone because the customer
chose another template for the front page.




#########################################################################
071024 Wed 24 Oct 2007 05:37:13 PM EDT

Thinking about what needs doing for discounts... haven't looked at it
in months:

1. This, in Offer:

            if ($o['type'] == 'F') {
                $amount_applied = $this->applyDollarAmount( $where, $o['amount']);
            } elseif ($o['type'] == 'P') {
                $amount_applied = $this->applyPercentage( $where, $o['amount'], $o['minimum_order']);
            } elseif ($o['type'] == 'E') {
                $amount_applied = $this->applyShippingDiscount( $where, $o['amount'], $o['minimum_order']);
            }


needs to be moved to DiscountFactory. Each method needs to go away
completely. We need a PercentOffer, a DollarAmountOffer, and a
ShippingDiscountOffer (or whatever I decide to call them). New offers
would be BuyOneGetOneReduced or somesuch. All probably just use an
apply() method, making apply() in Offer go away completely.

2. This means I have to develop a test suite first, to make sure
   offers and coupons are still working as I refactor.

3. Offer methods need to come out of Discount and into Offer for
   now. Then, perhaps, subclass Offer into the above listed types and
   move their methods down there. Then the factory has to instantiate
   them. Yada yada.




#########################################################################
071026 Fri 26 Oct 2007 12:25:58 PM EDT

Two new types of offers: Buy one, get % off second (B), and buy one
get dollars off second (D).

How to create:


-- insert into osc_offers_description values(95, 1, 'Half off second poster', 'Half off second poster');

-- INSERT INTO `osc_offers` 
-- (offer_id,
-- type,
-- code,
-- amount,
-- minimum_order,
-- start_date,
-- expire_date,
-- uses_per_coupon,
-- uses_per_user,
-- restrict_to_products,
-- restrict_to_categories,
-- restrict_to_customers,
-- joined_startdate,
-- joined_finishdate,
-- auto_apply,
-- partial_redeem,
-- grant_on_signup,
-- active,
-- date_created,
-- date_modified,
-- minimum_quantity)
-- VALUES 
-- (95,
-- 'B',
-- 'halfoffposter2',
-- '50.0000',
-- '0.0000',
-- '2007-06-15 00:00:00',
-- '2018-06-15 00:00:00',
-- 0,
-- 1,
-- '',
-- '32',
-- NULL,
-- '0000-00-00',
-- '0000-00-00',
-- 0,
-- 0,
-- 0,
-- 'Y',
-- '2007-06-15 17:17:56',
-- '2007-06-15 17:17:56',
-- 2);



-- insert into osc_offers_description values(96, 1, 'Two bucks off second mug', 'Two bucks off second mug');

-- INSERT INTO `osc_offers` 
-- (offer_id,
-- type,
-- code,
-- amount,
-- minimum_order,
-- start_date,
-- expire_date,
-- uses_per_coupon,
-- uses_per_user,
-- restrict_to_products,
-- restrict_to_categories,
-- restrict_to_customers,
-- joined_startdate,
-- joined_finishdate,
-- auto_apply,
-- partial_redeem,
-- grant_on_signup,
-- active,
-- date_created,
-- date_modified,
-- minimum_quantity)
-- VALUES 
-- (96,
-- 'D',
-- 'twobucksoff2mugs',
-- '2.00',
-- '0.0000',
-- '2007-06-15 00:00:00',
-- '2018-06-15 00:00:00',
-- 0,
-- 1,
-- '1101,1103,1104,1105,1114,1117,1122,1123,1125,1126',
-- '',
-- NULL,
-- '0000-00-00',
-- '0000-00-00',
-- 0,
-- 0,
-- 0,
-- 'Y',
-- '2007-06-15 17:17:56',
-- '2007-06-15 17:17:56',
-- 2);

The gist of it: I've added a new column, "minimum_quantity," which is
probably always going to be 2 for these offers. For type B, "amount"
is a percentage off. For type D, "amount" is a dollar amount off the
second item.


#########################################################################
071029 Mon Oct 29 17:06:37 2007

Driving mpp via runner:

kristalle:/home/swain/public_html/projects/myphotopro swain$ script/runner --environment=swain 'puts User.find(7).name'
Steve Wainstead

This puts me close to being able to send emails.



#########################################################################
071031 Wed 31 Oct 2007 12:08:37 PM EDT

N6PK9CWQRBSV calendar ID.

A bug in the store code meant people getting triple discounts on card
orders. The bug was from multiple rows being returned by the query,
which I found when I added the buy-one-get-one-free stuff. I didn't
propagate the fix to the other methods; and what's more, I don't think
this bug was there before. Puzzling.




#########################################################################
071101 Thu 01 Nov 2007 10:30:38 AM EDT

It seems I can pretty much just use all the "book" code from the OFS
for calendars too... that is, OrderPartBooks.pm will become
OrderPartPixamiProducts.pm. The reason being: OrderPartBooks and
OrderPartCalendars would be completely identical anyway, needing
identical methods in the DBInterface class. It would be a lot of
pointless copy and paste programming.




#########################################################################
071106 Tue 06 Nov 2007 05:46:30 PM EST

Out sick yesterday. I feel pretty lousy right now; it's almost six.

Meanwhile, I think a fundamental shift in the OFS would be
useful. Rather than dealing in WholeOlders, we should focus on the
shipping part. Each should be allowed its own status... in a way this
means the analogy breaks down when it's time to ship the
order. Well... I guess a WholeOrder can be instantiated, it can check
the status of its shipping parts, and act accordingly... this is
really about having an order with a print part and a slimline card
part; I don't want the prints to be uploaded, then the order held for
the card, then the whole order resent when the card is
vetted. WholeOrder should honor the orders_status of its parts.




#########################################################################
071109 Fri 09 Nov 2007 03:15:42 PM EST

Chris's addition of isRoot() uncovered an ongoing bug; one Fernando
knew about. There are orphan albums. The orphan has a parent name, but
the parent does not have it in its photos.dat array.

I think an integrity check is in order here: if the album is not a
root album, summon the parent and make sure they are in
agreement. Typically this will involve adding the orphan to the
parent's array, as a fix.

Album has a method getSubAlbums() that returns an array of
subalbums... this is the key, then; after the initial checks
(config.php and so on), before we traverse all the Gallery objects an
integrity check should be done on parent-child relationships.




#########################################################################
071112 Mon 12 Nov 2007 02:08:56 PM EST

A round of bug fixes upon arrival today; an Icelander ordered a Kideo,
the free shipping coupon wasn't working with anonymous checkout,
and... I think that's it. I also improved the error page, which now
shows an actual message to the user. Am waiting on the Pixami server
rollout: I created two new albums on plookfish for testing.


Figured out the problem: album08's photos.dat is written out three
times. Last write wins. Last write doesn't include albums 10 and 11.




#########################################################################
071115 Thu 15 Nov 2007 11:33:47 AM EST

Oops. I deleted all club members from the database on
development. Chris put a new power supply into spork and I got the
relevant rows for me, Jessy and Fernando. We're back in business.

Longer story: While tinkering with veracity.php, I was trying to
figure out why Chris had added the "isRoot()" method call at one
point... he said because duplicates were showing up in his
tables. This doesn't make sense, since there's an album name caching
hash in veracity.php to prevent albums from being visited more than
once.

What he probably meant, and I think I remember him saying this months
ago, is that albums with no parent were showing up in his mpa_albums2
table.

So what really happened was he found a long standing bug, a subtle and
infrequent one, where users are losing an album. It turns out 1,103
people on production have "orphaned" albums. Some of these created
accounts with us as recent as the end of October.

I started retooling veracity to add these albums to the parent album;
all the data is there to do it. For example, album08 has no children,
but album10 says its parent album is album08. Simple, no?

No. Gallery opened three copies of album08 in the course of its run;
the data I saved when into the first and second instances (album11
also was an orphan of album08), so the last write "won."

It turns out this typical construct in Gallery:

$pAlbum = new Album();
$pAlbum->load($pAlbumname);

in fact gets the pickled instantiation in the album.dat file and then
does a memberwise copy ("cloning" in Java terminology). What a waste!
Why was it done this way? My one guess is because of Gallery upgrades,
this prevented issues with the pickled class not matching the new
class definition, if it changed. (I never thought of that until just
now. Sometimes writing in my log is a form of rubber ducking).

But then again, that can't be true, can it? The $tmp album would never
instantiate so cloning wouldn't work. Hrmm. My other guess is it's due
to some PHP4 wonkiness, and fail that, just plain bad coding.

So. This lead me to creating a branch in Gallery
(R_SWAIN_REFACTORED_BRANCH) and hacking at Gallery's internals. This
went quite well: I removed all Album constructor calls, and Gallery
only calls AlbumDB's getAlbumByName() in any given case. This means no
more copies are made, and in PHP5 all references to an album
are.. er... references, like in Java (no pass by value, only pass by
reference). Or it should be. Gallery worked just fine.

But when I ran veracity with this experimental Gallery
codebase... look out! I toasted swain.myphotodevel.com. For some weird
reason subalbums were being reinserted all over the place. Some kind
of looping/recursion issue perhaps? The fault probably lies in the new
function verifyParentage() in verify-lib.php.

This, anyway, lead me to the problem of creating a test site that can
be deleted and recreated. So 'autotest' was born yesterday.

www@torque:/home/www$ cat ./rm_autotest.sh
# delete the 'autotest' account. Can be recreated with 'mk_autotest.sh'.

EXECUTESQL='/d0/mysql/mpa/bin/mysql -S /tmp/mysql.mpa.sock -uroot mpa -e'
$EXECUTESQL 'call delete_autouser()'

rm -rf /mnt/slow/vol01/a/au/aut/auto/autot/autotest
rm -rf /mnt/fast/vol01/a/au/aut/auto/autot/autotest


www@torque:/home/www$ cat ./mk_autotest.sh
# Use this script to recreate the autotest site.
# Delete it without banning it first, of course.

/opt/mpa/admin/unix-bin/createaccount.pl autotest 112233 autotest@test.myphotodevel.com

cd /home/swain/cvs/pgms/perl
./lhhreplay.pl ./autotest/autotest_createalbums.lhh

cd /mnt/slow/vol01/a/au/aut/auto/autot
tar xzvf /home/www/autotest.slow.tgz
cd /mnt/fast/vol01/a/au/aut/auto/autot


Running lhhreplay here is not strictly necesary, and in my first run,
it failed due to css files 404'ing. There's the problem of lhhreplay's
input files going stale, which they do. So that step is probably good
for nothing. It would be the subsequent lhhreplay scripts I write to
test all of Gallery's functionality that would be more useful anyway.

Oh, my delete_autouser() is defined in
./cvs/pgms/sql/delete_autouser.sql:

swain@torque:~/cvs/pgms/sql$ cat ./delete_autouser.sql
-- delete user 'autotest' from the system
DELIMITER $$

DROP PROCEDURE IF EXISTS delete_autouser $$

CREATE PROCEDURE delete_autouser()
BEGIN

DECLARE autotest_userid INT;

SELECT userid INTO autotest_userid FROM users WHERE username = 'autotest';

DELETE FROM users                 WHERE userid      = autotest_userid;
DELETE FROM userinfo              WHERE userid      = autotest_userid;
DELETE FROM userstats             WHERE userid      = autotest_userid;
DELETE FROM prem_packages_history WHERE customer_id = autotest_userid;
DELETE FROM mpa_photos            WHERE subdomain   = 'autotest';
DELETE FROM mpa_albumitems        WHERE userid      = autotest_userid;
DELETE FROM mpa_albumitems2       WHERE user_id     = autotest_userid;
DELETE FROM mpa_albums2           WHERE user_id     = autotest_userid;
DELETE FROM mpa_points            WHERE username    = 'autotest';

END $$
DELIMITER ;

---

Meanwhile: buy one, get 50% of the second. This means: 

mysql> select (9 - ( 9 % 2));
+----------------+
| (9 - ( 9 % 2)) |
+----------------+
|              8 | 
+----------------+
1 row in set (0.00 sec)

mysql> select (8 - ( 8 % 2));
+----------------+
| (8 - ( 8 % 2)) |
+----------------+
|              8 | 
+----------------+
1 row in set (0.00 sec)


For buy two, get 50% of the third, the modulus argument would be
three:

mysql> select (9 - ( 9 % 3));
+----------------+
| (9 - ( 9 % 3)) |
+----------------+
|              9 | 
+----------------+
1 row in set (0.00 sec)

mysql> select (8 - ( 8 % 3));
+----------------+
| (8 - ( 8 % 3)) |
+----------------+
|              6 | 
+----------------+
1 row in set (0.00 sec)


In the second case, only 6 items qualify. So only two items are
discounted. Thus, six times the percentage off is the amount deducted?
Probably...




#########################################################################
071127 Tue 27 Nov 2007 03:33:31 PM EST

Yay jet lag. Saves me from Milch today.

Have been hunting down a bug where subtotal did not match total; that
is, it shows up in the osc.log like this:

5c5b3dbb5869e7ccaad0ba87dba14d0d  2007-11-15  09:14:17 :: ERROR: subtotal from osc_orders_total (9.9500) doesn't match total from osc_orders_products (19.9000)

The reason for this is weird. checkout_process.php was called twice,
simultaneously:

69.159.233.243 - - [15/Nov/2007:09:14:14 -0500] "POST /checkout_process.php HTTP/1.1" 302 26
75.137.178.61 - - [15/Nov/2007:09:14:16 -0500] "GET /login.php?new_cust=yes&action=login&goto=&x=87&y=17 HTTP/1.1" 302 26
75.137.178.61 - - [15/Nov/2007:09:14:16 -0500] "GET /enter_address.php HTTP/1.1" 200 12799
69.159.233.243 - - [15/Nov/2007:09:14:14 -0500] "POST /checkout_process.php HTTP/1.1" 302 26

This is the actual order it shows up as in the log. (My grammar
aside). So here's one reason why we occasionally see this bug.

svn checkout https://svn.corp.fortunecity.com/myphotopro/trunk


svn import . https://svn.corp.fortunecity.com/swain/trunk
svn import . https://svn.corp.fortunecity.com/swainlisp/trunk

This file now under Subversion. gosh. wow. golly gee willickers.


#########################################################################
071130 Fri 30 Nov 2007 10:13:27 AM EST

Out sick yesterday.

Thinking about vetting of gifts: the ideal thing would be to make use
of the ofs_orders_parts_status table. Add a new column `vetted`, which
defaults to zero. If this OrderShippingPart needs vetting, AND
ofs_orders_parts_status.vetted == 0, then change the status to 'held'.

Now, does this all fit together? Moving something to 'held' only
occurs when it's time to ship the thing to the printer -- step 7.

(Aside: two refactoring projects: update all the order status numbers,
and rename the columns in ofs_orders_parts_status).

The goal here is to let Jessy look at held orders and vet the
individual order shipping parts. The OFS is going to have to pull out
all orders of status 7 and state 'ready'.



#########################################################################
071203 Mon 03 Dec 2007 05:29:11 PM EST

Victory, as I got Rails to send an email from kristalle to ... well,
kristalle, but via ims-1. Huzzah. So that means I got the
configuration right and all.

I should propagate the config to dev too. It might differ
slightly. Meanwhile: did all kinds of piecemeal work today. I debugged
the crontab on mdb-2 (my fault), did various assists with the OFS,
pushed Ferry to get the OFS to talk to the Pixami server (no dice yet,
says the low level routing is a problem), tinkered with eye.fi quite a
lot, finished reading the SVN book, and also finished up my Japan
uploads.




#########################################################################
071204 Tue 04 Dec 2007 11:21:57 AM EST

The cron job for sending emails should be this simple:

/Users/swain/Sites/projects/sendmyemail/script/runner 'PhotogMailer.deliver_lead()'

Runner only needs something like a line or two of Ruby. Originally I
did it this way, in the sendmyemail project I created:

kristalle:/home/swain/public_html/projects/sendmyemail swain$ script/runner 'PhotogMailer.create_send_emails()'
Date: Tue, 4 Dec 2007 10:45:25 -0500
From: leads@myphotopro.com
To: swain@corp.fortunecity.com
Subject: Hello, photographer!
Mime-Version: 1.0
Content-Type: text/plain; charset=utf-8

Dear so and so, 

You have a lead!

You will be charged at the end of the month.
---


And earlier than that:

kristalle:/home/swain/public_html/projects/sendmyemail swain$ script/runner 'email = PhotogMailer.create_lead(); puts email.encoded;'
Date: Tue, 4 Dec 2007 10:43:17 -0500
From: leads@myphotopro.com
To: swain@corp.fortunecity.com
Subject: Hello, photographer!
Mime-Version: 1.0
Content-Type: text/plain; charset=utf-8

Dear so and so, 

You have a lead!

You will be charged at the end of the month.
---


So all I need is a method on the ActionMailer subclass called 'leads()'
which will be called this way: 'deliver_leads()'. It uses reflection
to do the correct thing. I had trouble when I defined a method
send_emails on the ActionMailer subclass and tried to call it
directly; kept getting 'method not found' errors. I guessed correctly
that all methods have to be called create_xxx or deliver_xxx.

How to run stuff from a script:

#!/usr/bin/env /Users/swain/Sites/projects/myphotopro/trunk/script/runner
@users = User.find_all_by_emails_sent(0)
puts @users[5].photographers


Found this via script/runner -h. Output:


kristalle:/home/swain/public_html/projects/myphotopro/trunk swain$ script/foo --environment=swain
#<Photographer:0x2589628>
#<Photographer:0x2589600>
#<Photographer:0x25895d8>

I'm stuck on the architecture question: where does the behavior go for
sending the emails? Seems like the User class would get
it... something like:

@users = User.find_all_emails_sent(0)
foreach @users |u|
    u.send_thankyou_email
    foreach u.photographers |p|
       p.send_lead_email
    end
    update the row for the user (u.emails_sent= Time.now; u.save)
end



#########################################################################
071206 Thu 06 Dec 2007 08:39:34 AM EST

Yesterday I spent considerable time trying to solve a bug where, for
anonymous users, the credit card number disappeared. It was clear from
the log in /tmp on the osc servers that the store submitted the charge
to Authorizenet with no credit card number.. about 8 people in the
last 42 days met this bug. Couldn't reproduce it, couldn't find a
cause; so I put in what I hope will be a solution. The anonymous user
class will send the user to the payment selection page if there's no
credit card number.

Also, had to remove the PixamiEscape class calls in the OFS so '$da'
would stop showing up in addresses. Sadly I wasted nearly a day
writing that stuff per Tom at Pixami, and Woody Yu said to remove
it. That's live. Have to scrap that class and stuff.

Long fun manager's meeting too. We're all ebulliant because MPA is
doing so well last month and this:

--------------------------------------------------
Total Transactions: date, # of transactions, money

DATE     TRANSACTIONS    $$$$$
12-01       121        3,127.94
12-02       220        6,528.94
12-03       176        4,774.17
12-04       178        4,392.29
12-05       181        4,745.84

------------------------------------
Total Transactions, total this month

TRANSACTIONS    $$$$$
876         23,569.18

---------------------------------------------------------------------
Total Transactions by day, last month: date, # of transactions, money

DATE     TRANSACTIONS    $$$$$
11-01       219        2,653.66
11-02       182        2,234.71
11-03       148        2,336.27
11-04       195        2,937.80
11-05       155        2,600.39
11-06       150        2,544.76
11-07       121        2,246.91
11-08       110        1,852.57
11-09       101        1,909.05
11-10        91        1,505.73
11-11       116        2,532.66
11-12       151        2,440.61
11-13       118        1,895.74
11-14       140        2,748.41
11-15        95        1,933.42
11-16       104        1,673.50
11-17       106        1,715.96
11-18       145        2,612.31
11-19       126        2,119.30
11-20       109        1,834.09
11-21       103        1,767.57
11-22        82        1,785.35
11-23       104        2,556.72
11-24       114        2,018.74
11-25       158        3,595.24
11-26       181        3,262.58
11-27       143        2,591.24
11-28       155        4,026.08
11-29       142        4,049.30
11-30       102        2,799.88

-----------------------------
Total transactions last month

TRANSACTIONS    $$$$$
3975        72,780.55

---

Some notes about MPP:

I do the development on my Mac. Jessy controls the deployment on
torque, in /opt/mpa/custom-sites/jhanley/. She did all her work under
CVS, and since then Chris moved the project to SVN because Capastrano
requires it.

Meanwhile: I do my development with Mongrel, which comes with Rails;
Chris chose fastcgi to deploy MPP under Apache. Makes sense.

For credit card stuff, I created the project mpp_credit_card because I
couldn't work out how to do database migrations with two
databases. This gives us a separate credit card admin interface,
however, on a different port, so that may or may not be a win.

The credit card class has a symbol passed into the connect method
specifying the database info to use from database.yml. Unfortunately I
don't know how to make this conditional based on the server we're
running on (my mac versus torque, that is).

---

Been fighting Rails, trying to get advertiser.address to save
correctly. It won't. Puzzling. But I think the advertiser's address
was just the billing address. The photographer has an address, and I
didn't notice this at the outset.





#########################################################################
071207 Fri 07 Dec 2007 10:33:35 AM EST

The Advertiser class has a guaranteed unique email address; this is
the key to identifying them.

Very quiet day here: Jessy and Chris are both off.

I made good progress today: I spent time on the admin interface. I got
reacquainted with how to do authentication: the forgotten part was the
before_filter business, which is like Emacs's (defadvice) feature
(before advice, after advice). Now all the admin controllers are
password protected and it should be easy enough to do an account
controller for the advertisers, so they can manage their accounts.

And, the account controller is created; I think basic authentication
is now working for advertisers. The methods/views all have to be
fleshed out which will be a considerable piece of work.





#########################################################################
071210 Mon 10 Dec 2007 10:43:52 AM EST

Fernando estimates 3-4 hours a day pushing through book and calendar
orders. Ridiculous.

Had a huge child porn site over the weekend. I think the copy failed
when it was being removed; the browser returned successfully, but most
of the full sized images are missing. Today I cannot upload a second
batch to the NCMEC; probably their server failed again.

Solved my login problems with the Account controller; I can see now
where I have to put stuff into the 'details' and 'photography' methods
(CRUD ops on the advertiser and photographer stuff).




#########################################################################
071211 Tue 11 Dec 2007 09:25:57 AM EST

Installed MacPorts and RMagick last night. Demo'd what I have for
Peter, who seemed pleased (and pleased he got the thank you email from
MPP).

Met with Chris and Fernando in an attempt to get Ops moving forward
on:

* getting the OFS to talk to the Pixami server
* getting MPP working on torque and staging

End result is: intbuilder.mpa.com should be working today (by
lunchtime, even) so we can at least let the OFS do its thing. MPP by
COB tomorrow, but he was complaining about how much else he has to do
(data center move plan, etc).

We also talked about memcached, and it looks like there are no
roadblocks to working on that; so I need to draw up a plan for that.




#########################################################################
071212 Wed 12 Dec 2007 11:56:40 AM EST

Rolled out the store this morning: calendar and book covers now show
in the shopping cart and confirmation pages. Very yay.

Running Veracity for Chris on mdb-3. Haven't done a whole lot today;
tracked down how to modify the OFS so we send the right mailing code
to Rastar. We were marking all orders domestic. Morning meeting was
longish. Whipped up a little CGI to list the day's orders.

We are having another huge day in sales. A "25% off everything" offer
went out.

We also rolled out a fix for the OFS... actually two, in the last two
days. One: we can talk to the Pixami server now via
intbuilder.myphotoalbum.com; and I left out the line that adds the
order shipping part to the ofs_shipping_part_status table. Fernando
fixed that.

Reread most of my log from the beginning of the year, hoping to find
notes on my work with memcached. I can't believe I didn't preserve
that anywhere.

Found it! Found my hacks for memcached on spork! In a nutshell, I
created a function in util.php called ultrafoo(). It took an album
name and returned the instantiated album, checking to see if it was in
memcached or not.

RCS file: /opt/cvs/ampiradev/gallery/albums.php,v
retrieving revision 1.171
diff -r1.171 albums.php
24c24,35
< $albumDB = new AlbumDB(FALSE);
---
> 
> if ( ! $albumDB = $memcache->get('swain-albumdb') ) { 
>     stderr("No albumDB in cache. Creating...");
>     $albumDB = new AlbumDB(false);
>     $memcache->set('swain-albumdb', $albumDB, false, 0) or die ("Failed to save data at the server");
>     stderr("Added albumdb to cache!");
>     //stderr("cached: " . serialize($albumDB));
> } else {
>     stderr("Got the albumdb from cache!");
>     //stderr("cached version: " . serialize($albumDB));
> }
> 
32a44
> 
36c48,49
< $perPage = $gallery->app->albumsPerPage;
---
> 
> $perPage  = $gallery->app->albumsPerPage;
46,52c59,65
< $navigator["page"] = $gallery->session->albumListPage;
< $navigator["pageVar"] = "set_albumListPage";
< $navigator["url"] = makeGalleryUrl("albums.php");
< $navigator["maxPages"] = $maxPages;
< $navigator["spread"] = 5;
< $navigator["fullWidth"] = 100;
< $navigator["widthUnits"] = "%";
---
> $navigator["page"]        = $gallery->session->albumListPage;
> $navigator["pageVar"]     = "set_albumListPage";
> $navigator["url"]         = makeGalleryUrl("albums.php");
> $navigator["maxPages"]    = $maxPages;
> $navigator["spread"]      = 5;
> $navigator["fullWidth"]   = 100;
> $navigator["widthUnits"]  = "%";
Index: init.php
===================================================================
RCS file: /opt/cvs/ampiradev/gallery/init.php,v
retrieving revision 1.89
diff -r1.89 init.php
35a36,39
> $memcache = new Memcache;
> $memcache->connect('localhost', 11211) or die ("Could not connect");
> //$memcache->flush();
> 
272c276,283
< $gallery->userDB = new Gallery_UserDB;
---
> 
> if ( ! $gallery->userDB = $memcache->get('swain/userdb') ) {
>     stderr("No userdb in cache. Creating and adding it.");
>     $gallery->userDB = new Gallery_UserDB;
>     $memcache->set('swain/userdb', $gallery->userDB, false, 0);
> } else {
>     stderr("Got userdb from cache");
> }
302,303c313,323
< 	$gallery->album = new Album;
< 	$ret = $gallery->album->load($gallery->session->albumName);
---
> 
>     if ( ! $gallery->album = $memcache->get("swain/{$gallery->session->albumName}") ) {
>         $gallery->album = new Album;
>         $ret = $gallery->album->load($gallery->session->albumName);
>         stderr("adding swain/{$gallery->session->albumName} to cache");
>         $memcache->set("swain/{$gallery->session->albumName}", $gallery->album, false, 0);
>     } else {
>         stderr("got swain/{$gallery->session->albumName} from cache");
>         $ret = true;
>     }
> 
429a450
> require("includes/hanley.php");
Index: util.php
===================================================================
RCS file: /opt/cvs/ampiradev/gallery/util.php,v
retrieving revision 1.99
diff -r1.99 util.php
1425,1426c1425,1426
<             $myAlbum = new Album();
<             $myAlbum->load($myAlbumName);
---
> 
>             $myAlbum = ultrafoo($myAlbumName);
1443,1444c1443,1444
<             $myAlbum = new Album();
<             $myAlbum->load($myAlbumName);
---
> 
>             $myAlbum = ultrafoo($myAlbumName);
1547,1548c1547,1548
<     $myAlbum = new Album();
<     $myAlbum->load($albumName);
---
> 
>     $myAlbum = ultrafoo($albumName);
1555,1556c1555,1556
<             $nestedAlbum = new Album();
<             $nestedAlbum->load($myName);
---
> 
>             $nestedAlbum = ultrafoo($myName);
1822,1823c1822,1823
<     $myAlbum = new Album();
<     $myAlbum->load($albumName);
---
> 
>     $myAlbum = ultrafoo($albumName);
1829,1830c1829,1830
<                 $nestedAlbum = new Album();
<             $nestedAlbum->load($myName);
---
> 
>             $nestedAlbum = ultrfoo($myName);
3685a3686,3705
> 
> function ultrafoo($albumname, $loadphotos = true) {
>     global $memcache;
> 
>     if ( empty($albumname) ) {
>         debug_print_backtrace();
>         die("No albumname passed into ultrafoo");
>     }
> 
>     if ( ! $album = $memcache->get("swain/$albumname") ) {
>         $album = new Album();
>         $album->load($albumname, $loadphotos);
>         $memcache->set("swain/$albumname", $album, false, 0);
>         stderr("ultrafoo: Set $albumname in the cache.");
>     } else {
>         stderr("ultrafoo: Got $albumname from the cache.");
>     }
> 
>     return $album;
> }
Index: view_album.php
===================================================================
RCS file: /opt/cvs/ampiradev/gallery/view_album.php,v
retrieving revision 1.245
diff -r1.245 view_album.php
170,171c170,177
<         $pAlbum = new Album();
<         $pAlbum->load($pAlbumName);
---
>         if ( ! $pAlbum = $memcache->get("swain/$pAlbumName") ) {
>             $pAlbum = new Album();
>             $pAlbum->load($pAlbumName);
>             $memcache->set("swain/$pAlbumName", $pAlbum, false, 0);
>             stderr("Added $pAlbumName to cache.");
>         } else {
>             stderr("Loaded $pAlbumName from cache.");
>         }
730,731c736,737
< 			$index=$gallery->album->getIndexByVotingId($id);
< 			$albumName=$gallery->album->isAlbumName($index);
---
> 			$index = $gallery->album->getIndexByVotingId($id);
> 			$albumName = $gallery->album->isAlbumName($index);
734,736c740,749
< 					makeAlbumUrl($albumName). ">\n";
< 			       	$myAlbum = new Album();
< 			       	$myAlbum->load($gallery->album->isAlbumName($index));
---
>                                 makeAlbumUrl($albumName). ">\n";
> 
>                             if ( ! $myAlbum = $memcache->get("swain/$albumName") ) {
>                                 $myAlbum = new Album();
>                                 $myAlbum->load($gallery->album->isAlbumName($index));
>                                 $memcache->set("swain/$albumName", $myAlbum, false, 0);
>                                 stderr("added $albumName to the cache");
>                             } else {
>                                 stderr("Got $albumName from cache");
>                             }
947,949c960,967
< 				$myAlbum = new Album();
< 				$myAlbum->load($myAlbumName);
< 
---
>                 if ( ! $myAlbum = $memcache->get("swain/$myAlbumName") ) {
>                     $myAlbum = new Album();
>                     $myAlbum->load($myAlbumName);
>                     $memcache->set("swain/$myAlbumName", $myAlbum, false, 0);
>                     stderr("Added $myAlbumName to the cache.");
>                 } else {
>                     stderr("Got $myAlbumName from cache.");
>                 }
1171,1173c1189,1197
< 			if ($gallery->album->isAlbumName($i)) {
< 				$myAlbum = new Album();
< 				$myAlbum->load($gallery->album->isAlbumName($i));
---
> 			if ($thisalbumname = $gallery->album->isAlbumName($i)) {
>                 if ( ! $myAlbum = $memcache->get("swain/$thisalbumname") ) {
>                     $myAlbum = new Album();
>                     $myAlbum->load($gallery->album->isAlbumName($i));
>                     $memcache->set("swain/$thisalbumname", $myAlbum, false, 0);
>                     stderr("Added $thisalbumname to cache");
>                 } else {
>                     stderr("Got $thisalbumname from cache");
>                 }
Index: view_photo.php
===================================================================
RCS file: /opt/cvs/ampiradev/gallery/view_photo.php,v
retrieving revision 1.210
diff -r1.210 view_photo.php
185,186c185
<     $pAlbum = new Album();
<     $pAlbum->load($pAlbumName);
---
>     $pAlbum = ultrafoo($pAlbumName);
Index: classes/Album.php
===================================================================
RCS file: /opt/cvs/ampiradev/gallery/classes/Album.php,v
retrieving revision 1.116
diff -r1.116 Album.php
173,174c173
<         $album = new Album();
<         $album->load($albumName);
---
>         $album = ultrafoo($albumName);
181,182c180
<             $parentAlbum = new Album();
<             $parentAlbum->load($this->fields['parentAlbumName']);
---
>             $parentAlbum = ultrafoo($this->fields['parentAlbumName']);
583c581
< 
---
>         stderr("Loaded $name from filesystem.");
1474,1475c1472
<             $parentAlbum = new Album();
<             $parentAlbum->load($this->fields['parentAlbumName'], $loadphotos);
---
>             $parentAlbum = ultrafoo($this->fields['parentAlbumName'], $loadphotos);
1489,1490c1486
<             $album = new Album();
<             $album->load($albumName);
---
>             $album = ultrafoo($albumName);
2077,2078c2073,2074
<                 $nestedAlbum = new Album();
<                 $nestedAlbum->load($this->isAlbumName($i));
---
>                 $nestedAlbum = ultrafoo($this->isAlbumName($i));
>                 
2122,2123c2118
<                 $nestedAlbum = new Album();
<                 $nestedAlbum->load($this->isAlbumName($i));
---
>                 $nestedAlbum = ultrafoo($this->isAlbumName($i));
2133,2134c2128
<                 $nestedAlbum = new Album();
<                 $nestedAlbum->load($this->isAlbumName($i));
---
>                 $nestedAlbum = ultrafoo($this->isAlbumName($i));
2576,2577c2570
<                 $myAlbum = new Album();
<                 $myAlbum->load($matches[1]);
---
>                 $myAlbum = ultrafoo($matches[1]);
2605,2606c2598
<         $myAlbum = new Album();
<         $myAlbum->load($this->isAlbumName($index));
---
>         $myAlbum = ultrafoo($this->isAlbumName($index));
2618,2619c2610
<                     $subAlbum = new Album();
<                     $subAlbum->load($this->getAlbumName($index));
---
>                     $subAlbum = ultrafoo($this->getAlbumName($index));
Index: classes/gallery/UserDB.php
===================================================================
RCS file: /opt/cvs/ampiradev/gallery/classes/gallery/UserDB.php,v
retrieving revision 1.6
diff -r1.6 UserDB.php
135a136
>         global $memcache;
146c147,153
< 		$user = new Gallery_User();
---
>         if ( ! $user = $memcache->get("swain/$uid") ) {
>             $user = new Gallery_User();
>             $memcache->set("swain/$uid", $user, false, 0);
>             stderr("Set swain/$uid in the cache");
>         }
>         else { stderr("Loaded user object from cache"); }
> 



#########################################################################
071213 Thu 13 Dec 2007 03:21:20 PM EST

The demo sucked this morning; I should have tested the app. The db
needed raking, and for that matter, the data imported. Stupid.

Jessy laid into me for the chart thing... said Peter was visibly put
off, which he was. I could have stated things better.

Got Dylan all set up with Rails/SVN on torque, plus shell access.




#########################################################################
071214 Fri 14 Dec 2007 11:07:06 AM EST

I give up. Chris is against storing the images for MPP in the
database, so I'll have to implement a file management system in
Rails. It really pisses me off. A complete waste of time.

And, some time later, Chris provides a bunch of links and rethinks the
BLOB issue. I have to admit I'm not too keen on storing the medium
sized images in the database.

I implemented email confirmation in MPP. Peter tested and was
impressed.


#########################################################################
071217 Mon 17 Dec 2007 10:22:42 AM EST

Vetted cards; I think Fcat might have been at it too because they were
shrinking in number before I got to them. Or maybe not. Set up Dylan
with fixing up the stylesheet for the admin controller. Found a weird
error in the store from yesterday but it's something Jessy was trying
to buy, with an expired coupon. Never saw that error before.

I know I ended Friday with throwing out the "event types," since I'd
already created "specialties." 

"Sending" the emails via the console:

@user = User.find_by_id(23)
@user.send_thankyou_email
@user.send_leads



#########################################################################
071218 Tue 18 Dec 2007 11:13:07 AM EST

Told Jessy she has to give me ten bucks to fix a store bug. Quantities
on the order confirmation page are wrong.

Bleh. Took forever to solve a bug with display of an order in
checkout_success.php. In the end I just stripped out all the category
crap. Why was that in there?

Whipped up a form to send emails out for a given user. Was a good
excercise for me in Rails!

When I come back: hack the photographer signup form to work in the
account administration.



#########################################################################
080103 Thu 03 Jan 2008 06:31:04 PM EST

Oops. Was back yesterday. Chris and I did battle with merging the
Pixami stuff in; no dice. Reviewed that with Fernando today and I
think he's on top of it. Had a meeting with Jessy and Peter; went over
the social networking stuff she wants to do. A lot of my dev projects
have to come first... well, at least: moving subusers into the
database. Moving basic album/photo metadata into the DB would also be
useful. I now wonder, tiredly, if a Gallery class is even necessary. I
suppose for permissions testing, it does.

I've started identifying what needs doing and possible issues... I
suppose I should draw up a full set of use cases?



#########################################################################
080104 Fri 04 Jan 2008 01:20:40 PM EST

Overarching dev projects are:

1. autorenew
   * will have to force store account creation -- cc must be linked to
     the site. To do this we need to ask the Cart if it has a club
     with autorenew checked.
   * user must opt out of autorenewal (in the store)?
   * batch cc processing needed (can be done later)

2. credit card editing
   * CRUD. Just copy what Amazon does.

3. memcached
   * refactoring gallery internals:
      * smoothing out the gallery API via refactoring
      * making it far more efficient (in terms of object construction)
   * needs a LOT of testing

4. move all user data to mysql
   * move subusers
   * do we need a special subuser class?

5. convert all album data to sqlite
   * more or less, preserve current format

6. pathless gallery
   * need a "final" veracity run to import data
   * veracity will have to be the "maintainence" program
   * building new tables "one last time"
   * gallery uses db info (cutover)
   * progressively introduce "rootless" albums via spreading

7. gallery object
   * encapsulate the $gallery variable as a new singleton


Chris made a presentation today on the data center move; planned
completion date is March 30th. His quote of the day: "It took me 30
minutes to find a chair" (at the data center; he had "chair, keyboard,
mouse" listed under one of the todo items). Jessy laughed for what
seemed like five minutes.





#########################################################################
080107 Mon 07 Jan 2008 01:14:06 PM EST

Came in Saturday, but didn't do a whole lot: merged Gallery's HEAD to
my branch and resolved conflicts. Found a bug where creating a new
album ads it to the end instead of the front. Upgraded Rails to 2.0.x
and did some testing; worked OK. Emailed Ops to upgrade
torque. Already done today, too! Huzzah.

Fleshed out two mini-specs on credit card editing and autorenewal for
Fernando, but I need to give him deadlines. Editing shouldn't take
more than two days, really. If that. AR will take quite a bit more
work.

So.. returned to working on technical specs. Jessy's first part of the
social networking project already existed; so I noted that at the top
of her page. Most of the page dealt with the later goal of displaying
shares on the target user's friends page anyhow.

Combining address book and subusers: well, we technically don't have
to merge the tables. I have to think on this one a bit.

I hacked gallery/UserDB.php briefly to allow '@' and '.' in usernames,
so that solves that... it seems people in the address book will be
moved to the subusers table, and this should be moderately easy.

User who can only view one album: we send in the email a hashkey:

sitename + album + our secret word == hashkey;

When the user hits the URL for that album:

swain.myphotodevel.com/view_album.php?hashkey=UmFuZG9tSVY0DT

Some mechanism will have to test if it's a valid hashkey or
not... algorithmically:

if ($hashkey) 
   if ($gallery->album->isViewableWithHashkey($hashkey)) {
   ....

Where to store the hash keys? With the album, it would seem. Perhaps a
many to many table thusly:

albumid | hashkey

would be simpler.


Interlude: stipped all $Id$s from gallery and osccommerce.





#########################################################################
080108 Tue 08 Jan 2008 10:15:57 AM EST

For "Friends," merging the address book and the subusers creates a
problem. How do you then associate the actual users? So perhaps a list
of contacts is still necessary and separate from the subusers. 



#########################################################################
080109 Wed 09 Jan 2008 02:00:40 PM EST

Where's the week going? Meanwhile: merging branches has been rough due
to the Id tag. Been removing those, and that alone is a PITN. (Pain in
the neck). Also told Ferry not to use curse words in code anymore
because we might get audited at a later date. Heh. Something that
concerns him.

Hmm. Wonder if PHPDoc is still running... nope.





#########################################################################
080111 Fri 11 Jan 2008 10:26:05 AM EST

Spent most of the day testing for the rollout, and fixing bugs (had
one I introduced to the shortform; went completely the wrong way about
debugging it. There was a javascript error, should have noticed that
straight away! Bad Steve!)

Bleh. Just wasted a lot of time trying to figure out why Emacs is now
indenting the close brace by one space. Where the hell did that come
from? I need to figure out the whole indentation system now. Shelve
that until later. The answer is probably in c-indent-alist and that
trick (which I can dig out of PhpWiki) where the file specifies the
indentation.




#########################################################################
080115 Tue 15 Jan 2008 10:44:07 AM EST

Solved some issues yesterday with MPP, namely getting the specialties
to display on the account index page. Also had a few other
commits. Had a tiff with Chris when he started asking dumb questions
about a file in the gifts dir; thought he was just code spelunking and
annoying me but he was actually working on something. I also note here
my typing has improved a lot, and I don't know why.

How to encrypt passwords:

#!/usr/bin/perl -w

use Digest::SHA1  qw(sha1 sha1_hex sha1_base64);

print "Hello, sailor boy!\n";

$salt = create_new_salt("1");
$digest = encrypt_password("112233", $salt);
print "digest: $digest\n";


sub create_new_salt {
    my $id = shift;
    die unless $id;
    return $id . rand();
}


sub encrypt_password {
    my $password = shift;
    my $salt = shift;

    $string_to_hash = $password . "blippy" . $salt;
    return sha1_hex($string_to_hash);
}





#########################################################################
080116 Wed 16 Jan 2008 10:55:26 AM EST

Did some reworking of the photographer data yesterday. Now have the
name for the company name in most places; filtered out ones with no
state. Seems they all have zip codes if they have a state. Added
Canadian provinces too.

Finally am constraining the search results to the specialty the user
selected. Rather than do a big join -- which is probably possible -- I
resorted to looping on the results of all addresses matching the
user's choice(s). It doesn't take much code... the bonus is I have all
the photogs who don't list that specialty, but I can push them to the
end of the array just in case. Actually now that I think of it, I can
use unshift and push to build up the array rather than building
two... and use array.length to constrain the... no, wait. That won't
work. I might wind up with ten withou that specialty when there are
ten that do have it. So it will be the slower way. No biggie.



#########################################################################
080117 Thu 17 Jan 2008 01:57:15 PM EST

Came up with a simple solution to the shell buffer problem. On the
Mandriva Linux systems, when I started up Emacs, all the shell buffers
I'd want were created for me; and the contents of previous
incarnations were inserted at the top (point-min).

On the Ubuntu systems, however, the previous contents are inserted
somehow in a way that makes the whole file a series of arguments to
the shell. This had disasterous consequences.

I disabled this feature, but was unhappy without my permanent buffer
contents. Today it dawned on me to just write a (y-or-n-p) prompt to
create the delay needed. Worked like a charm. No sweat now to invoke
sw-mpp to open four shells, and type "y RET" to restore the buffer
contents.

;; the big enchilada
(defun sw-mpp ()
  "Are we live or on tape?"
  (interactive)

  (setq sw-restore-shell-buffers-flag nil)

  (sw-shell "console")
  (goto-char (point-max))
  (insert "cd /home/swain/public_html/projects/myphotopro")
  (comint-send-input)

  (sw-shell "mongrel")
  (goto-char (point-max))
  (insert "cd /home/swain/public_html/projects/myphotopro")
  (comint-send-input)


  (sw-shell "cli")
  (goto-char (point-max))
  (insert "cd /home/swain/public_html/projects/myphotopro")
  (comint-send-input)

  (sw-shell "sql")
  (goto-char (point-max))
  (insert "cd /home/swain/public_html/projects/myphotopro")
  (comint-send-input)

  (setq sw-restore-shell-buffers-flag t)

  ;; We probably want to disable automatically saving the shell
  ;; buffers until this is decided by the user; I might walk away and
  ;; in the next few minutes all the shell buffer files would be
  ;; overwritten. Also, if I choose 'n' the old ones should be backed
  ;; up. Even better idea: if auto-save-desktop runs and I haven't
  ;; made the choice, automatically back them up.

  (if (y-or-n-p "Restore the shell buffers? ")
      (progn
        (sw-insert-saved-buffer-contents "cli")
        (sw-insert-saved-buffer-contents "mongrel")
        (sw-insert-saved-buffer-contents "console")
        (sw-insert-saved-buffer-contents "sql")
        )
    ;; else
    (progn
      (sw-backup-saved-buffer-contents "cli")
      (sw-backup-saved-buffer-contents "mongrel")
      (sw-backup-saved-buffer-contents "console")
      (sw-backup-saved-buffer-contents "sql")
      )
    )

  (sw-init-shell "mongrel" "script/server")
  (sw-init-shell "console" "script/console")
  (sw-init-shell "sql" "mysql -uroot myphotopro_development")
)


Just seen in an strace by Chris:

open("/usr/lib/perl/5.8/DynaLoader.pm", O_RDONLY|O_LARGEFILE) = 4
ioctl(4, SNDCTL_TMR_TIMEBASE or TCGETS, 0xbfa05208) = -1 ENOTTY (Inappropriate ioctl for device)
_llseek(4, 0, [0], SEEK_CUR) = 0
read(4, "# Generated from DynaLoader.pm.PL\n\npackage DynaLoader;\n\n# And Gandalf said: \'Many folk like to know beforehand what is to\n# be set on the table; but those who have laboured to prepare the\n# feast like to keep their secret; for wonder makes the words "..., 4096) = 4096





#########################################################################
080118 Fri 18 Jan 2008 11:55:41 AM EST

Building on my recent work of saving shell buffer contents... why not
set up a git, cvs or svn repository a subdir which holds all shell
buffers; then a cron job to automatically commit all the files every
night?

It's kind of extreme but I'd never lose anything.


You say, "typolesbo is trying to format a date in a page, using php's strftime()"
You say, "asks me, "why can't i do (something) before i've made my time?""
You say, "i said "because you have no chance to survive""
You say, "it was all downhill from there"




#########################################################################
080123 Wed 23 Jan 2008 11:47:20 AM EST

I wrote this block in UserDB.php today.

    /**
     * If $username == 'admin' we'll have to instatiate an AdminUser;
     * else it will be a SubUser. This has to be, because Gallery
     * expects to be able to do the "same things" to a User class
     * regardless of who they are... but subusers and users are in
     * separate tables.
     *
     * bleh, scratch all that. The problem is the data
     * model. Gallery's data model does not map to the mpa_users
     * table. If we don't put an entry for the admin in the subusers
     * table, we have to store the extra data somewhere else anyway!
     * In another table? That's stupid. The subusers table already has
     * the right schema and it's 10x simpler to do it that way.
     *
     * So that begs the question: should this table still be called
     * mpa_subusers? Probably.
     */

Boy, is Ferry gonna have kittens when he finds out.



#########################################################################
080124 Thu 24 Jan 2008 10:03:41 AM EST

To review so far:

1. Got rid of the borked constructor for UserDB; we use a Factory
method now that simply returns the unserialized file.

2. Decided to put the site admin into the mpa_subusers table, as
that's more uniform.

Met with Chris over the mpa_subusers table. Not surprisingly he wants
the uid <=> siteid association moved to a separate table so a subuser
can belong to more than one site. He did say that table would have to
list the perms the user has as well.

My thinking here is that the mpa_subusers table could eventually
become the main users table. A new thought!

Thinking a few jumps ahead... I could also replace the username
'admin' with the site name username. That would assist in the Ferry
scheme of things, though I still feel like it's a waste of time.



#########################################################################
080125 Fri 25 Jan 2008 12:40:21 PM EST

Hanley wants me to do Trialpay stuff for her, can't find the login/pw
anymore. Thought I had it posted up writtin in Centerline. Tried to
organize a last minute lunch outing today, but it failed. Chris is
going upstate for his father's birthday, has to eat at his desk.

Am running 10 Perl jobs at a time, each doing 30 users at a time,
regenerating the RSS feeds. They all fell behind
again... well... actually most of them have been behind because Chris
forgot he shut it off last January. When we restarted it we never
updated them for the year. Meanwhile, I introduced a bug a few weeks
ago. I didn't know /opt/mpa/veracity was the path being used, and the
copy there of regenerate-feeds.php was broken (it wasn't loading of
the new library files. I broke verify-lib.php into three files).

Emailed ops twice about this.



#########################################################################
080129 Tue 29 Jan 2008 09:57:44 AM EST

Basic thrashing about yesterday. I got rid of extra calls to build the
userMap array in Gallery_UserDB.php. This is a huge win, really, but
there's noone to share it with.

Peter is looking for a way to track the spending of a user from signup
to deletion... the idea is, what revenue does a customer bring in over
their lifetime? Probably the best thing to do is generate a
spreadsheet of some sort so he can crunch numbers.

I spent time, end of yesterday through now (2pm) optimizing the file
makefeeds.php. This script generates the rss.xml file. It was looping
through every album, loading all the photos. I suppose this would be
useful if we had rss feeds per album, which we don't. So a good start
was shutting that off. It stopped running out of memory at that point.

Next I built a loop that creates an array of the ten most recently
updated albums that can be viewed by anyone.

Got about half way through password recovery for myphotopro. It just
has to send the email with the link, and clicking the link has to do
something. These are no big deal really; all things I've done before.


Wainstead \ gives up on AIM argument with head of ops, who's telling him "refactoring" is just 
"putting icing on bad code"
scott [to Wainstead \]: well, frequently it is
marburg warbles Le Tigre, "I'm outta time....outta fuckin time... I'm a gasoline gut with a 
vasoline mind..."
scott [to Wainstead \]: it can be a good thing, but it's no magic bullet for turning crap into art
heller says, "then I would argue it shouldn't be called "refactoring". refactoring is supposed to 
be a real improvement. "
Wainstead \ [to scott]: have you read martin fowler's book?
scott [to Wainstead \]: I have not
marburg [to Wainstead \]: it's not scott's fault he's illiterate!  stop picking on him.
heller [to Wainstead \]: tell him to just read the first line of the wikipedia article. 
scott [to heller]: ok, if you define it to be an improvement then sure
Wainstead \ [to marburg]: that wasn't what i was implying :o)
scott [to heller]: but then I submit that much of what people call refactoring isn't.
heller [to scott]: sure. like it's defined that in a base 10 numbering system 2+2 = 4. 
heller [to scott]: then I would correct them for misusing the term. . .
Wainstead \ [to scott]: i would wholeheartedly agree with that statement. most programmers don't 
understand what refactoring means.
heller says, "exactly. "
heller says, "but, it sounds like chris is saying that the definition of refactoring isn't to 
improve it. . ."
[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
chrisatfcity: Well if the code wasn't written right to begin with and adding simple functionality 
takes you weeks thena rewrite is in order
chrisatfcity: guy makes perfect sense
Steve Wainstead: if the code wasn't written right you refactor it
chrisatfcity: refactor is like reicing a cake.
Steve Wainstead: you refactor it until the new code is easy to add
Steve Wainstead: that's the rule
Steve Wainstead: that's the common wisdom now
chrisatfcity: if the cake itself sucks reicing ain't gonna do it
chrisatfcity: I like my metaphor
Steve Wainstead: no, refactoring, by definition, means: changing theinternals of the code so it's 
easier to test/modify/add new stuff
Steve Wainstead: if your "refactoring" is "icing" you're doing it completely wrong
12:00 PM
chrisatfcity: well if you keep the old code and clean it up.. you are just re icing it
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
You say, "and on and on"
You say, "i've learned to just give up when he refuses to understand something"
You say, "the motivation for this converstation being this poorly written piece: 
http://highscalability.com/moving-old-new-do-not-be-afraid-re-write-take-some-help => 
http://avln.us/6o2"
URL Added: ID# 0 -- 
http://highscalability.com/moving-old-new-do-not-be-afraid-re-write-take-some-help
chilly_willy [to Wainstead \]: i just wish i had the time to refactor my code
chilly_willy [to Wainstead \]: everyone just wans more features, screw making the code easier to 
work with
heller [to Wainstead \]: even if you use his analogy of re-icing you have to apply "to make it 
better" so if the cake underneath sucks, then part of refactoring isn't just re-icing, it's 
putting a better cake underneath first. 
scott [to Wainstead \]: well, under the wikiepdia definiton of refactoring, leaving the external 
interface the same and totally rewriting all of the actual code still counts as refactoring.
heller says, "yea. and I htink that's a generally acccepted definition. so, chris is high. "



#########################################################################
080130 Wed 30 Jan 2008 10:06:14 AM EST

Peter's gonna pitch elimos.com to Alex over at Unhappy Corp. I
guestimated 4 weeks to roll out a site using Rails. I think two weeks
is more than enough to build 90% of the functionality: it's not reuse
so much as my understanding of Rails has improved that much. I should
probably set up an app on Slim just for kicks, something that can
stand medium traffic levels without falling over.

Peter and Jessy are in Las Vegas the rest of the week for a photo
conference. Also, I've given up giving up caffeine. I blame Dunkin'
Donuts for giving me real coffee on Sunday; had headaches the last two
days. And where I thought I was past that after last week.

Back on MPP, fleshing out password recovery.

Password recovery all done, I think. Also rolled out
Gallery/Veracity/subuser port to staging, tested, looks good. I need
to be able to rerun veracity after the release to "catch up" any new
signups missed during the 4 hour run (or so). I should time that
again.

Simple strategy: run Veracity to port everything. Rerun Veracity to
cover all new users since the beginning of the previous run. Roll
out. Rerun again since start of previous run. Rerun for entire
userbase, to catch any possible subusers that were missed.




#########################################################################
080131 Thu 31 Jan 2008 09:37:47 AM EST

The run of Veracity yesterday, which ported all user data to the
database, took almost exactly 3 hours. (2 hours 58 minutes).

I had a total brainfart: I forgot to update the signup wizard!
Duh. That's my top priority today.

Well, that started with finding all the files on production that are
either modified or not under version control. Sent two emails. Really,
it's all me, Chris and Fernando.

OK, signup wizard appears to be done. Whew.



#########################################################################
080204 Mon 04 Feb 2008 04:39:43 PM EST

I've sunk quite a bit of time into testing the store, now that the
codebase is in SVN. Got my build and development set up properly.




#########################################################################
080205 Tue 05 Feb 2008 02:14:16 PM EST

Very challenging: figuring out why my "autotest" site was failing on
logins. Turns out the tarball for the fast storage was overwriting the
file 'user.local.php'. Emacs will edit tar.gz files (or .tgz in this
case) so I was able to delete the files from the archive.

So... got the full test done. Dunno why I had separate "remove" and
"make" scripts; combined them into one, recycle_autotest.sh:

# completely delete the user 'autotest' and then recreate

echo "Deleting autouser from database..."
EXECUTESQL='/d0/mysql/mpa/bin/mysql -S /tmp/mysql.mpa.sock -uroot mpa -e'
$EXECUTESQL 'call delete_autouser()'

echo "rm -rf autouser off fast and slow storage..."
rm -rf /mnt/slow/vol01/a/au/aut/auto/autot/autotest
rm -rf /mnt/fast/vol01/a/au/aut/auto/autot/autotest

echo "using createaccount.pl to recreate site..."
/opt/mpa/admin/unix-bin/createaccount.pl autotest 112233 autotest@test.myphotodevel.com

echo "Using lhhreplay.pl to recreate albums..."
cd /home/swain/svn/pgms/perl
./lhhreplay.pl ./autotest/autotest_createalbums.lhh

echo "Untarring the albums for autotest..."
cd /mnt/slow/vol01/a/au/aut/auto/autot
tar xzvf /home/www/autotest.slow.tgz
cd /mnt/fast/vol01/a/au/aut/auto/autot
tar xzvf /home/www/autotest.fast.tgz

echo "Creating and deleting subusers for autotest..."
cd /home/swain/svn/pgms/perl
./lhhreplay.pl ./autotest/autotest_makes_users.lhh


echo "Done."



There's a brittleness here though: the first LHH script creates all
necessary albums and subalbums. The tarballs contain all the images. I
should come up with a simple way to create new tarballs should the lhh
script become obsolete; also, the next step after that would be to
extract the username so one can create a site regardless of
username. That's totally doable.

It would take a Perl script using the Gallery API to upload the
images, I think, to automate that part of it.

In the end it should be "one click," so to speak, to create a new site
on the fly and test the functionality. I'm reminded of setting up
similar tests with Oliver at the NYT, and how such tests are
lifesavers.

Oh, and it should then do a comprehensive test of all store
functionality. And this test should work on staging too.




#########################################################################
080207 Thu 07 Feb 2008 10:59:07 AM EST

Reviewed Fernando yesterday. Longish manager's meeting too.

Wrote up two tasks for Fernando: store-is-alive fix, and
don't-delete-gifts-in-the-cart fix.

Followups from yesterday:

* digibug.com runs on PHP 4.3.3 on Apache.
* Gallery Remote does not have photo organizing features.

Spent considerable time exploring Adobe AIR. This is the "rich
internet application" "runtime" they are releasing; currently in beta
3 as of... December or so. So it's advanced since I last
looked. Showed Jessy a demo app called Bee that is supposed to
integrate WordPress to Flickr... I'm thinking that we can do the photo
organizing tool Jessy was talking about. More to the point, now that I
think about it, it could do the "mirroring" thing where the
organization on your HD and Gallery are the same. I suppose that makes
the most sense. This would mean we could adopt a "build/compose/edit"
kind of RIA that then "syncs" with the online Gallery (comments and
all!) Not only would that be cool, I dunno of anyone else doing it
(though I haven't really looked).

Sending a share email:

DBConn: DBConn::_queryDB: got this query: 'SELECT s.uid AS uid, s.username AS username
                  FROM mpa_subusers s, mpa_sites_subusers ss
                  WHERE ss.site_id = 142687
                  AND s.uid = ss.uid'
DBConn: DBConn::_queryDB: ok i am done (succesfully).
DBConn: DBConn::_queryDB: got this query: 'SELECT s.*, ss.*
                  FROM mpa_subusers s, mpa_sites_subusers ss, users u
                  WHERE u.userid=ss.site_id
                  AND s.uid = ss.uid
                  AND u.userid='142687'
                  AND s.uid='1100548322_1920879344''
DBConn: DBConn::_queryDB: ok i am done (succesfully).
DBConn: DBConn::_queryDB: got this query: 'SELECT num_emails FROM mpa_users_email_history where email_address='swaindevel@test.myphotodevel.com' and date_sent like '2008-02-07%''
DBConn: DBConn::_queryDB: ok i am done (succesfully).
DBConn: DBConn::_queryDB: got this query: 'SELECT * FROM mpa_users_address_book WHERE email_address = 'swaindevel@test.myphotodevel.com' and friends_email = 'swain@corp.fortunecity.com''
DBConn: DBConn::_queryDB: ok i am done (succesfully).
DBConn: DBConn::_queryDB: got this query: 'INSERT INTO mpa_users_email_history (email_history_id, parent_userid, album, type, photo_name, album_title, description, email_address, date_sent, num_emails) VALUES (NULL, 142687, 'album31', 'Slideshow', '', 'it's a man's life in the army', 'big pay, lots of fun', 'swaindevel@test.myphotodevel.com', NOW(), 1)'
DBConn: DBConn::_queryDB: ok i am done (succesfully).
DBConn: DBConn::_queryDB: got this query: 'SELECT num_emails FROM mpa_users_email_history where email_address='swaindevel@test.myphotodevel.com' and date_sent like '2008-02-07%''
DBConn: DBConn::_queryDB: ok i am done (succesfully).
DBConn: DBConn::_queryDB: got this query: 'SELECT userid FROM users WHERE email_address = 'swain@corp.fortunecity.com''
DBConn: DBConn::_queryDB: ok i am done (succesfully).
DBConn: DBConn::_queryDB: got this query: 'INSERT INTO mpa_users_received_shares (id, received_userid, email_history_id, time_added) VALUES (NULL, 142697, , NOW())'
DBConn: DBConn::_queryDB: ok i am done (succesfully).
DBConn: DBConn::_queryDB: got this query: 'select sum(amt) from mpa_points where username = 'swain''
DBConn: DBConn::_queryDB: ok i am done (succesfully).
DBConn: DBConn::_queryDB: got this query: 'SELECT state from mpa_profile where userid=142687'
DBConn: DBConn::_queryDB: ok i am done (succesfully).
DBConn: DBConn::_queryDB: got this query: 'SELECT datediff(birthdate, NOW()), country, firstname FROM userinfo WHERE userid=142687'
DBConn: DBConn::_queryDB: ok i am done (succesfully).
DBConn: swain.myphotodevel.com: connexion closed.



#########################################################################
080208 Fri 08 Feb 2008 05:52:15 PM EST

typolesbo: ok again
typolesbo: i didnt have it shoeing hte new files ;-)
typolesbo: i am def not saying it's "DONE"
typolesbo: i still need to add votoing
typolesbo: and click tracking
typolesbo: but the differnt displays
typolesbo: etc should work on that page
typolesbo: its more...
typolesbo: look at how i coded it
typolesbo: and tell me what you think
typolesbo: and what I should change





#########################################################################
080211 Mon 11 Feb 2008 10:45:10 AM EST

The above typolesbo paste was just to remind me what she wanted me to
do; which was to review her new album pages. So far they render badly
and the functionality is not there.



#########################################################################
080213 Wed 13 Feb 2008 10:32:22 AM EST

Now waiting on Chris to come back from a data center tour to roll out
Gallery. This rollout is almost two weeks late and the main problem, I
think, is Chris.

Epliogue: fucking A, this rollout process has to go.



#########################################################################
080214 Thu 14 Feb 2008 10:21:23 AM EST

Chris says signups are running at 65% success instead of the normal
85%. Also just got into a tiff with him over aim about an image not
loading. For days now I've been seeing a lot of "connection resets"
and things not loading.


Steve Wainstead: i'm continuing to see elements not loading
Steve Wainstead: acutally photos not loading
Steve Wainstead: and if i refresh the page they load
chrisatfcity: and??
10:15 AM
chrisatfcity: I need examples.
chrisatfcity: URLs etc.
chrisatfcity: Just saying somehting does not load doesn't help.
Steve Wainstead: i cannot provide anything
chrisatfcity: ofcourse you can
chrisatfcity: What image did not load
Steve Wainstead: if i give you the url to a photo that didn't load, and then did, what good woudl that do you?
chrisatfcity: go into the source
Steve Wainstead: i already deleted the album
chrisatfcity: and grab the URL
Steve Wainstead: and you'll tell me : it loaded for me
chrisatfcity: it would help isolate the issue
chrisatfcity: oh fer fuckssake
Steve Wainstead: :)
chrisatfcity: just give me the URL and stop whioning.
Steve Wainstead: well you always do say that :)
chrisatfcity: That's retarded.
Steve Wainstead: i said already, i deleted the ablum
chrisatfcity: It could load for anyone.
chrisatfcity: don't be an ass
Steve Wainstead: i was testing a site
chrisatfcity: it's too early to get on my nerves
Steve Wainstead: no, reallly. i deleted it.
chrisatfcity: well then don't complain to me about it again..
Steve Wainstead: so, i shouldn't say anything when things don't load
Steve Wainstead: ?
chrisatfcity: if you delete the information we need to troubleshoot what the hell am I supposed to do about it?
Steve Wainstead: well, tell you what. i won't say anything anymore.
chrisatfcity: It's like complaining about an ingrown toe nail when you have no legsd




#########################################################################
080219 Tue 19 Feb 2008 11:08:57 AM EST

Hrmm. Gifts project on Torque was missing. Possibly not there from the
very beginning. Chris thought I was some kind of Spanish Inquisition
for asking.

Have fleshed out an uploader script to test uploading. Committed to
svn as "uploader.pl."




#########################################################################
080220 Wed 20 Feb 2008 11:37:50 AM EST

New stored procedures:

-- the point here is to delete the customer who bought an
-- autorenewable club membership; this account was created while
-- running "utlimate_test.lhh" via my perl script "lhhreplay.pl". --sw

-- this chunk was taken out of my work log; something I solved long
-- ago... it forms the basis of this stored procedure:

-- select @id := customers_id from osc_customers where customers_email_address='mister@test.myphotodevel.com';
-- delete from osc_orders_products where orders_id in (select orders_id from osc_orders where customers_id = @id);
-- delete from osc_orders_products_attributes where orders_id in (select orders_id from osc_orders where customers_id = @id);
-- delete from osc_orders_total where orders_id in (select orders_id from osc_orders where customers_id = @id);
-- delete from osc_orders_status_history where orders_id in (select orders_id from osc_orders where customers_id = @id);
-- delete from osc_orders where customers_id = @id;
-- delete from osc_session_info where customers_id=@id;
-- delete from osc_address_book where customers_id = @id;
-- delete from osc_customers_basket where customers_id=@id;
-- delete from osc_customers where customers_id=@id;



DELIMITER $$



DROP PROCEDURE IF EXISTS delete_autorenew_customer $$



CREATE PROCEDURE delete_autorenew_customer(cust_email_address VARCHAR(64))
BEGIN

DECLARE ultimatetest_cust_id INT;

SELECT customers_id INTO ultimatetest_cust_id FROM osc_customers WHERE customers_email_address = cust_email_address;

IF (ultimatetest_cust_id IS NOT NULL) THEN
   DELETE FROM osc_orders_products            WHERE orders_id IN (SELECT orders_id FROM osc_orders WHERE customers_id = ultimatetest_cust_id);
   DELETE FROM osc_orders_products_attributes WHERE orders_id IN (SELECT orders_id FROM osc_orders WHERE customers_id = ultimatetest_cust_id);
   DELETE FROM osc_orders_total               WHERE orders_id IN (SELECT orders_id FROM osc_orders WHERE customers_id = ultimatetest_cust_id);
   DELETE FROM osc_orders_status_history      WHERE orders_id IN (SELECT orders_id FROM osc_orders WHERE customers_id = ultimatetest_cust_id);
   DELETE FROM osc_orders                     WHERE customers_id = ultimatetest_cust_id;
   DELETE FROM osc_address_book               WHERE customers_id = ultimatetest_cust_id;
   DELETE FROM osc_cart                       WHERE customers_id = ultimatetest_cust_id;
   DELETE FROM osc_customers                  WHERE customers_id = ultimatetest_cust_id;
ELSE
   SELECT concat('Nothing to delete for ', cust_email_address) AS message;
END IF;

END $$




-- remove the club membership for risefm.myphotodevel.com
DROP PROCEDURE IF EXISTS declubify_risefm $$

CREATE PROCEDURE declubify_risefm()
BEGIN

DECLARE risefm_id INT;

SELECT userid INTO risefm_id FROM users WHERE username='risefm';
DELETE FROM mpa_club_memberships WHERE mpa_userid = risefm_id;
UPDATE users SET status = 1, package_type = 0 WHERE userid = risefm_id;

END $$




DROP PROCEDURE IF EXISTS swain_undo $$

CREATE PROCEDURE swain_undo()
BEGIN
call declubify_risefm();
call delete_autorenew_customer('deleteme@test.myphotodevel.com');
call delete_autorenew_customer('deleteme2@test.myphotodevel.com');
END $$

DELIMITER ;



#########################################################################
080221 Thu 21 Feb 2008 02:41:47 PM EST

Note for today: Chris has again reinstated Bugzilla as the means for
tracking requests for Ops. I filed one for viewvc, and how websvn runs
out of memory.

For safekeeping:


(defun sw-highlight-stuff ()
  "Yow!  Legally-imposed CULTURE-reduction is CABBAGE-BRAINED!"
  (interactive)
  (hi-lock-face-buffer "DEGRADED_MODE" "hi-red-b")
  (hi-lock-face-buffer "FFMPEG" "hi-red-b")
  (hi-lock-face-buffer "FLVTOOL2" "hi-red-b")
  (hi-lock-face-buffer "IMAGE_SERVER" "hi-red-b")
  (hi-lock-face-buffer "PARTIAL_DISABLED_LOGINS" "hi-red-b")
  (hi-lock-face-buffer "MASS_STORAGE_DIR" "hi-red-b")
  (hi-lock-face-buffer "MENCODER" "hi-red-b")
  (hi-lock-face-buffer "MPA_MYSQL_DB" "hi-red-b")
  (hi-lock-face-buffer "MPA_MYSQL_HOST" "hi-red-b")
  (hi-lock-face-buffer "MPA_MYSQL_PASSWORD" "hi-red-b")
  (hi-lock-face-buffer "MPA_MYSQL_USERNAME" "hi-red-b")
  (hi-lock-face-buffer "PARTIAL_DEGRADED_MODE" "hi-red-b")
  (hi-lock-face-buffer "RAW_IMAGE_SERVER" "hi-red-b")
  (hi-lock-face-buffer "MPA_SERVICE_NAME" "hi-red-b")
  (hi-lock-face-buffer "SESSION_TYPE" "hi-red-b")
  (hi-lock-face-buffer "MPA_STATIC_SERVER" "hi-red-b")
  (hi-lock-face-buffer "USER_DATA_ROOT" "hi-red-b")
  (hi-lock-face-buffer "SERVICE_OUTAGE" "hi-red-b"))




#########################################################################
080222 Fri 22 Feb 2008 11:07:37 AM EST

Running it like this:

find . -type f \( -name "*.php" -o -name "*.inc" -o -name "*.default" \) -print  | ~/svn/pgms/perl/redefine.pl > output.php

Of moderate interest is how I'm now attempting to parse out the minor
differences to accomodate them... on the one hand I'm starting to see
it as a lexed input stream, though... I haven't quite "seen" it yet. I
can feel something's there but can't quite find it. And I also feel
the need for Emacs's recursive editing, once I find out how to do
search-and-replace across files. I believe such a thing is possible.


I found that I can craft the output and use grep-find to list all the
changes:

find . -type f \( -name "*.php" -o -name "*.inc" -o -name "*.default" \) -print  | ~/svn/pgms/perl/redefine.pl 

is the command, and the print statement looks like this:

print "$filename.new:$. $line";

I then used the elisp function listed above to highlight all the
constants.

OK, I think I've worked out the problem to the point where I have to
stop. I don't want to make all the changes and commit them to CVS; I'm
waiting on Chris to move Gallery to SVN. He's resisting though; he
wants to come up with the "right" project layout before importing
it. This is our age old battle of "worse is better" or "don't let the
best be the enemy of the good" or "a good plan, violently executed
today is better than a perfect plan next week."


Demo'd the Perl script to Fernando... Mike got viewvc up and
running. It's way cool. I sync'd all the conf files for gallery on
torque, staging and production (the production one is not live yet).

Sending us home early due to bad weather.



#########################################################################
080225 Mon 25 Feb 2008 12:13:26 PM EST

Reasons for dumping the Aurigma tool and developing a replacement in
Flex:

1. Aurigma tool has security holes.
2. Chris does not want to edit/compile another copy.
3. We are dependent on Chris for the Aurigma tool.
4. We have never liked the UI for the Aurigma tool.
5. We can build a better uploader that runs on all platforms.
6. This is a gateway to a Rich Internet Application that sorts photos
   on the user's computer, or other new functionality.




#########################################################################
080227 Wed 27 Feb 2008 02:00:19 PM EST

Was working with Fernando on alist and hash types in elisp last night:

(setq blippylist '(("foo" . 31337) ("baz" . 69) ("blee" . 42)))
(cdr (assoc "foo" blippylist))

This is a simple way to do Perl style hashes.




#########################################################################
080228 Thu 28 Feb 2008 10:13:07 AM EST

Am trying to work out a new way to insert the buffer contents from the
previous session. There's all kinds of troube



#########################################################################
080228 Thu 28 Feb 2008 10:21:41 AM EST

Tried to solve the problem of shell buffer contents being inserted too
late (too early?). This results in all the shell buffer contents being
executed as commands by bash, which has catastrophic results.

I want a buffer local variable that is a flag indicating whether the
contents have been restored. But I run into some crazy problem where
it loops infinitely, the flag being void. Harrumph.

Meanwhile, I've been teaching Gallery how to let people login via
email address. I have the basic cases handled:

1. email of site admin
2. email of subuser
3. email of another subdomain

There's one sticking point: if they are a subuser of that site and
want to login to their own site, they will be blocked. The way around
this, I suppose, is to make Gallery a monolithic application and lose
all our distinctiveness.




#########################################################################
080304 Tue 04 Mar 2008 11:05:39 AM EST

Summary of my refactoring of the Album class:

2008-02-29 17:00  swain

	* classes/Album.php: minor changes

2008-02-29 16:59  swain

	* util.php: took out debugging output

2008-02-29 16:55  swain

	* classes/Album.php: pushed off the code to make the intermediate
	sized photo to a new method; also added $me variables to the new
	methods, which gives us finer grained debugging.

2008-02-29 15:38  swain

	* classes/Album.php: Pulled more blocks of code out, into their own
	methods.

2008-02-29 14:34  swain

	* copy_photo.php, gallery_remote.php, gallery_remote2.php,
	move_photo.php: Updated the calls to Album::addPhoto to use the new
	class

2008-02-29 12:25  swain

	* classes/: NewAlbumItem.php, NewMovie.class.php: Don't serialize
	it; var export it.

2008-02-29 12:24  swain

	* classes/NewAlbumItem.php: added a __toString() method.

2008-02-29 12:23  swain

	* util.php: Now passing a NewAlbumItem class into
	Album::addPhoto(). But still, processNewImage() should probably go
	away.

2008-02-29 12:21  swain

	* classes/Album.php: Huge changes:
	
	I introduced two new classes, NewAlbumItem and NewMovie. These
	collect variables together, which helps the code organization
	somewhat.
	
	This also makes passing data around more efficient, since objects
	are passed by reference. It cuts down on the noise/clutter
	somewhat, but adds some in the form of:
	
	$originalFilename becomes $nm->originalFilename
	
	But a little namespacing probably helps.
	
	Next, I took a huge section of addPhoto() and moved it into
	processNewMovie(), a new method.
	
	addPhoto() is still four pages long, probably three pages too
	many... and processNewMovie is two pages long, so further breakdown
	will help.
	
	I got rid of several temporary variables that were just getting
	their values from defined constants anyways.

2008-02-29 12:01  swain

	* init.php: added NewMovie to the load list

2008-02-29 12:01  swain

	* classes/NewMovie.class.php: Created new data holder class so
	we're not passing tramp data all around the place.

2008-02-29 11:53  swain

	* add_movie.php: don't use the premium object to tell us the site
	ID

2008-02-28 18:29  swain

	* init.php: Added new class.

2008-02-28 18:29  swain

	* classes/NewAlbumItem.php: Oops. Bad rectangle editing.

2008-02-28 18:14  swain

	* classes/NewAlbumItem.php: Container class for a new
	AlbumItem-to-be.

2008-02-28 17:06  swain

	* albums.php: dropped the check on the album version; also quite a
	bit of other junk.
	
	*** albums.php	14 Jan 2008 15:02:30 -0500	1.181 ---
	albums.php    28 Feb 2008 17:01:07 -0500 *************** ***
	501,520 ****
	
		 <br>
	
	-    <?php if (ereg("album[[:digit:]]+$", $albumURL)) { ?> -   
	<?php if (!$gallery->session->offline) { ?> -		<?php } ?>
	-    <?php } ?> -    <?php if ($gallery->album->versionOutOfDate())
	{ ?> -	   <?php if ($gallery->user->isAdmin()) { ?> -	 </span> - 
	 <span class="error"> -    <?php echo _("Note:	This album is out
	of date!") ?><?php echo popup_link("&nbsp;" . _("upgrade album")
	."&nbsp;", "upgrade_album.php") ?> -   </span> -     <?php } ?> -  
	 <?php } ?> - -   </span>
	
	     <?php } ?>
	
	--- 501,506 ----

2008-02-28 17:05  swain

	* init.php, util.php, search.php: dropped the check on the album
	version


--------------------------

I realized why Gallery programmers did that crazy memberwise copying
of the class in the dat file: if the class structure changed, perhaps
instantiation fails. I'll have to test this but it explains a lot.

I was reading about object databases this weekend: an interesting
thing is they are good for high performance.

Spent some time spelunking in the error logs. Found that a db patch
was missing (275.sql). My fault. Chris applied it, I wrote a Perl
script to extract all the failed INSERT queries and ran them against
mdb-2. Filed a bug in Bugzilla for the continued "mysql session" error
dumps, which should be solvable by reconnecting to the db.

So it's kinda silly that I wrote the "login via email" as I did: fetch
the username for that email. What was I thinking? Hrrmm. For email
shares, there is no username. I could go with the original idea of
parsing out the "local name" from the email address (i.e. the 'swain'
in 'swain@panix.com'). Suitable, I suppose.

Once created the username cannot be changed though.



#########################################################################
080307 Fri 07 Mar 2008 10:39:17 AM EST

Dylan was coughing all day yesterday, and I started a dry
throat... this morning I'm burning up. Unless it's just hot in
here. Either way... I'm going home momentarily.

Yesterday was a day of tasks gettting "pushed on the stack." I need to
consolidate the user deletion stuff somehow; was looking at a stored
procedure. But Fernando found a bug: admins were being added to sites
on production. One had 18. Fernando had 1000+. He found delayed video
processing was causing it, removed a $tmpUser->save() and that solved
it. Freaky.

Then later in the day Jessy dragged me into a bug with pagination,
which led to a fight that had been waiting to happen a long time: she
started recoding the Gallery pages before I was ready. She accused
"the dev team" of being too slow. I told her nowhere was refactoring
the API ever on the task list, which she strangely contested. Chris
even walked away from the argument.

She texted me an apology last night; told me today Melissa was making
fun of her and telling her to let it go. I kept thinking how the
native Americans would start forest fires to clear the underbrush and
the forests were park-like back in the colonial days. Of course I'm on
Nyquil and running a fever so this probably gets less coherent as I
go.

I hacked the new numUserCanView method to test if
$user->canWriteToAlbum because canReadAlbum always returned true. Or
so it seemed. It requires stepping through the app and I don't have
the concentration to do it. So adios.




#########################################################################
080310 Mon 10 Mar 2008 10:15:35 AM EDT

Went home sick Friday. Terrible weekend. Fever and all that. Watched
"Little Children," wherein Kate Winslet couldn't stop disrobing, and
"300."

The store couldn't connect to the database 11 times last night,
between 1045PM and 343AM. Reported this to Chris; it's in the osc log
for March 10th.

Jessy claims to have fixed the numUserCanView method by loading the
album.

Tried for a while today to figure out error handling in stored
procedures, but it was so ugly I gave up for the time being... and
went with a meat and potatoes approach. 



#########################################################################
080311 Tue 11 Mar 2008 05:34:48 PM EDT

Yesterday we had a six hour outage. The store log was filled with
"unable to connect to db" errors again. Forwarded it to ops.

Chris out today. Our bandwidth sucked all day; probably in part due to
some DNS problem.

Maybe because I'm sick, or I took phy*** something for my congestion,
but today was the slowest day on earth. Still is.

Anyhow... I spent time finishing up the "archive the user" stuff
which I think is 90% there; I have a feeling I forgot
something. Meanwhile, I found I had a bug in provisioning-lib.pl
because I removed two subs and one of them actually was creating
globals needed elsewhere... bit by my own bad programming! So I should
clean that up tomorrow.

Oh, also implemented a new bit for Chris that tracks how much space
was freed up.



#########################################################################
080312 Wed 12 Mar 2008 09:56:37 AM EDT

Was just checking on org-mode, which comes with Emacs 22.



#########################################################################
080313 Thu 13 Mar 2008 11:34:26 AM EDT

Skin counts: that is, tally of the themes our users chose over the
default, for March 12 2008.

28% changed their theme overall.
39% of club members changed their theme.


Total number of sites checked is 214,539.
153,425 have never changed their skin.

There were 12,080 club member sites.
4,717 changed their theme from the default.

---

Yesterday I filed something like 15 bugs for Jessy. Today I went over
her files and they actually looked pretty good. There may be an issue
with so many more file requests from the filesystem, so we'll see. She
does far more includes than before.

I have been pouring over the dumps of a couple dat files, thinking
about the data models. It occurred to me that I could write some
benchmarking stuff to see if jamming it all into one SQLite file makes
it run faster than if we pull everything from individual dat
files... there may be no real differerence though, as we're still
unserializing strings to unmarshal the objects. That in itself might
suggest creating mini databases instead of useing SQLite as an object
store, though again it's a question of whether constructing is faster
than unserializing (unmarshalling) or not.



#########################################################################
080314 Fri 14 Mar 2008 01:25:04 PM EDT

Went through the 15 or so bugs I filed for Jessy. Most are closed now,
thankfully, but Chris is being as difficult about things as
suspected. Had a row with him over aim because he did his usual thing:
pasting some link to me and not explaining it.

Zend Studio don't run. Fernando's complains the evaluation period
expired.




#########################################################################
080324 Mon 24 Mar 2008 12:11:07 PM EDT

Back from Japan. New primary focus: moving to Kodak for prints. Had a
long meeting with Peter and Jessy this morning.

2:15pm. Finally done reading and replying to email.




#########################################################################
080325 Tue 25 Mar 2008 09:13:04 AM EDT

So I have this order from on high that the OFS takes precedence over
all. Jessy is pushing me to review the optimization stuff done by Fcat
though. I don't have Zend Studio set up, unfortunately.

Spent time again searching for an equivalent of cvsreport. cvsreport
is a Perl script easily found via Google; SVNReport is some ancient
Java project that I don't care to even look at because all I want is a
script for cron. SVNReport is a half baked Crystal Reports or
something. So... nothing yet. Curious. I can't find a way to limit svn
log to a particular date or the last 24 hours. Bleh. Maybe the web
thingie has rss?





#########################################################################
080326 Wed 26 Mar 2008 07:08:58 AM EDT

In to work by 6:58am. I think no matter how one documents a software
project, it's the experience that counts more... for example, I was
just reflecting on how I move the store code to use native PHP
sessions. This brought to mind how sessions work in the store and the
changes that happened; all of that I *experienced* because I did
it. To convey that in words on a web page or a piece of paper somehow
omits something. The essence, or perhaps the Quality of it, in the
"Zen And The Art Of The Motorcycle" sense.

Oddly once I deleted my cookies and deleted everything in the
osc_cart% tables, the new product codes worked just fine.




#########################################################################
080327 Thu 27 Mar 2008 11:32:48 AM EDT

Yay to easy fixes. The Qualex document needs first_name twice; that
was easy enough to do with a new method.

Meanwhile... I've long had second thoughts on how we use DBInterface
to access the database. It's so convoluted. One has to call a method
to get the SQL code, which must be fed to a method to get the
results. Actually when I state it like that it doesn't sound hard at
all.

I also now recall that one of the reasons I moved the SQL into little
wrapper subroutines was just to facilitate Emacs formatting of Perl
code. But then, they were just stuck in variables previous to that.





#########################################################################
080328 Fri 28 Mar 2008 11:49:56 AM EDT

At COB I emailed a sample XML file to Christine at Kodak asking for a
visual verification. It only needs the price charged per item. I now
need to integrate gift products and cards into a same order.

I suppose I should start thinking about multiple ship-to addresses and
shipping types. It would be nice for the store to have.

And in the large, probably the ability for nonmembers to upload and
order photo products independent of their MPA account. I guess
logically they would start by uploading photos and we'd create the
site for them; they would be largely unaware of the site name. I dunno
how we'd do that though. "First, choose a unique username." From the
user's point of view they'd be creating a store account that has photo
albums in it... this requires use cases. We'd have to market it
differently.

I created two offers for Jessy: half off your second book and 20% off
photo products. I created them via sql and applied them to mdb-2. Sent
an email.

I started veracity yesterday; filed a bug on it. We save the full
sized movie file now and it's causing veracity to fail.





#########################################################################
080331 Mon 31 Mar 2008 09:42:54 AM EDT

Veracity done. Quite a few fatal errors.

Store had tons of failures overnight; unable to connect to mdb-2
again. Emailed Ops.

Had a thought while chatting with Fernando this morning; he just came
back from vacation (Las Vegas, then a wedding). When people pay via
e-checks, they are status 4 in the store. If they take too long to pay
for the order the gifts directory gets flushed and we lose their
image.

So e-check orders should get built and then placed on hold.



#########################################################################
080401 Tue 01 Apr 2008 10:10:27 AM EDT

Finally have a parsable version of the spreadsheet with all (or
nearly all) of Kodak's products. Perhaps I should have requested a
dump of some kind? Oh well.

Oops. Missed a meeting with Qualex. I replied and asked for a data
dump that's more regularly formatted.



#########################################################################
080402 Wed 02 Apr 2008 10:55:10 AM EDT

With Chris here it only took about ten minutes to resolve the issue
with Staging posting orders to Qualex. I sent an order through no
problemo, and emailed Christine, Tom and Peter.

I now have to finish the task of data migration: Kodak's data to our
database. It came out in the conference call yesterday that their
database of all products and specs is... the Excel
spreadsheet. Christine sent me an updated one with gift data in it but
it's essentially useless. Unless you want to do everything by hand,
which it seems Kodak does.

quick notes in a call with thomas from kodak:
"external partner order id tag"
can't post https back to us



#########################################################################
080403 Thu 03 Apr 2008 02:04:39 PM EDT

Yesterday ended with a successful test post to Qualex. I was missing
lineitem, and I just threw in an incrementing variable to fill it. The
data is in the database, in osc_orders_products_attributes, but
extracting it is too tricky for now.

Meanwhile, emailed Christine asking if there was a bug in the
spreadsheet where DOGCOLLAR appears twice for inventory_name; it would
appear inventory_name is their primary key. It was and it is. So that
resolved, once again I dropped/created the table after throwing out my
composite primary key and imported the data. Now all gifts are in.

Which brings me to the next needed part: matching our product IDs to
their "inventory names." This way I can update the products table.

Waiting on Chris, who's been spearheading the Gallery rollout. Bugs
here there and everywhere. The pressure is to get this out before some
"analysts" look at the site.

Anyway, the new products cause Express Select to fail in the
store. Gonna chase that down.



#########################################################################
080407 Mon 07 Apr 2008 10:36:50 AM EDT

Again kicking around the idea of what to do about people who've signed
up on development. So far, noone else has, so I hope my patch worked.

Five customers were affected by sessions errors last night from 1130
to five past midnight. Emailed Ops about it.

typolesbo: im hunbgry

We got the test prints and mug from Kodak today and there were a lot
of cropping problems. If we have to size the image prior to upload,
that will be an issue.



#########################################################################
080409 Wed 09 Apr 2008 10:03:09 AM EDT

Hmm. No entry yesterday? Yesterday was partially soaked up with a
meeting with Qualex. I sat next to a guy with bad cologne for two
hours. Jessy and I were in all black and the Qualex people joked that
Peter didn't match. Also, choosing RRW photos for testing is a good
thing because the "coolness rubs off on us," so to speak.

I am close to wrapping up Qualex order fulfillment. It was a mistake
to try to shoehorn the DPI products... or preserve them, or
whatever. What I need to think about is the ability to determine where
they ship based on manufacturer's ID. That would allow us to swap
between the two... but this is something of a store issue. The store
is inserting the product ID into the orders tables, and those are
bound to the manufacturer. So perhaps I was right to begin with.

Also I realized that testing with Qualex would be simple... just whip
the OFS into shape so that any order created on staging is ready to
go, then copy it to production like I've been doing. Hmmm. There is
also the issue of existing orders... they will have product IDs that
don't match. Gonna have to figure that one out too.

I guess with a mapping of 115 => 7002 (as an example) we could just
run an UPDATE statement against all shopping carts.

Prefix codes are really about "batching" the order, to use Qualex's
term. Qualex "batches" the order for us, so that throws a spanner in
the works.

So I'm toying with a switch: WholeOrder sorts the products by
manufacturer's ID, and each group gets an OrderShippingPart. We could
accommodate District "batching" by prefix code still. Maybe. Dunno yet
if the two paradiggums are compatible.


Again having the same old debate with Chris over moving the data to
Mysql. I told him last night on the way to the Black Door that he'd
eventually get his way, and I thought it was a huge mistake.

Steve Wainstead: one of the problems i have with moving everything to mysql is we're just fighting the same old battle of object/relational mapping.
Steve Wainstead: and i like that every site owns its own data and its data is not mixed together with all the other data
Steve Wainstead: every site has its own object database, in practice
Steve Wainstead: i'm still waiting for a really solid reason to put everything into mysql
chrisatfcity: then your major problem is we have NO way to join data across sites
chrisatfcity: no way to get unified statistics
Steve Wainstead: and why do we need to join across sites?
Steve Wainstead: for what?
chrisatfcity: for future business requirements
Steve Wainstead: you can't name any
chrisatfcity: any kind of social networking will require it
Steve Wainstead: not to be antagonistic. we've had this debate so many times already.
Steve Wainstead: we're not going to be a social networking site.
chrisatfcity: want to share albums between sites...
chrisatfcity: not possible
Steve Wainstead: no, that's possible
Steve Wainstead: totally doable
Steve Wainstead: it just has to be implemented
chrisatfcity: any valid web application out there these days is backended with a relational database.
chrisatfcity: it would be insane not to.
Steve Wainstead: if the need were that great we would have done it by now
Steve Wainstead: and there you go again
Steve Wainstead: "valid web application"
chrisatfcity: sorry
chrisatfcity: profitable ...
chrisatfcity: viable
Steve Wainstead: well, no need to apologize. but it's very telling of your thinking
chrisatfcity: proper
chrisatfcity: well designed
Steve Wainstead: we are not a real web app until everything is in a rdbms
Steve Wainstead: no site is well designed unless everything is in an rdbms
chrisatfcity: not saying that I'm saying we are severely disabled until we are in an rdbms
chrisatfcity: we are not marketable
Steve Wainstead: kodak is giving us $250K. how is that not marketable?
chrisatfcity: the french we dealt on the phone were shocked we didn't have our data in a db and rightly so.. pretty much my thinking is that our software is not sellable or white labelable until it is DB driven.
chrisatfcity: They don't care what is underneath as they just want us to buy prints.
Steve Wainstead: i disagree
chrisatfcity: they are not "buying us"
chrisatfcity: if they or anyone did a technical due dilligence on mpa for plans to purchase it would fail on the fact that we use dat files
chrisatfcity: rather than an rdbms
Steve Wainstead: again i disagree
chrisatfcity: As most apps to unify a system require that
Steve Wainstead: unless they were simpletons
Steve Wainstead: and again i disagree
chrisatfcity: well your wrong.
Steve Wainstead: i don't believe at all, Chris, that you think there is "only one way to do things right"
Steve Wainstead: i know you better
Steve Wainstead: but this is what i keep hearing from you
chrisatfcity: No, but for this app to make it at all... it will need to have the photos config and all the meta data in the DB so it is searchable and statistics can be generated on our userbase.
chrisatfcity: on the fly
Steve Wainstead: you want to lead the market and be an innovator, look into couchdb instead. http://incubator.apache.org/couchdb/docs/overview.html
chrisatfcity: I don't trust these S3 ec2 app engine.
chrisatfcity: once you place your trust into a 3rd party vendo things get hairy
chrisatfcity: look at evolutionware
Steve Wainstead: couchdb is built on erlang and uses a document model
Steve Wainstead: and is meant for shared-nothing sites
Steve Wainstead: i like that we currently don't have to build every object out of relational data, which means reams of code. right now we simply unserialize the dat file.
Steve Wainstead: it couldn't be any easier than that
Steve Wainstead: and our schema is 10x simpler. remember all the headaches you had with cascading deletes?
chrisatfcity: there weren't headaches.
chrisatfcity: it was fucking awesome
Steve Wainstead: i remember them clearly :)
chrisatfcity: There were none
Steve Wainstead: yes there were
chrisatfcity: it works
chrisatfcity: properly
Steve Wainstead: you were pulling your hair out
Steve Wainstead: well it works now, yes
chrisatfcity: wtf are you talking
chrisatfcity: about
Steve Wainstead: after a ton of frustration
chrisatfcity: um no... there was NO frustration
chrisatfcity: no was setting up the new schema
Steve Wainstead: oh, trust me. i remember very clearly how aggravated you were getting the cascading deletes to work :)
Steve Wainstead: i can understand you don't remember
chrisatfcity: get them to work.. it is a fairly simple schema.
chrisatfcity: there were no probnlems getting it to work
Steve Wainstead: yes there were. i remember very clearly.
chrisatfcity: in fact once the syntax was straightened out it work right off the bat
Steve Wainstead: i think it took you a day and a half
chrisatfcity: I was surprised at how easy it was..
Steve Wainstead: i remember you cursing over it
chrisatfcity: to redesign the schema yea
chrisatfcity: I've never cursed while doing mysql schemas
chrisatfcity: seriously i don't know what your smoking, but that last schema was fine..
chrisatfcity: veracity on the other hand I was cursing at that
chrisatfcity: trying to get that to work the the new schema was a bitch
chrisatfcity: that was where i was pulling my hair out.
1:45 PM
chrisatfcity: because it did unecessary recursions and caused duplicate data in the db
Steve Wainstead: ah, no it didn't!
chrisatfcity: that is what fucked with the Foreign keys
Steve Wainstead: you found a bug but didn't realize it!
chrisatfcity: because it was trying to insert entries twice
Steve Wainstead: and you did that isRoot() hack, to get around it
Steve Wainstead: what you found were orphaned albums
chrisatfcity: wasn't a hack..
Steve Wainstead: a bug i still have to go fix
chrisatfcity: i fixed it
Steve Wainstead: well, you didn't know it was a hack but it was
Steve Wainstead: because you thought you were getting duplicates. you weren't.
chrisatfcity: it worked proper that was all i cared about
Steve Wainstead: you were finding albums with no parent!
Steve Wainstead: there are a few thousand of them on production
chrisatfcity: well they should be deleted then.
chrisatfcity: And I'm not sure that was the case
Steve Wainstead: oh, i know, because i worked it out back in january or so.
Steve Wainstead: actually back in november. my log entry from the 15th:
[long log entry from 11/15 omitted]


So I record the never ending debate here for posterity. The vengeful
thing to do is to give him what he wants. The problem is it would
probably just be my problem in the end, anyway.

Oh, I don't need to alter table for osc_products. I bet
ofs_prefix_code is already just some int. Well, it's a bigint. No
matter.

I probably want to create a Qualex category for all Qualex products. I
am heading towards a Qualex prefix code, etc. etc. It just seems
simpler.

Well... a dead end, kinda:

root@torque:~/public_html/projects/ofs/bin# ./makeclean.pl  21628; ./import_files.pl ; ./create_orders_xml.pl 
[./import_files.pl] Starting at Wed Apr  9 18:56:08 2008
[./import_files.pl] [pid 15197] [orders_id 21628] [Wed Apr  9 18:56:08 2008] Changed processing_state to pending
ERROR: OrderPartFactory got a bogus category code: '21'
root@torque:~/public_html/projects/ofs/bin# 

So how to build the order if there's only one category code? Not
doable. All the Qualex products still need to be sorted into
categories; the OrderParts then build up the order based on
these. Hrmm.

So my first thought is to add the assorted Qualex products to
osc_products_to_categories; and for each OrderPart subclass, make the
prefix code a parameter passed in. But this means each one's query has
to do the correct thing. So I need to test the query for, say,
LargePrints to see if it will get the Qualex large prints or not. I
think it will because it has in the past.



#########################################################################
080410 Thu 10 Apr 2008 09:39:48 AM EDT

I managed to back out. The problem above came when I added a Qualex
category in the returned results of DBInterface::categories. Category
21 freaked out the OrderPartFactory.

The problem seems to be: I have the categories expressed in the DB
class instead of the database. So at the moment I'm thinking that I
should create a table for this; osc_categories_manufacturers, which
expresses just that... except... that also sounds wrong.

Categories seem to want to have "types." Some categories are a means
of sorting products into groups for the customer: shirts, prints,
posters, calendars. Others are more "system oriented." The first
example is 1, which is currently labeled "All Products" but is
actually "Can Be Sold" or "Sellable." If a product is not in 1, it
cannot display in the cart. (The reason for that is ancient and I
don't recall it).

So coming back to the current problem: we need a list of categories
for OrderPartFactory. Each category must map to an OrderPart subclass
to handle those products. Instead of a SELECT statement, I have this
hardwired into DBInterface.

I was thinking some of the OrderParts could be consolidated: a Kideo
and a poster print really function the same way, they just create
separate directories. Oh, another idea I had was to create all
prefixed order id directories (like 800023621) as subdirectories of
the whole order (23621). I wonder why I didn't do that to begin
with. The thought there was the Qualex xml file could live in the
order id directory, and all the products could continue to be sorted.

So part of the problem of the last couple of days has been: my getting
pulled in different directions by these design decisions. I've made
some incremental improvements to the db schema, though; and I think
I've identified a problem in the design vis the DBInterface expressing
the categories... this should be in the DB, I suppose. On the
downside, an update to the database would cause orders to fail ("Bogus
category ID of 21"). But if the error message is sufficient, the
rollback would be simple. Versus now, where one adds a line to the
DBInterface class; easily reversable.

So anyway, at the outset (building the order) we're not interested in
manufacturers, are we? Well, we do sort the order into parts via
prefix codes. Each prefix code corresponds to a manufacturer; multiple
prefix codes can map to one manufacturer (District). Now, multiple
products in multiple categories must map to one prefix code. This is
part of the bind I'm in.

The osc_categories table has parent_id. This is the category's parent
category; currently the only thing there is 21, Photographs, is the
parent to 22, Glossy and 23, Matte. But this means a category can only
have one parent. Hrmm. I still need this:

# The following subs are used by the factory classes...

sub categories {
    my ($self) = @_;
    return (
            $self->folding_cards_category   ,
            $self->glossy_category          ,
            $self->photo_gifts_category     ,
            $self->cards_4x8_category       ,
            $self->cards_5x7_category       ,
            $self->archive_cds_category     ,
            $self->photo_calendars_category ,
            $self->large_prints_category    ,
            $self->frames_category          ,
            $self->books_category           ,
            $self->kideo_category           ,

            );
}


This is obviously a hardcoded version of a SQL query. (Is this solving
my problem though? I need to get all the photos for Qualex, id of
7000+, to be built). (Well, parameterize the prefix code, then. For
each category there's a prefix code, isn't there? Well, for each
product there's a prefix code. Is that accurate? Then the query is
really: for each product, get the prefix code it needs. Pass these
prefix codes to the OrderPart subclasses. No? Well, 11000000 is Qualex
and that's multiple products. So that can't be, can it? Yes: Category
maps to subclass. Prefix code is the directory, which is a
parameter. For all product IDs in the order, get all distinct prefix
codes? No, not quite).

Another thought is to let the OrderParts sort the order into the
prefixed order id directories, then have OrderShippingPart consolidate
them. Hmm.

And in factoring out all the prefix codes from the OrderPart
constructors, I may have found an answer... gifts were being placed in
the PRINTS_PREFIX_CODE directory. (They were? Did I make that change
in this session?) Aha, I did. I suck. Well, that's what version
control is for :o) It told me the truth.

Well, I changed the prefix code passed in to the constructors of the
OrderPart subclasses. Looks good. But the Qualex_ShippingPart class
won't put the poster in the xml. Hrmm. Perhaps it doesn't find it
because there's no fs_path?

----

I'm thinking about a class hierarchy for products, to be used by the
shipping classes. Select all products for this order by manufacturer,
and all the rows returned are instances of ShippingProduct (or
something). Hmm. The issue is the XML for the assorted manufacturers
differs; so somehow ShippingProducts have to present one unified
interface that each ShippingPart instance knows how to use. Worth some
thought.

The Qualex xml is so *regular* that I wish we'd done it from the start.



#########################################################################
080411 Fri 11 Apr 2008 03:33:20 PM EDT

OrderPart subclasses have three responsibilities:

1. Locate the image on the filesystem (in an album, in a gift dir, etc)
2. Do any processing on that image (resizing, converting).
3. Put the image in a prefixed orders directory.

OrderShippingPart subclasses are specific to a manufacturer:

1. Create the XML file.
2. Upload the order.


With a bit of refatoring, some duplicate code can be factored out of
the OrderPart subclasses. OrderPartLargePrint is identical to
OrderPartGifts.

So this works, and I wonder if I can't use it to jam most of
everything into the xml for qualex:

SELECT p.*
 FROM osc_products p, osc_orders_products op, osc_manufacturers m
 WHERE p.products_id      = op.products_id
 AND op.orders_id         = 21631
 AND m.manufacturers_name = 'QUA'
 AND p.manufacturers_id   = m.manufacturers_id;

This scopes it to just prints:

SELECT p.*
 FROM osc_products p,
      osc_orders_products op,
      osc_manufacturers m,
      qualex_prints qp
 WHERE p.products_id      = op.products_id
 AND op.orders_id         = 21631
 AND m.manufacturers_name = 'QUA'
 AND p.manufacturers_id   = m.manufacturers_id
 AND p.manufacturers_product_id = qp.inventory_name
;

Similarly:

SELECT p.*
 FROM osc_products p,
      osc_orders_products op,
      osc_manufacturers m,
      qualex_gifts qg,
      qualex_product_categories qc
 WHERE p.products_id      = op.products_id
 AND op.orders_id         = 21631
 AND m.manufacturers_name = 'QUA'
 AND p.manufacturers_id   = m.manufacturers_id
 AND p.manufacturers_product_id = qg.inventory_name
 AND qg.product_category_id = qc.id
;




#########################################################################
080414 Mon 14 Apr 2008 11:34:59 AM EDT

Once again I'm somewhat frustrated by my save-shell-buffer-contents
scheme not working anymore. Any of our servers that were upgraded from
Mandriva to Ubuntu developed this annoying habit of trying to execute
every line of the saved shell buffer contents, which would be comical
were it not so disastrous. (The result was a frozen shell buffer, and
dozens of crap files created in the current working directory).

For now I'm trying a kludge: append today's date to the shell buffer
contents file. At least the contents won't get overwritten on
startup. That is: today, Monday, I started up Emacs. Because I've
disabled inserting the shell buffer contents (or my previous hack
failed to do so; for a while at least root's contents got inserted)
shortly after startup each shell buffer, which was pretty much empty,
had its contents written out, overwriting last week's stuff. So all
that work is "lost," so to speak. It's really about keeping track of
what I've done.

And for now, success:

-rw-r--r-- 1 swain swain     165 2008-04-14 11:38 .emacs.shellbuffer.cvssync-2008-04-14
-rw-r--r-- 1 swain swain   13112 2008-04-14 11:38 .emacs.shellbuffer.cli-2008-04-14
-rw-r--r-- 1 swain swain     135 2008-04-14 11:38 .emacs.shellbuffer.www-2008-04-14
-rw-r--r-- 1 swain swain     465 2008-04-14 11:38 .emacs.shellbuffer.root-2008-04-14
-rw-r--r-- 1 swain swain      97 2008-04-14 11:38 .emacs.shellbuffer.test-2008-04-14
-rw-r--r-- 1 swain swain     403 2008-04-14 11:38 .emacs.shellbuffer.sql-2008-04-14

These will not be reloadable; not without some serious handstands. So
this is something of a challenge in elisp programming.

The problem, I think, stems from the startup time of a shell
buffer. Under Mandriva, the shell came up, the contents inserted, and
there was no problem. With Ubuntu, I think the contents get inserted
after the shell starts up. AFAIK, there's no way to find out if the
shell has started or not, from Emacs.

So I've thought of a variety of hacks, none satisfactory. It seems the
simplest thing to do is: set a buffer local variable when the shell is
created. The first time we're going to write out the buffer contents,
if this variable is nil, we insert the previous contents and then
save. My previous attempt to make this work failed however. Don't
recall why.





#########################################################################
080415 Tue 15 Apr 2008 03:36:17 PM EDT

I find myself back at a point where I want to pull all the products
for this order that go to Qualex. And my first impulse is to define a
category for all Qualex products; but then, this is completely
unnecessary because I should just do a join for 'QUA'. All fine and
dandy. But I again come back to another issue... for every
OrderShippingPart it needs to get its products from the database, the
images for which are already in the prefixed orders directory. I'm
thinking each row from the query should be an object with a standard
interface. Somehow I feel this would make life easier than dealing
with hashes with myriad keys.

Let's define that hash right now.. oh, already did:


#     rows returned:
#         new_image_name
#         order_datetime
#         xml_transit_date
#         manufacturers_product_id
#         order_item_quantity


Actually it's larger than that, going by Data::Dumper:

$VAR4 = {
          'order_item_product_code'   => '7008',
          'order_datetime'            => '2008-04-10 14:32:19',
          'order_item_description'    => '4X6',
          'order_item_image_filename' => '17491.jpg',
          'order_item_quantity'       => '1',
          'new_image_name'            => '17491',
          'fs_path'                   => '/mnt/slow/vol01/s/sw/swa/swai/swain/swain/albums/album31/P8070061.jpg',
          'orders_id'                 => '21631',
          'products_options'          => 'fs_path',
          'ship_to_dpi_date'          => '2008-04-15 11:53:58'
        };
$VAR5 = '3';
$VAR6 = {
          'order_item_product_code'   => '7008',
          'order_datetime'            => '2008-04-10 14:32:19',
          'order_item_description'    => '4X6',
          'order_item_image_filename' => '17493.jpg',
          'order_item_quantity'       => '1',
          'new_image_name'            => '17493',
          'fs_path'                   => '/mnt/slow/vol01/s/sw/swa/swai/swain/swain/albums/thirdcolumn/P6130028.jpg',
          'orders_id'                 => '21631',
          'products_options'          => 'fs_path',
          'ship_to_dpi_date'          => '2008-04-15 11:53:58'
        };

And now I recall some issue where we use fs_path versus
gift_something_something. Hrmm.


And now, again, I see where building the order at the outset has the
problem of putting District prints into 100000000 and Qualex prints
into 1100000000. But we would never do this, would we? The customer
would receive their prints in two mailings. Not optimal.

So on rollout, I'll have to update all existing carts, mapping one
product ID to another.

Anyway the point to the paragraph previous to last is: orders could
have been divided by product ID and manufacturer ID. This would
somehow allow District prints to go into 100000000 and Qualex prints
to go into 1100000000. And all the right things would happen. As it
stands, I only have to make sure 5x7 slimlines go to District.

So there will never be an order with mixed print product IDs, and if
there is it's an error.

Been tracking down why 11x14 won't go into the cart with the correct
product ID. No, actually, I started out with my new
store.product_codes.conf file; that lead me on a journey through
Jacob's code to find how the product ID is defined:

    //////////////////  This puppy is used in gifts/classes.php to make a bunch of defines
    function defineProductCodesAndPrices() {
        $result = $this->_queryDB("SELECT p.products_id,
                                          p.products_price,
                                          pd.products_name,
                                          constant_name
                                          FROM
                                          osc_products p,
                                          osc_products_description pd
                                          WHERE p.products_id = pd.products_id
                                          AND constant_name <> ''
                                  ");
        if ($result) {
            while ($row = mysql_fetch_assoc($result)) {
                if (strlen($row['constant_name'])) {         ////////////// if strlen is not 0
                    define($row['constant_name'] . '_ID'   , $row['products_id']   );
                    define($row['constant_name'] . '_PRICE', $row['products_price']);
                    define($row['constant_name'] . '_DESC' , $row['products_name'] );
                }
            }
        }
    }


So that makes it hard to change things, in a sense... as originally
planned, the constant_name is hardwired into the classes. So I think,
more and more, the one time effort of renaming the constant_name for
every old and new product is the fixed one time cost of doing this.

I just updated the 11x14 product class and it worked OK, except that
the wrong product class in the store was invoked. Which is another
issue: Gallery and the store both have product classes. Whether they
can be unified is another question. This might lead to the "shared
library" issue all over again.


And another note. This looks kind of like an antipattern to me:

      8:define('PRODUCT_ID_11X14', '140');
      9:define('PRODUCT_ID_12X18', '139');
     10:define('PRODUCT_ID_16X20', '231');
     11:define('PRODUCT_ID_20X30', '233');
    177:        if(in_array($products_id, array(PRODUCT_ID_11X14, PRODUCT_ID_12X18))) {
    180:        else if(in_array($products_id, array(PRODUCT_ID_16X20, PRODUCT_ID_20X30))) {


It says "this should be a database lookup" and not an array search.

Oh, actually, I think it will be a mix of changing constant names and
changing the constant in the product file. PRINT_11X14_MATTE would be
completely inaccurate.




#########################################################################
080417 Thu 17 Apr 2008 11:13:36 AM EDT

By end of day yesterday I had again updated matchup.pl and committed
it... it now generates two files, rather than outputting to
stdout. This seems to be the typical pattern for these sorts of
things... I always wind up writing a "do" file and an "undo" file. I
also refactored the class DBInterface.pm in a fairly large way.

sub set_order_pending {
    my ($self, $orders_status, $orders_id) = @_;

#     my $dbh = $self->get_connection;
#     my $sth = $dbh->prepare($self->get_update_status_sql)  or die $DBI::errstr;
#     $sth->execute( $orders_status,'pending', $orders_id) or die $DBI::errstr;

    my $sth = $self->exec_statement_handler(
        $self->get_update_status_sql,
        $orders_status,
        'pending',
        $orders_id
        );

    $sth->finish();
}

This is a pretty typical example. I can now turn on debugging and see
all the database chatter. Well, nearly all of it.

sub exec_statement_handler {
    my $self  = shift;
    my $query = shift;

    $self->log("Running query:\n$query\nwith args: '", join(', ', @_), "'")
        if DEBUG;

    my $sth = $self->{dbh}->prepare($query)
        or die $DBI::errstr;

    # the array '@_' holds the rest of the args passed in (if any)...
    $sth->execute( @_ )
        or die $DBI::errstr;

    return $sth;
}

I've done a little bit of work trying to solve the
insert-previous-shell-buffer-contents problem again. I was looking at
shell-mode-hooks. It's kind of surprising how many hook functions I've
installed over the years... and I still don't quite grasp how to do it
on my own. I understand what hook functions are and how they work, but
adding them is another thing, and what happens is still another thing.

So I think I'm kind of at a milestone point, or something. I still
need to make the OFS work end to end with Qualex for any product
though. I fixed a bug yesterday in doing end to end with our current
suppliers (mock-zaah.php was missing from
swainstore.myphotodevel.com). I did that as part of my refactoring of
DBInterface.pm.

Oh, and I added code to update prices too. I still haven't committed
my output file as a DB patch. And I started looking at mugs-import.pl,
and found that it was incorrect... I was inserting the billing code
and not the inventory name. So here's a chance to delve into the
qualex_gifts table.

The mystery of yow resolved:


From monnier@iro.umontreal.ca  Thu Apr 17 13:19:12 2008
Delivered-To: swain@torque.dev.fortunecity.com
Subject: Re: yow returns the same line every time
Date: Thu, 17 Apr 2008 13:18:58 -0400

> Executing (yow) over and over always returns the same line:
> "Yow!  Legally-imposed CULTURE-reduction is CABBAGE-BRAINED!" [4 times]

Yes, its' the only line left.  IIRC the others were removed because of
copyright issues.


        Stefan


I reported it via emacs (report-emacs-bug).

---

I've replaced the sub 'categories' with 'get_orders_categories' and
taught the OrderPartFactory to ignore categories_ids it knows nothing
about. More hardwired stuff removed. Now, there is still the mapping
of which OrderPart class is responsible for which product category;
and this is expressed in the OrderPartFactory. Can this be removed? Is
it something that should go in the database? For now, it stays,
because it's fairly readable and I'm thinking that moving the
expressing of these relationships into the db will make the system
harder to read for humans.

So orderpart to category, and we just pass in another prefix code. Oh,
that new conf file has to go...



#########################################################################
080421 Mon 21 Apr 2008 10:24:37 AM EDT

Should be working on a rollout today. Sidetracked by a programming
puzzle: averaging the sales numbers without writing a script.

swain@torque:~/public_html/projects/ofs/lib$ echo "1,431.02 
1,298.97 
1,782.57 
1,139.87 
1,597.39 
1,548.58 
1,959.65 
1,305.27 
1,344.92 
1,086.86 
1,552.77 
1,071.58 
1,467.65 
1,787.49 
1,357.48 
1,694.42 
  935.69 
1,194.98 
1,532.04 
1,456.32 " | perl -ne 'BEGIN{$x=0.0} chomp; s/,//g; $x += $_; END { print $x/$., "\n" }'
> > > > > > > > > > > > > > > > > > > 1431.02

Darky helped work that out. Two bugs hampered the effort: feeding the
input incorrectly, and the numbers have commas in them.

OK, rolled everything back. Fixed a bug in my undo script for prints;
the District products got the Qualex constant names. Easily remedied
by testing the product ID.

Store idea: it would be super useful if the store tracked every step
the user took, and dump that in a debug output. This "no billto" is
annoying and the debug dump tells me nothing.




#########################################################################
080422 Tue 22 Apr 2008 12:01:53 PM EDT

----------------text pasted by Wainstead \ to Emrys' Tavern----------------
AIM IM with typolesbo.
11:51 AM
typolesbo: I may have to kill me
typolesbo: sorry kill him
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
heller [to Wainstead \]: that's quite the typo. 
merlin [to Wainstead \]: she needs to be sure she never arranges a hitman over im or email


Snuffed out a bug. Julian Tree hardcoded the product IDs in some
Javascript, but what's more, he did a substring call that depended on
the length of the product ID being 3 digits.

function updateQty(_pid,_qty) {

  //document.log = "";
  //document.log += "updateQty: got: " + _pid + ' ' + _qty + "\n";

  var sizes = get_sizes();

  var j;

  for (var i in photoObj){
    for (var pcode in sizes) {

      j = sizes[pcode] + i;

      //document.log += "working on: j=" + j + "\n";

      if ((_pid == 7043) && (!$(j))){ 
        //document.log += "it's 7043\n";
        itree_set_value( 'cq_7008_'+i , _qty);
      } else {
        //document.log += "It's not 7043, subst: " + j.substring(3,7) + " from " + j + "\n";
        itree_set_value(j,   ((_pid + '' == j.substring(3,7) + '')
                              ? _qty 
                              : 0) 
                        );
      }

    }
  }
  //alert(document.log);
}


(from shopping_cart.js).

I need to write a couple patches now. I think I'll commit the SQL for
inserting photo products.

Rollout of Qualex printing was completed at 6pm.


#########################################################################
080423 Wed 23 Apr 2008 02:20:47 PM EDT

Tired today. Was up early, in before 8:30. Was here late; past seven
thirty I believe. At the last minute there were a couple bugs in the
rollout.

One was: some spurious define()s in store.conf that are only on
production. They defined PRODUCT_4X6 as 114, for example. This trumped
everything else; the javascript in the shopping cart didn't work.

Then the new signup coupons didn't work. I found my swain4 didn't
work, and that was the tipoff. I edited a dump of osc_offers and
changed the category ID from 22 to 21.

Manager's meeting today, and miscellanous this and thats. Reported a
CP case to the NCMEC. Can't find an Excel spreadsheet Jessy has on the
shared drive.. perms probably.

Loaded all my rrw photos into iPhoto. Created some smart albums. Not
too shabby. It gets up to speed shortly after.




#########################################################################
080424 Thu 24 Apr 2008 12:31:50 PM EDT

Yesterday blew right by.

Spock: "He is intelligent, but not experienced. His pattern indicates
two dimensional thinking."




#########################################################################
080428 Mon 28 Apr 2008 01:44:48 PM EDT

Friday I resolved some bugs with 4x8 slimline cards. Been busy today
going through the MediaClip installer's guide (another book builder
program), emails, researching Amazon's SimpleDB and Goole's App
Builder, and with the problem of order notifications. No idea why the
status updates for all the test orders worked fine...

Sent 28 orders through again. Had a tiff with Chris over AIM:
replication is still broken on mdb-1. He can't fix it. He blames the
table sizes and 32 bit architecture. He blames Gallery.

Steve Wainstead: replication is still not fixed?
Steve Wainstead: i am getting wildly different results on mdb1 an 2
chrisatfcity: no.... the tables are too big too import into mdb-1
chrisatfcity: I can't do a single transactional dump.
chrisatfcity: goddamn 32 bit boxes..
Steve Wainstead: bleh
chrisatfcity: I've been taking backups of mdb-2 so need to worry
Steve Wainstead: here is why i am terrified of putting everything in the database
chrisatfcity: we are MIGRATING to a new DB server.
chrisatfcity: chrissakes..
chrisatfcity: we are also moving off of 32bit architecture
chrisatfcity: plus this database is bloated and is twice the normal size.
chrisatfcity: with dupes entries in mpa_albumitems and mpa_photos
chrisatfcity: max row in this DB shouldn't exceed 100 or so million.
chrisatfcity: right now we are there because we have some much duplicate data.
chrisatfcity: so it takes forever to do an import
Steve Wainstead: that does little for my confidence, sadly.
chrisatfcity: i don't know what that means?
Steve Wainstead: i am not confident we can run MPA on top of Mysql
chrisatfcity: you have no confidence in MySQL? then stop using flickr wikipedia.
chrisatfcity: and any other app that uses mysql.
Steve Wainstead: because we cannot manage it
chrisatfcity: fuck you.
chrisatfcity: So you ar enot confident in me basically.
Steve Wainstead: i'm sorry chris, but that's how i feel
Steve Wainstead: no
chrisatfcity: Yes
Steve Wainstead: i think you can do it. but ... i haven't seen it yet.
chrisatfcity: Haven't seen what?
chrisatfcity: I've already told you I';ve managed a DB 3 times thjis size at whenu
chrisatfcity: and we had a lot more riding on that db
Steve Wainstead: i didn't mean "no, i am not confident in you"
Steve Wainstead: i have a very high opinion of your abilities
chrisatfcity: I've already said this DB is a piece of piss
chrisatfcity: compared to the whenu one
chrisatfcity: we just need to fix the frickin application
chrisatfcity: to use the DB properly.
Steve Wainstead: well, one way or another we're porting mpa to mysql, so you better be right
chrisatfcity: Well the app is worthless to anyone without the data in
a centralized DB... as long as it is shardable.. it is scalable.






#########################################################################
080429 Tue 29 Apr 2008 01:59:28 PM EDT

Chris has no memory of being the blocking point on MPP. He flipped me
off in the manager's meeting today.

Meanwhile, I need to get the OFS done.

Sent out email on how to roll out gifts. In the end: folded cards will
continue to go to Zaah because I don't know how to get the
orientation... Qualex does do 5x7 slimlines, and I hacked that
in. Everything looks good now. Briefed Fernando on how to roll back.

Off to Las Vegas.



#########################################################################
080505 Mon 05 May 2008 03:09:51 PM EDT

One big bug I missed: hockey pucks, which are DPI only, wound up in
the Qualex orders. Fcat correctly created a new category for DPI-only
products and updated the OrderPartsFactory.

Took until 1pm to flush out my email. There were some odd store errors
but nothing major.

The Sears thing: this is akin to people being able to buy photo gift
products without creating an MPA account.




#########################################################################
080508 Thu 08 May 2008 12:17:52 PM EDT

Culled my MPP entries for Mike. He's going to do development on MPP
now. I have to step him through the app.


From osc.log:

deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: swaincalendar: subdomain plookfish
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: swainbook: page count: 25
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: Cover URL: cover-fetcher.php?AlbumID=8VKGOF6UTAZ1
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: swain__: shipping grand total 54.15
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: /login.php: Cart::calculateEverything called.
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: DiscountHelper::applyClubDiscount: Applying club discounts now...
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: No club discounts for this order.
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: swain__: default US shipping
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: GiftCardShipping::getShippingCost() called
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: swain: Got this many card sets: 5
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: swain: tier is: US
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: swain: gift card query: SELECT first_item + (additional_item * (5 - 1)) AS shipping_cost
                  FROM osc_giftcard_shipping
                  WHERE shipping_method='US'
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: swain: gift card shipping cost: 975
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: FoldedCardShipping::getShippingCost() called
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: swain: Got this many card sets: 5
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: swain: tier is: US
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: swain: gift card query: SELECT first_item + (additional_item * (5 - 1)) AS shipping_cost
                  FROM osc_foldedcard_shipping
                  WHERE shipping_method='US'
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: swain: gift card shipping cost: 899
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: swain__: shipping grand total 54.15
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: Subtotals update query:
UPDATE osc_cart SET  `content_type` = 'physical' , `subtotal_amount` = '360.42' , `shipping_amount` = '0' , `order_total` = '360.42' , `tax_amount` = '0' , `tax_pct` = '0' , `t\
ax_name` = 'Tax' , last_accessed = NOW() WHERE sess_key LIKE 'deb1f14e663e6790909683df5510cfe5'

deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 ::
Cart::calculateEverything done.

Here is the boundary, it would seem, between the call to login.php and the
call to shopping_cart.php.

deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: /shopping_cart.php: Cart::calculateEverything called.
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: DiscountHelper::applyClubDiscount: Applying club discounts now...
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: No club discounts for this order.
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: swain__: default US shipping
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: GiftCardShipping::getShippingCost() called
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: FoldedCardShipping::getShippingCost() called
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: swain__: shipping grand total 0
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: Subtotals update query:
UPDATE osc_cart SET  `content_type` = 'virtual' , `subtotal_amount` = '0' , `shipping_amount` = '0' , `order_total` = '0' , `tax_amount` = '0' , `tax_pct` = '0' , `tax_name` = \
'Tax' , last_accessed = NOW() WHERE sess_key LIKE 'deb1f14e663e6790909683df5510cfe5'

deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: Cart::calculateEverything done.
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: __swain:  RegisteredUser returning login.php
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: __swain:  RegisteredUser returning login.php
deb1f14e663e6790909683df5510cfe5  2008-05-08  14:29:55 :: script name: /shopping_cart.php


[08/May/2008:14:28:30 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /shopping_cart.php?action=add_product&book=5000{px_book_id}8VKGOF6UTAZ1 HTTP/1.1" 7657
[08/May/2008:14:28:34 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /shopping_cart.php?action=add_product&book=5000{px_book_id}8VKGOF6UTAZ1 HTTP/1.1" 7657
[08/May/2008:14:28:34 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /cover-fetcher.php?AlbumID=0K4GKE3MO7JD HTTP/1.1" 8094
[08/May/2008:14:28:34 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /cover-fetcher.php?AlbumID=8VKGOF6UTAZ1 HTTP/1.1" 7613
[08/May/2008:14:28:35 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /cover-fetcher.php?AlbumID=0TQR10E4OQJB HTTP/1.1" 3539


[08/May/2008:14:29:32 -0400] 64.52.253.115 TLSv1 AES128-SHA "POST /shopping_cart.php HTTP/1.1" 26
[08/May/2008:14:29:33 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /login.php HTTP/1.1" 4070
[08/May/2008:14:29:54 -0400] 64.52.253.115 TLSv1 AES128-SHA "POST /login.php HTTP/1.1" 26
[08/May/2008:14:29:55 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /shopping_cart.php HTTP/1.1" 3319
[08/May/2008:14:29:56 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /images/order-prints-now.gif HTTP/1.1" 431
[08/May/2008:14:29:56 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /images/store-account-info.gif HTTP/1.1" 1009
[08/May/2008:14:29:56 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /images/prints.jpg HTTP/1.1" 10573
[08/May/2008:14:29:56 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /images/gifts.jpg HTTP/1.1" 20927
[08/May/2008:14:29:56 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /images/join-the-club-now.gif HTTP/1.1" 432
[08/May/2008:14:29:56 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /images/create-gifts-now.gif HTTP/1.1" 423
[08/May/2008:14:29:57 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /images/club.jpg HTTP/1.1" 16651


[08/May/2008:14:31:17 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /shopping_cart.php?action=add_product&book=5000{px_book_id}MJ7KGI09TIZI HTTP/1.1" 3655
[08/May/2008:14:31:18 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /shopping_cart.php?action=add_product&book=5000{px_book_id}MJ7KGI09TIZI HTTP/1.1" 3655
[08/May/2008:14:31:19 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /cover-fetcher.php?AlbumID=MJ7KGI09TIZI HTTP/1.1" 3556
[08/May/2008:14:31:44 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /shopping_cart.php?action=add_product&book=5000{px_book_id}BDYBN5IPB4KC HTTP/1.1" 3777
[08/May/2008:14:31:46 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /shopping_cart.php?action=add_product&book=5000{px_book_id}BDYBN5IPB4KC HTTP/1.1" 3777
[08/May/2008:14:31:47 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /cover-fetcher.php?AlbumID=MJ7KGI09TIZI HTTP/1.1" 3556
[08/May/2008:14:31:47 -0400] 64.52.253.115 TLSv1 AES128-SHA "GET /cover-fetcher.php?AlbumID=BDYBN5IPB4KC HTTP/1.1" 8111


My thinking is there's a bug in the cart merging section. Observe:

mysql> select cart_id , order_total from osc_cart where customers_id=7;
+-----------+--------------+
| cart_id   | order_total  |
+-----------+--------------+
|  38452344 |   0.00000000 |
|  39418317 | 107.93000031 |
|  51083438 |   0.00000000 |
|  51459616 |   0.00000000 |
|  51688837 |   0.00000000 |
|  52030449 |   0.00000000 |
|  52440004 |   0.00000000 |
|  52720226 |   0.00000000 |
|  52807794 |   1.63999999 |
|  53824850 |   0.00000000 |
|  55202072 |   0.00000000 |
|  55526754 |   0.00000000 |
|  57620834 |   0.00000000 |
|  57681634 |   0.00000000 |
|  57766452 |   0.00000000 |
|  61312672 |   0.00000000 |
|  64262078 |   0.00000000 |
|  65299186 |   0.00000000 |
|  69384076 |   0.00000000 |
|  71744194 |   0.00000000 |
|  72578870 |   0.00000000 |
|  73308644 |   0.00000000 |
|  76463810 |   0.00000000 |
|  77017610 |   0.00000000 |
|  77021016 |   0.00000000 |
|  78484126 |   0.00000000 |
|  81095096 |   0.00000000 |
|  88704542 |   1.68000007 |
| 104891618 |   0.00000000 |
| 108267172 | 148.33999634 |
| 108267536 |   0.00000000 |
+-----------+--------------+
31 rows in set (0.00 sec)


Jessy has 37 carts? This should not be. But this does not appear to be
related to her dissappearing merchandise. I did a left outer join on
all the rows above with osc_cart_contents: 

mysql>  SELECT si.cart_id, si.sess_key, si.order_total, c.unique_string FROM osc_cart si  left outer join osc_cart_contents c ON si.sess_key = c.sess_key WHERE si.customers_id = 7 AND c.unique_string is null limit 100;
+-----------+--------------------------------------+--------------+---------------+
| cart_id   | sess_key                             | order_total  | unique_string |
+-----------+--------------------------------------+--------------+---------------+
|  38452344 | 8cb4147e59e7ddb5ec48cefef3a04e95     |   0.00000000 | NULL          |
|  39418317 | 5f49dcdadc3b45072a3ae62962eb3ee6     | 107.93000031 | NULL          |
|  51083438 | 0728fbcb80b6f828fa33ad4992a7265b     |   0.00000000 | NULL          |
|  51459616 | 1986ce7e817a3492964aa289d0c63925     |   0.00000000 | NULL          |
|  51688837 | 0f665f035e0dca60e3a6cb8be6d10595     |   0.00000000 | NULL          |
|  52030449 | 65aa86f89dda1306c8207340ccc9b047     |   0.00000000 | NULL          |
|  52440004 | a7738751dc5ee10605c754cb2e7463bd     |   0.00000000 | NULL          |
|  52720226 | ef932caa2ccc3a2b1dc147e18451d903     |   0.00000000 | NULL          |
|  52807794 | 962f567272f14b6d396cdafbcfaba52e     |   1.63999999 | NULL          |
|  53824850 | 2454037c6d927c16e0d1365c5c9aad26     |   0.00000000 | NULL          |
|  55202072 | 9dc21769a8b305a9529da9270d7aa8eb     |   0.00000000 | NULL          |
|  55526754 | 79b3672f3c891bbd951a309f068f9be4     |   0.00000000 | NULL          |
|  57620834 | e1b8c1ffb440b6ad34e9548f64f99cb1     |   0.00000000 | NULL          |
|  57681634 | 5d85f9b4f05b635a4732cfe225417c44     |   0.00000000 | NULL          |
|  57766452 | 3f529085b83d4d139afea5480a80acb6     |   0.00000000 | NULL          |
|  61312672 | 9a7e4cfa45a83c078d2f0ed9d086d860     |   0.00000000 | NULL          |
|  64262078 | 6a97b284195efec5bd4ff8518ce1d7a5     |   0.00000000 | NULL          |
|  65299186 | 0633b2eba36672ddcddf7a403190b30c     |   0.00000000 | NULL          |
|  69384076 | 25e06b7fa4278bc456db416a653f397a     |   0.00000000 | NULL          |
|  71744194 | c2a11228fd84f61bd9f31486dca819e6     |   0.00000000 | NULL          |
|  72578870 | e92196d3a319090c1254fdeb47f5532a     |   0.00000000 | NULL          |
|  73308644 | b61c462d300e0bd4eac65f61eec3938c     |   0.00000000 | NULL          |
|  76463810 | 91711c0d596a96d158297db6e8b03afd     |   0.00000000 | NULL          |
|  77017610 | 7272156592851fbc78fa96a50b5720d1     |   0.00000000 | NULL          |
|  77021016 | abdbec4c70a6b106fd3a665e6807bc33     |   0.00000000 | NULL          |
|  78484126 | 8ba39109ec9ec97e1d0824a98c53d6f1     |   0.00000000 | NULL          |
|  81095096 | ab627199a4b8221d93632143d4401393     |   0.00000000 | NULL          |
|  88704542 | 0daf2b1fd57b92aaa23f1668465338da     |   1.68000007 | NULL          |
| 104891618 | 3e8f8c9c68231d48a66ad9a978e47e7d     |   0.00000000 | NULL          |
| 108267172 | e9cf845c799a8be328552954ca6e398a     |   0.00000000 | NULL          |
| 108267536 | _lo_0c87e29153230a06dd608328522af521 |   0.00000000 | NULL          |
+-----------+--------------------------------------+--------------+---------------+
31 rows in set (0.00 sec)



Both with "is not null" and "is null" and the results were 0 and 31,
respectively.

The reason for this is because of the merge function's call:

    function getPreviousCartID($customers_id) {
        $previous_sid_sql = " SELECT c.cart_id
                              FROM osc_cart_contents c, osc_cart si 
                              WHERE si.customers_id = " . (int)$customers_id . " 
                              AND si.cart_id = c.cart_id ";
        return DB::getVar($previous_sid_sql);
    }

If there are no rows in osc_cart_contents, this returns nothing.




#########################################################################
080509 Fri 09 May 2008 02:29:57 PM EDT

On a hunch I've duplicated the bug, or at least found another. Add to
cart while logged in, then go directly to login page and login again;
this results in losing your row from osc_cart.

I also found that the cart culling script is deleting legit carts. It
was operating on customers_id in both osc_cart_contents and
osc_cart_contents_attributes which are never set.

So I played with constraints for a little bit, and worked this out:

drop table if exists swain_child  ;
drop table if exists swain_parent ;


CREATE TABLE `swain_parent` (
  `albumitem_id` int unsigned NOT NULL auto_increment,
  `site_id`      int unsigned NOT NULL default 0,
  `parent_id`    int unsigned NOT NULL default 0,
  PRIMARY KEY  (`albumitem_id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

 CREATE TABLE `swain_child` (
  `albumitem_id` int unsigned NOT NULL default '0',
  `title`        varchar(50) default NULL,
  `owner_id`	 int unsigned NOT NULL default '0',

  PRIMARY KEY (`albumitem_id`),

  CONSTRAINT `mpa_albumitems_upd_1` FOREIGN KEY (`albumitem_id`) REFERENCES `swain_parent` (`albumitem_id`) ON UPDATE CASCADE ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

insert into swain_parent values(1,42, 12);
insert into swain_child values(1,'ima title', 12);


Here, the child table has both delete and update constraints and this
all works as one would think. I can update or delete the parent row
and the correct things happen in the child. This would solve the
problem with the culling script.

Hmm. This would be easy to test... dump the three cart tables, edit
them, reload them, run the store. I could drop extraneous columns
while I'm at it.



#########################################################################
080512 Mon 12 May 2008 06:08:21 PM EDT

Hmm. I think I need to clean up Jacob's object explosion in gifts
before I can do anything meaningful with it.




#########################################################################
080513 Tue 13 May 2008 03:32:20 PM EDT

Am working on shrinking the code base for products. This means
factoring out a lot of redundant code from Jacob's class hierarchy.

M-x c-set-style RET cc-mode RET fixes the borkage with braces.



#########################################################################
080514 Wed May 14 15:34:57 2008

find . -name \*.php -print0  | xargs -0 egrep '^class' | perl -nlaF'/\s/' -e 'print $F[1]'

Here, we use these Perl command line flags:

n: iterate over each line of input... if you use 'p' it prints the
line afterwards.

l: chomp the line; automatically print \n afterwards
a: autosplit the line
F'//': the pattern to autosplit on. Results go in @F.

With p, i.e. find . -name \*.php -print0  | xargs -0 egrep '^class' | perl -plaF'/\s/' -e 'print $F[1]'

we get:

Photo_MiniFootball
./classes.php:class Photo_MiniFootball extends Games_And_Puzzles {
Photo_Hockeypuck
./classes.php:class Photo_Hockeypuck extends Games_And_Puzzles {
Magnets
./classes.php:class Magnets extends Products {
Magnet_3x4
./classes.php:class Magnet_3x4 extends Magnets {
Magnet_25x35
./classes.php:class Magnet_25x35 extends Magnets {
Sporting
./classes.php:class Sporting extends Products {
All_products
./classes.php:class All_products {





#########################################################################
080515 Thu May 15 11:35:03 2008

Jacob's classes mix categories and products... it's too generalized,
perhaps. I do like that Jessy can just edit text files for groupings,
rather than it all being in the database and us having to write an
interface for her; or us writing patch files for her. But there's too
many classes maybe. Information is duplicated in the classes that's
already in the database. I'd have to move all the cropping information
into the db too.

It's as though you had a Java system where everything is just treated
as an Object. It would work, but it's cheating in a way.

Here's some incredibly bad programming on Jacob's part:

   579  jodonnell     function getProductDisplayName($product_name = '') {
   712  jodonnell         if ($product_name == '') { return; }
   579  jodonnell         $this->require_class($product_name);
   579  jodonnell         $Product_name = ucfirst($product_name);
   579  jodonnell         ob_start();
   579  jodonnell         eval("$Product_name::getProductDisplayName();");
   579  jodonnell         $name = ob_get_clean();
   712  jodonnell         if ( ! $name  && $this->product->desc) {
   712  jodonnell             return $this->product->desc;
   712  jodonnell         }
   579  jodonnell         return $name;
   579  jodonnell     }

The subclasses *echo* the name instead of returning it. Bleh. And
where $product->getProductDisplayName() is called on a subclass, it's
happenstance that it echoes it into the right place, probably.



#########################################################################
080519 Mon 19 May 2008 10:25:39 AM EDT

Out Friday after being punched in the face defending my cab driver.

I was working on abolishing the 170 classes that make up the Product
classes Jacob created. I ported the data in to the DB and found that
there's a few exceptions to the rule:

Fatal error: Call to a member function getProductChildren() on a
non-object in
/d0/home/swain/public_html/projects/ampiradev/gallery/gifts/classes/product.class.php
on line 122

This means not every class that has-a PhysicalProductDetails (formerly
PhysicalProduct) is the same.. or else this class has something it
doesn't need?

Why do all "sellable" products have to be in category 1? It's because
that's how we select individual products when we join on the
products_to_categories table. If a product belongs to two or more
categories, then there are duplicates in the count:

with categories_id = 1
mysql>  SELECT 
               c.products_id AS id,
               pd.products_name,
               SUM(c.price_set * c.customers_basket_quantity ) AS subttl,
               c.price_set_comment AS discount,
               SUM(c.customers_basket_quantity) AS count,
               pc.categories_id

        FROM  osc_cart_contents  c, osc_products p, osc_products_to_categories pc, osc_products_description pd
        WHERE c.cart_id = 7702
        and p.products_id  = c.products_id 
        and pd.products_id = c.products_id 
        and pc.products_id = c.products_id 

        AND pc.categories_id = 1
        GROUP BY id, discount 
        ORDER BY categories_id;

+------+---------------------+---------+---------------+-------+---------------+
| id   | products_name       | subttl  | discount      | count | categories_id |
+------+---------------------+---------+---------------+-------+---------------+
| 7008 | 4X6                 |  0.4800 | Club Discount |     4 |             1 | 
| 7102 | Mouse Pad           |  9.9900 |               |     1 |             1 | 
| 7111 | Coasters (Set of 4) | 19.9900 |               |     1 |             1 | 
+------+---------------------+---------+---------------+-------+---------------+
3 rows in set (0.00 sec)



without categories_id = 1
mysql>  SELECT 
               c.products_id AS id,
               pd.products_name,
               SUM(c.price_set * c.customers_basket_quantity ) AS subttl,
               c.price_set_comment AS discount,
               SUM(c.customers_basket_quantity) AS count,
               pc.categories_id

        FROM  osc_cart_contents  c, osc_products p, osc_products_to_categories pc, osc_products_description pd
        WHERE c.cart_id = 7702
        and p.products_id  = c.products_id 
        and pd.products_id = c.products_id 
        and pc.products_id = c.products_id 


        GROUP BY id, discount 
        ORDER BY categories_id;

+------+---------------------+---------+---------------+-------+---------------+
| id   | products_name       | subttl  | discount      | count | categories_id |
+------+---------------------+---------+---------------+-------+---------------+
| 7008 | 4X6                 |  0.9600 | Club Discount |     8 |             1 | 
| 7111 | Coasters (Set of 4) | 39.9800 |               |     2 |             1 | 
| 7102 | Mouse Pad           | 19.9800 |               |     2 |             1 | 
+------+---------------------+---------+---------------+-------+---------------+
3 rows in set (0.00 sec)


so the problem, really, is to come up with a better sql statement. In
fact we don't seem to need the category at all:

 mysql>  SELECT 
               c.products_id AS id,
               pd.products_name,
               SUM(c.price_set * c.customers_basket_quantity ) AS subttl,
               c.price_set_comment AS discount,
               SUM(c.customers_basket_quantity) AS count
        FROM  osc_cart_contents  c, osc_products p, osc_products_description pd
        WHERE c.cart_id = 7702
        and p.products_id  = c.products_id 
        and pd.products_id = c.products_id 
        GROUP BY id, discount 
;
+------+---------------------+---------+---------------+-------+
| id   | products_name       | subttl  | discount      | count |
+------+---------------------+---------+---------------+-------+
| 7008 | 4X6                 |  0.4800 | Club Discount |     4 | 
| 7102 | Mouse Pad           |  9.9900 |               |     1 | 
| 7111 | Coasters (Set of 4) | 19.9900 |               |     1 | 
+------+---------------------+---------+---------------+-------+
3 rows in set (0.00 sec)


The issue here, if it is one, is that we don't have a way to order the
products in the summary. I think at the moment we're not controlling
it anyway, so it seems like no loss.

Since ordinality (cardinality?) is desirable for the Products classes
in mpa_products, perhaps the two can overlap.

Seems to work:



      SELECT 
               c.products_id AS id,
               pd.products_name,
               SUM(c.price_set * c.customers_basket_quantity ) AS subttl,
               c.price_set_comment AS discount,
               SUM(c.customers_basket_quantity) AS count,
               pc.categories_id

        FROM  osc_cart_contents  c
        INNER JOIN osc_products p                ON p.products_id  = c.products_id 
        INNER JOIN osc_products_description pd   ON pd.products_id = c.products_id 
        INNER JOIN osc_products_to_categories pc ON pc.products_id = c.products_id 

        WHERE c.cart_id = 7702
        AND pc.categories_id = 1
        GROUP BY id, discount 
        ORDER BY categories_id;
+------+-----------------------------------------------------------+---------+---------------+-------+---------------+
| id   | products_name                                             | subttl  | discount      | count | categories_id |
+------+-----------------------------------------------------------+---------+---------------+-------+---------------+
| 1281 | Baby Onesie - 12 mo                                       | 39.9800 |               |     2 |             1 | 
| 148  | Club                                                      | 20.0000 |               |     1 |             1 | 
| 2000 | Key to the Attic                                          |  9.9500 |               |     1 |             1 | 
| 4015 | Tuscany 16x20 florentine <br>silver frame for 11x14 photo | 47.9800 |               |     2 |             1 | 
| 7008 | 4X6                                                       |  0.4800 | Club Discount |     4 |             1 | 
| 7060 | Large Poster - 16x20                                      | 47.9700 |               |     3 |             1 | 
| 7102 | Mouse Pad                                                 |  9.9900 |               |     1 |             1 | 
| 7111 | Coasters (Set of 4)                                       | 19.9900 |               |     1 |             1 | 
+------+-----------------------------------------------------------+---------+---------------+-------+---------------+
8 rows in set (0.00 sec)


mysql>         SELECT 
               c.products_id AS id,
               pd.products_name,
               SUM(c.price_set * c.customers_basket_quantity ) AS subttl,
               c.price_set_comment AS discount,
               SUM(c.customers_basket_quantity) AS count
        FROM  osc_cart_contents  c
        INNER JOIN osc_products p                ON p.products_id  = c.products_id 
        INNER JOIN osc_products_description pd   ON pd.products_id = c.products_id 
        WHERE c.cart_id = 7702
        GROUP BY id, discount 
;
+------+-----------------------------------------------------------+---------+---------------+-------+
| id   | products_name                                             | subttl  | discount      | count |
+------+-----------------------------------------------------------+---------+---------------+-------+
| 1281 | Baby Onesie - 12 mo                                       | 39.9800 |               |     2 | 
| 148  | Club                                                      | 20.0000 |               |     1 | 
| 2000 | Key to the Attic                                          |  9.9500 |               |     1 | 
| 4015 | Tuscany 16x20 florentine <br>silver frame for 11x14 photo | 47.9800 |               |     2 | 
| 7008 | 4X6                                                       |  0.4800 | Club Discount |     4 | 
| 7060 | Large Poster - 16x20                                      | 47.9700 |               |     3 | 
| 7102 | Mouse Pad                                                 |  9.9900 |               |     1 | 
| 7111 | Coasters (Set of 4)                                       | 19.9900 |               |     1 | 
+------+-----------------------------------------------------------+---------+---------------+-------+
8 rows in set (0.00 sec)

Ditto for the query used in the Order class:

  
mysql>             SELECT 
               p.orders_products_id,
               p.products_id,
               p.products_model,
               p.products_name,  
               p.products_price,       
               p.final_price,  
               p.products_tax,       
               p.products_quantity     as quantity
            FROM osc_orders_products p,
                 osc_products_to_categories pc
            WHERE orders_id = 21676
            AND pc.categories_id = 1
            AND p.products_id = pc.products_id
            
;
+--------------------+-------------+----------------+-----------------------------------------------------------+----------------+-------------+--------------+----------+
| orders_products_id | products_id | products_model | products_name                                             | products_price | final_price | products_tax | quantity |
+--------------------+-------------+----------------+-----------------------------------------------------------+----------------+-------------+--------------+----------+
|              17840 |        1281 | Baby Onesie    | Baby Onesie - 12 mo                                       |        39.9800 |     39.9800 |       0.0000 |        2 | 
|              17841 |         148 | Club           | Club                                                      |        20.0000 |     20.0000 |       0.0000 |        1 | 
|              17842 |        2000 | Key to the A   | Key to the Attic                                          |         9.9500 |      9.9500 |       0.0000 |        1 | 
|              17843 |        4015 | Tuscany 16x2   | Tuscany 16x20 florentine <br>silver frame for 11x14 photo |        47.9800 |     47.9800 |       0.0000 |        2 | 
|              17844 |        7008 | 4X6            | 4X6                                                       |         0.1200 |      0.1200 |       0.0000 |        1 | 
|              17845 |        7008 | 4X6            | 4X6                                                       |         0.1200 |      0.1200 |       0.0000 |        1 | 
|              17846 |        7008 | 4X6            | 4X6                                                       |         0.1200 |      0.1200 |       0.0000 |        1 | 
|              17847 |        7008 | 4X6            | 4X6                                                       |         0.1200 |      0.1200 |       0.0000 |        1 | 
|              17848 |        7060 | Large Poster   | Large Poster - 16x20                                      |        47.9700 |     47.9700 |       0.0000 |        3 | 
|              17849 |        7102 | Mouse Pad      | Mouse Pad                                                 |         9.9900 |      9.9900 |       0.0000 |        1 | 
|              17850 |        7111 | Coasters (Se   | Coasters (Set of 4)                                       |        19.9900 |     19.9900 |       0.0000 |        1 | 
+--------------------+-------------+----------------+-----------------------------------------------------------+----------------+-------------+--------------+----------+
11 rows in set (0.00 sec)

mysql>             SELECT 
               p.orders_products_id,
               p.products_id,
               p.products_model,
               p.products_name,  
               p.products_price,       
               p.final_price,  
               p.products_tax,       
               p.products_quantity     as quantity
            FROM osc_orders_products p
             WHERE orders_id = 21676
 
            
;
+--------------------+-------------+----------------+-----------------------------------------------------------+----------------+-------------+--------------+----------+
| orders_products_id | products_id | products_model | products_name                                             | products_price | final_price | products_tax | quantity |
+--------------------+-------------+----------------+-----------------------------------------------------------+----------------+-------------+--------------+----------+
|              17840 |        1281 | Baby Onesie    | Baby Onesie - 12 mo                                       |        39.9800 |     39.9800 |       0.0000 |        2 | 
|              17841 |         148 | Club           | Club                                                      |        20.0000 |     20.0000 |       0.0000 |        1 | 
|              17842 |        2000 | Key to the A   | Key to the Attic                                          |         9.9500 |      9.9500 |       0.0000 |        1 | 
|              17843 |        4015 | Tuscany 16x2   | Tuscany 16x20 florentine <br>silver frame for 11x14 photo |        47.9800 |     47.9800 |       0.0000 |        2 | 
|              17844 |        7008 | 4X6            | 4X6                                                       |         0.1200 |      0.1200 |       0.0000 |        1 | 
|              17845 |        7008 | 4X6            | 4X6                                                       |         0.1200 |      0.1200 |       0.0000 |        1 | 
|              17846 |        7008 | 4X6            | 4X6                                                       |         0.1200 |      0.1200 |       0.0000 |        1 | 
|              17847 |        7008 | 4X6            | 4X6                                                       |         0.1200 |      0.1200 |       0.0000 |        1 | 
|              17848 |        7060 | Large Poster   | Large Poster - 16x20                                      |        47.9700 |     47.9700 |       0.0000 |        3 | 
|              17849 |        7102 | Mouse Pad      | Mouse Pad                                                 |         9.9900 |      9.9900 |       0.0000 |        1 | 
|              17850 |        7111 | Coasters (Se   | Coasters (Set of 4)                                       |        19.9900 |     19.9900 |       0.0000 |        1 | 
+--------------------+-------------+----------------+-----------------------------------------------------------+----------------+-------------+--------------+----------+
11 rows in set (0.00 sec)

mysql> 



So this paves the way to use osc_products_to_categories. I need to
update two queries to not join on osc_products_to_categories anymore,
delete all categories_id=1 from that table, and start creating new
categories based on the product hierarchy in mpa_products.



#########################################################################
080528 Wed 28 May 2008 09:52:15 AM EDT

Back from vacation.

Just changed two queries and deleted all category 1 entries in
osc_products_to_categories.



#########################################################################
080529 Thu 29 May 2008 11:50:53 AM EDT

Chris in ... Pennsicola or something today. I need his USB cable for
my camera because I took a way cool picture of Jeanne in her
sunglasses at RRW last night.

Been picking at the ProductTemplate subclasses in gifts. I'm kinda
hung up on the decision to use osc_categories and brethren for these
classifications, versus having mpa_% tables to do it. On the one hand,
osc_categories should work because the structure is there and I tossed
out the category 1 nonsense yesterday... but... this is a Gallery
specific thing, so having the info in separate tables also makes
sense. There's also display data in the classes:

attribute: product -> 
attribute: header -> occs/header.jpg
attribute: title -> 
attribute: product_picture -> 
attribute: product_text -> 
attribute: next_page -> 
attribute: images -> 
attribute: cropping_coords -> 
attribute: price -> 
attribute: children_list -> Array
attribute: desc -> Main Products

And then Frames, the parent class, mucks things up somewhat. Real life
is like that: it doesn't always map to a class hierarchy.

Hrmm. My copy of "Encouters with the Archdruid" is missing.



#########################################################################
080602 Mon 02 Jun 2008 11:18:18 AM EDT

Whipped up a quickie page to preview the card images Chris is
generating:

<?php

$dir = "/opt/mpa/custom-sites/jhanley/ampiradev/gallery/cards";
$files = array();

// Open a known directory, and proceed to read its contents
if (is_dir($dir)) {
    if ($dh = opendir($dir)) {
        while (($file = readdir($dh)) !== false) {
            if ( preg_match('/jpg$/', $file) )
                $files[] = $file;
        }
        closedir($dh);
    }
 }

sort($files);


if (isset($_REQUEST['index'])) {
    if ( ! isset($files[ $_REQUEST['index']] ) ) die("no such index {$_REQUEST[index]}");
    $imagename = $files[ $_REQUEST['index']];
    $index = $_REQUEST['index'];
    $next  = $index + 1;
    $prev  = $index - 1;
    if ( (count($files) - 1) < $next) $next = count($files) - 1;
    if ( $prev < 0 ) $prev = 0;
 } else {
    for ($x = 0; $x < count($files); $x++) {
        echo "$x: <a href=\"transverse.php?index=$x\">$files[$x]</a><br>\n";
    }
    exit(0);
 }


if (isset($_REQUEST['mail'])) {
    // email the message to whomever
    $message = "Problem with $imagename:\n{$_REQUEST[problem]}";
    $message = wordwrap($message, 70);
    $message .= "\n\nform: http://swainhome.myphotodevel.com/transverse.php?index=$index";
    $message .= "\n\nimage: http://whoozie.myphotodevel.com/cards/$imagename";
    mail('swain@myphotoalbum.com,chris@corp.fortunecity.com,jessy@myphotoalbum.com,fmarte@corp.fortunecity.com', "Error in card $imagename", $message);

    echo "<font color=red><h1>Message sent.</h1></font>\n";    
} 



// sample image url:
// http://whoozie.myphotodevel.com/cards/Baby_5_Boy_Dots_H.jpg
?>

<a href="transverse.php?index=<?php echo $prev; ?>">prev</a> |
<a href="transverse.php?index=<?php echo $next ?>">next</a> |
<a href="transverse.php">index</a>
<h3><?php echo $imagename; ?></h3><br>
<a href="#report">report error</a><p>
<img src="http://whoozie.myphotodevel.com/cards/<?php echo $imagename; ?>">
<p>
<hr>
<p>

<a name="report">Explain the problem with this card:</a>

<form action="transverse.php" method="POST">

<input type="hidden" name="index" value="<?php echo $index; ?>">
<input type="hidden" name="mail" value="true">

<textarea name="problem" cols="50" rows="10">
</textarea>

<input type="submit">

</form>




#########################################################################
080603 Tue 03 Jun 2008 01:48:48 PM EDT

Solved the bug with the shortform that was so vexing me
yesterday... last night I realized I could use staging in simple ways
to narrow down where the problem was, without stepping through the
hideous mess that is the configuration management.

I commented out the old $gallery->app variables, so Gallery used the
new constants. No difference. I switched staging to use my personal
build and the bug showed up. So that eliminated any system config
issue.

And then I noticed that there was an error coming from the shortform
itself: couldn't load a class. The page was not loading completely,
but this was not visible. It was trying to load a class I think I
deleted from subversion. I commented out the require() and lo, the
thing worked again.

I'm now working on making the gifts run separate from Gallery, and
it's proceding apace.



#########################################################################
080605 Thu 05 Jun 2008 12:22:50 PM EDT

Am working on another idea: moving all images out of Gallery and into
a gallery-static project. So far so good. I deleted all jpg, gif and
png files after craeating a new virtual server, swainstatic, which
points at the untarred hierarchy of images.



#########################################################################
080606 Fri 06 Jun 2008 02:40:12 PM EDT

I cooked up a new tool to help find where missing image calls were
coming from. First, I came across a PHP function,
get_included_files(), which returns an array of all included/required
files. I wrote something for my register_shutdown_function. Here's the
code:

function exit_notice() { 
    // using ~swain/svn/pgms/perl/searchem.pl, i can find any missing files in error_log. --sw
    $fp = fopen("/home/swain/tmp/www/included_files", "w");
    if (!$fp) die("Can't write swain's included files list!");
    foreach (get_included_files() as $file)
        fwrite($fp, "$file\n");
    fclose($fp);
}
register_shutdown_function( 'exit_notice' );

Now there's a file after each pageview in my home dir. Parsing it is
as simple as a perl script:

#!/usr/bin/perl

use strict;
use warnings;

open INCLUDED_FILE_LIST, "< /home/swain/tmp/www/included_files" or die $!;

while (my $file = <INCLUDED_FILE_LIST>) {
    chomp $file;
    $file =~ s/^included: //;
    print `grep --with-filename --line-number $ARGV[0] $file`;
}



Output looks like this:

swain@torque:~/svn/pgms/perl$ ./searchem.pl spacer.gif
/d0/home/swain/public_html/projects/gifts/products.php:403:                echo "<img src='" . STATIC_SERVER . "/images/spacer.gif' width='175' height='155' alt='{$prod_name}' border='0'></a>";
/d0/home/swain/public_html/projects/gifts/products.php:433:                echo "<img src='" . STATIC_SERVER . "/images/spacer.gif' width='175' height='155' alt='{$prod_name}' border='0'></a>";
/d0/home/swain/public_html/projects/gifts/products.php:445:                echo "<img src='" . STATIC_SERVER . "/images/spacer.gif' width='175' height='175' alt='{$prod_name}' border='0'></a>";
/d0/home/swain/public_html/projects/gifts/products.php:452:                echo "<img src='" . STATIC_SERVER . "/images/spacer.gif' width='175' height='155' alt='{$prod_name}' border='0'></a>";
/d0/home/swain/public_html/projects/ampiradev/gallery/util.php:1996:            . "\n\t<td><img src=\"". STATIC_SERVER . "images/spacer.gif\" border=\"0\""
/d0/home/swain/public_html/projects/gifts/products_html.php:7:        <Td class=barbg2 width=50%>' . STATIC_SERVER . '<img src="/images/spacer.gif" width="4" height="20" alt="" border="0"></TD>
/d0/home/swain/public_html/projects/gifts/products_html.php:17:        <Td class=barbg2 width=50%><img src="' . STATIC_SERVER . '/images/spacer.gif" width="4" height="8" alt="" border="0"></TD>
/d0/home/swain/public_html/projects/gifts/html_wrap/gifts.header:31:	<td class="headerbg" height=100%><img src="<?php echo  STATIC_SERVER ?>/images/spacer.gif" width="1" height="1" alt="" border="0"></td>
/d0/home/swain/public_html/projects/gifts/html_wrap/gifts.header:112:	<td class=headerbg height=100%><img src="/images/spacer.gif" width="1" height="1" alt="" border="0"></td>
/d0/home/swain/public_html/projects/gifts/html_wrap/gifts.footer:18:		<td class="footerbg"><img src="<?php echo  STATIC_SERVER ?>/images/spacer.gif" width="6" height="100" alt="" border="0"></td>
/d0/home/swain/public_html/projects/gifts/html_wrap/gifts.footer:61:		<td class="footerbg"><img src="<?php echo  STATIC_SERVER ?>/images/spacer.gif" width="6" height="100" alt="" border="0"></td>


With that I hunted down the remaining missing image calls from
Apache's error_log. Well, it's not 100% but nearly so. Jessy and Dylan
are redesigning it, so my work on products.php was probably wasted.

Yesterday I broke out all image, css and js files from Gallery into a
new project, mpa_static. It just made it easier to share files that
way between gifts and gallery. Here's the before and after, once I
removed all static content from the gifts project:

1.6G	gifts
112M	gifts

Gallery is now only 40MB. mpa_static is 1.7GB.

There was an extremely weird bug I encountered: the session database
connection handle going out of scope. This happened when the gifts
stub files looked like this:

<?php

  /**
   * Gifts are in their own Subversion project. This stub file loads
   * it from the correct location specified by the conf variable
   * $GIFTS_BASEDIR.
   */

require_once('/opt/mpa/conf/gallery.conf');
require("{$GALLERY_BASEDIR}/inc/function/get_all_gallery_items.inc");
require("{$GIFTS_BASEDIR}books/book_explain.php");

?>

Changing it to this solves the problem:

<?php

  /**
   * Gifts are in their own Subversion project. This stub file loads
   * it from the correct location specified by the conf variable
   * $GIFTS_BASEDIR.
   */

require_once('/opt/mpa/conf/gallery.conf');
require("{$GIFTS_BASEDIR}books/book_explain.php");

?>


That is, eliminating that one line. This bug manifested itself in the
Apache error log like so:

using pingDb...
[Fri Jun 06 15:28:36 2008] [error] [client 10.1.1.209] PHP Warning:  mysql_ping() expects parameter 1 to be resource, null given in /opt/mpa/lib/mysql_sessions.inc on line 237, referer: http://swain.myphotodevel.com/gifts/products.php
MPA MYSQL SESSIONS DB ERROR: [Fri, 06 Jun 2008 15:28:36 -0400] mysql error number: '' : mysql error msg: '' message I (showerror) was passed: 'mysql ping failed.' On: swain.myphotodevel.com /gifts/books/book_explain.php

Stack trace:
#0  mpaGetFullDump() called at [/opt/mpa/lib/mysql_sessions.inc:265]
#1  showerror(mysql ping failed.) called at [/opt/mpa/lib/mysql_sessions.inc:239]
#2  pingDb() called at [/opt/mpa/lib/mysql_sessions.inc:114]
[stuff deleted]




#########################################################################
080617 Tue 17 Jun 2008 12:07:38 PM EDT

Switching to the white keyboard; the Pro is too arthritic. The keys
jam on the way down.

grant select,insert,update,delete on mpa.mpa_products_groupings   to 'phpmyadmin'@'10.1.1.190' identified by 'shoesoff';
grant select,insert,update,delete on mpa.osc_products_properties  to 'phpmyadmin'@'10.1.1.190' identified by 'shoesoff';
grant select,insert,update,delete on mpa.osc_products_description to 'phpmyadmin'@'10.1.1.190' identified by 'shoesoff';
grant select,insert,update,delete on mpa.osc_products             to 'phpmyadmin'@'10.1.1.190' identified by 'shoesoff';





#########################################################################
080619 Thu 19 Jun 2008 10:15:15 AM EDT

From a previous entry: here's how to calculate "as the crow flies"
distances with the Google Maps API:

swain$ script/console
Loading swain environment.
>> include GeoKit::Geocoders
=> Object
>> from = MultiGeocoder.geocode('322 8th Ave, New York NY 10001')
=> #<GeoKit::GeoLoc:0xb75bb2fc @zip="10001", @state="NY", @precision="unknown", @success=true, 
@lng=-73.997206, @city="New York", @country_code="US", @lat=40.747449, @street_address="322 8th 
Ave">
>> dest = MultiGeocoder.geocode('34-38 75th St, Jackson Heights, NY 11372')
=> #<GeoKit::GeoLoc:0xb7555114 @zip="11372", @state="NY", @precision="unknown", @success=true, 
@lng=-73.891407, @city="New York", @country_code="US", @lat=40.752292, @street_address="3438 75th 
St">
>> Location.distance_between(from, dest)
=> 5.55412844927348
>>

and 

>> class Location
>> include GeoKit::Mappable
>> end
=> Location


Thought: the call to Location.distance_between returns instantly. This
would suggest to me that the distance calculation is done locally
without a network call; and I can see where once you have
longitude/latitude, you have all you need to calculate distance.




#########################################################################
080620 Fri 20 Jun 2008 05:05:29 PM EDT

New delete statements for clearing out old carts.

delete osc_cart from osc_cart left outer join osc_cart_contents on
osc_cart.cart_id = osc_cart_contents.cart_id where
osc_cart_contents.cart_contents_id is null;

delete osc_cart_contents_attributes from osc_cart_contents_attributes
left outer join osc_cart on osc_cart_contents_attributes.sess_key =
osc_cart.sess_key where osc_cart.sess_key is null;

delete osc_cart_contents from osc_cart_contents left outer join
osc_cart on osc_cart_contents.cart_id = osc_cart.cart_id where
osc_cart.cart_id is null;


These don't constrain to last_accessed though. But doing a left outer
join in a delete was the trick solved here.



#########################################################################
080623 Mon 23 Jun 2008 11:32:23 AM EDT

Chris off to a bad start. I'm having him fix mysql on staging, which I
hosed while developing the delete routines I wrote for the cart.

I think going with PATH_INFO the same way I did for the crack pages
will resolve the subdir issue... that is, gifts wants to access
everything from the top level, but gallery wants to access everything
from gifts/. I just toyed with PATH_INFO and $_GET:

<?php

print "Hello, sailor!";
print "<p>";
print "Path info: $_SERVER[PATH_INFO]";
print "<p>";
print "Query string: $_SERVER[QUERY_STRING]<hr>";
foreach ($_GET as $key => $val) {
    print "$key => $val<br>\n";
}
?>

with predictable results:

http://crack.myphotodevel.com/delme.php/this/is/a/path?i=am&get=data


Hello, sailor!

Path info: /this/is/a/path

Query string: i=am&get=data
i => am
get => data


So I can use a Front Controller, maybe even products.php, to include
the right file. This will get rid of nearly everything in gifts/ (all
the stub files, that is) as well, or else I can just leave them there.

swain@torque:~/public_html/projects/mpa_gallery/gifts$ find . -type f | grep -v svn
./folded_cards/add_message.php
./folded_cards/quantity.php
./folded_cards/pick_border.php
./folded_cards/pick_border_preview.php
./folded_cards/temp_inside_card_picture.php
./cards/gc_add_frame.php
./cards/gc_quantities.php
./cards/gc_add_message.php
./cards/select_photo.php
./books/book_explain.php
./books/book_create.php
./crop_picture.php
./quantity.php
./products.php
./select_photo.php
./select_frame.php


I would shorten them to:
/fc/add_message
/fc/quantity
/c/add_frame
/c/select_photo
/b/book_explain
/b/book_create
/crop_picture
/select_frame

and so on. I also realized on Friday my first focus should be getting
single image products working, since cards books and calendars are all
up in the air.

Perhaps for uniformity I'd use 't' for top level. Instead of:

/crop_picture
/select_frame

I'd use:

/t/crop_picture
/t/select_frame

That would just make parsing the PATH_INFO easier.



#########################################################################
080624 Tue 24 Jun 2008 10:18:57 AM EDT

Yesterday, spent considerable time debugging staging's
configuration. Turns out we need a store rollout as well, what with
the patches from 435 onwards.

Fixed whoozie's store configuration. Emailed technology asking to test
staging.

b06c18d4194229a0a8c42fd3e679251d  2008-06-23  10:17:18 :: WARNING: missing file: /mnt/slow/vol01/t/tw/twi/twin/twinc/twincityroyals/albums/album02/half.jpg

Lots of these from Saturday until yesterday. Chris had a bug in his
spreading stuff; he has symlinks whose names no longer match the
'slow' volumes they point to... so about eight customer's orders were
unable to be purchased, 137 signups failed, and maybe a couple other
things. Chris sent out an email about it. It went undetected until I
asked Fernando about it on Monday morning; I should have done
something Sunday when I saw it.




#########################################################################
080625 Wed 25 Jun 2008 04:50:36 PM EDT

There are product categories and meta categories. Mugs, mousepads,
tshirts, and ornaments are product categories. Spring, Father's Day,
"For Her," and so on are meta categories. Or nonphysical categories if
you prefer.




#########################################################################
080627 Fri 27 Jun 2008 11:39:34 AM EDT

Chris Allaire. Recruiter. New York Magazine.


Wainstead \ [to scott]: db2 doensn't support LIMIT either, iirc
You say, "dow's rallying"
You say, "bargain hunters probably"
Wainstead \ | db2 "select * from blah fetch first 10 rows only"
You say, "though i tended to:"
Wainstead \ | db2 "select * from blah" | head -10



#########################################################################
080630 Mon 30 Jun 2008 12:57:44 PM EDT

New rollout was completed Friday night around 8pm. There were a lot of
last minute issues, like the ACSCAN site not working. There's a lot of
relative image URLs in the CSS still. Books/calendars were broken on
Saturday morning; Chris fixed them that afternoon. Crack pages were
broken.




#########################################################################
080701 Tue 01 Jul 2008 02:22:46 PM EDT

After a long detour today into Veracity land, I'm done. Chris is
moving Plookfish to /opt/mpa_gallery/current, like everywhere else. I
had to rejigger regenerate-feeds.php to match. Ran into some issues
with init.php being loaded twice due to gallery.conf being loaded more
than once, resulting in $GALLERY_BASEDIR being redefined and init.php
being loaded again from a different place, resulting in a fatal error
when an attempt was made to redefine stderr(). So all that sorted out,
and it won't work on production because Chris still hasn't moved
plookfish, it seems.

We did a standup meeting today for the first time in ages. Got into a
tiff with Hanley who thought I was making a personal attack on her
when I pleaded for the extermination of spacer.gif. YOU ARE NOT YOUR
CODE, I should have thought to told her.




#########################################################################
080702 Wed Jul  2 13:28:47 2008

Solved the bug with frames: had a stupid bug in preg_match. Duh.

Wrote a cron job to mail the ChangeLog for four projects out of SVN.

Been researching sessions in Gallery and the Cart. Gallery has a lot
of pre-php4 cruft still. I commented session.php. The store has a
wonky setup of: one cookie for the cart, another for the session. The
cart can outlast the session; being logged in or out is a session
thing.





#########################################################################
080708 Tue 08 Jul 2008 11:31:30 AM EDT

Hubris.

I made many large changes to Gifts and Gallery, and lo, nothing
worked. I should have used stepwise refinement.

Worked on the damn SVN report script again. I think it will do the
right thing now.

The really nice thing about moving all the static content out, and
separating gifts and gallery, is the projects are so lightweight now I
can easily check out multiple copies.

It seems PHP casting circumvents SQL injection attacks:

#!/opt/php5/bin/php
<?php

$x = "'; delete * from tablename; '42";
print "hello, sailor! " . (int)$x . "\n";

?>

Output:

hello, sailor! 0




#########################################################################
080710 Thu 10 Jul 2008 10:49:18 AM EDT

Yesterday: endless interruptions and distractions.

Setting include path:

set_include_path(
	$_SERVER['DOCUMENT_ROOT'].'/ecard' 
	. PATH_SEPARATOR . $_SERVER['DOCUMENT_ROOT'].'/ajax/itreelib' 
	. PATH_SEPARATOR . get_include_path()
);

I'm going take the plunge here and start using the include path
more. I'm working on an interface which is defined in /opt/mpa/lib; I
want to use my local copy so I'll set it in the conditionals in
gallery.conf.

So: contexts are off and running. I just committed to the two new
branches the code that routes the user to either upload or select
photo.

Took a long detour into looking at the SWF Upload thing Chris and
Fernando are working on... handheld Fcat until he got the debugger
version of the player installed; found out how the swfupload app is
built (open source Windows app)... it's all there. Chris was just
spouting off to Peter how great the iPhone app store is, and how we
could have an app in a week for it.

After another long detour into how images are processed by Gallery:

1) Most of the action still takes place in util.php. The only barrier
there is the use of global $gallery, maybe. (This can be parameterized
however).

2) I should focus on factoring out the $gallery stuff in the rest of
gifts and isolating the $file in a new class. Get gifts to work end to
end first with Gallery, then build out upload_photo.php.

---

OK, branches merged in to trunk, everything good. I got Gallery out of
quantity.php! We can probably do single photo gifts in a few more
days.




#########################################################################
080714 Mon 14 Jul 2008 11:41:11 AM EDT

AIM IM with chrisatfcity.
10:26 AM
chrisatfcity: I need you to disable downloads immediately for all users on fast02
chrisatfcity: uploads
Steve Wainstead: ok
chrisatfcity: we have something filling up space on here... and i need to find it
chrisatfcity: its at 100% again with NO available space.
Steve Wainstead: did you have a look at the opp servers?
Steve Wainstead: i think we just re-enabled something with movies? or i heard wrong
chrisatfcity: Doesn't matter that all occurs on the slow volumes
chrisatfcity: wtf is this
chrisatfcity: /opt/video/bin/mencoder /mnt/fast/vol01/l/lo/lor/lori/lorin/lorintim/videoTmp/01325c5c63426791d336ba96fc0df990 -ofps 25 -o /mnt/fast/vol01/l/lo/lor/lori/lorin/lorintim/videoTmp/01325c5c634267
chrisatfcity: goddamnit
chrisatfcity: video processing?? on fast..
chrisatfcity: argh'
Steve Wainstead: i take that to be a rhetorical question :)
chrisatfcity: goddamnit
10:30 AM
Steve Wainstead: i'll need a list of users who are on fast02
Steve Wainstead: we disable uploadingfor them by not letting them login
chrisatfcity: we'll get you the 3 letters.
chrisatfcity: It'll take to long to scan the directories.
chrisatfcity: And besides im doing that already looking for space.
10:35 AM
chrisatfcity: mike should be getting it to you any second now.
Steve Wainstead: ok
Steve Wainstead: turning it on will require pushing the gallery.conf to all the servers, i believe
Steve Wainstead: also
chrisatfcity: not a problem
Steve Wainstead: /opt/mpa/conf/out-of-service.php
chrisatfcity: not gallery.conf tho?
Steve Wainstead: when i've cooked it up
chrisatfcity: yea that
Steve Wainstead: yes
chrisatfcity: oh and enable it in conf yea
Steve Wainstead: gallery.conf too has to be pushed
10:45 AM
Steve Wainstead: ok emailed the php file to you
Steve Wainstead: push that to /opt/mpa/conf/
chrisatfcity: just put it in conf
chrisatfcity: its easuer
chrisatfcity: easier\
10:50 AM
Steve Wainstead: and set SERVICE_OUTAGE to true
chrisatfcity: in the central conf
Steve Wainstead: i already ssnt it though
chrisatfcity: doesn't help mke
chrisatfcity: now i have to scp to bastion then to mdb thencopy it in place
chrisatfcity: sheesh
Steve Wainstead: well i have to do the same thing ???
chrisatfcity: well you were making the list i figured you
chrisatfcity: 'd be making it on mdb-2
chrisatfcity: and dropping it in the centralized conf
Steve Wainstead: not when he emails me the list :)
Steve Wainstead: i just made it locally
chrisatfcity: cut and paste is amazing
chrisatfcity: how?
chrisatfcity: you don't have a local DB
Steve Wainstead: mdb2 good?
chrisatfcity: im doing it
Steve Wainstead: ok
10:55 AM
Steve Wainstead: 4,316 uploads from 730 to 845
Steve Wainstead: working on checking the files now
11:05 AM
Steve Wainstead: 116 users affected
chrisatfcity: lovely
11:10 AM
chrisatfcity: how many users are going to be affected when i enable the outofservice?
chrisatfcity: shit shit shit... this doesn't disable signups.
chrisatfcity: fucker
11:15 AM
chrisatfcity: what's the difference between this
chrisatfcity: // selective service outages. At the moment you must define an
// associative array element in out-of-service.php. Set to true to
// activate service outages.
define('SERVICE_OUTAGE', true);
chrisatfcity: and this
chrisatfcity: // don't let users log in who are listed in out-of-service.php
define('PARTIAL_DISABLED_LOGINS', false);
Steve Wainstead: the latter takes full usernames
Steve Wainstead: the former just three letter codes
Steve Wainstead: yes the former is going to lock out a lot of unaffected users
Steve Wainstead: you are the sole designer of all these outage types
Steve Wainstead: i have only ever coded what you've asked for
chrisatfcity: You are the implenter
chrisatfcity: implementer
Steve Wainstead: and we go through this whith every emergency
chrisatfcity: and it sucks
Steve Wainstead: you can't shut things off the way you want and you blame me
chrisatfcity: we need a better method
Steve Wainstead: yes, you say that too
chrisatfcity: I can't shut shit off
Steve Wainstead: and you vow to set a meeting
chrisatfcity: everything is disjointed.
Steve Wainstead: and flesh out the emergencies we need to meet
Steve Wainstead: and you never do
chrisatfcity: Because we NEVER have time.
chrisatfcity: always something more important
Steve Wainstead: you have plenty of time to surf reddit and set up your iphone on company time. and yes, i know, "fuck you steve"
chrisatfcity: Exactly
Steve Wainstead: all production sites are whitescreening at the moment
chrisatfcity: stop being wholly than art hou
11:20 AM
chrisatfcity: Yes because you gave me a php script with errors
chrisatfcity: i'm fixing it
chrisatfcity: and fuckj you steve
chrisatfcity: this is your app
Steve Wainstead: aha
Steve Wainstead: mike's script contains garbage. mea culpa. i should have checked it.
chrisatfcity: i don't have time for petty bickering
chrisatfcity: touche
Steve Wainstead: this isn't petty bickering
11:25 AM
Steve Wainstead: i'll set the goddamn meeting this time
chrisatfcity: yes it is ...
Steve Wainstead: i'm tired of you giving me shit for this
Steve Wainstead: when it's all your fault
chrisatfcity: I'm not giving you shit
chrisatfcity: and it's NO ONE fault
chrisatfcity: jesus stop pointing fingers..
chrisatfcity: lame
chrisatfcity: please update jessys message
11:30 AM
Steve Wainstead: done
chrisatfcity: thx
chrisatfcity: users are still managing to login or are logged in.
chrisatfcity: can we kick off just the users who are affected?
Steve Wainstead: sure, just need a list of usernames
chrisatfcity: i don't have that
chrisatfcity: we have the list of 3 level deep
chrisatfcity: that's it
Steve Wainstead: we can put the whole site into maint mode
chrisatfcity: no
chrisatfcity: I have NO ideas how long it's going to be until we get space back
Steve Wainstead: then the list of corrupted sites is going to go up
chrisatfcity: why?
Steve Wainstead: because they will continue to upload
chrisatfcity: how?
chrisatfcity: we disabled then?
Steve Wainstead: you can take teh oop servers out
Steve Wainstead: what would that do?
chrisatfcity: Hell no
Steve Wainstead: you said they were still logging in
chrisatfcity: we don't monitor uploads.
Steve Wainstead: i.e. the out-of-service is not working
chrisatfcity: if we did it like video processing where we logged..
chrisatfcity: wecould just reprocess.
Steve Wainstead: i just tested a site in out-of-service.php
Steve Wainstead: and was directed to maint.shtml
Steve Wainstead: so it's working
chrisatfcity: awesome
chrisatfcity: ugh i didn't update that page.
Steve Wainstead: oh, it redirects them from the get go
Steve Wainstead: interesting
Steve Wainstead: my site works
Steve Wainstead: you should be golden for the time being
chrisatfcity: [Mon Jul 14 11:39:39 2008] [error] [client 65.222.217.212] PHP Warning: fopen(/mnt/fast/vol01/f/fa/fai/fait/faith/faithandfriends//albums/album13/photos.dat.2) [<a href='function.fopen'>function.fopen</a>]: failed to open stream: No space left on device in /opt/mpa_gallery/current_R_2008_07_01_AdditionalLightBoxes/platform/fs_unix.php on line 74
11:40 AM
Steve Wainstead: yeah but i can't tell what volume that is since it's a symlink
Steve Wainstead: 'FAI' is not in the list from Mike
chrisatfcity: tell him that


AIM IM with MSG <yhavesns>.
11:42 AM
Steve Wainstead: you may have missed some usernames on vol04
Steve Wainstead: FAI is not in the list. apparently there's some fai's on vol04.
MSG: thats just fast03
MSG: i didnt do 04
Steve Wainstead: er
Steve Wainstead: you better coordinate with chris on what needs to be listed, because I don't know
MSG: yea, its just 02 and 03
MSG: 02 is full and 03 is almost full


Steve Wainstead: he gave me the list to 02 and 03
Steve Wainstead: so... there you are
11:45 AM
chrisatfcity: dyslexia on my part


---

So: from the start of the day I was looking into why the changelogs
were so borked (SVN logs in ChangeLog format we get each day). Really,
why not just munge the XML ourselves? (Well, because we wanted an off
the shelf solution from the get-go, so I tried the XSLT thing from
svn2cl.) Why SVN returns dates prior to the range I specify, I dunno.

But the above conversation shows that Chris's crisis was taking up
time this morning, and finally by noon I ordered lunch and mucked
around a bit more with listing the missing sized/thumbnails. Not too
bad really: I think uploads go to the user's tmp dir and then are
erased after being moved to the slow storage. So for the most part
people just couldn't upload. Why did vol02 fill up? (Or 04? Who knows
which one he meant in the end).

It turns out when he re-OS'd mdb-1 he didn't update the crontab on
mdb-2, so the script that flushes user's tmp directories was not
running. Typical sloppy systems administration.

A thought over the weekend: can we do this:

SelectedPhotoBaseClass: has common methods
DerivedClass: also implements an interface? Let's test.

#!/opt/php5/bin/php
<?php

interface FooInt {
    function IntOne();
    function IntTwo();
}

class FooBase {
    function __construct() {}
    function FBOne() { print "..  One FISHWICH coming up!!\n"; }
}

/**
 * Subclass of FooBase implementing an interface
 */
class FooChild extends FooBase implements FooInt {
    function __construct() {
        parent::__construct();
    }

    function IntOne() { print "Hello.  Just walk along and try NOT to think about your INTESTINES being almost FORTY YARDS LONG!!\n"; }
    function IntTwo() { print "Did I SELL OUT yet??\n"; }
}

$fc = new FooChild();
$fc->IntOne();
$fc->FBOne();

?>

Output:

swain@torque:~/tmp/testphp$ ./mixed.php
Hello.  Just walk along and try NOT to think about your INTESTINES being almost FORTY YARDS LONG!!
..  One FISHWICH coming up!!


So yes, I don't have to choose between a base class and an interface.





#########################################################################
080721 Mon 21 Jul 2008 12:04:00 PM EDT

Shipping should probably just be set on a per-product basis; no
categories. It might mean a larger table, but that's no big deal.

The difficulty, sorta, lies in the many permutations of US mail,
airmail, second day, Canada, and so forth. Then for each: first item,
each additional item.

I think I could also create the new design for shipping and only move
posters to it, at first; since it's a matter of tweaking the classes.

Well.... my work on "autotest," which lives in /home/www, is now out
of date. Once again, LHHReplay stuff goes stale. Oh well. There's
really no way around that.

I managed last week to convice Chris of the need to change the rollout
procedure. Well, I told him I need help solving a problem: that I have
not effectively managed how development is done, and my solution was
to more closely manage integration on the development box. But what
this effectively does, is cede staging to ops entirely, and I'll just
give them tag or branch names to roll out. Right now I've been testing
HEAD on products, gallery and cart (and static) and everything looks
good. Real good, in fact. Jessy is now rushing to finish something,
and then she and I are going to sit together and test everything. I
want to use that time to emphasize that we need to plan the releases
in a way that takes each project into account; and that work done by
two people might conflict with the rollouts, and we can avoid any
pains that way.

Over the weekend we had troubles with the store. In part, because
Qualex was hammering us with order status reports (two a second), and
the qualex log file wouldn't open (shared storage issues); this caused
a lot of hung Apache children, which necessitated a server reboot,
being unkillable even with -9 as root. From 3pm to 5pm Chris fought
with this while I did a bit of help, and finally osc-2 was happy after
I told it to log qualex xml to /tmp. This morning I changed it back
and that cause child processes to start hanging again; fixed that in
short order. The catch was, config.pl is on the shared storage... and
the log file was in /tmp on osc-2 of course. I failed to take this
into account, looking at /tmp on mdb-2 and thinking the config file
change hadn't mattered.





#########################################################################
080723 Wed 23 Jul 2008 06:54:32 PM EDT

Long day for the rollout. Geez. But it got done, and largely under the
new process. Spent more time on testing and debugging after that;
there were a bunch of PHP notices showing up in the log files, driving
Chris crazy. Fixed all that. Had to test out using "return" in a file,
which worked.

The fastest way to get GMC going is to brute force it: the
SelectedPhoto class should just set every possible field up front and
be done with it. I have maybe an hour's work to finish up on single
photo stuff (all that's left is folded cards) and then I just need to
cook up the file upload stuff.



#########################################################################
080724 Thu 24 Jul 2008 06:15:05 PM EDT

cp /mnt/slow/vol01/s/sw/swa/swai/swain/swain/albums/culturehands/44466765701_G.jpg /opt/mpa/custom-sites/gifts/tmp/
cp /mnt/fast/vol01/s/sw/swa/swai/swain/swain/albums/culturehands/44466765701_G.sized.jpg /opt/mpa/custom-sites/gifts/tmp/




#########################################################################
080725 Fri 25 Jul 2008 02:02:09 PM EDT

commentText in photos.dat indicates a comment. The number of them
indicates how many.

Automatic renewal was launched on February 13th, 2008. Since we scope
this to purchase date, the numbers should be accurate.

mysql> select products_id, constant_name from osc_products where constant_name like '%CLUB%';
+-------------+-----------------+
| products_id | constant_name   |
+-------------+-----------------+
|         154 | AUTORENEW_CLUB  |
|         148 | CLUB_MEMBERSHIP |
|         151 | CLUB_RENEWAL    |
+-------------+-----------------+
3 rows in set (0.00 sec)


New members only as of 2/13/08:

mysql> select auto_renew, count(auto_renew) from mpa_club_memberships where join_date > '2008-02-13 00:00:00' group by auto_renew;
+------------+-------------------+
| auto_renew | count(auto_renew) |
+------------+-------------------+
| n          |              1438 |
| y          |              1891 |
+------------+-------------------+
2 rows in set (0.04 sec)


All orders placed containing either club membership or club renewal
since 2/13/08:

mysql> select count(*) from osc_orders o, osc_orders_products op where o.date_purchased > '2008-02-13 00:00:00' and o.orders_id = op.orders_id and op.products_id in (154, 148, 151);
+----------+
| count(*) |
+----------+
|     5326 |
+----------+
1 row in set (4.05 sec)


The same, by product ID:

mysql> select op.products_id, count(op.products_id) from osc_orders o, osc_orders_products op where o.date_purchased > '2008-02-13 00:00:00' and o.orders_id = op.orders_id and op.products_id in (154, 148, 151) group by op.products_id;
+-------------+-----------------------+
| products_id | count(op.products_id) |
+-------------+-----------------------+
|         148 |                  3392 |
|         151 |                  1934 |
+-------------+-----------------------+
2 rows in set (1.85 sec)


Breakdown by anonymous purchases (who cannot be auto_renew):

mysql> select op.products_id, count(op.products_id) from osc_orders o, osc_orders_products op where o.date_purchased > '2008-02-13 00:00:00' and o.orders_id = op.orders_id and op.products_id in (154, 148, 151) and customers_id = 0 group by op.products_id;
+-------------+-----------------------+
| products_id | count(op.products_id) |
+-------------+-----------------------+
|         148 |                   548 |
|         151 |                    31 |
+-------------+-----------------------+
2 rows in set (0.84 sec)




Breakdown by people with store accounts:

mysql> select op.products_id, count(op.products_id) from osc_orders o, osc_orders_products op where o.date_purchased > '2008-02-13 00:00:00' and o.orders_id = op.orders_id and op.products_id in (154, 148, 151) and customers_id <> 0 group by op.products_id;
+-------------+-----------------------+
| products_id | count(op.products_id) |
+-------------+-----------------------+
|         148 |                  2844 |
|         151 |                  1903 |
+-------------+-----------------------+
2 rows in set (1.57 sec)



Build a temp table of all the data for crunching:

mysql> create temporary table swain_arc (select op.products_id, cm.auto_renew from osc_orders o, osc_orders_products op, mpa_club_memberships cm where cm.osc_customers_id = o.customers_id and  o.date_purchased > '2008-02-13 00:00:00' and o.orders_id = op.orders_id and op.products_id in (154, 148, 151) and customers_id <> 0 );
Query OK, 4487 rows affected (3 min 43.63 sec)
Records: 4487  Duplicates: 0  Warnings: 0



auto_renews and opt-outs:

mysql> select concat(products_id, auto_renew) as concatted, count(concat(products_id, auto_renew)) from swain_arc group by concatted;
+-----------+----------------------------------------+
| concatted | count(concat(products_id, auto_renew)) |
+-----------+----------------------------------------+
| 148n      |                                    627 |
| 148y      |                                   1916 |
| 151n      |                                    250 |
| 151y      |                                   1694 |
+-----------+----------------------------------------+
4 rows in set (0.02 sec)



Note the differences here: the first scopes join_date = date_updated.

mysql> select auto_renew, count(auto_renew) from mpa_club_memberships where join_date = date_updated and (join_date > '2008-02-13 00:00:00' OR date_updated > '2008-02-13 00:00:00') group by auto_renew;
+------------+-------------------+
| auto_renew | count(auto_renew) |
+------------+-------------------+
| n          |              1425 |
| y          |              1888 |
+------------+-------------------+
2 rows in set (0.03 sec)




mysql> select auto_renew, count(auto_renew) from mpa_club_memberships where  (join_date > '2008-02-13 00:00:00' OR date_updated > '2008-02-13 00:00:00') group by auto_renew;
+------------+-------------------+
| auto_renew | count(auto_renew) |
+------------+-------------------+
| n          |              1677 |
| y          |              3550 |
+------------+-------------------+
2 rows in set (0.04 sec)




Joined prior to 2/13/08:

mysql> select auto_renew, count(auto_renew) from mpa_club_memberships where  (join_date < '2008-02-13 00:00:00' AND  date_updated > '2008-02-13 00:00:00') group by auto_renew;
+------------+-------------------+
| auto_renew | count(auto_renew) |
+------------+-------------------+
| n          |               236 |
| y          |              1661 |
+------------+-------------------+
2 rows in set (0.04 sec)





#########################################################################
080801 Fri 01 Aug 2008 05:10:34 PM EDT

Worked out quite a few details for file uploads. A lot has happened in
PHP since Gallery was first written. The bulk of this comes from the
PHP online manual, plus user annotations.

<!-- The data encoding type, enctype, MUST be specified as below -->
     <form enctype="multipart/form-data" action="http://swainhome.myphotodevel.com/recv.php" method="POST">

     <!-- MAX_FILE_SIZE must precede the file input field -->
     <input type="hidden" name="MAX_FILE_SIZE" value="12582912" />

     <!-- Name of input element determines name in $_FILES array -->
     Send this file: <input name="userfile" type="file" />

     <input type="submit" value="Send File" />
     </form>


     <?php

     if (count($_FILES) == 0) return; // no files uploaded

switch ($_FILES['userfile']["error"]) {
 case UPLOAD_ERR_OK:
     break;
 case UPLOAD_ERR_INI_SIZE:
     throw new Exception("The uploaded file exceeds the upload_max_filesize directive (".ini_get("upload_max_filesize").") in php.ini.");
     break;
 case UPLOAD_ERR_FORM_SIZE:
     throw new Exception("The uploaded file exceeds the MAX_FILE_SIZE directive that was specified in the HTML form.");
     break;
 case UPLOAD_ERR_PARTIAL:
     throw new Exception("The uploaded file was only partially uploaded.");
     break;
 case UPLOAD_ERR_NO_FILE:
     throw new Exception("No file was uploaded.");
     break;
 case UPLOAD_ERR_NO_TMP_DIR:
     throw new Exception("Missing a temporary folder.");
     break;
 case UPLOAD_ERR_CANT_WRITE:
     throw new Exception("Failed to write file to disk");
     break;
 default:
     throw new Exception("Unknown File Error");
 }

// see http://us3.php.net/getimagesize

$info = getimagesize($_FILES['userfile']['tmp_name']);



// for ($x = 0; $x < 7; $x++) {
//     print "<li>$x: $info[$x]";
// }

// element 2 of the return result of getimagesize is the file type; see:
// http://us2.php.net/manual/en/function.exif-imagetype.php

switch ($info[2]) {
 case IMAGETYPE_GIF:  echo "GIF file.<p>"; break;
 case IMAGETYPE_JPEG: echo "JPG file.<p>"; break;
 case IMAGETYPE_PNG:  echo "PNG file.<p>"; break;
 default: echo "Illegal file type."; return;
 }


$uploaddir = './uploads/';
$uploadfile = $uploaddir . basename($_FILES['userfile']['name']);

echo '<pre>';
if (move_uploaded_file($_FILES['userfile']['tmp_name'], $uploadfile)) {
    echo "File is valid, and was successfully uploaded.\n";
 } else {
    echo "Possible file upload attack!\n";
}

echo 'Here is some more debugging info:';
print_r($_FILES);

print "</pre>";

?>





#########################################################################
080804 Mon 04 Aug 2008 06:28:07 PM EDT

Longish meeting today via phone with some former Rastar guy, who wants
to do books with the national parks. The idea seems OK, but I think
the development costs might make it infeasible. (Not feasible?)

I am behind the ball on the Signature Wines thing. Did some toying
with a script, the idea being: pass the session key to them, so they
can send it back. Doesn't look like I can "assume" that session. I'll
have to write a parsing class.

But I wound up on a side track: replacing all of $gallery->session
with $_SESSION. That led to some weird side effects, and I learned svn
revert -R . to blow away all changes.



#########################################################################
080807 Thu 07 Aug 2008 02:59:01 PM EDT

This is the link I crafted to test the Signature Wines thing.

Index: products.php
===================================================================
--- products.php	(revision 1759)
+++ products.php	(working copy)
@@ -514,4 +514,5 @@
 //
 //***************************************************************************************
 require_once("{$GIFTS_BASEDIR}inc/$appContext/footer.inc") ?>					
-        
\ No newline at end of file
+<hr>
+<a href="http://swainhome.myphotodevel.com/signature.php?sk=<?php echo $_COOKIE['PHPSESSID']; ?>">test link for signature wines</a>


Jessy and I have a slight design difference. She wants to toss out
upload_photo.php and make select_photo.php do either task: upload a
photo (if GMC) or show albums (if Gallery). This is unfortunate, since
select_photo.php contains a lot of Gallery code. So that needs
fixing. But she doesn't want to have to fix up upload_photo.php, which
I understand.

Meanwhile, I will have to introduce context classes to the cart as
well. The thumbnails come from different places; the store will only
work with Gallery at the moment. In fact, the five levels deep stuff
is wired into the Product base class.





#########################################################################
080808 Fri 08 Aug 2008 01:23:50 PM EDT

For the cart, I opted to just do "if gifts: else:" for the three spots
where the code had to change. It worked fine. This is not a
sustainable approach, of course. I wonder if templating can do a sort
of inheritence scheme.

So: done! OFS can build orders for Gifts. I had to make a few cheezy
hacks, which I will now detail, and their proper solutions:

1) in quantity.php, I modified the stowstring passed to the store. It
contains the subpath, since a gift user's stuff is in a subdir named
after their session.

2) Modified both Photo classes to match this call

3) Modified a few methods in gift.class.php; here is where the hacks
came in. I just test the subdomain. And:

4) Also test the subdomain in template.php to leave out a couple of
elements.

For 3 and 4, there should be a Gallery class and a GMC class to return
the proper values; or a solution similar, since that might not be the
perfect fit.




#########################################################################
080811 Mon 11 Aug 2008 03:51:16 PM EDT

Well, wanted to work on shipping today, but... it being
Monday... started the day with a very long train ride, due to an F
being taken out of service. I wanted to work on shipping today, but
instead got very involved in readying the next release of the store
code. Had to redo some of my staging tests; had to write up the whole
thing for Chris. It all seems to test out, so I think we're good.

I helped Jessy and Dylan add prices from the database to their PHP
code; added a few lines to GiftDB to define constants for starting
price for a category too.

I also put the string into Qualex_ShippingPart.pm. I think it will
work as-is, but need to test it.

Woops. Posted orders to Qualex's test facility as well as Zaah. Hrmm.





#########################################################################
080812 Tue 12 Aug 2008 10:07:32 AM EDT

Yup, got a terse email from Thomas at Kodak. Oh well.

I need to get a simple API doc written, if only in Twiki, for
Signature Wines.




#########################################################################
080813 Wed 13 Aug 2008 03:30:40 PM EDT

mysql> SELECT ui.*, p.state, p.city FROM users u, userinfo ui left outer join mpa_profile p on ui.userid=p.userid WHERE email_address = 'mcmickmick@test.myphotodevel.com' AND password = '112233' AND u.userid=ui.userid;
+--------+-----------+----------+--------+------------+---------+------------+--------+-----+---------------+---------------+-------------+
| userid | firstname | lastname | gender | birthdate  | country | postalcode | income | sid | directorylist | state         | city        |
+--------+-----------+----------+--------+------------+---------+------------+--------+-----+---------------+---------------+-------------+
| 142687 | SUPER     | PICKLE   | M      | 1983-12-23 | aq      | 99999      |      1 |     |             0 | McMurdo Sound | CENTERVILLE | 
+--------+-----------+----------+--------+------------+---------+------------+--------+-----+---------------+---------------+-------------+
1 row in set (0.01 sec)


This would be the way to extract info for a user who's used their
Gallery email/password for the Cart. Hopefully there will be nulls if
the profile is not filled out...

mysql> SELECT ui.*, p.state, p.city FROM users u, userinfo ui left outer join mpa_profile p on ui.userid=p.userid WHERE email_address = 'autotest@test.myphotodevel.com' AND password = '112233' AND u.userid=ui.userid;
+--------+-----------+----------+--------+------------+---------+------------+--------+---------+---------------+-------+------+
| userid | firstname | lastname | gender | birthdate  | country | postalcode | income | sid     | directorylist | state | city |
+--------+-----------+----------+--------+------------+---------+------------+--------+---------+---------------+-------+------+
| 143307 | mpa       | testing  | F      | 1970-01-01 | us      | 10001      |      1 | unknown |             0 | NULL  | NULL | 
+--------+-----------+----------+--------+------------+---------+------------+--------+---------+---------------+-------+------+
1 row in set (0.04 sec)


good!




#########################################################################
080814 Thu 14 Aug 2008 05:14:32 PM EDT

STAINLESS_STEEL_MUG

That's what the new stainless travel mug will use for
constant_name. The old one got a new constant_name.

Got the store rolled out today; Chris rolled out trunk so some supreme
weirdness happened. That's all live and good now.

The manager's meeting went on until almost 12:30. Or maybe it
did. Chris was to present, or he decided to present there, his pitch
on the data migration project. He droned from a piece of paper and
Peter looked agitated. It was not going well at all, so I took to the
whiteboard and outlined the phases the project would have to take,
what was changing, and why. This was very productive, in the end.

I explained how dat files worked; what pieces would go into the
database, in what order; how Veracity is slow and this would hold up
any work regardless; how memcached was another prerequisite; the
murmur hash Chris found; how we currently distribute the data and why
we spread it; the four letters deep proposal, and made a joke that
Chris threw his drink in my face and stormed out of the Black Door
(Peter thought that was really funny); and that pretty much covered
it. It went very well, I thought. Jessy had been asking some very
tough questions, but her angle was to delay the pro-am features Peter
now wants (to compete with smugmug). I also explained the software
estimation margin of error graph -- does that thing have a name? -- to
Chris, and recalled how Rob Walker once explained it as "The further
we are from being done, the more fucked we are." Chris thinks that an
ATOMic database is the panacea for the Flash uploader, that it would
solve the concurrency problem; and I couldn't make him understand that
it was no guarantee, because it's still Gallery accessing the
database.

Jessy told me over AIM later that she's actually 100% behind the
project. Peter followed up with an email that Chris said he didn't
understand, and finally, Chris started whining about the standup
meetings and sent me a link to an article complaining about standups
from some douche at the ACM. I quit iChat rather than listen to him
whine.

So, a first stab at adding products. We haven't added any in a while,
and I moved a lot of the product info off the filesystem (in
mpa_products) into the database. Later, we should unify those classes
with the store's product classes in a core library.

Add to these tables:

osc_products
osc_products_description
osc_products_to_categories
mpa_categories,         probably
mpa_products_groupings
osc_products_properties



#########################################################################
080815 Fri 15 Aug 2008 10:05:33 AM EDT

No entry. Says me, on the 18th.


#########################################################################
080818 Mon 18 Aug 2008 11:19:39 AM EDT

find  /home/swain/public_html/projects/mpa_products
/home/swain/public_html/projects/mpa_gallery
/home/swain/public_html/projects/mpa_cart
/home/swain/public_html/projects/mpa_static \( -name \*.js -o -name
\*.css -o -name \*.php -o -name \*.inc -o -name \*.default -o -name
\*html \) -print0 | xargs -0 grep -n

This find command will search my current copies of the projects for a
string I provide. I found Jessy had committed a file with
whooziestatic.myphotodevel.com as a link. Looks like Dylan has a ton
in there too.

So I need a script to search all files for those particular
items... more to the point, I suppose, any links to myphotodevel.com.

I installed htmltidy on torque. Not quite happy with the results. This
runs it from emacs:



; Function to run Tidy HTML parser on buffer
 ; NOTE: this requires external Tidy program
 (defun tidy-buffer ()
  "Run Tidy HTML parser on current buffer."
  (interactive)
  (if (get-buffer "tidy-errs") (kill-buffer "tidy-errs"))
  (shell-command-on-region (point-min) (point-max)
    "tidy -f /tmp/tidy-errs -q -i -wrap 72 -c" t)
  (find-file-other-window "/tmp/tidy-errs")
  (other-window 1)
  (delete-file "/tmp/tidy-errs")
  (message "buffer tidy'ed")
 )
 (global-set-key (kbd "C-x t") 'tidy-buffer)


My first job is to fix the form, which is getting too many form
variables added:

http://swain.myphotodevel.com/store.php/to/select_photo?product=playing_cards&fromCat=games_and_puzzles&product=playing_cards&fromCat=games_and_puzzles&fromCat=games_and_puzzles&set_albumName=album40

Done. Actually I broke it when I tried to update Jacob's sad
code. Oops. But there were still issues Jessy created that she did
clean up, to her credit.




#########################################################################
080819 Tue 19 Aug 2008 10:57:11 AM EDT

The problem I'm up against now: in the Product class in mpa_products,
there's a method that returns Boolean when passed a string that is the
name of a "product" or "category." The difficulty here is that, the
way Jacob built it, categories and products are
interchangeable. Though to be fair, the problem he was up against was
that a category could contain products and other categories. For
example, "fordad" is a category of items for Father's Day: it contains
a Golf Towel, but it also contains Mugs (the former a product, the
latter a category).

So at first blush the answer is this: a container class of
CategoryItems, and a CategoryItem is-a Product or is-a Category, which
in turn would also contain CategoryItems.

I guess this would imply an Interface: move whatever "CategoryItem"
behaviors there are into that. (PHP does not support multiple
inheritence, alas).




#########################################################################
080820 Wed 20 Aug 2008 04:11:08 PM EDT

Well, after a manager's meeting and our first 11am sitdown
meeting... I was working on shipping, and decided to write some
housekeeping sql to drop TLC tables and delete products from DPI we
never sold. All done.

Next I merged branch to trunk for mpa_products, resolved the
conflicts, got that rolled out to staging. There's a number of bugs in
mpa_products, and Fernando's replacement process for
ampira.redirect.php failed. He's now working with Chris on MediaClip.

I helped Dylan switch from branch to trunk and got his build working
right.

I have a bug in the cart code to fix; it is displaying tabs and other
items when coming from GMC.



#########################################################################
080821 Thu 21 Aug 2008 11:35:38 AM EDT


Worked on solving the hash login problem for Fernando, who's now on
vacation. Turned out to be the session bug we've seen before and
solved by doing a redirect back to the same page.


#########################################################################
080822 Fri 22 Aug 2008 01:50:15 PM EDT

Committed my changes for the hash login code. Tested stuff, looks
good. Started tinkering with session.php. I think I understand it a
lot better now, and have been commenting it.



#########################################################################
080826 Tue 26 Aug 2008 01:27:29 PM EDT

Have begun the process of getting the rollout ready; however had to
run numbers for Tom, and now have to prepare for an MPP meeting.




#########################################################################
080827 Wed Aug 27 09:33:24 2008

Did a lot of testing yesterday and filed two bug reports for
Jessy. I tested the rollout procedure -- signup has to go out last --
successfully. Did some exploratory work in conversion from
$gallery->session to using $_SESSION, but there was a bug in which
album was the current album; also spent a bit of time reading up on
diff, context diffs and patch, and learned how easy it was to generate
a patch file and apply it. Very spiffy. svn diff's output is
patch-ready.

Did my first ever folded card with MediaClip. Couldn't figure out how
to edit text.

https://store.myphotodevel.com/shopping_cart.php?action=add_product&quantity=5&productinfo={productid}2{projectid}14331520080827025039{sitename}signature

There's the post to the store.

Now this is weird. This stow string that Chris passes does not conform
to the spec I gave him; and what's more, the current way it's done
relies on a weird PHP language "feature":

        // this next line does not do what you would expect; it's some
        // kind of PHPism. Here, if $_string =
        // '148{mpa_user_id}143036{sbd}swainfree{auto_renew}0' then
        // $_product_id will equal 148. In other words, casting the
        // string to an INT returns the INT portion of the
        // string. Pretty weird. --sw
        $_product_id = (int)$_string;




#########################################################################
080828 Thu Aug 28 10:37:44 2008

INTO OUTFILE syntax:

SELECT * FROM final_result INTO OUTFILE  '/tmp/December2006_newReport.txt' FIELDS TERMINATED BY ','  OPTIONALLY ENCLOSED BY '"' LINES TERMINATED BY '\n'; 

mpa_products_groupings.category_members that do not match a
constant_name:


mysql> select distinct category_member from mpa_products_groupings pg left outer join osc_products p on pg.category_member = lower(p.constant_name) where constant_name is null;
+-------------------+
| category_member   |
+-------------------+
| mousepads         | 
| photo_prints      | 
| mugs              | 
| photo_club        | 
| cards             | 
| books             | 
| apparel           | 
| games_and_puzzles | 
| prints            | 
| personalized_dvd  | 
| forher            | 
| forhim            | 
| formoms           | 
| fordads           | 
| newbaby           | 
| kids              | 
| forcouple         | 
| justfriends       | 
| forfamily         | 
| forpet            | 
| forgrandma        | 
| forgrandpa        | 
| under20           | 
| home_and_office   | 
| calendars         | 
| gift_cards        | 
| ornaments         | 
| giftguide         | 
| photo_books       | 
|                   | 
| photo_calendar    | 
| newproducts       | 
+-------------------+
32 rows in set (0.50 sec)


mpa_products_groupings.category_members that match a constant_name:

mysql> select distinct products_id, lower(constant_name) as constant_name from osc_products p, mpa_products_groupings pg where constant_name = category_member;
+-------------+------------------------+
| products_id | constant_name          |
+-------------+------------------------+
|        7110 | frosted_stein          | 
|        7118 | keepsake_box           | 
|        7123 | large_canvas           | 
|        7143 | heavy_white_t_shirts   | 
|        1235 | long_sleve             | 
|        7148 | white_sweatshirt_s     | 
|        7111 | coasters_4x4           | 
|        7127 | teddy_bear             | 
|        7121 | clip_board             | 
|        7124 | playing_cards          | 
|        7109 | white_steel_mug        | 
|        7135 | bbq_apron              | 
|        7136 | deluxe_tote_bag        | 
|        7164 | golf_towel             | 
|        7112 | pillow_case            | 
|        6000 | dvd_spiderman          | 
|        6001 | dvd_dora               | 
|        6002 | dvd_barney             | 
|        6003 | dvd_baby_genius        | 
|        6004 | dvd_arthur             | 
|        6005 | dvd_care_bears_winter  | 
|        6006 | dvd_care_bears_fitness | 
|        7126 | puzzle_252piece        | 
|        7153 | kids_t_shirts          | 
|        7138 | white_t_shirts         | 
|        3113 | folded_cards           | 
|        7120 | cutting_board          | 
|        7119 | wall_clock             | 
|        7105 | ceramic_black_mug      | 
|        7103 | ceramic_mug_11_oz      | 
|        7102 | mousepads_8x9          | 
|        7107 | ceramic_mug_15_oz      | 
|        7104 | tiled_mug_11_oz        | 
|        7108 | tiled_mug_15_oz        | 
|        7106 | magic_mug              | 
|        7122 | small_canvas           | 
|        7113 | throw_blanket          | 
|        1242 | tote_bag               | 
|        7162 | clutch_bag             | 
|        7163 | bucket_bag             | 
|        7114 | pillow_sham            | 
|        7117 | ornament_snowflake     | 
|        7115 | ornament_flat          | 
|        7010 | print_11x14_matte      | 
|        7018 | print_12x18_matte      | 
|        7060 | print_16x20_matte      | 
|        7007 | print_20x30_matte      | 
|        7158 | boxer_shorts           | 
|        7132 | pet_collar             | 
|        7134 | dog_bowl               | 
|        7156 | girl_bib               | 
|        7157 | boy_bib                | 
|        7128 | photo_baseball         | 
|        7137 | diaper_bag             | 
|        7125 | puzzle_in_box          | 
|        7129 | photo_minibasketball   | 
|        7130 | photo_minifootball     | 
|        7131 | photo_soccerball       | 
+-------------+------------------------+
58 rows in set (0.01 sec)


And I think there is a solution to this problem:

"A category contains either products or other categories."

I think one way to do this in the database is to create a category for
each product, whose sole member is that product. Well, that changes
the statement, then, to this:

"A category contains only categories, or only products."

The only remaining problem is sort order. This does not solve it; a
given category can only have one sort value, under the OSCommerce
schema... so I should think this data would be in a table akin to
osc_products_to_categories.

Perhaps the design of the mpa_products_groupings table is the answer
anyway. But "category_member" can have one of two values, so another
column specifying the type would be needed; is this good or bad?





#########################################################################
080902 Tue 02 Sep 2008 03:43:24 PM EDT

Been testing and testing again. So sick of it.

R_2008_07_23_ProductSeparation is the current cart release; but the
last rollout was August 6th, for Fernando's improvements.

R_2008_07_31_Pxn8AndHouseAds is the current gallery release.

R_2008_07_31_BugFixesAndPhotoHandling is the current products release.

Wrote out all the documentation for the rollout, did more and more
rounds of testing, helped Jessy, and so on; worked pretty much only on
the rollout stuff. Early in the morning though I placed an order with
a card made in Mediaclip.







#########################################################################
080904 Thu 04 Sep 2008 03:57:52 PM EDT

Finally, FINALLY got the rollouts done. Problems that arose:

1) mass debug output in UserDB and User flooded the error logs.
2) Some missing images (!) even though I asked Jessy and Dylan
repeatedly to test.
3) CGI scripts in the signup wizard were not executable
4) One of the class files in /opt/mpa/lib was root-only so that broke
everything everywhere

GMC fails on staging and production but for different reasons; filed
both in bugzilla.

So I came here to my log to think out the changes to the OFS to handle
Rastar. So:

1) new product data entered
2) new manufacturer added to db
3) new prefix code added


Hi Fernando,

The task to extend the OFS to handle MediaClip and Rastar falls to
you. I've made a short Twiki page:

https://twiki.corp.myphotoalbum.com/bin/view/MPA/MediaClipAndTheOFS

For the OrderPartMC subclasses, I'm guessing we will be making a
network call of some sort to tell the Clip Producer to make the
PDF. Or maybe there's some nifty Perl/MONO binding we can use. Either
way, it's going to come down to some kind of abstraction that only the
OrderPartMC subclasses need to understand, and as always, the rest of
the OFS is clueless about it and decoupled from it.

So: import_files.pl is called by cron; WholeOrder is built; it calls
its OP subclasses and they do their thing. With no Clip Producer set
up yet, you can just fake it any way you want to with a stub
subroutine. You'll need to work on the OrderPartFactory class to make
the correct subclasses of OrderPartMCs.


Next: the first thing we're doing is Folded Cards, so once you have a
PDF (may as well just create one for testing purposes with our current
folded card system), put that in the XML for Qualex, and upload
it. Should be pretty straightforward.

Next: the Rastar API doc has an example of the XML document. You can
pare this down to a basic, unpopulated file, and commit it to
/opt/mpa/template/rastar. Then comes the fun of loading it, filling
it, writing it out. DOM manipulation is fun!

Also: we will be using FTP to send the files to Rastar. For the XML
and upload steps, we'll need a new subclass of OrderShippingPart,
probably Rastar_OrderShippingPart.pm, to handle those tasks. You'll
need to work on the OrderShippingPartFactory to create a proper
subclass of OrderShippingPart. On torque, FTP the order into torque's
ftp server; this should still be functioning, or at least in place.


Really, the hardest part here, it seems to me, is getting the Clip
Producer to make something for you. I'm making a first guess that the
OrderPart subclass will somehow call it, wait for it to finish, and
then retrieve the PDF file. Maybe it will be that easy. The real trick
here is: it has to work the same way on production. The million dollar
question is: how will the OFS communicate with the Clip Producer on
production, and how will they share files? Remember we have Draconian
firewall rules and no single part of any system can communicate with
any other part, even with the firewall. Mere processes cannot even
signal each other. The filesystem is read only. Even root cannot do
anything. All of our servers are unplugged and buried underground in
concrete bunkers. OK, I'm kidding here. But you get the idea: that
which works just fine on dev and staging tends to be impossible on
production.

Then order notification has to be updated. This has always been done
as a sort of afterthought, and I suppose it will continue to be that
way, unless you can put on a designing hat and think of a more "OFS
way of doing it" instead of it being a mere external Perl script. I
dunno.

Depending on the filesystem mess on production, for which you've
heroically done a lot of support, you should be able to do the Folded
Cards part in a fairly short period of time. Also this will be waiting
on Chris to get the Clip Producer up and running.

I've committed products.php to mpa_products; it has a test link at the
bottom of the page, when you are in cards, to start the Mediaclip
process. You can buy a card via the Cart, and everything should be
correct in the order.

As a final note, I was never happy with how I had to modify the OFS
when we switched to Qualex. For some reason the prefix codes made it
really difficult to put multiple products into the same order. I don't
remember why now, that being five months ago, but if you run into any
walls ask me for help. There's got to be some way of vastly
simplifying the OFS, but I haven't been able to visualize it yet.


---

I remembered today that an essential part of porting everything to the
database, Chris's One Storage To Rule Them All plan, also needs to
port everything in config.php to the database. This would mean dealing
with the wonkiness of the shortform, though; and that whole whacky
system. God that thing is convoluted.

Perhaps a first step is to break out all the variables that the user
cannot set, that are the same from site to site; and then break out
all the variables that the user cannot set, but are site specific.



#########################################################################
080905 Fri 05 Sep 2008 05:20:07 PM EDT

fun    start/end time  pid   label
___________________________________
hooha: 1220649517.928  26644 :start
hooha: 1220649519.279  20710 :start
hooha: 1220649520.6782 26659 :start
hooha: 1220649521.9589 23364 :start
hooha: 1220649523.2383 27845 :start
hooha: 1220649531.344  20710 :end
hooha: 1220649532.6459 23364 :end
hooha: 1220649533.0434 27845 :end
hooha: 1220649533.2885 26644 :end
hooha: 1220649535.0249 26659 :end

So yeah, the flex/javascript uploader
(http://demo.swfupload.org/Documentation/#swfupload) does the evil
thing and makes five upload requests at a time. In fact it probably
makes no difference what order they were uploaded or when they finish;
each process loads its own copies of Album, its own array of Photos,
and whoever wrote last won. In the above sample the third upload won.

So there's a possiblity to code around this. Maybe. Let's think. We
could load the needed classes at the outset; but when it comes time to
save them, perhaps a "version number" could be tested. Hmm. Nope, that
won't get around a race condition. It comes closer though.

So the next idea is to delay the updating of the dat file. We could
just make each process lay a photo.dat file somewhere; when the
uploading is done we submit the form and it picks them all up and adds
them. How much coding would that require?

Load Album
process file (i.e. create sized, thumb, highlight)
build up AlbumItem object
write that thing to the database
exit w/happy code

Form now submits: query db for all AlbumItem objects, add them to the
photos.dat array. What this suggests to me is we break one huge method
into discrete operations. Probably this is somehow related to Chris's
wet dream of copying pbase's delayed processing.

More fun: we then need to borrow this Gallery code for GMC. I
think. It seems like it would smoothen the transition to go from a GMC
purchase to *poof* new Gallery user.

So Album->save() needs, really, to do:

Album->createThumb();
Album->createSized();
Album->createHighlight() if Album->hasNoHighlightYet();

Nah. That doesn't quite sound right.

AlbumItem->createThumb();
AlbumItem->createSized();
AlbumItem->createHighlight() if Album->hasNoHighlightYet();

Better.

Album->writeLatentImage(AlbumItem);

Borrowing some old film terminology there in "latent image". Perhaps
that's not descriptive enough:

Album->writeLatentImageToDatabaseForLater(AlbumItem);

I suppose we can just queue up all the image processing in a table
somewhere. Why is this so hard to do? It seems to me a simple matter
of decoupling. I guess it's that multiple processes do the processing,
so there's a concurrancy issue there too. Whoopie.

Well, here's a funny idea: implement file locking via the
database. Sounds like a kludge though.


One of many processors wakes up; grabs a site. Sets semaphore to
'pending.'
Process all the photos for that site.
Update the semaphore to "done" or thereabouts.

At this point the files are created. Next process should add them to
the albums. So maybe:

1) User uploads files via flash.
2) Album classes put the full sized images on the slow storage. I don't
   trust the tmp files to stick around for very long.
3) Images are slotted in the db. This is a series of INSERTS. Really
   this can happen as with each upload.
4) Daemon processes all the images. Maybe this can be done in
   parallel.
5) When all images from the upload are processed, then we can update
   the Album class. The AlbumUpdateDaemon.

Breaking out 2+3:
file uploaded; mv to slow storage; insert into db.

Breaking out 4:
I would do them all in parallel. That is, a set of photos might be
processed by different daemons.

5: AlbumUpdateDaemon, the AUD, SELECTs all the ready rows from the
database, processes them, viola. This means, though, that AUDs could
wind up competing for the same dat file, so there still lies the
concurrency issue.

So file locking via the database is still needed. As awful as that
might sound.

How to notify user? Album could query the db for pending
photos. PendingAlbumItem instances could fill the role of AlbumItem
for the nonce. Is that a proxy pattern? Nope.


#########################################################################
080906 Sat Sep  6 09:07:06 2008

Thinking again on how to solve the concurrency problem with
MPA. Actually I'm reflecting on how Chris believes that porting
everything to the database solves our concurrency problems, which it
does not. Why? Because the data is retrieved from the database by two
separate processes, internal changes are made to each, and then they
both write back to the database. The last writer "wins."

The race condition has never been in the data storage. It's always
been in the application. Changing the data storage does not eliminate
the race condition.

I'm thinking that one of the problems with Gallery is uploading and
displaying are tightly coupled. The responsibility for handling
uploads should be moved out of the Album class. So let's think on this
a bit.

The user has chosen which album they are uploading to; uploads
currently go to a PHP script. Files are uploaded to a tmp
directory. They have to be processed (sized and thumbs created). I
think at the least all of this can be moved out of the Album class,
into an UploadHelper class. (One of the fundamental problems in the
current design is that the Album class is too overloaded with
responsibilities).

So pulling out uploading is a first step. Once files are uploaded,
they have to be queued to be processed. Here's the first multitasking
issue: two machines of two (four?) cores each; so we need four
(eight?) daemons to do the converting. This problem has largely been
solved by the delayed video processor, though that is written in Perl,
so communicating with a Gallery is somewhat problematic. Also there
has never been a solution to killing a runaway process that is
"pinning the CPU."

I don't see, offhand, why we can't ignore Gallery entirely in the
convert calls... the UploadHelper should put all the data needed into
the database row (the database table being the queue) that the
converter needs. Location, sizes, names. I think updating a
"processing state" column, then checking the UPDATE call to make sure
the row was changed, will probably suffice.

So now the user has uploaded their photos; from their perspective,
nothing happened yet. So after the upload, when the page is refreshed
the simplest thing is to tell them "10 items still being processed."
An Album only needs to do a "select count(*)" from the database. This
sounds rather intensive, on the one hand, but the queue should never
be more than a hundred or so images. We could even move this out into
another column, say in "users," a flag indicating whether to scan the
table or not. This is an optimization so it can wait.

On the OPP servers, as outlined above, the images are processed.

Now, something has to trigger a page reload for the user. For now
let's stick with the simplest thing that works: user has to manually
refresh the page to see if their stuff is done. (Which is the current
situation). How do the new items go into their album?

I think with delayed video processing, the daemon has to manipulate
the site. Perhaps this is why Fernando has to set the site name at the
start of his script -- "fmarte."

If, instead, we have the Gallery do this we might get around that
problem. Album checks for processing items; are any ready?

Here lies the race condition. If two copies of the same Gallery make
that request, they are both told yes. Only one needs to add the items
to the site; the other needs to reload when the first is done.

And here again I wonder if the UPDATE approach will work:

  try to get a lock: update table set state=taken where id = INT;
  test if updated returned 1 (row was modified)

This should be guaranteed to be atomic. Two conditions are possible:

1) Returned 1. We have the lock. We process all the waiting photos for
this site.

2) Returned 0. We did not get the lock. Someone else did; we can
either return the "waiting to be processed" message again; or we can
busy wait until the lock is free and reload the site. Bleh. Too
complicated. We tell them items are still being processed.

So, now we really do have the situation where Album is adding new
items to itself and writing out the database. Not sure how the user
sees this.

foreach item in queue:
  album->save() (as it currently does)

There's no delay since the files are already created. Objects are
instantiated, updated, written to the dat files.

Lock released. Well, there's the rub, eh? What if the lock is never
released? (User stopped the browser, the connection was lost,
etc). Well, that's a problem that has to be solved.






#########################################################################
080909 Tue 09 Sep 2008 06:39:23 PM EDT

Yesterday and today: lots of debugging of stuff like folded
cards. Turns out I made a mistake when refactoring the
foldingcard.class.php. I also found that a value was being truncated
when inserted: card_image_fullpath had the last four chars lopped off.

So the OFS depended on a bug in another program. Somewhat
amusing. Meanwhile, a user complained about upload times; yesterday
Jessy and I looked at some of the script run times for him and some
other users. There are some really severe upload times; a minute or so
for a single image. I don't know why. I want to add an "image
processing time" for each image, and we can then figure out:

full script runtime, minus image processing time, equals file upload
time.

This might tell us something.



#########################################################################
080910 Wed 10 Sep 2008 04:52:43 PM EDT

Well.

It was Flash on Mac on Firefox all along; here's an upload from IE:

hooha: 1221078458.2964 11212 :start
hooha: 1221078458.4118 11212 :end
hooha: 1221078476.1934 14140 :start
hooha: 1221078476.3932 14140 :end
hooha: 1221078479.1382 14152 :start
hooha: 1221078479.3857 14152 :end
hooha: 1221078484.3106 9946 :start
hooha: 1221078485.123 9946 :end
hooha: 1221078486.162 9941 :start
hooha: 1221078486.71 9941 :end
hooha: 1221078486.8012 13074 :start
hooha: 1221078487.0898 13074 :end
hooha: 1221078491.0591 11586 :start
hooha: 1221078491.3053 11586 :end
hooha: 1221078492.5061 14411 :start
hooha: 1221078492.8728 14411 :end
hooha: 1221078492.9773 9953 :start
hooha: 1221078493.2301 9953 :end
hooha: 1221078496.9467 13058 :start
hooha: 1221078497.2157 13058 :end
hooha: 1221078498.4898 14421 :start
hooha: 1221078498.9153 14421 :end
hooha: 1221078499.0077 9959 :start
hooha: 1221078499.264 9959 :end
hooha: 1221078508.2021 9942 :start
hooha: 1221078508.4098 9942 :end
hooha: 1221078534.3473 9950 :start
hooha: 1221078534.6055 9950 :end
hooha: 1221078541.5568 14402 :start
hooha: 1221078542.0129 14402 :end
hooha: 1221078542.8611 14438 :start
hooha: 1221078544.6175 14438 :end
hooha: 1221078544.7363 14164 :start
hooha: 1221078545.1727 14164 :end

Perfectly serial. Versus:

hooha: 1221071801.8216 11586 :start
hooha: 1221071802.5095 9958 :start
hooha: 1221071803.2069 9934 :start
hooha: 1221071803.892 9932 :start
hooha: 1221071804.5524 9955 :start
hooha: 1221071805.0608 9946 :start
hooha: 1221071805.6493 11649 :start
hooha: 1221071821.5395 11586 :end
hooha: 1221071821.7472 9958 :end
hooha: 1221071823.7287 9932 :end
hooha: 1221071823.9561 9934 :end
hooha: 1221071824.2467 9946 :end
hooha: 1221071824.4154 9955 :end
hooha: 1221071824.438 11649 :end

for mac/ff.

This kind of sucks, because that means FF/Mac users might have trouble
using GMC. Oh well.

---

Meanwhile: thinking about config.pl. There's definitely stuff we can
drop. And I think I would break it into several tables. Why? If
there's no row in a table for a particular group of settings, we use
the defaults. Maybe. Alternately I'm thinking of one ginormous table,
but that would not be 3NF.

It's premature optimization, maybe, but it's fun so let's do
it. Grouping things like rss, comments, "default" (skins and such)
into separate tables, we then have a master table of columns of
foreign keys. Key null? Use the defaults. Sounds workable.

So there's this huge hassle of the configuration system, which sucks
butt. bleh.

By my calculations: 6570 bytes per config.php file times 250K users is
1.5 GB according to Google Calculator. So disk savings is negligible.

Every page request equals a file access though, so there's that.

Perhaps throwing out the shortform entirely would be the way to go...






#########################################################################
080911 Thu 11 Sep 2008 01:58:50 PM EDT

Posted a bunch of stuff to SWFUpload's discussion board, so the author
has some more facts on the matter.

Committed some things for mpa_cart for mediaclip.

Also, Jessy was very excited about my idea to abolish config.php and
redo the shortform. It turns out she wants to do things I hadn't
thought of, like one click thumbnail resizing.

I did some work yesterday -- thought experiments, I should say -- into
how we'd break up the data in config.php. Oh, see my thoughts from
yesterday. Anyway I like the idea of adding code to Gallery to put the
data in the database if it's not already there. For example, this
would replace the code in init.php that loads config.php:

if config info is in the database:
   create a config object holding that data
   store it in memcached
else:
   load config.php
   create a new config object
   store it in the db
   stash it in memcached

In a fairly short order we'd have everything in the database. I'd
rather we do all the albums and photos the same way: if it's not in
mysql, put it there. Later on veracity would finish up the job. We'd
keep two copies of the data for a while, which was the plan I think
back prior to the last datacenter move.

Seems my first task would be to put the UploadedPhoto into an album. A
simple wrapper should work for now: the path to the "album" is the
path in the tmp directory, the photo is in an array and is the zeroeth
element. This is doable. Then I'd have to move, eventually, towards
merging Gallery's Album class with GMC's Album class. Maybe. Maybe
not. Maybe Gallery's Album will have a method importGMCAlbum(GMCAlbum
$album); that will bring the data in. And we would use the customer
information in the Cart to create the account; all they need to do is
create an accountname.

Hrmm. Well, actually it makes no sense to add an "album" on the single
photo path because that would affect Gallery too: pages like
quantity.php use a reference, $sphoto, which points to an instance
that implementes an interface. So if I wrap that in a GMC album class
then something similar has to happen for Gallery and we enter a world
of mess.

Still... based on Jessy's page flow... the user will be able to return
to the "album" and see a set of thumbnails; they will select one and
it will now be the "chosen one" (heh). There will be the side-by-side
display of their album and the upload box.

So: put everything in the session, or create a new table to hold all
the data? Probably the database.

session_id
user's filename
gmc's filename
location on storage

I suppose this would be useful for the store too. Or the OFS rather;
knowing the session ID would mean easy access to the
files. We should probably make the GMC session key fairly permanent.





#########################################################################
080912 Fri 12 Sep 2008 04:43:20 PM EDT

Worked with tcpdump a bit today; neat stuff. Chris analyzed the
traffic for the SWFUpload tool; he can see it connecting to different
sockets on the server... we had the same problem on his Safari as
Firefox. Windows, no problem.

Helped Fernando diagnose nulls in the XML Mediaclip writes to the
database.

Trying to think out this Album business in gmc:

Well, got interrupted again. Sigh.

Again:

User uploads file; album instantiates photo; thing is written to db.

For a GMC photo, it would appear that all I need to figure out
everything is this:

cookie
image_name (as created by md5)
gifts tmp directory

I can calculate everything from that, I think.



#########################################################################
080915 Mon 15 Sep 2008 01:44:02 PM EDT

Jessy uploads five files:

hooha: 1221500561.3454 9961 :start
hooha: 1221500561.4873 9961 :end
hooha: 1221500561.4945 9964 :start
hooha: 1221500561.6952 9964 :end
hooha: 1221500562.2499 9949 :start
hooha: 1221500562.3453 14416 :start
hooha: 1221500562.4765 9949 :end
hooha: 1221500562.5684 14416 :end
hooha: 1221500570.308 14225 :start
hooha: 1221500571.1537 14225 :end
hooha: 1221500619.5761 9945 :start
hooha: 1221500619.6664 9945 :end

Me:

hooha: 1221500735.4511 14163 :start
hooha: 1221500736.7575 9948 :start
hooha: 1221500737.9019 11760 :start
hooha: 1221500738.9761 27723 :start
hooha: 1221500740.1357 9940 :start
hooha: 1221500744.1895 14163 :end
hooha: 1221500747.9826 11760 :end
hooha: 1221500748.2042 9948 :end
hooha: 1221500748.4918 9940 :end
hooha: 1221500748.5648 27723 :end

Helped Tim test the uploader. Actually I have no problems uploading to
staging. But as the above output shows, something funny goes on with
Macs.

I spent time trying to get readable output from tcpdump, to no
avail. There's no client available right now for Tiger, only Leopard.

Fernando wanted help with some multidimensional types in Perl; but I
told him not to bother, just use XML::DOM. This he did and found it
was  much easier. I told him I'd buy him lunch if I was wrong.

Fixed a bug finally: there was a bug opening the directory for folded
card themes. I had a feeling I'd fixed this somewhere else before in
the code base... probably did... probably duplicate code in
mpa_products.

I'm thinking GMC has to supply images to MediaClip the same way
Gallery does: taking queries and returning XML. This should be the
case for cards as well as calendars and books. But I'm ahead of
myself; first we have to have multiple images uploaded.

I'm supposing:

gifts.myphotoxxxxxx.com/getxml.php: returns one album, ever.
gifts.myphotoxxxxxx.com/getxml.php?albumname=default: returns the
photos the user uploaded. 'default' being the name that just came to
mind this moment.

A GMC photo class needs to create instances either from the database
(in the case of previously uploaded files) or from $_FILES (new
upload). Naturally you can't overload methods on PHP objects... so...

Probably: initFromArray() and initFromUpload(). Make the code
completely duplicated. Then factor out the differences.





#########################################################################
080916 Tue Sep 16 15:30:10 2008

Ran a new set today. The numbers on the Windows uploads in a previous
entry here looked too short. 

ms: 1221592347.0682 18012 :start  
ms: 1221592349.5361 18012 :end    
ms: 1221592349.8388 18002 :start  
ms: 1221592351.9992 18002 :end    
ms: 1221592352.3285 18215 :start  
ms: 1221592354.4726 18215 :end    
ms: 1221592354.5743 18327 :start  
ms: 1221592354.6546 18327 :end    
ms: 1221592354.8429 18003 :start  
ms: 1221592356.9909 18003 :end    
ms: 1221592357.2887 17986 :start  
ms: 1221592359.4087 17986 :end    

mac: 1221592642.2971 535 :start   
mac: 1221592643.2217 17983 :start 
mac: 1221592644.5965 17987 :start 
mac: 1221592645.959 18005 :start  
mac: 1221592647.4727 18006 :start 
mac: 1221592649.5 18012 :start    
mac: 1221592649.6199 18012 :end   
mac: 1221592652.2145 535 :end     
mac: 1221592653.3497 17983 :end   
mac: 1221592654.3956 18005 :end   
mac: 1221592654.6902 17987 :end   
mac: 1221592655.2495 18006 :end   

I had a lot of trouble getting the numbers; it turned out uploads to
port 8080 hit Torque's build of Gallery, not the user's. Bad.

Miles Bader is hero for a day because his patch to comint.el works.

--- orig/lisp/comint.el
+++ mod/lisp/comint.el
@@ -1774,7 +1774,9 @@
               (let ((inhibit-read-only t)
                    (inhibit-modification-hooks t))
                 (add-text-properties comint-last-output-start (point)
-                                     '(rear-nonsticky t
+                                     '(front-sticky
+                                      (field inhibit-line-move-field-capture)
+                                      rear-nonsticky t
                                       field output
                                       inhibit-line-move-field-capture t))))


Thus ending years of frustration.

Spent quite a bit of time on SWFUploader again today; found if you set
debug=true you get a spiffy box at the bottom of the page. Exactly the
sort of thing I would have done.

I figured out, after reading a lot of code, that a queueComplete
"plugin" is really just a function you write yourself. All I did was
set window.location. Worked fine.




#########################################################################
080918 Thu Sep 18 12:06:33 2008

Fighting with bugs in GMC, now that it handles multiple uploads. I'm
puzzling over whether I should create an armada of getter/setter
methods for the SelectedPhoto classes. I'm leaning towards yes; each
one can do a filetest on the file it's supposed to return, so I can
add a lot of assertions while I debug. I can add them to the base
class and the interface... no, just the interface. Because when then
come via Gallery, they have an original and a sized (in their Gallery
album), then they have a copy and a sized copy in their tmp gift dir,
or in gift's tmp dir. So my think goes: if they are on the GMC path,
they don't need the original and sized original... so we can return
the copy and copy sized values for that. I know, it's confusing.

I've long felt that accessing the fields directly was kind of icky
anyway. The desire here is that the fields are all moved up into the
base class and are somehow enforced; that way whatever the
applications need will be guaranteed to be there, and we can also
"create it as needed" instead of "creating it every time" as we do not
(very slow, very inefficient).

So.. right now the problem is, on the GMC path, we have a full sized
with the user name and a copy with the GMC-assigned name.


  -rw-r--r-- 1 www www 30450 Sep 18 11:40 c5627afc9a9f9f4755ade2a4e2d8b4a0.jpg
  -rw-r--r-- 1 www www 13682 Sep 18 11:40 c5627afc9a9f9f4755ade2a4e2d8b4a0.sized.jpg
  -rw-r--r-- 1 www www  3941 Sep 18 11:40 c5627afc9a9f9f4755ade2a4e2d8b4a0.thumb.jpg
  -rw-r--r-- 1 www www 46923 Sep 18 11:06 lea.jpg
  -rw-r--r-- 1 www www 11062 Sep 18 11:06 lea.sized.jpg

Never mind the timestamps, the basic evidence is correct here.

---

Just spoke with a Constable Colleen Bevington, of the Royal Mounted
Canadian Police, regarding case number 2008683775, which is the NCMEC
case number 611059, which I reported on 7/28/08. Requested a fax from
her. She had the usual questions about timestamps and such. I think I
inadvertently deleted all my non-image files, sadly. But the perp's
data is still in mpa_photos. Her incoming number was 613-949-6121.

Sent an email to Lindsey at NCMEC asking if we are to destroy or
retain the copies. I periodically delete them, but on no set schedule.

---

So, I think to fix the cropping tool it's a simple matter of keeping
the "selected photo" in the session, i.e. 
$_SESSION['gmc_filename'] = $photo->image_name;




#########################################################################
080919 Fri Sep 19 14:21:13 2008

So we've come to a weird crossroads with GMC. I can't upload a dozen
pix at once because GMC wants each to be associated with a
product. Why? Because GMC expects to create a sized image and a
thumbnail for each one; those dimensions are dependent on the
Product. Hrmm.

So Jessy agreed that for single upload products we'd have just the
browse button for now; for multi uploads we'd use the SWFUpload flash
object.

So I need to test somehow. I suppose I should make a faux print
product page.

Last thing doing: getting the flash uploader to work on GMC.



#########################################################################
080929 Mon 29 Sep 2008 10:30:09 AM EDT

I'm back from vacation. Circled Iowa with Mike Kole.

Replied to Colleen from the Mounties confirming we received her fax.

Trying to figure out where I left off. Fortunately, there's
uncommitted files in the products project and that's an indicator.

Found, here at the end of the day, Jessy deleted a bunch of important
code from welcome.php. This resulted in: new signups were forced to
login after activating. Not a big deal, but it was one more step they
were forced to take. Jessy got really defensive and said she couldn't
test it because you cannot sign up on development. (You can't sign up
on torque because the mx record for test.myphotodevel.com is somehow
wrong; ims-1 rejects something from fortunecity.com).

In the end I'm guilty of putting important appliation code in a
display page where she can change it. But it peeves me she changed
something, not knowing what it is. It just bolsters Chris's argument
that she should not be programming.

I got multi-photo uploads working with GMC, and did some refactoring
(though it might need some more) to allow add_flash_upload_tool.inc to
be used by Gallery and GMC. Next:

* add photos to cart
* write XML interface to the GMC album, for MediaClip

Wrote another reply to Colleen the Mounty. Replied to two questions in
her fax.

Sunday night, Mike called Chris and told him he'd accepted a new
position as a Rails developer.



#########################################################################
080930 Tue 30 Sep 2008 03:10:07 PM EDT

Dependencies. The Photo class in GMC is dependent on the Product class
for the dimensions of the sized image. Hrmm. There needs to be a way
to decouple that. I can see where using the same image for multiple
products would lead to complications; I bet when ordering from
Gallery, the photo is simply copied in again every time.

Perhaps I can use a NullProduct class as a default? Alternately I'm
thinking of giving the photo class a handle on the Product class;
which means in the db, I'd have to store the product class name along
with the image info, which isn't so terrible.

On the other hand... if all it needs is the size of the sized image
(the midpic), that value could be stored. Or I can just choose a
default. 

Anyway, I hardcoded 250 into the SelectedPhoto base class; and I
changed the session cookie name to PHPSESSID to match Gallery. That,
actually, should finish everything for the time being. I can turn on
folded cards and test.





#########################################################################
081002 Thu 02 Oct 2008 02:23:27 PM EDT

Been rattling my noggin for the past hour or so about adding prints to
cart from GMC. Grayboarded some of it with Jessy but we agree that
this is a small need, ultimately. Really, books and calendars are the
prime products for GMC, and mugs/mousepads/tshirts will probably be
the biggest sellers.

Oh, I forgot about the "create an MPA site" step. Ah well. That's in
the page flow Jessy and I thought up. It's here somewhere.

Maybe it's finally time for a Gallery object in the cart; ditto a GMC
object, which is the motivator. I already fleshed out, on paper,
GallerySiteHelper and GiftsSiteHelper classes to abstract away
differences like 'getThumbnailURL()'. I'm kind of at a loss as to when
I would instantiate these though. Meanwhile, I think shopping_cart.php
never, ever sees 'print_choices' in its GET data anymore. We use the
ajax.php file in Gallery to do all print adding.

Oh, I should set up a comprehensive test while I do store work.

---

Well... hacked in code in the cart to add prints from GMC. The cheap
solution seems to be: take the data from the DB, fudge it to match
what Gallery passes in, then call $this->addPhoto(). Lame, but it
would probably work. Still have to hack up the SiteHelper
classes. Maybe I'll work this weekend.




#########################################################################
081003 Fri 03 Oct 2008 02:25:59 PM EDT

Distilling my todo lists into a set of note cards; found this:

Sgt. Rodney Thompson; Bedford County, VA.

That was one of the CP contacts from law enforcement. Oh and Colleen
Beverly called again, have to return her call.


Spent a long time clearing up my desk; distilling the todo lists into
note cards; only to find all the mpp stuff was pinned to the
wall. Alas.

I have changed some defined constants shared by gallery and cart;
actually, gallery uses the constants and the store does not. I should
probably throw them out altogether.

---

Stow strings are used throughout, so excersing them from the codebases
might be tricky. Nah. Stow strings are a minilanguage and we should
kee them.



#########################################################################
081006 Mon 06 Oct 2008 11:26:27 AM EDT

Testing MediaClip today. Gonna review the OFS.

Done. Could use some renaming as Fernando simply ressurected the
copy_to_shipping_dir.pl script.

Where I left off last week was trying to decide what the scope of
responsibility would be for a GMC class within the Cart: merely a
helper class that munged strings, or would it be an "instance of" GMC
(or a Gallery?) It seems the answer came to be the latter, thinking
about it half asleep this weekend... but I don't remember why now.

The semi crappy thing to do is munge the GMC photo class into
returning stow strings of its data. That's why I was re-evaluating
stow strings, but decided they formed a mini-language and we'd keep
them.

OK, GMC now stores the file width and height in the table.
OK, can now add prints to cart. Thumbnails don't work
though. Amusingly it's all Hello, Sailor! images.



#########################################################################
081007 Tue 07 Oct 2008 04:57:36 PM EDT

Been cranking away on GMC/Cart stuff today. Did an end to end
upload/buy/fulfill with prints. Did a bit of refactoring so
Mediaclip+GMC works. Well, almost: Mediaclip doesn't like the xml it
gets from GMC. Will have to debug that with Chris's help.

So I started fixing the FIXME's scattered throughout mpa_products, and
I'm trying to solve the problem where adding prints to cart then
generates a sized image for every single file, which takes
hours. (Seemingly anyway). But I found a bug where uppercase file
extensions break stuff, so I'm looking at this now.

But I wanted to write out the algorithms needed for resizing
photos. When uploading images for prints:

make thumbnails
never make a sized image, unless the user wants to see how it crops in
the cart.

For single photo gifts:
Always make sized and thumb? I think the sized is used when showing
the product+image sandwich on quantity.php.

For calendars and books:
Probably need to make a sized photo every time

The problem is the "selected photo" interface. Born from Gallery, it
has notions about an "original," a copy of the original, a sized
version of the original, a sized version of the copy, and so on. I
guess it comes back to the idea that all the object's "fields" should
be hidden behind accessors. Then we don't care. I'm not really sure
the original full sized image from Gallery is ever needed.

Good news, everyone! This works:

#!/opt/php5/bin/php
<?php

$foo = "hello, sailor!";
print "{$foo}\n";

class Blippy {
    function printFoo() { return "foo"; }
}

$blip = new Blippy();
print "{$blip->printFoo()}\n";

?>

Output:

swain@torque:~/svn/pgms/php$ ./testbraces.php 
hello, sailor!
foo
swain@torque:~/svn/pgms/php$ 


So I can just change the variables into methods and procede thus.



#########################################################################
081008 Wed 08 Oct 2008 10:45:01 AM EDT

So.. I got as far as MediaClip actually fetching and reading the data
from GMC! All I had to do was pass in a correct "username"
(subdomain). I should have found that on my own. But the important
thing is I know where the log file is now:

root@torque:/d0/ecommercebridge/log# !!
tail -f fluorine.log


But there's some weird null pointer exception going on. That can be
diagnosed later: the XML from GMC is identical to that from
Gallery. It's clearly parsed the XML at this point.


2008-10-08 10:37:08,204 [-1244660816] DEBUG MyPhotoAlbum.ECommerceBridge.Plugins.UserFilesManager - Sitename: swaingifts
2008-10-08 10:37:08,205 [-1244660816] DEBUG MyPhotoAlbum.ECommerceBridge.Plugins.UserFilesManager - Session Key: ftgme2qfg2u91gr6okaisvtfn3
2008-10-08 10:37:08,205 [-1244660816] DEBUG MyPhotoAlbum.ECommerceBridge.Plugins.UserFilesManager - UID: 0
2008-10-08 10:37:08,205 [-1244660816] DEBUG MyPhotoAlbum.ECommerceBridge.Plugins.UserFilesManager - XML Feed -> http://swaingifts.myphotodevel.com/getxml.php
2008-10-08 10:37:08,205 [-1244660816] DEBUG MyPhotoAlbum.ECommerceBridge.Plugins.UserFilesManager - SK -> ftgme2qfg2u91gr6okaisvtfn3
2008-10-08 10:37:08,289 [-1244660816] DEBUG MyPhotoAlbum.ECommerceBridge.Plugins.UserFilesManager - AlbumId -> yourphotos
2008-10-08 10:37:08,289 [-1244660816] DEBUG MyPhotoAlbum.ECommerceBridge.Plugins.UserFilesManager - AlbumLabel -> Your Photos
2008-10-08 10:37:08,289 [-1244660816] DEBUG MyPhotoAlbum.ECommerceBridge.Plugins.UserFilesManager - Image XML Feed -> http://swaingifts.myphotodevel.com/getxml.php?albumname=yourphotos
2008-10-08 10:37:08,379 [-1244660816] DEBUG MyPhotoAlbum.ECommerceBridge.Plugins.UserFilesManager - photoList count -> 20
2008-10-08 10:37:08,379 [-1244660816] DEBUG MyPhotoAlbum.ECommerceBridge.Plugins.UserFilesManager - PhotoId -> 55997690245_G.jpg
2008-10-08 10:37:08,380 [-1244660816] ERROR com.TheSilentGroup.Fluorine.Filter.MessageFilter - Object reference not set to an instance of an object
com.TheSilentGroup.Fluorine.Messaging.MessageException: Object reference not set to an instance of an object ---> System.NullReferenceException: Object reference not set to an instance of an object
  at MyPhotoAlbum.ECommerceBridge.Plugins.UserFilesManager.GetAlbums () [0x00000] 
  at Mediaclip.ECommerceBridge.API.Services.ModuleServiceBase`1[Mediaclip.GreetingCard.Model.GreetingCard].getAlbums () [0x00000] 
  at (wrapper managed-to-native) System.Reflection.MonoMethod:InternalInvoke (object,object[])
  at System.Reflection.MonoMethod.Invoke (System.Object obj, BindingFlags invokeAttr, System.Reflection.Binder binder, System.Object[] parameters, System.Globalization.CultureInfo culture) [0x00000] --- End of inner exception stack trace ---

  at com.TheSilentGroup.Fluorine.Remoting.RemotingAdapter.Invoke (IApplicationContext applicationContext, IMessage message) [0x00000] 
  at com.TheSilentGroup.Fluorine.Messaging.Services.RemotingService.ServiceMessage (IApplicationContext applicationContext, IMessage message) [0x00000] 
  at com.TheSilentGroup.Fluorine.Messaging.MessageBroker.RouteMessage (IApplicationContext applicationContext, IMessage message, IEndpoint endpoint) [0x00000] 
  at com.TheSilentGroup.Fluorine.Messaging.Endpoints.EndpointBase.ServiceMessage (IApplicationContext applicationContext, IMessage message) [0x00000] 
  at com.TheSilentGroup.Fluorine.Filter.MessageFilter.Invoke (com.TheSilentGroup.Fluorine.Gateway.AMFContext context) [0x00000] 
2008-10-08 10:37:08,384 [-1244660816] DEBUG com.TheSilentGroup.Fluorine.FluorineGateway - End AMF request.
2008-10-08 10:37:08,518 [-1244660816] DEBUG com.TheSilentGroup.Fluorine.FluorineGateway - Begin AMF request.
2008-10-08 10:37:08,518 [-1244660816] DEBUG com.TheSilentGroup.Fluorine.Messaging.MessageServer - Query endpoint endpointPath:/builder/Gateway.aspx contextPath:/builder
2008-10-08 10:37:08,519 [-1244660816] DEBUG com.TheSilentGroup.Fluorine.AMFReader - Attempt to read custom object flex.messaging.messages.RemotingMessage.
2008-10-08 10:37:08,521 [-1244660816] DEBUG com.TheSilentGroup.Fluorine.AMFReader - Attempt to read custom object .
2008-10-08 10:37:08,522 [-1244660816] ERROR Mediaclip.ECommerceBridge - This is the logger error
2008-10-08 10:37:08,524 [-1244660816] DEBUG  com.TheSilentGroup.Fluorine.FluorineGateway - End AMF request.


Oh, bollocks. My XML is wrong for listing photos. Teh suck. Well
that's easily fixed. Also not all the sized images are
created... hrmm...

Oh, the API for a "photo" object, be it GMC or Gallery, should have
accessors to the following:

full
sized
thumb
highlight (for an album)

And that's it. All the noise about "original in user's Gallery" and
such should be hidden away. From the point of view of the Gifts
project it isn't necessary to pollute the glossary with all that
stuff.

...

VICTORY!

I got photos uploaded to GMC showing in MediaClip. It seems, however,
that the sized photos are not there. File extension is uppercase?
Nope, it simply wasn't generated. Hrmm.

Demo'd the stuff for Peter. Very yay. OFS chokes on GMC orders though;
Fernando is doing some grevious string hacking.

fileName="http://rawimages.myphotodevel.com/w/wh/who/whoo/whooz/whoozie/albums/album01/istock_000004888053small.jpg"

fileName="http://swaingifts.myphotodevel.com/tmp/63gvqfjpt82gfg6r9sfpgtoc20/fc4b905361875a433bfb16fa5d8f54b2.jpg"

Here's the conflict. He munges the former into a path on the
filesystem; his s/// failes on the latter though.




#########################################################################
081013 Mon 13 Oct 2008 11:35:26 AM EDT

On Friday morning we rolled out MediaClip folded cards. That's quite a
big deal. During log monitoring, I found we've been getting hit with
spam links for viagra and other drugs. Bleh.

I then factored out Jacob's captcha code from share.php and
process_something.php; made a class Captcha to deal with that; tested;
then added code to add_comment.php, tested all around, had Jessy
resize the box, tested, and all was good. Today packaged that for
Chris. It will roll out this afternoon.

I got Chris to finally create mpa_core in Subversion, and he went one
step further and made an mpa_signup too. Makes sense. I'm tempted to
rush right in and start that process, but I don't want to hamper
the development process with a dev box with one configuration, while
production has another.

Also, today I'm wearing my old new glasses. Sent an email to Satomi
using Photobooth.

Trying to figure out what the layout of mpa_core would be... do I mix
perl and php? If not, is there a perl/ and php/ at the top level? 

Is there some semblance of functionality I can use to divide at the
top level? I think my initial response is to just toss it all into
mpa_core at the top level and sort it later; or maybe divide it
between php and perl.

And we should perhaps have an mpa_cronjobs as well.

But for starts: all PHP should come out. Leaving the Perl in there is
no biggie.

Oh, have to fix up the OFS to process GMC orders still... 

Done; I can't see any "clean" way to solve the problem that the XML
from MediaClip gives us the URL to the raw image. So Fernando does an
s/// on it to make it a file path; if his fails, we try mine.

            unless ($file_name_path    =~ s%http://rawimages.\Q$SERVICE_NAME/%/mnt/slow/vol01/%i) {
                # kludge: munge the URI for GMC instead, see if that
                # works... note I'm using [a-z]*gifts instead of just
                # 'gifts' to accomodate our test sites on torque. --sw oct 2008
                $file_name_path    =~ s%http://[a-z]*gifts.\Q$SERVICE_NAME/%/opt/mpa/custom-sites/gifts/%i;
            }


Eh, it works.



#########################################################################
081014 Tue 14 Oct 2008 10:59:45 AM EDT

We'll need at least three calendar products, I think; I don't know how
many books, and there's no slimlines in there at all.

Yesterday Chris brilliantly rolled out mod_deflate on the image
servers and went to work on Jessy's machine (installing XP so he can
install MediaClip). I decided on sheer whim to place a print order,
and lo, the thumbnails didn't load in the shopping cart page. But it
worked for him. It eventually turned out to be an inconsistent bug
with the load balancer, and he finally resolved it. I am skeptical
about his claim in his email that the outage was "10-15 minutes." I'd
say more like a half an hour.

Still, rolling out a configuration change on a Monday afternoon? Even
if it is Columbus Day, such changes should be handled more gingerly.

Today: more failures. Onstor bug hit, and now I'm seeing the exact
same images-not-loading problem as yesterday. Chris is on the phone
with someone and whacking his keyboard really hard. It sucks for him
that Peter found the outage. Peter's bug was odd: GiftDB complained
that it didn't get a CONSTANT_NAME back for some reason.




#########################################################################
081015 Wed 15 Oct 2008 12:10:14 PM EDT

Peter's pushing for us to get the rest of MediaClip finished. Had to
call Jessy to get some info. Fernando is going to enter the product
data: nine books, four calendars. Dunno about slimlines yet.

[Wed Oct 15 13:47:53 2008] [error] [client 64.52.253.115] File does not exist: /opt/mpa_products/current/tmp/b11b56928c51e5a0e13be1b556fd70cd.thumb.jpg
[Wed Oct 15 13:47:53 2008] [error] [client 64.52.253.115] File does not exist: /opt/mpa_products/current/tmp/94326cef46465b9d100c5f9c36ba90b2.thumb.jpg



Note on staging the cart tries to pull the thumbnails from the wrong
address... or something...





#########################################################################
081016 Thu 16 Oct 2008 12:25:12 PM EDT

Yesterday: got MediaClip books working with the cart.

Today: Renewed focus on MPP. Gotta get all that working again.



#########################################################################
081017 Fri 17 Oct 2008 04:42:06 PM EDT

The story so far: Working off an old O'Reilly article, I want to
create a local repository of my shell buffer contents. I don't want to
have dated files like I currently do:

swain@torque:~$ ls -la .emacs.shellbuffer.* | wc -l
589

Examples:

-rw-r--r-- 1 swain swain     834 2008-07-10 18:51 .emacs.shellbuffer.www-2008-07-10
-rw-r--r-- 1 swain swain    4257 2008-07-11 15:16 .emacs.shellbuffer.www-2008-07-11
-rw-r--r-- 1 swain swain     135 2008-07-14 18:23-.emacs.shellbuffer.www-2008-07-14
[...]
-rw-r--r-- 1 swain swain     851 2008-10-15 18:18 .emacs.shellbuffer.www-2008-10-15
-rw-r--r-- 1 swain swain    4596 2008-10-16 16:58 .emacs.shellbuffer.www-2008-10-16
-rw-r--r-- 1 swain swain      76 2008-10-17 16:43 .emacs.shellbuffer.www-2008-10-17

This is too much. So, The Google turns up this article:

http://www.onlamp.com/pub/a/onlamp/2002/10/31/subversion.html#create_a_repository

Here's my steps so far, which seem to work fine.

  509  svnadmin create .svnlocal
  510  svn mkdir file:///home/swain/.svnlocal/shellbuffers -m  "create emacs shellbuffers repostiory"
  511  pwd
  512  cd
  513  cd .svnlocal
  514  ls -lta
  515  ls
  516  find . -name shellbuffers
  517  cd
  518  svn checkout file:///home/swain/.svnlocal/shellbuffers .emacs.shellbuffers
  519  cd .emacs.shellbuffers

Now, I need to tweak Emacs to use the new directory that uses the
local repository. I'm giggling as I write this because it's so
freaking silly in a way.

OK:

(defvar sw-buffer-file-name-prefix "~swain/.emacs.shellbuffers/"
  "All shell buffers, when their contents are saved, get this string prefixed to the buffer name.")

I dropped the long filename prefix, since it's not needed anymore.

Hmm. What I'd be giving up here is the easy ability to grep the
shellbuffer files. But it wouldn't be hard to tweak the Korn shell
script to generate all the files with svn cat, and then grep
those. The need arises so rarely.

And on every machine I'd have to create a repository and all
that. Perhaps this is a per-machine kind of thing? On torque it makes
more sense but on mup-1 or stg-1 it makes little sense.

So, this is a runtime option of sorts. Torque? Subversion. Elsewhere?
Incremental files.



#########################################################################
081020 Mon 20 Oct 2008 10:35:55 AM EDT

Well, coming back after the weekend:

swain@torque:~/.emacs.shellbuffers$ svn commit -m "since updated"
Sending        cli
Transmitting file data .
Committed revision 3.

Now that's a nice feature. They only commit if they've been
changed. Timestamps don't seem to matter.

So, after a contentious standup meeting, we're gunning to get this
thing live by Wednesday as promised.



#########################################################################
081021 Tue 21 Oct 2008 07:27:45 PM EDT

In very late, had to wait on Vinnie. Actually I wasn't going to come
in at all but he was done before noon.

Just did a massive housecleaning of the OFS, throwing out all the DPI,
Neilsen, and Zaah code. I started by trying to fix a bug where the
"your order has shipped" email had a bug: it doesn't list the
subtotal, discount, shipping and final total. It turns out we have no
way to do end to end testing of the OFS at the moment; probably not
since we switched to Qualex. PixFusion, it seems, never did implement
an order status notification mechanism, so I shot off an email. I
can't remember how Pixami does it, but who cares; it will just be
Qualex and Rastar.

Erm. How do I select all status 9 orders that are Qualex product
laden? Erm... select * from somewhere where orders_status=9 and
products_id = p.products_id and p.manufacturers_id = 11?



#########################################################################
081024 Fri 24 Oct 2008 09:52:10 AM EDT

Got end to end testing of the OFS fixed; threw out a ton of old code
in the process. Store now uses the ezsql in /opt/mpa/lib/ezsql. Modded
that to get around the bug that prevents mysql_insert_id from being
returned.

Spent time at PDN yesterday; smaller than last year (which was smaller
than the year before.) No Apple. No collages.net. I think the digital
revolution is largely complete, which in part is why it's smaller. The
focus of the panels has shifted somewhat, less on industry issues and
more on the craft and the business.

Also fixed a bug where shipping did not show up for Mediaclip books;
fixed places in the cart where the books didn't show up at all; and
fixed a bug in the "order complete" email. Fernando has been cranking
away on the Rastar order fulfillment. Chris is out today for a
bachelor party. He flew somewhere. Last night while I was at Tom's,
Peter called me saying he got an email from Janet saying the site was
down. I leaned over Jim Yanks to type in the URL on Satomi's laptop --
they were trying to sort out a mess with Tom's expense reports -- but
the site was up. Likewise the cart seemed fine.

Yesterday morning we had a number of broken print orders. This was due
to Chris rolling out the wrong conf files for the store (he rolled out
"in maintenance" then rolled back old ones). My new constants for the
stow strings were missing so adding an entire album to cart resulted
in one broken image. Yet people still bought the single item.

Did repeated rollouts and testing of the codebases to staging. Finally
tagged them STAGING. Should be good to go live on Tuesday.


---

Wrote up a small script to query Rastar for an order's status, since
we have to poll them. (bleh). Have to write one more piece to update
the status on our end, and then remove_completed_orders needs
finishing.





#########################################################################
081027 Mon 27 Oct 2008 10:29:38 AM EDT

Spent time tweaking my setup on kristalle (my iMac), so shell buffer
contents are stored in a local svn repository.

Oy vey. In the advertisers table, all the first_names are populated
with email addresses. How did this happen?



#########################################################################
081028 Tue 28 Oct 2008 02:47:51 PM EDT

Did quite a bit of housekeeping with MPP yesterday: redid some of the
lisp I use, added an svn repo on my imac and cronned the perl script
to manage it, etc. Found Mike had made changes to the DB so my tables
were out of date, corrected that, added a new action to the
photog_admin ("contact") and that needs to be fleshed out.

I realized I'm writing, in effect, a CRM for MPP. For some reason I
like this idea.

cart: R_2008_10_10_folded_cards_launch
gall: R_2008_10_13_comments_captcha
prod: R_2008_10_17_signature_wines

Whipped up the release notes for the mediaclip book release. We'll
have to get calendars live by tomorrow.


kristalle:/usr/local/src/subversion-1.4.3/tools/examples swain$ gcc -o ~/client minimal_client.c  -I/usr/local/include/subversion-1 -I/usr/local/include/apr-0 -L/usr/local/lib -lsvn_client-1 -lapr-0 -laprutil-0 -lsvn_client-1 -lsvn_fs-1 -lsvn_ra_dav-1 -lsvn_repos-1 -lsvn_delta-1 -lsvn_fs_fs-1 -lsvn_ra_local-1 -lsvn_subr-1 -lsvn_diff-1 -lsvn_ra-1 -lsvn_ra_svn-1 -lsvn_wc-1 
kristalle:/usr/local/src/subversion-1.4.3/tools/examples swain$ ~/client
Usage:  /Users/swain/client URL
kristalle:/usr/local/src/subversion-1.4.3/tools/examples swain$ ~/client file:///Users/swain/.svnlocal
   shellbuffers
kristalle:/usr/local/src/subversion-1.4.3/tools/examples swain$ 

Rather hideous, but I got a subversion client to compile. The
subversion tarball contains an example program, minimal_client.c, and
half the battle was finding what it needed to compile.



#########################################################################
081030 Thu 30 Oct 2008 05:14:05 PM EDT

Long day of testing, tweaking, and prepping yet another rollout.

Edited the json files so we have American English calendar
dates. Tested and retested. Fixed a bug in the cart. Helped Jessy get
her work done today. Spent quite a lot of time on IM with her, in
fact.




#########################################################################
081031 Fri 31 Oct 2008 12:16:19 PM EDT

Calendars live. Tom/Peter/Jessy tossed out an invalid offer concept,
which Fernando dutifully tried to implement, which lead to an offer
going out that was completely infeasible. Layers of miscommunication,
coupled with an inability to say no. Oh well. Some lessons are learned
the hard way.




#########################################################################
081103 Mon 03 Nov 2008 10:54:08 AM EST

You say, "today our head of ops gets told he's being fired"
You say, "his replacement starts tomorrow"
You say, "should be a lot of drama"
draco [to Wainstead \]: what did he screw up?
Wainstead \ [to draco]: in a nutshell, he is incapable of holding a middle management position. 
he's a brilliant technical person, but he cannot communicate with nontechnical people. he cannot 
work unsupervised either; he probably does only 1-2 hours of work in a given day (unless he's 
putting out fires). He cannot finish anything; i've seen him fuck himself many many times because 
something was only 90% done, or done half assed.
heller [to Wainstead \]: you are aware of all the fun of escorting  him into a room away from 
computers while you guys change all passwords and stuff. right? 
Wainstead \ [to heller]: that's not my job. i doubt he'll pull something like that; he's going to 
be offered a very sweet severance package. he's always majorly in debt so i'm confident he'll take 
it.
heller says, "then it's not being fired. . .it's being layed off. :->"
Wainstead \ [to heller]: i warned our ceo and jessy (since she's director of photo services) that 
we could be facing a week of downtime in the worst case, where the mass storage has some failure 
and he's gone
Wainstead \ [to heller]: true enough, laid off. and replaced with one of his former bosses.
heller asks, "so. . .what did he do? or not do?"
Wainstead \ [to heller]: also i'm the good cop here. the ceo is the fall guy. so even if he blows 
up i'll call him and tell him not to fuck me. or he doesn't get his dvd's back. ;o)
Wainstead \ [to heller]: well, that's a long long story. but this process started about three 
months ago, when, again, he got jessy so upset she went into the conference room and curled up in 
the corner on the floor (not kidding) because she was so mad and frustrated trying to deal with 
him. since he became head of ops back in ... 2005, I think, he's progressively made more and more 
difficult procedures so he doesn't get bothered by anybody and he can play with his iphone all day.
Wainstead \ [to heller]: that was probably one of those confrontations that set her off. she and i 
have talked each other down dozens and dozens of times over him.
Wainstead \ [to heller]: he is, in the parlance of antipatterns, a corncob
heller says, "ok. so just general assholishness. . ."
tiResias [to project]: where are you getting this extra 1.2% in your cost calculations from...
Wainstead \ [to heller]: well, his general assholeness was what brought things to critical mass, 
finally. so that day i had our ceo come into the conf room to talk to jessy and i
heller [to tiResias]: MS tax. 
Wainstead \ [to heller]: and one of the things i told him was: there were days in the past couple 
of years where, after some confrontation with him (chris) i was so *beside myself* that i sat at 
my desk, unable to work, and thought: there's no way i can continue working here...
tiResias [to heller]: I actually think it may be some sort of tax calculation, but I'm not sure 
where that is set up
Wainstead \ [to heller]: one of those many occasions where you probably told me to stop bitching 
about him on avalon :o)
Wainstead \ [to heller]: so our ceo told jessy and me, if you want i will replace him but you have 
to be full in 
Wainstead \ [to heller]: and i didn't want that, because despite wanting to blow him away with a 
sawed off shotgun on a near weekly basis, we get along great outside of work
heller says, "that's no reason to work with someone you can't stand to work with. :-> "
heller says, "I know lots of people I would never work with. "
Wainstead \ [to heller]: and i had our ceo and jessy sold on the idea that day that what we needed 
to do was work on team buiding; that chris and jessy used to get along fantastic (smoke breaks, 
but she quit smoking)
tiResias says, "well, we didn't invoice any taxes, so I guess I can't put this number in a status 
report ;)"
Wainstead \ [to heller]: yeah, well, it didnt' matter because of the next two things to happen... 
we have half a million dollars invested in storage, and chris is completely unable to tell our 
ceo, in terms our ceo would understand, the state of the storage, what's being used for what, etc 
etc
Wainstead \ [to heller]: this all came to a head last month with our ceo sending chris an excel 
spreadsheet and bugging him (cc'ing everyone too) twice a day making him fill it out
Wainstead \ [to heller]: in the end it was a fairly simple document too; and i thought, two years, 
chris, of our ceo asking for this in manager's meetings and you couldn't create one?
Wainstead \ [to heller]: and finally, proverbial straw came about five weeks ago. we do daily 
standup meetings, just me, my programmer, jessy, her design guy. and chris was put on a project to 
get this .NET book maker up and running for the holidays (now live, it's pretty cool)
Wainstead \ [to heller]: our ceo told chris to join the standups until the project was finished 
(maybe 6 weeks). 
[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
Although I feel it is more than adequate to do a meeting Mon Wed Fri, I've got no problems joining 
a daily tech meeting.
Two requests: have it after 11am and let's make it seated.

My requests are due to the following:
Standing for any amount of time and my back starts to act up.
Between 9am and 10:30am OPs is checking the previous nights emails, monitoring system, and graphs.
OPs would more than likely push this meeting back several times a week and I'd like us to keep a 
routine
and besides morning meetings are horrendous.  I for one am not a morning person.

I propose this:
Seated in the conf room.
Limited to the following:
What I did yesterday
What I am doing today
Problems I am having.
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
You say, "now, there are two problems here. 1: he can't come in at 945am every day? 2: he's a 
fucking liar about reading systems emails for two hours every morning and everyone knows it. 3: 
his "proposal" is exactly what we do anyway. 4: he can stand in a bar or at a concert for hours on 
end, so the back thing is horse shit."
You say, "so our ceo said to me: i will order him to be in at the 945"
You say, "and i said: don't bother we'll move it to 11am"
You say, "but everyone hated that because it broke the flow of the day"
You say, "and our ceo sat chris down, 1:1 talk, and by the end our ceo had to walk out because he 
wanted to punch chris, who can be like a stubborn 2yo on the pot refusing to poop."
You say, "so, after meeting this guy bill only once, he was hired to replace chris. i'm not 
worried though. bill has been a sysadmin for years longer than chris and is highly recommeneded by 
jessy's girlfriend (uber sysadmin herself) so somehow things will shake themselves out."
You say, "for me, after 3-4 years of this drama, it's like the guilty relief one feels after a 
terminally ill loved one passes away. i'm done with the situation and feel practically nothing."
heller says, "well. . .the problem is going to be how pissed chris is. "
You say, "i have sudo access to most machines.. as long as he doens't lock me out of bastion 
(intermediate machine) there wont' be too many problems."
heller [to Wainstead \]: as I said. you don't need to work with someone who's just going to be a 
roadblock. no matter how good a guy he is. 
Wainstead \ [to heller]: yeah. i have plenty of friends i wouldn't want to work with. i have 
plenty of coworkers whom i like but wouldn't be friends with. frank zappa said, in his 
autobiography: friendship lasts up to about $10,000. then it's just boss/worker relationship. but 
i think that's true also when you have a stake in the company (and we all do)
merlin stoicly orates, "holy fucking shit i hate this morning"

---

Count colum types in a database. No idea anymore why I was writing
this.

#!/opt/php5/bin/php
<?php

// Tell Gallery not to exit on redirects.
define('MPA_NO_EXIT', true);

$_SERVER['MPA_GALLERY_ROOT'] = 'swain.myphotodevel.com';
require_once('/opt/mpa/conf/gallery.conf');
require_once("{$GALLERY_BASEDIR}init.php");

$dbconn = DBConn::getInstance();
$conn = $dbconn->getConnection();

print "connection: $conn\n";

$query = "show tables";
$result = mysql_query($query, $conn);

if (!$result) {
    $message = 'Invalid query: ' . mysql_error() . "\n";
    $message .= 'Whole query: ' . $query;
    die($message);
 } else {
    //var_export($result); print "\n";
 }

while ($row = mysql_fetch_assoc($result)) {
    //print "{$row['Tables_in_mpa']}\n";
    $query = "show columns from {$row['Tables_in_mpa']}";
    $lr    = mysql_query($query, $conn);
    while ($col = mysql_fetch_assoc($lr)) {
        $types[$col['Type']]++;
    }
 }


foreach ($types as $type => $count) {
    print "$type: $count\n";
}

?>

----

Been resurrecting Jacob's cd burning code... there are some major
problems with it.

1. It relies on mpa_id, which is the primary key to the mpa_albumitems
table. This table is not maintained.

2. The table structure he used is appalling:

mysql> desc gift_archive_disc;
+---------------+------------------+------+-----+---------+----------------+
| Field         | Type             | Null | Key | Default | Extra          |
+---------------+------------------+------+-----+---------+----------------+
| id            | int(10) unsigned | NO   | PRI | NULL    | auto_increment | 
| createtime    | datetime         | YES  |     | NULL    |                | 
| albumItemsIds | text             | YES  |     | NULL    |                | 
| type          | char(11)         | YES  |     | NULL    |                | 
+---------------+------------------+------+-----+---------+----------------+
4 rows in set (0.01 sec)

Here, albumItemsIds contains a pipe delimited string of the selected
photos.

3. The code relies on the old filesystem structure (that is, before
Jessy's redesign of all the pages). Fixing this is hard.


4. All photo selecting has been consolidated into select_photo.php;
so, do we break that decision or merge this into it?




#########################################################################
081104 Tue 04 Nov 2008 10:43:16 AM EST

Any rastar order that's not cancelled and not finished. Each order
part has a row in ofs_orders_parts_status. So join the 1200's that are
not status 3 to the rastar table...

Been trying to think through the algorithm today for querying order
status from Rastar. There's two tables: ofs_orders_parts_status and
rastar_orders_status. The latter, we'll add a new row for each status
change. This gives us an audit trail.

I think the polling script will only insert rows and nothing more. It
will be up to the remove_completed_orders.pl script to change the
orders_status in ofs_orders_parts_status to 3 when there's a row
that's 'Shipped' or 'Cancelled'. This seems fairly uncoupled.

1. get all rows from rastar_orders_status where
ofs_orders_parts_status.orders_status = 9 (transmitted).
2. Query Rastar.
3. For each result, insert new row into rastar_orders_status (which
means we need to filter out duplicates).

1. remove_completed_orders queries rastar_orders_status for all orders
where ofs_orders_parts_status.orders_status = 9 and
rastar_orders_status.orders_status = 'Shipped'.
2. Update ofs_orders_parts_status to 3.



#########################################################################
081105 Wed 05 Nov 2008 10:52:49 AM EST

Obama won. Prop 8 passed, Series of Tubes was re-elected, the Crats
only got 56 senate seats, NY state senate goes to the Crats, MA
decriminalizes 1oz of mary jane... Al Franken lost... Palin might get
a Tyra Banks-style talk show.

---

Can't really focus on anything. I'm just trying to add print surface
selection for now. Trying to decide where that would go; probably in
osc_cart.

Fixing svn perms when committing: /opt/scripts/svn_correct_perms on
rcs.corp.myphotoalbum.com.




#########################################################################
081106 Thu 06 Nov 2008 01:44:08 PM EST

How to set a text node after you get an element by tag name, in Perl:

#!/usr/bin/perl

use XML::DOM;
use Data::Dumper;

my $parser = new XML::DOM::Parser;
my $doc = $parser->parsefile('/opt/mpa/template/qualex/qualex_order.xml');


my $node = $doc->getElementsByTagName('paper_surface')->item(0);

my $child = $node->getChildNodes()->item(0);
$child->setNodeValue('matte');
print $child->getNodeValue;

print "\n";


And, as implemented, with error checking:


# this replaces whatever value is in a text node, or appends a new
# text node if none is found
sub replace_text_node {
    my ($self, $tagname, $value) = @_;

    my $node = $self->doc->getElementsByTagName($tagname)->item(0)
        or do {
            $self->add_error("Failed to find an element with tag name '$tagname'");
            return ERROR;
    };

    my $child = $node->getChildNodes()->item(0);

    if ( $child && ($child->getNodeType() == XML::DOM::TEXT_NODE) ) {
        $child->setNodeValue($value);
    } else {
        my $textnode = $self->doc->createTextNode($value);
        $node->appendChild($textnode);
    }

}


Today: updated rastar polling script... the problem on production with
subversion happens when you use the newer client (1.5) on mdb-2 to
update a repository; every other machine has 1.4, and will refuse to
read the local copy anymore.

Put an order through with white borders and luster. Spent time tracing
the javascript in the cart; but it's really really tightly coupled, I
think, with the PHP code. So this is a huge problem. It always has
been, though; the current implementation grew out of the old one
organically. I should imagine elsewhere in this log I documented how I
spent time optimizing the page and discovered it was being super
horrible inefficient using a buffer, making a full copy of the page in
a variable, and then printing the variable.




#########################################################################
081107 Fri 07 Nov 2008 12:50:43 PM EST

Well, without reading back what I wrote yesterday, what I found with
the cart is that the javascript is intimately tied to the PHP code in
the Cart class. Specifically, since the form variables are named in
the scheme "cbid[]", which translates to a PHP array on the back end,
this creates a very concrete data structure dependency between the
page and the class code.

What's at cost here is understandability, but on the other
hand... even rewriting the whole shebang into something more loosely
coupled won't necessarily help matters much. But what I really want, I
suppose, is ease in extending the damn thing. Particularly, I want to
add bordered prints next.

Now, conceptually, it would work this way:

4XD print: has "parameters" indicating which Qualex product ID should
be used. For qualex there's only two choices (bordered or not). For
District this would have been a bigger help, because a matte 4XD was a
different product ID, but for Qualex it's a top level XML tag's value.

So let's broaden the problem some more. For a given image in a
customer's album, they might want a 4x6 and an 8x10. Currently, two
copies of the image will be placed in the order. Yes, this wastes disk
space, but not much in the grand scheme. The amount of effort to
overcome this defect is far more expensive than just buying more disk
space.

Anyhow: if we did, it might have other benefits.

image -> 4xd
      -> 5x7
      -> 4Bx6

OK, in DDL terms this would mean a table looking like this:

image_id,
qualex_product_id

In a perfect world we wouldn't copy the image from the slow storage at
all, though I'm much more comfortable doing so.

(Incidentally, my current thinking is to put off Veracity, and code
Gallery to do all the work of storing the data in the database, and
copying over stuff only when there's a hit on the site. Then, with
this 'dual mode Gallery' we have time to port the data into the DB).

(al gore rythm:

first, new provisions are provisioned the new way. all new signups are
db-only.
second, gallery is extended to port the data to the db when someone
requests something. First hit will be slow.
third, at our leisure, we port the rest of the sites over. could be as
trivial as hitting each site, one at a time.
fourth, clean up the filesystem. this only means deleting dat files.
fifth, unified file system? no more slow/fast?

end).

Meanwhile... in two or so years, I think MPA will be fairly
obsolete. Let's go off on a theoretical experiment.

One of the biggest problems is: uploading is slow. Everyone complains
about it. It's the fault of the ISP though.

This is why the plugin for iPhoto resizes before upload,
optionally. Does Flex have this capability? Skimming through my two
Flex books, it looks like it. It's a big step to making a desktop app
that synchronizes the albums and photos on your desktop with those on
the server.

Anyway; most friends are now sharing photos on Facebook and
Myspace. What's notable here is the social networking came
first. Where we beat them is in offering finished products; and will
the social networks survive? My instinct says no, because they are
for-profit ventures that must inevitably make money, and efforts to
make money will probably ruin them; and people will probably drop out
of them after tiring of them. I'm not saying they are a flash in the
pan, no; I'm saying that a fatigue sets in, you get tired of the
people who post every little thing because they are dying for
attention, you get the Michael Normans who are posting crap from their
jobs... whereas Avalonians would probably pay a minimum fee to stay
connected year over year. The dropout rate is remarkably low.

Well that's a tangent. The point is... what happens to photo sharing
in the future? There's a need to get the images directly off the
camera to somewhere on the Net. Camera phones continue to improve. I
should think the savvy types will shoot with their camera and the
images uploaded nearly immediately, slowly, to conserve
bandwidth. Probably sorted by datetime, and later the user can
tag/sort them. It's really a matter of *the path of least resistance.*
Uploading and sharing photos is a hassle. It should be as direct as
possible.

This now comes back to the idea of developing iPhone or Android
applications, but that means phones and licensing and restrictions all
have to evolve to support it. But they probably will.

On the other hand, the G10 is now something like 14MP, which is kind
of silly.

So... two paths here: the snapshot from the camera phone, instantly
shared; and the more sluggish handheld jumbo image files, slow uploads
and all that. Seems we're stuck competing with Snapfish et al in the
latter category.

---

Here's how Jacob's stuff worked. There's a column in a table,
gift_archive_disc, with a column of type TEXT. He stored an array of
mpa_id's as a pipe delimited list:

albumItemsIds: 13868|13869|13870|13871|13872|13873|13874|13875|....

These mpa_id's were (past tense) the IDs of the photos as stored in
the mpa_albumitems table.

When we moved data centers in the fall of 2006, this table was lost
because Chris dumped the database to a text file using the default
settings that mysqldump uses... so the table mpa_albumitems was one
long string.

When he tried to load this 10GB table into the new database, he got a
"String too long" error, and so we gave up on the table at that point
because there were too many things to deal with at the time.

So Jacob's UI relies on a feature that no longer exists.

---

Renaming files. How about: only if we need to? If the name has some
wonky thing about it -- too long, contains funny chars -- we rename
it.

Conversely we can just name it with the ID from the database.



#########################################################################
081110 Mon 10 Nov 2008 10:29:43 AM EST

It was slightly gratifying to hear from Fernando how much Jacob hated
the cd/dvd project. HATED IT. Me too. It's a mind numbingly tedious
awful boring project.

Well, we can visit each photo since we do anyway. filesize is the PHP
function. I can reuse Ronny's du() on the album. I can cook up a
testbed.

Thought: user adds photos or whole album to disc. Keep internal
running count of the bytes. Can do this in Javascript along with the
session.

So, the fun really begins now. Until now quantity.php in products only
handled single photo items and expects a photo ID to be passed
in. Time to refactor.



#########################################################################
081111 Tue 11 Nov 2008 09:28:09 AM EST

[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
AIM IM with typolesbo.
9:22 AM
typolesbo: youi in?
typolesbo: what did you want up calling the class for the t-shirt?
typolesbo: they are all faliking for m
typolesbo: e?
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
Wainstead \ . o O ( need... more... coffee... first... )
[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
9:25 AM
Steve Wainstead: ORNAMENT_PORCELAIN_T_SHIRT
Steve Wainstead: is that what you want?
typolesbo: tahst fine
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
You say, "had i not been reading about quantum mechanics on the way in this morning that exchange 
might have baffled me"
draco [to Wainstead \]: a porcelain t-shirt sounds quite uncomfortable
Wainstead \ [to draco]: all i know is it's a christmas ornament. go figure.


Oddly, I've been looking at order_prints.php and picking away at the
JavaScript; and then thought, why am I even looking at this page? I'm
working on picking images for DVDs and CDs.

---

Today I've been mucking around a lot with DOM scripting. Why? Well,
the code in order_prints.php is spaghetti, and I was looking at the
state of the art in 2008 for separation of concerns. Way back in 1999
or so, I wrote up a thing at the NYTimes saying we should put all our
javascript at the end of the page file, and dynamically add all
functionality that way. This is the approach espoused in my book "DOM
Scripting." Today's browsers and JS are much more supportive of this
approach.

So I worked on a toy page, discovering along the way that every
element now has an onclick() event handler, which is why some evil
pages out there always pop an ad when you click on any text. Bastards.

And then I started in on jQuery, because noone on staff really
understands how it works; it turns out (according to Wikipedia) it's
garnering a lot of industry support (even MS!). I think this might be
because of a) a plugin approach, making it more lightweight to load
versus prototype.js, and 2) the wacky syntax style it supports because
every call returns the query object.

$('some-selector').callone().calltwo().callthree().callfour().end();

Actually from the jQuery "How It Works" page:

$("a")
   .filter(".clickme")
     .click(function(){
       alert("You are now leaving the site.");
     })
   .end()
   .filter(".hideme")
     .click(function(){
       $(this).hide();
       return false;
     })
   .end();

Which, at first blush, looked kinda unreadable to me but I suppose
it's not so bad. Kind of FP, really. Probably the appeal. Functional
programming has been cool again in recent years. "Chainability" is
what the jQuery author calls it.

Onwards... turns out the 'shop' pages are loading two versions of
jQuery; in fact, there's three versions (and four copies) in the
static project. Sigh. Jessy removed the older version from the page
but it broke something on the right side of whichever page she was
looking at. So there's something that will have to be figured out. But
I can depend on jQuery being present whatever I do.

My toy page:

<html>
<script type="text/javascript" src="jquery.js"></script>
<style>
p {
 color: darkslategray;
 background: lightskyblue;
}

a.test { font-weight: bold; }
</style>

<script>

function blippy() { alert('need a date?'); }

function swapem() {
    $("a").addClass("test");
    /*
    var paa       = document.getElementById("poopagraph");
    var pee       = document.getElementById("doink");

    var accumulator = "";
    for (var prop in paa.style) {
        accumulator += prop + "\n";
        pee.style["prop"] = paa.style["prop"];
    }
    foo = new window();
    foo.document = accumulator;
    */
}

function plooklinks() {
    document.getElementById("swainimg").onclick =  function foo() { alert("hello, sailor!"); };
    var pees = document.getElementsByTagName('p');
    //alert("pees length: " + pees.length);
    
    for (x = 0; x < pees.length; x++) {
       //alert("setting " + x);
       pees[x].onclick = blippy;
    }
    
    // changing the style
    document.getElementById("mebutton").onclick =  function changeColor() { 
        pee                  = document.getElementById("poopagraph");
        pee.style.color      = "navajowhite";
        pee.style.background = "blue";
        $("a").removeClass("test");
    };

    document.getElementById("youbutton").onclick = swapem;
}

window.onload = plooklinks;

$(document).ready(function(){
   // Your code here
/*
   $("div").click(function(event){
     alert("i am god, you are god, we are all god");
     event.preventDefault();
   });
*/
   $("a").click(function(event){
      event.preventDefault();
      $(this).hide("slow");
   });

// generate markup
   $("#rating").append("Please rate: ");
   
   for ( var i = 1; i <= 5; i++ )
     $("#rating").append("<a href='#'>" + i + "</a> ");
   
   // add markup to container and apply click handlers to anchors
   $("#rating a").click(function(e){
     // stop normal link click
     e.preventDefault();
     
     // send request
     $.post("sandbox/rate.php", {rating: $(this).html()}, function(xml) {
       // format and output result
       $("#rating").html(
         "Thanks for rating, current average: " +
         $("average", xml).text() +
         ", number of votes: " +
         $("count", xml).text()
       );
     }); // end $.post
   }); // end call to $("#rating a").click


});



</script>

<body onload="plooklinks();">
<div>
clickable div. click me.<br>
<a href="http://wainstead.info/">hello there sailor boy</a>
</div>
<p class="foofoo" id="poopagraph">
here is me.<br>
<img id="swainimg"
     src="http://wainstead.info/images/drinkingsmall.png">
</p>

<input name="mebutton" id="mebutton" type="button" value="drink me">
<input name="youbutton" id="youbutton" type="button" value="lick me">
<p class="foofoo" id="doink">
spare paragraph
</p>

<div id="rating"></div>

</body>
</html>


Oh, one reason Dylan's stuff might not work when Jessy pulls the older
file: I noticed it uses what might be an older way of running code
after the DOM load:

	// Accordain left nav
	    jQuery().ready(function(){
	        // accordian markup
	        jQuery('#gift_shop_nav').accordion({
	            header: '.head',
	            navigation: true,
	            fillSpace: true,
	            animated: 'slide'
	        });
	        
	    });


The new way is:

$(document).ready(function() {
   $("#orderedlist").addClass("red");
 });


But that might not matter. It's probably backwards compatible.



#########################################################################
081112 Wed 12 Nov 2008 03:55:02 PM EST

If anything I should consolidate Tree's code down to only a couple
files, so I can throw out what's not being used; then make the
remainder comprehensible.



#########################################################################
081113 Thu 13 Nov 2008 10:28:19 AM EST

Did spend time in Tree's AJAX dungeon yesterday. What a tangled
mess. Should clean that up.

I realize now I had select_cd.php in the gifts project, and that's
wrong. order_prints.php is in gallery and this is the correct
approach. A reminder:

Gallery can load things from Gifts but NEVER the other way around.

Bill's struggling to get a rollout done on the cart.


Bill: His documentation sucks
Bill: I have to reverse engineer everything to figure out how its done
10:35 AM
Bill: ok got it checed in and tagged

---

Back from Martha Stewart. I've come to see Tree's code for what it is:
sort of a rogue library. I'd imagine this is a common problem in group
software development.

So while exploring the stuff that uses Tree's code I found that ecards
are broken, and probably have been for some time. I suppose I should
write a test for that with lhhreplay. Even putting the card
directories back into mpa_products did nothing. I wonder how long
ecards have been broken. Probably since July 2008.

Oh! So... my original plan was to factor out the ajax calls from the
photo selection grid. That is, when you are choosing photos each photo
has a button and some javascript it calls... and I want that
javascript to be added at runtime instead of wired in. So the basic
plan was to do this:

1) Pull the javascript out, and add it after the page load.
2) Make that javascript added based on which page it's loaded in.

But first I spent a load of time reading how jQuery works, then
diagnosing why we load two versions of jQuery in our pages (still
unsolved), and then I started spelunking around in Tree's code. Which
lead to the discovery that ecards are broken. I've now updated
Gallery's store.php to load order_prints.php correctly (Gallery's, not
Product's), and threw in select_cd.php which moved over from gifts,
and all looks OK for the moment (except nothing works yet).

Now. Selecting photos and albums. Oh! I started with the DVD code. I
should go back to that. Get DVDs working first, and then down to the
level of picking individual photos for a CD.

I think the issue was: selecting a DVD led to a test if the whole site
would fit, which I think I solved, and then we land on quantity.php
which breaks because it expects a single photo. So that has to be
factored out somehow. That was where I left off.

Further into the code, it was an unexpected redirect that took me a
while to track down; and that would be in the context album or photo
class, which is really bad coding on my part. It's not for those
classes to decide if we redirect to albums.php or not. Probably should
just be a fatal error.



#########################################################################
081114 Fri 14 Nov 2008 10:08:18 AM EST

Well, ecards have been phased out and the link to them was
errant. Good to know.

---

For ordering prints we are now down to only order_prints.php and
ajax.php loading Tree's code. There was one place, points.php, that
used a couple of his functions, and two other things: ecard.php and
editor.php that were calling his code. Both were dead.

When you load order_prints.php, the javascript function call to add a
print or album to cart calls ajax.php with a bunch of POST data. If
you order the entire album, all the photo's ids are sent via ajax and
a function is called recursively to add them all to cart.

Also the file ajax_check.php is loaded in order_prints.php and gives
them a noscript tagset if they are deemed inferior.

I don't think I need to fudge with quantity. Just add to cart. This
makes it even more like order_prints.php.




#########################################################################
081117 Mon 17 Nov 2008 02:37:42 PM EST

Well. Had a 10:30 with Chris, to go over his ideas for restructuring
the filesystem... and he was completely anal retentive. Wouldn't share
or engage at all. Bill gave me an odd backwards glance when we left
the fishbowl. So virtually nothing came out of that.

Tim has an idea of using reversed userid's to replace the five levels
deep hierarchy. Simple, elegant and I like it.

/mnt/nfs is replacing /mnt/slow. Not sure what that gains us, but oh
well.

I debugged the swfupload stuff -- there's a new set of params it
needed -- and committed it. Fernando didn't quite make it to the
finish line on that so I had to resolve it. Took only an hour or so.

Grepped for /mnt/slow, found some instances, wrote it up to ops and
dev lists.

Did all the setup and testing for the rollout tomorrow. By 5pm didn't
feel like starting something else, so downloaded the ecmascript 4
validator; which is a binary, run by a shell script, where you can
interactively play with ecmascript.



#########################################################################
081202 Tue 02 Dec 2008 11:32:08 AM EST

Back from Japan. Watching Jessy assemble her figurines from Akihabara
was hilarious.

Not as much email as I'd have worried about. Things were pretty smooth
while I was away. Two things to tackle for Bill: itemize the cron
jobs, and investigate 200 emails sent by mup-2.

Also a missing product ID in the store log yesterday.

---

So... no answer on alaskadream3. This site somehow sent 200+ emails to
the same guy in a couple seconds, on Nov 26th in the early 8 AM. What
I see in the log makes no sense, unless: a bot script was logged in as
that user and sent 200+ share emails. To what purpose?



#########################################################################
081203 Wed 03 Dec 2008 03:01:44 PM EST

In retrospect, I wonder why I load everything in Veracity and then
compare. There's no reason why it can't work album per album, is
there? Something about the recursion?

The nesting is really a human-perceived thing, because it's all
really just an array and they all sit on the filesystem. So it might
be much more lightweight to dispense with the recursion.

No, I seem to have some memory of arguing this with Chris. There was
some cause for doing it recursively. Then again I'm so tired I can
hardly see.





#########################################################################
081204 Thu 04 Dec 2008 10:32:56 AM EST

At the end of the day yesterday I found out what ailed veracity. It
was a total newbie mistake by Chris.

     2      swain     $album_nc[$albumname]++;
     2      swain     if ($album_nc[$albumname] > 1) { 
    79      swain         glog("Oops: second time I've looked at '$albumname'!\n");
     2      swain         return;
     2      swain     }
    45      chris     elseif ( $album->isRoot() ) {
    45      chris 		// Drop dis bitch into the DB -- it is root so it needs an entry in db and
    45      chris 		// it needs id's in it's datz file
    45      chris 		insertNewAlbum( $album );
    45      chris 	} 
    45      chris 	else { 
    45      chris 		$albumDB = new AlbumDB();
    45      chris 		if (! $albumDB->getAlbumbyName( $album->fields['parentAlbumName'], false ) ) {
    45      chris 			$album->fields['desc'] = "DARKMATTER";
    45      chris 			insertNewAlbum( $album, -1 );
    45      chris 			return;
    45      chris 		}
    45      chris 			
    45      chris 	}
     2      swain 

Here, Chris creates a new copy of AlbumDB every time explodLP() is
called. Since he didn't pass in FALSE, the default is to load all
albums every time. For my site, 211 albums, and nearly two seconds
required to create a new copy of AlbumDB that way, up to seven minutes
was added to the runtime ((211 * 2) / 60). I think it was closer to a
second plus a fraction, since the runtime was typically around 400+
seconds.

Runtimes are now down to about 11 to 14 seconds versus 411.

I've added some new timing data to the output of showTime(), and there
are a few areas where runtime is a tenth of a second or more, the most
being 1.0 seconds at the end when data structures are compared.

   Comparing collections. time passed: 10.265383958817 (8.8930130004883E-5)
   swain: mass storage check: No corresponding sized for: album09 100_1101.sized.jpg
   swain: gallery data check (sized): Missing full sized image: album09 100_1251.jpg or 100_1251.flv
   swain: gallery data check (thumb): Missing full sized image: album09 100_1251.jpg or 100_1251.flv
   swain: There were 3 failures in the fs collections.
   Done comparing collections. time passed: 11.266204833984 (1.0008208751678)

Wound up working on Veracity all day, and monitoring it. Blew away
almost 2K of my own pix, sadly, when I introduced a bug to it.



#########################################################################
081205 Fri 05 Dec 2008 09:44:02 AM EST

Two terabytes freed by Veracity!

Bill: That program is the sweetness
Steve Wainstead: yeah, totally worth the time i invested in it the last two days
Bill: All of my volumes in the red or yellow have backed down
Bill: thank you thank you!

Not quite sure what to make of the sites with no config.php. They fall
into clumps of dates. Very few from 2008. Seems most have no site at
all anymore. Hmm. Fast storage was lost?

2.51572062 terabytes freed so far. I'm moving the run over to osc-2 to
see if the numerous unlink errors go away.


3.0500345 terabytes freed, all told. Also computed and sent the
numbers on album skins, which show once again that they are largely a
waste of Jessy's expensive time, but who am I to say.





From:   swain@myphotoalbum.com
Subject: [MPA Dev] Final numbers from veracity
Date: December 5, 2008 5:44:35 PM EST
To:   dev@myphotoalbum.com
Cc:   peter@myphotoalbum.com, ops@myphotoalbum.com, jessy@myphotoalbum.com
Reply-To:   fcdev@corp.myphotoalbum.com


I just finished up the last few hundred sites. Here's the good news and the bad news.

Good:
3.09 terabytes freed up.
2,895,301 files removed.

Bad:
2,514 missing individual albums across 102 sites (on the slow storage).

136 sites with no "albums" folder on the mass storage (i.e. all of their full sized images are gone).

26 sites with broken albums or some other fatal error.

386 sites with no config.php file; however, I think that most of these are either deleted sites or the config file couldn't be loaded due to NFS errors. I'll revise this number after Veracity runs again, which will be over the weekend.

There may be more bad news as I have a gigabyte or so of log files to grind through, looking for oddities.

--------
Steve Wainstead
Director of Software Development
http://www.myphotoalbum.com/
(212) 981-8609


Fcdev mailing list
Fcdev@corp.myphotoalbum.com
https://mail.corp.myphotoalbum.com/cgi-bin/mailman/listinfo/fcdev





#########################################################################
081208 Mon 08 Dec 2008 09:45:43 AM EST

Reread my log on the cd/dvd stuff. Good thing I wrote it down; forgot
90% of what I'd done.

http://www.usps.com/shipping/trackandconfirm.htm
03081400000007187973

Ran Veracity on the remaining sites -- some 2K of them -- that were
missed due to fatal errors.

(re)Invented the algorithm for 50% off 2nd item.

one minus (percentage divided by two) equals percentage to multiply
the subtotal by.

1 - (50% / 2) == .75

Now, why doesn't that work for third item 50% off?

$20 each, three items. Total should be $50.

1 - (50% / 3) == .833333
$60 * .833 == 49.999

So that does work, tho there's a bit of fudging there.



#########################################################################
081210 Wed 10 Dec 2008 10:57:07 AM EST

Well. By Tom's numbers I'm out of vacation days. I'd just as soon stay
home for Christmas, but Mom would cry a river.

Out sick yesterday. Feeling much better today but still getting hot
flashes.

We are now behind on book/calendar orders going back to December
4th. Everything we send is "coming through corrupted" according to
Rastar. This is a crock because we compare byte sizes of the file
locally and remotely after transfer, and they are the same. They
switched us to another FTP server with the same results.

---

After some thought, creating a new $10 club membership for first
timers creates a problem: recurring billing is going to charge them
$10 next year. The anally retentive solution: add a club membership to
the cart and add an offer at the same time. Currently there's no way
to do this, so it's time to add a new feature.

Lesson for the day: you cannot add a new coupon/offer inside of
calculateEverything() because you're putting the cart before the
horse. You must add a new coupon/offer prior to calculating
everything.

So, done and done. All four of Jessy's promo requests are now
feasible, if you know how to do them. (Therein lies the trick). It's
some combination of creating an offer, passing it via GET, and testing
the cart's contents.

Got approval from Peter to work from home second half of tomorrow so I
can wait for the cable guy.



#########################################################################
081211 Thu 11 Dec 2008 11:34:32 AM EST

Wrote a tiny fix for Veracity, in classes/Album.php, to test if the
instance is an AlbumItem. Tested on osc-2, looks good. Wonder if
there's lots of sites with arrays of stdClass instances? Which might
actually work.

Meanwhile, I have to work out the rule set for fixing sites. I pledged
to fix all of them.

1) No mass storage "albums" folder: create.
2) Album on fast but not on slow: create folder, copy all sized images
over.

This requires no checking with Gallery; it can consist of pure
filesystem operations.

3) Not on fast but it's on slow, Gallery says it's not there: this is
already implemented. Delete the slow album.

4) Missing fast storage: Gallery has it, slow has it, fast does
not. Then we need to recreate everything. I think for this phase we'll
not do this, as it's a bit complicated.

Stated another way, the goal now is to fix dark energy.

Add to the list: 27 sites with no users listed in the subusers
table. Does this prevent the admin from logging in? Probably. One is a
club member.

---

Well, working at home. Cable fixed. Guy had to run a new line over the
roof. Meanwhile, I lost my sql shellbuffer due to an mdb-1
reboot. Suck. Which really doesn't make sense.

OK, after some krufty hacking, Veracity now creates a new "albums" on
the nfs storage; creates any missing album folders on same; copies the
sized version over if the full sized one is missing; and creates a
config.php file if it's missing. What's left: some sites are missing
users, so they need fixing; missing display files: if they are truly
missing then they need to be recreated. (We'll know because Gallery
says the album exists).



#########################################################################
081212 Fri 12 Dec 2008 03:32:30 PM EST

Veracity was dying on sites that had no fast storage... bummer. So
around 400 or 500 of the processes never finished. I worked out the
"ghosts" that caused this, cooked up a sql script and removed them
from the database. Debugged my config.php regeneration code, been
rerunning veracity on the failed name ranges, and everything looks
good now. Also, 

root@osc-2:/home/www# wc -l filescopied
19735 filescopied

Now I have to gear up another run.

To do:
1. Handle all movie file types.
2. Fix sites with no users.
3. Replace missing sized/thumbs when there's a full size (i.e. fix
   dark energy).
4. Fix or dispose of ghosts.
5. Find corpse data? Maybe much later.

Which I'm probably missing something, but now I'm thinking about
moving albumdb.dat off the filesystem. Hmm.



#########################################################################
081215 Mon 15 Dec 2008 09:26:43 AM EST

Spent a chunk of yesterday (Sunday) reading my Facebook Cookbook from
O'Reilly. Seems we could do a fair amount of integration with them. I
think we can display Facebook albums on MPA, and with some effort,
vice versa. The real trick is can we tag the photos? It doesn't look
like it so far.

Some confusion as Bill wants to switch over to the svn copy of
mpa_signup. It will stay in the same place, which is what mixed me up.

Bill gave me a link to VirtualBox, some Sun owned thing for
virtualization. Free. I can install XP this way.




#########################################################################
081216 Tue 16 Dec 2008 11:33:28 AM EST

Looking at the sites with no admin users again... thinking about a
simple fix. Perhaps this can be a "self healing" hack where: if
username/password  match that in mpa.users, and there's no matching
rows in mpa_sites_subusers, then insert new rows into
mpa_sites_subusers and mpa_subusers to fix it.

Meanwhile, the algorithm to fix the currently broken sites goes like
this:

generate uid
insert into mpa_sites_subusers (uid, site_id, isAdmin,
canCreateAlbums);
insert into mpa_subusers (uid, 'admin', 'Administrator', hashed
password, email, etc etc.

The only minor challenge here is to encrypt the password again.

Now, it turns out, we are still provisioning the user dat files, which
is a waste of space and inodes. Interesting. On the upside, this means
the data for the missing sites is on the filesystem. I could use a
mini-run of Veracity to fix them.

Since we're going to remove all the user dat stuff anyway, it would
probably be better to code Veracity to fix the sites from scratch
rather than depend on the dat files.

I can't make random uid's though, because I think the uid is written
into an album.dat file.



#########################################################################
081217 Wed 17 Dec 2008 10:16:43 AM EST

Thinking: http://facebook.myphotoalbum.com/swain. I wonder if this
creates any problems? Should I generalize the URL?
applications.myphotoalbum.com? Hmm. I'm tempted to go down the road of
doing away with the config.php file and getting the Gallery object
going. It's like this huge set of projects that keep resurfacing that
need doing. I was also pondering the idea of storing album instances
in the database, sans a few externally required pieces of data (like
highlight, theme) and using Chris's schema for the photos. I don't
think we need the photos stored in pickled form. Do we? Bleh. They
have an owner field.

There just doesn't seem to be any other way than to do an audit of all
the fields in config.php that the user has access to... kind of a
bummer.

Walking around thinking: I can just grep stuff out of the
shortform.php file, or chop up the "view form" stuff in Firefox.

Neither: here's a dump from a script I wrote, looping on $_REQUEST,
that shortform.php posted to it:

this_page                   => defaults
next_page                   => fcconfirm
print_photos                => Array
showAlbumTree               => no
highlight_size              => 200
showOwners                  => no
editPassword                => Array
showSearchEngine            => yes
emailOn                     => yes
emailGreeting               => 
selfReg                     => no
selfRegCreate               => no
multiple_create             => no
gallery_slideshow_type      => ordered
gallery_slideshow_length    => 
gallery_slideshow_loop      => yes
comments_anonymous          => yes
comments_display_name       => !!FULLNAME!! (!!USERNAME!!)
bordercolor                 => black
border                      => 1
font                        => verdana
resize_file_size            => 0
max_size                    => off
max_file_size               => 0
fit_to_window               => no
use_fullOnly                => no
extra_fields                => Description
showDimensions              => no
item_owner_modify           => yes
item_owner_delete           => yes
item_owner_display          => no
poll_type                   => critique
poll_scale                  => 5
poll_hint                   => 
poll_orientation            => vertical
poll_nv_pairs               => Array
poll_num_results            => 5
slideshow_type              => ordered
slideshow_recursive         => no
slideshow_loop              => yes
slideshow_length            => 0
emailSubjPrefix             => MyPhotoAlbum
rssHighlight                => *
rssMaxAlbums                => 25
rssVisibleOnly              => yes
rssDCDate                   => no
rssBigPhoto                 => no
rssPhotoTag                 => yes
go_next                     => Save
galleryTitle                => i got a lust for life
skinname                    => red
gallery_thumb_frame_style   => none
album_frame                 => none
albumsPerPage               => 5
cols                        => 3
rows                        => 3
add_to_beginning            => no
thumb_frame                 => none
image_frame                 => none
thumb_size                  => 200
resize_size                 => 1024
useOriginalFileNames        => yes
comments_indication         => both
comments_indication_verbose => no
rssEnabled                  => yes
rssMode                     => thumbs
display_clicks              => yes
voter_class                 => Nobody
poll_show_results           => no
show_profile_tab            => yes
show_hotvideos_tab          => no
adminEmail                  => swain@hahahoho.com
senderEmail                 => swain@hahahoho.com
preserve                    => +galleryTitle+editPassword+albumDir+tmpDir+photoAlbumURL+albumDirURL+movieThumbnail+mirrorSites+graphics+pnmDir+pnmtojpeg+ImPath+autorotate+jpegImageQuality+showAlbumTree+highlight_size+showOwners+albumsPerPage+showSearchEngine+skinname+gallery_thumb_frame_style+zipinfo+unzip+use_exif+cacheExif+use_jpegtran+default_language+ML_mode+available_lang+show_flags+dateString+dateTimeString+locale_alias+emailOn+adminEmail+senderEmail+emailSubjPrefix+emailGreeting+selfReg+selfRegCreate+multiple_create+email_notification+gallery_slideshow_type+gallery_slideshow_length+gallery_slideshow_loop+comments_indication+comments_indication_verbose+comments_anonymous+comments_display_name+timeLimit+debug+use_flock+expectedExecStatus+sessionVar+userDir+devMode+adminCommentsEmail+adminOtherChangesEmail+maximumAlbumDepth+bordercolor+border+font+cols+rows+thumb_size+resize_size+resize_file_size+max_size+max_file_size+useOriginalFileNames+add_to_beginning+fit_to_window+use_fullOnly+print_photos+returnto+display_clicks+extra_fields+showDimensions+item_owner_modify+item_owner_delete+item_owner_display+voter_class+poll_type+poll_scale+poll_hint+poll_show_results+poll_num_results+poll_orientation+poll_nv_pairs+slideshow_type+slideshow_recursive+slideshow_loop+slideshow_length+album_frame+thumb_frame+image_frame
albumDir                    => $GALLERY_USERDIR/albums
tmpDir                      => $GALLERY_USERDIR/tmp
photoAlbumURL               => http://swain.myphotodevel.com
albumDirURL                 => http://images.myphotodevel.com/s/sw/swa/swai/swain/swain/albums
movieThumbnail              => $GALLERY_USERDIR/images/movie.thumb.jpg
graphics                    => ImageMagick
pnmDir                      => /usr/bin
pnmtojpeg                   => pnmtojpeg
ImPath                      => 
autorotate                  => yes
jpegImageQuality            => 90
zipinfo                     => /usr/bin/zipinfo
unzip                       => /usr/bin/unzip
use_exif                    => /usr/bin/jhead
cacheExif                   => no
use_jpegtran                => /usr/bin/jpegtran
default_language            => 
ML_mode                     => 0
available_lang              => Array
show_flags                  => 
dateString                  => %x
dateTimeString              => %c
locale_alias                => Array
timeLimit                   => 30
debug                       => no
use_flock                   => no
expectedExecStatus          => 0
sessionVar                  => gallery_session
userDir                     => $GALLERY_USERDIR/albums/.users
devMode                     => no
adminCommentsEmail          => no
adminOtherChangesEmail      => no
maximumAlbumDepth           => 3
returnto                    => yes
mpa_popup                   => true
menutitle                   => -1c
/setup/shortform_php        => 1|sc2
mpa_fqdn                    => http://atticaccount.myphotodevel.com
fcwt                        => atticaccount
PHPSESSID                   => nlpjdq29ogknae12vciooagce6
acopendivids                => featured
acgroupswithpersist         => nada


But this doesn't help me a whole lot... still need to go through each
item, determine what it's for (if anything), and if it should go into
the database or not. I need to make the smallest possible table of
user settable parameters.

Audit complete, remarkably:

# set these at runtime:
adminEmail                  => swain@hahahoho.com
senderEmail                 => swain@hahahoho.com
albumDir                    => $GALLERY_USERDIR/albums
tmpDir                      => $GALLERY_USERDIR/tmp
photoAlbumURL               => http://swain.myphotodevel.com
albumDirURL                 => http://images.myphotodevel.com/s/sw/swa/swai/swain/swain/albums
movieThumbnail              => $GALLERY_USERDIR/images/movie.thumb.jpg
# obsolete:
userDir                     => $GALLERY_USERDIR/albums/.users



# not settable by user:

slideshow_type              => ordered
slideshow_recursive         => no
slideshow_loop              => yes
slideshow_length            => 0

# "gallery" slideshow stuff is obsolete
gallery_slideshow_type      => ordered
gallery_slideshow_length    => 
gallery_slideshow_loop      => yes

adminCommentsEmail          => no
adminOtherChangesEmail      => no
poll_nv_pairs               => Array
available_lang              => Array
locale_alias                => Array
editPassword                => Array
maximumAlbumDepth           => 3
debug                       => no
use_flock                   => no
expectedExecStatus          => 0
sessionVar                  => gallery_session
timeLimit                   => 30
show_flags                  => 
dateString                  => %x
dateTimeString              => %c
ML_mode                     => 0
ImPath                      => 
autorotate                  => yes
jpegImageQuality            => 90
default_language            => 
poll_show_results           => no
devMode                     => no
returnto                    => yes
poll_type                   => critique
poll_scale                  => 5
poll_hint                   => 
poll_orientation            => vertical
poll_num_results            => 5
resize_file_size            => 0
max_size                    => off
max_file_size               => 0
fit_to_window               => no
use_fullOnly                => no
extra_fields                => Description
showDimensions              => no
item_owner_modify           => yes
item_owner_delete           => yes
item_owner_display          => no
bordercolor                 => black
border                      => 1
font                        => verdana
comments_anonymous          => yes
comments_display_name       => !!FULLNAME!! (!!USERNAME!!)
multiple_create             => no
graphics                    => ImageMagick
pnmDir                      => /usr/bin
pnmtojpeg                   => pnmtojpeg
zipinfo                     => /usr/bin/zipinfo
unzip                       => /usr/bin/unzip
use_exif                    => /usr/bin/jhead
cacheExif                   => no
use_jpegtran                => /usr/bin/jpegtran
selfReg                     => no
selfRegCreate               => no
emailOn                     => yes
emailGreeting               => 
emailSubjPrefix             => MyPhotoAlbum
showOwners                  => no
rssHighlight                => *
rssMaxAlbums                => 25
rssVisibleOnly              => yes
rssDCDate                   => no
rssBigPhoto                 => no
rssPhotoTag                 => yes
rssMode                     => thumbs
showSearchEngine            => yes


# are indeed settable by user:
display_clicks              => yes
useOriginalFileNames        => yes
voter_class                 => Nobody
galleryTitle                => i got a lust for life
skinname                    => red
gallery_thumb_frame_style   => none
album_frame                 => none
albumsPerPage               => 5
cols                        => 3
rows                        => 3
add_to_beginning            => no
thumb_frame                 => none
image_frame                 => none
thumb_size                  => 200
resize_size                 => 1024
rssEnabled                  => yes
highlight_size              => 200
show_profile_tab            => yes
comments_indication         => both
comments_indication_verbose => no
showAlbumTree               => no
# this one is a bit more complicated. The Premium class uses it to
# determine if printing is allowed, but there's the other older
# printers listed too, which we don't need.
print_photos                => Array




# "preserve" was a mechanism used by Gallery to store the previous values, I think...

preserve                    => +galleryTitle+editPassword+albumDir+tmpDir+photoAlbumURL+albumDirURL+movieThumbnail+mirrorSites+graphics+pnmDir+pnmtojpeg+ImPath+autorotate+jpegImageQuality+showAlbumTree+highlight_size+showOwners+albumsPerPage+showSearchEngine+skinname+gallery_thumb_frame_style+zipinfo+unzip+use_exif+cacheExif+use_jpegtran+default_language+ML_mode+available_lang+show_flags+dateString+dateTimeString+locale_alias+emailOn+adminEmail+senderEmail+emailSubjPrefix+emailGreeting+selfReg+selfRegCreate+multiple_create+email_notification+gallery_slideshow_type+gallery_slideshow_length+gallery_slideshow_loop+comments_indication+comments_indication_verbose+comments_anonymous+comments_display_name+timeLimit+debug+use_flock+expectedExecStatus+sessionVar+userDir+devMode+adminCommentsEmail+adminOtherChangesEmail+maximumAlbumDepth+bordercolor+border+font+cols+rows+thumb_size+resize_size+resize_file_size+max_size+max_file_size+useOriginalFileNames+add_to_beginning+fit_to_window+use_fullOnly+print_photos+returnto+display_clicks+extra_fields+showDimensions+item_owner_modify+item_owner_delete+item_owner_display+voter_class+poll_type+poll_scale+poll_hint+poll_show_results+poll_num_results+poll_orientation+poll_nv_pairs+slideshow_type+slideshow_recursive+slideshow_loop+slideshow_length+album_frame+thumb_frame+image_frame


(end audit)

So the steps to take are: 
0) New database table for site config data (done)
1) new PHP script that the shortform POSTs to, which updates the
   database... (put a hook in init.php instead)
2) new PHP script that contains all the ones not settable by the user (done)
3) runtime code to set the dynamic ones (e.g. photoAlbumURL) (done)
4) Signup wizard populates the new table, does not create a config.php
   file from template. This can come later though.
5) Shortform pulls data from new sources instead of
   config.php... actually, once we've created a $gallery the shortform is
   good to go. (done)
6) Veracity run to move everything into db
7) also get rid of all the .users stuff

For a page view, we need to build a $gallery up; this can first test
the database, and if it's not in there, load config.php instead. I can
use a Veracity run later on to port it all to the database. This would
have to be after the signup wizard was updated.

Also: demotion code needs updating.



#########################################################################
081218 Thu 18 Dec 2008 10:35:24 AM EST

So... back to thinking about albumdb. Perhaps "sort order" is
something I should store in a separate table, away from the actual
list of albums... but if I do that, then it suggests that mpa_albumdb
should just get another column and we be done with it. Hrmm. We still
have to go fetch all the albums anyway, because we need to check the
permissions before displaying them. Thus... at a top level, we're
interested in: sort order, perms, highlight, title&c. User-defined
sort order is a pain.



#########################################################################
081219 Fri 19 Dec 2008 10:51:31 AM EST

Christmas party last night. T'was fun! We were at Down The Hatch and
played beer pong.

I found the bug in the shortform has been there a while (it's on
production at this very moment). Filed a bug report for Jessy; I
commented out the offending line, 1625, in the shortform.

//changeImg("<?php echo  STATIC_SERVER ?>/themes/" +  '<?php echo $gallery->app->skinname ?>' + "/screenshot.jpg");

There's a new JS error popping up now, but I can't see putting much
effort into fixing it. I think Jessy will probably do a major revamp
of the way sitewide config is handled.

---

Fixed a stupid bug in the new shortform design; I was passing the
string "yes" instead of "checked." Branched veracity (why have I never
thought of that before?) and made a version that ports the config data
and deletes everything else... the files are tiny, but numerous. We'll
blow away one or two million files, most of them not being used.

Order of the rollout must be this:

1) db patches applied. This creates the needed table,
   mpa_sitewide_config.
2) Roll out Gallery, which is bilingual, so to speak.
3) Roll out signup wizard, which provisions the new way.
4) Run veracity, to port the config data and clean up the filesystem.





#########################################################################
081222 Mon 22 Dec 2008 12:40:22 PM EST

Did a lot of groundwork for mpa_core today. Jessy wants to start
putting things into it already; I was thrown for a loop when she
became excited about putting things for www into it... which I never
anticipated. But she and Dylan want to rid themselves of .shtml files
(SSI) and Tim is somehow involved in this decision, in that Google
indexing won't be affected if they are PHP files.

Bill rolled out the mpa_signup wizard, and that was Bad. It was the
new version that didn't provision config.php anymore.



#########################################################################
081229 Mon 29 Dec 2008 01:08:34 PM EST

Back from vacation.

Was late to the conference call because I didn't know we were having
one! I never saw the official word that we're all allowed to work
remotely today. Bill has set up VPN stuff for us.

I tested the new configuration setup on staging, all looks good. First
I applied the database patches. Gallery didn't work; my experimental
work on porting AlbumDB into Mysql was in the way, staging having an
older version of Gallery (but was newer than production). I rolled
Gallery back to the production copy, tested, everything was OK.

I then updated it to latest from Subversion. That also tested out OK.

Next, I found the signup wizard wasn't updated on staging yet, so I
checked out HEAD into ~www, checked out trunk/conf/stg into
~www/mpa.svn/conf, and then used root to move the old to /opt/mpa-cvs
and mv ~www/mpa.svn to /opt/mpa. And it all worked!

I updated Veracity on staging and ran it; all the data was ported to
the database (into mpa_sitewide_config, that is). I then tweaked this
branch of Veracity to blow away the config.php file as well, and all
was well.

I deleted ez_sql from mpa_cart today, and Fernando reported the admin
interface for OSCommerce had failed. Tracked that down, ammended the
library search path in admin/includes/appliation_top.php and that
solved it. He sees the "hello sailor" image from home though when he
hits his store.

One semi-scary thing though is mpa_core is already a dependency.



#########################################################################
081230 Tue 30 Dec 2008 10:09:07 AM EST

In at normal time; Dylan surprised me when he showed up. I left the
door locked because I thought I'd be alone.

Set up a virtual host for myself, swainwww.myphotodevel.com. It points
at my build of mpa_www. I then tested to see if we can do away with
loginpage2.php, which seems to be the case (passing uname/pw directly
to loginpage.php works correctly) so I've committed everything and we
can now see if loginpage2.php can be dropped. I hope so. It was a
workaround to some bizarre PHP bug.

It's a sauna in here today. Just spent time connecting a monitor and
keyboard to Calvin to see why it won't boot. Second boot was the
charm.




#########################################################################
090105 Mon 05 Jan 2009 03:07:09 PM EST

Wednesday I worked from home all day. I found that one cannot access
the store sites on torque; you get the root of the image server, I
think. It says "Hello sailor! need an image?"

I was working on the problem of the extraction of all GET/POST/COOKIE
params into the global namespace, via the PHP function extract(). This
happens in init.php, and creates a number of security workarounds to
try to prevent people from modifying internal variables, such as
$GALLERY_BASEDIR. The correct answer is to treat tainted data as
tainted data, and leave them in the superglobals. This tells you where
they come from, as well. Here's a sample of the logging I was doing:

/albums.php extracted 26 POST vars: config_changed,go_next,galleryTitle,skinname,gallery_thumb_frame_style,album_frame,albumsPerPage,cols,rows,add_to_beginning,thumb_frame,image_frame,print_photos,thumb_size,resize_size,useOriginalFileNames,comments_indication,comments_indication_verbose,rssEnabled,rssMode,display_clicks,voter_class,poll_show_results,show_profile_tab,adminEmail,senderEmail

/albums.php extracted 2 GET vars: displayGalleryStyle,currentItem

/captionator.php extracted 10 POST vars: page,perPage,action,newAlbumTitle,newmodcaptionription,new_captions_1,extra_fields,new_keywords_1,new_captions_2,new_keywords_2

/create_or_add.php extracted 1 GET vars: set_albumName

/create_or_add.php extracted 3 POST vars: action,newAlbumTitle,newAlbumDescription

/do_command.php extracted 2 GET vars: return,cmd

/download.php extracted 2 GET vars: set_albumName,id

/email_invite.php extracted 1 GET vars: page

/gallery_remote2.php extracted 2 POST vars: cmd,protocol_version

/gallery_remote2.php extracted 5 POST vars: cmd,protocol_version,set_albumName,caption,force_filename

/import_emails/import.php extracted 5 POST vars: username,password,Submit_x,Submit_y,Submit

/import_emails/import.php extracted 6 GET vars: spimport,book_style,KeepThis,TB_iframe,height,width

/import_emails/import.php extracted 8 POST vars: allbox2,allbox,formname,sender,addresses,submit_x,submit_y,submit

/inc/share/albumpushxml.php extracted 2 GET vars: set_albumName,whatType

/index.php extracted 1 GET vars: yPosition

/invite_friends.php extracted 6 POST vars: emails,fromName,message,email_action,x,y

/links-badges.php extracted 5 GET vars: set_albumName,index,id,FromShare,type

/links.php extracted 4 GET vars: set_albumName,index,id,FromShare

/links-slideshow.php extracted 5 GET vars: set_albumName,index,id,FromShare,type

/links-text.php extracted 5 GET vars: set_albumName,index,id,FromShare,type

/loginpage.php extracted 1 GET vars: returnpage

/loginpage.php extracted 4 POST vars: returnpage,uname,gallerypassword,referer


One simple solution is to go through each file and test/set the
variable:

$returnpage      = $_GET['returnpage'];     
$uname           = $_GET['uname'];          
$gallerypassword = $_GET['gallerypassword'];
$referer         = $_GET['referer'];        

though one should test with isset(), I suppose:

isset($_GET['returnpage']      ) && $returnpage      = $_GET['returnpage'];     
isset($_GET['uname']           ) && $uname           = $_GET['uname'];          
isset($_GET['gallerypassword'] ) && $gallerypassword = $_GET['gallerypassword'];
isset($_GET['referer']         ) && $referer         = $_GET['referer'];        

very Perlish, probably illegal in PHP. Let's see: Hmm. Seems
legal. Still, the old terenary operator could provide a default where
needed, but I think we test if the variable holds anything. Perhaps
array_key_exists()? 

"isset() does not return TRUE for array keys that correspond to a NULL
value, while array_key_exists() does."

Says the manual. So:

array_key_exists('returnpage',      $_GET ) && $returnpage      = $_GET['returnpage'];     
array_key_exists('uname',           $_GET ) && $uname           = $_GET['uname'];          
array_key_exists('gallerypassword', $_GET ) && $gallerypassword = $_GET['gallerypassword'];
array_key_exists('referer',         $_GET ) && $referer         = $_GET['referer'];        

The trial:

#!/opt/php5/bin/php
<?php

$_GET = array();
$_GET['returnpage'] = 1000;

array_key_exists('returnpage',      $_GET ) && $returnpage      = $_GET['returnpage'];     
array_key_exists('uname',           $_GET ) && $uname           = $_GET['uname'];          
array_key_exists('gallerypassword', $_GET ) && $gallerypassword = $_GET['gallerypassword'];
array_key_exists('referer',         $_GET ) && $referer         = $_GET['referer'];        

print "$returnpage\n";
print "$referer\n";
print isset($uname) ? "yes\n" : "no\n";
?>


I wound up throwing out about 100 lines of hidden variables in
shortform.php as a result of this auditing; I also found three vars
that weren't being set. Today I found one that was getting set to zero
every time (highlight_size) and took it out of the UPDATE query in
DBConn.

I thought I should add a flag, a constant, that if defined, I can
collect the GET/POST data on production. It would be much faster than
doing it by hand. The output could be parsable, and a script can
generate the headers for all the files.

Done. I can define a constant now and toggle logging once we roll out.

Oh... so...having dispensed with config.php for all time, this puts us
one step closer to having a proper Gallery class, whose instance we'll
fetch via Gallery::getInstance(). Oh, maybe that's where I can wrap
the thing so we get it from memcached. That is, I don't want to query
the database every time for the stuff in mpa_sitewide_config. It does
a join on mpa.users to get the email address.

Hmm. Something about calling loadConfig(). I feel lethargic
lately. I'm glad the holidays are over, really... now it's the cold
colorless stretch to Valentine's Day.



#########################################################################
090106 Tue 06 Jan 2009 05:05:36 PM EST




#########################################################################
090107 Wed 07 Jan 2009 11:23:01 AM EST

No entries yesterday; spent the better part of the day in meetings,
mostly about the Dotphoto thing.

Nothing anywhere on how to build the iPhoto plugin. Way to go,
Chris. And I didn't document it anywhere it seems.

Thinking over the DVD thing... which Jessy basically wouldn't take no
for an answer on yesterday... Acutrack is the company, so I need to
create a bunch of stuff in the database for them. One database patch
coming up.

typolesbo: is it difficutl to do the zip
Steve Wainstead: oot
typolesbo: of an antier
typolesbo: album
Steve Wainstead: anteater?
typolesbo: entire
typolesbo: album
Steve Wainstead: anteater albm... no, i don't think it would be
typolesbo: I want ot trun downloing on for eveyrone

anteater album: an album and its entire contents

Need to add an ArchiveDVD class to the cart... and map the archive DVD
product to it.

Problem: quantity.php expects to have a "selected photo." This won't
be the case for DVDs however. What to do.

Hmm. Need to add more product info, this time for mpa_products. And
with mpa_core now existing, we can finally put the kibosh on this
nonsense! But it would require a semi-huge refactoring of the cart and
product product classes into one big shebang.

Todo:
1) Add the needed stuff in mpa_products_groupings, mpa_whateversis
   tables for mpa_products project.
2) Add shipping class for Acutrack
3) generate ISO
4) build table and populate it with the user's album choices
5) rejoice (maybe)





#########################################################################
090108 Thu 08 Jan 2009 03:22:51 PM EST

[Type lines of input; use `.' to end or `@abort' to abort the command.]
----------------text pasted by Wainstead \ to Emrys' Tavern----------------
typolesbo: that should be fixed
typolesbo: can you search for
typolesbo: something
typolesbo: but it will need to be
typolesbo: 2 times?
typolesbo: does that make sence?
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
Mars Polar Lander . o O ( abend )
heller says, "holy shit. . .only 1 typo and it's still incomprehensible! "
Wainstead \ [to heller]: we played Set for the first time in months and i *almost* beat her. i 
couldn't believe it.
You say, "turns out what she meant was: search all files for a line that appears twice"
heller says, "that girl should be the subject of numerous studies of how the brain works. "




#########################################################################
090109 Fri 09 Jan 2009 10:06:03 AM EST

Get off at Hamilton, the Northeast Extension.

http://www.njtransit.com/sf/sf_servlet.srv?hdnPageAction=TrainSchedulesTo

http://www.njtransit.com/sf/sf_servlet.srv?hdnPageAction=TrainSchedulesTo

Call Bill once I reach Princeton Junction.

---

Fixed three bugs I filed for Jessy; she's been engrossed all day
trying to get the two new Aurigma tools done. Our cert expires today,
so thereafter our users will see a "cert expired" warning when they
upload with the old Aurigma tool.

Worked out release stuff for Bill; turns out mpa_products and
mpa_gallery are codependent at the moment, old mpa_products wanting to access
files in Gallery that have moved off to mpa_core... and new
mpa_products won't work with old gallery either.

Hot damn! All I had to do was copy the latest GalleryContext class to
the current production branch, and that solved the problem. So we need
to:

1) update the current Gallery release
2) roll out mpa_products
3) roll out mpa_gallery





#########################################################################
090114 Wed 14 Jan 2009 02:43:04 PM EST

Rolled out mpa_core and then mpa_products, which works; but there's
things missing because mpa_static cannot update until the uploader is
working. Jessy's been working like crazy on the uploader for days now.

Meanwhile, I've been handed a task to make Trialpay more
generic. We're going to sell club memberships and 50 free prints now,
so I have to modularize trialpay.php in mpa_cart. Which I'm working
on.

The first problem becomes: clubhelper.class.php does the clubifying,
but it depends on an Order class, or at least an order ID.

Wow, looking at some Jacob/Tree code. Fucking horrible:

     59:    function _redeemFreePrints10() {
     93:    function _redeemFreePrints25() {
    127:    function _redeemFreePrints50() {

and:

        $query = "SELECT offer_id FROM osc_offers_description WHERE offer_name='(points) 50 free prints'";

Well, the stuff works, so what can you do?

---

How to merge from trunk to branch?

swain@torque:~/public_html/projects/mpa_core$ svn switch https://svn.corp.myphotoalbum.com/mpa_core/tags/R_2009_01_14_initial_release
U    lib/SelectedPhoto.class.inc
U    inc/core_javascript.inc
U    inc/core_header.inc
Updated to revision 27.
swain@torque:~/public_html/projects/mpa_core$ svn info
Path: .
URL: https://svn.corp.myphotoalbum.com/mpa_core/tags/R_2009_01_14_initial_release
Repository Root: https://svn.corp.myphotoalbum.com/mpa_core
Repository UUID: ff5c9cf9-2359-0410-9f81-d21499b4376b
Revision: 27
Node Kind: directory
Schedule: normal
Last Changed Author: bill
Last Changed Rev: 21
Last Changed Date: 2009-01-14 11:25:31 -0500 (Wed, 14 Jan 2009)

swain@torque:~/public_html/projects/mpa_core$ svn merge -r 21:HEAD https://svn.corp.myphotoalbum.com/mpa_core/trunk .
U    inc/core_javascript.inc
U    inc/core_header.inc
swain@torque:~/public_html/projects/mpa_core$ svn commit -m "Merging changes from trunk to this release branch"
Sending        inc/core_header.inc
Sending        inc/core_javascript.inc
Transmitting file data ..
Committed revision 28.
swain@torque:~/public_html/projects/mpa_core$ svn switch https://svn.corp.myphotoalbum.com/mpa_core/trunk
U    lib/SelectedPhoto.class.inc
Updated to revision 28.


Now, I'm not sure why the last set of changes didn't merge over but
when I checked the branch on staging, the two core*inc files had the
correct fixes.



#########################################################################
090115 Thu 15 Jan 2009 02:39:46 PM EST

Getting Gallery out required restarting the Apache servers; then
everything was OK. Actually, the first rollout failed because
uploading didn't work; Jessy committed a new PHP include file for the
Aurigma tool, which has the wildcarding license key I think, and then
everything worked. I forgot the signup wizard had to immediately
follow, so it was maybe an hour where confirmations failed (no
config.php.template file anymore). I had Bill update the signup wizard
from the trunk, I did a complete signup with uploads and everything
was good. Configuration is in the DB now too.

Fixed a bug in the cart, where finish === NULL, and added a test to
make sure the subdomain is valid.



#########################################################################
090116 Fri 16 Jan 2009 03:34:11 PM EST

Whipping trialpay.php into shape. Some notes:

1) merchant.trialpay.com for access to our stuff
2) notifcation key is on the "my account" page
3) You can test by: setting the script called to
store.myphotodevel.com, except you can't do this while the thing is
live or real Trialpay transactions post to the dev server.
4) then clicking Test Product, entering details, and choosing the
first product listed, which is the Trialpay test product.

Been refactoring points/func.php. Lot of magic numbers and
globals. Ferreted out most of them. I am wondering now if I should
just use the function to upgrade them to club membership rather than
digging around in the cart code; in fact I will, as it should be
faster.

Bleh. I see now that getMPAUserID() does not insulate us from the
global $gallery. It just wraps it. Actually I knew that. Hmm. We can't
use $gallery in Cart-land. Well, actually, I could try to wrap
$gallery in a Gallery class, or make it an instance of, but... I don't
want cart code to depend on this stuff. Maybe Trialpay doesn't belong
in the store code? I'd have to change the database instance being
used, and the logging calls.

Well, oddly, zip bam boom and it was done. What now? I need to load
the site, so to speak... hmm.





#########################################################################
090119 Mon 19 Jan 2009 10:06:40 AM EST

Oh, on Friday I threw out the server variable pointing at the start of
the "five levels deep" directory structure. This has been a fixture in
init.php since the first days of mpa.

if ( ! $_SERVER['MPA_GALLERY_ROOT']) { //fail }

Read most of the "Deploying Rails" book over the weekend. Excellent
book.

Slightly sidetracked into looking at why there are errors in the
Apache error log for "no such directory 'emoticons'." The cause is
older comments, and in this case spam comments on
sample5.myphotoalbum.com.


     'comments' =>
    array (
      0 =>
      Comment::__set_state(array(
         'commentText' => 'great',
         'datePosted' => 1119805365,
         'IPNumber' => '85.96.47.150',
         'name' => 'save315@yahoo.com',
         'UID' => 'everybody',
      )),
      1 =>
      Comment::__set_state(array(
         'commentText' => '<img src="../emoticons/omg.gif"> this modern half',
         'datePosted' => 1131566412,
         'IPNumber' => '208.54.15.1',
         'name' => 'bobby',
         'UID' => 'everybody',
      )),


Thus, the link is inaccessibly embedded in the object and
unreachable. So the need arises to pull comments out of the AlbumItem
objects themselves.

So... where's Chris's schema?

DROP TABLE IF EXISTS `mpa_albumitem_comments`;
CREATE TABLE `mpa_albumitem_comments` (
  `comment_id`   int unsigned NOT NULL auto_increment,
  `albumitem_id` int unsigned NOT NULL default '0',
  `name` varchar(256) default 'unknown',
  `body` text default '',
  `created_at` timestamp NOT NULL default now(),
  `UID` varchar(256) default 'EVERYBODY',
  `user_id` int unsigned NOT NULL default '0',
  `from_ip` int unsigned NOT NULL default '0',

  PRIMARY KEY (`comment_id`),
  -- these come later
  -- KEY `albumitem_id_idx` (`albumitem_id`),
  -- CONSTRAINT `mpa_albumitems_cmfk_1` FOREIGN KEY (`albumitem_id`) REFERENCES `mpa_albumitems` (`albumitem_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

I need  a dump of a simple comment. Or rather, a fairly complete
comment:

  1 => 
  AlbumItem::__set_state(array(
     'image' => 
    Image::__set_state(array(
       'name' => 'P1010263',
       'type' => 'jpg',
       'width' => 1024,
       'height' => 768,
       'resizedName' => 'P1010263.sized',
       'thumb_x' => NULL,
       'thumb_y' => NULL,
       'thumb_width' => NULL,
       'thumb_height' => NULL,
       'raw_width' => 2560,
       'raw_height' => 1920,
       'version' => 25,
    )),
     'thumbnail' => 
    Image::__set_state(array(
       'name' => 'P1010263.thumb',
       'type' => 'jpg',
       'width' => 200,
       'height' => 150,
       'resizedName' => NULL,
       'thumb_x' => NULL,
       'thumb_y' => NULL,
       'thumb_width' => NULL,
       'thumb_height' => NULL,
       'raw_width' => 200,
       'raw_height' => 150,
       'version' => 25,
    )),
     'caption' => 'look it\'s mike\'s kitchen',
     'hidden' => NULL,
     'highlight' => true,
     'highlightImage' => 
          Image::__set_state(array(
             'name' => 'P1010263.highlight',
             'type' => 'jpg',
             'width' => 200,
             'height' => 150,
             'resizedName' => NULL,
             'thumb_x' => NULL,
             'thumb_y' => NULL,
             'thumb_width' => NULL,
             'thumb_height' => NULL,
             'raw_width' => 200,
             'raw_height' => 150,
             'version' => 25,
          )),
     'isAlbumName' => NULL,
     'clicks' => NULL,
     'keywords' => '',
     'comments' => 
          array (
            0 => 
            Comment::__set_state(array(
               'commentText' => 'These names are getting pretty old. hey, wtfbbq. <img src="http://swainstatic.myphotodevel.com/emoticons/sleepy.gif"> 
                   so here\'s a url:
                   http://sample5.myphotoalbum.com/view_photo.php?set_albumName=Sicily&id=P9240020
                   
                   and a link:
                   <a href="http://wainstead.info/">wainstead.info</a>
                   so there!',
               'datePosted' => 1232387674,
               'IPNumber' => '10.1.1.209',
               'name' => 'wain wcwain',
               'UID' => 'everybody',
            )),
    ),
     'uploadDate' => 1230742554,
     'itemCaptureDate' => 
    array (
      'hours' => '00',
      'minutes' => '00',
      'seconds' => '00',
      'mday' => '00',
      'mon' => '00',
      'year' => '0000',
    ),
     'exifData' => NULL,
     'owner' => 'nobody',
     'extraFields' => 
    array (
      'phid' => 0,
      'mpa_id' => NULL,
      'Description' => 'can i live in the garage?',
    ),
     'rank' => NULL,
     'version' => 25,
     'emailMe' => NULL,
     'debug' => false,
  )),


Hmm.

foreach album
  foreach albumitem
    if has comments:
      foreach comment:
        insert into db
        affix comment_id to albumitem
save if updated

The AlbumItem will need to store a comment ID, and probably have the
same transitional code setup that I did for config.php. That is, wrap
loading of comments in loadComments, or something similar; if the
comment_id is set, pull it from the database; else if there's an
array, use that. This differs from the config.php situation in that
there is *always* a config.php, but here there usually will not be a
comment.

Once all the comments are ported, the process of culling splinks out
should be easy; but this means that the AlbumItem should expect to
have comment IDs that point to nothing, and probably shouldn't do
anything. Or display "<comment deleted>". When the day comes that
AlbumItems can be in the database, we can ferret those out too.

I don't think I've ever manipulated AlbumItems in Veracity before.

Well. Veracity just deleted all my photos. It was because I short
circuited the loop in explodeLP. I think it was, anyway. I should not
have used 'continue.'

---

Was just looking into an account, 'helencockeram', who had no
config. She was deleted for not buying anything; she must have gone
through the signup, not confirmed, then bought a club membership.

I didn't get anywhere near trialpay yet! I found all the functions
were being passed args but the signatures had nothing.

---

Now I have everything strung together, and Trialpay correctly adds 50
free prints, or upgrades to club membership; the last detail though is
it deducts the corresponding amount of points, which it shouldn't. So
I have to somehow separate those behaviors.

Alternately, I could just pass in a flag, but that's not so exciting.


#########################################################################
090120 Tue 20 Jan 2009 02:57:28 PM EST


Waiting for the IRS woman to call me. Waiting is truly the hardest
part. Had to have Jessy talk me down a bit in the conference room,
which really helped.

I got all the Trialpay stuff working, so I moved it to torque and
tested with a new site; nothing. I had to work out what was making it
not work (silent errors), and fixed all that. Seems to be A-OK now.

So while I'm thinking of it, anything "points" related should probably
come out of the redemption class. redemption has enough to do as it
is; monkeying with the points system should be something else.

We'll need a way for users to view their available coupons now. The
points history page just ain't the place.


---

Getting all the current codes for a user... no wait, these aren't
filtered out for usage...

select cc.validation_code, od.offer_description from osc_coupon_codes
cc, osc_offers_description od where cc.offer_id = od.offer_id and
cc.subdomain='swain';

SELECT cc.validation_code, od.offer_description
FROM osc_coupon_codes cc, osc_offers_description od
WHERE cc.offer_id = od.offer_id
AND cc.subdomain='swain' and uses_done < uses_allowed;

Now, a test to see what current offers exist that are available. No
wait, the previous doesn't filter on expire date:

SELECT cc.validation_code, od.offer_description
FROM osc_coupon_codes cc, osc_offers_description od
WHERE cc.offer_id = od.offer_id
AND cc.subdomain='swain' and uses_done < uses_allowed
AND cc.expire_date > now();

Anyhoo. We have to look at the infrequently-examined osc_orders_offers
table, eh? Hmm. Perhaps that should go in the cart.

Actually... shouldn't the comment have the ID of the albumitem it
belongs to? I think this should have to be... hrmm. Otherwise, I can
give every AlbumItem an array of Comment IDs, which will have to get
serialized into photos.dat. Which would remove some disk space,
probably not a whole lot, but there it is.

How about: if an albumitem gets a comment, it also gets a row in
mpa_albumitems? Possibly.

Tags are stored in the AlbumItem too. Unfortunate.



#########################################################################
090121 Wed 21 Jan 2009 09:51:23 AM EST

Looks like we'll be going with ezprints, at the moment, though fuji or
someone else might still be in the running.

I'm surprised the dotphoto deal is still alive; or else Peter is
stringing them along for now. Who knows?

Meanwhile, I realized now that the Trialpay project has hit a
roadblock because it wasn't spec'd and I don't know where to go from
here.

OK, Jessy is going to do the Trialpay thing now. I'll have to show her
how to test it.

Oh! I have to do a Veracity run. I created a branch for that, and now
that I think of it, for years I've had this script or that script that
I edit and make a few changes and run it; and next time I edit again
and change it, sometimes creating huge comment blocks of old code
because I don't want to lose it; often, not committing changes because
I will throw them out. Silly! Now I'll branch in Subversion so every
version will live forever, and having a "trunk" means I'll always have
the "default version."

---

Been doing housekeeping tasks while watching Veracity. All the
config.php data (that is user settable) is being ported into Mysql
today. All albums/.users directories and user.local.php files are
being deleted. Should free up around 2 million files. 

Just did a bunch of testing of the service outage types, and it's all
fucked up. Either they don't work anymore, or I'm just testing them
wrong.

Well. Veracity missed 21,000 sites. How is this?

mysql> select count(username) from users u left outer join mpa_sitewide_config sc on u.userid=sc.site_id where sc.site_id is null and u.status > 0 order by username into outfile '/tmp/users'
    -> ;
Query OK, 1 row affected (1.17 sec)

root@mdb-1:/home/www# wc /tmp/users
 21087  21088 231098 /tmp/users

This is a Bad Thing, since Veracity is supposed to visit every
site. Oh well; using an input file to Veracity directly. Let's see
where this goes. Oh, I looked at the site zoeybird, which was in the
result set of the above query; and indeed the site still had the
user.local.php file.



#########################################################################
090122 Thu 22 Jan 2009 10:13:41 AM EST

Still almost 900 user's configurations not ported into the database;
it seems they are ghosts though. Meanwhile, the continual messages
about "Warning: desktop file appears to be in use by PID NNNNN" "Using
it may cause conflicts.  Use it anyway?" when I start Emacs appears to
be due to a change in Emacs behavior:

https://bugs.launchpad.net/ubuntu/+source/emacs-snapshot/+bug/163342

Well, I'm stymied because one of the slow volumes is not working,
which causes things to hang. Hmm; site loads though.

--

Long lunch with Jessy. Very fun! I described GEB to her, which is
coincidental since I've been listening to The Musical Offering so much
lately.

---

Am looking at the way users now login from activate.cgi. A five letter
code is passed, which is compared to a hashed version in Gallery's
mpa_subusers table. There's no salt so presumably this might have a
hole. Not terribly worried about it. Not sure how it gets set
though...

How logging in via the hash works:

1) In activate.cgi, first the five letter code is create:

# for password hash
local $unix_time = mktime(localtime(time));
local $rec_pass_hash = substr( (md5_hex( $password . $userid . $unix_time ) , 0, 5) );
local $recoverPassHash = md5_hex($rec_pass_hash);

2) This five letter code is used to create the link to the welcome.php
page:

    $continue_url =
    "http://$username.$service_name/welcome.php?hash=$rec_pass_hash";

3) Then, the hash is used in the INSERT into mpa_subusers;

    &CreateUserinfo($userid,
                    $firstname,
                    $lastname,
                    $gender,
                    $birthdate,
                    $country,
                    $postalcode,
                    $income,
                    $sid,
                    $directorylist,
                    $$hash{'email_address'},
                    $recoverPassHash
                    );

4) In Gallery, in welcome.php:

    if ($tmpUser->checkRecoverPasswordHash($hash)) {
        stderr("The correct hash passed in for admin of {$gallery->app->subdomain}.. need to delete hash and log customer in");
        $password = $dbconn->getPassword($gallery->app->subdomain);
        if(loginUser($gallery->app->subdomain, $password)) {
            stderr("welcome.php: login credentials are correct.. logged customer in");
            $tmpUser->genRecoverPasswordHash(true);
            $tmpUser->save();
        }

The recover password hash is set to null by Gallery.

So... to do this from www.myphotoxxxx.com:

1) User enters uname/pw.
2) Test against users table.
   if success: generate hash, place in mpa_subusers
               create a link to albums.php with five letter code
   if fail:
            compare username to those in mpa_subusers.
             if found, compare pw to existing pw. There might be many
             matches though.

Note they might also use their email address. So all of the above has
to work for either username or email address.

Currently, logging in via email address from www doesn't work. After
some exploratory surgery, I found that it's because I put the email
address into the userMap associative array in the instance of
UserDB. So the username or the email address are used to return an
instance of Gallery_User, and then we test the password against that.

First, I should come up with a function that returns the five letter
code that is used to make the recoverPassHash in mpa_subusers. This
could be used in a variety of places; in fact, maybe the method does
that for me...

    function genRecoverPasswordHash($reset=false) {
        if ($reset) {
            $this->recoverPassHash = NULL;
            return "";
        }
        $rec_pass_hash=substr(md5($this->password.
                                  $this->uid.microtime()), 0, 5);
        $this->recoverPassHash = md5($rec_pass_hash);
        return str_replace("&amp;", "&", makeGalleryUrl('pops/new_password.php', array('hash' => $rec_pass_hash, 'uname' => $this->getUsername())));
    }

Sad. Why is it creating the link? This should be external to the
method. Or this method should be renamed genRecoverPasswordHashLink.



#########################################################################
090126 Mon 26 Jan 2009 09:56:47 AM EST

The previous entry is probably a combination of Thursday and Friday
both; I think I didn't start a new entry. I should probably just
commit my log once a day.

Just spent about an hour correcting a mistake Jessy made. She made a
lot of edits to shopping_cart_cb.php, but she was editing an older
copy; when she tried to commit there were conflicts, and she claims
her "tool deleted the file" and she committed her new version. This
blew away some changes I added, namely, code to display archive DVDs.

As mad as I am, I should have set her up on a branch so she could do
her mass changes without blocking anyone. Currently the cart is
unusable.

Detective work: had to figure out how I implemented "half off club
membership" for Jessy. Through a combination of svn's logs, svn diff,
this log, the database patch I created, and finally searching our AIM
conversations I sorta pieced it together. The little include file has
the logic for printing the "add a club membership" box. I created a
HALFCLUB promo code, and the URL for the little button in the "add
club membership for 'foosite'" needs to pass in the promo code as GET
data... like so: coupon_code=HALFCLUB.

---

Changing a password via the console works pretty much as I'd expect it
to:

>> advert = Advertiser.find(1340)
=> #<Advertiser id: 1340, last_name: "Wainstead", email_address: "wainstead@test.myphotodevel.com", first_name: "Steve", address_id: nil, hashed_password: "3bf2bed93c95aa09b1e9e351798b9772862f9d55", salt: "264759200.302024459639434", updated_at: "2009-01-07 18:07:37">
>> Advertiser.instance_methods(false)
=> ["credit_card_ids", "loaded_address?", "address=", "email_address_confirmation", "salt=", "updated_at=", "last_name?", "email_address=", "before_save_associated_records_for_emails", "hashed_password", "hashed_password?", "before_save_associated_records_for_photographers", "set_address_target", "emails=", "convert_to_lower", "photographers", "credit_card_ids=", "email_address_confirmation=", "validate", "password", "address_id", "first_name?", "last_name", "after_create_or_update_associated_records_for_credit_cards", "validate_associated_records_for_emails", "password_confirmation", "updated_at?", "hashed_password=", "validate_associated_records_for_photographers", "credit_cards", "email_ids", "create_new_salt", "photographers=", "password=", "address_id=", "address_id?", "last_name=", "photographer_ids", "before_save_associated_records_for_credit_cards", "create_address", "password_confirmation=", "salt?", "first_name", "credit_cards=", "has_one_after_save_for_address", "address", "email_ids=", "salt", "updated_at", "email_address", "email_address?", "after_create_or_update_associated_records_for_emails", "after_create_or_update_associated_records_for_photographers", "photographer_ids=", "validate_associated_records_for_credit_cards", "build_address", "emails", "first_name="]
>> advert.password= "112233"
=> "112233"
>> advert.save
=> true
>> 

Here we pass "false" to instance_methods so we only see the ones we
defined, versus all the parent class's methods.

This also works for Admin objects, though I have to set the email
address too now.


>> swain = Admin.find(2)
=> #<Admin id: 2, name: "swain", hashed_password: "b4c2b9b32986b1d8bc3cf8072d6e67d47d167465", salt: "274681400.668135973477284", email_address: nil>
>> swain.password= "11223344"
=> "11223344"
>> swain.save
=> false
>> swain
=> #<Admin id: 2, name: "swain", hashed_password: "8a28b7de0ceaf8202d2e4209280ed9e282dc223a", salt: "267547000.945877848510301", email_address: nil>
>> swain.email_address = "swain@myphotoalbum.com"
=> "swain@myphotoalbum.com"
>> swain.password="11223344"
=> "11223344"
>> swain.save
=> true
>> swain.password="112233"
=> "112233"
>> swain.save
=> true
>> 

I purged the GeoKit stuff from the vendor/plugins directory, and had
to comment out a bunch of stuff in environment.rb, and make Search no
longer a... er... no longer mixin the functionality of GeoKit.

Also, Admin.find_all won't work (deprecated). Instead it's
Admin.find(:all).

---

Yay! I finished the implementation of lost admin password for
MPP. It's also very Rails 2.2.2 compliant now. My last bug was really
quite simple; I should have just thought about it a little longer.

Now on to bigger and better things... I really should go all out to
implement a mini CRM system in it. Maybe. People tend to like their
email clients better... I wonder how Parature handles this.



#########################################################################
090127 Tue 27 Jan 2009 09:46:47 AM EST

I also need to take a look again at how the credit card editing stuff
is working, which lives in a separate Rails project.

---

After I updated mpp_credit_card to work with Rails 2.2.2, I went
looking for a solution for the much-missed dynamic scaffolding. The
project ActiveScaffold requires you to do stuff with the layout; but
having started with nothing but the dynamic scaffold, I had no layout,
and adding one threw errors. So I gave up on that, branched, threw all
the old code out, created a new codebase from scratch, created a
static scaffold the new way and committed. All was happy, but I think
it's a dumb loss for Rails to have moved that out of the project and
then effectively abandoning it.





#########################################################################
090128 Wed 28 Jan 2009 04:41:49 PM EST

Meetings; then, resolving coupon issues for Jessy, changing/testing
the domain name change to images.mxx.com/images over static.mxx.com,
fixing a bug in the cart where jQuery wants a function $() and so did
Tree's library; Javascript does need namespaces. Some help to Fernando
on svn merging; researched Trac a bit; read up on Subversion and
managing multiple projects... I'm not sanguine about Bill's desire to
unify the projects into one plate of spaghetti. Mmm. Spaghetti.

Oh, installed svn-bisect and ack, which are neat tools.

---

Been trying to get llhreplay working on my Mac but it's bitching about
not being able to call 'new' on some module...



#########################################################################
090129 Thu 29 Jan 2009 09:55:09 AM EST

Trying to find out where, on development, the image URLs inserted into
the cart have http:// instead of https://.

Been testing the store... found some minor bugs and filed them. More
for me than Jessy, it turns out. Earlier I was solving issues she had
with her build of www, and got that rectified. Horror of horrors, all
the CVS directories were committed to SVN. I mass deleted them.




#########################################################################
090130 Fri 30 Jan 2009 09:53:18 AM EST

Yesterday Bill deployed MPP to osc-1 via Capastrano. I tested all the
features, we solved some configuration bugs and it looks like it's
live. Peter replied to a couple of the system emails this morning
(saying he got them).



From:   peter@myphotoalbum.com
Subject: FW: MyPhotoPro - Contact Inquiry
Date: January 30, 2009 9:17:01 AM EST
To:   swain@myphotoalbum.com
Reply-To:   peter@myphotoalbum.com

fyi - received yesterday afternoon.

Is MPP almost ready to go?



-----Original Message-----
From: swain@myphotoalbum.com [mailto:swain@myphotoalbum.com] 
Sent: Thursday, January 29, 2009 3:51 PM
To: contact@myphotopro.com
Subject: MyPhotoPro - Contact Inquiry

The following Inquiry was submitted by steve wainstead.

This request falls under the topic Problem with website

The details of the query submitted are as follows:
does this contact form work or not?

To respond to steve wainstead
Phone: 917-723-3094
Email: swain@myphotoalbum.com

---

Had a weird error when I bought with Paypal earlier. I was redirected
to the login page after the purchase completed, instead of the order
completed page. Bought two more prints but couldn't duplicate it, even
though I cleared cookies and all. Can't do a test on development
either; looks like PP changed the way you do test purchases.

---

Fixed two bugs in the cart: jQuery and prototype.js were both being
loaded in the cart. I rewrote the email check to use jQuery, which
fortunately turned out to be simple.

The other bug involved the create_account form at the end of the
anonyous buyer path. This was a typical javascript bug: trying to
manipulate a form before it was defined.





#########################################################################
090202 Mon 02 Feb 2009 09:54:35 AM EST

Came in Saturday and repaired/rearranged my collages; then assembled
the one of Erin and Jeanne in Erin's car and took it home. Which
reminds me, I meant to bring in the cardboard tube I stole from
Lenny's desk.

Oh, end of Friday I cooked up a small project to test ActiveScaffold,
some gem for replacing dynamic scaffolding in Rails. Meh, it works. I
was researching either yesterday or Saturday the classic_paginate and
will_paginate projects, both from the same guy. I think I started a
project to test that too; here or at home? I forget.

-- export as csv example for mysql:
select *
into outfile '/tmp/uniq.csv'
fields terminated by ',' optionally enclosed by '"'
lines terminated by '\n'
from swain_test;

So... got will_paginate to work through some old fashion
hacking. Hacking away at it until it worked. I was missing one thing,
in the end, and that was to put the require statement in my
environment.rb file.

require "will_paginate" 

class UserController < ApplicationController

  def index
    @users = User.paginate :page => params[:page], :order => 'lastname, firstname'
    logger.info("got this many users: #{@users.length}")
  end

end


class User < ActiveRecord::Base
  cattr_reader :per_page
  @@per_page = 30
end


<table border="1">
    <% for user in @users -%>
       <tr><td><%= user.lastname %></td><td><%= user.firstname %></td><td><%= user.username %></td><td><%= user.email_address %></tr>
    <% end -%>
</table>


<%= will_paginate @users %>

fix paging in emacs:
git config --global core.pager ""

The first problem with storing a git-controlled project in svn is all
the new git objects don't get added to svn. That is, once you try it
you see how it's obviously stupid to do.

---

Bulk updated pagination in mpp. Yay.


   def list
-    @address_pages, @addresses = paginate :addresses, :per_page => 30
+    @addresses = Address.paginate :page => params[:page], :order => 'state_id, city'
   end




+        <%= will_paginate @addresses %>
 	
-	<%= link_to 'Previous page', { :page => @address_pages.current.previous } if @address_pages.current.previous %>
-	<%= link_to 'Next page', { :page => @address_pages.current.next } if @address_pages.current.next %> 


I didn't add the page limits to the model classes, even... so
upgrading is pretty simple in that respect.


---

Hacked in a search on company name, so the admin interface took huge
leaps today. Far more useable than before.



#########################################################################
090203 Tue 03 Feb 2009 10:40:28 AM EST

Fixing up the address editing in MPP. It's more useful now and I'm
going to scope it to state. I wonder how I'll get pagination to handle
that.

Just added two new config options for the shortform for Jessy; the
gallery display style (terrible name, should be "layout style") and
the album display (layout) style.


Bill: "/etc/init.d/mongrel_cluster restart" after you svn update :)

---

Fixed a couple of bugs on production with Bill. One involved a gem
being only available to www and not root. But the other involves
address records not associated with any advertisers. I put a test in:
if address.advertiser.nil? next
and this solved the problem. It logs them to the mongrel log for now.


Time to look at the rollout.

Done: staging has versions of everything same as production, but I
updated the cart. Fixed a bunch of typos in the template
class. Everything works. Had to update the conf file so we use secure
static image serving. Jessy says IE still complains about insecure
items; I wonder if it's because there's javascript popups that use
plain URLs.





#########################################################################
090204 Wed 04 Feb 2009 03:21:59 PM EST

Fixed an MPP bug this morning -- addresses were being looked up by
photographer ID, clearly an old dumb bug -- then, manager's meeting,
lunch, cart rollout, and a moving out meeting. Bill wants a 2U rack to
virtualize all the server room machines.

The cart rollout was OK, but there was a bug in the gallery.conf
(subdomain name was wrong) so static content wasn't serving.

I'm puzzled why there were data intergrity problems on mpp. Hmm. I'm
now thinking I should make credit card management a top priority since
the thing has to make money. I was going to abandon the
mpp_credit_card project, but I think that might do for admin
management of cards.

Copied a little tutorial on encrypting stuff in Ruby. Was really easy,
which is way cool.

Actually encrypted a fake credit card number! How about that.



#########################################################################
090205 Thu 05 Feb 2009 10:32:19 AM EST

Today: first time Tim was in on the morning standup. Fuji are here now
trying to sell their wares to us.

I now have a small testbed where credit card numbers are encrypted
into the database and decrypted when displayed for viewing or
editing. And I limit the field length to 16 as well. It seems there
was one more thing I wanted to do, but now I can't remember. Oh! Do
the regexp thing to display only ************1111.

Well... I have Emacs 22.1 on my Mac. Time to fix that.



#########################################################################
090206 Fri 06 Feb 2009 09:52:12 AM EST

Got Emacs 22.3 up; turns out all I needed to do was put git in the
PATH; which X11 didn't have, since it's started via the Dock. Edited
~/.MacOS/environment.plist and that fixed that.

I have all the info I need at hand to do a transaction with
Authorizenet, so that's the next step. Still no response on the blog
post I made on the "padding check failed" error:

 OpenSSL::PKey::RSAError in Creditcards#update

Showing app/views/creditcards/edit.html.erb where line #8 raised:

padding check failed

Extracted source (around line #8):

5: 
6:   <p>
7:     <%= f.label :ccnumber %><br />
8:     <%= f.text_field :ccnumber, :maxLength => 16, :size => 16, :value => @creditcard.get_decrypted_ccnumber %>
9:   </p>
10:   <p>
11:     <%= f.submit "Update" %>


This makes no sense: an OpenSSL::PKey::RSAError but the line in
question is in my template?

I want to decouple the encrypted credit card from the one used to
contact Authorizenet.


>> require 'active_merchant'
=> []
>> credit_card = ActiveMerchant::Billing::CreditCard.new(
  :number     => '4111111111111111',
  :month      => '8',
  :year       => '2009',
  :first_name => 'Tobias',
  :last_name  => 'Luetke',
  :verification_value  => '123'	
)

?> ?> ?> ?> ?> ?> >> => #<ActiveMerchant::Billing::CreditCard:0x3325ad4 @month="8", @last_name="Luetke", @first_name="Tobias", @verification_value="123", @year="2009", @number="4111111111111111">
>> ?> credit_card.valid?
=> true
>> quit
kristalle:~/svn/pgms/rails/ccexperiment swain$ 

i.e. my class is really EncryptedCreditCard; and we should probably do
all our work with the ActiveMerchant::Billing::CreditCard, which is
"built" by some method that takes an EncryptedCreditCard or has access
to one... and come to think of it an Advertiser might have two or more
credit cards... hmm.

Ah. ActiveMerchant::Billing::CreditCard has a display_number
method. Totally what I want. I need to flesh out a new algorithm. I
think Creditcard will be a wrapper to A::B::C, has-an A::B::C.


----------------text pasted by Wainstead \ to Emrys' Tavern----------------
AIM IM with typolesbo.
12:48 PM
typolesbo: lunch?
Steve Wainstead: sure
typolesbo: where2?
Steve Wainstead: anywhere
typolesbo: dinner?
Steve Wainstead: oh, you mentioned that yesterday
typolesbo: yea
Steve Wainstead: sure if you want!
Steve Wainstead: i can have dinner now, lunch later.
------------end of text pasted by Wainstead \ to Emrys' Tavern-------------
pasted to Emrys' Tavern
Wainstead \ waits to see if she gets it
You say, "we've been playing Set during lunch again lately, and two days ago it was three of us
versus her, and she still found more sets than the three of us combined"
heller says, "i'm telling you. . .she needs to have her brain studied. "
You say, "the new rule is she's not even allowed to look at the cards as I lay them down because
she's calling "Set!" before I'm even done"
heller . o O ( new rule: she's never allowed to look at the cards.  )
tiResias . o O ( now she only wins 75% of the time )

---

Lunch at Venus Diner, obviously. Have a dry spot in the back of my
throat so it's ColdEeze time. I'm thinking of starting over for the
credit card testbed project, because I can't do ALTER TABLE on my
version of sqlite3. (So says the internet).

Notable: git revert does NOT do what svn revert does. It undoes the
previous commit; and the git revert can be undone with another git
revert.

git reset --hard HEAD

This is the way to do an "svn revert" in git. Though apparently not a
very good way. I've used git stash for the time being.





#########################################################################
090209 Mon 09 Feb 2009 10:25:58 AM EST

Oh, installed (again) RMagick on Friday. I wanted to tinker a bit with
the notion of a photographer's portfoliio. I didn't finish "Ruby for
Rails" this weekend, unfortunately. I did learn some new ideas
though. The block thing: I get it on a nuts and bolts level at this
point. I'm still fuzzy on the scope of @ variables.

Again I'm wondering how it is that the cart is always in test mode on
development and staging but not on production. Sadly my Emacs
bookmarks hold nothing. Time to go spelunking.

There's a variety of ways. I should probably create a developer
account on Authorizenet; but you can just pass x_test_request=TRUE in
the POST data to AN. You can also call a testing url:
https://test.authorize.net/gateway/transact.dll. In Rails, with
ActiveMerchant, you do this, apparently:

ActiveMerchant::Billing::Base.mode = :test

at the top of your script or whatever.



require 'active_merchant'
ActiveMerchant::Billing::Base.mode = :test
credit_card = ActiveMerchant::Billing::CreditCard.new(
  :number     => '4111111111111111',
  :month      => '8',
  :year       => '2009',
  :first_name => 'Tobias',
  :last_name  => 'Luetke',
  :type => 'visa'
)
credit_card.valid? # returns false

credit_card.errors.full_messages.join() # returns "Verification value is required"

credit_card.verification_value=123
gateway = ActiveMerchant::Billing::AuthorizeNetGateway.new(:login => 'fortune212', :password => 'Nhd81yhjJPrI4FZz')


response = gateway.authorize(10000, credit_card)

# but i keep getting back:
#<ActiveMerchant::Billing::Response:0x32a9c68 @test=true,
#@params={"response_reason_text"=>"The merchant login ID or password
#is invalid or the account is inactive.",
#"response_reason_code"=>"13", "response_code"=>3,
#"transaction_id"=>"0", "avs_result_code"=>"P", "card_code"=>nil},
#@authorization="0", @success=false, @cvv_result={"message"=>nil,
#"code"=>nil}, @message="The merchant login ID or password is invalid
#or the account is inactive", @fraud_review=false,
#@avs_result={"message"=>"Postal code matches, but street address not
#verified.", "code"=>"P", "street_match"=>"N", "postal_match"=>"Y"}>

But it is successfully in test mode.

I also installed a ruby debugger gem on Friday and was stepping
through the app. Way cool. Mongrel drops you to an irb prompt when it
hits a breakpoint you set, via <% debugger %> I think.

In development.rb:
require "ruby-debug"

And somewhere in your ruby code do:

debugger

and that's the point you wind up in the interactive debugger. The
browser "waits" for the response to finish.





#########################################################################
090210 Tue 10 Feb 2009 12:07:41 PM EST

Managed to craft a form to enter credit card info. Saves to credit
card db. Hmm. Bet you can't get it out again. Nope. Well, data
validation was next anyway. Fixed. Man that was fast. I fixed that in
like twenty seconds.



#########################################################################
090211 Wed 11 Feb 2009 10:04:19 AM EST

Jessy out today; father getting an operation. Spent yesterday
afternoon testing Gallery, finding bugs and fixing typos. Fixed a
couple Javascript bugs too.

Last releases:


R_2009_01_14_aurigma_uploaders_and_core  gallery
R_2009_02_04_cart_using_core             cart
R_2009_01_14_initial_release             core
R_2009_01_14_switch_to_mpa_core          products

Found a bug where you can add your 15 free prints coupon to the cart,
and you're offered $10 off club membership; but adding the club to the
cart does not apply the discount. I disabled adding coupons from
order_prints for the time being, since Jessy's out today. I'm looking
at adding the ability to have more than one coupon/offer in the cart.

Well, the rollout failed, and it turned out because I forgot to check
if there were database patches (there were two). Bill is out to lunch,
so when he's back I'll apply them and we can roll out again.

I think my terminal problems -- where tailing the log files on
production start doing some weird buffer thing, "writing" the same
block of text over and over -- is an Expect bug on OS X. I found in a
plain xterm just running the Expect script that it got hosed.

OK, rollout finally done. Only Gallery went live. We had to restart
the mups to get around a bug from older files being cached.

Looking at upgrading pxn8; we didn't change a whole lot in the Perl
scripts that come with it. After I untar the latest version over my
copy from svn I get:

swain@torque:~/public_html/projects/mpa_gallery/pixenate$ svn stat
?      log
?      cgi-extra
?      styles
?      themes
?      docs
?      upload.pl
?      cache
?      images
?      license-agreement.txt
?      lib
?      generate_fonts.pl
M      config.ini
?      javascript/pxn8_core.js
?      javascript/pxn8_fonts.js
?      javascript/pxn8_imagemagick.js
?      javascript/pxn8_save.js
?      javascript/pxn8_xhairs.js
?      javascript/pxn8_slide.js
?      javascript/pxn8_tools.js
?      javascript/pxn8_colors.js
?      javascript/pxn8_resize.js
?      javascript/pxn8_toolbar.js
?      javascript/pxn8_all.js
?      javascript/pxn8_hires.js
?      javascript/pxn8_strings_en.js
?      javascript/pxn8_drag.js
?      javascript/pxn8_all_minimized.js
?      javascript/pxn8_dom.js
?      javascript/pxn8_strings_es.js
?      javascript/pxn8_preview.js
?      javascript/pxn8_overlay.js
?      javascript/pxn8_event.js
?      javascript/pxn8_ajax.js
M      pxn8.pl
M      save.pl
M      .htaccess


Not too bad.



#########################################################################
090212 Thu 12 Feb 2009 05:27:00 PM EST

Got the other three projects rolled out; no real problems. I spent the
day working on kludges to fix Jessy's new club banner thingie. It does
all the right things now, at least as far as we know.



#########################################################################
090213 Fri 13 Feb 2009 11:11:53 AM EST

Started looking at Veracity yesterday evening. It doesn't work,
currently, because it expects there to be a config.php file. I'm
having a problem with it because the paths to the files are not being
defined, for some reason. I wish php had a command line debugger...

Since the extensions sometimes don't match now -- that is, a
grandma.mov will have a grandma.thumb.jpg (but no sized), it might
suffice to completely ignore the extensions... except...sometimes
there are cases where there will be a grandma.gif and a grandma.jpg,
right? Hmm. Pathological.

Bleh. We store the original movie file next to the flv file in the
mass storage... so... hmm. This complicates things. Well, we'll
continue.

Got Veracity working with loadConfig(). Some other fixes
too. Everything looks OK at the moment. Spoke too soon: original movie
files are deleted. Doh.

Even worse: Veracity hits a site where videos are processing... this
has very confusing results. It reports dark matter for files that
shouldn't be there. Like moviename.sized.jpg.

I can't just ignore movies; they have to go into the db same as
everything else.

And in the end, all the movies were OK. Hrmm.



#########################################################################
090217 Tue 17 Feb 2009 11:30:51 AM EST

Debugged paypal purchases this morning; when I came in Fernando said
we had four complaints about it not working. Tom reported it
too. After a long investigation, turns out Jessy deleted a line that
printed out the form variables in the "splash page" that forwards
customers to Paypal. With that one line replaced it works again.

I was thinking over the weekend that I should add that many to many
table to Chris's original schema. Hmm. Perhaps I should write an
ORMish database abstraction layer for Gallery to talk to...

There should be a ligthweight way to retrieve all albums and their
highlights. This was something Brad said became an issue with their
database schema. Chris's design doesn't seem to include an albums
table... technically, an album is an albumitem so it's not necessary;
one could create a view to list albums. Let's see what Joel Celko
says.

I suppose albumitem-to-album relations could be kept in another table
without having to have an albums table. I'm wondering at cooking up
some test data; I also thought about tweaking veracity just to do an
albums-only insert. That might keep things simple for now.

Alternately, we can use a second table for albums only, but the table
structure is identical to albumitems. Hrmm. I suppose I should branch
Veracity before I do that.

This will impact the cart and the OFS too... they will have to learn
to do things via the database; unless I create "proxy" objects
(decorators?) that allow them to continue working the way they have...

Thought: Load an album from mysql, load one from the dat. Compare. If
the objects are not identical, something wasn't inserted. One cheap
way to do this would be strcmp on serialized copies of the objects.

I've probably noted this elsewhere, but I wonder if Veracity recurses
due to my noobieness with Gallery. I think just interating over the
albumdb would be good enough, though that won't tell you explicitly
whose child the album is/whose its parent is. But... this could be
noted in the iteration...
              

foreach ($albumdb as $album) {
    foreach ($album as $albumitem) {
        if (isAlbum($albumitem))
            noteThisIsAnAlbum($albumitem);
        elseif (isMovie($albumitem))
            doSomethingWithVideo($albumitem);
        else
            doSomethingWithPhoto($albumitem);
    }
}

I can't see an immediate flaw in this... also, why bother with the
usermap? Or logging in? One user object that's 'admin' should be able
to surf all sites, I should think. At the moment Veracity is crapping
bricks because the "gallery collection" data structures keep reloading
the 'swain' site after it iterates to the next site...

Dark energy can be dumped when I get around to porting the data, I
suppose.

Note: anywhere Gallery is doing some operation on $gallery->album,
this should probably be factored out. It has side effects that make
life hard for Veracity. But judging from ack's output that might be
really hard to do. Or irrelevant.


#########################################################################
090218 Wed 18 Feb 2009 11:39:33 AM EST

Testing the new signup process on development. Mostly, just minor
things like the use of ampira.redirect.php. I'd like to make that go
away. It's an embarassment really.

I asked yesterday: why log in every time on every site? I just
realized this tests for the presence of an admin user, so that's
useful.

I'm also to the thinking that the idea that "everything's an
albumitem" is more appropriately an application thing, not a database
thing.

Also yesterday I received a call from Detective Jack Morgan, Kentucky
State Police, Electronic Crimes Section. He was trying to get more
information on "hardworkingman1," a child porn case I reported in
2007. Unfortunately it got kicked around three states before it came
to him, and the ISP either didn't have logs or long since got rid of
them... so he was hoping for a name or other information. Most
unfortunate. I told him everything I had, I put into the NCMEC report.

---

Hm. Rediscovering my Celko book on trees and hierarchies. It gives me
the idea that our "many to many" table would really be a "list
adjacency model" with some constraints. Well, yeah, I
suppose. Hmm. Rather than doing a simple "album_id/albumitem_id" table
there would be other constraints to preserve the hierarchy. Perhaps
the order the items appear in the album should be separate from this;
an album contains a number of ids, some of which are also albums.


#########################################################################
090219 Thu Feb 19 13:35:27 2009

Might have lost a week's worth of entries... torque's d0
partition/drive has been flaking out.

I think the idea of an albums_to_albumitems table not only is sound,
but Celko's expositions on the "List Adjacency Model" are helpful, at
least in their listing of needed constraints.

Idea: all albumitems are unique. Even if the same photo is in three
albums, it has three different albumitems to represent that fact... an
albumitem is just that, a node in a tree. It can be any kind of data
type. Hmm. Well, the problem then is you'd need three rows in
Albumitems to show this fact, or else a Treenodes table of
treenode_id, albumitem_id. Hrmm.

Yay. Bill restored my log from backup; I didn't lose anything.



#########################################################################
090220 Fri 20 Feb 2009 11:29:46 AM EST

Peter's calling for an "all hands on deck" thing to cut over to EZ
Prints. I have to parse another one of Jessy's spread sheets, which
makes me PMS -- Pre Migration Syndrome. I was snappy with her in the
meeting today.

Sadly we'll lose matte finish prints for the time being, since they
are a different product number for ezprints. Unless I have a brilliant
idea on how to handle that.

Club print discount: this is applied via an offer, in the
DiscountHelper class (which the Cart class has-an instance of).


---

Rereading my entry of 080410 Thu 10 Apr 2008, where I'm ruminating on
the migration to Qualex, it just dawned on me that the whole issue
with categories (a category can contain products and other
categories) harkens to my readings the past two days on hierarchies in
SQL; and Celko's "Nested Set Model" provides a solution... though we
still have the "type" problem, same as in albums and photos: a node
can be either, and somehow one has to distinguish. For the store/cart,
the data set is small enough that performance isn't going to be much
of an issue though.

Also, I should write a cron job to commit my log every day... done!

I still have a bug in MPP where encrypting the credit card fails, even
though my little test project works just fine.

OK, changed the key for constant_name to be (constant_name,
manufacturers_id).

Perhaps it's time to write a script to generate a PHP file of product
IDs and their constants... and this file can live in mpa_core, where
all projects can reach it if they need to... and I can add a tools/
directory to mpa_core that has a script to regenerate this
file. Also... since we can have our own copies of mpa_core, I could be
using ezprints while torque uses qualex. Dunno if there will be OFS
issues (probably) but it's a step in the right direction.



#########################################################################
090223 Mon 23 Feb 2009 11:14:45 AM EST

Fernando says the blocks of errors I've been seeing for days are not
from autorenewals... which is puzzling. So I asked him to track those
down. Autorenewals weren't running under cron over the weekend, which
is all the weirder, so I have to keep closer tabs on him. He's
supposed to be posting to EZ Prints today.

Today: worked out a new perl script I started on Friday, which
generates a file of all constants for all products. I modified GiftsDB
and productfactory to use it. I tried for a while to use Perl's
format/write features to make the file more readable, but it was not
worth the effort... and then I finally finished generating the SQL to
insert all ezprints prints and posters into the db, created a patch
file and committed it.

Also did some tweaking of test sites for Jessy.



#########################################################################
090224 Tue 24 Feb 2009 11:51:43 AM EST

Working from home today; Fernando is in the office. Looks like Qualex
is threatening to cut us off Thursday for nonpayment. They are being
tough about payment since they are going under in March.

I have prints and gifts loaded into the three main products
tables. The constant names for gifts are wrong; and stationary is
formatted differently, I think, so I'm going to leave that be until
I'm back in the office. Time to focus on the OFS.





#########################################################################
090225 Wed 25 Feb 2009 05:42:56 PM EST

All day meeting with our new Dotphoto buddies. Lunch at Dallas BBQ. I
shouldn't eat so much meat.




#########################################################################
090226 Thu 26 Feb 2009 11:14:39 AM EST

Hmm. Was looking at fixing a bug last night. What was it? Ah! Applying
club discounts to prints.

New bug: club discount is applied to all orders. I wonder if it's the
new status thingie. Hmm. Bug went away. Well, I realized today I need
to update all product IDs in the existing carts on production when we
go live...

For some reason the ofs's OrderPartFactory can't separate order parts
based on who's making it... that is, it goes by category. Really, for
each product ID, it should just find the manufacturer and do the Right
Thing based on that.



#########################################################################
090227 Fri 27 Feb 2009 03:28:29 PM EST

Been whacking away today on ezprints... right now, trying to fix
Express Select. Again. I fixed it in April 2008 but the fix was to
switch to constants... which doesn't seem to be an issue when I view
source... hmm. There is that wonky config file, but ... the ids are
correct. I don't get it.



#########################################################################
090302 Mon 02 Mar 2009 11:56:09 AM EST

Working from home. We had a nor'easter, and the hot water tank burst,
so here I am. Testing from home; all projects look good.


mysql> select cc.products_id, pd.products_description from osc_cart_contents cc, osc_products_description pd where cc.cart_id = 37 and pd.products_id = cc.products_id;
+-------------+---------------------------------------------+
| products_id | products_description                        |
+-------------+---------------------------------------------+
| 7102        | Classic Mousepad                            | 
| 7103        | White 11oz Mug                              | 
| 7105        | Ceramic Mug 11oz (black)                    | 
| 7107        | White 15oz Mug                              | 
| 7111        | 4Coasters (1 image)                         | 
| 7115        | Porcelain Flat Circle Ornament              | 
| 7117        | Porcelain Snowflake Ornament (single-sided) | 
| 7122        | Photo Canvas - 16x20                        | 
| 7123        | Photo Canvas - 20x24                        | 
| 7124        | Playing Cards                               | 
| 7125        | Puzzle In Box                               | 
| 7135        | Photo Apron                                 | 
| 7136        | Deluxe Tote Bag                             | 
| 7141        | Tshirt (white) - XL                         | 
| 7144        | Tshirt (white) - (Sub) Medium               | 
| 7152        | Sweatshirt (white) - XXL                    | 
| 7153        | Kids Tshirt - Small                         | 
| 7169        | Stainless Travel Mug                        | 
| 9041        | Porcelain Star                              | 
+-------------+---------------------------------------------+
19 rows in set (0.01 sec)


Here's what I have to map: old product IDs to the new ones.

---

All done, and the hot water tank too. The one upside to generating
this file of PHP constants and EZPrints products IDs is I found a bug,
where I hadn't added them to osc_products_to_categories.



#########################################################################
090303 Tue 03 Mar 2009 09:58:22 AM EST

Just for history's sake, here's the file I eventually created
yesterday. I had to put one of every product (including all sizes for
each apparel item) to create the mapping. Tedious.

+-------------+---------------------------------------------+
  old mpa id  | products_description                        | mpaid | ez_id | products_description                              |
+-------------+---------------------------------------------+ 
: 7102        | Classic Mousepad                            | 11050 | 10101 | 8x9 Standard Mouse Pad                            | 
: 7103        | White 11oz Mug                              | 11051 | 10102 | 11 oz white Mug                                   | 
: 7105        | Ceramic Mug 11oz (black)                    | 11052 | 10190 | 11 oz Black Mug                                   | 
: 7107        | White 15oz Mug                              | 11055 | 10112 | 15 oz white Mug                                   | 
: 7111        | 4Coasters (1 image)                         | 11059 | 10113 | Coasters - Set of 4 - Single Image                | 
: 7115        | Porcelain Flat Circle Ornament              | 11065 | 10138 | Ornament - Porcelain Circle                       | 
: 7118        | Keepsake Wood Box                           | 11066 | 10240 | Keepsake Box - Mahagony                           | 
: 7122        | Photo Canvas - 16x20                        | 11105 | 90120 | 16 x 20 - Mounted                                 | 
: 7123        | Photo Canvas - 20x24                        | 11120 | 90050 | 20 x 30 - Rolled                                  | 
: 7124        | Playing Cards                               | 11068 | 70002 | Playing Cards                                     | 
: 7125        | Puzzle In Box                               | 11069 | 10127 | 252 Piece Puzzle w/Box                            | 
: 7135        | Photo Apron                                 | 11094 | 10180 | Apron                                             | 
: 7136        | Deluxe Tote Bag                             | 11095 | 10185 | Tote Bag                                          | 
: 7169        | Stainless Travel Mug                        | 11058 | 10115 | Photo Travel Mug - Stainless                      | 
: 9041        | Porcelain Star                              | 11064 | 10137 | Ornament - Porcelain Star                         | 

: 7138        | Tshirt (white) - Small                      | 11074 | 10103 | T-Shirt - Premium Image - Adult S                 | 
: 7139        | Tshirt (white) - Medium                     | 11075 | 10104 | T-Shirt - Premium Image - Adult M                 | 
: 7140        | Tshirt (white) - Large                      | 11076 | 10105 | T-Shirt - Premium Image - Adult L                 | 
: 7141        | Tshirt (white) - XL                         | 11077 | 10106 | T-Shirt - Premium Image - Adult XL                | 
: 7142        | Tshirt (white) - XXL                        | 11078 | 10107 | T-Shirt - Premium Image - Adult XXL               | 
                                                           
: 7143        | Tshirt (white) - (Sub) Small                | 11079 | 10225 | Xtra Large Image T-Shirt - Premium - Adult S      | 
: 7144        | Tshirt (white) - (Sub) Medium               | 11080 | 10226 | Xtra Large Image T-Shirt - Premium - Adult M      | 
: 7145        | Tshirt (white) - (Sub) Large                | 11081 | 10227 | Xtra Large Image T-Shirt - Premium - Adult L      | 
: 7146        | Tshirt (white) - (Sub) XL                   | 11082 | 10228 | Xtra Large Image T-Shirt - Premium - Adult XL     | 
: 7147        | Tshirt (white) - (Sub) XXL                  | 11083 | 10229 | Xtra Large Image T-Shirt - Premium - Adult XXL    | 
                                                           
: 7148        | Sweatshirt (white) - Small                  | 11084 | 10170 | Sweatshirt - S                                    | 
: 7149        | Sweatshirt (white) - Medium                 | 11085 | 10171 | Sweatshirt - M                                    | 
: 7150        | Sweatshirt (white) - Large                  | 11086 | 10172 | Sweatshirt - L                                    | 
: 7151        | Sweatshirt (white) - XL                     | 11087 | 10173 | Sweatshirt - XL                                   | 
: 7152        | Sweatshirt (white) - XXL                    | 11088 | 10174 | Sweatshirt - XXL                                  | 
                                                           
: 7153        | Kids Tshirt - Small                         | 11070 | 10200 | T-Shirt - Premium Image - Youth S                 | 
: 7154        | Kids Tshirt - Med                           | 11071 | 10205 | T-Shirt - Premium Image - Youth M                 | 
: 7155        | Kids Tshirt - Large                         | 11072 | 10210 | T-Shirt - Premium Image - Youth L                 | 


This was my input for a Perl script to generate all the sql (patch 820, in fact).



---

[nsfw] KENtucky: Dude, you're not going to believe this, but the person in
http://crack.myphotoalbum.com/vwr.php/album/jennyo/album318 was at the same hotel I was at this
past weekend. Columbia, SC. [1:19 a.m. 3]
[nsfw] Andy [to KENtucky]: Did you do her? [1:20 a.m. 3]
[nsfw] KENtucky: I talked to this girl for a while at 3AM:
http://crack.myphotoalbum.com/vwr.php/image/jennyo/album318/sarah_003.sized.jpg [1:20 a.m. 3]
[nsfw] KENtucky: no, but I tried to hook the dude I was with up. [1:20 a.m. 3]
[nsfw] KENtucky: it was a bachelorette party. the bachelorette was carrying around the blow-up
penis. i asked her if she knew she was carrying a big inflatable penis.  she then explained how
she'd traded it for a leigh. [1:21 a.m. 3]

(the girl in KENtucky's photo is just sitting on the floor. In other
photos a bachelorette is carrying an inflatable penis).

Well, I pulled Jessy and Peter into the conference room to tell them I
fucked up and print prices were 0.00 over the weekend. How this
happened: my original creation of patch 785 did not set the prices. I
later created a patch out of Jessy's updates to the product tables; I
then went back and updated patch 785 to have the correct prices. I
found this bug on development, where the patch of Jessy's changes
wipes out the work of patch 785. I had made a "redo" patch, but at the
time of the rollout I thought it fixed the pricing problem. It
didn't. It fixed something else.

So over the weekend:

+-------------+---------+
| products_id | numsold |
+-------------+---------+
|       11000 |    2411 |
|       11002 |     101 |
|       11004 |      35 |
|       11006 |      15 |
+-------------+---------+

and
99 rows in set (0.11 sec)

99 orders got free prints. A customer contacted Lenny and told him
they were not charged for the prints; Jessy IM'd me Lenny's IM, but
Fernando had already pointed it out to me by what he saw in the admin
interface to OSCommerce.

Rollout of the signup wizard  and mpa_www complete... turns out the
login page on www didn't work anymore. And there were typos. I rolled
out five files to the cart for Dylan.

---

I just had that happy sensation that comes from reusing a tool I spent
the time creating yesterday.. it parses the input file I posted abover
and generates SQL code. It's hard to imagine a lot of programmers live
without the ability or knowledge to do these things.

Notes on finding dupes in a table with surrogate keys:

I did a bunch of research recently on the debate of surrogate keys
versus natural keys. Actually, I didn't know or remember that that's
what they are called. For all of our tables, practically, we use a
surrogate key (an autoincrementing integer). This number has no
meaning at all to the other columns, and now that I think of it,
clears up the issue for me on how, in 3NF, the columns must 'depend'
on the primary key somehow.

A natural key, which for a photo would be
sitename+albumname+photoname, is a composite key. One of the key
problems (heh) is that users might rename the album or the photo, so
this is an update on the primary key, which (apparently) causes
problems. Or is just a headache.

Anyhow, how to find duplicate rows in a table with surrogate keys? I
thought today: why not just concat() all the columns? This failed on
null values (you can't concat null), and heller pointed out ifnull(),
which solved the problem.

I found this via the google:

select distinct(column_name) from information_schema.columns where
table_name='osc_products' order by column_name;

So that would go some way in creating a tool that would generate the
query for me, which has this kind of ugliness:

select concat(
ifnull(products_id, ''),
ifnull(products_quantity, ''),
ifnull(products_model, ''),
ifnull(products_image, ''),
ifnull(products_price, ''),
ifnull(products_date_added, ''),
ifnull(products_last_modified, ''),
ifnull(products_date_available, ''),
ifnull(products_weight, ''),
ifnull(products_status, ''),
ifnull(products_tax_class_id, ''),
ifnull(manufacturers_id, ''),
ifnull(products_ordered, ''),
ifnull(is_physical, ''),
ifnull(ofs_prefix_code_id, ''),
ifnull(constant_name         , ''),
ifnull(manufacturers_product_id, ''),
ifnull(class_id, '')
) as stringy,
count(
concat(
ifnull(products_id, ''),
ifnull(products_quantity, ''),
ifnull(products_model, ''),
ifnull(products_image, ''),
ifnull(products_price, ''),
ifnull(products_date_added, ''),
ifnull(products_last_modified, ''),
ifnull(products_date_available, ''),
ifnull(products_weight, ''),
ifnull(products_status, ''),
ifnull(products_tax_class_id, ''),
ifnull(manufacturers_id, ''),
ifnull(products_ordered, ''),
ifnull(is_physical, ''),
ifnull(ofs_prefix_code_id, ''),
ifnull(constant_name         , ''),
ifnull(manufacturers_product_id, ''),
ifnull(class_id, '')
)
) as numofthem
from osc_products
group by stringy
order by numofthem;

About as ugly as they come. But it works, or seems to... I didn't find
any dupes in osc_products though I thought there were...



#########################################################################
090304 Wed 04 Mar 2009 09:49:01 AM EST

Started whacking away at stationary yesterday but the input file is
irregular.

I crashed a conference call Jessy and Peter were holding at COB
yesterday. They were talking to some guy about doing wedding
sites. The end result of that is: they want to be able to white label
Gallery. What I have to figure out is: can we use some other domain
name besides mpa.com/mps.com/mpd.com? Probably. But no subdomain? Much
harder. So I am suddenly interested in Tim's work, because if we
divorce the file locations from the subdomain, that would be a win.

Also note I've been using the word 'win' more these days, a reddit
influence.

---

I got stationary in the database; however, osc_products_to_categories
is not populated, and I think it will all fail without rows in
osc_products_properties. For stationary. Pushing on Fernando to get
gifts rolled out... should be nothing more than a set of database
patches (up to and including 835) and updating mpa_core (new product
constant definitions).

---

How to bring back matte finish? Evil way: if it's selected, add one to
each product ID. Muhahaha. I'm thinking, though, of a lookup table or
some kind of translation event... if print_finish_type is set to 1,
it's glossy, else... hmm. Four prints, maybe posters too; and then
this is all in the database already. A view? It would be easier if
each print product had a print_finish_type itself. Or if somehow this
were all decoupled. Life was so much easier with Qualex.

Hmm. osc_products.products_status is a field for "in stock/out of
stock." Most products are set to zero. Nothing anywhere tests this
column though; but here's a convenient way to tackle this.

Meanwhile, I don't feel like getting whitebox.mpa to talk to another
database quite yet. I find mysql administration tedious.

Logically, if matte is selected, this should be set when the order is
created by the cart. The OFS shouldn't know or care. On the other
hand, we could defer this to the OrderPartPrints class and let it do
the work. Hmm. Or, even, in the XML generator. This would obliviate
any need to update the database, I suppose.

So first... a finish types table? Seems logical. Actually, having now
hacked all that out, it seems to me there should be, first, a print
sizes table. For each size, there's an ID. (Using a "natural key,"
we'd just use the code 4XD, 4X6, etc). Somehow we'd need to map
product_id to size_id. Yes? Or does that just put us back where we
started? Something feels wrong about the design I have.

Oh well, it's written.



#########################################################################
090305 Thu 05 Mar 2009 09:51:29 AM EST

Oh, I worked on whitebox.mpa yesterday too.

Taxes done for 2008. Was out 10:41 until 12:30. Terrible. Rebooted the
Pix firewall for Bill; the people working out of the office today are
having a lot of connectivity problems. Peter reports no gifts or books
sold yesterday, so I'm ordering a mug to test. Waiting on the xmit to
qualex part. (upload_order.pl).

Tim walked me through his scripts and I migrated
coretest.myphotodevel.com to the new filesystem layout. Very keen. I'm
going to cook up a tiny testbed to compute the location of the
directories, and return that string.

---

First rollout with everyone working remotely
was... problematic. Fernando didn't hold his end up because he claims
he missed my messages. I had to patch the database and push out a
change that happened in Gallery that Jessy forgot about. The use of
context classes needs some thinking; more than once now, the class
interface changed, and PHP was fatal erroring on a method that she
defined elsewhere but Gallery's class didn't have.

Fundamentally: Jessy has a header and footer file she wants used
everywhere. These are in mpa_core. They expect to have an object
that's some subclass of the Context class. The base class lives in
mpa_core. So... if the base class at least provides some default
behavior, the derived class won't be missing that method.


Bill: ok... everyone ready?
Bill: Im bout to pull the trigger
Steve Wainstead: i've bought 2 clubs now for zappa.myphotodevel.com
Steve Wainstead: yeah go for it
Bill: done
Steve Wainstead: ok, massive failures
Steve Wainstead: [Thu Mar 05 15:28:31 2009] [error] [client 217.129.48.185] PHP Fatal error: Call to undefined method GalleryContext::getFooterTarget() in /opt/mpa_core/R_2009_03_05_ezprints_gifts/inc/core_footer.inc on line 32, referer: http://where.myphotoalbum.com/view_album.php?set_albumName=album11&page=7
Steve Wainstead: jessy?
jessyhanley: ea
jessyhanley: whats wrong?
Steve Wainstead: oh, do we need agallery rollout too?
jessyhanley: did you guys do the core
Steve Wainstead: hmm
Steve Wainstead: we roled out products and core
Steve Wainstead: funny that error is only on swg3
jessyhanley: core doesnt have the latest ifle
jessyhanley: when I look at that where thing
jessyhanley: there are nw links there
jessyhanley: like
jessyhanley: satisfaction etc
3:30 PM
Steve Wainstead: bill did the caches get cleared?
Steve Wainstead: i'm gonna migrate GalleryContext over to the productino branch, jessy
Steve Wainstead: all our customers are seeing white screens
jessyhanley: i saw the site
jessyhanley: oh SHOOT
jessyhanley: yes
jessyhanley: we did make a gallery chagne
Bill: yeah caches clear with rollouts now
jessyhanley: because it wasnt loading
jessyhanley: the gener
jessyhanley: i forgot we had to do that
jessyhanley: eventhoguh it was the added to the top level
jessyhanley: controler context class
Bill: the rollout logs have no errors
Bill: want me to reload apache on swg-3?
jessyhanley: yea we need that 1 file to be in gallery
Steve Wainstead: bill please update mpa_gallery across the board
jessyhanley: the gallyer context class
Steve Wainstead: i updated afile
jessyhanley: sorr forgot


Ah, I remember now. Just two days ago I think, or maybe even
yesterday, the GalleryContext class didn't extend the base
class. That's why it failed. OK, cart and products both extend the
base class. Ditto WWW.





#########################################################################
090306 Fri 06 Mar 2009 10:23:50 AM EST

Began tinkering with a way to compute the new directory location. I
don't want to do something like sprintf if I can help it; but then
again, once I've done the munging I can stash it in the session so we
don't do it every time.

Here's a thought: separate print sizes from the cart. Rather than
having the user select the sizes in the cart itself, we can just move
that functionality to another page: choose print sizes or finishes. I
would also like to put an abstraction layer between the cart and the
product IDs, if that makes any sense. A small adult white tshirt is
just that, and the cart can deal with things on those levels. Some
later step (order creation?) can translate those into the correct
product IDs. I think what I'm trying to solve here is the problem with
print finishes.

First: been playing around today with the filesystem migration
stuff. I cooked up a function to compute the slow and fast storage
locations. I'm grepping through Gallery looking for calls to
getFiveLevelsDeepPath(), and a lot of them are used for the image
servers.

Well... I redefined $GALLERY_USERDIR to use the new location, and lo,
it works. I added the Gallery class finally, making it official... and
I have this thought: since we're going to test the db to see if this
site has been migrated, I can just create subclasses of Gallery:
GalleryFiveLevelsDeepStorage and GalleryTimsScheme, and those will
have methods pathToSlow() and pathToFast() and they will do the Right
Thing. Is this worth it? Probably not.

I'll probably just have Gallery do it, no subclasses, and later we can
toss out helper methods.

Hmm. If the app context returns us the Gallery, then Veracity can have
an application context class (!) and that can return the desired
Gallery. Internally it can hold an array keyed on subdomain, and we
can switch galleries at will. In theory. A GalleryContext instance,
however, will hold its own Gallery. Intruiging.

So the Cart can also hold one or more, if it follows the
interface. Actually, Gallery might be the only one to return only one
and one only... any attempt to change it would be fatal? Yes? No?
Well, let's look at the case of shared albums.

We are swain.mpa.com. We want a jessy.mpa.com album. We do something
like:

$gallery->loadfriends();

This loads an array of zero or more friend sites. We can iterate:

foreach ($gallery->friends() as $friendgallery) {
   // do something with that gallery
}

Now... permissions? Perhaps we use some design patter to wrap a
Gallery such that only certain operations are permitted. That would
probably be doable.

Now... can we create a Context class before everything else? How I
wish sometimes for a Front Controller.

Hmm. Chicken versus egg time: veracity needs to fill an array, or
thereabouts... actually when would veracity ever need an array of
Galleries? But it would need to reset the Gallery on each
iteration. Anyway, a problem here is this: getting the context class
"above" the gallery code. Not sure how to accomplish this.

If we create a GalleryContext at the top of every page.. that is,
we'll do this at the top of every page:

require_once("/opt/mpa/conf/gallery.conf");
require_once("{$GALLERY_BASEDIR}classes/GalleryContext.class.inc");
$GLOBALS['app_context'] = new GalleryContext();

(which can probably be tossed into a single include file),
then... we've moved it out of init.php. This means any other
application can load init.php and other non-display files, providing
whatever context class it wants. So a short audit of all the Gallery
files would be in order: if they are web pages, we do the above; if
they are not, we don't. They must be included by something else.

Then, at the top of init.php, it's a given that there's always a
Context class defined for us; else it's a fatal error.



#########################################################################
090309 Mon 09 Mar 2009 10:22:49 AM EDT

I had the urge over the weekend to try out my new ideas, specifically
for using the Context class to give us the Gallery object. But:
there's the counter notion of creating a proxy (Proxy?) class to
intermediate between Galleries.

Reviewing my log from Friday, I thought of this: I can put a test in
at the end, in that function that's called at the end of the
request... register_shutdown_function(). In that I can test $GLOBALS
to see if the key 'gallery' is set... this should be a fatal error, in
the end. An ounce of prevention. But I don't think I can terminate the
process at that point, can I? Actually may as well test this.

OK, in init.php:

// at the top of the file
if ($_SERVER['HTTP_HOST'] == 'swain.myphotodevel.com')
    ob_start();



    // in the exit function
    if (array_key_exists('gallery', $GLOBALS)) {
        ob_end_clean();
        die("API violation: cannot set global gallery in superglobal GLOBALS\n");
    }

This works as an assertion, so the global $gallery can be cleaned
up. I'm kind of down on the idea of renaming it $thisgallery, but
otoh, that could be a stopgap while I clean out all the globals. The
big step was blowing away config.php. That helped a lot.

4,148 instances of the variable $gallery including the sitewide config
file... certainly a lot of work, but then again, I might just do a
massive change to the codebase thusly:

s/global $gallery;/$thisgallery = $context->fetchGallery()/;

and then:

s/$gallery->/$thisgallery->/g

and count up the failures. As an experiment it's low budget. The first
thing, though, is to update all the "page template" files; that is,
all the PHP files at the top level, which make up most of the
application. (Stuff in pops/ will need it too, I think).

swain@torque:~/public_html/projects/mpa_gallery$ ftx 'global $gallery;'|wc -l
239

Not bad. First thing though is to edit all the page template files.

Oh, and another thing; and this relates to the whiteboxing problem. I
have to parameterize the gallery conf file, so a whiteboxed solution
can load a different one. Hmm. I had some thought this weekend over
just placing a file in the DocumentRoot that does this... and I've
come to question the need for absolute paths to files, using
{$GALLERY_BASEDIR} and whether that gains us anything. Hrmm.

Oh, I should move my swain and swainlisp projects to git, and then
start pushing those repos around, instead of relying on our company's
subversion repository. At the very least, my lisp library should be
exported.

I think the steps must be:

Top level page templates have to load the GalleryContext class.
require("classes/GalleryContext.class.inc");

They then load the conf file:
GalleryContext::loadConfig(); // calls
require_once('/opt/mpa/conf/gallery.conf');

But how does that get us around the whiteboxking issue? We still need
to load things differently that way. Hrmm. OK, the "seed file" at the
top level.

include("seedfile.inc");

In which:
if (GALLERY)
   require("classes/GalleryContext.class.inc");
   $GLOBALS['app_context'] = new GalleryContext();
elseif (WHITEBOX)
   require("classes/WhiteboxContext.class.inc");
   $GLOBALS['app_context'] = new WhiteboxContext();

// do any other things

And outside this file, all access to $gallery is by first calling the
context class, I guess.

Perhaps we'll use SERVER vars to indicate which it is? That would seem
simple enough. i.e.:

ServerName swain.myphotodevel.com
DocumentRoot /home/swain/public_html/projects/mpa_gallery
SetEnv MPA_GALLERY_ROOT /mnt/fast/vol01

We can SetEnv something like
SetEnv APPLICATION_DOMAIN mpa_gallery
or
SetEnv APPLICATION_DOMAIN mpa_whitebox

Not super optimal, but that will have to do for now. Alternately I can
enforce the loading of init.php first... hmm.

---

Well... refactoring done. 'global $gallery' is now history. The
gallery class is provided by the context class; it's still a global,
in truth, since it's placed there in init.php.

I wound up leaving $gallery in init.php so far; this doesn't upset the
apple cart. I'm trying to partition the display code from the
underpinnings... in theory, I can instantiate a Gallery inside the
cart now, and not have any namespace pollution or anything going on.

So that's done, after so many years. I'm thinking of doing away with
$GALLERY_BASEDIR now. It's another holdover from original Gallery, and
was created... who knows why? Security reasons?

Well, that was a mess. Files in subdirectories cannot open "init.php."
I reverted everything, but it was a simple change to make.




#########################################################################
090310 Tue 10 Mar 2009 11:49:18 AM EDT

I think two things should happen before init.php is loaded:

1. Load the configuration file.
2. Create the Context subclass.

From there, init.php can get all the info it needs to set things
up. The configuration file has to load first because the "basedir"
path(s) must be set. The Context class has to be instantiated so the
$gallery can be created.

End of yesterday, was brainstorming on the phone with Tim... he thinks
we can write a simple mod_perl module to translate image URLs. We can
do two things this way:

1)
http://images.myphotoalbum.com/s/sw/swa/swai/swain/swain/album01/foo.jpg
can be supported.

2) http://images.myphotoalbum.com/swain/album01/foo.jpg would be how
the new URLs would look. These would translate into
000/142/000142687-swain/albums/album01/foo.jpg.

This gives us two things: 1). We can dispose of the three-levels-deep
symlinking mess, and 2) we hide the user IDs.

---

Dunno why I never thought of this before:

-require_once('/opt/mpa/conf/gallery.conf');
+require_once("$_SERVER[DOCUMENT_ROOT]/load_configuration.inc");

That is, using DOCUMENT_ROOT to locate a file.



#########################################################################
090311 Wed 11 Mar 2009 01:22:39 PM EDT

Barely time to do anything today, after a two hour conference
call... one little test for Fernando... lunch... watching
thru-you.com... minor tweaking of mod_rewrite.

I'm working on mod_rewrite after fixing up the configuration file
issue in Gallery; my goal is white labeling and letting us write
facebook apps.

---

We had a rollout, later everything went down, rolled back, went live,
turned out that the problem was the Winchester array and not the
apps. Some one hour rebuild thingie is going on now.



#########################################################################
090312 Thu Mar 12 12:11:26 2009

Working from home today. Got mail working on the mini and the laptop;
recompiled emacs to try to get around annoying mouse color. Turns out
I only needed set-mouse-color, but I was two versions behind anyway so
it was all good. Got mod_rewrite working on the mini, and watched the
rollout for Bill; mass failures and he had to restart the web servers
to clear them up. As if the APC caches didn't clear.

Which reminds me: the bug that's plagued me for years now when I'm
tailing logs. I first created an Expect script to log me into the
server and tail the log:

#!/usr/bin/expect

# $Id: mup.exp,v 1.6 2007/02/23 17:56:09 swain Exp $

set timeout 25

set machine [lindex $argv 0]
set muppattern [lindex $argv 1]
puts "Using machine $machine $muppattern"
spawn /usr/bin/ssh bst-1.fortunecity.com
expect "Unauthorized"

send "ssh $machine\r"
expect "$muppattern"
send "cd /opt/apache2/logs\r"
expect "logs"
send "tail -f `ls -tr *error* | tail -1` | grep -v 'TRANSMIT_ERROR' \r"

interact
puts "mup.exp done."

# $Id: mup.exp,v 1.6 2007/02/23 17:56:09 swain Exp $

With ssh keys set, it slides right through and the log is being
tailed. I wrote some elisp to open four shell buffers to tail the
logs:


;; $Id: mups.el,v 1.6 2007/07/05 19:09:20 swain Exp $

(defvar sw-tail-mups-alist '(
                             ("swg-3" . "swg-3") 
                             ("mup-3" . "mup-3")
                             ("mup-2" . "mup-2")
                             ("mup-1" . "mup-1")
                            )
  "List of mup servers.")


(defun sw-tail-mups ()
  "Tail error logs on the mup servers in shell buffers."
  (interactive)
  ;; if we are on a windowing system like X11, open this in a new frame
  (if window-system
    (let ((mups-frame (make-frame)))
      (select-frame mups-frame)
      (set-frame-name "mups")))

  (let (pair (file-alist sw-tail-mups-alist))
    (while (consp file-alist) 
      ;; first time through these are equal so we do not split the buffer
      (if (not (equal (safe-length file-alist) (safe-length sw-tail-mups-alist)))
          (split-window-vertically))
      (setq pair (car file-alist))
      (shell)
      (rename-buffer (car pair))
      (goto-char (point-max))
      (insert (format "~swain/svn/mup.exp %s %s" (car pair) (cdr pair)))
      (comint-send-input)
      ;;(message "car: %s cdr: %s" (car pair) (cdr pair))
      (setq file-alist (cdr file-alist))
      )
    (balance-windows)
    (window-configuration-to-register ?m))
  )



But the bug is: eventually the same block of text is "printed" to the
buffer ad inifinitum. I thought it must be an emacs bug.

I wrote a new Expect script to use GNU screen:

#!/usr/bin/expect

# $Id: mups.exp,v 1.4 2005/11/02 19:32:06 swain Exp $

set timeout 25

# Get the password from the user.
send "Password: "                ;# prompt user for password
stty -echo                       ;# turn off echoing
expect -re "..+"                 ;# expect input matching this regexp
set passwd $expect_out(buffer)   ;# set variable 'passwd'
stty echo                        ;# turn echoing back on

spawn "/usr/bin/screen"
expect "to end"
send "\r"
expect "swain"                   ;# match my shell prompt

# need to wrap this in a proc...
send "ssh mup-1.fortunecity.com\r"
expect "assword"
send "$passwd\r"
expect "Fozzy"
send "sudo -s\r"
expect {
    "assword" {
        send "$passwd\r";
        expect "root"
    }
    "root" ;#  do nothing. we are already root.
}
send "cd /opt/apache/logs\r"
expect "logs"
send "tail -f `ls -tr *error* | tail -1` | grep -v 'File does not exist: /mnt/cel-1/vol01/linkless/gallery/1'\r"
send "S	c"             ;# split screen, switch to it, start bash

expect "etelone"
send "ssh mup-2.fortunecity.com\r"
expect "assword"
send "$passwd\r"
expect "Gonzo"
send "sudo -s\r"
expect {
    "assword" {
        send "$passwd\r";
        expect "root"
    }
    "root" ;#  do nothing. we are already root.
}
send "cd /opt/apache/logs\r"
expect "logs"
send "tail -f `ls -tr *error* | tail -1` | grep -v 'File does not exist: /mnt/cel-1/vol01/linkless/gallery/1'\r"
send "S	c"             ;# split screen, switch to it, start bash

expect "etelone"
send "ssh mup-3.fortunecity.com\r"
expect "assword"
send "$passwd\r"
expect "beaker"
send "sudo -s\r"
expect {
    "assword" {
        send "$passwd\r";
        expect "root"
    }
    "root" ;#  do nothing. we are already root.
}

send "cd /opt/apache/logs\r"
expect "logs"
send "tail -f `ls -tr *error* | tail -1` | grep -v 'File does not exist: /mnt/cel-1/vol01/linkless/gallery/1'\r"



interact
puts "mups.exp done."


This looked pretty much the same as the Emacs result: a Screen with
four buffers (windows?) each tailing a remote log. But the same
problem occured: a chunk of text written to the buffer over and over.

A couple weeks ago I just control-C'd out of one of these, which drops
me back to my machine, and logged in manually. The problem didn't
happen anymore! And this is what I've been doing since.

So: it's an Expect bug. It has to be.

---

Meanwhile, a tutorial I found on mod_rewrite is either wrong or
dated. No matter; hacking got it to work.

RewriteEngine on
RewriteLog /private/var/log/apache2/mod_rewrite_log
RewriteLogLevel 9

RewriteCond   %{HTTP_HOST}                 ^klingklang.local$
RewriteRule   ^/page/([^/\.]+)/?$           /index.php?page=$1

Here, calling http://klingklang.local/page/jimjam does the right thing
on my mini. The browser URL stays the same, but /index.php?page=jimjam
is the result. Progress. Ah! I bet because his example uses .htaccess
instead of httpd.conf.

So I want to match this:

klinkklang.local/swain/anythingelse.php?var1=val1

This should become:

swain.klingklang.local/anythingelse.php?var1=val1

Or maybe not. We can always add a var:

klingklang.local/anythingelse.php?username=$1var1=val1

OK, this catches any username:

RewriteCond   %{HTTP_HOST}                 ^klingklang.local$
RewriteRule   ^/([^/\.]+)/?$           /index.php?username=$1


---

OK, got this far:

RewriteEngine on
RewriteLog /private/var/log/apache2/mod_rewrite_log
RewriteLogLevel 9

RewriteCond   %{HTTP_HOST}                 ^apps.klingklang.local$
RewriteRule   ^/([^/\.]+)/?(.*)$           /$2&username=$1

When called like this:
http://apps.klingklang.local/swain/view_album.php?set_albumName=album01

The log shows this:

127.0.0.1 - - [12/Mar/2009:17:06:56 --0400]
[apps.klingklang.local/sid#8ca308][rid#93de50/initial] (2) init
rewrite engine with requested uri /swain/view_album.php
127.0.0.1 - - [12/Mar/2009:17:06:56 --0400]
[apps.klingklang.local/sid#8ca308][rid#93de50/initial] (3) applying
pattern '^/([^/\.]+)/?(.*)$' to uri '/swain/view_album.php'
127.0.0.1 - - [12/Mar/2009:17:06:56 --0400]
[apps.klingklang.local/sid#8ca308][rid#93de50/initial] (4)
RewriteCond: input='apps.klingklang.local'
pattern='^apps.klingklang.local$' => matched
127.0.0.1 - - [12/Mar/2009:17:06:56 --0400]
[apps.klingklang.local/sid#8ca308][rid#93de50/initial] (2) rewrite
'/swain/view_album.php' -> '/view_album.php&username=swain'
127.0.0.1 - - [12/Mar/2009:17:06:56 --0400]
[apps.klingklang.local/sid#8ca308][rid#93de50/initial] (2) local path
result: /view_album.php&username=swain
127.0.0.1 - - [12/Mar/2009:17:06:56 --0400]
[apps.klingklang.local/sid#8ca308][rid#93de50/initial] (2) prefixed
with document_root to
/Users/swain/Sites/virtualhost/view_album.php&username=swain
127.0.0.1 - - [12/Mar/2009:17:06:56 --0400]
[apps.klingklang.local/sid#8ca308][rid#93de50/initial] (1) go-ahead
with /Users/swain/Sites/virtualhost/view_album.php&username=swain [OK]

Which appears to do the Right Thing, however the browser says:

Not Found

The requested URL /swain/view_album.php was not found on this server.


Hmm.



#########################################################################
090313 Fri 13 Mar 2009 10:12:15 AM EDT

Jessy couldn't see a number of things in her cart at home; turns out
she didn't approve the bad certs.

---

Too much fun chatting with Jessy via video iChat. She has Leopard so
she can change colors. She was actually teasing me because I couldn't
do it. Very unlike a girl.

Been tweaking mod_rewrite rules today and hacking Gallery code. I have
surfing via apps.myphotodevel.com working now.

RewriteEngine on
RewriteLog "|/opt/apache2/bin/rotatelogs /opt/apache2/logs/mod_rewrite_log 86400"
RewriteLogLevel 9

RewriteCond   %{REQUEST_URI}               !^/favicon.ico$
RewriteCond   %{HTTP_HOST}                 ^apps.myphotodevel.com$
RewriteRule   ^/([^/\.]+)/([^\?]+)$        /$2?username=$1&%{QUERY_STRING} [L]
RewriteRule   ^/([^/\.]+)/$                /albums.php?username=$1&%{QUERY_STRING} [L]

Here, we ignore favicon.ico; match the domain; if the script is
passed, call that; hmm, that should probably get an L as well. Done;
but the second rule wouldn't match anyway. Let's test. Works. All is
yay.

I had to relocate where the sessions file is loaded in Gallery, which
worries me since that might lead to subtle bugs... I think I should
review that file and throw out anything we don't need.

End of day: Jessy had endless hassles with SVN. I think perhaps I
should look at moving us to Git.




#########################################################################
090316 Mon 16 Mar 2009 09:32:40 AM EDT

Well. Regretably, "method call on a non-object" is not
catchable. Which is really piss-poor of the PHP dev team. Their
reasons are silly too.

A curiosity happened when I hardwired the login form on loginpage.php
to apps.myphotodevel.com. First, the redirect-after-login fails; no
biggie. Second, even when I change the /subdomain to another, I still
surf my own site; until I hit one of those links that is somehow
composed differently (the one in the breadcrumb). Then I land on
whoozie.

NO! I take that back. I'm looking at whoozie's albums, but the theme
looks like mine. No wonder I've been thinking of The Fly lately.

---

Perhaps putting the username in the session is a bad idea. It might be
better to require that the subdomain follow as a directory:
http://apps.myphotodevel.com/swain/. Gallery is occasionally spitting
out http://apps.myphotodevel.com/somepage.php, which is why I stuck it
in there in the first place. But ultimately, there's going to be one
session for apps.mpa.com; so problems will arise from this. Very
similar to solving the problem of global Gallery, perhaps. Maybe the
gallery session object -- $gallery->session -- could be scoped to a
single hash key? I think that might already be doable.

So any session accessed is always gotten via $_SESSION['subdomain'],
orginally:

$gallery->session = $_SESSION['subdomain'];

Hmm.

Also I need to solve the problem of the url not having a closing
slash: http://apps.myphotodevel.com/swain fails.

Then again: why not craft a Front Controller pattern thingie to just
do all this in PHP? I do believe I already gave this some thought
vis-a-vis the app_context class. Oh right, "file not found." You have
to do some kind of munging just to get the username out. Still: the
munging is not a problem.

I think the reason Gallery used all functions to generate the URLs was
due to the "embedding" of it in Nuke and such. So the coding that went
into that might be of use after all.

OK, tossed out all my changes. Saved a copy of init.php though.

Coming at it one direction:
ftx '<a href' | grep -v javascript|grep -v '.svn' |grep -v 'setup/old' |grep -v STATIC | grep -v makeGallery | grep -v makeAlbum |grep -v 'href=""' | grep -v 'href="#"' | grep -v 'href="http' |grep -v 'http://www' > urls

Really, most of what I want to match is this:
<a href="/

This returns 476, versus 621 the other way. Probaby easily
perl-one-lined away too. Semi-easy.

s%<a href="/%<a href="{\$gallery=>makeGalleryUrl()}%;

Except that the method needs args. Doh.

---

So, some experimentation with <base> shows that it's still useless
after all these years. When I do this:

<base href="http://apps.myphotodevel.com/swain/">

and the link is this:

<a href="pops/something.php">

this is passed to the server:
/swain/pops.something.php

wtf?

---

Oh, dear. MPA promotions would have to come out of the app as
well. Geez. And would a white labeled version for another company
require us to apply their promotions? What a mess that would be.

Anyway, after deleting my cookies, <base> started doing the Right
Thing. That can be a stopgap measure for those 500 or so 'a' tags for
the time being; the rest, I can probably script away about 80% (of
250) and hand edit the rest of them. I do still like the idea of
putting them in the Gallery class.



#########################################################################
090317 Tue 17 Mar 2009 11:45:49 AM EDT

I found yesterday that about 500 of the URLs in Gallery can be handled
just by using <base>. Not optimal, but it gets us partway there.

AIM IM with jessyhanley.
11:52 AM
jessyhanley: on my god... how do i make my mack stop reading me evertying
jessyhanley: i pressed soemthing
jessyhanley: and tis reading my typing
jessyhanley: on good
jessyhanley: god!
jessyhanley: its terriable
jessyhanley: it just read my words
jessyhanley: its funny hear it try to read my typos
jessyhanley: LOL
jessyhanley: good god
jessyhanley: HELP
Steve Wainstead: this is a priceless moment in company history
Steve Wainstead: anyway, something in system preferences, universal accesss
jessyhanley: HELP
jessyhanley: PLEASE
jessyhanley: you hav eno diea how funny this is

---

Meanwhile: I'm thinking of scoping the cookie to the domain name,
instead of the subdomain. The problem is getting from apps to swain
and back again. I am logged into one but not the other; auth should
probably work across both. The problem of links, maybe, can wait a
bit.

Well. I changed the setting in php.ini, per a discussion I found:

; The domain for which the cookie is valid.
session.cookie_domain = myphotodevel.com

This was blank, originally; now, when session_start() is called, the
session cookie is set for the tld name, instead of the
subdomain... the big surprise is once I login to swain, I'm not logged
into any other site. But once I logout I'm logged out of all of them.

Nope: not on the second try. Weird. Old session data? Old cookie data?

I think if we scope all session activity to $gallery->session, then
we're safe. Each one gets a key in $_SESSION that uses the album
directory of the site, which is always guaranteed to be unique.

--

Mass changed:

_SESSION[' -> gallery->session->

for a handful of variables. At any rate, now apps can access swain's
session; or swain's apps's.

Thought: Cart can load a gallery... given the user's PHPSESSID, it
could fetch all the Galleries involved; which is to say, something
like this:

$galleries = Gallery::fetchGalleries($_SESSION['PHPSESSID']);

Each Gallery would have its session handy; that is,
$this->session. Hmm.

With an accessor, we can do something like: 

foreach ($galleries as $gallery) {
   $gallery->makeClub();
   $gallery->saveSession();
}

Something like that. At the moment given the site_id I could loop over
all $_SESSION keys, looking for GallerySession objects and checking
site_id for the right one... otoh, I'm tempted to just change the
value of the key to make it easier. I wonder why they chose such a
long complex string?

key: gallery_session_2b98c715ead9f96d8b009ae0f3f4af3b:
val: GallerySession::__set_state(array(




#########################################################################
090318 Wed 18 Mar 2009 03:22:16 PM EDT

LOOONG meeting this morning. After some noodling around I set up email
notifications for Subversion. All reet!

Now... I want to be able to "get" the session for a given
Gallery. That would be spiffy. But the hash keys in $_SESSION are
gobbledeegook, as noted above. Hmm.

Bleh. Compiled emacs for the svn box, won't run due to no termcap db
file? teh suck.


